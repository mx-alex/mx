IRIS/CACHE for Windows^INT^vmx.ro^~Format=IRIS.S~^RAW
%RO on 20200426 11:41:15
MX^INT^1^65495,42075^0
MX ;[ 20200229 13:28:03 ]
 ; MSM, CACHE, IRIS,  GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS 2005-2020
 Q
MXWEB ; TKWEB-(this comment enables this linetag to be reference from web  with  M3)
MXGET ; TKWEB
 Q
ii(oo) q ""
UCI(%UCI) n %
 x:$zv["Mini"!($zv["Ca")!($zv["IRIS") "s %=$znspace" x:'$d(%) "s %=$p($zu(0),"","")"
 q $g(%,"UNDEF")
sv j comX4(12) q
comX4(comPort,b,zr) 
 s zr=$g(zr,"^sv"),b=$g(b,9600),ComPort="COM"_comPort  ;; ,terminat=$g(terminat,13)
 s $zt="comR4^MX"  close ComPort  h 1  k @zr s @zr="START-$j="_$j,oldQ=0  ;; ,oldH=0
 ;OPEN comX ;;;:(:::"  801x0":b):5 s o=$TEST  ;; h 1 ;; 20150224
 OPEN ComPort:(:::" 8     ":b):5 h 1
 s @zr=$j f %=1:1:99 s @zr@(%)=0
 ;; w *-3 ;; 20150129   ;; q  ;;USE comX:(:"SI") f o=1:1:999 r *a:0  ;; read com-port, even $c(3)  !! 
 USE ComPort:(:::" 8     ":b)
comR4 
 i $g(@zr)="" CLOSE ComPort HALT
 ;; s jsv=$j i $ze["<ENDOFFILE" CLOSE ComPort HALT
 s Q="" f x=0:1:99 r *o:1 q:o=-1!(o=13)  s Q=Q_$c(o)
 i '$l(Q),o<0 w *-3 f x=0:1:32000 r *o:0   ;; 20161122 
 g:oldQ=Q!'$l(Q) comR4  s %=$H,oldQ=Q
 ;; i oldH=%,'Q g comR4
 s sec=+%_$e(100000+$p(%,",",2),2,9) i '$d(@zr@(sec)) s o=+$o(@zr@(0)) k @zr@(o)
 s @zr@(sec)=Q  g comR4
 q
comWrite(Port,text,zr,b) 
 k:'$l($g(zr)) zr k:'$l($g(b)) b 
 s zr=$g(zr,"^comWrite"),b=$g(b,9600),ComPort="COM"_+Port  s @zr@(Port,$$pD^MXD($h,2))="?"  ;; ,terminat=$g(terminat,13)
 OPEN ComPort:(:::" 8     ":b):5
 USE ComPort:(:::" 8     ":b)
 WRITE text,$c(13),text,$c(13)    ;; *-3
 CLOSE:000 ComPort s @zr@(Port,$$pD^MXD($h,2))=text
 q
comRtest(Port) 
 s b=9600,ComPort="COM"_+Port,ts=$$pD^MXD($h,2) n o,x,Q
 OPEN ComPort:(:::" 8     ":b):5 h 1
 USE ComPort:(:::" 8     ":b)
 s Q="" f x=0:1:99 r *o:1 q:o=-1!(o=13)  s Q=Q_$c(o)
 CLOSE ComPort s ^test(Port,ts)=Q_$$pD^MXD($h,2)
 q
mxIndex(reportNo) 
 n % s %=$g(%omPrint(-reportNo),-1) q:% ""  s %omPrint(-reportNo)=""
 i $l(%) q:'$d(^om(%USID,reportNo)) "" q $$getObj^MXTQM(%,1)
 s:%mxIndex="" %mxIndex=$g(%mxIndex(0)) q:%mxIndex="" ""
 I $$S^MXF(" s %YX(%YXy,2)="".<mx ic20.-2 "" ",0)
 q $$getObj^MXTQM(%mxIndex,1)
omFormat(oo) 
 if oo[%B set oo=oo_"<mx format=itog "
 q oo

MX1^INT^1^65495,42075^0
MX1 ; ;[ 20200426 11:38:07 ]
 ; MSM, CACHE, IRIS, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2020
 q
trm 
 s i=$io,p=$p,io="|TRM|:|"_$j 
 ;; close $p   OPEN io:(:5533:"MA"):200 
 ;; USE io:(:5533:"RAWCD":"":32000:32000)
 s ^mxMonito($$ts,"trm",$j)=$znspace_" -- START trm^MX1 $io="_$io_"  i="_i_"  p="_p
 ;; s ^mxMonito($$ts,"trm",$j)=io_"   terminal "
 q  ;;; 
trmRead READ R:99     j:000 webChild:(:5:$io:$io)  s ^mxMonito($$ts,"trm",$j)=io_" %="_%
 w "terminal-",R,!!!
 h 1 g trmRead
 q
c2(m,server,port,uci) 
 n %io,%,r s %io=$p s %15=$c(15)
 i $g(port) CLOSE "|TCP|2" d  i '%chanel2 u %io s %mxWarng(-1)=%chanel2 q %chanel2
 . s %chanel2="ERRO"_"R ::: -- not connected to :"_server_":"_port_":"_uci 
 . OPEN "|TCP|2":(server:port::$c(15)):2 s %="w $j,"" "",$zv ;; UCI="_uci_"  "_%15
 . i $t USE "|TCP|2" d:$zv[-64  WRITE %,*-3 READ r:1 WRITE %,*-3 READ r:1 s %chanel2=$e(r,1,$l(r)-2)_" "_server_":"_port_":"_uci q
 .. i $zv["Ca" n curdev x "s curdev=##class(%SYS.NLS.Device).%New() s curdevState0=curdev.State,curdev.State=0,curdevState1=curdev.State"
 s r=%chanel2
 i r u "|TCP|2" w m," ; ",$c(0),%15,*-3 r r:7 s r=$e(r,1,$l(r)-2)
 u %io i m[(";CL"_"OSE;"),%chanel2 CLOSE "|TCP|2" s %chanel2=";CLO"_"SED; "_%chanel2
 q r
tcpMiniM ; vmx-CONCURRENT-SERVER with tcp port 5233  (minim)  ;
 k ^mxMonito s io="|TCP|:5233"  s ^mxMonito($$ts,1,-$j)="START tcpMiniM "
 OPEN io ;;  USE io:(/MODE="rwb":/TERM=$c(0))
tcpLmi k:000 ^oooRead1 s $ztrap="tcpErrMi^MX1"
 USE io:/ACCEPT ;;  h 1 r *%1 ;; i %1<0 g tcpLmi 
 ;; s %=$c(%1) i %1>-1 f  r *%1:0 q:%1<0  s:%1>0 %=%_$c(%1)
 ;; s ^mxMonito($$ts,1,$j)=%_-$l(%) i %'["UCI=" u 0 g tcpMiniM  ;; d:000  close $io  g tcpMiniM
 . i %'["Accept" w 0,$c(15),$c(0),*-3 q
 . s %=$c(13)_$c(10) n %mxWeb
 . s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 . w %mxWeb_1_%_%_$c(0),*-3
 s ^mxMonito($$ts,1,-$j)="START tcpMiniM "_io
 s:000 ^oooRead1=% g:111 tcpChild^MX1   j:000 tcpChild^MX1:(:$io) ;;  h 1
 s ^mxMonito($$ts,1,-$j)="START tcpMiniM ->> j tcpChild^MX1 "
 g tcpLmi
 q
web s io="|TCP|"_$j OPEN io:(:80:"MA"):200 USE io:(:80:"RAWCD":"":32765:32765)
 s ^mxMonito($$ts,0,-$j)=io_"  --- 80 "
 READ %  j webChild:(:5:$io:$io)  s ^mxMonito($$ts,1,-$j)=io_"  --- 80 "
 h 1 g web+2
 q
webChild USE $io:(:80:"RAWCD":"":32765:32765) s:000 ^mxMonito($$ts,0,-$j)=$io
 READ:1 ooo s o=$p($p(ooo,"MX=",2),"-"),port=$s(+o=3:5233,$zv[-64:2264,1:2232),uci=$p(o,+o,2,22)
 s %USID="web",shee=0,^mxMonito($$ts,0,-$j)=$io_";;"_ooo
 i 'o s ooo="",port=80,uci="%SYS" d  n o g webReply
 . s:o["{" o=$$u8^MXF(.o) s o=$p(o,";;") s:'$l(o) o="s ooo=1234567890"
 . f %=$l(o)-2:-1:1 s x=$e(o,%) i x="%" s x=$e(o,%,%+2),x=$f("%20  %22""  %23#  %3E> %3C<",x) s:x $e(o,%,%+2)=$e("%20  %22""  %23#  %3E> %3C<",x)
 . k %,x x o
 . s Html=$$U8^MXF(ooo),^mxMonito($$ts,1,-$j)=$g(o)_";;"_$l(ooo)_";;"_$e(ooo,1,333)
 f %=3:1:99 i $e(uci,%)?1n!($e(uci,%)=" ") s shee=$p($e(uci,%,99)," "),uci=$e(uci,1,%-1) q
 s:$l(shee)<2 shee="1_" ;; s:$l(uci)<3 uci="VMX"
 i o,uci'["%" zn uci
 d getStart s $p(ooo,";--;",2)=" %mxPort="_port_";"_uci_";"_shee_";"_%session_";"_%USID_"; "
 s Html=$$U8^MXF(ooo) s ^mxMonito($$ts,1,-$j)=$p(ooo,";--;",2)
webReply s %=$c(13)_$c(10),%1=$l(Html)
 s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 w %mxWeb_%1_%_%_Html,*-3 k:000 ooo,Html,uci,port,shee d:$d(o) saveMem
 q
tcpErrMi h 1 x "s view=$view(""err"",1)" s ^mxMonito($$ts,999,$j)=$ze_"  io="_$g(io)_" view="_view
 ;; close io  g tcpMiniM
 q
tcpError h 1 s ^mxMonito($$ts,999,$j)=$ze_"  io="_$g(io)
 c:$d(io) io h 1   ;; goto tcp+2
tcp(PORT) ; MX-CONCURRENT-SERVER with tcp (defolt-PORT : 2232(32-bit) : 2264(64-bit) : 5233(minim) : 5264 (IRIS) )
 s i=$io,p=$p,PORT=$g(PORT,$s($zv["IRIS":5264,$zv["-64":2264,1:2232))
 g:$zv["MiniM" tcpMiniM  g:$zv["MS" tcpMSM  q:$zv'["Ca"&($zv'["IRIS")  s io="|TCP|"_$j
 OPEN io:(:PORT:"MA"):200 
 USE io:(:PORT:"RAWCD":"":32765:32765)  ;; 32767=7FFF
 s ^mxMonito($$ts,0,$j)=$znspace_" -- START tcp^MX1 $io="_$io_"  i="_i_"  p="_p_" PORT="_PORT
tcpL 
 s $ztrap="tcpError^MX1"
 READ %   j tcpChild^MX1:(:5:$io:$io)
 ;; s ^mxMonito($$ts,0,$j)=$znspace_" -- START j tcpChild^MX1 "_$g(%)
 h 1 g tcpL
 q
 ;; i $zv["Ca" s ip=$zu(67,15,$j),o=$d(^mxSYSTEM("mxDenyIP",ip_1)) d  g:o tcpL
 ;; . s ^mxMonito($$ts,0,$j)=ip_" "_p_" "_$tr(%accept_" job="_$j_" $za="_$za_" $zb="_$zb_" $zc="_$zc,$c(0),"o")
 ;; . i o s o=o_$zr,@$zr=@$zr_" ::: access denyed ::: "_o
tcpChild ;; s ^mxMonito($$ts,0,$j)=$znspace_" -- START j tcpChild^MX1 "
 k ooo s ooo="" 
 i $zv["MS" USE 56 g tcpChilR^MX1
 i $zv["MiniM" USE $io:(/MODE="rwb":/TERM=$c(0))
 i $zv'["MiniM" USE $io:(:PORT:"RAWCD":"":32765:32765)
 s ^mxMonito($$ts,1,$j)=$znspace_" -- START tcp^MX1 $io="_$io_"  i="_i_"  p="_p_" PORT="_PORT
tcpChil2 s $ztrap="saveMem^MX1",ooo=""
 i $zv'["MiniM" f  READ:600 ooo d:ooo=""  s uci=$tr($p($p(ooo," UCI=",2)," "),"""") s:ooo["OPTIONS" ^mxMonito($$ts,0,-$j)=ooo s:$e(ooo,1,3)="GET" o=$p($p($p(ooo,"UCI=",2),";",1,6)," "),uci=$p(o,";") q:$l(uci)>2
 . i $g(%session),$d(%mxWeb),$znspace'="%SYS",$g(%gm),$g(^oAllVars($g(%USID,-2.2),-%session,"$j"))=$j s %=%session n YX,Y,X,ooo,%session,%mxWeb  i $$SaveMem^USX(%USID,-%)
 i $zv["MiniM" f  READ *%:60  d:%>-1  s uci=$tr($p($p(ooo," UCI=",2)," "),"""") s:$e(ooo,1,3)="GET" o=$p($p($p(ooo,"UCI=",2),";",1,6)," "),uci=$p(o,";") q:$l(uci)>2
 . s ^mxMonito($$ts,3.1,-$j)=% 
 . s:%>0 ooo=$c(%) f  READ *%:0 q:%<0  s:%>0 ooo=ooo_$c(%)
 . s ^mxMonito($$ts,3.2,-$j)=ooo
 . ;;  i '$l(ooo),$g(%session),$d(%mxWeb),$znspace'="%SYS" k YX,Y,X,ooo i $$SaveMem^USX(%USID,-%session)
 ;; q:'$l(o)
 s ooooREAD=-99 s $ztrap="mxErrChR^MX1"
 i $l(uci)>2,$l(uci)<9,$znspace'=uci zn uci
 i $e(ooo,1,3)'="GET" w uci,0,$c(0),$c(15),*-3 g tcpChilR^MX1  ;; mx-EXCEL
 q:'$l(uci)
 ;; s ^mxMonito($$ts,3,$j)="START tcpChild^MX1  ooo="_ooo_-$l(o)_$g(o)
 i $e(ooo,1,3)="GET" s %mxWeb=1 d    ;; mx-WEB
 . ;; s %1=+$g(%session)
 . i o["%session" f %="YX","%USID","%mxSheet","%session" s @%=$p($p(o,";"_%_"=",2),";")
 . i o'["%session" s %USID=$p(o,";",3),%mxSheet=$p(o,";",2),%session=0,YX="" 
 . i '%session s ^mxMonito($$ts,3.3,$j)="START tcpChild^MX1  o="_o h 1
 . s %1omCode=$p($p(ooo,";=",2,999),";];") s:%1omCode["{" %1omCode=$$u8^MXF(.%1omCode)
 . f %=$l(%1omCode)-2:-1:1 s o=$e(%1omCode,%) i o="%" s o=$e(%1omCode,%,%+2),o=$f("%20  %22""  %23#  %3E> %3C<",o) i o s o=$e("%20  %22""  %23#  %3E> %3C<",o),$e(%1omCode,%,%+2)=o
 . s %mxForma=%mxSheet i '%session d getStart q
 . ;
 . ;; s ^mxMonito($$ts,4,$j)=YX_" "_%USID_" "_%mxSheet_" %session="_%session_" ooo="_ooo_"   o="_o
 . i YX="-2" s:000 %session=$g(^ooomxWeb(%USID,0)) s %=0,ooo="" x "f  s %=$o(^oSaveAsT(%USID,""web_MX_JS"",%)) q:'%  s o=$p(^(%),""// "") s ooo=ooo_o" q
 . s %oldJob=$g(^oAllVars(%USID,-%session,"$j")) 
 . i %oldJob'=$job s %=%session x "n YX,ooo,%session,%1omCode,%mxSheet,%mxForma  i $$RestMem^USX(%USID,-%)" s ^oAllVars(%USID,-%session,"$j")=$job,%mxWeb=1
 . i YX=%mxSheet d getForma q
 . i $l(%1omCode)>11,'YX s %changed=$g(%changed)+1
 . s Y=+YX,X=+$p(YX,"-",2),%qSelect=$g(%qSelect),%ySelect=$g(%ySelect,1),%xSelect=$g(%xSelect,1),%B=$c(254)
 . s %1ooooYX=YX,ooo=""
 . i Y&X!(YX="0"),$l(%1omCode)>1 d  q
 .. s:Y Yrc=$g(^oYrc(%USID,%mxSheet,Y),Y),%YXy=Y,%YXx=X
 .. i Y,X s %1=$g(^oTQMo(%USID,%mxSheet,Yrc,X)),%2=$g(^oRC(%USID,%mxSheet,Yrc\1,X)),%3=$g(^oYX(%USID,%mxSheet,Y,X)) 
 .. x "n %1,%2,%3,%1ooooYX "_%1omCode s ooo=$g(ooo),YX=%1ooooYX
 .. i ooo="",YX d
 ... i $e(%2,1,6)="?$$B~ " f %=3:2 s o=$p($p(%2," ",1,15),"?",%) q:'$l(o)  x "n %,YX s $p(%2,""?"","_%_")="_o
 ... s ooo=%1_";;oRC="_%2_";;oRC=;;oYX="_%3
 s Html=YX_";"_%USID_";"_%mxSheet_";"_%session_";="_$$U8^MXF(.ooo)
 s %=$c(13)_$c(10),%1=$l(Html)+1
 ;; s %mxWeb="HTTP/1.1 206 Partial Content"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Accept-Ranges: bytes"_%_"Content-Range: bytes 1-"_%1_"/"_%1_%_"Cache-Control: no-cache"_%_"Connection: " ;; ..
 s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 ;; s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: http://www.armex.pro/links.txt"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 ;; s ^mxMonito($$ts,7,$j)=$g(%1omCode)_"  ooo="_ooo
 w %mxWeb_%1_%_%_Html_$c(0),*-3
 i $g(%1omCode)[";$$SaveMem;" x "n YX,Y,X,Html,ooo,%mxWeb,o,%1omCode i $$SaveMem^USX(%USID,-%session)"
 k Html,ooo,%accept s %mxWeb=1
 g tcpChil2
saveMem i $l($g(%USID)),$g(%session)>0,$g(%gm) n ooo i $$SaveMem^USX(%USID,-%session)
 q
getStart 
 s:'$l(%USID) %USID=$e($p($p($p(ooo,"UCI=",2),";",3)," "),1,22) 
 ;; s (^(0),%session)=$g(^ooomxWeb(%USID,0),1)+1
 i '$l(%USID) s ooo="<HTML><BODY> -- "_ooo_$zv_" -- user not exists -- ERROR -- </BODY></HTML>" q
 i '$d(^oRC(%USID)) s ooo="<!DOCTYPE HTML><BODY> -- "_ooo_$zv_" -- not exists in "_$zr_" -- ERROR -- </BODY></HTML>" q
 s (^ooomxWeb(%USID,0),%session)=$g(^ooomxWeb(%USID,0))+1
 s %=0,ooo="" d  s:000 ^mxMonito($$ts,7,$j)=$l(ooo)
 . f  s %=$o(^oSaveAsT(%USID,"web_MX_HTML",%)) q:'%  s o=$p(^(%),"// ") s ooo=ooo_o
 . s %="" f  s %=$o(^oAllVars(%USID,%)) q:'%  i %<(-%session) k ^(%)
 x "n YX,Y,X,Html,ooo,%mxWeb,o,%1omCode s %=%session n %session i $$SaveMem^USX(%USID,-%)"
 s ^mxMonito($$ts,6,$j)=$g(YX)_" web %USID="_$g(%USID)_" "_%mxSheet_" $l(ooo)="_$l(ooo)_$zv
 q
getForma n %
 s ooo="",%=%USID n %USID s %USID=$p(%,".")
 i $l(%1omCode)>11 x:'$d(%DatUMs)!'$d(%gm) ";; n %mxSheet,%mxForma,%1omCode,YX,ooo ;; i $$RestMem^USX(%USID,-%session)" d
 . s %="%" f  s %=$o(^oRC(%USID,%mxForma,"?.var",%)) q:'$l(%)  s:'% @%=^(%)
 . x %1omCode  n %mxSheet,%mxForma,%1omCode,YX,ooo  i $$SaveMem^USX(%USID,-%session)
 s %=$o(^oYrc(%USID,%mxSheet,0,0)) i % s YX="[=",ooo=^(%) k ^(%) q 
 q:'$l(%1omCode)
 n %0,Yrc,%insRows,ym,xm,xi,X,Y,%11,%,%1,%22,%123,%formatC
 s Yrc=0,%insRows=0,ym=2,xm=5,xi=5,%formatC=$g(^vmxExcel(%USID,%mxSheet,".format"))
 s Y=0 f  s Y=$o(^cYX(%USID,%mxSheet,Y)) q:'Y  s X=1 f  s X=$o(^cYX(%USID,%mxSheet,Y,X)) q:'X  i $d(^(X,2)) s ^oTQMo(%USID,%mxSheet,Y,X)=$g(^oTQMo(%USID,%mxSheet,Y,X))_";;oRC=?$$Image cYX Size=222"
 f  s Yrc=$o(^oTQMo(%USID,%mxSheet,Yrc)) d:Yrc  i 'Yrc s ^oYrc(%USID,%mxSheet,0,999999)=ooo q
 . s:Yrc["." %insRows=%insRows+1 s Y=Yrc\1+%insRows,o="",X=.2,%123=.123,%11=0 s:Y>ym ym=Y
 . i Yrc'["." f  s X=$o(^oTQMo(%USID,%mxSheet,Yrc,X)) q:'X  s %1=$g(^(X)),%2=$g(^oRC(%USID,%mxSheet,Yrc,X)) d  q:$l(o)>10000
 .. s %="" i X>1,$l(%2)!$l(%1) s %=$f(%formatC,"]"_Yrc_-X_":") i % s %=$p($e(%formatC,%,%+210),"]")
 .. i $e(%2,1,3)="?$$" d  s %=""
 ...  n % s %=$p($p(%2," "),"::",2,9) i $l(%) s %0=%2,%2="" i @% s %2=%0 
 .. s:%2'=%1&$l(%2) %1=%1_";;oRC="_%2 s:$l(%) %1=%1_" ;f;"_% q:'$l(%1)  s:"00.0-  "'[%1 %11=X 
 .. s o=o_"[="_$s(%123+1=X:"~",1:Y_-X_"-")_%1,%123=X
 . i Yrc["." f  s X=$o(^oTQMo(%USID,%mxSheet,Yrc,X)) q:'X  s %1=$g(^(X)) i $l(%1) s o=o_"[="_$s(%123+1=X:"~",1:Y_-X_"-")_%1,%123=X  s:"00.0-  "'[%1 %11=X q:$l(o)>10000
 . i $l(ooo)+$l(o)>10000 s ^oYrc(%USID,%mxSheet,0,Yrc)=ooo,ooo=""
 . s:%123>xm xm=%123 s:%11>xi xi=%11 s:Y'=Yrc ^oYrc(%USID,%mxSheet,Y)=Yrc s ooo=ooo_o
 k ^oY m ^oY=^oYrc(%USID,%mxSheet,0)   s YX="[=",o=$o(^oYrc(%USID,%mxSheet,0,0)),ooo=ym_-xm_-xi_^(o) k ^(o)
 ;; s ^mxMonito($$ts,6,$j)=YX_" web "_%USID_" "_%mxSheet_" $l(ooo)="_$l(ooo)
 q
tcpChilR 
 i $zv'["MiniM" READ %1omCode
 i $zv["MiniM" READ *% s %1omCode=$c(%) f  READ *% q:%<1  s %1omCode=%1omCode_$c(%)
 s:$e(%1omCode,1,4)["zw" ^mxMonito($$ts,0_$g(%USID))=%1omCode_" ::: "_$zt
 s $ztrap="mxErrChR^MX1",%oorxxxw="1"
 i $e(%1omCode,1,5)="CLOSE" w $j,":CLOSE:",0,$c(0),$c(15),*-3 close $p hang 2 HALT
 i '$d(%oorxxxU) s %oorxxxU="" s:$zv["U) " %oorxxxU=1
 i $l(%oorxxxU) s %oorxxxU=$f(%1omCode,"{") d:%oorxxxU
 . n %1,%,s f %=%oorxxxU-1:1:$l(%1omCode) i $e(%1omCode,%)="{" f %1=4,5,6 s s=$e(%1omCode,%+%1) i s="}" s s=$e(%1omCode,%+1,%+%1-1) i s\1=s,s<66200,s>250 s $e(%1omCode,%,%+%1)=$c(s) q
 x %1omCode w 0_$c(0)_$c(15),*-3  ;; w:$g(%oorxxxw)'="0" 0,$c(0),$c(15),*-3
 g tcpChilR
 q
tcpChilRformsm ;; not correct  work
 i $zv["Ca"!($zv["IRIS") READ %1omCode i 1 ;; i $zv["MS" s ^mxMonito($$ts,$g(%USID)_" ")=$e(%1omCode,1,500)
 else  s %1omCode="" f  READ *% q:%<1  s %1omCode=%1omCode_$c(%)
 i $zv["MS" s ^mxMonito($$ts,0)=$e(%1omCode,1,500)
 i $e(%1omCode),$e(%1omCode,1,7)-1000000>0 s %1omCode=$e(%1omCode,8,999999) f %2=1:1:999 d  q:%<0
 . s ^mxMonito($$ts,%2)=1000000_$e(%1omCode,1,500)
 . w 0_$c(0)_$c(15),*-3 s %1="" f  READ *% q:%<1  s %1=%1_$c(%)
 . s ^mxMonito($$ts,%2)=$e(%1,1,500)
 . s %=$e(%1,1,8)-1000000 s:%>0 %1=$e(%1,8,999999) s %1omCode=%1omCode_%1  
 s $ztrap="mxErrChR^MX1",%oorxxxw="1"
 i $e(%1omCode,1,5)="CLOSE" w $j,":CLOSE:",0,$c(0),$c(15),*-3 close $p hang 2 q
 i '$d(%oorxxxU) s %oorxxxU="" s:$zv["U) " %oorxxxU=1
 ;; i $zv["MS" s ^mxMonito($$ts,$g(%USID)_2)=$e(%1omCode,1,500)
 . n %1,%,s f %=%oorxxxU-1:1:$l(%1omCode) i $e(%1omCode,%)="{" f %1=4,5,6 s s=$e(%1omCode,%+%1) i s="}" s s=$e(%1omCode,%+1,%+%1-1) i s\1=s,s<66200,s>250 s $e(%1omCode,%,%+%1)=$c(s) q
 x %1omCode w 0_$c(0)_$c(15),*-3  ;; w:$g(%oorxxxw)'="0" 0,$c(0),$c(15),*-3
 ;; i $zv["MS" s ^mxMonito($$ts,$g(%USID)_2)=$e(%1omCode,1,500)
 g tcpChilR
 q
mxErrChR n e
 s ^mxMonito($g(ooooREAD)+.1,$g(%USID)_" ::: ERROR in : ")=$g(%1omCode)_$ze_" $zt="_$zt_" %mxForma="_$g(%mxForma)_" y="_$g(%YXy)_" x="_$g(%YXx),$zt=""
 s e=$tr(@$zr,$c(0))_" ERRO"_"R ::: "_$ze_" ::: "_$g(%1omCode) s:$zv["U) " e=$$U8^MXF(e)
 s %=$ze,^mxMonito($$ts,$g(%USID)_" ::: ERROR in : ")=e_" ::: "_% s e=$$trw^UST(e,"<mx","<.mx")
 i %["<DISCONNECT>" close $p hang 1 HALT   ;; hang 120
 i %["<WRITE>" close $p hang 1 HALT   ;; hang 120
 s $ec=""  w:'$d(%mxWeb) "ERRO"_"R ::: ",$$trw^UST(e,"<mx","<.mx"),0,$c(0),$c(15),*-3 
 s %=$c(13)_$c(10)
 i $d(%mxWeb) s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 i $d(%mxWeb) s Html=$g(YX)_";"_$g(%USID)_";"_$g(%mxSheet)_";=ERRO"_"R ::: "_$$U8^MXF(e) w %mxWeb_($l(Html)+1)_%_%_Html,$c(0),*-3  s ooo=""  g tcpChil2   ;;; HALT
 I %["<NAMESPACE>" h 1 close $p h 1 HALT
 g tcpChilR
 q
W(%) w $c(0,0),$c($l(%)\256),$c($l(%)#256),%
 q
GTMread ;;w !,"gtm : WRITE /WAIT(%ZNTimeS) :  %ZNCmd=",%ZNCmd,"  SOCKET=",%ZNSock
 q
enterYX(%USID,%mxSheet,%y,%x,%N,%K) q:'$d(%mxWeb) 0
 ;;  20190503  ;; i $e(%K)="<",$e(%K,1,3)'="<mx" q " "_%y_"-"_(%x+1)
 n %,%1,oo,%mxForma,%ooSheet,%mxIndex,%in,%n,%E,oRCresult,%oldoYXq,ooooooYX,%G,%goY,%goX
 n gotoYXyy,gotoYXxx,%oRCmCod,%TQMmCod s %ooSheet=%mxSheet,%qChange=%K
 s %mxForma=$p(%mxSheet,"--"),%G=0,%YXy=%y,%YXx=%x,%E="",%GM=0,%flagEdi=$g(%flagEdi),%K(0)=%K 
 s (%nn,%tabRow)=$$%0Yrc^MXTQM2(%y) s:$e($g(^oRC(%USID,%mxForma,%y,%x)),1,2)["?_" %Yrc=%y
 s %oldoYXq=$g(^oYX(%USID,%mxSheet,%y,%x)),%in=$g(^oRC(%USID,%mxForma,%Yrc,%x))
 i %oldoYXq'=%K,$d(^onChange(%USID,%mxForma,%y,%x)) s %oRCmCod=^(%x),%qChange=%K,%yChange=%y,%xChange=%x
 i %tabRow,%Yrc<%YXy,%YXy-%Yrc+1'=%tabRow s %E=%tabRow_" %Yrc="_%Yrc_"  %YXy="_%YXy g enterYXe
 i $e(%in)="?",$e(%in,1,3)'="?$$" s %N=$tr($p(%in," "),"?_") i "%oo"'[%N,%in[" ;;; ",%N'="%mxIndex" s %oRCmCod=$p(%in," ;;; ",2,99) s:$e($g(^(%x+1)),1,3)="?.." %oRCmCod=%oRCmCod_$e(^(%x+1),4,999)
 i '%tabRow,$e(%K)="="!($e(%K,$l(%K))="=") d  g:$l($g(%E)) enterYXe i $d(%1) x:$e(%K)="=" "s %K"_%K x:$e(%K,$l(%K))="=" "s %K="_$e(%K,1,$l(%K)-1)    ;;  ;;  to-do !! $$formuExc()  
 . s %1=$tr(%K,"+-/*()^_=[]':\#,.;","                 ") i $tr(%1," """)="" k %1 q
 . q:%K["$"!(%K["^")!(%K["_")!(%K["'")!(%K["%")!(%K["[")!(%K["""")!($e(%K)'="=")!%K
 . f %=1:1:$l(%1," ") s %n=$p(%1," ",%) i $l(%n),'%n,$e(%n)'="$",'$d(@%n) s %E=$g(%E)_%n_"--< undef >  "
 i $e(%in)'="?"!($e(%in,1,3)="?$$"),'%tabRow,'$d(%oRCmCod) s ^oYX(%USID,%mxSheet,%y,%x)=%K g enterYXe
 i 0_%mxForma["0t." s %FILE=$e(%mxForma,3,99),%GM=$l(%LI(%FILE),",") 
 else  i %tabRow s %=$g(^oRC(%USID,%mxForma,"?$$TQM",1)),%=$p(%," ",3) i $e(%)="^",%[")" d
 . s %oRCmCod="i '$l($g(%E)),1_$d("_%_") s @$zr@(%N)=%K",%FILE=$e($p(%,"("),2,99),%LII(%FILE)=$e($p(%,"(",2,99),1,$l(%)-1),%GM=0 
 i %tabRow s %=1,%1=-1 f  s %=$o(^oRC(%USID,%mxForma,%Yrc,%)) q:'%  s o=^(%),%n=$p(o," ") i $e(%n,1,2)="?_" s %n=$e(%n,3,99),%1=%1+1,@%n=$p($g(^oYX(%USID,%mxSheet,%y,%)),"<mx ") s:%n["%mxIndex" @%n=%_o s:%n=%N %G=%1 i %G>1 s:$p(o,";")[" ] " %GM=%1
 i %tabRow,%x'>%mxIndex!(%G<2)!'%GM,%flagEdi'[(%y_" "_%mxSheet_" ") d
 . s %flagEdi=%y_" "_%mxSheet_" ",%YX(%y,2)="<mx ic19.-2"
 . n %x x $p(%mxIndex,";;;",2) i '%G,%K="-" s o=$p(%mxIndex,";-;",2) i $l(o) x o s oo="<mx ic46.-2",%E=1
 ;
 i ($e(%K)="=")!($e(%K,$l(%K))="=") d  g:$l(%E) enterYXe i $d(%1) x:$e(%K)="=" "s (oo,%K)"_%K x:$e(%K,$l(%K))="=" "s (oo,%K)="_$e(%K,1,$l(%K)-1)  ;;  ;;  to-do !! $$formuExc()  
 . s %1=$tr(%K,"+-/*()^_=[]':\#,.;","                 ") i $tr(%1," """)="" k %1 q
 . q:%K["$"!(%K["^")!(%K["_")!(%K["'")!(%K["%")!(%K["[")!(%K["""")!($e(%K)'="=")!%K
 . f %=1:1:$l(%1," ") s %n=$p(%1," ",%) i $l(%n),'%n,$e(%n)'="$",'$d(@%n) s %E=$g(%E)_%n_"--< undef >  "
 i '$d(%oRCmCod) g:'%G&%E!(%N="%mxIndex") enterYXe 
 i %tabRow,%flagEdi'[(%y_" "_%mxSheet_" ") s:%G&%GM %YXx=+%mxIndex g enterYXe
 i '$d(%oRCmCod),'$l(%N) s ^oYX(%USID,%mxSheet,%y,%x)=%K g enterYXe
 s:'$l(%K) %K=$g(%WW(%N)) s:%K["<mx "!($e(%K)="?") oo=%K
 i 0_%mxForma["0t.",%G d  i '$l(%K) s:%tabRow>1&'$l(%oldoYXq)&(%'=%N) %K=$g(^oYX(%USID,%mxSheet,%y-1,%x)),oo=%K i '$l(%K) s %E="-- enter info in this cell ! --" g enterYXe
 . s %=%LII(%FILE),%=$p(%,",",$l(%,",")) q:%'=%N  s:$l(%K) @%N=%K,%NEW=$d(@("^"_%FILE_"("_%LII(%FILE)_")"))
 ;;;;;;;;;;;;;;;;;; i %GM!'%tabRow s oRCresult=$$oRC^MXTQM2(%K,%mxForma,%y,%x)
 ;; k ^ERR f %="%YXy","%YXx","%y","%x","%mxIndex","%G","%GM","%goY","%goX","%N","%Yrc","%tabRow","%flagEdi","%TQMformu","%oRCformu" s ^ERR(%)=$g(@%,"<undef>")
  s @%N=%K  x $g(%oRCmCod) x:%tabRow $g(%TQMmCod)
 i $l($g(%E)),$e(%E,1,4)'="%SEL" s @%N=%oldoYXq q " - "_%G_%N_";;=%E=;;"_$$trw^UST(%E,$c(10),"<br>   ")
 i %K(0)'="=%N","ooo"'[%N,%N'?1"%".n s (@%N,^oYX(%USID,%mxSheet,%YXy,%YXx))=$p(%K,"<mx ")   
 i %ooSheet'=%mxSheet q %mxSheet 
 i $d(%SEL) q " - "_%G_%N_";;=%E=;;"_$g(%E)_";;=%E=;;=SEL=;;"_$$ooo2^MXF("%SEL")
 i $d(%YX) x "n %YXy,%YXx  s ooooooYX=$$oYXshowM^MXTQM2(%mxSheet)"
enterYXe s %goY=%YXy,%goX=%YXx+1 s:%K(0)'=%K&'$d(oo) oo=%K 
 ;;  s:$l(%oldoYXq)&(%K'=%oldoYXq)&'$d(oo) oo=%K_"<mx ic19 fb @"_%oldoYXq i $d(oo),'$l(oo) s oo="  "
 i %G,%GM'<%G s:%YXx'>%mxIndex %YXx=+%mxIndex  s:%G=+$g(%GM) %YXx=+%mxIndex,%goY=%YXy+1 s %goX=+$o(^oRC(%USID,%mxForma,%Yrc,%YXx)) s:'%goX %goX=+$o(^oRC(%USID,%mxForma,%Yrc,+%mxIndex))
 i '%G,$l(%N),'%tabRow s o=$g(%EnterLi(%mxForma)) d:'$l(o)  i o[%N s o=$p(o," "_%N_" ",2,9) i $l(o) f %=1:1:9 s %n=$p(o," ",%) q:%n="//"  i $l(%n) s o=$g(^oRC(%USID,%mxForma,"?var",%n)) s:o gotoYXyy=o+(%n=%N),gotoYXxx=+$p(o,"-",2) q
 . s %=0 f  s %=$o(^oRC(%USID,%mxForma,"?$$EnterList",%)) q:'%  s o=o_" "_$p(^(%)," ",2,99) 
 . s %EnterLi(%mxForma)=o_" "
  ;; k ^ERR f %="%YXy","%YXx","%y","%x","%mxIndex","%G","%GM","%goY","%goX","%N","%Yrc","%tabRow","%flagEdi","%oRCmCod","oo","%oldoYXq" s ^ERR(%)=$g(@%,"<undef>")
 q:$g(%n)[":)" 1
 s:$g(gotoYXyy) %goY=gotoYXyy s:$g(gotoYXxx) %goX=gotoYXxx s:$g(%E) %E=";;=%E=;;"_%E_";;=%E=;;"
 q " "_%goY_"-"_%goX_" "_%G_%N_$g(%E)_";;=YX=;;"_$g(ooooooYX)_";;=YX=;;=oo=;;"_$g(oo)
 q
ts() q $$pD^MXD($h,2)
mxMSMtcp 
tcpMSM ; vmx-CONCURRENT-SERVER with tcp port 2666  (msm)  ;
 k ^mxMonito s io=56,^mxMonito($$ts,1,-$j)="START tcpMSM port 2666 "
initMSM ; Process the init state MSM
 x "S nt=($ZB($V(0,-4,2),#F,1)=10)"    ; Determine OS type, NT or not NT
 close 56 open 56:(:nt*8):"TCP"   ; Open and initialize the device
 ;; s %=$c(%1) i %1>-1 f  r *%1:0 q:%1<0  s:%1>0 %=%_$c(%1)
 ;; s ^mxMonito($$ts,1,$j)=%_-$l(%) i %'["UCI=" u 0 g tcpMiniM  ;; d:000  close $io  g tcpMiniM
 use 56   s %lddb=$KEY,rr(0)=%lddb g listeMSM
 q
listeMSM ; Process the ntlisten state
 use 56:(%lddb)
 s ^mxMonito($$ts,1,-$j)="listeMSM %lddb="_%lddb_"   nt="_nt  h 1 
  x "W /SOCKET("""",2666) S %xddb=$KEY,lza=$ZA,lzb=$ZB,lzc=$ZC,%ddb=$ZH(%xddb)"
 s ^mxMonito($$ts,1,-$j)="%xddb="_%xddb_" lza="_lza_"  lzb="_lzb_"  lzc="_lzc_"  %ddb="_%ddb h 1 
 I lzc&(lzb=-8) G listeMSM
 I lzc G initMSM
 ; Save the caller address
 x "S addr=$V(%ddb+16,-3,0)"
 x "S %(""ADDRESS"")=$V(addr+13,-3,$V(addr+12,-3,1),9)"
 x "U 56:$ZH(+%ddb)"
 ;
 ;;; Associate the ddb with this job :
 ;;x "V %ddb+46::$J-$V(272,-4,4):2"
 ;;; Check for accept error :
 ;;I lzc&(lzb=-8) G listeMSM
 ;;I lzc G initMSM
 ;; g x
 s ^mxMonito($$ts,1,-$j)="START MSM "_io
 ;
 d tcpChild^MX1
 h 2 g listeMSM
 q
nspace(name) 
  ; zn "%SYS" d ^DATABASE
  zn "%SYS"
  x "s o=##class(Config.Configuration).AddNamespace(name,name,name)" 
  q o
 q
rest(%USID,%UCI,%1omCode) 
 ;; n (%USID,%UCI,%1omCode)
 if '$d(%USIDoo)!$g(^oAllVars(%USID_"*",%UCI,-2)) s %1=%USID,%2=%UCI d   s %USIDoo=%USID
 . n %USID,%UCI,%omCode,%request,%response,%SYSLOG,%session,skipheader,tAuthorized,tRedirectRoutine,tRedirected,tSC,tURL,%zt,%j  if 1_$$RestMem^USX(%1_"*",%2)
 ;
 s ooo="",%zt=$zt,%zns=$znspace,$ztrap="restErr^MX1",%io=$io
 s ^|"%SYS"|trm($j)=$znspace_" "_%USID_" "_$zt 
 k ^oooorest($j)
 ;;  s:$e(%1omCode,1,4)["zw" ^mxMonito($$ts,0_$g(%USID))=%1omCode_" ::: "_$zt
 s %oorxxxU=$f(%1omCode,"{") d:%oorxxxU
 . n %1,%,s f %=%oorxxxU-1:1:$l(%1omCode) i $e(%1omCode,%)="{" f %1=4,5,6 s s=$e(%1omCode,%+%1) i s="}" s s=$e(%1omCode,%+1,%+%1-1) i s\1=s,s<66200,s>250 s $e(%1omCode,%,%+%1)=$c(s) q
 D $ZU(82,12,1)
 x %1omCode   if '$d(%USID) d oo^MXterm  ;;  w 0_$c(0)_$c(15),*-3 
 D $ZU(82,12,0)
 n % s %=0,ooo="" f  s %=$o(^|%zns|oooorest($j,%)) q:'%  s ooo=ooo_^(%)
restE 
 if $l($g(%USID)),$znspace=$g(%UCI),$$SaveMem^USX(%USID_"*",%UCI)
 q $g(ooo)
restErr s:$l($g(%zt)) $zt=$g(%zt),ooo="ERROR ::: "_$ze_"  "_ooo   D $ZU(82,12,0)
 g restE
 q

MX2^INT^1^65495,42075^0
MX2 ;[ 20191011 20:14:18 ]
 ; M3-LITE, MSM, CACHE, GT.M-5x
QQ ; TKWEB ; start mxWeb 
 s %USID=$g(%("FORM","U")),oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) a="127.0.0.1"
 i %USID="" s %USID=a s:%USID="127.0.0.1" %USID="es"
 s:%USID %USID="u"_$p(%USID,".",4)
 s:$l(a) ^o(a)=%USID
 w "<html>" k ^oProc m ^oProc=% s ^oProc("ADDRESS")=a
 ;;w "<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.0 Frameset//EN"">",!
 w "<head><title>mxWeb</title>",!
 ;w "<SCRIPT></SCRIPT>",!
 w "<HTA:APPLICATION ID=""WL"" APPLICATIONNAME=""WebLink"" ICON=""http://localhost/gb/weblink1.ico""",!
 W " CONTEXTMENU=""NO"" SCROLL=""NO"" SINGLEINSTANCE=""YES"" VERSION=""2.0"" WINDOWSTATE=""maximize"">",!
 w "</head>",!
 w "<frameset frameborder=0 framespacing=0 border=0 cols=* rows=55,*>",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQTITL^MX"" application=yes name=QQTITL noresize scrolling=no >",!
 w "<frameset frameborder=0 framespacing=0 border=0 cols=""225,*"" rows=""*"">",!
 w "<frameset frameborder=0 framespacing=0 border=0 cols=""*"" rows=""0,*"">",!
 w "<frame marginwidth=0 marginheight=0 application=yes name=""code"" noresize >",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQMENU^MX"" application=yes name=QQMENU noresize >",!
 w "</frameset>",!
 w "<frameset rows=95%,5% >",!
 w "<SCRIPT> </SCRIPT>",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQFORM^MX"" application=yes name=QQFORM noresize scrolling=auto >",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQEMPT^MX"" application=yes name=QQCOMM noresize scrolling=no >",!
 w "</frameset></html>"
 Q
QQTITL ; TKWEB ; frame title
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s %USID=^o(a),oxxxo=$p(oooo,"&A=",2,99)
 i oxxxo="" s oxxxo="d w7^MX"
 d getVars
 w "<HTML>"
 w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQTITL</TITLE></HEAD><BODY>",!
 w "<table width=1020 border=0 cellspacing=0 cellpadding=0 "
 w " align=center style=""position: absolute; left: 0; top: 0"">",!
 ;;W "<tr valign=""top""> ",!
 ;;w "<td width=1020 colspan=2 height=30 bgcolor=#FFFFFF>"
 ;;w "<img src=""toppen.jpg"" width=""2100"" height=30 ></td></tr>",!
 w "<tr><td width=1020 colspan=2 height=30>",!
 f o=1:1:6 w "<img src=blaknapp.jpg width=170 height=30>"
 w "</td></tr>",!
 W "</table>",!
 w "<SCRIPT></SCRIPT>",!
 d oxxxo
 Q
w7 
 f o=%USID k ^MsgVM(o),^MsgMV(o),^MsgMVM(o),^MsgVMV(o),^mxM(o)
 ;;s $zt="Ervb^USX"
 i $$NewDate^MXD
 s %XD81=$g(%XD81,20020101),%XD82=$g(%XD82,20021231)
 i $$icDate^MXD(%XD81,%XD82)
 i $$icFIRMA^fir(1)
 w "<table bgcolor=silver width=100% style=""position: absolute; left: 0; top: 30"">"
 w "<tr><td> ",$$u^MX($g(%FIRMA)),"</td><td> ",$$u^MX($g(%DatUMs)),"</td> "
 w "<td>",%UCI,"</td>"
 w "</tr></table>"
 Q
QQMENU ; TKWEB  ; frame of the menu
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99) s:oxxxo="" oxxxo=" d mxMENU "
 d getVars
 W "<HTML>"
 ;w "<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.0 Frameset//EN"">",!
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQMENU</TITLE>",!
 ;w "<SCRIPT type=""text/javascript"" language=""JavaScript"" >",!
 ;------------------------- SCRIPT ---------------------------
 w "<SCRIPT language=JavaScript >",!
 w "function jsMXmenu(line) {",!
 w "o21=new String; id=new String",!
 w "yMax=MENU.rows.length;",!
 w "if (line==yMax) {yMax=0;}",!
 w "o21=MENU.rows(line).getAttribute('VALUE'); le=o21.length-1",!
 w "vi=MENU.rows(line+1).style.display ; ",!
 w "im=MENU.rows(line).all.length-1 ; ",!
 w "id=MENU.rows(line).all[im].getAttribute('id') ;",!
 w "if ((id.charAt(0)=='o')&&(vi=='none'))   {",!
 w "  MENU.rows(line).all[im].style.display='inline'; ",!
 w "  MENU.rows(line).all[im-1].style.display='none';}",!
 w "if ((id.charAt(0)=='o')&&(vi=='inline')) {",!
 w "  MENU.rows(line).all[im].style.display='none'    ; ",!
 w "  MENU.rows(line).all[im-1].style.display='inline';}",!
 ;
 ;w "window.alert(id)",!
 w "for (y=line+1; y<yMax; y++) {",!
 w " o21=MENU.rows(y).getAttribute('VALUE');",!
 w " if (o21.charAt(le)=='1') {MENU.rows(y).style.display='none';",!
 w "   im=MENU.rows(y).all.length-1 ; ",!
 w "   id=MENU.rows(y).all[im].getAttribute('id') ;",!
 w "   if (id.charAt(0)=='o') {",!
 w "     MENU.rows(y).all[im-1].style.display='inline'; ",!
 w "     MENU.rows(y).all[im].style.display='none';}    ",!
 w "  }",!
 w " if (o21.charAt(le)!='1') break;",!
 w "}",!
 w "if (vi=='inline') {yMax=0;}",!
 ;
 w "for (y=line+1; y<yMax; y++) {",!
 w " o21=MENU.rows(y).getAttribute('VALUE');",!
 w " if (o21.charAt(le)!='1') break;",!
 w " if ((o21.charAt(le)=='1')&&(o21.charAt(le+1)!='1')) "
 w "              {MENU.rows(y).style.display='inline';}",!
 w "}"
 w "} </SCRIPT>",!
 ;-------------------------------------------------------------
 w "</HEAD>",!
 w "<BODY bgcolor=#b6c4d5 >",! ;;onload='jsMXmenuStart()' >",!
 d oxxxo
 Q
T1menuA ; Example : conv some enother table to '^T1menu'
 s %B=$c(254)
 s o="" f n=1000:1000 s o=$o(^menu(o)) q:o=""   d
 . s ^T1menu(n)=%B_2_%B_%B_o_%B_%B_%B_"closed",oo=""
 . f nn=100:100 s oo=$o(^menu(o,oo)) q:oo=""  d
 ..  s ^T1menu(n+nn)=%B_1_%B_^menu(o,oo),%=$zr
 ..  i nn=100 s $p(^T1menu(n),%B,5)=$p(^menu(o,oo),%B,3)
 ..  s f=$p(^menu(o,oo),%B,2) q:f=""
 ..  i $d(^AL(f)) s $p(@%,%B,5)=$g(^AL(f,"NAME"))
 Q
mxMENU ;  create frame 'QQMENU'
 d:'$d(^T1menu) T1menuA
 w "<table id=MENU border=0 cellpadding=0 cellspacing=0 >",!
 s o="" f n=0:1 s o=$o(^T1menu(o)) q:o=""  s oo=^(o) d
 . w:n#9=0 "<SCRIPT> </SCRIPT>",!
 . s o21=$p(oo,%B,2),mo=$p(oo,%B,3),mtxt=$p(oo,%B,4),text=$p(oo,%B,5)
 . s ref=$p(oo,%B,6),img=$p(oo,%B,7) s:"- "[text text=mo_" "_mtxt
 . w "<tr title='",$$u^MX(text),"' value=",o21
 . i o21[2 w " onclick=""jsMXmenu(",n,")""; "
 . w " STYLE=""cursor: hand; "
 . w:$e(o21)=1 " display:none; "
 . w " font: icon; "
 . w " margin: 0; padding: 0; border-width: 0; "
 . w " overflow: hidden; color:#112299; "
 . w " "" ><td VALIGN=TOP nowrap >"          ;;;;;;;;;;;;;
 .f o1=1:1:$l(o21) i $e(o21,o1)=1 s oo21=$o(^T1menu(o)) d
 .. i $e(o21,o1+1)=1 w "<img src='menu_bar.gif'>" q
 .. i oo21'="" s oo21=$p(^(oo21),%B,2)
 .. i o21=oo21 w "<img src='menu_tee.gif'>"
 .. else    w "<img src='menu_corner.gif'>"
 .d
 .. i img["closed" d  q
 ...    w "<img id=c",n," src='menu_folder_closed.gif'>"
 ...    w "<img id=o",n," src='menu_folder_open.gif' "
 ...    w " STYLE='display:none;'>"
 .. i $l(img)<3    w "<img id=i",n," src='menu_link_ie.gif'>" q
 .. w "<img id=i",n," src='",img,"'>"
 . ;
 .s x=" w """_n_"""",b=" -- ",tt="b,o21,b,mtxt,b,text,b,ref,b,img"
 .f nn=1:1:$l(tt,",") s x=x_","""_$$u^MX(@($p(tt,",",nn)))_""""
 .d
 .. i $l(ref)>2 w "<a href='",ref,"' >",$$u^MX(text)," </a>" q
 .. i o21_.2[2.2 w mtxt," ",$$u^MX(text) q
 .. w "<a href='XX^MX?&A=",x," ;' target=QQCOMM >",$$u^MX(text)," </a>"
 .w "</td></tr>",!
 w "</table>"
 Q
QQFORM ; TKWEB   ; frame of forms
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99) s:oxxxo="" oxxxo=" k %XD81 i $$d8^MXD "
 W "<HTML>"
 d getVars
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQFORM</TITLE></HEAD>",!
 W "<BODY alink=#437a70 bgcolor=#b6c4d5 leftmargin=0 link=#7d354b marginheight=2 marginwidth=0 text=#222222 topmargin=2 vlink=""#7d354b"" xxOnLoad=xOnLoad()>",!
 W "<table border=0 valign=top cellpadding=0 cellspacing=0 width=542 height=425 style=""position: absolute; left: 44; top: 168"">",!
 W "<tr valign=top> ",!
 W "<td align=center height=61 width=500 > ",!
 W "<p><b><font color=""#5B7693""><font face=""Britannic Bold"" size=""7""> - mxWeb - </font>",!
 W "<font color=#5B7693><br><font size=5 >",$$u^MX($g(^mvars(%USID,0,"%FIRMA"))),"</font></td></tr></table>",!
 ;;;
 ;W "<tr><td valign=top align=center width=55 height=25 ><b>UserName </b></td>",!
 W "<table border=1 valign=top cellpadding=0 cellspacing=0 style=""position: absolute; left: 155; top: 268"">",!
 W "<tr><td valign=top align=center width=55 height=25 style=""align: right "" ><b>UserName </b></td>",!
 W "<td valign=top width=211 height=25 > ",!
 W "<input type=text size=26 maxlength=30 name=UserName tabindex=1 value=CASIO ></td></tr>",!
 W "<tr><td valign=top align=center width=55 height=25 ><b>Password </b></td>",!
 W "<td valign=top width=211 height=25 > ",!
 W "<input type=password size=26 maxlength=25 name=Password tabindex=2 value=CASIO ></td></tr>",!
 W "<tr><td></td><td align=left height=45 width=211> ",!
 W "<p align=left> ",!
 W "&nbsp; <input type=image src=""login.gif"" width=93 height=22 border=0 ></td></tr></table>",!
 d oxxxo
 Q
QQCOMM ; TKWEB  ; frame of comments
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99)
 W "<HTML>"
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQCOMM</TITLE></HEAD><BODY>",!
 d oxxxo
 Q
XX ; TKWEB  ; execut &A=oxxxo
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99)
 W "<HTML><HEAD><TITLE>mx-XX</TITLE></HEAD><BODY>",!
 d oxxxo
 q
oxxxo ;        ; execut &A=oxxxo
 n (%USID,oxxxo,%) s %j=7,^o("oxxxo")=oxxxo
 i oxxxo'[";!fast!;" s %=$$RestMem^USX,oxxxo=$g(^o("oxxxo"))
 d getVars
 i oxxxo'[";/:\;" x oxxxo i 1
 else  f zxxxo=1:1:$l(oxxxo,";/:\;") s o=$p(oxxxo,";/:\;",zxxxo) x o
 i $g(oxxxo)'[";!fast!;",$g(oxxxo)'[";!rest!;",$$SaveMem^USX
 w "</BODY></HTML>"
 Q
getVars ; get m-vars from enother frames
 n o,oo
 s oo="" f  s oo=$o(%("FORM",oo)) q:oo=""  i oo["_t" d
 . s o=$p(oo,"_") i $l(o) s ^mvars(%USID,0,o)=%("FORM",oo)
 Q
bfRead(f) 
 ; binary files reading
 n o,x o "file":(f:"RI") k ^r
 f o=1:1 u "file" r *x q:$zc  s ^(o\20)=$g(^r(f,o\20))_","_x
 c "file" q o
QQEMPT ; TKWEB  ; empty page
 W "<html><body bgcolor=#b6c4d5>" x "s %UCI=$zu($zv[""Ca""*5)"
 w "<p align=center>",$$d8t^MXD($$pD^MXD($h))," ",%UCI," ",$zv,"</p></body></html>"
 Q
MXTKWEB ; TKWEB   ; frame of ^oTQMret(%USID) --> ^|"%SYS"|omxTKWEB(%mxTKWEB)
 ;;;s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")),%USID=^o(a)
 ;;;s oxxxo=$p(oooo,"&A=",2,99) s:oxxxo="" oxxxo=" k %XD81 i $$d8^MXD "
 s %mxTKWEB=1 s ^oMonito($h)=$g(oxxxo)_$g(%mxTKWEB)
 s nuf=$g(^oe(%mxTKWEB)),y="",w="" f o="YY","XX" s @o=$g(^oExcelSh(nuf,o))
 s %UCI=$p(nuf,":"),%USID=$p(nuf,":",2),%FORM=$p(nuf,":",3)
 f %=1:1:$l(XX," ") s o=$p(XX," ",%),$p(w,":",+o)=$p(o,":",2)
 f %=1:1:$l(w,":") s o=$p(w,":",%) s:o $p(w,":",%)=o*1.4\1 s:'$l(o) $p(w,":",%)=$p(w,":",%-1)
 f %=1:1:$l(YY," ") s o=$p(YY," ",%),$p(y,":",+o)=$p(o,":",2),$p(y,":",+o)=($p(y,":",+o)\1)
 ;;f %=1:1:$l(y,":")+99 s o=$p(y,":",%) s:o $p(y,":",%)=o*1 s:'$l(o) $p(y,":",%)=$p(y,":",%-1)
 W "<HTML>"
 ;;d getVars
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>-mx-oTQMret-oTKW-</TITLE></HEAD>"
 W "<BODY alink=#437a70 bgcolor=#b6c4d5 leftmargin=0 link=#7d354b marginheight=1 marginwidth=0 text=#222222 topmargin=2 vlink=""#7d354b"" xxOnLoad=xOnLoad()>"
 ;;w y
 W "<table border=0 valign=top cellpadding=0 cellspacing=0 >"
 W "<tr valign=top> "
 W "<td align=center height=6 width=500 > "
 ;W "<p><b><font color=""#5B7693""><font face=""Britannic Bold"" size=""3"">mxWeb "_$g(%ns)_" "_$g(%USID)_" "_$g(%FORM)  ;;_" </font>",!
 W "<p><b><font color=""#5B7693"">",nuf,"  %UCI=",%UCI," </font>"
 ;;W "<font color=#5B7693><br><font size=5 >",$$u^MX($g(^mvars(%USID,0,"%FIRMA"))),"</font></td></tr></table>",!
 ;;;
 ;W "<tr><td valign=top align=center width=55 height=25 ><b>UserName </b></td>",!
 ;;;W "<table border=1 valign=top cellpadding=0 cellspacing=0 style=""position: absolute; left: 155; top: 268"">",!
 ;;;W "<tr><td valign=top align=center width=55 height=25 style=""align: right "" ><b>UserName </b></td>",!
 ;;;W "<td valign=top width=211 height=25 > ",!
 ;;;W "<input type=text size=26 maxlength=30 name=UserName tabindex=1 value=CASIO ></td></tr>",!
 ;;;W "<tr><td valign=top align=center width=55 height=25 ><b>Password </b></td>",!
 ;;;W "<td valign=top width=211 height=25 > ",!
 ;;;W "<input type=password size=26 maxlength=25 name=Password tabindex=2 value=CASIO ></td></tr>",!
 ;;;W "<tr><td></td><td align=left height=45 width=211> ",!
 ;;;W "<p align=left> ",!
 ;W "&nbsp; <input type=image src=""c:/mx/lamxxxer.gif"" width=55 height=22 border=0 ></td></tr></table>"
 ;;;d oxxxo
 ;;;W "<table border=1 valign=top cellpadding=0 cellspacing=0 style=""position: absolute; left: 155; top: 268"">",!
 W "<table border=0 valign=top cellpadding=0 cellspacing=1 <font color=""#2B3633"" size=1 /font> >"
 k flagTabl s %YXy=0,flagTabl=0,yy=10,h=1,y2=0,%YXxm=0,%th=0
 f %2yy=1:1:99 s %YXy=$o(^oe(nuf,%YXy)),y2='flagTabl+y2 q:'%YXy  q:'$o(^oe(nuf,%YXy,2))  d:00 MXTKWEBt s ww=11,%=$p(y,":",y2) s:%="" %=h s h=% i h f %YXx=2:1 s:'$o(^oe(nuf,%YXy,%YXx-.1)) %YXx=0 d:%YXx  i '%YXx w "</tr>" s yy=yy+h+5+(''flagTabl*2) q
 . i %YXx=2 s %0=$g(^oe(nuf,%YXy,0)) s:%0 %th=0,flagTabl=%0 i '%th,'%0,$g(^oe(nuf,%YXy+3,0))+$g(^oe(nuf,%YXy+4,0)) s %th=1 d MXTKWEBt
 . i %YXx=2,flagTabl,'%0 k flagTabl s flagTabl=0 w "</table><table border=0 valign=top cellpadding=0 cellspacing=0 ><tr>" 
 . i %YXx=2 w "<tr>"  ;;,"<td>",%th,"</td>","<td>",flagTabl,"</td>","<td>",%0,"</td>"
 . q:'$p(w,":",%YXx)  s oo=$g(^(%YXx)) w:oo["$$B " $$ooB(oo) s:"?"[$e(oo) oo=""  s:%YXx>%YXx %YXxm=%YXx
 . i flagTabl,oo=0!(oo&$p(oo,".",2)),%YXx>3 s oo=$j(oo,0,2),flagTabl(%YXx)=2 s:'oo oo=""
 . i $g(flagTabl(%YXx))=2,oo=0!oo s oo=$j(oo,0,2) s:'oo oo=""
 . s a=" " i %YXx>3&oo!$g(flagTabl(%YXx)) s a=" align=right " 
 . s cc=" " i a=" ",$l(oo)>2,%th,$g(^oe(nuf,%YXy,%YXx+1))="" s cc=" COLSPAN=2 "
 . s o="""#3B5673"" size=2" s:$e(oo)="=" o="""#2B2623"" size=2",oo=$$funExcel(oo) s font="<font color="_o_" /font>"
 . ;;w "<td wrap height="_(h+5)_" style=""position: absolute; height: "_(h+5)_"; width:"_$p(w,":",%YXx)_"; left:"_ww_"; top:"_yy_""" "_a_cc_$$MXTKWEBf(.oo)_" >"_font_"<NOBR>",$$u^MX($e(" "_oo_" ",1,50)),"</NOBR></td>"
 . i %th w "<th BGCOLOR=""#a6b4c5"" width="_$p(w,":",%YXx)_" wrap height="_(h+5)_" "_a_cc_$$MXTKWEBf(.oo)_" >",font,$$u^MX(" "_oo_" "),"</th>"
 . i '%th w "<td width="_$p(w,":",%YXx)_" wrap height="_(h+5)_" "_a_cc_$$MXTKWEBf(.oo)_" >",font,"<NOBR>",$$u^MX(" "_oo_" "),"</NOBR></td>"
 . ;;w "<td style=""border-right: 1px solid gray; border-bottom: 1px solid gray;"" width="_$p(w,":",%YXx)_a_$$MXTKWEBf(.oo)_" ><font color=""#6B8693"" size=2 /font>",$$u^MX(" "_oo),"</td>"
 . s ww=ww+$p(w,":",%YXx)+1
 . i cc[2 s %YXx=%YXx+1
 w "</table>"
 d
 .W "<table border=0 valign=top cellpadding=0 cellspacing=1 style=""font: size=1"" >"
 .s %YXy=0,%YXxm=20
 .f  s %YXy=$o(^oe(nuf,%YXy)) q:'%YXy  w "<tr><td>",%YXy,"</td>" f %YXx=0:1:%YXxm s oo=$g(^oe(nuf,%YXy,%YXx)) s:$e(oo)="?" oo="" w "<td>",font,$$u^MX(oo),"</td>" i %YXx=%YXxm w "</tr>"
 .w "</table>"
 .q
 w "<table border=1><tr><td> UCI=",%UCI,"</td><td> %USID=",%USID,"</td><td> %mxForma=",%FORM,"</td><td>   ",$$pD^MXD($H,2),"</td><td><input type=image src=""c:/mx/lamer.gif"" width=55 height=22 border=0 ></td></tr>"
 w "</table>"
 i $zv["Ca"!($zv["IRIS") x "s %fromUCI=$zu($zv[""Ca""*5)" i %fromUCI="%SYS" zn %UCI d  zn %fromUCI
 .n %UCI,%fromUCU x "s %UCI=$zu($zv[""Ca""!($zv[""IRIS"")*5)"
 .W "<table border=1 valign=top cellpadding=0 cellspacing=1 style=""font: size=1"" >"
 .s %form=0  w "<tr><td>",%UCI,"</td>"
 .f  s %form=$o(^oTKMe0(%USID,%form)) q:%form=""  w "<td>",%UCI,":",%USID,":",%form,"</td>"
 .w "</tr></table>"
 .q
 i $zv["Ca"!($zv["IRIS") x "s %fromUCI=$zu($zv[""Ca""*5)" i %fromUCI="%SYS" zn %UCI d  zn %fromUCI
 .s %mxForma=%FORM,%j=1,o=$$NewDate^MXD
 .k ^oTQM(%USID) m ^oTQM(%USID)=^oTQMe0(%USID,%mxForma)  s o=$$TQM^MXTQM()
 .W "<table border=0 valign=top cellpadding=0 cellspacing=1 style=""font: size=1; color=green "" >"
 .s %YXy=0,%YXxm=20
 .f  s %YXy=$o(^oTQMret(%USID,%YXy)) q:'%YXy  w "<tr><td>",%YXy,"</td>" f %YXx=0:1:%YXxm s oo=$g(^oTQMret(%USID,%YXy,%YXx)) s:$e(oo)="?" oo="" w "<td>",font,$$u^MX(oo),"</td>" i %YXx=%YXxm w "</tr>"
 .w "</table>"
 .q
 w "<a href='http://www.gismeteo.ru/towns/26406.htm'><img src='http://informer.gismeteo.ru/graph/G26406-1.GIF' border=0></a>"
 w "</BODY></HTML>"
 Q
MXTKWEBt s:$g(^oe(nuf,%YXy,1))="~" $p(y,":",%YXy)=0
 ;;s o=$g(^oe(nuf,%YXy+1,1)) i o-1,$o(^oe(nuf,%YXy))'["." q
 ;;i $g(^oe(nuf,%YXy,1))_$g(^oe(nuf,%YXy-1,1))="__" q
 w "</table><table border=1 valign=top cellpadding=0 cellspacing=0 >" ;;s flagTabl=-%YXy
 ;;s o=$o(^oe(nuf,%YXy)) i o["." s flagTabl=$p(o,".",2)+2 
 ;;w "</table>" W "<table style=""border-left: 1px solid black; border-top: 1px solid black;"" valign=top cellpadding=0 cellspacing=1 >" s flagTabl=%YXy
 q
MXTKWEBf(oo) 
 q:oo'["<mx " ""  s f=$p(oo,"<mx ",2,9),oo=$p(oo,"<mx ")
 i $p(f,"ic",2) ;; w " BGCOLOR=""#b6d4d5""" 
 q ""
funExcel(oo,z,%y,%x) 
 n %,%1,%2,y1,y2,o,o9,y  s o9="1234567890,:",%y=$g(%y,%YXy),%x=$g(%x,%YXx)
 q:$e(oo)'="=" oo s:'$d(z) z=$name(^oe(nuf))
 s %1=$p(oo,":"),%2=$p(oo,":",2),y1=$tr(%1,o9_%1,o9),y2=$tr(%2,o9_%2,o9)
 s:oo["=SUBTOTAL(" y1=$p(y1,",",2) s y1=+y1,y2=+y2
 i y1+1=y2,+$g(@z@(y2,0))=1 f %=y2:1 q:'$g(@z@(%,0))  s y2=% 
 i 11111_oo["1111=SUM(" f y=y1:1:y2 s oo=oo+$g(@z@(y,%x))
 i 1_oo["1=SUBTOTAL(9," f y=y1:1:y2 s oo=oo+$g(@z@(y,%x))
 i 1_oo["1=SUBTOTAL(3," f y=y1:1:y2 s oo=oo+''$l($g(@z@(y,%x)))
 q:oo["." $j(oo,0,2)  q oo
sysTKWEB(%) s %sys="MGR,MXM" s:$zv["Ca" %sys="USER"  s:'$g(%) %=1
 x "s %UCI=$zu($zv[""Ca""*5),nuf=%UCI_"":""_%USID_"":""_%mxForma"
 k ^|%sys|oe(+%) m ^|%sys|oe(+%)=^oTQMe(%USID) s ^|%sys|oe(+%)=nuf
 k ^|%sys|oe(nuf) m ^|%sys|oe(nuf)=^oTQMe(%USID)
 k ^|%sys|oExcelSh(nuf) m ^|%sys|oExcelSh(nuf)=^oExcelSh(%USID,%mxForma)
 q %
ooB(oo) q ""  
 w "<td><FORM width=5 height=4 NAME=""Form1"" ACTION="""_$$u^MX("//localhost.MXTKWEB^MX2:1")_""">"
 ; {1072}<INPUT TYPE="hidden" NAME="info" VALUE="{1047}{1072}{1087}{1080}{1089}{1100} {1074}{1072}{1073}{1072}{1085}{1102} {1085}{1072}{1072}{1074}{1086}{1089}{1082}{1088}{1077}{1089}{1077}{1085}{1100}{1077}">
 ;{1072} <INPUT TYPE="radio" NAME="sex" VALUE="Male" CHECKED> {1052}{1091}{1078}{1080}{1082}<BR>
 ; {1072}<INPUT TYPE="radio" NAME="sex" VALUE="Female"> {1041}{1072}{1073}{1072}<BR>
 ; {1072} {1048}{1084}{1103}:<BR>
 ; {1072}<INPUT TYPE="text" NAME="textfield" VALUE="{1042}{1072}{1089}{1103} {1055}{1091}{1087}{1082}{1080}{1085}" SIZE="30" MAXLENGTH="60"><BR>
 ; {1072} {1055}{1072}{1088}{1086}{1083}{1100}:<BR>
 ;{1072} <INPUT TYPE="password" WIDTH="10" NAME="passwd"><BR><BR>
 w "<INPUT TYPE=""submit"" VALUE="" "" width=4 height=3 >"
 w "</FORM></td>"
 q ""
GTMLINK(port) 
   ;Based on Socket Examples from fscwitte@users.sourceforge.net
   ; NO ^ROUTINE ENTRY
   n ver
   s:port="" port=8000
   s ver=$e($zv,1,10)
     i ver["GT.M" j START^%MLINK(port) q
     i ver["Cache" j srv^%MLINK(port) q
   QUIT
   ;
START(%ZNPort)   ;Start the Server
   ;S %ZNPort=800
   S %ZNDev="SCK$"_$J
   O %ZNDev:(ZLISTEN=%ZNPort_":TCP":NODELIMITER:ATTACH="listener"):60:"SOCKET"
   E  Q
   ; USE fills $KEY with "BOUND|socket_handle|portnumber"
   U %ZNDev
   ;
   ; Start listening, sets $KEY to "LISTENING|socket_handle|portnumber"
   W /LISTEN(1)
   ;
   ; Wait for connection, $KEY will be "CONNECT|socket_handle|remote_ipaddress"
1 
   F  D  q:$KEY]""
   . W /WAIT(60)
   . I $KEY]"" Q
   ;
   ; Store the connection socket in local variable,
   S %ZNSock=$piece($KEY,"|",2)
   C %ZNDev:(SOCKET="listener") J START^GTMLINK ;close listener and start another GT.M Link to listen port
   S $ZTRAP="GOTO ERROR^GTMLINK"
2   U %ZNDev:(SOCKET=%ZNSock)
   W "glc_READY:",$c(0)
   ;
   s qqnump=$j
   x "s qW=##class(%Library.qWORD).%New()"
   x "s qARM=##class(%Library.TqARM).%New()"
     s qqlang=1
3       F  D      
   . s %ZNData=$$GETDATA() q:%ZNData=""
   . i %ZNData="" q
   . q:%ZNData=$c(1)
   . I %ZNData="glc_EXIT:" W "glc_DISCONNECTED:",$c(0) s ^tmplink("close",$j)=$h_"~EXIT" C %ZNDev H
   . I $P(%ZNData,":",1)="glc_EXECUTE" D
   .. W $c(1,2,3,4,5,6,7,8,9)
   .. I %ZNData["getsessionid=1" k:$d(^%session($JOB)) ^%session($JOB) s ^%session($JOB)=$h
   .. F %ZTemp=0:1:9 s %Var="P"_%ZTemp,@%Var=$p(%ZNData,$c(1),%ZTemp+2)
   .. S %ZNCommand=$P($P(%ZNData,":",2,9999),$c(1),1)
   .. S:%ZNCommand[($c(5)_"xmldata=1") %ZNCommand=$p(%ZNCommand,$c(5)_"xmldata=1",1)
   .. S P9=""  
   .. X:%ZNData'["getsessionid=1" %ZNCommand
   .. s:%ZNData["getsessionid=1" P0=$JOB
   .. F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   .. W "glc_EXRESPONSE:<registry>",P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$c(1)
   .. W $c(9,8,7,6,5,4,3,2,1)
   s ^tmlink("close",$j)=$h
   C $I
   H
GETDATA() 
         n c,d,end,c1
         S (d,end,c1,c)=""
         d FINDST
         f  d  q:end=1
         .R *c:60 q:'$T
         .S d=d_$C(c)
         .S c1=c1_c
         .s:c1[987654321 d=$p(d,$c(9,8,7,6,5,4,3,2,1),1),end=1
         .q
         s ^tmlink("open",$j)=d
         q d
FINDST 
         n c,end,str
         s (c,end,str)=""
         f  d  q:end=1
         .R *c:60 q:'$T
         .q:(c<1)!(c>9)
         .s str=str_c
         .s:str[123456789 end=1
         .q
         q
ERROR 
   W $c(1,2,3,4,5,6,7,8,9)
   F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   s ^GTMERROR($j,$h)=$TR($ZSTATUS,$C(13,10),"")
   U %ZNDev:(SOCKET=%ZNSock)
   W "glc_ERROR:"_$TR($ZSTATUS,$C(13,10),""),$C(1),"<registry>",P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$C(1),$c(9,8,7,6,5,4,3,2,1)
   g 3
sererror 
   W $c(1,2,3,4,5,6,7,8,9)
   F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   s ^GTMERROR($j,$h)=$ZERROR
   W "glc_ERROR:"_$zerror,$C(1),"<registry>",P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$C(1),$c(9,8,7,6,5,4,3,2,1),*-3 
   g 4
srv(port) 
     n dev,mode,jobflag,id,end
     S dev="|TCP|"_port
 ;; // 4 transfer to job open socket        
    s $zt="error" 
    S mode="AS" 
    s end=""
    S jobflag=4
    O dev:(:port:mode::32767:32767) 
    f  d  q:end=1
    .U dev R x:30 ;; // wait connection
    .i $T J srvj(port):(:jobflag:$IO:$IO):0 s end=1
    .q
error 
   c dev  
   j srv^%MLINK(port)
  q
srvj(port) 
   n id,in,d,str,dev
   s $zt="sererror"
   s d=""
   W "glc_READY:"_$c(0),*-3  
4  F  D          
   . s %ZNData=$$GETDATA() q:%ZNData=""
   . i %ZNData="" q
   . q:%ZNData=$c(1)
   . I %ZNData="glc_EXIT:" W "glc_DISCONNECTED:",$c(0) s ^tmplink("close",$j)=$h_"~EXIT" H
   . I $P(%ZNData,":",1)="glc_EXECUTE" D
   .. s value=""
   .. W $c(1,2,3,4,5,6,7,8,9)
   .. I %ZNData["getsessionid=1" k:$d(^%session($JOB)) ^%session($JOB) s ^%session($JOB)=$h
   .. F %ZTemp=0:1:9 s %Var="P"_%ZTemp,@%Var=$p(%ZNData,$c(1),%ZTemp+2)
   .. S %ZNCommand=$P($P(%ZNData,":",2,9999),$c(1),1)
   .. S:%ZNCommand[($c(5)_"xmldata=1") %ZNCommand=$p(%ZNCommand,$c(5)_"xmldata=1",1) 
   .. s P9=""
   .. ;; //s:($tr(%ZNCommand," ")'="")&(%ZNData'["getsessionid=1") %ZNCommand=$$GetFunc(%ZNCommand)
   .. d:%ZNData'["getsessionid=1" Ex(.%ZNCommand)
   .. i %ZNData'["getsessionid=1" s ^Aaa("com")=%ZNCommand x %ZNCommand
   .. s:%ZNData["getsessionid=1" P0=$JOB
   .. F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   .. W "glc_EXRESPONSE:<registry>",value,$C(1),P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$c(1)
   .. W $c(9,8,7,6,5,4,3,2,1),*-3 
   ..q
   .q
   Q       
Ex(Cmd) 
   q:Cmd=""
   f  q:($e(Cmd)'=" ")!(Cmd="")  s Cmd=$e(Cmd,2,32000)
   q:Cmd=""
   i $e(Cmd)="$" s Cmd="s value="_Cmd q
   i $e(Cmd)="=" s Cmd="s value"_Cmd q
   q
   ;  //end//  GT.M Link Server - by paulo.rogerio@zipmail.com.br  ; Compiled April 3, 2007 11:16:22
 ;; {1052}{1086}{1078}{1085}{1086} {1074}{1099}{1082}{1080}{1085}{1091}{1090}{1100}
 ;; s{1072}qqnump=$j
 ;; s{1072}qW=##class(%Library.qWORD).%New()
 ;; s{1072}qARM=##class(%Library.TqARM).%New()
 ;; s{1072}qqlang=19
 ;; {1056}{1072}{1073}{1086}{1090}{1072}{1077}{1090} {1083}{1077}{1090} 15 {1087}{1086} cache {1080} GT.M
 ;; 123456789 - {1087}{1072}{1082}{1077}{1090} {1074}{1085}{1072}{1095}{1072}{1083}{1077} {1087}{1077}{1088}{1077}{1076}{1072}{1095}{1080}
 ;; 987654321 - {1074} {1082}{1086}{1085}{1094}{1077}
 ;; {1064}{1083}{1077}{1090} {1076}{1072}{1085}{1085}{1099}{1077} {1082}{1072}{1082} {1087}{1086}{1090}{1086}{1082}{1086}{1084} , {1090}{1072}{1082} {1080} {1090}{1080}{1087}{1072} {1087}{1086} {1082}{1086}{1084}{1072}{1085}{1076}{1077} {1072}{1085}{1072}{1083}{1086}{1075}{1072} VisM
 ;; {1054}{1090}{1076}{1077}{1083}{1100}{1085}{1086} {1084}{1086}{1078}{1085}{1086} {1087}{1077}{1088}{1077}{1076}{1072}{1074}{1072}{1090}{1100} {1080} {1087}{1086}{1083}{1091}{1095}{1072}{1090}{1100} {1088}{1077}{1075}{1080}{1089}{1090}{1088}{1099} {1086}{1090} P0 {1076}{1086} P9

MXD^INT^1^65495,42075^0
MXD ;  [ 04/26/2006  6:08 PM ]  ;[ 20170821 15:08:20 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx ( multi-user virtual EXCEL incorporated into the database )
 ; vmx Copyright(c) 2005-2016, SIA ENTERS, Latvia, Reg.Nr.42102022219
 ; registered by Agency INTELS, Riga, Latvia, reg.40003134156, on June 28, 2005, Nr.178
 ; 
pD(%H,t) ;CONVERTS %H,$H TO ggggmmdd
 i $e(%H,1,4)="^mM(" s %H=+$e(%H,5,99),%H=$tr($e(%H,1,$l(%H)-1),".",",")
 n time,o s time=""
 i $g(t) s o=$s(%H[".":".",1:","),time=+$e($p(%H,o,2),1,5) s:'time time="" d:time
 .s time=" "_$e(time\3600+100,2,3)_":"_$e(time#3600\60+100,2,3)_":"_$e(time#60+100,2,3)
 n %LY,%R,%Y,%D,%M,%I,%DAT1 s %H=$g(%H,$h)\1,%H=%H>21914+%H
 S %LY=%H\1461,%R=%H#1461,%Y=%LY*4+1841+(%R\365),%D=%R#365,%M=1
 I %R=1460,%LY'=14 S %D=365,%Y=%Y-1
 F %I=31,(%R>1154)&(%LY'=14)+28,31,30,31,30,31,31,30,31,30 Q:%I'<%D  d
 .s %M=%M+1,%D=%D-%I
 I %D=0 S %Y=%Y-1,%M=12,%D=31
 q:$g(t)=-1 time  q %Y_$e(100+%M,2,3)_$e(100+%D,2,3)_time
dmE(%d,%8) 
 i '$d(%d),@%N="-" q "-"
 i +$g(%d)>2000 s %d=$tr(%d,1234567890_%d,1234567890),%d=$$dmg(%d)
 n %2 s:$g(%d) %2=$p(%d," ",2,9),%d=$p(%d," ") s:'$d(%d) %2=$p(@%N," ",2,9)
 n %o,% s:'$g(%8)&'$g(%d) %8="8+" s:+$g(%d)=8 %8=%d s:'$g(%8) %8=8
 i $g(%d) s %d=$tr(%d,"-/{1102}123456780.9"_%d,"...123456780.9"),%o=$$dmg(%d,%8),%=$$d31(%o,%8) s:%'?8n %d=$$dmg(%o) q:'$l(%2) %d q %d_" "_%2
 s @%N=$tr(@%N,"-/{1102}123456780.9"_@%N,"...123456780.9"),%o=$$dmg(@%N,%8),%=$$d31(%o,%8)
 s:%'?8n %E=% s:%E="" (oo,@%N)=$$dmg(%o) s:$l($g(%2)) (oo,@%N)=oo_" "_%2
 q @%N
gmd(d8,p2) 
 i $g(p2)=8,d8>999 q $e($tr(d8,1234567890_d8,1234567890),1,8)
 i +d8?8n q $e(+d8,1,4)_"."_$e(+d8,5,6)_"."_$e(+d8,7,8)
 q:'$d(p2) $$dmg(d8) q $$dmg(d8,p2)
mdg(d8,p2) q:+d8'?8n d8
 q:$g(p2)'["/" $e(+d8,5,6)_"."_$e(+d8,7,8)_"."_$e(+d8,1,4) q $e(+d8,5,6)_"/"_$e(+d8,7,8)_"/"_$e(+d8,1,4)
 q d8
dmg(d8,p2) s:$g(%LANG)="" %LANG="LV"
 n o1,o2,o3,% s p2=$g(p2) s:d8<0 d8=$e(d8,2,99) q:'d8 d8  s:$p(d8,"/",2) d8=$tr(d8,"/",".")
 s o1="janv{257}ris febru{257}ris marts apr{299}lis maijs j{363}nijs j{363}lijs augusts septembris oktobris novembris decembris"
 s:%LANG["RU" o1="{1103}{1085}{1074}{1072}{1088}{1103} {1092}{1077}{1074}{1088}{1072}{1083}{1103} {1084}{1072}{1088}{1090}{1072} {1072}{1087}{1088}{1077}{1083}{1103} {1084}{1072}{1103} {1080}{1102}{1085}{1103} {1080}{1102}{1083}{1103} {1072}{1074}{1075}{1091}{1089}{1090}{1072} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1103} {1086}{1082}{1090}{1103}{1073}{1088}{1103} {1085}{1086}{1103}{1073}{1088}{1103} {1076}{1077}{1082}{1072}{1073}{1088}{1103}"
 s:"DE"[%LANG o1="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 s:"EN GB"[%LANG o1="January February March April May June July August September October November December"
 s:%LANG="UA" o1="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 i '$g(p2) q:+d8?6n $e(d8,1,4)_".gada  "_$p(o1," ",$e(d8,5,6))
 I d8?8n,d8>19000000,d8<21110000 s:p2-8=0 %E=$$d31(d8,p2) q $e(d8,7,8)_"."_$e(d8,5,6)_"."_$e(d8,1,4) 
 i d8'["." q d8
 i '$p(d8,".",3) s $p(d8,".",3)=$e($$d8,1,4)
 s o1=$e(100+$p(d8,"."),2,3),o2=$e(100+$p(d8,".",2),2,3),o3=$p(d8,".",3),o3=$s(o3<100:o3+2000,1:o3)
 i p2=8 s %=$$d31(o3_o2_o1,8) q:'$l(%) o3_o2_o1 q %
 q o3_o2_o1
d8t(d8,mm) 
 n o1,o2 s:$g(%LANG)="" %LANG="LV"
 s o1="janv{257}ris febru{257}ris marts apr{299}lis maijs j{363}nijs j{363}lijs augusts septembris oktobris novembris decembris"
 s:%LANG["RU" o1="{1103}{1085}{1074}{1072}{1088}{1103} {1092}{1077}{1074}{1088}{1072}{1083}{1103} {1084}{1072}{1088}{1090}{1072} {1072}{1087}{1088}{1077}{1083}{1103} {1084}{1072}{1103} {1080}{1102}{1085}{1103} {1080}{1102}{1083}{1103} {1072}{1074}{1075}{1091}{1089}{1090}{1072} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1103} {1086}{1082}{1090}{1103}{1073}{1088}{1103} {1085}{1086}{1103}{1073}{1088}{1103} {1076}{1077}{1082}{1072}{1073}{1088}{1103}"
 s:"DE"[%LANG o1="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 i "EN GB"[%LANG s o1="January February March April May June July August September October November December" i d8?8n,"GB EN"[$g(mm) q $p(o1," ",$e(d8,5,6))_" "_$e(d8,7,8)_", "_$e(d8,1,4)
 s mm=$g(mm,o1)
 s:d8<0 d8=-d8 q:'d8 ""  q:+d8?6n $e(d8,1,4)_".gada  "_$p(mm," ",$e(d8,5,6))
 I '$p(d8,"-",2),d8>0 q $e(d8,1,4)_".gada "_$e(d8,7,8)_"."_$p(mm," ",$e(d8,5,6))
 s o1=$e(+d8,1,4)_".gada "_$e(+d8,7,8)_"."_$p(mm," ",$e(+d8,5,6)),o2=+$p(d8,"-",2)
 q o1_" - "_$e(o2,1,4)_".gada "_$e(o2,7,8)_"."_$p(mm," ",$e(o2,5,6))
d8(d,d31,dBas) 
 s d=$g(d)
 i d="",$g(%YXy),$g(%YXx) q:+$g(oYX(%YXy-1,%YXx-1))?8n +oYX(%YXy-1,%YXx-1)  q:+$g(oYX(%YXy-1,%YXx))?8n +oYX(%YXy-1,%YXx)
 i $l(d)>4!'d,+d'?8n q $$pD($h)
 i +d?8n!'$d(dBas) q:$$d31(+d,$g(d31))'="" $$d31(+d,$g(d31)) q +d
 s:+dBas'?8n dBas=$$pD($h+dBas) s:d<10 d=0_+d s:$l(d)=3&(d=+d) d=0_d s:$l(d)<5 d=$e(+dBas,1,8-$l(d))_d q:$$d31(d,8)'="" $$d31(d,8)
 q d
d31(d,N,dmin) 
 q:'$g(N) 28+$e(3_($e(d,3,4)#4=0)_3232332323,$e(d,5,6)) s dmin=$g(dmin,19000101)
 i N>1111 q:-d'[-N "ERROR: d="_+d_", is off range "_N  s N=$l(+N)
 i N<9,$l(+d)<N q:'d "enter date "_$e("ggggmmdd",1,+N)  q "ERROR: d="_+d_", is too short, length must "_N
 i N'["+",N<9,d>$e($$pD($h),1,$l(+d)),d>($g(%gm(1))_31),$g(%gm(1))?6n q "ERROR: d="_+d_" > {353}odien/today="_$$pD($h)
 i d<dmin q "ERROR: "_+d_" < "_dmin
 i d>20990101 q "ERROR: "_+d_" > 20990101"
 i N>5,$e(d,5,6)<1!($e(d,5,6)>12) q "ERROR: d="_+d_", MONTH="_$e(d,1,6)
 i N>7,$e(d,7,8)=33,mxConfig[":ggggmm33:" q ""
 i N>7,$e(d,5,6)=12,$e(d,7,8)>31,$e(d,7,8)<35 q ""   ;;;;;;;;;;;;; mxConfig[":ggggmm33:"
 i N>7,($e(d,7,8)<1&(mxConfig'[":ggggmm00:"))!($e(d,7,8)>(28+$e(3_($e(d,3,4)#4=0)_3232332323,$e(d,5,6)))) q "ERROR: DAY="_$e(d,1,8)
 q ""
dmgCheck(d,dMin) 
 n %,d0 s d0=d s:$g(dMin)?4n dMin=dMin_"0101"
 g:d?8n dmgChecE s d=$tr(d,"/ \{1102}.1234567890"_d,".....1234567890")
 i d>1900,$p(d,".",2),$p(d,".",3) s d=$tr(d,".")_$e($p(d,".",2)+100,2,3)_$e($p(d,".",3)+100,2,3) g dmgChecE
 i $p(d,".",3)>1900 s d=$p(d,".",3)_$e($p(d,".",2)+100,2,3)_$e($p(d,".")+100,2,3) g dmgChecE
 i $p(d,".",3) s d=$p(d,".",3)+2000_$e($p(d,".",2)+100,2,3)_$e($p(d,".")+100,2,3) g dmgChecE
 n d00 s d00=$$pD($h)
 i $p(d,".",2) s d=$e(d00,1,4)_$e($p(d,".",2)+100,2,3)_$e($p(d,".")+100,2,3) g dmgChecE
 i d>99 s d=$e(d00,1,4)*10000+d g dmgChecE
 i d s d=$e(d00,1,6)*100+d g dmgChecE
dmgChecE i d?8n s %E=$$d31(d,8,$g(dMin)) q:'$l($g(%E)) $$dmg(d) q d0 
 s %E=d0_" : ERROR in DATE" s:'d %E=" date is null "  q d0
d8plus(d8,p) 
 q:'p d8
 n %,%1,%2,%3 s %3=d8#100,%2=$e(d8,5,6),%1=$e(d8,1,4) i p+%3<29,p+%3>0 q d8+p
 i p>0 f %=1:1:p s %3=%3+1 d:%3>27
 .i 28+$e(3_($e(%1,3,4)#4=0)_3232332323,%2)<%3 s %3=1,%2=%2+1
 .i %2>12 s %2=1,%1=%1+1
 i p<0 f %=1:1:-p s %3=%3-1 d:%3<1
 .s %2=%2-1 s:%2<1 %2=12,%1=%1-1 s %3=28+$e(3_($e(%1,3,4)#4=0)_3232332323,%2)
 q %1*100+%2*100+%3
daStatus(%d,%0) 
 s %0=$g(%0,$$d8) s:$p(%d,".",2) %d=$$dmg(%d) q:%d'?8n ""  s:$p(%0,".",2) %0=$$dmg(%0)
 q:%d<%0 "EX<mx ic7"  q:%d<(%0+100) "W<mx ic44"
 q "ok<mx ic2 fc10"
multD(d1,d2,p,K,d00) 
 n %,d s d=d1,d00=$g(d00) f %="d1","d2","d00" s:$p(@%,".",2) @%=$$dmg(@%)
 i p["{1088}{1072}{1079}" q:(d00<d1!(d00>d2))&d00 0  q:d1'>d2 1 q 0
 f %=1:1:999999 s d=$$nextD(d,d2,p) q:d>d2!'d  i $g(K),%>K q
 q %-1
nextD(d8,d8m,p) 
 n d,%,d s d=0 s:d8["." d8=$$dmg(d8) s:d8m["." d8m=$$dmg(d8m) q:d8'?8n 0  q:d8m'?8n 0
 q:d8>d8m 0 q:d8=d8m d8
 i p="{1075}{1086}{1076}" s d=d8+10000 q:d>d8m 0 q d
 i p["{1085}{1077}{1076}{1077}" s d=$$d8plus(d8,7) q d
 i p["{1076}{1077}{1082}{1072}" s d=$$d8plus(d8,10) q d
 i p["{1084}{1077}{1089}{1103}" s d=d8+100,%=$e(d,5,6) s:%>12 d=$e(d,1,4)+1_$e(%-12+100,2,3)_$e(d,7,8)
 i p["{1082}{1074}{1072}{1088}" s d=d8+300,%=$e(d,5,6) s:%>12 d=$e(d,1,4)+1_$e(%-12+100,2,3)_$e(d,7,8)
 i p["{1087}{1086}{1083}{1091}" s d=d8+600,%=$e(d,5,6) s:%>12 d=$e(d,1,4)+1_$e(%-12+100,2,3)_$e(d,7,8)
 i d#100>28 s %=$e(d,1,6)_$$d31(d) q:%<d %
 q d
icDate(p1,p2) 
 n m,%,%1,%2  s:$g(%LANG)="" %LANG="LV"
 s %XD81=p1,%XD82=p2,%gm=p2\100,%gm0=%gm\100*100,%gm1=%gm0+1
 s m=0 f %=%gm:-1:%gm-100 s:%#100=0 %=%-88  s %gm(m)=%,m=m-1
 s m=0 f %=%gm:+1:%gm+100 s:%#100=13 %=%+88 s %gm(m)=%,m=m+1
 s %ggmm=$s(-%gm[-2:%gm,1:%gm#10000)_":"_%USID
 k %Quarter i "01 04 07 10"[$e(%XD81,5,6),$e(%XD81,1,6)+2=%gm,$e(%XD82,7,8)>29 s %Quarter=%gm#100\3_" quarter "_$e(%gm,1,4)
 S %MONTHS="jan feb mar apr mai j{363}n j{363}l aug sep okt nov dec"
 s menesi="janv{257}ris febru{257}ris marts apr{299}lis maijs j{363}nijs j{363}lijs augusts septembris oktobris novembris decembris"
 s menesa="janv{257}r{299} febru{257}r{299} mart{257} apr{299}l{299} maij{257} j{363}nij{257} julij{257} august{257} septembr{299} oktobr{299} novembr{299} decembr{299}"
 s MENESI="JANV{256}RIS FEBRU{256}RIS MARTS APR{298}LIS MAIJS J{362}NIJS J{362}LIJS AUGUSTS SEPTEMBRIS OKTOBRIS NOVEMBRIS DECEMBRIS"
 d:%LANG="RU" 
 .S %MONTHS="{1103}{1085}{1074} {1092}{1077}{1074} {1084}{1072}{1088}{1090} {1072}{1087}{1088} {1084}{1072}{1081} {1080}{1102}{1085}{1100} {1080}{1102}{1083}{1100} {1072}{1074}{1075} {1089}{1077}{1085} {1086}{1082}{1090} {1085}{1086}{1103} {1076}{1077}{1082}"
 .s menesi="{1103}{1085}{1074}{1072}{1088}{1100} {1092}{1077}{1074}{1088}{1072}{1083}{1100} {1084}{1072}{1088}{1090} {1072}{1087}{1088}{1077}{1083}{1100} {1084}{1072}{1081} {1080}{1102}{1085}{1100} {1080}{1102}{1083}{1100} {1072}{1074}{1075}{1091}{1089}{1090} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1100} {1086}{1082}{1090}{1103}{1073}{1088}{1100} {1085}{1086}{1103}{1073}{1088}{1100} {1076}{1077}{1082}{1072}{1073}{1088}{1100}"
 .s menesa="{1103}{1085}{1074}{1072}{1088}{1103} {1092}{1077}{1074}{1088}{1072}{1083}{1103} {1084}{1072}{1088}{1090}{1072} {1072}{1087}{1088}{1077}{1083}{1103} {1084}{1072}{1103} {1080}{1102}{1085}{1103} {1080}{1102}{1083}{1103} {1072}{1074}{1075}{1091}{1089}{1090}{1072} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1103} {1086}{1082}{1090}{1103}{1073}{1088}{1103} {1085}{1086}{1103}{1073}{1088}{1103} {1076}{1077}{1082}{1072}{1073}{1088}{1103}"
 .s MENESI="{1071}{1053}{1042}{1040}{1056}{1068} {1060}{1045}{1042}{1056}{1040}{1051}{1068} {1052}{1040}{1056}{1058} {1040}{1055}{1056}{1045}{1051}{1068} {1052}{1040}{1049} {1048}{1070}{1053}{1068} {1048}{1070}{1051}{1068} {1040}{1042}{1043}{1059}{1057}{1058} {1057}{1045}{1053}{1058}{1071}{1041}{1056}{1068} {1054}{1050}{1058}{1071}{1041}{1056}{1068} {1053}{1054}{1071}{1041}{1056}{1068} {1044}{1045}{1050}{1040}{1041}{1056}{1068}"
 d:"EN GB"[%LANG
 .s menesi="January February March April May June July August September October November December"
 .s menesa="January February March April May June July August September October November December"
 .s MENESI="January February March April May June July August September October November December"
 d:"DE"[%LANG
 .s menesi="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 .s menesa="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 .s MENESI="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 d:%LANG="UA"
 .s menesi="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 .s menesa="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 .s MENESI="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 S %MONTH=$P(MENESI," ",%gm#100)
 s %XD81m=p1\10000_"."_$p(%MONTHS," ",$e(p1,5,6))_"."_$e(p1,7,8)
 s %XD82m=p2\10000_"."_$p(%MONTHS," ",$e(p2,5,6))_"."_$e(p2,7,8)
 s %2=$$d8plus(p2,1)
 s %XD82m1=%2\10000_"."_$p(%MONTHS," ",$e(%2,5,6))_"."_$e(%2,7,8)
 i p1#100=1,p2#100>31 s $p(%XD82m,".",3)="",$p(%XD81m,".",3)=""
 S %1=-3 F %=1910:1:%gm\100 S %1=(%#4=0)+%1+365
 S %MAXDAY=28+$E(3_(%gm\100#4=0)_3232332323,%gm#100)
 F %=1:1:%gm#100-1 S %1=28+$E(3_(%gm\100#4=0)_3232332323,%)+%1
 s %WEEKDAY(1)=%1+1#7
 s %1=%XD82#100+%1,%1=%1#7+1
 s %YEAR=$e(%XD82,1,4)
 s %DATUMS=%gm\100_".gada "_$p(MENESI," ",$e(%gm,5,6))
 i -%XD82'[-%gm!(-%XD81'[-%gm) d
 .s %1=$p(menesa," ",$e(%XD81,5,6)),%2=$p(menesa," ",$e(%XD82,5,6))
 .s %1=$e(%XD81,1,4)_".gada "_$e(%XD81,7,8)_"."_%1
 .s %2=$e(%XD82,1,4)_".gada "_$e(%XD82,7,8)_"."_%2
 .s %DatUMs=%1_"-"_%2 s:$e(%1,1,4)<$e(%2,1,4) %DatUMs=$$trw^UST(%DatUMs,".g.01.{1103}{1085}{1074}{1072}{1088}{1103}")
 .s:+%DatUMs?4n %DatUMs=$$trw^UST(%DatUMs,"-"_+%DatUMs_".gada "," - ")
 . ;; i $g(%LANG)["RU" s %DatUMs=$$trw^UST(%DatUMs,".gada "," {1075}. ")
 e  s %="" d
 .i %XD81#100-1!(%XD82#100-$$d31(%gm)) s %=$e(%XD81#100+100,2,3)_-$e(%XD82#100+100,2,3) s:%XD81=%XD82 %=$e(100+%,2,3)
 .s %DatUMs=$e(%XD82,1,4)_".gada "_$s(%:%_".",1:"")_%MONTH
 i %XD82-%XD81=1130 s %DatUMs=$e(%XD82,1,4)_".gads"
 s:%LANG="RU" %DatUMs=$$trw^UST(%DatUMs,".gada",".{1075}{1086}{1076}"),%DatUMs=$$trw^UST(%DatUMs,".gads",".{1075}{1086}{1076}")
 s:%LANG="UA" %DatUMs=$$trw^UST(%DatUMs,".gada",".{1088}{1086}{1082}{1091}"),%DatUMs=$$trw^UST(%DatUMs,".gads",".{1088}{1086}{1082}{1091}")
 s:"EN GB"[%LANG %DatUMs=$$trw^UST(%DatUMs,".gada",".year"),%DatUMs=$$trw^UST(%DatUMs,".gads",".year")
 s:"DE"[%LANG %DatUMs=$$trw^UST(%DatUMs,".gada",".Jahrs"),%DatUMs=$$trw^UST(%DatUMs,".gads",".Jahrs")
 s GADS=$p(%DATUMS,"  "),%B=$c(254),DATUMS=%DATUMS
 s (d8today,%d8today)=$$pD($h),d8arhiv=$e(%d8today,1,4)-2*10000,%oldDate=%d8today-20000
 s:%XD82<%d8today %oldDate=%XD82-20000
 q ""
NewDate(%1) 
 k oVVVo
 n %2,p1,p2,e
 s (%1,p1)=$g(%1) s:'p1 p1=$g(^ParVM(%USID,"UserDate"))
 s p2=$p(p1,"-",2),p1=$p(p1,"-") i 'p2,%1["-" s p2=$$pD(+$h) i %1'["." s:+p1?4n p2=$e(p2,1,4),p1=+p1_-p2
 i 'p1 s (p1,p2)=$$pD($h)
 s %1=+p1,%2=+p2 s:'%2 (p2,%2)=$p(p1,"-",2)
 s:%2=0 %2=$$pD($h) s:'%2 %2=+%1
 i %1?4n,%1>1990,%1<2099 s %1=%1_"0101"
 i %2?4n,%2>1990,%2<2099 s %2=%2_1231
 f %="%1","%2" d
 .s:@%<99 @%=$s(%[1:$$pD($h),1:%1)\100*100+@%
 .q:@%>20991231  q:13579[$l(@%)
 .i $e(@%,1,4)>1990,$e(@%,1,4)<2099 s @%=$e(@%_$s(%[1:"01",1:33),1,8)
 s %=%2#10000 i %#100=33,p2#100-33 d
 . s %=$e(3_($e(%2,3,4)#4=0)_3232332323,%\100)+28
 . s %2=%2\100*100+%
 s p1=+%1,p2=+%2 s:p1>p2 p1=p2,p2=+%1
 s e=""  f %="p1","p2" d
 .i $e(@%,1,4)>2099!($e(@%,1,4)<1990) s e=" ?Gads="_$e(@%,1,4)_"?"
 .i $e(@%,5,6)>12!($e(@%,5,6)<1) s e=" ?M{275}n.="_$e(@%,5,6)_"?"     
 .i $e(@%,7,8)>33!($e(@%,7,8)<1) s e=" ?Diena="_$e(@%,7,8)_"?"    
 .i @%>20990101!(@%<19900000) s e=" ? "_@%_" ?"
 .s:@%'?8n e=" ? "_@%_" ? ggggmmdd "
 i e="",$$icDate(p1,p2)
 q e
Week(d8,%2) 
 i +d8'?8n!(d8>20990000)!(d8<18400000) q "-- error --   d8="_d8
 n %,w f %=$e(+d8,1,4)_"0101":-1 q:'$$WeekDay(%) 
 f w=1:1 s %=$$d8plus(%,7) q:%>d8
 q w
 n %0x,% s %2=$g(%2),%0=0 f %=$e(d8,1,4)_"0101":1 s %0=%0+1 q:'$$WeekDay(%)  
 i %'<d8 q $$Week($e(d8,1,4)-1_1231)+(d8<20100199)  ;; is error in 2009 calendar of weeks LATVIA !!
 q:+$e(d8,5,6)=1 (d8#100)-%0-1\7+1
 s %0=31-%0+(d8#100)-1 F %=2:1:$e(d8,5,6)-1 S %0=28+$e(3_($e(d8,3,4)#4=0)_3232332323,%)+%0
 q %0\7+1
WeekDay(d8,%2) 
 i d8<($h+999),d8>($h-999) s d8=$$pD(+d8)
 i d8<999,d8=+d8 s d8=$$pD($h+d8)
 n %1,%,gggg,o s gggg=$e(d8,1,4),%LANG=$g(%LANG,"LV")
 S %1=-2 F %=1910:1:gggg-1 S %1=%#4=0+%1+365
 F %=1:1:$e(d8,5,6)-1 S %1=28+$e(3_(gggg#4=0)_3232332323,%)+%1
 s o=%1+$e(d8,7,8)#7,%="Sv{275}tdiena pirmdiena otrdiena tre{353}diena ceturtdiena piektdiena Sestdiena "
 s:$g(%LANG)["RU" %="{1042}{1086}{1089}{1082}{1088}{1077}{1089}{1077}{1085}{1100}{1077} {1087}{1086}{1085}{1077}{1076}{1077}{1083}{1100}{1085}{1080}{1082} {1074}{1090}{1086}{1088}{1085}{1080}{1082} {1089}{1088}{1077}{1076}{1072} {1095}{1077}{1090}{1074}{1077}{1088}{1075} {1087}{1103}{1090}{1085}{1080}{1094}{1072} {1057}{1091}{1073}{1073}{1086}{1090}{1072} "
 s:"EN GB"[%LANG %="Sunday Monday Tuesday Wednesday Thursday Friday Saturday "
 s:"DE"[%LANG %="Sonntag Montag Dienstag Mittwoch Donnerstag Freitag Samstag "
 s:"UA BY"[%LANG %="{1053}{1077}{1076}i{1083}{1103} {1087}{1086}{1085}{1077}{1076}i{1083}{1086}{1082} {1074}i{1074}{1090}{1086}{1088}{1086}{1082} {1089}{1077}{1088}{1077}{1076}{1072} {1095}{1077}{1090}{1074}{1077}{1088} {1087}'{1103}{1090}{1085}{1080}{1094}{1103} {1057}{1091}{1073}{1086}{1090}{1072} "
 s:$g(%2)[" " %=%2
 q o_$p(%_%," ",o+1)
tsts(%1,%2) 
 n m,%,h s h=":"
 s:$p(%1,h)["." $p(%1,h)=$$dmg($p(%1,h)) s:$p(%2,h)["." $p(%2,h)=$$dmg($p(%2,h)) 
 s:'%1 %1=$e(%2,1,6)_"01" s:'%2 %2=$e(%1,1,6)_$$d31($e(%1,1,6))
 s m=$p(%2,h,2)*60+$p(%2,h,3)-($p(%1,h,2)*60)-$p(%1,h,3)
 s %=+%1 f  q:%'<%2  s m=m+1440,%=$$d8plus(%,1)
 q m
t1t2(t1,t2) 
 n %1,%2,%3 s:$l(t1,":")=2 t1=":"_t1,t2=":"_t2,%3=2 s %1=+t1,%2=+t2 s:%2<%1 %2=%2+24
 s %1=%1*3600+($p(t1,":",2)*60)+$p(t1,":",3),%2=%2*3600+($p(t2,":",2)*60)+$p(t2,":",3)
 s %1=%2-%1,%1=$e(%1\3600+100,2,3)_":"_$e(%1-(%1\3600*3600)\60+100,2,3)_":"_$e(%1#60+100,2,3)
 q:$d(%3) $p(%1,":",2,3)  q %1

MXF^INT^1^65495,42075^0
MXF ;  [ 04/26/2006  6:08 PM ]  ;[ 20090514 13:53:39 ]
 ; MSM, CACHE, IRIS, GT.M,  MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2020
 ; 
m(%) ; $$RunLine  $$omQuery
 n %n i $d(%),% s %n=om n om s om=%n,$p(om,"/",2)=$e("         ",1,%-1)_$p($p(om,"/",2)," ",%) 
 s ossso3ss=$p(om,"/",3),occco4cc=$p(om,"/",4),%5sv=$p(om,"/",5),%oiiio2i=$p(om,"/",2)
 i $e(%5sv,1,2)="n " s o=$e(%5sv,3,999),%5sv="" f %=1:1:$l(o,",") s %n=$p(o,",",%),%3=@%n n @%n s @%n=%3
 x $p(om,"/",7,99) s %n=$p(om,"/",6) s:$e(%n)=";" %n="" i %n="xmsm",$l(xmsm) s %n="i "_xmsm
 i $l(%n)>2,"IF-if-i -If"[$e(%n,1,2),%n[" " x %n_" s %n="""" " q:$l(%n) -.1
 i $l(%n),$d(@%n)>9 d  q:'$d(%n) -.2
 . s %omUSIDn="" f  s %omUSIDn=$o(@%n@(%omUSIDn)) q:'$l(%omUSIDn)  x "s %="_@%n@(%omUSIDn)  i '% k %n q   
 s:'$l(occco4cc) occco4cc="occco4cc" s %ztTQMm=$zt,$zt="ERRm^MXF" 
 ;; i $d(%maxLoom) s %maxLoom=%maxLoom-1 i %maxLoom<0 s %mxWarng("$$m^MXF:%maxLoom:limitOff")=om q
 f %oiiio2x=1:1:$l(%oiiio2i," ") s %i0=$p(%oiiio2i," ",%oiiio2x),(%ii,%iiB)=$tr(%i0,":-+",",") d:$l(%ii)
 . s %omUSIDn=$s($e(om,1,20)["^||om(":"^||om(""",1:"^om(""")_%USID_""","_%oiiio2x_","_%iiB_",""%ii"")"
 . s %omNewii=$o(@(%omUSIDn)) i '$l(%omNewii) s ^("%ii")=%ii d  q
 .. f %=1:1:$l(ossso3ss," ") s ^($p(ossso3ss," ",%))=@($p(ossso3ss," ",%))
 .. f %=1:1:$l(occco4cc," ") s ^($p(occco4cc," ",%))=@($p(occco4cc," ",%))
 .. i $l(%5sv) f %=1:1:$l(%5sv," ") s ^($p(%5sv," ",%))=@($p(%5sv," ",%))
 .. f %2=$l(%ii,","):-1:1 s $p(%omUSIDn,",",%2+2)=""""_%B_"""" d:$p(%i0,":",%2)'["-"
 ...  s @(%omUSIDn)=%ii
 ...  f %=1:1:$l(ossso3ss," ") s %n=$p(ossso3ss," ",%) s:@%n ^(%n)=$g(^(%n))+@%n
 ...  i $l(%5sv) f %=1:1:$l(%5sv," ") s %n=$p(%5sv," ",%) s:$l(@%n) %o5=$g(^(%n)),^(%n)=$$sv^fin("%o5++"_%n)
 . i '%zvMSM f %=1:1:$l(occco4cc," ") s %n=$p(occco4cc," ",%),%8o=@%n i "  - .%"'[%8o s %8=^(%n) i %8'=%8o,%B_%8_%B'[(%B_%8o_%B),$l(%8)<20000 s ^(%n)=$s('$l(%8):%8o,1:%8_%B_%8o)
 . i %zvMSM s o=$zr f %=1:1:$l(occco4cc," ") s %n=$p(occco4cc," ",%),%8o=@%n i "  - .%"'[%8o s %8=^(%n) i %8'=%8o,%B_%8_%B'[(%B_%8o_%B) d
 .. i $l(%8)+$l(%8o)<510 s ^(%n)=$s('$l(%8):%8o,1:%8_%B_%8o) q
 .. i %8=".!." s %zvMSMo1=$g(%zvMSMo1,1000111)+1,^(%n,%zvMSMo1)=$e(%8o,1,510+%zvMSM) q:1_$d(@o)
 .. s ^(%n,1000000)=%8,^(1000001)=%8o s:1_$d(@o) ^(%n)=".!."
 . f %=1:1:$l(ossso3ss," ") s %n=$p(ossso3ss," ",%) s:@%n ^(%n)=$g(^(%n))+@%n
 . ;;   20191120    i $l(%5sv) f %=1:1:$l(%5sv," ") s %n=$p(%5sv," ",%) s:$l(@%n) %o5=$g(^(%n)),^(%n)=$$sv^fin("%o5++"_%n)
 . f %2=$l(%ii,","):-1:1 s $p(%omUSIDn,",",%2+2)=""""_%B_"""" d:$p(%i0,":",%2)'["-"
 .. s @(%omUSIDn)=%ii
 .. f %=1:1:$l(ossso3ss," ") s %n=$p(ossso3ss," ",%) s:@%n ^(%n)=$g(^(%n))+@%n
 .. ;;  20191120  i $l(%5sv) f %=1:1:$l(%5sv," ") s %n=$p(%5sv," ",%) s:$l(@%n) %o5=$g(^(%n)),^(%n)=$$sv^fin("%o5++"_%n)
 s $zt=%ztTQMm q 1
ERRm n %n,% s $zt=%ztTQMm,%mxWarng("$$m^MXF:"_$ze_" row="_%YXy_" col="_%YXx)=$g(zi)_":::"_$g(%ii)_" :::"_$g(%oiiio2i)_":::"_$g(%oiiio2x)
 i $l($g(%ii)) f %=1:1:$l(%ii,",") s %n=$p(%ii,",",%) i '$l($g(@%n)) s %mxWarng("$$m^MXF:"_$s('$d(@%n):"<undef>index",1:"empty_index:")_" y="_%YXy_" x="_%YXx)=%n_" ::: "_$g(zi)_" ::: "_%ii
 q -1
B(z,x) n %zrXXoo,%x2,%,%YXyy s %YXyy=%YXy  ; onSelect - izlecosas pogas
 s %zrXXoo=$zr,%x2=$g(x),x=$g(x,%YXx),%=+$p(x,"-",2) s:%x2["c" x=%YXx s:% %YXyy=+x,%YXxx=%
 i x s:x<2!(x["+")&(%x2'["c") x=x+%YXx s:x>1255 x=2
 i $e(z,1,3)="$$B" s ^omxMacro(%USID,%mxForma,%YXyy,x)=z q:1_$d(@%zrXXoo) 1 
 i " "[$e(z),z'["xForma=" s ^omxMacro(%USID,%mxForma,%YXyy,x)="$$B 9] 9 o[__ . 10/3:6 "_$e(z,2,480) q:1_$d(@%zrXXoo) 1
 i "1 * "[$e(z,1,2) s ^omxMacro(%USID,%mxForma,%YXyy,x)="?$$B    xForma=1  "_$e(z,3,480) q:1_$d(@%zrXXoo) 1
 ; xForma=a 5 s ... 
 i $e(z)="^" s %=$p($e(z,2,99),"("),z="xForma="_$s($d(^AL(%)):"     s @(""x""_""Forma"")="""_$$kav2(z)_""" ",1:"xZRobj     s xZR="""_$$kav2(z)_"""")
 i $e($tr(z," "),1,7)="xForma=" s ^omxMacro(%USID,%mxForma,%YXyy,x)="$$B 9-6"_$s(%x2["c":%x2,1:"")_" 9-2 o[__ xForma="_$p($p(z,"xForma=",2)," ")_" 10/3:6 "_$p($p(z,"xForma=",2,9)," ",3,999)  q:1_$d(@%zrXXoo) 1
 q:1_$d(@%zrXXoo) 0
R(z,x) n %zrXXoo s %zrXXoo=$zr,x=$g(x,%YXx)  ; on-Right-Click
 i x s:x<2!(x["+") x=x+%YXx s:x>1255 x=2
 i $e(z)="^",$d(@z),'$d(^AL($e($p(z,"("),2,99))) q:1_$d(@%zrXXoo) z
 i $e(z)="^",'$d(@z) q:1_$d(@%zrXXoo) z
 i $e(z)="^" s ^omxGlobR(%USID,%mxForma,%YXy,x)=z q:1_$d(@%zrXXoo) 1
 k ^omxGlobR(%USID,%mxForma,%YXy,x)
 i "1 * "[$e(z,1,2) s ^omxRight(%USID,%mxForma,%YXy,x)="?$$B    xForma=*  n %N s %N="""_$g(%N,"o")_""" "_$e(z,3,480) q:1_$d(@%zrXXoo) 1
 ; xForma=a 5 s ... 
 i $e(z,1,7)="xForma=" d  s ^omxRight(%USID,%mxForma,%YXy,x)="?$$B       n %N s %N="""_%N_""" "_z q:1_$d(@%zrXXoo) 1
 . n % s %=$p(z," ",2,999) s:% %=$e(%,2,999) s:% %=$e(%,2,999) s z=$p(z," ")_"  "_%
 q:1_$d(@%zrXXoo) 0
T(oXecute,%YXxx,gotoYX)   ; on-Timer
 n %zrXXoo,%1,%2 s %zrXXoo=$zr,%YXxx=$g(%YXxx,%YXx)
 k ^onEvents("Timer",%USID,%mxForma,%YXy,%YXxx)
 s ^onEvents("Timer",%mxForma,%YXy,%YXxx)="n %N,%K,%y,%x s %y="_+%YXy_",%x="_%YXxx_",%K=$g(^oYX(%USID,%mxSheet,%YXy,%YXxx)),%N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo,%YXo "_oXecute_"  s:$d(oo) %YX(%y,%x)=oo"
 q:1_$d(@%zrXXoo) 1
S(oXecute,%YXxx,gotoYX)   ; on-Select
 n %zrXXoo,%1,%2,%,%YXyy s %zrXXoo=$zr,%YXxx=$g(%YXxx,%YXx),%YXyy=%YXy,%=+$p(%YXxx,"-",2) s:% %YXyy=+%YXxx,%YXxx=%    
 k ^onSelect(%USID,%mxForma,%YXyy,%YXxx)
 s (%,^onSelect(%USID,%mxForma,%YXyy,%YXxx))="n %N,%K s %K=$g(^oYX(%USID,%mxSheet,%ySelect,%xSelect)),%N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo,%YXo "_oXecute_"  s:$d(oo) %YX(%ySelect,%xSelect)=oo s %ySelect(0)=%ySelect,%xSelect(0)=%xSelect"
 k ^onEvents("cellSelect",%USID,%mxForma,%YXyy,%YXxx) s @$zr=%
 ;;;s ^(%YXxx)="k gotoYXxx,gotoYXyy,oo i $$noTrack^MXF() k %YXo "_oXecute_"  s:$d(oo) %YX(%YXy,"_%YXxx_")=oo "  ;; ?????????? loop !!!
 q:1_$d(@%zrXXoo) 1
noTrack() n % q 1  q:'$d(%YXo) 1
C(oXecute,%YXxx) 
   ; on-Change   ;; %qChange = last_changed_cell_new_value
 n %zr,%1,%2,%,%YXyy s %zr=$zr,%YXyy=%YXy,%YXxx=$g(%YXxx,%YXx),%=+$p(%YXxx,"-",2) s:% %YXyy=+%YXxx,%YXxx=%    
 i %YXxx s:%YXxx<2!(%YXxx["+") %YXxx=%YXxx+%YXx s:%YXxx>1255 %YXxx=2
 s (%,^onChange(%USID,%mxForma,%YXyy,%YXxx))="n %N s %N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo "_oXecute_"  s:$d(oo) %YX(%yChange,%xChange)=oo k oo "
 k ^onEvents("cellChange",%USID,%mxForma,%YXyy,%YXxx) s @$zr=%
 q:1_$d(@%zr) 1
D(%,x) ; on-DD-click
 n %zr s:$e(%,1,2)="^ " $e(%)="" s x=$g(x,%YXx) i x s:x<2!(x["+") x=x+%YXx
 s %zr=$zr,%=$$trw^UST($$trw^UST(%,";;; ",";||2 "),";|| ",";||2 ")
 s ^onSeleDD(%USID,%mxForma,%YXy,x)="n %N s %N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo "_%
 q:1_$d(@%zr) 1
L(%indeSEL,%textSEL,%mxForma) 
 ; on-left-click:  set dropDown and form-Call from list (with param.)
 n %,o,%n,%i s %i="" f %=1:1:$l(%indeSEL,",") s %n=$p(%indeSEL,",",%) i $g(@%n)="" k %textSEL q
 q:'$d(%textSEL) -1 s o="" f %=1:1:$l(%textSEL,",") s %n=$p(%indeSEL,",",%),o=o_%B_$g(@%n)
 x "s ^oYXiSeLi(%USID,%mxForma,%YXy,%YXx,"_%indeSEL_")=%mxForma_o"
 q %indeSEL_%B_%textSEL_%B_%mxForma
IR(%i,%di) 
 n %,%I,%R,%IR,%n,%1,o
 i '%i,$zv'["MiniM" s $zt="Ervb^USX"
 s %1=$e($p(%i,"("),2,99)
 i $g(%LII(%1))=""!($g(%LI(%1))="") d
 .  n %i,%di,%MV d ^USX s %LI(%1)=$g(^AL(%1,"%LI"))
 i '%di s %I=$NAME(@%i),%R=$g(@%I) d:$l(%R)=500  i 1
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 e  s %I=$$zo500^UST(%i,%di) s:%I="" %I=%i s %R=$g(@%I) d:$l(%R)=500
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 q:'$l(%R) -1  x %XG(%1),%XI(%1) s %IR=%I
 f %=1:1 s %n=$p(%LI(%1),",",%) q:'$l(%n)  d:%n["~"    s %IR=%IR_$c(9)_$s($l(@%n)<1023:@%n,1:$l(@%n)_">1023")
 . i %n'["~~" s %n=$tr(%n,"~") q
 . s %n=$tr(%n,"~") s:'$d(%XG0(%1,%)) %XG0(%1,%)=$p($g(^AL(%1,"%W",%n,0)),";",2,99)
 . s o=%XG0(%1,%) n %K,%1,% x o s:$d(%K) @%n=%K
 q %IR
sel(mode,from,t) 
 ; select 1 items from nodes or list
 q:t="" t
 n i,oo,o,omax,y,ymax,o1,o2,x,zr,q
 s omax=0,ymax="$$sel^USF(...) - not selected item "_t_" from "_from
 d:'$d(%LAT) %lat^fin s o1=%LAT,o2=%lat,t=$tr(t,o1,o2)
 i mode="maxtrue",$e(from)="^",from[",y," d  q:ymax>1 $p(ymax," ",2,99)
 .s x=+$p(from,",y,",2),zr=$p(from,",y,")_")",zr=$NAME(@zr)
 .s y="" f  s y=$o(@zr@(y)) q:y=""  s q=$g(^(y,x)) i q'="" d  q:o=2
 .. s oo=$e($tr(q,o1,o2),1,$l(t)+2),o=$l(t)-$l($tr(t,oo))
 .. f i=1:1:$l(t)+1 q:oo'[$e(t,1,i)
 .. s o=o+i-1/$l(t) i o>omax s omax=o,ymax=o_" "_y_" "_o_" "_q
 q -1
XQ(%oXecute) s $zt="Xerror^MXF" n Q x %oXecute q $g(Q)
X1(%oXecute) s $zt="Xerror^MXF" x %oXecute q 1
X(%oXecute) s $zt="Xerror^MXF" x %oXecute q 1
mks(%reportN,%kursSta) s:'$d(%kursSta) %kursSta=kursStar
 i $g(%reportN) s o=$$m(+%reportN) x %kursSta_" i 11_$$m(+%reportN) q" q .2
 s o=$$m x %kursSta_" i 11_$$m q" q .2
 q 0
Xerror s mxERROR=$g(%mxForma)_" ERROR ::: "_$tr(%oXecute,$c(0))_" ::: $ZTRAP="_$ZTRAP_" $$X^MXF: $ZERROR="_$ZERROR
 q mxERROR
pD(%H,t) ;CONVERTS %H,$H to ggggmmdd
 q:'$d(%H) $$pD^MXD q:'$d(t) $$pD^MXD(%H) q $$pD^MXD(%H,t)
dmE(%d,%8) 
 q:'$d(%d) $$dmE^MXD q:'$d(%8) $$dmE^MXD(%d) q $$dmE^MXD(%d,%8)
dmg(d8,p2) 
 q:'$d(p2) $$dmg^MXD(d8)  q $$dmg^MXD(d8,p2) 
d8t(d8,mm) 
 q:'$d(mm) $$d8t^MXD(d8)  q $$d8t^MXD(d8,mm)
d8(d,d31,dBas) 
 s d=$g(d)
 i d="",$g(%YXy),$g(%YXx) q:+$g(oYX(%YXy-1,%YXx-1))?8n +oYX(%YXy-1,%YXx-1)  q:+$g(oYX(%YXy-1,%YXx))?8n +oYX(%YXy-1,%YXx)
 i $l(d)>4!'d,+d'?8n q $$pD($h)
 i +d?8n!'$d(dBas) q:$$d31(+d,$g(d31))'="" $$d31(+d,$g(d31)) q +d
 s:+dBas'?8n dBas=$$pD($h+dBas) s:d<10 d=0_+d s:$l(d)=3&(d=+d) d=0_d s:$l(d)<5 d=$e(+dBas,1,8-$l(d))_d q:$$d31(d,8)'="" $$d31(d,8)
 q d
d31(d,N) 
 q:'$g(N) 28+$e(3_($e(d,1,4)#4=0)_3232332323,$e(d,5,6))  q $$d31^MXD(d,N)
d8plus(d8,p) 
 q:'p d8  q $$d8plus^MXD(d8,p)
daStatus(%d,%0) 
 s %0=$g(%0,$$d8) s:$p(%d,".",2) %d=$$dmg(%d) q:%d'?8n ""  s:$p(%0,".",2) %0=$$dmg(%0)
 q:%d<%0 "EX<mx ic7"  q:%d<(%0+100) "W<mx ic44"
 q "ok<mx ic2 fc10"
Week(d8,%2) 
 q 0
p(oo,o,o2) 
 s o2=$g(o2," ") q $p($p(oo,o_"=",2),o2)
m2u(oo) ; msm8code  --> &#unicode;
 n o,uu,o1,x s uu="" d:'$d(%msm8uni) %msm8uni
 f o=1:1:$l(oo) s o1=$e(oo,o),x=$f(%msm8uni,o1) s:x o1="&#"_$e(%msm8uni,x,x+3)_";" s:o1=" " o1="&nbsp;" s uu=uu_o1
 q uu
u2m(oo) ; &#unicode; --> msm8code
 n o,uu,o1,x,% s uu="" d:'$d(%msm8uni) %msm8uni  s:oo["&nbsp;" oo=$$trw^UST(oo,"&nbsp;"," ")
 f %=2:1:$l(oo,"&#") s %=$p(oo,"&#",%) s:%'[";" uu=uu_"&#"_% i %[";" s x=$f(%msm8uni,$e(10000+$p(%,";"),2,9)) s:'x uu=uu_"&#"_x s:x uu=uu_$e(%msm8uni,x-5)_$p(%,";",2,999)
 q uu
quot(o) 
 i o["&" s o=$$trw^UST(o,"&","&amp;")  ; &#38;
 i o[">" s o=$$trw^UST(o,">","&gt;")   ; &#62;
 i o["'" s o=$$trw^UST(o,"'","&apos;") ; 
 i o["""" s o=$$trw^UST(o,"""","&quot;")  ; &#34;
 ;; i o[$c(8364) s o=$$trw^UST(o,$c(8364),"&euro;")    ; &euro; = &#8364;   {1040}
 q o
%msm8uni n %,%1,o k %msm8uni  s %msm8uni="",%msm8uni(1)="",%msm8uni(2)=""
 s %=".2548226.1810256.1980257.2110268.2100269.2400274.2410275.2420290.2140291.2150298.2160299.2440310.2430311.2460315.2450316.2520325.1830326.2080352.2530353.2220362.2210363.2480381.2470382.1281040."
 s %=%_"1291041.1301042.1311043.1321044.1331045.1341046.1351047.1361048.1371049.1381050.1391051.1401052.1411053.1421054.1431055.1441056.1451057.1461058.1471059.1481060.1491061.1501062.1511063.1521064.1531065.1541066.1551067.1561068."
 s %=%_"1571069.1581070.1591071.1601072.1611073.1621074.1631075.1641076.1651077.1661078.1671079.1681080.1691081.1701082.1711083.1721084.1731085.1741086.1751087.2241088.2251089.2261090.2271091.2281092.2291093.2301094.2311095.2321096."
 s %=%_"2331097.2341098.2351099.2361100.2371101.2381102.2391103.1841105.1898470.1888721."
 i $zv'["U) " f %1=2:1 s o=$p(%,".",%1) q:'$l(o)  s ^unicode(+$e(o,4,7))=$c(+$e(o,1,3)),%msm8uni=%msm8uni_$c(+$e(o,1,3))_$e(o,4,7)
 i $zv["U) " f %1=2:1 s o=$p(%,".",%1) q:'$l(o)  s ^unicode(+$e(o,4,7))=$c(+$e(o,4,7)),%msm8uni=%msm8uni_$c(+$e(o,4,7))_$e(o,4,7)
 f %1=2:1 s o=$p(%,".",%1) q:'$l(o)  s:$e(o,1,3)<254 %msm8uni(1)=%msm8uni(1)_$c(+$e(o,1,3)),%msm8uni(2)=%msm8uni(2)_$c(+$e(o,4,7))
 s %unicode=%
 q
kav2(t) i $zv["Ca"!($zv["IRIS") q $replace(t,"""","""""")
 q $$trw^UST(t,"""","""""")
U(t) ; to UNICODE { >253 }
 q:$d(%dba8bit) t  i $d(%mxWeb),$zv'["U) " q $$U8(t)
 n U,%,fu i $zv'["U) ",'$d(%mxWeb) s %dba8bit=8 q $$U8(t)
 f %=1:1:$l(t) i $a($e(t,%))>254 s fu=% q  
 q:'$d(fu) t  s U=$e(t,1,fu-1)
 f %=fu:1:$l(t) s U=U_$s($a($e(t,%))<254:$e(t,%),$a($e(t,%))>255:"{"_$a($e(t,%))_"}",$a($e(t,%))=254:"{"_8226_"}",1:$e(t,%))  
 q U
Uu(t) q:t'["{" t  q:$zv'["U) " $$u8(t) n %,s,s8,%1 ; from { unicode } to unicode  $c(U) 16-bit
 f %=1:1:$l(t) i $e(t,%)="{" f %1=4,5,6 s s=$e(t,%+%1) i s="}" s s=$e(t,%+1,%+%1-1) s:s=8226 s=254 i s\1=s,s<66200,s>253 s $e(t,%,%+%1)=$c(s) q
 q t
U8(t) ; msm 8 bit to {UNICODE>253}
 i $zv["U) " q:'$d(%mxWeb) t  k %dba8bit q $$U(t)  
 q:$tr(t," 0123456789.-+:~=[]{}()qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM")="" t
 n U,%,fu,%1  d:'$d(%msm8uni) %msm8uni
 f %=1:1:$l(t) i " 0123456789.-+:~=[]{}()qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"'[$e(t,%),%msm8uni[$e(t,%) s fu=% q
 q:'$d(fu) t  s U=$e(t,1,fu-1),%1=0
 f %=fu:1:$l(t) s %1=1 s:" 0123456789.-+:~=[]{}()qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"[$e(t,%) U=U_$e(t,%),%1=0 s:%1 %1=$f(%msm8uni,$e(t,%)),U=U_$s(%1:"{"_+$e(%msm8uni,%1,%1+3)_"}",1:$e(t,%))
 q U
u8(t) q:t'["{" t  q:$zv["U) " $$Uu(t)  n %,s,s8,%1 d:'$d(%msm8uni) %msm8uni ; {unicode} --> msm8code
 f %=1:1:$l(t) i $e(t,%)="{" f %1=4,5 s s=$e(t,%+%1) i s="}" s s=$e(t,%+1,%+%1-1) i s\1=s,s<66200,s>255 s s8=$f(%msm8uni,$e(10000+s,2,9)) i s8 s $e(t,%,%+%1)=$e(%msm8uni,s8-5) q
 q t
SaveXML(%j,%USID,file,b,codePage) 
 ; Save ^oXMLf(y,x) to file
 s %code3=$c(231)_$c(199)_$c(251)_$c(219)_$c(238)_$c(206)_$c(226)_$c(194)_$c(240)_$c(208)_$c(236)_$c(204)_$c(237)_$c(205)_$c(239)_$c(207)_$c(254)_$c(222)_$c(232)_$c(200)_$c(242)_$c(210)
 n q,qq,y,x,%10 s %10=$c(10),%code3="eEuUiIaAsSgGkKlLzZcCnN"
 s (qq,y,x)="",codePage=$g(codePage)
 i $zv["MS" o 51:(file:"W"):0 u 51
 i $zv'["MS" OPEN file:"NWS":1 u file
 f  s y=$o(^oXMLf(y)) q:'y  s x=1 f  s x=$o(^oXMLf(y,x)) q:'x  s q=^(x) i "?="'[$e(q),"   -       . "'[q d
 .  i codePage=1257 s q=$tr(q,$$Uu("{275}{274}{363}{362}{299}{298}{257}{256}{353}{352}{291}{290}{311}{310}{316}{315}{382}{381}{269}{268}{326}{325}"),%code3)
 .  i $g(b)'="" s:$e(q,$l(q))'="=" q=q_b
 .  s qq=qq_q i '$o(^(x)) d:qq[%10  w qq,%10 s qq=""
 ..  s o=qq_%10_"!! {1074} {1090}{1077}{1082}{1089} {1077}{1089}{1090}{1100} {1085}{1077}{1085}{1091} : "_%10_$p(qq,%10)_"*"_%10_" - {1101}{1090}{1086}{1090} {1083}{1080}{1096} <Alt/Enter> {1091}{1076}{1072}{1083}{1077} SaveXML^MXF !!"
 ..  s ^omxWarng(%USID,file_" row="_$e(y+100000,2,9)_",column="_x)=o_%10_%10,qq=$tr(qq,%10)
 i $zv["MS" x "close 51 h 1" q:%j
 i $zv'["MS" x "close file h 1" q:%j
 q file
%latRU n %1,%2
 s %2="{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}"
 s %1="{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}"
 S %LAT=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}{1105} ""/-.'`&")
 s %lat=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn{1077} ")
 s oLat1=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}{1105}")
 s oLat2=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn{1077}")
 q 
%lat n %1,%2 s (%1,%2)=""
 s %rus=$$Uu("{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}")
 s %RUS=$$Uu("{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}")
 i $g(%LANG)["RU" d %latRU q
 S %LAT=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257} ""/-.'`&")
 s %lat=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuia{353}{291}{311}{316}{382}{269}{326}euia ")
 s oLat1=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}")
 s oLat2=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn")
 q 
AddrR1C1(a) 
 n R,C s oCellAdr=a,a=$tr(a,"$")
 s a=$tr(a,"qwertyuiopasdfghjklzxcvbnm","QWERTYUIOPASDFGHJKLZXCVBNM")
 s R=+$tr(a,"1234567890"_a,"1234567890")
 s:$l(a,2) C=$a(a)-64 s:'$l(a,2) C=$a(a)-64*26+$a($e(a,2))-64
 s oCellRow=+R,oCellCol=+C
 q "R"_+R_"C"_+C
AB(x) 
 s x=x\1 q:x>255!'x "oo"_x  q:x<27 $e("ABCDEFGHIJKLMNOPQRSTUVWXYZ",x)
 q $e("ABCDEFGHIJKLMNOPQRSTUVWXYZ",x-1\26)_$e("ABCDEFGHIJKLMNOPQRSTUVWXYZ",x-1#26+1)
EAN13(o) 
 ; MX : printing barcode with font EAN-13
 n S,oAB,x,b1,EAN13,o7
 s o=$tr(o,1234567890_o,1234567890),b1=$e(o),o=$e(o_"0000000000",1,12)
 s S=$e(o,12)+$e(o,10)+$e(o,8)+$e(o,6)+$e(o,4)+$e(o,2)*3
 s S=S+$e(o,11)+$e(o,9)+$e(o,7)+$e(o,5)+$e(o,3)+$e(o,1)#10*-1+10#10
 s oAB=$p("oooooo.oo1o11.oo11o1.oo111o.o1oo11.o11oo1.o111oo.o1o1o1.o1o11o.o11o1o.",".",$e(o)+1)
 s o=$e(o,2,12)_S
 s o7=$tr($e(o,7,12),"0123456789","PQRSTUVWXY")
 f x=1:1:6 s:$e(oAB,x) $e(o,x)=$tr($e(o,x),"0123456789","@ABCDEFGHI")
 s EAN13=$e("!""#$%&'()*",b1+1)_"|"_$e(o,1,6)_"|"_o7_"|"
 q:$e(EAN13)="'" "'"_EAN13 q EAN13
code35(t) 
 s:'$d(%code35) %code35=$c(231)_$c(199)_$c(251)_$c(219)_$c(238)_$c(206)_$c(226)_$c(194)_$c(240)_$c(208)_$c(236)_$c(204)_$c(237)_$c(205)_$c(239)_$c(207)_$c(254)_$c(222)_$c(232)_$c(200)_$c(242)_$c(210)_$c(6)_$c(20)
 q $tr(t,%code35,$$Uu("{275}{274}{363}{362}{299}{298}{257}{256}{353}{352}{291}{290}{311}{310}{316}{315}{382}{381}{269}{268}{326}{325}"_$c(254)_$c(254)))
code1257(t) 
 s:'$d(code1257) code1257=$c(231)_$c(199)_$c(251)_$c(219)_$c(238)_$c(206)_$c(226)_$c(194)_$c(240)_$c(208)_$c(236)_$c(204)_$c(237)_$c(205)_$c(239)_$c(207)_$c(254)_$c(222)_$c(232)_$c(200)_$c(242)_$c(210)
 q $tr(t,$$Uu("{275}{274}{363}{362}{299}{298}{257}{256}{353}{352}{291}{290}{311}{310}{316}{315}{382}{381}{269}{268}{326}{325}"),code1257)
nodeComp(n1,n2,leno) 
 q:'$d(@n1) "-"_n1  q:'$d(@n2) "-"_n2  
 n %1,%2,%,o,%1o,%2o s n1=$name(@n1),n2=$name(@n2),%1=$ql(n1),%2=$ql(n2)
 s o="",leno=$g(leno,15000),%1o=$e(n1,1,$l(n1)-1),%2o=$e(n2,1,$l(n2)-1)
 f  s n1=$q(@n1) q:n1=""  q:$ql(n1)<%1  q:$name(n1,%1)'=n1  s %=%2o_$p(n1,%1o,2,9) i $g(@n1)'=$g(@%) s o=o_$qs(n1,$ql(n1))_"="_$g(@n1)_"  "_$c(254) q:leno=1  i $l(o)>leno s o=o_" ... "_n1_" ... " q
 q:leno=1&$l(o) o
 f  s n2=$q(@n2) q:'$l(n2)  q:$ql(n2)<%2  q:$name(n2,%2)'=n2  s %=%1o_$p(n2,%2o,2,9) i '$d(@%),$l(@n2) s o=o_$c(254)_$qs(n2,$ql(n2))_$c(254) i $l(o)>leno q:leno=1  s o=o_" ... "_n2 q
 q o
globComp(globNode,UCI2) 
 n n,i0,i2,zr,ii,zr0
 k ^ogloComp(%USID) k ^ogloCom(%USID) m ^ogloComp(%USID,0)=@globNode
 x "m ^ogloComp(%USID,2)=^|UCI2|"_$e(globNode,2,999)
 m ^ogloCom(%USID)=^ogloComp(%USID,0) m ^ogloCom(%USID)=^ogloComp(%USID,2)
 k globComp s zr=$NAME(^ogloCom(%USID)),n=0,zr0=$e(zr,1,$l(zr)-1)
 f i=1:1 s zr=$q(@zr) q:zr'[zr0  s ii=$p(zr,",",2,99) d
 .i globNode["^AL",zr["ColumnWidth"!(zr[",""t_") q
 .s:ii="" ii="1)"
 .s i0="^ogloComp(%USID,0,"_ii,i2="^ogloComp(%USID,2,"_ii
 .i $g(@i0)'=$g(@i2) s n=n+1,globComp(i)=ii
 q n
 ;
SUM(rr) q 0
sume(ss,se,o) 
 s:$g(o)="" o="^" i se[$c(10),se'[o s o=$c(10)
 q:se'[o ss+se  n e
 f e=1:1:$l(se,o) s ss=ss+$p(se,o,e)
 q ss
re(%R,%B,o,ee) 
 n e,%,max,g,gg k re s gg="",max=1,o=$g(o,"^"),%B=$g(%B,$c(254)) 
 i o s gg=o,o="^"
 i %R'[o,$g(ee)'["*" s re(1)=%R q %R
 f %=1:1:$l(%R,%B) s g=$p(%R,%B,%) s:$l(g,o)>max max=$l(g,o)
 s:$g(ee)<1 ee=max
 f %=1:1:$l(%R,%B) s g=$p(%R,%B,%) f e=1:1:max s ge=$p(g,o,e) d
 .  i ge="",gg'[% s ge=$p(g,o,e-1),$p(g,o,e)=ge
 .  s $p(re(e),%B,%)=ge,re(e,%)=ge
 q $g(re(+ee\1))
reSplit(%I,%e) 
 k %re n %R,%FILE,o,%,%n,%max,%eee 
 s %max=1,%eee=9999,%e=$g(%e) s:%e %eee=+%e,%e=$p(%e,+%e,2) s:'$l($g(%e)) %e="^" 
 s %FILE=$e($p(%I,"("),2,99) i '$d(%LI(%FILE)) s %1=%FILE d ^USX
 s %R=$g(@%I) s:$l(%R)=500 %R=%R_$g(@%I@(501)) s:$l(%R)=1000 %R=%R_$g(@%I@(1001))
 f %=1:1 s %n=$tr($p(%LI(%FILE),",",%),"~") q:'$l(%n)  d 
 .f %ee=1:1 s o=$p(@%n,%e,%ee) s:%ee=1!$l(o) %re(%n,%ee)=o s:%ee>%max %max=%ee q:$p(@%n,%e,%ee+1,999)=""
 .s o=$o(%re(%n,%eee+.1),-1) s:o @%n=%re(%n,o)
 q %max
zrJoin(%zr,%n) 
 q:'$d(@%zr) ""  s:'$d(%n) %n=999999 q:'%n $g(@%zr@(%n))
 n %R s %R=$g(@%zr) s:%R=".!." %R="" i $d(@%zr@(%n))
 f  s %n=$o(^(%n)) q:'$l(%n)  i %n,$d(^(%n))#2 s %R=%R_$s($l(%R):%B,1:"")_^(%n)  
 q %R
reJoin(%) 
 q %R
checkSyn(code)  ;; cache  iris  only
 s code(0)=1,code(1)=" "_code n o,e,l
 i $zv["Ca"!($zv["IRIS") d  q $s($l(o)<4!(o["<NOLINE>"):"",1:$g(%mxForma)_" syntax_error: "_o)
 . s o=$$CHECK^%R(.code,.e,0),o=$$FMTERR^%R(.e,.code,.l),o=$p($g(l(1)),":",3,33)
 . i o["Command not valid within" s o="" 
 q ""
checkVrs(%code) 
 n %1,%2,%,%3,%oo s %oo=""
 s %1="QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890%"
 s %2="",$p(%2," ",$l(%code))=" "
 s %code=$tr(%code,%1_%code,%1_%2)
 f %=1:1:$l(%code," ") s %3=$p(%code," ",%) d
 . i $l(%3),$l(%3)<9,'%3,$e(%3,2,9)'["%" s %oo(%3)=$g(%3)
 s %3="" f  s %3=$o(%oo(%3)) q:%3=""  s %oo=%oo_%3_"="_%oo(%3)_"  "
 q %oo
mxLock(%ZR,lockTime,%E) 
 i '$g(lockTime) k ^omxLock(%ZR) q ""
 n o,Lock s Lock=$h_%B_lockTime_%B_%USID_%B_$g(%E)
 s o=$g(^omxLock(%ZR)) i $p(o,%B,3)=%USID!'o s ^(%ZR)=Lock q ""
 i $p($h,",",2)-$p(o,",",2)>$p(o,%B,2) s ^(%ZR)=Lock q ""
 i $h-o s ^(%ZR)=Lock q ""
 q o
EnterAL(oo) 
 ;?$$EnterAL ^FILE(i1,i2,i3)=f1,f2,f3,f4 name m-command-start
 q:oo[";;" ""
 n o,%FILE
 s %FILE=$p($p(oo,"("),"^",2),o=$p(oo," ",3) s:o="" o=%FILE s ^AL(%FILE,"NAME")=o
 s ^("START")=$p(oo," ",4,999)
 s o=$p(oo," ",2),o=$p(o,"(",2,99),^("%LI")=$$trw^UST(o,")=",",")
 s ^("%LG")="%SF,"_$p(o,")=",2,999)
 s o=$p(o,")="),^("%LII")=o,o=$p(o,",",$l(o,",")),^AL(%FILE,"%W",o,1)=" d F "
 q ""
ZR(%ZR,%na,%set) 
 i $e(%ZR)'="^" q "er:???:%ZR="_%ZR_":%na="_%na  ; error %ZR
 i $g(%na)="" q "er:$l(%na)=0:%ZRdelete:%ZR="_%ZR_":%na="_%na
 i '$d(%set) n %1,%,%2 d  q %2  ; read property
 .i $d(^ZR(%ZR,%na)) s %2=$g(^(%na)) q
 .s %1=$e($p(%ZR,"("),2,99)
 .i '$d(^AL(%1,"%LG")) s %2="er:?%LG?:%ZR="_%ZR_":%na="_%na q
 .s %1=^("%LG")
 .f %=1:1:$l(%1,",") i $tr($p(%1,",",%),"~")=%na s %2=$p($g(@%ZR),%B,%) q
 .i '$d(%2) s (%na,%2)="er:???%LG???:%ZR="_%ZR_":%na="_%na
 q:'%set "ok:get:%ZR="_%ZR_":%na="_%na
 i $d(@%na)#2=0 s @%na=0 q "er:%na<UNDEF>:%ZR="_%ZR_":%na="_%na
 i $g(^ZR(%ZR,%na))'=@%na s ^ZR(%ZR,%na)=@%na i $l(@%na) s ^ZR(%na,$e(@%na,1,55))=%ZR
 q "ok:set:%ZR="_%ZR_":%na="_%na
ZRnaList(%na,%K) 
 n %ZR,o,% s o="" d %lat 
 s %K=$tr($p(%K,";;"),oLat1_" ""/-.'`&",oLat2)
 f  s o=$o(^ZR(%na,o)) q:o=""  s %ZR=^(o)  d
 . q:$tr(o,oLat1_" ""/-.'`&",oLat2)'[%K
 . i '$d(@%ZR) k ^ZR(%ZR) q
 . i $d(^ZR(%ZR,%na)) s %(o)=^ZR(%ZR,%na) q
 . s %="^" f  s %=$o(^ZR(%)) q:%'["^"  i '$d(@%) k ^ZR(%)
 . s %="^" f  s %=$o(^ZR(%)) q:%'["^"  i $d(^ZR(%,%na)) d  q
 . . s ^ZR(%na,$e(^ZR(%,%na),1,55))=%
 . . s %(o)=^ZR(%,%na)
 q:$d(%)<2 %na_"?"_%K
 s o="",%=1 k ^ose(%USID)
 f  s o=$o(%(o)) q:o=""  s ^(%)=$g(^ose(%USID,%))_%(o)_$c(4) s:$l(^(%))>12000 %=%+1
 q:%=1 ^(1)  q ""
wR(%F,%I,%LIST,%1,%2,%3,%4,%5,%6,%7,%8,%9,%10,%11,%12,%13,%14,%15) 
 n %n,%,%0,%FILE,%R f %=1:1:$l(%LIST,",") s %n=$p(%LIST,",",%),%0="%"_%,@%n=@%0
 s %FILE=$$%XG^USX(%I),%R="" x %CON(%FILE)
 s:%F>0 @%I=%R
 i $$%mM^US(%F,%I)
 q 1
orFiltr(oo,o1,o2) 
 s:$e(o1)="-" o1=$e(o1,2,99) i $d(o2) s:$e(o2)="-" o2=$e(o2,2,99) 
 i oo["=" n o s o="="_$tr(oo,"+- ","==")_"=" q:o[("="_o1_"=") 1  q:'$d(o2) 0 q:o[("="_o2_"=") 1 q 0
 i $e(oo)["-" s o=oo n oo s oo=$tr(o,"-","+")
 n o,f,x s f=0 q:'$l(oo) 1
 f x=1:1:$l(oo,"+") s o=$p(oo,"+",x) i $l(o),"-"_o1[("-"_o) s f=1 q
 q:f 1 i $d(o2) f x=1:1:$l(oo,"+") s o=$p(oo,"+",x) i $l(o),"-"_o2[("-"_o) s f=1 q
 q f
save1rou(R) 
 n x,f,% s f="c:\m\"_R_".1",x="f %=1:1:9999 s t=$t(+%) w:$l(t) !,t"
 i $zv'["MS" x "zl "_R_"   o f:""WNS"":1 u f w $zv,$h,!,$zu(5),!,R x x  c f" q
 x "zl "_R_"   o 51:(f:""W""):0 u 51 w $zv,$h,!,$zu(0),!,R x x  c 51 "
 q
rest1rou(R) 
 s f="c:\m\"_R_".1"
 i $zv'["MS" x "o f:""RS"":1 u f ZLOAD  c f  ZSAVE "_R q
 x "o 51:(f:""R""):1 u 51 ZLOAD  c 51 ZSAVE "_R
 q
AL1(%ZR,%na) 
 q $$q(%ZR,%na)
q(%ZR,%na) 
 i $e(%ZR)'="^" q "er:???:%ZR="_%ZR_":%na="_%na  ; error %ZR
 i $g(%na)="" q "er:$l(%na)=0:%ZR="_%ZR_":%na="_%na
 n %1,%,%2 s %1=$e($p(%ZR,"("),2,99)
 i '$d(%LG(%1)) d ^USX i $g(%LG(%1))'["," q "er:?%LG?:%ZR="_%ZR_":%na="_%na
 s %1=%LG(%1)
 f %=1:1:$l(%1,",") i $tr($p(%1,",",%),"~")=%na s %2=$p($g(@%ZR)_$g(@%ZR@(501)),%B,%) q
 q:$d(%2) %2 
 s err="er:???%LG???:%ZR="_%ZR_":%na="_%na_"  %LG="_%1
 q ""
iiiLine s (iii,%mxIndex)=$o(^oMX(%USID,%V,iii)) q:'iii  s o=99
 f  s o=$o(^oMX(%USID,%V,iii,o)) q:'$l(o)  s @o=^(o) s:@o="*" @o=@o_"<mx ic15.99"
 q
%YX(%yxq,%YXyy,%YXxx) 
 n %q,%x,%y,%,%1,%2,%yy,%xx,%e,oo,%n s %y=$g(%YXy,1),%x=$g(%YXx,1),%e=""
 i $e(%yxq)="?" s %n=$p(%yxq," "),%yy=0 d  q 1_%yxq
 . i %n'["_" s %n=$e(%n,2,99),%=$p($g(^oRC(%USID,%mxForma,"?var",%n)),";",2,999) x % s:$d(@%n) %YX(%n)=$g(@%n) s:$d(oo) %YX(%n)=$g(oo) k oo q
 . f  s %yy=$o(^oRC(%USID,%mxForma,%yy)) q:'%yy  s %xx=1 f  s %xx=$o(^oRC(%USID,%mxForma,%yy,%xx)) q:'%xx  i $e(^(%xx),1,$l(%n))=%n s %=$p(^(%xx),";",2,999) x % s %=$tr(%n,"?_") s:'$d(oo)&$d(@%) oo=$g(@%) d  k oo  
 .. i $d(oo) s %YX($s($g(%YXyy):%YXyy,%n["_":%YXy,1:%yy),$s($g(%YXxx):%YXxx,1:%xx))=oo
 f %=1:1:$l(%yxq," ") s %1=$p(%yxq," ",%),%q=$p(%1,"=",2,999) s:%q="" %q="%e" d:$l(%1)
 . i %1'["=" s %q=$$trw^UST(%1,"[]"," ") s:$e(%q,1,3)="<mx" %q="<mx "_$e(%q,4,999),%q=$g(%YXq)_%q s %YX(%y,%x)=%q q
 . s %2=$p($p(%1,",",2),"="),%1=$p(%1,",") s:%1 %y=%1,%1="" s:%2 %x=%2,%2=""
 . x:$l(%1) "s %y="_%1 x:$l(%2) "s %x="_%2
 . x "s %YX(+%y,+%x)="_%q q:%y_%x'[":"
 . f %yy=+%y:1:+$p(%y,":",2) f %xx=+%x:1:+$p(%x,":",2) x "s %YX(%yy,%xx)="_%q
 q 1
CalcF11(%t) 
 n %x,%,%1,%d,%b,o s %x="",%d="|",%b="    ---------------------------"
 q:%t["::" ""  q:%t=""&0000 "EXIT" q:$e(%t,1,4)="EXIT" %t_%b q:%t'[%d %t_%d
 q:"zw"[%t %t  i $e(%t,1,3)[" ","wWzZsS"[$e(%t) q %t
 q:%t[(%b_%d_%b_%d_%b_%d) "EXIT" ;; q:%t[(%b_%d_%b_%d_%b_%d) ""
 f %=1:1:$l(%t,%d) s %1=$p($p(%t,%d,%),"  "),$p(%t,%d,%)=%1 d
 . i %1["---" s %t="" q
 . i "QWERTYUIOPASDFGHJKLZXCVBNM%$qwertyuiopasdfghjklzxcvbnm"[$e(%1_1),%1'[" ",%1'="zw",%1'="w" x "s o="_%1 s $p(%t,%d,%)=o_"    "_%1,%1=o
 . i "+...+0..+//+::+**+======"[%1 s %1="" s:%>1 $p(%t,%d,%)=%b q
 . i $l($p(%1,"="))>0,$l($p(%1,"=",2,99))>0,'%1 x "s "_%1 q
 . i %>1!(%1'=+%1) s:"1234567890."[$e(%1) %1="+"_%1
 . s %x=%x_%1 q:%=1&($e(%1)'="+")  q:$l($p($p(%t,%d,%+1),"  "))
 . s %1=$p($p(%t,%d,%),"  ")_"   ",%1=%1_$e("                                ",$l(%1),15)
 . x "s %x="_%x s $p(%t,%d,%)=%1_"= "_%x_"  =",%x=""  
 q:$l(%t) %t_%d q ""
mJournal(%t,%y,%x,%q,%n) 
 q:'%t "" q:'$d(^mJournal(%t,0)) "" q:$zv["MS" "" s %mxSheet=$p(^(0),%B,2) 
 n %,o,%Yrc s:$l($g(%n)) %=$tr($g(@%n),%B) i $$%0Yrc^MXTQM2(%y)
 s:'$d(%) %=$tr($g(^oYX(%USID,%mxSheet,%y,%x)),%B),%n=$e($p($g(^oRC(%USID,%mxForma,%Yrc,%x))," "),2,99)
 s o=$o(^mJournal(%t,999999),-1)+1,^(o)=%y_%B_%x_%B_$g(%n)_%B_%_%B_%q
 q %
getJourn(%1,%2) 
 q $$getJourn^MXTQM(%1,%2)
ooo2(o) n ooo,% s ooo="" f  s o=$q(@o) q:'$l(o)  d  s ooo=ooo_$c(4)_@o_$c(5)
 . f %=1:1:$ql(o) s ooo=ooo_$s($qs(o,%)["<:>":$p($qs(o,%),"<:>",2),1:$qs(o,%))_$c(4)
 q ooo
oooYX() n ooo,y,x,%,%Yrc s ooo="",%="%"
 f  s %=$o(%YX(%)) q:'$l(%)  s x=$g(^oRC(%USID,%mxForma,"?var",%)) s:x %YX(+x,+$p(x,"-",2))=%YX(%) k %YX(%)
 s y=0 f  s y=$o(%YX(y)) q:'y  s %="%" f  s %=$o(%YX(y,%)) q:'%  d:$$%0Yrc^MXTQM2(y)  k %YX(y,%)
 . s x=0 f  s x=$o(^oRC(%USID,%mxForma,%Yrc,x)) q:'x  i $p($p(@$zr,"?_",2)," ")=% s %YX(y,x)=%YX(y,%) q
 f  s y=$o(%YX(y)) q:'y  s x=0 f  s x=$o(%YX(y,x)) q:'x  q:$l(ooo)+$l(%YX(y,x))>22000  s ooo=ooo_y_-x_"-"_%YX(y,x)_$c(4) k %YX(y,x)
 k:$l(ooo)<10000 %YX
 q ooo
%SEL(%f,%k) ;; q:'$d(%ALx)
 s %f=$name(@%f,0),%k=$tr(%k,oLat1_" .",oLat2) q:$l($g(%E))!$d(%SEL)!($l(%k)<2)
 f  s %f=$q(@%f) q:'$l(%f)  i $d(@%f)#2,$tr(%f_@%f,oLat1_" .",oLat2)[%k s %SEL($qs(%f,1))=@%f,%E="%SEL"
 q
comment(s,mode) 
 ; ^list from comment of the cell
 n %,o,n,q s n=0 q:mode'="^" 0  q:s'[mode ""
 s s=$tr(s,$c(10)_$c(13),%B_%B) i $l(s,"^")>2,s'[%B s s=$$trw^UST(s,"^",%B_"^")
 s s=s_%B
 f %=1:1 q:'$l(s)  s o=$p(s,"^"),s=$p(s,"^",2,999),o="^"_$p(s,")"_%B)_")"_%B_o,s=$p(s,")"_%B,2,999) d 
 . s %SEL($p(o,%B))=$g(%SEL($p(o,%B)))_%B_$p(o,%B,2,99)
 q %
 q
omReplace(z,%re,%de,%xe) 
 k ^omo(%USID) n zz,o
 for  s z=$q(@z) q:'$l(z)  q:$qs(z,1)'=%USID  s zz=$replace(z,"^om(","^omo(") d:z[(%re_%de)  s @zz=@z 
 . s o=$g(^(%re)) x:$d(%xe) "s "_%re_"=o,o="_%xe s zz=$replace(zz,%re_%de,o_%de)
 i $d(o) k ^om(%USID) m ^om(%USID)=^omo(%USID)
 q $d(o)
 q

MXGTM^INT^1^65495,42075^0
MXGTM ; for GTM ; ;[ 20190602 22:24:47 ]
 q
FREAD ; terminal gtm !!
 x "zprint ^FREAD" 
 read "File > ",sd set retry=0 set $ztrap="BADAGAIN" 
 open sd:(readonly:exception="do BADOPEN") use sd:exception="goto EOF"
 for  use sd read x use $principal write x,!
EOF 
 if '$zeof zmessage +$zstatus 
 close sd quit 
BADOPEN 
  set retry=retry+1 if retry=2 open sd
  if retry=4 halt
  if $piece($zstatus,",",1)=2 do
  . write !,"The file ",sd," does not exist. Retrying in about 2 seconds ..."
  . hang 2.1
  . quit
  if $piece($zstatus,",",1)=13 do
  . write !,"The file ",sd," is not accessible. Retrying in about 3 seconds ..."
  . hang 3.1 
 . quit 
 quit 
BADAGAIN 
 w !,"BADAGAIN",!
 quit 
 ;
tcp ; GT.M native master server
  s timeo=30
  s port=2233  ;; 6331
  s tcp="|TCP|"_port
  o tcp:(ZLISTEN=port_":TCP":NODELIMITER:ZNODELAY:ATTACH="listener"):timeo:"SOCKET"
  e  q
  ;u tcpdev:morereadtime=100
  u tcp
 x " w /listen(1)"
  f  d  q:$key]""
  . x "w /wait(timeo)"
  . i $key]"" q
  s socket=$p($key,"|",2)
 close tcp:(SOCKET="listener")
 j tcp^MXGTM
 use tcp:(NODELIMITER:ZNODELAY:SOCKET=socket) ;; j listen^%mwire
  ;c tcp:(SOCKET="listener")
  ;u tcp:(NODELIMITER:ZNODELAY:SOCKET=socket)
  ;;   d command
L s ooo=""
 f  READ *%:60  d:%>-1  s uci=$tr($p($p(ooo," UCI=",2)," "),"""") s:$e(ooo,1,3)="GET" o=$p($p($p(ooo,"UCI=",2),";",1,6)," "),uci=$p(o,";") q:$l(uci)>2!111
 . ;; s ^mxMonito($$ts,3.1,-$j)=% 
 . s:%>0 ooo=$c(%) f  READ *%:0  s ooo=ooo_$c(%)  q:%<0  
 . ;; s ^mxMonito($$ts,3.2,-$j)=ooo
 s Html=$l(ooo)_-987654321
 s %=$c(13)_$c(10),%1=$l(Html)
 s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 w %mxWeb_%1_%_%_Html,$c(0),*-3 ;; k:000 ooo,Html,uci,port,shee ;;  d:$d(o) saveMem
 use 0  w ooo,!,$key,!,Html 
 use tcp
 g L
mwireVersion 
  ;;Build 22
  ;
mwireDate 
  ;;06 July 2011
  ;
version 
  ;
  s output="+M/Wire "_$p($t(mwireVersion+1),";;",2,2000) ;_separatorend;
  w output
  QUIT
  ;

MXTQM^INT^1^65495,42075^0
MXTQM ;  [ 03/28/2005  1:14 AM ]  ;[ 20200322 13:45:16 ]
 ; MSM, CACHE, IRIS, GT.M, MiniM
 ; vmx ( multi-users virtual EXCEL incorporated into the database )
 ; Copyright (c) 2005-2020, SIA ENTERS, Latvia, 42102022219
 ; registered by Agency INTELS, Riga, Latvia, 40003134156, on June 28, 2005, Nr.178
 q
TQM(o) ; Create & Processed ^oTQMo(%USID,%mxForma)
 s %UCI=$$UCI^MX(),%USID000=$g(%USID(0)) k:$zv["MiniM" ^mxMonito
 d:$zv["Ca"!($zv["IRIS") DISABLE^%NOJRN n %zvMSM,gotoForm,oXoooooo,oFlgLANG  s %zvMSM=$s($zv["MS":1,1:+$g(%zvMSM))
 n oo,ooo,%ooOOooo,%oXoOxx1,oOOiii,oOOqqq,oOOqqq14,%noOOooo,%,%1,%2,%3,%3mapGlo,%1globYX,%2globYX,%4,%3flag,%0,%N
 n yyROW,%yyROWnn,yyPLUSoo,xxCOL,flagItog,flagIton,flagItos,%MxEXCEL,%YXy,%YXx,%Yrc,mxLvarYX,%mVarsYX
 n %mxIndeQ,%l,%lX,%E,ERRinTQM,butCount,%mxSheet,%tabRow1,%tabRow,%zTQMo,%insRows,%lastTab 
 s butCount=0,%mxIndeQ=999999,%mxIndex="",%j=$g(%j,1),%B=$g(%B,$c(254)) s:'$l($g(%mxForma)) %mxForma=0 s %mxSheet=%mxForma k %insRange,%InsRange,%insColns
 ; i %mxForma'="datums",'%mxForma s ^mJournal(%USID,$$pD^MXF($h,2),"%mxForma")=%mxForma
 s %=$g(%USID("EnterCodePass")) k:%=6152!("ATG VMXIRIS"[%UCI)!$d(%mxWeb) %
 i $d(%) s o=$g(^mxConfig(1)) i o,o-% HALT
 i $d(%) i $d(^mxConfig(2)) s o=$g(^(2,%USID)) HALT:'o&'%  i o>9,o-% HALT
 i $d(%) i $d(^mxConfig("F",%mxForma)),'$d(^(%mxForma,%USID)) HALT
 s $zt="ErrTQM^MXTQM" i %USID'=$g(%USID000),$l($g(%USID000)) d
 .s %=" --- {1080}{1079}{1084}{1077}{1085}{1077}{1085}{1080}"
 .s %mxWarng(-1)=%_"e {1080}{1076}{1077}{1085}{1090}{1080}{1092}{1080}{1082}{1072}{1090}{1086}{1088}{1072} {1082}{1083}{1080}{1077}{1085}{1090}{1072} MX !! --- (( "_%USID
 .s %USID=%USID000 
 k oYX,%YX,%YXi s o=%USID,(oSheetYX,%)=%mxForma i '%mxForma s persAizs=12
 k ^oTQMo(o,%),^oTQMo2(o),^oTQMret(o,%),^oErr(o),^onEvents(o,%)
 k ^omxMacro(o,%),^omxGlobA(o,%),^onSelect(o,%),^onChange(o,%),^oYX(o,%)
 k ^omxRight(o,%),^omxGlobR(o,%)  ; onRightClick
 k ^onSeleDD(o,%)  ; sel and xecute m-comm mapped with selected item from DD-API list
 i $d(%mxWeb) m ^oTQMo(o,%)=^oRC(o,%) k ^oYrc(o,%) q:'$d(^oRC(o,%)) 0  d
 . s %1=0,%2=0 f  s %1=$o(^vmxExcel(o,%,".Hyperlinks",%1)) q:'%1  f  s %2=$o(^vmxExcel(o,%,".Hyperlinks",%1,%2)) q:'%2  s %3=^(%2),^(%2)=$g(^oTQMo(o,%,%1,%2),0)_"<mx ;.Hyp="_%3
 i '$d(%mxWeb) k ^oRC(o,%) m:$d(^oTQM(o,%)) ^oTQMo(o,%)=^oTQM(o,%),^oRC(o,%)=^oTQM(o,%) m:'$d(^oTQM(o,%)) ^oTQMo(o,%)=^oTQM(o),^oRC(o,%)=^oTQM(o) s ^vmxExcel(o,%,"M=EXCEL")=$g(mxConfig("M=EXCEL",%mxForma))  
 s %2max=0,(%,%MxEXCEL)=$g(^vmxExcel(o,%,"M=EXCEL")),%1=$p(%," "),%2=$p(%," ",2),%3mapGlo=$p(%," ",3)
 i $zv'["Ca",$zv'["IRIS",%["^||" s:%1["^||" %1="" s:%2["^||" %2=-9 s:%3["^||" %3=""  
 k:'$l(%3mapGlo) %3mapGlo i "M o . e"'[%1 s %mVarsYX=%1 
 s:"o."[%2 %2=-9 s:$e(%2)="^" %2globYX=%2,%2=-9 s:'%2 %mVarsYX=%2
 i %[";n%oTQMall" n %oTQMall s %oTQMall=1
 q:'$d(^oRC(%USID,%mxForma)) "ERROR :::  not exist "_$zr 
 x $p(%,";",2,999) s (yyROW,xxCOL,%2,%1,%0)=0,%zTQMo=$name(^oTQMo(%USID,%mxForma)) k yFORMAT n %oRChange  
 f  s %1=$o(^oTQMo(%USID,%mxForma,%1)) q:'%1  i $o(^(%1,1)) s %2=1 f  s %2=$o(^(%2)) q:'%2  s:%2>%2max %2max=%2 i $e(^(%2))="?" s %=^(%2),%4=$e(%,1,5) d:%4'["^^"
 . i $e(%,1,3)["=" s %=$p(%,"=",2,999) s:$e(%)'=" " %=" s oo="_% s (^oRC(%USID,%mxForma,%1,%2),@%zTQMo@(%1,%2))="?"_$s($e(%,1,3)["_"!%0:"_",1:"")_"o ;"_% q
 . i $e(%,1,9)["?_%mxInde" s:%[" f  s " @$zr=$$trw^UST(%," f  s "," f %mxIndeO=1:1:9999999 s ") q   
 . i $e(%,1,12)["?$$EnterList" k:'$d(%mxWeb) @%zTQMo@(%1,%2) q
 . i $e(%,1,12)["?$$ReadTable" d  q
 .. n oOOqqq s oOOqqq=% n %22,%n,%,%i,%node,%mNode,%mComm,yyRow s yyRow=%1
 .. s @%zTQMo@(%1,1)="~",@%zTQMo@(%1+1,1)="~",%=""
 .. s %mComm=$p(oOOqqq," ",3,999),%node=$p(oOOqqq," ",2) s:oOOqqq[" ; " %mComm=$p(oOOqqq," ; ",2,999)
 .. f %22=%2:1 q:'$o(@%zTQMo@(%1+1,%22-1))  s %n=$p($g(^(%22)),"<") s:%n["*" (%i,%n)=$tr(%n,"*") s:%n=")" %i=%22 q:%n=")"  s:$l(%n)&'%n %="s "_%n_"=$g(^("_%22_")) "_% d
 .. . s:$l(%node) %mNode=" s @%node@(@%i,"""_%n_""")="_%n_$g(%mNode)
 .. i $g(%i) s %mNode="",%="" f %22=%2:1 q:'$o(@%zTQMo@(%1+1,%22-1))  s %n=$g(^(%22)) s:%n %mNode=" s $p(@%node@(@%zTQMo@(%1,"_%i_")),%B,"_+%n_")=$g(@%zTQMo@(%1,"_%22_")) "_%mNode
 .. k:'$d(%i) %mNode s %mComm="n %,%11,%1,%2,o "_%mComm i $l(%node),$e(%node)'="^" k @%node 
 .. f %1=%1+2:1 q:'$o(@%zTQMo@(%1,1))!($o(^(1))>%22)  x %,$g(%mNode),%mComm k @%zTQMo@(%1) s ^(%1,1)="~"
 . i "^.@"'[$e(%4,2),%4'["*" q 
 . i %4["**",%2<$s($p(%,"**",2):$p(%,"**",2),1:250),%2<%2max&('$o(^(%2))!111),'$l($g(^(%2+1))) s @$zr=%,%oRChange(%1,%2+1)=%
 . i %4["*" s %4=%4_-1,%4=$p(%4,"-",2) s:%4 (^(%2),%oRChange(%1,%2))=$g(@%zTQMo@(%1,%2-%4)) q  
 . i %="?^" k ^(%2) x "f o=1:1:9 s %=$g(@%zTQMo@(%1-o,%2)) i $l(%)>2 s (%oRChange(%1,%2),@%zTQMo@(%1,%2))=% q" q 
 . s %=$p($e(%,3,99)," ") i %=1 s %=$tr($p(^(%2)," ",2,999),"""","'") d  q
 .. i '$d(helpShow(%mxForma,%1,%2)) s helpShow(%mxForma,%1,%2)=%,^(%2)="?o ; s oo="""_%_""" "
 .i %=".",%4["..",$e($g(^(%2-1)))="?" s ^(%2-1)=^(%2-1)_" "_$p(^(%2)," ",2,999) k ^(%2) q
 . q:"o %2..??"[%!%  s @%=$p(^(%2)," ",2,999) x "f  q:$e(@%)'="" ""  s @%=$e(@%,2,999)" 
 . s:$e(@%)=";" @%=$e(@%,2,999) s %noOOooo=%,^(%2)="",o=%2+1
 . i $e($g(^(o)),1,3)="?.." s @%noOOooo=@%noOOooo_$p(^(o),"..",2,999),^(o)="",o=o+1
 . i $e($g(^(o)),1,3)="?.." s @%noOOooo=@%noOOooo_$p(^(o),"..",2,999),^(o)=""
 . i $zv'["MS"!($l(@%noOOooo)<512) s ^omxForma(%USID,%mxForma,"?.var",%noOOooo)=@%noOOooo,^oRC(%USID,%mxForma,"?.var",%noOOooo)=@%noOOooo k ^oRC(%USID,%mxForma,%1,%2) i $d(@%zTQMo@(%1,%2))
 ;; s %=9999999999 f  s %=$o(@%zTQMo@(%),-1) q:'%  q:$g(^(%,1))'["~"  k @$zr 
 i $d(%oRChange) m ^oRC(%USID,%mxForma)=%oRChange,^oTQMo(%USID,%mxForma)=%oRChange k %oRChange
 s %="" f  s %=$o(^oRC(%USID,%mxForma,"?.var",%)) q:'$l(%)  s @%=^(%) 
 s ^oRC(%USID,%mxForma,"?$$TQM",1)=%MxEXCEL
 i $d(%mVarsYX) k @%mVarsYX m @%mVarsYX=^oTQM(%USID,%mxForma),mxLvarYX=%mVarsYX
 s (yyROW,%mxIndex,%oXoOxx1,%YXy,%tabRow,oOOqLANG,%insRows)="",oFlgLANG=("LV"'[$g(%LANG))_$g(%LANG)
 f  s yyROW=$o(@%zTQMo@(yyROW)) q:'yyROW  d  d:$d(%lX) %lX d:%YXy>999999 r999999 q:yyROW<0  m:$d(%mVarsYX) @%mVarsYX@(%YXy)=@%zTQMo@(yyROW) 
 . i %USID'=$g(%USID000),$l($g(%USID000)) d  s yyROW=-yyROW,%USID=%USID000 q
 ..s %=yyROW_"  "_%mxForma_" -- {1079}{1072}{1073}{1083}{1086}{1082}{1080}{1088}{1086}{1074}{1072}{1085}{1086}"
 ..s %mxWarng(-2)=%_"  !! {1087}{1077}{1088}{1077}{1082}{1083}{1102}{1095}{1077}{1085}{1080}{1077} {1085}{1072} {1076}{1088}{1091}{1075}{1086}{1075}{1086} {1072}{1073}{1086}{1085}{1077}{1085}{1090}{1072} !!  "_%USID
 . s xxCOL=1,%oXoOxx1=$g(@%zTQMo@(yyROW,1)),%xxxHideRow=0 
 . ;; s:yyROW["." %YXy=%YXy+1 s:yyROW'["." %YXy=%YXy+yyROW-%yROWold,%yROWold=yyROW
 . s %YXy=yyROW\1+%insRows
 . i $g(%insRange)>0 n %1,%2,%3,% s %1=$p(%insRange," ",2),%2=+$p(%1,":",2),%3=$o(@%zTQMo@(9999999),-1),%1=+%1 d:%1&%2  s %InsRange=%insRange s %insRange(0)=%insRange,%insRange=$zr_%insRange
 . . f %=%3:-1:%2+1 m @%zTQMo@(%2-%1+1*%insRange+%)=@%zTQMo@(%) k @%zTQMo@(%) 
 . . f %3=1:1:%insRange f %=%1:1:%2 m @%zTQMo@(%2-%1+1*%3+%)=@%zTQMo@(%)
 . i $g(%insColns)>0 n %1,%2,%3,% s %1=$p(%insColns," ",2),%2=+$p(%1,":",2),%1=+%1 d:%1&%2  s %insColns(0)=%insColns,%insColns=$zr_%insColns
 . . n y s y=0 f  s y=$o(@%zTQMo@(y)) q:'y  i $o(^(y,%1)) s %3=$o(^(999999),-1),%insColns(y,%2)=%3 d
 . . . i %3>%2 f %=%3:-1:%2+1 i $d(^(%))#2 s ^(%2-%1+1*%insColns+%)=^(%) k ^(%)
 . . . f %3=1:1:%insColns f %=%1:1:%2 s:$d(^(%))#2 ^(%2-%1+1*%3+%)=^(%)
 . s %tabRow=$s($e(%oXoOxx1)="_":%tabRow+1,1:0),^oYX(%USID,%mxForma,%YXy,0)=yyROW_$s(%tabRow:-%tabRow,1:"")
 . i %tabRow d
 .. i %tabRow=1 s %tabRow(1)=%YXy,%tabRow(1)=yyROW k %tabRow1 m %tabRow1=@%zTQMo@(yyROW) q
 .. s %=$d(@%zTQMo@(yyROW,-1.11)) f  s %=$o(%tabRow1(%)) q:'%  s:$e($g(^(%)))["?" %tabRow1(%)=^(%) s:$e(%tabRow1(%))="?" ^(%)=%tabRow1(%)
 . f  s (%YXx,xxCOL)=$o(@%zTQMo@(yyROW,xxCOL)) q:'xxCOL  d  q:xxCOL<0  i $l($g(oOOqLANG)) s (@%zTQMo@(yyROW,xxCOL),^oYX(%USID,%mxSheet,%YXy,xxCOL))=oOOqLANG,oOOqLANG=""  
 .. s oOOqqq=^(xxCOL),oOOiii=$zr,%N="oooooooo" s:'$d(%tabRow) %tabRow=0 i $e(oOOqqq,1,3)'="?$$" s:"?"[$e(oOOqqq)&$d(%mxWeb) ^(xxCOL)="" i yyROW["."!'$d(%mxWeb) k:'$d(%oTQMall)&(oOOqqq'["<mx ") ^(xxCOL) q:$l(oOOqqq)<2
 .. i $e(oOOqqq)'="?" k:%tabRow>$d(%mxWeb)&'$d(%oTQMall) ^(xxCOL) s:$g(oFlgLANG) oOOqLANG=$g(^mxDictio(%LANG,$e($$U^MXF(oOOqqq),1,255))) q:%tabRow  s:$e(oOOqqq)'="="&(" 0 - "'[oOOqqq) ^oYX(%USID,%mxSheet,%YXy,xxCOL)=oOOqqq q
 .. s %3flag=$p(oOOqqq,";")'["-"
 .. s oOOqqq14=$e(oOOqqq,1,4),oOOqqq1=$s(oOOqqq14'["*":oOOqqq,1:"") q:oOOqqq14[".."
 .. k oo s %=0 i $e(oOOqqq,1,3)="?$$" d  s o=$p($p(oOOqqq," "),":") s:$l(o) ^oRC(%USID,%mxForma,o,%YXy_-%YXx)=oOOqqq i $p(oOOqqq," ")'["::" s %=1 i $e(oOOqqq,1,7)="?$$Diagr" s %=0 q
 .. . i $d(%mxWeb),$p(oOOqqq," ")["::" s $p(oOOqqq," ")=$$trw^UST($p(oOOqqq," "),"::",":")
 .. i % d  s o="" q:$e(oOOqqq,1,4)'["?$$B"  x:oFlgLANG "s %=$p($g(@oOOiii),"" "",4) s:$l(%)>2 %=$tr($g(^mxDictio(%LANG,$$u8^MXF(%))),"" "",""_"") s:$l(%) $p(@oOOiii,"" "",4)=%" q
 .. . n o s o=$p($p(oOOqqq," "),":",2) i $l(o) x "s o="_o s:o $p(oOOqqq," ")=$p($p(oOOqqq," "),":"),@oOOiii=oOOqqq  i 'o s @oOOiii="",oOOqqq="" q
 .. . i $e(oOOqqq,1,10)="?$$SaveMem" s %=$p(oOOqqq," ",2) s:%="" %=%mxForma i 1_$$SaveMem^USX(%USID,$j_%) s @oOOiii="" q
 .. . i $e(oOOqqq,1,10)="?$$RestMem" s %=$p(oOOqqq," ",2) s:%="" %=%mxForma d  s @oOOiii="" q
 .. . . s %1=$p(oOOqqq," ",3) s:$e(%1)="(" %1=$e(%1,2,$l(%1)-1) n:$l(%1) @(%1)
 .. . . n oOOiii,oo,yyROW,xxCOL,%noOOooo,oOOqqq,o,%YXy,%YXx,%tabRow,%mxForma,%mxWarng,%insRows
 .. . . s %1=$$RestMem^USX(%USID,$j_%)
 .. . i $e(oOOqqq,1,10)="?$$RunLine" s %=$$RunLine(yyROW,%YXx),@oOOiii="" q
 .. . i $e(oOOqqq,1,10)="?$$omQuery" s %=$$RunLine(yyROW,%YXx),@oOOiii="" q
 .. . s oXoooooo=$p(oOOqqq," ;;; ",2,99) i $l(oXoooooo)>1 x oXoooooo
 .. . i $l(oOOqqq,"?")>2 s oOOqqq=$$InsVar6(oOOqqq),@oOOiii=oOOqqq
 .. . i $p(oOOqqq," ")["--"!($e(o,1,7)="?$$B 0 ") s @oOOiii="" q
 .. . i $e(oOOqqq,1,6)["?$$B~ ",$d(%mxWeb) s @oOOiii="?$$B"_$p(oOOqqq,"~",2,99) q
 .. . i $e(oOOqqq,1,7)="?$$RunX" s %=$$RunX(yyROW,%YXx,oOOqqq),@oOOiii="." q
 .. . i $e(oOOqqq,1,5)["?$$B~" s o=$p(oOOqqq," ",4),o=$s(o="":%B,$e(o,1,2)["[":$p(o,"[",2,22),1:o),@oOOiii=$tr(o,"_[]"," "),o=".<mx <$$B "_$p(oOOqqq," ",2,999)_" /$$B>",o=$$S^MXF("s oo="""_$$kav2^MXF(o)_"""") q
 .. . i $e(oOOqqq,1,4)["?$$B" s:'$d(%mxWeb) butCount=butCount+1 d:butCount>220!(butCount>99&%tabRow)  q
 .. .. s butCount=butCount-1,o=$p(oOOqqq," ",4),o=$s(o="":%B,$e(o,1,2)["[":$p(o,"[",2,22),1:o)
 .. .. s @oOOiii=$tr(o,"_[]"," "),o=".<mx <$$B "_$p(oOOqqq," ",2,999)_" /$$B>",o=$$S^MXF("s oo="""_$$kav2^MXF(o)_"""")
 .. q:" ?$.@*^012"[$e(oOOqqq14,2)  s (%N,%noOOooo)=$tr($p($p(oOOqqq," "),";"),"?_"),oXoooooo=$p(oOOqqq,";",2,999)
 .. i %noOOooo="%l" k %l m %l=^oYX(%USID,%mxSheet,%YXy) m %l=@%zTQMo@(yyROW) k %l(0)
 .. i $d(%YX),$d(%YX(%YXy,%YXx)) s @%N=%YX(%YXy,%YXx) k %YX(%YXy,%YXx)
 .. i $p($p(oOOqqq," ",1,5),";")_" "[" oo " s oo=$g(@%noOOooo),@%noOOooo=$p(oo,"<mx ")
 .. i $e(oOOqqq14,2)'="_" s %noOOmod=$p(oOOqqq," ; ")_" " d  q
 ... s:"oo %1 "'[%noOOooo ^oRC(%USID,%mxForma,"?var",%noOOooo)=%YXy_-%YXx_"---"_oOOqqq d  i oXoooooo="" s:$d(@%noOOooo)#2 ^oYX(%USID,%mxSheet,%YXy,%YXx)=$p(@%noOOooo,"<mx ") q
 ... . i %noOOmod[(" zw ") x oXoooooo n %,o s o=%noOOooo f %=1:1 s o=$q(@o) q:'$l(o)  s %YX(%YXy+%,%YXx)=o,%YX(%YXy+%,%YXx+1)=$g(@o)
 ... . q:$l(oXoooooo)>1
 ... . i '%noOOooo,$l(%noOOooo)<33,"o"'[%noOOooo,$l($g(@%noOOooo)) d:$g(oFlgLANG)  s @oOOiii=$e(@%noOOooo,1,$s('%zvMSM:31500,1:%zvMSM+509)) s:$d(%3mapGlo)&%3flag %3mapGlo(%noOOooo)=$p(@oOOiii,"<mx ") q
 ... . . s %=$p(@%noOOooo,"<mx ") i $l(%)>2 s %=$g(^mxDictio(%LANG,$e(%,1,255))) i $l(%) s:$l($p(@%noOOooo,"<mx ",2)) %=%_"<mx "_$p(@%noOOooo,"<mx ",2) s @%noOOooo=%
 ... q:$l(%noOOooo)>31 
 ... i oXoooooo["$$RestMem^" d  s @oOOiii="" q
 ... . n oOOiii,oo,yyROW,xxCOL,%noOOooo,oOOqqq,o,%YXy,%YXx,%tabRow,%mxForma,%insRows
 ... . x oXoooooo
 ... k gotoForm x oXoooooo
 ... i "o oo ooo"'[%noOOooo,%noOOooo'["%" s %=$p($g(@%noOOooo),"<mx ") s:$l(%)>510 %=$e(%,1,$s('%zvMSM:31500,1:%zvMSM+509)) s ^oYX(%USID,%mxSheet,0,%noOOooo)=%,^oYX(%USID,%mxSheet,%YXy,%YXx)=%
 ... i $d(oo) d:$g(oFlgLANG)  s:$l(oo)>505 oo=$e(oo,1,$s('%zvMSM:31500,1:%zvMSM+509)) s:$g(%oXoOxx1)'["~" @oOOiii=oo
 ... . s %=$p(oo,"<mx ") i $l(%)>2 s %=$g(^mxDictio(%LANG,$e($$U^MXF(%),1,255))) i $l(%) s:$l($p(oo,"<mx ",2)) %=%_"<mx "_$p(oo,"<mx ",2) s oo=%
 ... i $d(%3mapGlo) s:%3flag %3mapGlo(%noOOooo)=$p($g(oo),"<mx ") i %3mapGlo[%noOOooo s %=$tr(%3mapGlo,"()",",,") i %[(","_%noOOooo_",") k %3mapGlo(%noOOooo)
 ... i $d(%mVarsYX),$l($g(@oOOiii)) s @%mVarsYX@(%YXy,+xxCOL)=$p(@oOOiii,"<mx ")
 ... i $d(mxERROR) s xxCOL=-xxCOL,yyROW=-yyROW q
tabRow .. i $e(oOOqqq14,2)="_" s %lastTab=%YXy d  q
 ... i %noOOooo="%l" k %l m %l=@%zTQMo@(yyROW) q
 ... i oXoooooo="","oo "'[%noOOooo d  q:%noOOooo'="%mxIndex"
 ...  .  i %oXoOxx1["~" q
 ...  .  i $p(oOOqqq,";")[" format" set @%noOOooo=$$omFormat^MX($g(@%noOOooo))
 ...  .  i %noOOooo="%mxIndex",$p(oOOqqq," ",2) s oXoooooo="set %mxIndex=$$mxIndex^MX("_+$p(oOOqqq," ",2)_")" q
 ...  .  s o=$g(@%noOOooo),%=$p(o,"<mx ") i $g(oFlgLANG),$l(%)>2 s oOOqLANG=$g(^mxDictio(%LANG,$e(%,1,255))) i $l(oOOqLANG) s %=oOOqLANG i $l($p(o,"<mx ",2)) s o=%_"<mx "_$p(o,"<mx ",2)
 ...  .  i $l(o)>510 s %=$e(%,1,$s('%zvMSM:31500,1:%zvMSM+509)),o=$e(o,1,$s('%zvMSM:31500,1:%zvMSM+509)) 
 ...  .  s @oOOiii=o s:$d(mxLvarYX) @mxLvarYX@(%YXy,+xxCOL)=%
 ...  .  s ^oYX(%USID,%mxSheet,%YXy,%YXx)=%,^(%noOOooo)=%
 ... i %noOOooo="%mxIndex" s %mxIndex(0)=%mxIndex,%mxIndex="" n %l i %oXoOxx1["~" s %oXoOxx1=%YXx d  i %noOOooo<9999999 s xxCOL=-1 q
 ... . n %n,oo f %noOOooo=1:1:9999999 s:000 %mxIndex="" x oXoooooo q:%mxIndex=""  d
 ... .. s %YXx=%oXoOxx1
 ... .. f  s %YXx=$o(@%zTQMo@(yyROW,%YXx)) q:'%YXx  s %=$g(^(%YXx)) i $e(%,1,2)="?_" s %n=$tr($p(%," "),"?_*") i $l(%n),'%n s oo=$g(@%n) x $p(%,";",2,999)   
 ... x oXoooooo i $d(oo),$l(oo)>509,%zvMSM  s:%zvMSM=1 oo=$p(oo,"<mx ") s oo=$e(oo,1,%zvMSM+509)
 ... i %noOOooo="%mxIndex" d  q:xxCOL<0  i $d(%l)>9 m @%zTQMo@(yyROW)=%l s @oOOiii=$g(oo),xxCOL=-1 q 
 ... . i '%tabRow,oXoooooo["=%tabRow" k @%zTQMo d  q
 ... . . n % s %=yyROW_$c(10)_oXoooooo_$c(10)_$g(%mxForma)_" ERROR:_%mxIndex>(%tabRow=0) -  {1085}{1072}{1076}{1086}" 
 ... . . s (%mxWarng(yyROW),mxERROR)=%_" {1085}{1072}{1076}{1086} {1091}{1074}{1077}{1083}{1080}{1095}{1080}{1090}{1100} {1088}{1072}{1079}{1084}{1077}{1088} {1090}{1072}{1073}{1083}{1080}{1094}{1099} !! "_%mxIndex
 ... . i yyROW[".5" k @%zTQMo s (%mxWarng(yyROW),mxERROR)=yyROW_$c(10)_oXoooooo_$c(10)_$g(%mxForma)_" ERROR:_too-many-rows-%mxIndex>"_%mxIndex,%tabRow=0 q
 ... . s %mxIndeQ=%mxIndeQ-1 i %mxIndeQ<0 k @%zTQMo s xxCOL=-1,(%mxWarng(yyROW),mxERROR)=$g(%mxForma)_" ERROR : %mxIndeQ>999999 : Row="_(yyROW\1),%mxIndex=0 q
 ... . i %mxIndex="" s xxCOL=-1,@%zTQMo@(%tabRow=1+yyROW,1)="_~",%1=yyROW\1,%2=+$e($p(yyROW,".",2)_"000000",1,6) d  q
 ... .. k %tabRow1 i %2>1 k @%zTQMo@(yyROW),^oYX(%USID,%mxSheet,%YXy) s %YXy=%YXy-1,%2=%2-1,%insRows=%insRows-1
 ... .. i %2,$d(%mxWeb),$d(^vmxExcel(%USID,%mxForma,".RowHeight")) s @$zr=$p(@$zr,":",1,%1)
 ... . s @oOOiii=oOOqqq s:$d(%mVarsYX) @%mVarsYX@(%YXy,+xxCOL)=oOOqqq 
 ... . i $d(%3mapGlo),%3flag,%oXoOxx1'["_" s %3mapGlo(%noOOooo,%YXy)=$p(oOOqqq,"<mx ")
 ... . s o=$g(@%zTQMo@(yyROW\1+1,1)) s:o="-" o="_"
 ... . i o'["_",%oXoOxx1'["_" d
 ... .. m @%zTQMo@(yyROW+.000001)=@%zTQMo@(yyROW) k @%zTQMo@(yyROW+.000001,1) s %insRows=%insRows+1
 ... .. s %tabRow=$e($p(yyROW,".",2)_"000000",1,6)+1
 ... .. i %tabRow=1 s %tabRow(1)=%YXy d
 ... .. . i oXoooooo_$g(^oRC(%USID,%mxForma,yyROW,%YXx))'[" ;;; " s ^(%YXx)=$g(^(%YXx))_" ;;; s %YX(%YXy,2)="".<mx ic19.-2"" "
 ... s oo=$g(oo) i $g(oFlgLANG),$l(oo) s o=$p(oo,"<mx ") i $l(o)>2 s %=$g(^mxDictio(%LANG,$e(o,1,255))) s:$l(%) o=$p(oo,"<mx ",2),oo=%_$s($l(o):"<mx "_o,1:"")
 ... s @oOOiii=oo s:$d(%mVarsYX) @%mVarsYX@(%YXy,+xxCOL)=oo i $d(%3mapGlo),%3flag,%oXoOxx1'["_" s %3mapGlo(%noOOooo,%YXy)=$p(oo,"<mx ")
 ... q:'$l(oo)
 ... s %=$p(oo,"<mx ") s:$l(%)>511 %=$e(%,1,$s('%zvMSM:31500,1:%zvMSM+509))
 ... s ^oYX(%USID,%mxSheet,%YXy,%YXx)=% s:"o oo"'[%noOOooo ^(%noOOooo)=%
 i $d(%YX),'%insRows s %1=0 f  s %1=$o(%YX(%1)) q:'%1  s %2=0 f  s %2=$o(%YX(%1,%2)) q:'%2  s @%zTQMo@(%1,%2)=%YX(%1,%2),^oYX(%USID,%mxForma,%1,%2)=%YX(%1,%2) k %YX(%1,%2)
 i $d(%mxWeb) s %1=999+$g(%lastTab) d:$e(%mxForma,1,4)'="web_"
 . ;; f %=%YXy:1 q:$g(^oTQMo(%USID,%mxForma,%,1))'["_"  s %YXy=%YXy+1
 . s:'$d(^oYX(%USID,%mxForma,%YXy,2)) ^(2)=%mxForma q:'$d(^vmxExcel(%USID,%mxForma,".RowHeight"))
 . s o=$p($p(@$zr,"*"),":",1,%YXy) s:'$l($p(o,":",%YXy)) $p(o,":",%YXy)=":"
 . f %=%YXy:-1:2 i $p(o,":",%) q:%YXy-%<9  s @$zr=$p(o,":",1,%)_":*"_$s(%YXy-%>%1:%1,1:%YXy-%) q
 i $d(mxERROR) d:$zv["Ca"!($zv["IRIS") ENABLE^%NOJRN  q $g(%YXy)_" mxERROR "_$g(mxERROR)
eErrTQM s:$zv["MiniM" ^mxMonito($g(ooooREAD)+.7,$g(%mxForma)_" ")="eErrTQM" s $ze=""
 s yyPLUSoo=0
 s yyROW="",$zt="TQMe^MXTQM",$ze="" i $d(%2globYX) d
 .f  s yyROW=$o(@%zTQMo@(yyROW)) q:yyROW=""  s:yyROW["." yyPLUSoo=yyPLUSoo+1 d
 .. s y=yyROW\1+yyPLUSoo 
 .. i $d(%2globYX),$d(@%2globYX@(y)) m ^oTQMo2(%USID,%mxForma,y)=@%2globYX@(y)
 .. m ^oTQMo2(%USID,%mxForma,y)=@%zTQMo@(yyROW) 
 .k @%zTQMo m @%zTQMo=^oTQMo2(%USID,%mxForma) 
 ;
TQMe k ^oTQMo2(%USID,%mxForma)
 s $zt="ErrTQM^MXTQM"
 d:$zv["Ca"!($zv["IRIS") ENABLE^%NOJRN 
 q $g(yyROW)
ztRunEnd q
%lX i $d(%lX) m @%zTQMo@(yyROW)=%lX k %lX
 q
lineItog q
oHideRow q
nPLUS(oOOqqq) 
 q "%nPLUS"
xPLUS(oOOqqq) 
 q "%nPLUS"
x3 q
RunX(%startYY,%YXx,oOOqqq00) 
 n yyROW,%1,oo,o,%YXy,oXoooooo,oOOqqq,%YXyMaxm
 s $et="d ErrTQM^MXTQM",%YXyMaxm=$p(oOOqqq00," ",2) s:'%YXyMaxm %YXyMaxm=999999
 s %YXy=%startYY f  s %YXy=$o(@%zTQMo@(%YXy)) q:%YXy>%YXyMaxm!'%YXy  d:$e($g(@%zTQMo@(%YXy,%YXx)))="?"
 .s oOOqqq=$e(^(%YXx),2,999) i "$*._?;:^"[$e(oOOqqq)!oOOqqq q
 .k oo s %1=$p(oOOqqq,";"),%N=$p(%1," "),yyROW=%YXy,oXoooooo=$p(oOOqqq,";",2,999)
 .i " oo %l "'[%N s:%1[" oo "!($l(oXoooooo)<3) oXoooooo="s (oo,@%N)=$g(@%N) "_oXoooooo
 .x oXoooooo
 .s @%zTQMo@(%YXy,%YXx)=$e("'"_$g(oo),1,510) s:$l($g(mxLvarYX)) @mxLvarYX@(%YXy,%YXx)=$g(oo) 
 q ""
RunLine(%startYY,%startXX,startGlo) 
 n %1,%2,oo,o,%YXx,%,%omVars,oXoooooo,%E,%zt s %zt=$zt,$zt="ErrTQM^MXTQM"  ;;$et="d ErrTQM^MXTQM",
 s o=$g(@%zTQMo@(%startYY,%startXX)),%2=$p($p(o," "),":",2,9) i $l(%2) x "s %2="_%2 q:'%2 ""
 i o["$$omQuery" set o=$$trw^UST(o,"| ","/"),%=$p(o,"/") if %["^" s %="^"_$p($p(%,"^",2)," ") d
 . s %="n:000 zr,% s zr=$q("_%_") if $l(zr) s zr=$name(@zr,$ql(zr)-1),%=$$getObj(zr,0)_$$m^MXF  f  s zr=$$getObj(zr,1) q:'$l(zr)  if $$m^MXF"
 . if $l($g(@%zTQMo@(%startYY,%startXX+1)))<9 s @$zr=%
 s %1=$p(o,"/",1,5),%2=$p(o,"/",6,99) i %1["/" d  s o=%1 s:$l(%2) o=o_"/"_%2  
 . f %="/ "," /","  " f  q:%1'[%  s %1=$$trw^UST(%1,%,$s(%["/":"/",1:" "))
 s o=$p(o," ",2,999),%RunName=0
 i o["/" s %RunName=$p(o,"/") s:%RunName="" %RunName=0 k ^mxReestr("RunLine",%USID,%mxForma,%RunName) s ^mxReestr("RunLine",%USID,%mxForma,%RunName,0,0)=o
 i '%startYY s %RunName=%startXX,o=$g(^mxReestr("RunLine",%USID,%startYY,%RunName,0,0)) q:'$l(o) -1_" "_%startYY_" "_%RunName
 s:$zv'["Ca"&($zv'["IRIS") $p(%RunName,"/")=$tr($p(%RunName,"/"),"|") s %=%RunName s:o["/" $p(o,"/")=% ;;  i %,%'["+",$d(^om(%USID,+%)) k ^om(+%,%USID) m ^om(+%,%USID)=^om(%USID)
 k:%'["+"&% ^om(%USID) i $d(^om(%USID)) n %mxPrint
 i $zv["Ca"!($zv["IRIS") x:%["^||om(" "k:%'[""+""&% ^||om(%USID) s %=$d(^||om(%USID))" n:% %mxPrint
 i $l(o)>5 k %om,om,formulaL s om=o,%2=$p(om,"/",2) m:$g(startGlo)'="" ^om(%USID)=@startGlo d
 .f %=2:1:6 s:$e($p(om,"/",%))="@" $p(om,"/",%)=@($e($p(om,"/",%),2,99))
 .s om(2)=$tr($p(om,"/",2,4),"+-")
 .f %=1:1:$l(%2," ") s %omPrint(%)="^om(%USID,"_%_","_$e("o,o,o,o,o,o,o,o,o,o,",1,$l($p(%2," ",%),":")*2-1)_")",%omPrint=%omPrint(1) s:%RunName["^||om(" $p(%omPrint(%),"(")="^||om"
 .f %=1:1:$l(%2," ") s %omPrint(-%)="^om(%USID,"_%_","_$p("-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999",",",1,$l($p(%2," ",%),":"))_")" d
 .. s:%RunName["^||om(" $p(%omPrint(-%),"(")="^||om"
 .s %1=$tr($p(om,"/",3,4),"/:+-","  ")
 .f %=1:1:$l(%1," ") s o=$p(%1," ",%) i $l(o),'o,o'="om" s @o=""
 .s %1=$tr($p(om,"/",2),"/:+-","  ")
 .f %=1:1:$l(%1," ") s o=$p(%1," ",%) i $l(o),'o s:000 @("x"_o)=$g(@("x"_o)) s:$g(@o)="" @o=o_"<mx ic3"
 i '%startYY n mxReestr,%YXy m mxReestr=^mxReestr("RunLine",%USID,%startYY,%RunName) s %YXx=0,%YXy=0
 i '%startYY f  s %YXy=$o(mxReestr(%YXy)) q:'%YXy  s oXoooooo="" f  s %YXx=$o(mxReestr(%YXy,%YXx)) d:%YXx  i '%YXx x oXoooooo q
 .s o=mxReestr(%YXy,%YXx)
 .i $e(o)="{" s xRunLine(%YXy,%YXx)="s %YXx="_%YXx_" "_$p($e(o,2,999)_"}}}}}","}}}}}"),o="x xRunLine("_%YXy_","_%YXx_")"
 .q:$e(o)="?"  f %=1:1:9 q:$e(o)'=" "  s o=$e(o,2,999)
 .f %=1:1:9 q:$e(o,$l(o))'=" "  s o=$e(o,1,$l(o)-1)
 .s oXoooooo=oXoooooo_"  "_o,formulaL(%startYY)=oXoooooo 
 i '%startYY x:$l($g(startGlo)) "k @startGlo m @startGlo=^om(%USID)" q $g(%RunName)
 f %YXx=%startXX+1:1 s o=$g(@%zTQMo@(%startYY,%YXx)) s:$e(o)=";" @$zr="?o ; " q:"?;.(+-='*#@~:/$0123456789"[$e(o)  s o=@$zr,@$zr="?o ; " d
 .s:$d(%RunName)&%RunName'["+" ^mxReestr("RunLine",%USID,%mxForma,%RunName,%startYY,%YXx)=o
 .i $e(o)="{" s xRunLine(%startYY,%YXx)="s %YXx="_%YXx_" "_$p($e(o,2,999)_"}}}}}","}}}}}"),o="x xRunLine("_%startYY_","_%YXx_")"
 .f %=1:1:9 q:$e(o)'=" "  s o=$e(o,2,999)
 .f %=1:1:9 q:$e(o,$l(o))'=" "  s o=$e(o,1,$l(o)-1)
 .s o(%YXx)=o
 s %=0 f  s %=$o(o(%)) q:'%  s:o(%)="x" o(%+1)=""""_$$trw^UST($g(o(%+1)),"""","""""")_"""" d
 .s oXoooooo=$g(oXoooooo)_"  s %YXx="_%_" "_o(%)
 i $d(oXoooooo) s (formulaL(%startYY),formulaL)=oXoooooo,%maxLoom=9999999 x oXoooooo
 s $zt=%zt q ""
ErrTQM n o s:$e($g(%MxEXCEL))'=" " %MxEXCEL="       "_$g(%MxEXCEL) k %3mapGlo
 g:$d(ERRinTQM) TQMe 
 x:$zv["GT" "s o=$ZSTATUS_$c(10)"
 x:$zv'["GT" "s o=$ze_$c(10)"
 s o=$g(%mxForma)_" TQM-ERROR"_"-"_$c(10)_o_" Row="_$g(%YXy)_" Column="_$g(%YXx)_$c(10)_"    %I="_$g(%I)_"  z="_$g(z)_"  %zr="_$g(%zr)_" $zr="_$zr
 s o=o_$c(10)_$g(oXoooooo),o=$tr(o,$c(0),"o"),o=$$trw^UST(o,"<mx","<.mx"),oXoooooo=$$trw^UST($g(oXoooooo),"<mx","<.mx")
 i $g(%YXy),$g(%YXx) s o=$e(o,1,250)_" ... "_$c(10)_(%YXy_-%YXx)_$c(10)_$g(^oTQM(%USID,%mxForma,+%YXy,+%YXx)) d
 . s ^oTQMo(%USID,%mxForma,+%YXy,+%YXx)=$s($zv'["MS":o,1:$e(o,1,500)),%YX(+%YXy,+%YXx)=oXoooooo_" ::: ERROR ::: "_$ze_" <mx ic1.99 __ |o| fc46 fb fs12"
 s ^oErr(%USID,+$g(ooooREAD),+$g(%YXy),+$g(%YXx))=$e($g(oXoooooo),1,510),%mxWarng(+$g(%YXy)_-$g(%YXx))=o,%mxWarng(+$g(%YXy)_-$g(%YXx)_" m-command : ")=$g(oXoooooo)
 s ^("oi")=$e($g(oOOiii),1,510),^("oq")=$e($g(oOOqqq),1,510),^("er")=$e(o,1,510)
 i $l($g(oXoooooo))>3 d
 .s %="QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890",%=$tr(oXoooooo,%)
 .s %=$tr(oXoooooo,%,$e("                                                   ",1,$l(%)))
 .n %n,o f o=1:1:999 s %n=$p(%," ",o) i $l(%n),$e(%n)'="0",'%n,$d(@%n)#2 s ERRinTQM(%n)=$e(@%n,1,510)
 s:$zv["MiniM" ^mxMonito(+$g(ooooREAD),$g(%mxForma)_" ERROR")=o,ooooREAD=$g(ooooREAD)+1000
 s ERRinTQM=o,$ec="" g TQMe
 q
oTQMret(o) 
 q TQMA(o)
TQMA(%TQMreto) ; Return by %MaxRetu byte from the ^oTQMo(%USID,%mxForma) to MX-CLIENT
 n o,oo,yyROW,xxCOL,%yyROWnn,oozoozoQ,oozoozoq,%,%1,%2,%3,%2mapVar,oooTQMAo,%MaxRetu,%z
 s %z="^oTQMret(%USID,%mxForma)" s:$d(@%z)<9 %z="^oTQMo(%USID,%mxForma)" s %z=$name(@%z)
 s (%,%MxEXCEL)=$g(mxConfig("M=EXCEL",%mxForma)),%1=$p(%," "),%2mapVar=$p(%," ",2) s:"^?;*o.M"[$e(%2mapVar) %2mapVar=-9
 s %MaxRetu=27000,%unicode=0 s:$zv["U) " %unicode=16 s:$zv["MS" %MaxRetu=15000
 i %TQMreto<2 s o=$$TQM(1) q:$d(%mxWeb) $o(^oYX(%USID,%mxSheet,999999),-1)_%mxSheet_" $$TQM="_o  s @%z=.1 d
 . i $l($g(flagLANG))>1 s oFlgLANG=flagLANG k:flagLANG[2 ^omxDicti k:flagLANG'["*" flagLANG
 i $g(mxERROR)'="" s o="mxERROR "_$g(%mxForma)_" mxERROR="_mxERROR_"  gotoForm="_$g(gotoForm),%mxWarng("TQMA")=o k mxERROR
 i $g(mxMsgBox)'="" s o="mxERROR "_$g(%mxForma)_" mxMsgBox="_mxMsgBox
 q:'$g(@%z) ""  s $zt=""
 s %MaxRetu=27000,%unicode=0 s:$zv["U) " %unicode=16 s:$zv["MS" %MaxRetu=15000
 s yyROW=$g(@%z),oooTQMAo="",o=$c(4)_$c(5)
 f  s yyROW=$o(@%z@(yyROW)) q:yyROW=""  d  q:xxCOL<0
 . s xxCOL=0,(%,oo)="",%yyROWnn=yyROW\1
 . i '%2mapVar,1_$d(^(yyROW,1)) f  s %=$o(^(%)) q:'$l(%)  s @%2mapVar@(%yyROWnn,%)=$p(^(%),"<mx ")
 . s:yyROW["." %yyROWnn=%yyROWnn_"+"_+$e($p(yyROW,".",2)_"000000",1,6)
 . f  s xxCOL=$o(@%z@(yyROW,xxCOL)) d:xxCOL  q:xxCOL<1  i $e(oozoozoQ)="<",$p(oozoozoQ,"<mx ",2,9)["~~" q
 .. s oozoozoQ=^(xxCOL) i $e(oozoozoQ)="?","$ -"'[$e(oozoozoQ,2) s oozoozoQ=""
 .. i '$l(oozoozoQ),xxCOL>1 q
 .. i $l($g(oFlgLANG))>1,$l(oozoozoQ)>1,$l(oozoozoQ)<255 d  i $d(@%z@(yyROW,xxCOL))
 .. . s oozoozoq=$tr($p(oozoozoQ,"<mx")," 1234567890-+.,") q:'$l(oozoozoq)
 .. . s %=$g(^mxDictio($e(oFlgLANG,1,2),oozoozoq))
 .. . i $l(%) s oozoozoQ=%_$s(oozoozoQ=oozoozoq:"",1:$p(oozoozoQ,"<mx",2,9)) q
 .. . s:oFlgLANG[2 ^omxDicti($e(oFlgLANG,1,2),oozoozoq)=%B i oFlgLANG[3,$e(oozoozoQ)'="?" s oozoozoQ=oozoozoQ_"<mx ic19"
 .. i $l(oo)<10000 s oo=oo_o_%yyROWnn_","_xxCOL_","_$s(%unicode:$$U^MXF(.oozoozoQ),1:oozoozoQ),%yyROWnn=""
 .. else  s:$l(oo)<%MaxRetu oo=oo_o_","_xxCOL_","_$e($s(%unicode:$$U^MXF(.oozoozoQ),1:oozoozoQ),1,2000)
 . i $l(oooTQMAo)+$l(oo)>%MaxRetu d:'$l(oooTQMAo)  s xxCOL=-1,yyROW=yyROW-.00000001 q
 .. n oo,x,maxo f maxo=2000:-100:100,10 s x=0,oo=0 d  q:oo<%MaxRetu 
 ...  f  s x=$o(@%z@(yyROW,x)) q:'x  s:$l(^(x))>(maxo+3) ^(x)=$e(^(x),1,maxo)_"..~" s oo=oo+$l(^(x))+9 
 . s oooTQMAo=oooTQMAo_oo
 s @%z=yyROW
QTQMA q $g(oooTQMAo)
insLine(%n,%x) 
 q:$g(%om(1,%n))=@%n ""  k %om(1) s %om(1,%n)=@%n s:'$d(%x) %x="s @%n=@%n_""<mx _^ fb ic19.999 """ x %x
 i 1_$d(@z@(1)) n % s %=9999 f  s %=$o(^(%)) q:'$l(%)  i %'=%n s @%=""
 s z=z0 q @%n
InsVar6(oo) 
 n ooo,%flaG,%3ooo564,%n9,o q:oo["??" oo    ;; =$$trw^UST(oo,"??","<Q.W.E.S.T>")
 s ooo=$e($p(oo," ",1,6),2,999),oo=$p(oo," ",7,999)
 f %3ooo564=2:2:$l(ooo,"?") s %n9=$p(ooo,"?",%3ooo564) i $l(%n9),$e(%n9)'?1n,$p(ooo,"?",%3ooo564,99)["?" s:$l(%n9," ")>1 ooo=ooo_" "_$p(oo," ",1,$l(%n9)-1),oo=$p(oo," ",$l(%n9),999) d
 . s %n9=$s($tr(%n9,"^%qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890(""),")="":"s %n9=$g("_%n9_")",1:"n oo,ooo s %n9="_%n9) x %n9 s $p(ooo,"?",%3ooo564)=$tr(%n9," ?","__"),%flaG=1
 s:$d(%flaG) ooo=$tr(ooo,"?") k %flaG
 i $l(oo,"?")>2 f %3ooo564=2:2:$l(oo,"?") s %n9=$p(oo,"?",%3ooo564) i $l(%n9),$e(%n9)'?1n,$p(oo,"?",%3ooo564,99)["?" d
 . s %n9=$s($tr(%n9,"^%qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890(""),")="":"s %n9=$g("_%n9_")",1:"n oo,ooo s %n9="_%n9) x %n9 s $p(oo,"?",%3ooo564)=$tr(%n9,"?","_"),%flaG=1
 s:$d(%flaG) oo=$tr(oo,"?")
 s ooo="?"_ooo_" "_oo  ;; s:ooo["<Q.W.E.S.T>" ooo=$$trw^UST(ooo,"<Q.W.E.S.T>","?")
 q ooo
InsVar2(%oooot,%ooooh) 
 ; Insert value of xxxxx?var?xxxxx
 s %ooooh=$g(%ooooh,"?") q:%ooooh="" %oooot
 n %1ooo564,%2ooo564,%ooo564,%maXoo56
 i %oooot["??" q %oooot   ;; s %oooot=$$trw^UST(%oooot,"??","<Q.W.E.S.T>")
 s %maXoo56=$l(%oooot,%ooooh) s:%maXoo56#2=0 %maXoo56=%maXoo56-1 q:%maXoo56<3 %oooot
 s %oooot=%oooot_"ooxxooxxooxx"
 s %2ooo564="%qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890("")"
 f %1ooo564=2:2:$l(%oooot,%ooooh) s %ooo564=$p(%oooot,%ooooh,%1ooo564) i "%1%2"'[%ooo564 d
 . i '%ooo564,"""()0"'[$e(%ooo564),$l(%ooo564)<9!(%ooo564["("),$tr(%ooo564,%2ooo564)="",$e(%ooo564,2,99)'["%" d  q
 .. s $p(%oooot,%ooooh,%1ooo564)=$g(@%ooo564,0)
 . q:").,;*#!~`=<>"[$e(%ooo564)
 . ;; i %ooo564["<Q.W.E.S.T>" s %ooo564=$$trw^UST(%ooo564,"<Q.W.E.S.T>","?")
 . ;; i %ooo564["<S.P.A.C.E>" s %ooo564=$$trw^UST(%ooo564,"<S.P.A.C.E>"," ")
 . x "s %ooo564="_%ooo564
 . s $p(%oooot,%ooooh,%1ooo564)=$tr($tr(%ooo564,"?")," ")
 i %oooot'["?(",%oooot'[")?" q $tr($e(%oooot,1,$l(%oooot)-12),"?")
 f %1ooo564=2:2:$l(%oooot,%ooooh) s %ooo564=$p(%oooot,%ooooh,%1ooo564) i $e(%ooo564)="(",$e(%ooo564,$l(%ooo564))=")" d
 . i $e(%ooo564,2,99)'["%" d  q
 .. s $p(%oooot,%ooooh,%1ooo564)=$g(@%ooo564,0)
 . ;; i %ooo564["<Q.W.E.S.T>" s %ooo564=$$trw^UST(%ooo564,"<Q.W.E.S.T>","?")
 . x "s %ooo564="_%ooo564
 . s $p(%oooot,%ooooh,%1ooo564)=$tr($tr(%ooo564,"?")," ")
 q $tr($e(%oooot,1,$l(%oooot)-12),"?")
oRC(%q,%sheetNa,Y,X) 
 q $$oRC^MXTQM2(%q,%sheetNa,Y,X)
oYX123(%q,%sheetNa,%Y,%X,%mxRange) 
 q $$oYX123^MXTQM2(%q,%sheetNa,%Y,%X,$g(%mxRange))
oYX(%q,%sheetNa,%Y,%X,%mxRange) 
 q:$d(%mxRange) $$oYX^MXTQM2(%q,%sheetNa,%Y,%X,%mxRange)  q $$oYX^MXTQM2(%q,%sheetNa,%Y,%X)
%YXo(q,%sheetNa,Y,X) 
 k:$g(%YXo("S"))'=%sheetNa %YXo s %YXo("S",-1)=$g(%YXo("S")),%YXo("S")=%sheetNa,%YXo("Q")=q
 s %YXo(-3)=$g(%YXo(-2)),%YXo(-2)=$g(%YXo(-1)),%YXo(-1)=$g(%YXo(0)),%YXo(0)=Y_-X
 q q
autoFiYX(%sheetNa,%n) 
 n Y,X,y,x,o,%0,%mxForma s %mxForma=$p(%sheetNa,"--")
 s (Y,oYXy)=oYXy(%sheetNa),oYXx=oYXx(%sheetNa),X=0,%0=$$%0Yrc^MXTQM2(Y) q:'%0 0
 d
 . f X=oYXx:1:255 s o=$g(^oRC(%USID,%mxForma,%Yrc,X)) q:o_" "[("?_"_%n_" ")  i '$o(^(X)) s X=0 q
 . s:X=255 X=0 q:X  s Y=Y+1
 . f X=+oYXx:-1:0 s o=$g(^oRC(%USID,%mxForma,%Yrc,X)) q:o_" "[("?_"_%n_" ")
 q:X Y_-X  q "Y="_Y_"  X="_X_"  %n="_%n_"  oSheetYX="_%sheetNa_"  oYXx="_oYXx_"  oYXy="_oYXy
oRowRead(oSheetYX,%Y) 
 n %mxForma,%1,%Yrc,% s %mxForma=$p(oSheetYX,"--") s:'$g(%Y) %Y=$g(oYXy(oSheetYX)) 
 q:'$$%0Yrc^MXTQM2(%Y) 0  n %x,%n s %x=1
 f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $e(^(%x),1,2)="?_" s %n=$p($e(^(%x),3,99)," ") d
 . i $l(%n),'%n,%n'["*",%n'["%","o oo"'[%n s:$d(^oYX(%USID,oSheetYX,%Y,%x))#2 @%n=$p(^(%x),"<mx ") s:$d(^(%n))#2 @%n=$p(^(%n),"<mx ")
 q %Y
oRowShow(%Y) 
 n %mxForma,%1,%Yrc,% s %mxForma=$p(oSheetYX,"--") s:'$g(%Y) %Y=$g(oYXy(oSheetYX)) 
 q:'$$%0Yrc^MXTQM2(%Y) 0  n %x,%n s %x=0
 f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $e(^(%x),1,2)="?_" s %n=$p($e(^(%x),3,99)," ") d
 . i $l(%n),'%n,%n'["*",%n'["%",$d(@%n)#2 s ^oYX(%USID,oSheetYX,%Y,%x)=@%n i "o oo"'[%n s ^(%n)=@%n,%YX(%Y,%x)=@%n
 q %Y
oYXshowM(oSheetYX) 
 q $$oYXshowM^MXTQM2(oSheetYX)
newRC(%before,%SheetYX) 
 s %SheetYX=$g(%SheetYX,oSheetYX) q $$newRC(%before,%SheetYX)
r999999 f %=999:1:999999 k @%zTQMo@(%)
 s yyROW=-1 q
%YXnn(%node,%tAbleNr) 
 q $$%YXnn^MXTQM2(%node,%tAbleNr)
getObj(%zrO,%di,%000) 
 i $e(%zrO)'="^" q:'$l(%zrO) $g(%mxForma)_" error : getObj^MXTQM : not args(%zrO)"  s:1_$d(^(%zrO)) %zrO=$zr
 s %zr=$name(@%zrO),%objName=$p($e(%zr,2,999),"("),%objLeve=$ql(%zr),%objLeNa=%objLeve_%objName
 i $e(%objName,1,2)="om","omo om0 om1 om2 om3 om4"[%objName q $$getObjom(%zrO,$g(%di))  
 i $e(%objName,1,4)="||om","||om0 ||om1 ||om2 ||om3 ||om4"[%objName q $$getObjom(%zrO,$g(%di))  
 i '$d(mxObjooo(%objLeNa)) s mxObjooo(%objLeNa)="",%59=0 d  s:%59 mxObjooo(%objLeNa)=" "_mxObjooo(%objLeNa)
 . n %x,%1,% s %="%",%1="",%x=0 n:$g(%000)>10 %000
 . f  s %=$o(^mxObjooo(%objName,%objLeve,%)) q:'$l(%)  s %59=%59+1 i %'["%",%'="o",'%,$e(%)'?1n,$e(^(%))'="-" s mxObjooo(%objLeNa,%)="",%1=%1_","_%,%x=%x+1,%59=%59-1 q:%x>125
 . i $l(%1) s mxObjooo(%objLeNa)="s ("_$e(%1,2,99999)_")="""_$g(%000)_"""",%1="" 
 . q:'$l(%)  f  s %=$o(^mxObjooo(%objName,%objLeve,%)) q:'$l(%)  s %59=%59+1 i %'["%",%'="o",'%,$e(%)'?1n,$e(^(%))'="-" s mxObjooo(%objLeNa,%)="",%1=%1_","_%,%x=%x+1,%59=%59-1 q:%x>250
 . i $l(%1) s mxObjooo(%objLeNa)=mxObjooo(%objLeNa)_" s ("_$e(%1,2,99999)_")="""_$g(%000)_"""" 
 s %di=$g(%di),%diNextO=$s($e(%di):1,'%di:0,1:-1),%000=$g(%000)
getObjdi i %diNextO s %59=$o(@%zr,%diNextO) s:$l(%59) %zr=$name(^(%59)) i '$l(%59) d  q:'$l(%59) ""
 . s %=$s(%diNextO>0:$name(@%zr@($c(255)_$c(255))),1:%zr)
 . f  s %=$q(@%,%diNextO) q:'$l(%)  i $ql(%)-1=%objLeve,%zr'=$name(@%,%objLeve) s (%59,%zr)=$name(@%,%objLeve) q
 i %000=11,1_$d(@%zr@(1)) s %="%"_$c(255) x "f  s %=$o(^(%)) q:'$l(%)  s @%=$g(^(%))" q %zr  
 i $l(%di)>4,$l($o(@%zr@(9999))) d  q %zr
 . f %59=2:1:$l(%di," ") s %=$p(%di," ",%59),(%80,@%)=$g(^(%),%000) ;; d:%80=".!."
 ..  s %8o="" x "i $o(^(%,999999)) n i s i=999999 f  s i=$o(^(i)) q:'i  i %B_%8o_%B'[(%B_^(i)_%B) s %8o=$e(%8o_$s($l(%8o):%B,1:"""")_^(i),1,32000)" s @%=%8o i $d(@%zr@(%))  
 x mxObjooo(%objLeNa)
 s %="%"_$c(255) i $d(@%zr@(1))
 f  s %=$o(^(%)) q:'$l(%)  s:$d(mxObjooo(%objLeNa,%)) @%=$g(^(%)) i '$d(mxObjooo(%objLeNa,%)) d  i $d(@%zr@(%))
 . q:$e($g(^mxObjooo(%objName,%objLeve,%)))="-"  s ^(%)="-" q:%
 . q:$tr(%," ^$@~!*#()-+.,&<>_=?:;")'=%!($e(%)?1n)  s ^(%)="",@%=$g(@%zr@(%),%000) k mxObjooo(%objLeNa)
 i %di["%YX" s %="%"_$c(255) f  s %=$o(mxObjooo(%objLeNa,%)) q:'$l(%)  s %YX(%)=@%
 q %zr
getObjom(%zrO,%di) 
 n %i,%,%ii,%zr,%2,i,%qs12  s %zrO=$name(@%zrO),%=$ql(%zrO),%zr=$name(@%zrO@("%ii")),%qs12=$qs(%zr,1)_$qs(%zr,2),%2=$name(@%zr,2)
 i $g(%di) f  s %zr=$q(@%zr,+%di) q:'$l(%zr)  q:$ql(%zr)<(%+1)  q:$qs(%zr,%+1)="%ii"   
 q:'$l(%zr) ""  q:$qs(%zr,1)_$qs(%zr,2)'=%qs12 ""  s %zr=$name(@%zr,%)
 s %="%"_$c(255) f  s %=$o(%om(%2,%)) q:'$l(%)  s @%=""
 s %="%"_$c(255) i $d(@%zr@(%))
 f  s %=$o(^(%)) q:'$l(%)  s @%=^(%),%om(%2,%)="" i @%=".!." s %8o="" x "i $o(^(%,999999)) n i s i=999999 f  s i=$o(^(i)) q:'i  i %B_%8o_%B'[(%B_^(i)_%B) s %8o=$e(%8o_$s($l(%8o):%B,1:"""")_^(i),1,32000)" s @%=%8o i $d(@%zr@(%))  
 ;; f  s %=$o(@%zr@(%)) q:'$l(%)  s @%=@%zr@(%),%om(%2,%)="" i @%=".!." s %8o="" x "i $o(^(%,999999)) n i s i=999999 f  s i=$o(^(i)) q:'i  i %B_%8o_%B'[(%B_^(i)_%B) s %8o=$e(%8o_$s($l(%8o):%B,1:"""")_^(i),1,32000)" s @%=%8o i $d(@%zr@(%))  
 s %ii=$g(@%zr@("%ii")) i $l(%ii) f %=1:1:$l(%ii,",") s %i=$p(%ii,",",%),@%i=$qs(%zr,%+2) s:%B=@%i @%i=%B_"<mx ic15.99"
 q %zr
o2(%zr,i1,i2) 
 s:'$l(i1) i1=$o(@%zr@("")) s i2=$o(@%zr@(i1,i2)) 
 i '$l(i2) s i1=$o(@%zr@(i1)) s:$l(i1) i2=$o(@%zr@(i1,"")) 
 q:'$l(i1)!'$l(i2) "" q:$d(^(i2)) $zr
 q -1
Otkat(%o1,%zr) 
 s:'$d(%zr) %zr=$g(%zrOtkat)
 q $$Otkat^MXTQM2(%o1,%zr)
F9oo() q $$F9oo^MXTQM2()
RUN(%mxFormR) 
 ; Processed %mxForma 
 q $$RUN^MXTQM2(%mxFormR)
getJourn(%1,%2) 
 s:'$d(%1) %1="" s:'$d(%2) %2="%mxForma" n % s %=%1 
 i '%2 f  s %=$o(^mJournal(%),-1) q:'%  i %B_^(%,0)[(%B_%USID_%B),^(0)'["datums",'$p(^(0),%B,2) s %=$p(^(0),%B,2) q
 i %2=1 f  s %=$o(^mJournal(%),-1) q:'%  i %B_^(%,0)[(%B_%USID_%B),$p(^(0),%B,2)=$g(%mxForma) q
 q %
RestVars(%) 
 q 1

MXTQM2^INT^1^65495,42075^0
MXTQM2   ;[ 20190127 21:31:45 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX-technology  ( Virtual Multi-channel EXCEL incorporated into the database )
 ; vmx Copyright(c) 2005-2018, SIA ENTERS, Latvia, Reg.Nr.42102022219
 ; registered by Agency INTELS, Riga, Latvia, reg.40003134156, on June 28, 2005, Nr.178
 ;
RUN(%mxFormR) ; Processed %mxFormF from %mxForma 
 i $g(%mxForma)=%mxFormR q "recursiv"
 i '$d(^oRC(%USID,%mxFormR)) s (o,%mxWarng("RUN^MXTQM2("_%mxFormR))="  -- not exists "_$name(^oRC(%USID,%mxFormR)) q o
 n %mxForma,%mxSheet,%YX,%mxWeb,o,%,%oRChange
 s (%mxForma,%mxSheet)=%mxFormR,%mxWeb=1 ;; k ^oTQMo(%USID,%mxForma)
 i $$TQM^MXTQM(1)
 q 1_%mxFormR_"-ok."
F9oo() 
 q:'$g(%YXx) ""  q:$g(%mxForma)="" ""  n %zr s %zr=$zr
 n oo,t,%,o s oo="" i $d(^ceChange(%USID,%mxForma,%YXx)) d
 . s t=%B_$d(^(%YXx,1)) f o=1:1:9999 s t=$o(^(t),-1) q:t=""  i $p(t,"r",2)=%YXy s oo=^(t) q 
 i $l(oo) s ^($h*1000000_"r"_%YXy)=oo q:1_$d(@%zr) oo
 s %="" f  s %=$o(^ceChange(%)) q:%=""  i $d(^ceChange(%,%mxForma,%YXx)) d
 . s t=%B_$d(^(%YXx,1)) f o=1:1:9999 s t=$o(^(t),-1) q:t=""  i $p(t,"r",2)=%YXy s oo=^(t) q 
 i $l(oo) s ^($h*1000000_"r"_%YXy)=oo
 q:1_$d(@%zr) $$U^MXF(oo)
%0Yrc(y) n %
 s %Yrc=$g(^oYX(%USID,%mxForma,+y,0)),%=$p(%Yrc,"-",2) i % s %Yrc=%Yrc-%+1 q +%
 s %=+$e($p(%Yrc,".",2)_"000000",1,6),%Yrc=%Yrc\1 q:% %+1  s %=+$e($p($g(^oYX(%USID,%mxForma,1+y,0)),".",2)_"000000",1,6)  
 q +%
%0Yvar(y,x) 
 i $$%0Yrc(y) 
 i $e($g(^oRC(%USID,%mxForma,+y,+x)),1,2)["?_" q $tr($p($g(^oRC(%USID,%mxForma,+y,+x))," "),"?_")
 q $tr($p($g(^oRC(%USID,%mxForma,+%Yrc,+x))," "),"?_")
oYXshowM(%mxSheet) 
 n %mxForma,%Yrco,%,%1,%2,%3,%y,%x,%0,%n,%nn,yxq s %mxForma=$p(%mxSheet,"--")
 s %=$g(mxConfig("M=EXCEL",%mxForma)) s:'$l(%) %=$g(^oRC(%USID,%mxForma,"?$$TQM",1))
 s %1=$p(%," "),%2=$p(%," ",2),%3=$p(%," ",3) s:$l($g(%E)) (%,%1,%2,%3)="" s:"o."[%2 %2="" s yxq="" s:$e(%1)'="^" %1=""
 f o=2:1:9 s %n=$p($tr(%3,"()",",,"),",",o) q:'$l(%n)  i $g(@%n)="" s %3="" q 
 s o=9999999 f  s o=$o(%YX(o)) q:'$l(o)   d:'o
 . s %=$g(^oRC(%USID,%mxForma,o)) s:'% %=$g(^oRC(%USID,%mxForma,"?var",o)) 
 . i % s %YX(+%,+$p(%,"-",2))=%YX(o) s:$p(%YX(o),"<mx ")'="." (^oYX(%USID,%mxSheet,+%,+$p(%,"-",2)),@o)=$p(%YX(o),"<mx ") k %YX(o) q
 . s %y=+$g(%YXy),%0=$$%0Yrc(%y) i '%0 k %YX(o) q
 . s %x=1 
 . f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  s %=$g(^(%x)) i $p($e(%,3,99)," ")=o s %YX(%y,%x)=%YX(o) s:$p(%YX(o),"<mx ")'="." (^oYX(%USID,%mxSheet,%y,o),^(%x))=$p(%YX(o),"<mx ") k %YX(o) q
 ;
 s %y=0 f  s %y=$o(%YX(%y)) q:'%y   s o=9999999 f  s o=$o(%YX(%y,o)) q:'$l(o)  d:'o
 .s %=$g(^oRC(%USID,%mxForma,o)) s:'% %=$g(^oRC(%USID,%mxForma,"?var",o)) i % s %YX(+%,+$p(%,"-",2))=%YX(%y,o) k %YX(%y,o) q
 .s %0=$$%0Yrc(%y) i '%0 k %YX(%y,o) q
 .s %x=1 
 .f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $p($e($g(^(%x)),3,99)," ")=o s %=$p(%YX(%y,o),"<mx ") s:%'="." (^oYX(%USID,%mxSheet,%y,o),^(%x))=% s %YX(%y,%x)=%YX(%y,o) k %YX(%y,o) q
 ;
 s %y=0 f  s %y=$o(%YX(%y)) q:'%y  i $l(yxq)<9999 s %x=0,%0=$$%0Yrc(%y) f  s %x=$o(%YX(%y,%x)) q:'%x  d
 . s (%n,%nn)=$g(^oRC(%USID,%mxForma,%Yrc,%x)) s:$e(%n)'="?" %n=""
 . s yxq=yxq_%y_";"_%x_";"_%YX(%y,%x)_$c(4),%=$p(%YX(%y,%x),"<mx ") i $l(%)>511,$zv["MS" s %=$e(%,1,511) 
 . k %YX(%y,%x) s %n=$p($e(%n,2,99)," ") s:$e(%n)="_" %n=$e(%n,2,99)
 .  q:".@$*"[$e(%n)!%n  q:" %q %n % %1 %2 o oo %Y %X %q %y %x "[(" "_%n_" ")  q:%="."  i $e(%n)'="%",$g(%YXy)=%y s @%n=%
 .  s (^oYX(%USID,%mxSheet,%y*''%0,%n),^oYX(%USID,%mxSheet,%y,%x))=% q:$p(%nn,";")["-"  
 .  i $e(%)'="?" s:$l(%1)&'%1 @%1@(%y,%x)=% s:$l(%2)&'%2 @%2@(%y,%x)=%
 .  q:'$l(%3)  i %3[%n q:","_$tr($p(%3,"(",2,9),")",",")[(","_%n_",")
 .  i '%0,123'[%2 s @%3@(%n)=% q
 .  i %0>0 s:123'[%2&$d(@%3@(%n,%0)) @%3@(%n,%0)=% s:%2>0&$d(@%3@(%n)) @%3@(%n)=%
 ;
 q $$U^MXF(yxq)
newRC(%before,%SheetYX) 
 n o,%yy,%xx,%n,%,%1,%2,%y,%33,%newVars,%mxForma s %newVars="%",%SheetYX=$g(%SheetYX,oSheetYX),%mxForma=$p(%SheetYX,"--")
 ;; s %=$g(mxConfig("M=EXCEL",%mxForma)),%33=$p(%," ",3),%3=$g(%3,%33)
 s %yy=0 f  s %yy=$o(^oRC(%USID,%mxForma,%yy)) q:'%yy  s %xx=0 d
 . f  s %xx=$o(^oRC(%USID,%mxForma,%yy,%xx)) q:'%xx  s %=$p($g(^(%xx))," ") i $e(%)="?" d
 .. s %n=$tr($e($p(%," "),2,99),"_?") q:".@$*0%"[$e(%n)  q:"ooo"[%n!%n
 .. s:" "_%before_" "'[(" "_%n_" ") %newVars=%newVars_","_%n
 q %newVars
Otkat(%o1,%zr) 
 s:'$d(%zr) %zr=$g(%zrOtkat)  q:$g(%E)'="" 0
 q:%zr'["^" "" n %,%i,o,h,%zt ;;f %=$ql(%zr):-1:1 s %i=$qs(%zr,%) i %i="" s %zr="" q
 s %zt=$zt,$zt="OtkatE^MXTQM2",%zr=$name(@%zr)
 q:$h*100000+$p($h,",",2)-2<$g(^bJournal(%USID,%zr)) ""
 i %o1="0" s ^bJournal(%USID,%zr)=$h*100000+$p($h,",",2),h=$$pD^MXD($h,2)
 i %o1="0",$d(@%zr) d  q:o "" m ^bJournal(%USID,%zr,h)=@%zr s o=1 f  s o=$o(^bJournal(%USID,%zr,o)) q:'o  i o+999<h k ^bJournal(%USID,%zr,o)
 . s o=$o(^bJournal(%USID,%zr,h),-1) q:'o 
 . i $l($$nodeComp^MXF($name(^bJournal(%USID,%zr,o)),%zr,1)) s o=0 
 . ;;f  s %z=$q(@%z) s:$l(%r) %r=$q(@%r) q:'$l(%r_%z)  s:'$l(%z)!'$l(%r) o=0 q:'o  i @%z'=@%r s o=0 q 
 n %1 s %1="{1042}{1077}{1088}{1085}{1091}{1090}{1100} {1074} {1089}{1086}{1089}{1090}{1086}{1103}{1085}{1080}{1077} {1085}{1072}"
 s %1=%1_" {1091}{1082}{1072}{1079}{1072}{1085}{1085}{1099}{1081} {1084}{1086}{1084}{1077}{1085}{1090} {1074}{1088}{1077}{1084}{1077}{1085}{1080}:"
 i %o1="s" k %SEL s o=0 f  s o=$o(^bJournal(%USID,%zr,o)) q:'$l(o)  s %SEL("R")="",%SEL(0)=%1,%SEL(o)=$$nodeComp^MXF($name(^bJournal(%USID,%zr,o)),%zr,200) d 
 . s %=0 f  s %=$o(%SEL(%)) q:%=o  i %SEL(%)=%SEL(o) k ^bJournal(%USID,%zr,%),%SEL(%) 
 . ;;
 . ;;f  s %z=$q(@%z) q:%z=""  s %r="%r"_$e(%z,3,99) i @%z'=$g(@%r) s %=$ql(%z),%SEL(o)=$e($g(%SEL(o))_"  "_%B_$qs(%z,%)_"="_@%z,1,250)
 i %o1 k @%zr m @%zr=^bJournal(%USID,%zr,%o1) s ^bJournal(%USID,%zr)=$h*100000+$p($h,",",2)
 q ""
OtkatE s $zt=$g(%zt) q ""
oRC(%q,%sheetNa,Y,X) 
 n %0,%,%oldCell,oCeValue,%qoo s oCeValue=%q,%qoo=11 i $l(%q)>1 s %qoo=$e(%q,$l(%q)-1,$l(%q))
 i %qoo=".." s %qSearch=$p(%q,"..") i $l(%qSearch) s %YXy=Y,%YXx=X,%qSelect=%q,%ySearch=Y,%xSearch=X,%YX("qSearch")=%q q %q
 i $d(^oYXselec(%USID,%sheetNa,Y,X)) s %oldCell=^(X) 
 k oRCerr,gotoYXyy,gotoYXxx s %YXsheet=%sheetNa n %mxSheet,%mxForma s %mxSheet=%sheetNa,%mxForma=$p(%mxSheet,"--")
 ;; n $et s $et="s %E=$ze_$c(10)_$g(%in),$ec="""" "
 n %in,%y,%x,%nn,%nALoooo,%N,%nNext,gotoName,%shin,%Xcomm,%E,o,%2,%3,%3flag s %shin=$p(%sheetNa,"--")
 s (%0,%nn,%tabRow)=$$%0Yrc(Y) s:$e($g(^oRC(%USID,%mxForma,Y,X)),1,2)["?_" %Yrc=Y
 s %in=$g(^oRC(%USID,%mxForma,%Yrc,X))
 i $e(%in,1,3)="?_*" f %=+X:-1:2 i $e($g(^(%)),1,2)="?_",$e(^(%),1,3)'["*" s %in=^(%) q
 q:'%0 "" i %q'="---" q:$e(%in,1,2)'="?_" ""    ;; only for %0>0 (mx-tabel)
 f %=X+11:-1:0 i $e($g(^(%)),1,2)="?_",$p(^(%)," ; ")["[" q
 q:'% ""
 i %q="-",$e(%in,1,2)'="?_"!($e(%in,1,10)="?_%mxIndex"),$g(^oRC(%USID,%mxForma,%Yrc,X+1))["?_" d  q ""
 . s o=$p(%in,";-;",2,99) i $l(o)>3 s %YX(Y,X)="<mx <$$B 30 12 o[--- . 5/2 "_o_"  s %YX("_+Y_","_+X_")="".<mx ic46.99"" ; %YX /$$B> ic19.99",gotoYXxx=X-1 q
 . s %YX(Y,X)="<mx <$$B 30 12 o[--- . 1/2 k %E s o=$$oRC^MXTQM2(""---"","""_%sheetNa_""","_Y_","_(X+1)_") ; %YX /$$B> ic19.99",gotoYXxx=X-1
 i %q'="---" q:$e(%in,1,10)="?_%mxIndex" ""
 s:";;.."'[%qoo ^oYX(%USID,%mxSheet,Y,X)=%q s gotoYXyy=Y,gotoYXxx=X+1,oRCyyyyy=Y,oRCxxxxx=X
 ;; %Yrc ;;  i %in[";_",%0<Y f %=+Y:-1:+%0 i $e($g(^oRC(%USID,%mxForma,%,X)),1,2)="?_" s %in=^(X) q
 ;; i $e(%in,1,3)="?_*" f %x=+X:-1:2 i $e($g(^(%x)),1,2)="?_",$e(^(%x),1,3)'["*" s %in=^(%x) q
 s (%command,%Xcomm)=$p(%in,";;;",2,9),(%n,%N,%nALoooo)=$p($e(%in,3,99)," "),oRCerr=Y_-X_" "_%nALoooo_" "_%Xcomm
 i " o %1 %2 Y X y x %y %x "[%n s (%n,%nALoooo)=%n_"o1o2o3" n @%n s @%n=""  ;; =$g(@%n)
 i %q="" s %=0 i $p(%in,";")'[" [",$g(%YXy(-1))-Y f %=X-1:-1:2,-99.65 q:$l($g(^oYX(%USID,%mxSheet,Y,%)))
 i %q="",%<0 q ""
 i %q="",$p(%in,";")["^",Y>1 s %q=$p($g(^oYX(%USID,%mxSheet,Y-1,X)),"<mx ") i $p(%in,";")["^+1" d  s:% %q=%q+1
 . f %=X-1:-1:2 i $g(^oYX(%USID,%mxSheet,Y-1,%))'=$g(^oYX(%USID,%mxSheet,Y,%)) s %q=1,%=0 q
 i %qoo=";;",%Xcomm'["%SEL",$l($g(%FILE)),$d(^AL(%FILE)) d  q:$d(%SEL) "%SEL:%E:"_%q
 . n %K,%G,%N,% s %K=%q,%N=%nALoooo,%G(%N)="" k %SEL
 . s o=$$mxFsel^USF(%FILE,%nALoooo,%q,1) m:'$d(%SEL) %SEL=^ose(%USID)
 i %qoo=";;",%Xcomm'["%SEL",%Xcomm'["%SEL" d  q:$d(%SEL) "%SEL:%E:"_%q
 . n %N s %N=%nALoooo,%=$g(ALanalog(%N))
 . i $l(%) s %N=$p(%,"^"),%=$p(%,"^",2) s:$l(%) %FILE=% d  q:$d(%SEL)
 .. n %K,%G,% s %K=%q,%G(%N)="" k %SEL
 .. s o=$$mxFsel^USF(%FILE,%N,%q,1) m:'$d(%SEL) %SEL=^ose(%USID) 
 . s %="" f  s %=$o(^AL(%)) q:%=""  i $d(@("^"_%)),$g(^AL(%,"%W",%nALoooo,-2))["$$" d  q:$d(%SEL)
 .. n %K,%FILE,%G s %FILE=%,%K=%q,%G(%N)="" k %SEL n %
 .. s o=$$mxFsel^USF(%FILE,%N,%q,1) m:'$d(%SEL) %SEL=^ose(%USID) 
 i %q'["---",%Xcomm["%SEL" x "n %1,%2,%3,%0,o,%N,%K s (%K,o)=%q,%E="""",%N=%nALoooo "_%Xcomm i %E'="",$e(%E,1,4)'="%SEL" s @%nALoooo=$g(%oldCell) q %E_" -- not found --:%E:"_%q
 i %Xcomm["%SEL" q:$d(%SEL) "%SEL:%E:"_%q 
 s:%q="--"!(%q="__") %Xcomm="",%q="--"
 i %q="--" s gotoYXyy=0,gotoYXxx=0,%1=1,%YX(Y,X)="" d  q:gotoYXyy ":%E:"_%q  s %1=0 d  q ":%E:"_%q
 . n %0,%Yrc i %1 f %1=%YXy+1:1 s %0=$$%0Yrc(%1) i '%0 s %1=%Yrc-.2 q
 . f  s %1=$o(^oRC(%USID,%mxForma,%1)) q:'%1  s %2=1 f  s %2=$o(^oRC(%USID,%mxForma,%1,%2)) q:'%2  d
 .. s %=^(%2) q:$e(%)'="?"  q:".^*$ "[$e(%,2)
 .. i %[" ;;; " s gotoYXyy=%1,gotoYXxx=%2,%2="e",%1="e"
 i %q="~",%Xcomm'["~" s gotoYXyy=Y_"]",%Xcomm="",%=$o(^oYX(%USID,%mxSheet,Y,X,""),-1) i %,^(%)'="~" s %YX(Y,X)="~"_^(%)_"<mx ic9.99" x $g(^oRC(%USID,%mxForma,%Yrc,"~"))
 s %nn=%0,%rowEmpty='$l(%q) i %q'="---","..;;"'[%qoo s @%nALoooo=%q
 s %=$g(mxConfig("M=EXCEL",%shin)),%2=$p(%," ",2),%3=$p(%," ",3),%1=$p(%," ") s:$l($g(%E)) (%,%1,%2,%3)="" s:"o."[%2 %2=-9
 i $l(%3),%q'["---" s o=$tr(%3,"()",",,") f %=2:1 s %x=$p(o,",",%) q:'$l(%x)  s:%x=%nALoooo!'$l($g(@%x))!(";;.."[%qoo) %3=""
 i %q["---",%Xcomm'["=""---""",$l(%3) s (%command,%Xcomm)=""
 i $g(%YXy(-1))-Y,%q'["---",'$l(%3)!%2 s %x=1 f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i %x-X s %=$g(^(%x)) i $e(%,1,2)="?_" s %=$e($p(%," "),3,99) d
 . q:"   %nn %mxIndex Y X %y %x o oo * ^ "[(" "_%_" ")  q:%=%nALoooo
 . s:$d(^oYX(%USID,%mxSheet,Y,%x))#2 @%=$p(^(%x),"<mx ") s:$d(^(%))#2 @%=$p(^(%),"<mx ") s:$l(@%) %rowEmpty=0 
 . i "123"'[%2 i %q="~",%Xcomm'["~" s (@%@(%0),^oYX(%USID,%mxSheet,Y,%x),@%)="~"_@%  ;; -oRC()
 k oo i ";;.."[%qoo,%Xcomm'[%qoo q:%Xcomm="" "" q %q
 s %E="" i %q="----" s %in="]"_%in,%Xcomm=""
 ;
 i %q'["---",$l(%Xcomm)>2,'%Xcomm x "n %1,%2,%3,%0,o,%N,%q,%K s (%K,o)=$g(@%nALoooo),%E="""",%N=%nALoooo "_%Xcomm i %E'="",$e(%E,1,4)'="%SEL" s @%nALoooo=$g(%oldCell)
 ;
 s:%tabRow (%nn,%0)=+%tabRow s Y=oRCyyyyy,X=oRCxxxxx  ;; -oRC()
 i $d(oo) s %YX(Y,X)=oo i ";;.."[%qoo,$l(oo)>1,";;.."[$e(oo,$l(oo)-1,$l(oo)) q oo 
 q:%nALoooo["o1o2o3"!($e(%E,1,4)="%SEL") $g(%E)_":%E:"_$g(@%nALoooo)
 i %q'["---","..;;"'[%qoo s ^oYX(%USID,%mxSheet,Y,X)=%q s:"o oo"'[%nALoooo ^(%nALoooo)=%q
 i $l(%1),"M"'=%1,"o oo"'[%1,'%1 s @%1@(Y,X)=$p(@%nALoooo,"<mx ")
 i 123'[%2 s:'%2 @%2@(Y,X)=$p(@%nALoooo,"<mx ") s:000 @%n@(%0)=$p(@%nALoooo,"<mx ")  ;; -oRC()
 i %q="---" n %nx,%n,%x,%mxI s %x=1,%mxI="" d  q ":%E:---"
 .f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  s %nx=$g(^(%x)) i $e(%nx,1,2)="?_" d  q:$p(%nx,";")["]"
 .. s %n=$e($p(%nx," "),3,99) s:%n["%mxIndex" %mxI=%nx q:"   %nn Y X %y %x o %nx %n * . $ "[(" "_%n_" ")
 .. s @%n=$g(^oYX(%USID,%mxSheet,Y,%n)) i $l(%mxI) x $p(%mxI,";;;",2,99) i %mxI[";-;" s $p(mxI,";-;")=""
 .. i $p(%nx,";")["]" x "n %1,%2,%3,%x,%y,%nx "_$p(%mxI,";-;",2) i %2>0 k:$l(%3) @%3
 .. i %x'<X s %YX(Y,%x)=".<mx ic3" k:$l(%3) @%3@(%n,%0)  ;; -oYX()
 i $l($g(gotoName)) s autoFill="",gotoYXyy=oRCyyyyy,%x=1 d
 . f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $tr($p(^(%x)," "),"?_")=gotoName s gotoYXxx=-%x q
 i $p(%in,";")_gotoYXyy["]" s:$g(gotoYXxx)'<0 gotoYXyy=gotoYXyy+1,gotoYXxx=2 i $l(%3)!111,%q'="---" d:%0
 . n %n f %x=+X:-1:2 s o=$g(^oRC(%USID,%mxForma,%Yrc,%x)) i $e(o,1,2)="?_" d  i $p(o,";")["[" s:$g(gotoYXxx)'<0 gotoYXxx=%x q
 .. q:$p(o,";")[" -"  s %n=$e($p(o," "),3,99) q:"0oo..;?"[%n!%n   
 .. i %sheetNa'[%mxForma n %mxForma s %mxForma=$p(%sheetNa,"--")
 .. ;; i $d(%mxInput(%mxForma)) s %3=$name(@%3) s:%mxInput(%mxForma)=%n %mxInput(%mxForma)=%3 i %mxInput(%mxForma)'=%3 s %E=$g(%E)_"___  access denied "_%3 q
 .. i $l(%3) s:123'[%2 @%3@(%n,%0)=$p($g(@%n),"<mx ") s:%2>0 @%3@(%n)=$p($g(@%n),"<mx ")
 i gotoYXxx>-2,$p(%in,";")'["]",%q'="~"!(%Xcomm["~"),%q'="---" d:$g(^oRC(%USID,%mxForma,%Yrc,1))["_"
 . i gotoYXxx>-1 s %x=X f  s %x=$o(^(%x)) q:'%x  i $e(^(%x),1,2)="?_" s gotoYXxx=%x q
 . i gotoYXxx=-1 s %x=1 f  s %x=$o(^(%x)) q:'%x  s %=$p(^(%x),";") i $e(%,1,2)="?_",%[" [" s gotoYXxx=%x q
 s:gotoYXxx<0 gotoYXxx=-gotoYXxx s:gotoYXyy<0 gotoYXyy=-gotoYXyy 
 q:%nALoooo["o1o2o3" $g(%E)_":%E:"_@%nALoooo
 s %=$p(@%nALoooo,"<mx ")
 s:"o oo"'[%nALoooo (^oYX(%USID,%mxSheet,%nALoooo),^(%nALoooo,%nn),^oYX(%USID,%mxSheet,Y,X),^(%nALoooo),^oYX(%USID,%mxSheet,0,%nALoooo))=%
 s:"o oo"[%nALoooo ^oYX(%USID,%mxSheet,Y,X)=%
 ;; s oRC(Y,X)=%in,(oYX(Y,X),oYX(%nALoooo),oYX(%nALoooo,%nn))=% ;; -oRC()
 i $l($g(%E)) s %E=%E_" :%N="_%nALoooo
 q $$U^MXF($g(%E)_":%E:"_@%nALoooo)
oYX123(%q,%sheetNa,%Y,%X,%mxRange) 
 q:$g(%E)'="" 0 n %mxSheet,%mxForma s %mxSheet=%sheetNa,%mxForma=$p(%mxSheet,"--")  n %qMSM i %q["..",$e(%q,$l(%q)-1,99)=".." q ".."
 s %qMSM=$p(%q,"<mx ") i $zv["MS" s:$l(%qMSM)>511 %qMSM=$e(%qMSM,1,511)
 s ^oYX(%USID,%mxSheet,%Y,%X)=%qMSM,oYX(%Y,%X)=%q
 n %,%n,%1,%2,%3 s %=$g(mxConfig("M=EXCEL",%mxForma)),%1=$p(%," "),%2=$p(%," ",2),%3=$p(%," ",3) s:$l($g(%E)) (%,%1,%2,%3)="" s:"o."[%2 %2=-9
 i '%2,$e(%qMSM)'="?" s @%2@(%Y,%X)=%qMSM
 i $l(%1),"M"'=%1,"o"'=%1,'%1 s @%1@(%Y,%X)=%qMSM 
 q:'$l(%3) %1_" "_%2
 s %0=$$%0Yrc(%Y),%=$g(^oRC(%USID,%mxForma,%Yrc,%X))
 s:$p(%,";")["-" %3="" s %=$p(%," ")
 i $e(%)="?",$l(%3) s %n=$tr($p(%," "),"_?") i "@$.*0"'[$e(%n),'%n d
 .  q:" %q %n % %1 %2 o oo %Y %X %q "[(" "_%n_" ")
 .  i %3[%n,","_$tr($p(%3,"(",2,9),")",",")[(","_%n_",") s @%n=%q q
 .  ;;i $p(%sheetNa,"--")'=%mxForma n %mxForma s %mxForma=$p(%sheetNa,"--")
 .  i $d(%mxInput(%mxSheet)) d  i %mxInput(%mxSheet)'=%3 q
 ..  s %3=$name(@%3) s:%mxInput(%mxSheet)=%n %mxInput(%mxSheet)=%3 i %mxInput(%mxSheet)'=%3 s:%'["_" %mxInput(%mxSheet,%3,%n)=%q q
 .  n %1 s %1=999 f  s %1=$o(%mxInput(%mxSheet,%3,%1)) q:%1=""  s @%3@(%1)=%mxInput(%mxSheet,%3,%1) k %mxInput(%mxSheet,%3,%1)
 .  s:%["_" ^oYX(%USID,%mxSheet,%Y,%n)=%qMSM s:%'["_" ^oYX(%USID,%mxSheet,0,%n)=%qMSM
 .  i %'["_" q:%2>0  s %=$g(@%3@(%n)),^oldGlobs(%USID,%mxSheet,%n)=$zr_"="_%,@%3@(%n)=%qMSM q
 .  i %0 s:123'[%2 @%3@(%n,%0)=%qMSM s:%2>0 @%3@(%n)=%qMSM 
 q:$zv'["U) " "1="_%1_" 2="_%2_" 3="_%3_" (%0,%tabRow)="_%0_" mComm="_%_" $zr="_$zr
 q $$U^MXF("1="_%1_" 2="_%2_" 3="_%3_" (%0,%tabRow)="_%0_" mComm="_%_" $zr="_$zr)
oYX(%q,%sheetNa,%Y,%X,%mxRange) 
 ; select or change 
 s %mxSheet=%sheetNa i %q["..",$e(%q,$l(%q)-1,99)=".." q ".."
 i %Y>0,1_$$%YXo^MXTQM(%q,%sheetNa,%Y,%X) s oYXy=%Y,oYXx=%X,oYXy(%sheetNa)=%Y,oYXx(%sheetNa)=%X,oYXq=%q
 n %qMSM,%,%123,%1,%2,%3,%0,%n,%nn,%nFormul,%11
 s oSheetYX(-1)=$g(oSheetYX),oSheetYX=$p(%sheetNa,"--"),%qMSM=$p(%q,"<mx ") q:'%Y
 i %Y>0,%Y-$g(%YXy)!(%X-$g(%YXx)) d  s oYXy=%Y,oYXx=%X,oYXy(%sheetNa)=%Y,oYXx(%sheetNa)=%X,oYXq=%q
 . s:'$g(%YXy) %YXy=%Y s:'$g(%YXx) %YXx=%X
 . s %YXy(-2)=$g(%YXy(-1)),%YXy(-1)=$g(%YXy),%YXx(-1)=$g(%YXx),%YXx(-1)=$g(%YXx),%YXy=%Y,%YXx=%X,%YXq(-2)=$g(%YXq(-1)),%YXq(-1)=$g(%YXq),%YXq=%q
 . s oYXy(-2)=$g(oYXy(-1)),oYXy(-1)=$g(oYXy),oYXx(-1)=$g(oYXx),oYXq(-2)=$g(oYXq(-1)),oYXq(-1)=$g(oYXq)
 i $zv["MS" s:$l(%qMSM)>511 %qMSM=$e(%qMSM,1,511)
 s %123=$g(mxConfig("M=EXCEL",oSheetYX)),%1=$p(%123," ",1),%2=$p(%123," ",2),%3=$p(%123," ",3) s:$l($g(%E)) (%123,%1,%2,%3)="" s:"o."[%2 %2=-9
 i %Y>0 s (%tabRow,%0)=$$%0Yrc(%Y),%n=$g(^oRC(%USID,%mxForma,%Yrc,%X)) s:$e(%n)'="?"!("$. ?%1234567890^-=*@!+"[$e(%n,2)) %n="" s %nFormul=%n,%n=$tr($p(%n," "),"?_")
 i %Y<0 s ^oYX(%USID,%mxSheet,-%Y,%X)=%qMSM s:$l(%1)&("oM"'[%1)&'%1 @%1@(-%Y,%X)=%qMSM q "" 
 s ^oYX(%USID,%mxSheet,%Y,%X)=%qMSM i $l(%n),"o oo"'[%n s ^(%n)=%qMSM s:'%0 ^oYX(%USID,%mxSheet,0,%n)=%qMSM
 s %11=$o(^oYX(%USID,%mxSheet,%Y,%X,""),-1) s:'%11 ^($h*100000+$p($h,",",2))=%qMSM i %11>0,%q'=^(%11),"~ -- _ __"'[%q s ^($h*100000+$p($h,",",2))=%qMSM
 s:$e(%1)'="^" %1="" s:$l(%1) @%1@(oYXy,oYXx)=%qMSM
 i '%2,$e(%qMSM)'="?",$p(%nFormul,";")_" "'[" - " s @%2@(%Y,%X)=%qMSM
 s o="" f %nn="%YXy","%YXx","%YXq" s o=o_%nn_0_"="_$g(@%nn)_$c(4) f %=1,2 s o=o_%nn_%_"="_$g(@%nn@(-%))_$c(4)
 s %0=+%tabRow
 q:'$l(%n) o_$c(4)_" %mxFormula="_%nFormul   s:$p(%nFormul,";")_" "[" - " %3="" s %=$p(%nFormul," ")  q:'$l(%) o_$c(4)_" %mxFormula="_%nFormul  
 i $d(^oRC(%USID,%mxForma)) s o=o_" oRC0="_$p($e(%nFormul,1,25)," ")_$c(4) i $g(%YXy(-1)),$g(%YXx(-1)) d
 . n %0,% s %0=$$%0Yrc(%YXy(-1)),%=$p($g(^oRC(%USID,%mxForma,%Yrc,%YXx(-1)))," "),o=o_" oRC1="_$p($e(%,1,25)," ")
 i $l(%3) i "@$.*0"'[$e(%n),'%n d
 .  q:" %q %n % %1 %2 o oo %Y %X %q "[(" "_%n_" ")
 .  i %3[%n,","_$tr($p(%3,"(",2,9),")",",")[(","_%n_",") s @%n=%q q
 .  q:%0  q:%2>0  q:$p(%nFormul," ")["_"  q:$g(@%3@(%n))=%qMSM
 .  ;;i %sheetNa'[%mxForma n %mxForma s %mxForma=$p(%mxSheet,"--")
 .  i '$d(%mxInput(%mxSheet)) s %=$g(@%3@(%n)),^oldGlobs(%USID,%mxSheet,%n)=$zr_"="_%,@%3@(%n)=%qMSM q
 .  s %3=$name(@%3) s:%mxInput(%mxSheet)=%n %mxInput(%mxSheet)=%3 i %mxInput(%mxSheet)'=%3 s o=o_" input denied -->> "_$g(@%3@(%n))_" <<-- "_%q_$c(4),%mxInput(%mxSheet,%3,%n)=%q q
 .  i $d(%mxInput(%mxSheet,%3)) s %=99 f  s %=$o(%mxInput(%mxSheet,%3,%)) q:%=""  s @%3@(%)=%mxInput(%mxSheet,%3,%) k %mxInput(%mxSheet,%3,%)
 .  s %=$g(@%3@(%n)),^oldGlobs(%USID,%mxSheet,%n)=$zr_"="_%,@%3@(%n)=%qMSM
 q:'$d(%mxRange) o_$c(4)_" %mxFormula="_%nFormul 
 q:%mxRange=%q!'$l(%1_%2) o_$c(4)_" %mxFormula="_%nFormul 
 q:o[" %E={1085}{1077}{1090} {1088}{1072}{1079}{1088}{1077}{1096}{1077}{1085}{1080}{1103} {1085}{1072} {1074}{1074}{1086}{1076} / access denied "_$c(4) o_$c(4)_" %mxFormula="_%nFormul
 n %y0,%y,%x0,%x,%z s %y0=%mxRange,%x0=$p(%mxRange,"x",2),%z=1
 q:'%x0 o_$c(4)_" %mxFormula="_%nFormul  q:$p(%y0,"+",2)<1 o_$c(4)_" %mxFormula="_%nFormul  q:$p(%x0,"+",2)<1 o_$c(4)_" %mxFormula="_%nFormul
 f %y=+%y0:1:%y0+$p(%y0,"+",2)-1 f %x=+%x0:1:%x0+$p(%x0,"+",2)-1 s %z=%z+1 d
 . s:'%2 @%2@(+%y,+%x)=$p(%mxRange,$c(4),%z)
 q:$zv'["U) " o_$c(4)_" %mxFormula="_%nFormul q $$U^MXF(o_$c(4)_" %mxFormula="_%nFormul)
InseRows(%mxFormA,%1,%InsRows) 
 s %mxFormA=$g(%mxFormA,%mxForma),%1=$g(%1,%yChange),%InsRows=$g(%InsRows,1)
 n %,o,%zr q:$g(^oRC(%USID,%mxFormA,%yChange,1))'["_" 0
 f %=%1:-1:1 q:$g(^oRC(%USID,%mxFormA,%,1))'["_"
 s o="",%=1 f  s %=$o(^(%)) q:'%  s o=o_$g(^(%))
 q:o["%tabRow"!(o["""+""") 0
 f %=%xChange+1:1:99,0 i $g(^(%))["?_",$p(^(%),";")[" [" q
 q:'% 0 k ^oYX(%USID,%mxSheet,%yChange,%xChange)
 f %=%1:1 i '$$%0Yrc(%) s %=%-1 q
 f o=%:-1:%1+1 k ^oYX(%USID,%mxSheet,%) m ^oYX(%USID,%mxSheet,%)=^oYX(%USID,%mxSheet,%-1)
 k ^oYX(%USID,%mxSheet,%1)
 q $$U^MXF(o)
eqvTree2(z1,z2) 
 n %1,%2,%
 s %1=0 f  s %1=$o(@z1@(%1)) q:'%1  s %2=0 f  s %2=$o(@z1@(%1,%2)) q:'%2  s %=$p($g(^(%2)),"<mx ") i $p($p($g(@z2@(%1,%2)),"<mx "),"?")'=% s %2=-1_" "_%1_-%2_"  "_%_" ::: "_$g(@z2@(%1,%2)),%1=" "_%1 q
 q:%2<0 %2  q 0

MXterm^INT^1^65495,42075^0
MXterm ;  ;[ 20200418 23:54:58 ]
 q
jo(%mcomm) ;; s ^ERR(0,$h)=%mcomm 
 i $e(%mcomm,1,2)="Q;"!($e(%mcomm,1,2)="q;")!($e(%mcomm,1,6)=" ;STOP") s %=$$killJob($g(%jobChild)) k ^trm(%USID)  w !,"-EXIT-" d oo zn:$d(%zns) %zns  d  q
 . n j s j="",nn=0 f  s j=$o(^$JOB(j)) q:'j  q:nn>3  i '$d(^JOB(+$h,j)),$o(^(1)),$$killJob(j)=j w " -- process "_j_" killed --  "  s nn=nn+1
 if %mcomm'["; readTRM ;",$l($g(%USID)) s %zns=$znspace k ^|"%SYS"|ootrmooo,^ootrmooo
 i "  "_%mcomm_"   "[" p  "!("  "_%mcomm_"  "[" P  "),%mcomm'["""" x %mcomm q
 s %zt=$zt,$zt="erjo^MXterm" n %
 if %mcomm'["; readTRM ;" s %=$$killJob($g(%jobChild)) i %mcomm'["^",%mcomm'[":",%mcomm'["w  " x %mcomm q  
 if %mcomm'["; readTRM ;" job job:(:1):1 s %jobChild=$ZCHILD,^JOB(%USID,$ZCHILD)=$h
 if %mcomm["; readTRM ;" k ^trm(%USID) s ^trm(%USID)=";;;"_$p(%mcomm,"; readTRM ;")
 f %=1:1:99 s o=$o(^trm(%USID,""),-1)  h .1  if o,$o(^trm(%USID,""),-1)=o,%>9 q
 i 'o,$g(%jobChild),%>98 w "  !! process ID = ",%jobChild i $$killJob(%jobChild)
 w "^trm(%USID)"    if $l($g(%USID)),$$RestMem^USX(%USID,"trm",$j)
 q
erjo w $ze," $zn=",$zn c:+$io=2 2
 q
job 
 s %io=$io,%B=$c(254)  k ^trm(%USID) k ^oAllVars(%USID,"trm") k ^|%zns|ootrmooo
 s ^|"%SYS"|trm($j)=$znspace_" "_%USID_" "_%zt,%zns=$znspace    
 s $zt="er^MXterm" ;; o "|TRM|"::1 j j2:(:5:"|TRM|"):1 c "|TRM|" 
 i ("  "_%mcomm_"  "[" zw  ")!("  "_%mcomm_"  "["w  ") s %mcomm="s %=""%"" f  s %=$o(@%) q:'$l(%)  i '$p(%,""%"",2),%'[""%o"" w %,""="",$g(@%),! i $d(@%)>2 s %1=% f  s %1=$q(@%1) q:'$l(%1)  q:$p(%1,""("")'=%  w ""    "",%1,""  =  "",$g(@%1),!"
 o $io u $io::"^MXterm" D $ZU(82,12,1) x %mcomm  D $ZU(82,12,0) u 0 
 i $d(%USID),$$SaveJob^USX(%USID,"trm",$ZPARENT)
 if '$d(%USID) d oo ;; s %j=1,%B=$c(254)
 s %=0 f o=1:1 s %=$o(^|%zns|ootrmooo(%)) q:'%  s ^|%zns|trm(%USID,o)=^|%zns|ootrmooo(%)
 s ^|%zns|trm(%USID,o+100)=$g(^|%zns|ootrmooo) ;; k ^|%zns|ootrmooo 
 q
er d oo D $ZU(82,12,0) c:+$io=2 2  u $p  u:$d(%io) %io  s $zt=$g(%zt) if $l($g(%USID))*$l($g(%zns))=0 halt
 s ^|%zns|trm(%USID,999999)=$e($g(^|%zns|ootrmooo),1,9999)_$ze
 q
jx(%mcomm,%znsp) 
 s %zns=$znspace,%znsp=$g(%znsp,%zns)  ;; if +$io=2 c 2
 job jobx:(:1):1 h 1 s %jobChild=$ZCHILD
 n %,oo  s %="",oo="" f  s %=$o(^ojx(1,%)) q:'%  s oo=oo_^(%)
 ;; n %,oo  s %="",oo="" f  s %=$o(^SPOOL(1,%)) q:'%  s oo=oo_^(%)
 q:'$l(oo) %mcomm  q "" 
jobx s %zt=$zt,$zt="jxErr^MXterm" n %  s:%zns'=%znsp $namespace=%znsp
 o 2:(1:1):"^MXterm" u 2 k ^SPOOL(1) D:000 $ZU(82,12,1) x %mcomm   D:000 $ZU(82,12,0)
 k ^|%zns|ojx(1) ;; s ^|%zns|ojx(1,-1)=%mcomm_" ;;; "_$zu(5)_" $io="_$io_" $p="_$p_"  $j="_$j
 s:%zns'=%znsp $namespace=%zns  ;;  s ^ojx(1,-2)=%mcomm_";;;;;"_$zu(5)_" $io="_$io_" $p="_$p_"  $j="_$j
 m ^ojx(1)=^|%znsp|SPOOL(1) 
 q
jxErr zn:$l($g(%zns)) %zns s ^ojx(1,1)=$ze_" "_$zt_" "_$g(^ojx(1,1)) s:$d(%zt) $zt=%zt  q  ;; c:+$io=2 2 q
x(%mcomm,%znsp) 
 s %io=$io k ^SPOOL($j) i $$killJob(0)
 s ^|"%SYS"|trm($j)=$znspace_" "_%USID_" "_$zt,%zns=$znspace    
 k ^|"%SYS"|ootrmooo,^ootrmooo  s $zt="erx^MXterm",%mcomm="  "_%mcomm_"  "
 i (%mcomm[" zw  ")!(%mcomm[" w  ")!(%mcomm[" ZW  ")!(%mcomm[" W  ") s %mcomm="s %=""%"" f  s %=$o(@%) q:'$l(%)  i '$p(%,""%"",2) w %,""="",$g(@%) w:$d(@%)>2 !,"" ..."" w ! "
 else  i %mcomm[" p  "!(%mcomm[" P  "),%mcomm'["""" x %mcomm q ""
 i $d(%znsp) s %UCI=$znspace zn %znsp  
 set ^ERR("x+7")=$io  o 2:($j:1):"^MXterm"  u 2::"^MXterm" 
 D $ZU(82,12,1)  x %mcomm   D $ZU(82,12,0)
 set ^ERR("x+9")=$io  c 2 u $io u:$d(%io) %io
 i $d(%znsp),$d(%UCI) zn %UCI  
  ;; if '$d(%USID) d oo zn %zns s %j=1,%B=$c(254)
 n %,o,%oo s %=0,o=1,%oo="" f  s %=$o(^ootrmooo(%)) q:'%  s %oo=%oo_^(%) d   s ^SPOOL($j,o)=%oo
 . f  s ^SPOOL($j,o)=$p(%oo,$c(10))_$c(10),%oo=$p(%oo,$c(10),2,999),o=o+1 q:%oo'[$c(10)
 q ""
erx 
 D $ZU(82,12,0)  o 2:($j:9999)  u 2  w $ze_"  "_$g(%mcomm)  zn:$d(%UCI) %UCI  w $ze_"  "_$g(%mcomm)
 d oo  close 2 u:$d(%io) %io s $zt=$g(%zt)
 q $g(^|%zns|ootrmooo)_$ze ;; s ^|%zns|trm(%USID,999999)=^|%zns|ootrmooo
 q
j2 s ^ERR("j2")=$j o "|TRM|:|"_j2 u "|TRM|:|"_j2 s ^ERR("$io")=$io
 q
killJob(j) 
 n % s %=$g(%USID,0) s:'j j=$o(^JOB(%,0)) q:'j 0  q:'$d(^$JOB(+j)) -j  q:$d(^JOB(+$h,j)) -$h
 i +$p($zv,"Build ",2)>602 do $System.Process.Terminate(+j) k ^JOB(%,+j) d  q j
 . f %=1:1:9 q:'$d(^$JOB(+j))  h 1
 . f %=1:1:99 k ^JOB($h-%)
 ;; Do $ZUTIL(4,+j,-65) h 1 q j
 q 0
oo if '$d(%USID) s %=$g(^|"%SYS"|trm($j)),%zns=$p(%," "),%USID=$p(%," ",2),%zt=$p(%," ",3,99)
 q
wstr(%exp) 
 D oo,$ZU(82,12,0) n %,o,z  u:000 0  s z=$zr 
 if %exp[$c(27) n %1,%2 s %1=""""_$c(27)_"[1m_$c("_$c(27)_"[m",%2=$c(27)_"[1m)_"_$c(27)_"[m""" d
 . f o=1:1:9 q:%exp'[%1!(%exp'[%2)  s %="s %=$c("_$p($p($p(%exp,%1,2),%2),$c(27))_")" q:%["-"  x % s %exp=$p(%exp,%1)_%_$p(%exp,%2,2,999)
 . s %2=$c(27)_"[1m)"_$c(27)_"[m"
 . f o=1:1:9 q:%exp'[%1!(%exp'[%2)  s %="s %=$c("_$p($p($p(%exp,%1,2),%2),$c(27))_")" q:%["-"  x % s %exp=$p(%exp,%1)_%_$p(%exp,%2,2,999)
 . s %1=$c(27)_"[1m$c("_$c(27)_"[m",%2=$c(27)_"[1m)"_$c(27)_"[m"
 . f o=1:1:9 q:%exp'[%1!(%exp'[%2)  s %="s %=$c("_$p($p($p(%exp,%1,2),%2),$c(27))_")" q:%["-"  x % s %exp=$p(%exp,%1)_""""_%_""""_$p(%exp,%2,2,999) q
 ;;f %=1:1:9 s o=$p($p(%exp,"_$c(1",2),")_"),%exp=%exp_o q:'$l(o)  d
 ;; . x "s o=$c(1"_o_")" s:$l(o) %exp=$p(%exp,"_$c(1")_o_$p(%exp,")_",2,99)
 ;;
 s %=+$o(^|%zns|ootrmooo(""),-1),o=$g(^(%)) s:'% %=1 s:$l(o)+$l(%exp)>999 %=%+1,o="" s ^(%)=o_%exp ;; ,$x=$x+$l(%exp)
 s %=+$o(^|%zns|oooorest($j,""),-1),o=$g(^(%)) s:'% %=1 s:$l(o)+$l(%exp)>999 %=%+1,o="" s ^(%)=o_%exp,$x=$x+$l(%exp)
 D $ZU(82,12,1) u:000 0::"^MXterm" i $d(z),$d(@z)
 q
wnl D oo,$ZU(82,12,0) n %,o,z  s z=$zr ;; w !
 s %=+$o(^|%zns|ootrmooo(""),-1),o=$g(^(%)),%='%+%,^(%)=o_$c(10),$x=1
 s %=+$o(^|%zns|oooorest($j,""),-1),o=$g(^(%)),%='%+%,^(%)=o_$c(10),$x=1
 i $d(z),$d(@z)
 D $ZU(82,12,1)
 q
wff D oo,$ZU(82,12,0) w:000 #  n %,o,z s z=$zr 
 s %=+$o(^|%zns|ootrmooo(""),-1),o=$g(^(%)),%='%+%,^(%)=o_$c(13,12),$y=1,$x=1
 s %=+$o(^|%zns|oooorest($j,""),-1),o=$g(^(%)),%='%+%,^(%)=o_$c(13,12),$y=1,$x=1
 i $d(z),$d(@z)
 D $ZU(82,12,1) 
 q
wchr(%) D oo,$ZU(82,12,0) w:000 *%   n %,o,z s z=$zr 
 s %=+$o(^|%zns|ootrmooo(""),-1),o=$g(^(%)),%='%+%,^(%)=o_$c(%)
 s %=+$o(^|%zns|oooorest($j,""),-1),o=$g(^(%)),%='%+%,^(%)=o_$c(%)
 i $d(z),$d(@z)
 D $ZU(82,12,1)
 q
wtab(%) ; w ?%
 D oo,$ZU(82,12,0)
 n %0,%1,o,z s %0=%,%=$s(%>$x:%-$x,1:1),%1="",$e(%1,%)=" " s z=$zr 
 s %=+$o(^|%zns|ootrmooo(""),-1),o=$g(^(%)),%='%+%,^(%)=o_%1_$c(9),$x=%0
 s %=+$o(^|%zns|oooorest($j,""),-1),o=$g(^(%)),%='%+%,^(%)=o_%1_$c(9),$x=%0
 i $d(z),$d(@z)
 D $ZU(82,12,1)
 q
rstr(len,to) 
 D $ZU(82,12,0) d oo s:'$l($g(len)) len=999 n %,o,z s z=$zr 
 ;; if $D(len)&&$D(to) s %input=$e(to_"ooooooooooooooooooooooooo",1,len) g rstre
 ;; i $D(len) s %input=$e("ooooooooooooooooooooooooo",1,len) g rstre 
 ;; i $D(to) s %input=to_"sek-ok-Read-to" g rstre
 ;; i $zv'["MiniM" READ %:3 s:%="" %="trm"  u $io::"^MXterm"
 s ^|%zns|trm(%USID)="?"_$zn,%input=""
 s %=0  f o=1:1 s %=$o(^|%zns|ootrmooo(%)) q:'%  s ^|%zns|trm(%USID,%)=^|%zns|ootrmooo(%)
 s ^|%zns|trm(%USID,o+10)=$g(^|%zns|ootrmooo) k ^|%zns|ootrmooo ;; s ^|%zns|ootrmooo=""
 f %=1:1:19 h 1 s o=$g(^|%zns|trm(%USID)) i $e(o,1,3)=";;;" s %input=$e($e(o,4,999),1,len),^|%zns|trm(%USID)="" q
rstre i $d(z),$d(@z)
 D $ZU(82,12,1)
 q %input
rchr(to) 
 D $ZU(82,12,0) d oo  
 i $d(to) s %inp=$a(8)  ;; R *data:to . ;
 i '$d(to) s %inp=$a(9)  ;; R *data
 D $ZU(82,12,1) 
 q %inp
zw n % s %=" " f  s %=$q(@%) q:'$l(%)  w !,%,"=",$g(@%)
 q
APC 
BEL 
CBT(%1) ; $X
CCH 
CHA(%1) ; $X
CHT(%1) ; $X
CNL(%1) ; $X, $Y
CPL(%1) ; $X, $Y
CPR 
CTC(%1,%2,%3,%4,%5,%6,%7,%8,%9) 
CUB(%1) ; $X
CUD(%1) ; $Y
CUF(%1) ; $X
CUP(%1,%2) ; $X,$Y
CUU(%1) ; $Y
CVT(%1) ; $Y
DA 
DAQ(%1,%2,%3,%4,%5,%6,%7,%8,%9) 
DCH(%1) 
DCS 
DL(%1) 
DMI 
DSR(%1) 
EA(%1) 
ECH(%1) 
ED(%1) 
EF(%1) 
EL(%1) 
EMI 
EPA 
ESA 
FNT 
GSM 
GSS 
HPA(%1) ; $X
HPR(%1) q  ; $X
HTJ s $x=$x+4 q  ; $X
HTS s $x=$x+4 q  ; $X
HVP(%1,%2) ; $X, $Y
ICH(%1) 
IL(%1) 
IND ; $Y
INT 
JFY 
MC 
MW 
NEL ; $X, $Y
NP(%1) 
OSC 
PLD ; $Y
PLU ; $Y
PM 
PP(%1) 
PU1 
PU2 
QUAD 
REP(%1) ; $X, $Y
RI ; $Y
RIS ; $X=0, $Y=0
RM(%1,%2,%3,%4,%5,%6,%7,%8,%9) 
SEM 
SGR(%1,%2,%3,%4,%5,%6,%7,%8,%9) 
SL 
SM(%1,%2,%3,%4,%5,%6,%7,%8,%9) 
SPA 
SPI 
SR 
SS2 
SS3 
SSA 
ST 
STS 
SU 
TBC 
TSS 
VPA(%1) ; $Y
VPR(%1) ; $Y
VTS 
 q
zpipe quit ; CPIPE example to run host console command -- https://github.com/rcemper/CPIPE/blob/master/CPIPE.int
execute(cmd,test)  ;; Public {
 set dev="|CPIPE|1"
 set $zt="cls"
 set empty=0
 open dev:cmd:0 s oo=$test
 ;; write:test $test,!
 ;; else write "pipe failed",! quit 0
 ; while empty<3  ;;  {
 use dev read line
 set empty=$s($l(line):0,1:$i(empty))
 use 0 write line,! ;;; or do any kind of analysis of the line
 ;; }
cls 
 set $zt="" use 0
 close dev
 if $ze'["<ENDOFFILE>" w $ze,!
 quit $t
 q  ;; }
cmd(osComm) 
 k ^oPIPE n pipe,%,R  s %zt=$zt,$zt="erPIPE^MXterm",pipe="|CPIPE|1" 
  o pipe:(osComm_" > cmd.txt"):1 q:'$test   u pipe
 f L=1:1:999 read R:0 if $l(R) s ^oPIPE($j,L)=R
 close pipe set $zt=%zt u 0
 q
erPIPE s $zt=%zt close pipe  u 0
 q

US^INT^1^65495,42075^0
US ;    ; [ 11/04/2006  5:40 PM ]  ;[ 20200217 19:32:22 ]
 ; MSM, CACHE, IRIS, GT.M, MiniM
 ; vmx  Copyright(c) SIA ENTERS  1997-2020
 g enter^USb
yx(y,x,c) 
 q ""
PN w $$n(@%1,%1) q
PN0 w $$n(%K,%N) q
n(%k,%N,%) 
 n %1 s %N=$tr($g(%N),"~")
 I %N="" s %N=$tr($p(%LI(%FILE),",",%G),"~")
 s (%k,@%N)=$g(%k,%K)
 s %1=$l($p(","_$tr(%LI(%FILE),"~")_",",","_%N_","),",")
 s (%G(%N),@%N)=%k,$p(%LIn,$c(5),%1)=%k
 q ""
RUN 
 s %NEW=1,%I="^"_%FILE,%ZR=1,%KEM=$L(%LII(%FILE),","),%SF=""
 f %=1:1:%KEM s %1=$p(%LII(%FILE),",") i $l(%1),$d(@%1) s %I=$name(@%I@(%1))
 i $$SaveMem^USX("t-"_%FILE)  ;; _$$CopySave^USX("t-"_%FILE)
 q
IR(%FILE) 
 n %,oo,%n s oo=""
 f %=1:1:$l(%LI(%FILE),",") s %n=$tr($p(%LI(%FILE),",",%),"~"),oo=oo_$e($g(@%n),1,1023)_$c(4)
 q oo
e(%Inew,%Iold) 
 s:$e(%Inew)'="^" %Inew="^"_%FILE_"("_%LII(%FILE)_")" 
 n %FILE s %Inew=$NAME(@%Inew),%FILE=$p($e(%Inew,2,999),"("),%SF=$g(%SF)
 q:$g(mxConfig)[("noChange:"_%FILE_":") ""
 s %Iold=$g(%Iold),%IRnew=$$IR(%FILE) s:%Iold["("""""!(%Iold[","""")") %Iold=""
 s:%Iold="" %Iold=%Inew i $e(%Iold)="~" s:$e(%Iold,2)="^" %Inew=$e(%Iold,2,999) s %Iold="DELETE"
 n %R,%1,%,%Rold,%N,o,%mxChange i '$d(%CON(%FILE)) s %1=%FILE d ^USX
 x %CON(%FILE) s %mxChange="" i $d(^mxConfig("A")),'$$tAccess("A",%FILE) s %E=" access denied " HALT  q %E
 i %Iold="DELETE" s %mxChange="-",%Iold=%Inew
 i %Iold["^",$d(@%Iold)#10 s %Iold=$NAME(@%Iold),%Rold=$$r5(%Iold) d  q:%mxChange<0 ""
 .  i $e(%mxChange)'="-",%Rold=%R,%Iold=%Inew s %mxChange=-1 q
 .  N %R,%I,@($tr(%LI(%FILE),"~")) s %I=%Iold,%R=%Rold x %XI(%FILE),%XG(%FILE)
 .  i 1_$$xglm(%I,-1) k @%Iold
 .  f %=1:1:$l(%LI(%FILE),",") s %n=$tr($p(%LI(%FILE),",",%),"~") d
 ..   i $p(%IRnew,$c(4),%)'=@%n s %mxChange=%mxChange_$c(10)_$c(13)_%n_"="_@%n_$c(10)_$c(13)
 q:$e(%mxChange)="-" %Inew_$c(4)_"-DELETED"
 i $$w5(%Inew,%R)_$$xglm(%Inew,1)
 q %Inew_$c(4)_%mxChange
vmALwr(%FILE,%Iold,%IRnew) 
 n %R,%1,%,%I,%Rold,%N,o i %FILE'=$g(%W) s %refreAL=1 d pAL^USb
 i mxConfig[("noChange:"_%FILE_":") q ""
 i mxConfig[("noChange2:"_%FILE_":"),%Iold["^" d  q:%Iold="" ""
 .  s o="^mM" f  s o=$q(@o) q:o=""  i o[(1_%Iold),$p(@o,%B)=%USID q
 .  s %Iold=""
 i '$d(%IRnew) s %IRnew=$$IR(%FILE)
 i %Iold["^" k %WW i $d(@%Iold)#10,%IRnew="" d  s %I="-"_%Iold g vmALwrE
 .  s %Iold=$NAME(@%Iold),%=$$xglm(%Iold,-1) k @%Iold
 i %IRnew="" s %I="?"_%Iold g vmALwrE
 f %=1:1:$l(%LI(%FILE),",") s %N=$tr($p(%LI(%FILE),",",%),"~"),(%G(%N),@%N)=$p(%IRnew,$c(4),%)
 s %I=$NAME(@("^"_%FILE_"("_%LII(%FILE)_")"))
 i %Iold'["^",$d(@%I)#10 s %Iold=%I ; exist old record with the same key
 i '$d(%CON(%FILE)) s %1=%FILE d ^USX
 x %CON(%FILE)
 i %Iold["^",$d(@%Iold)#10 s %=$NAME(@%Iold),%Rold=$$r5(%Iold) q:%R=%Rold&(%=%I) ""  d  k @%Iold
 .  N %R,%I s %I=%Iold,%R=%Rold
 .  n @($TR(%LI(%FILE),"~")) x %XI(%FILE),%XG(%FILE)
 .  i $$xglm(%I,-1)
 .  f %=1:1:$l(%LI(%FILE),",") d  ; only for indicate changed fields..
 ..   s %N=$tr($p(%LI(%FILE),",",%),"~")
 ..   s $p(%IRnew,$c(4),%)=$s($g(@%N)=$p(%IRnew,$c(4),%):"",1:$g(@%N)_$c(10)_"~~~~~~~~~~~~~"_$c(10)_$c(13)_$p(%IRnew,$c(4),%))
 i $$w5(%I,%R)_$$xglm(%I,1)
vmALwrE q %I_$c(4)_%Iold_$c(4)_%IRnew
vmALerr 
 x:$zv["MS" "w $zerr_%I_"" ""_%Iold_"" ""_%IRnew"
 q
ALv(%Sx7r) 
 s:'$g(%Sx7r) %Sx7r=1 s %LII=%LII(%FILE),%N=$tr(%N,"~") i %FILE'=$g(%W) s %refreAL=1 d pAL^USb
 I %Sx7r=1 k %mxINFO d  i %G>2,$d(^mxConfig("A")),'$$tAccess("A",%FILE) s %E=%N_": access denied "_$c(10)_$c(13)_%K_$c(10)_$c(13)_%E_$c(10)_$c(13)_"ERROR" q %E
 .s %LIn="",%KEI="",%KEM=$l(%LII(%FILE),",")
 .s %KEY=$l($p(","_%LII(%FILE)_",",","_%N_","),",")
 .i %G=1 s %maxList=1
 .i %K[$c(10)," Kase Banka oBanka pers pam "[(" "_%FILE_" ") s %K=$tr(%K,$c(10),"^") f  q:"^ "'[$e(%K)  s %K=$e(%K,2,9999) s:%K="" %K="-"
 .f  q:$c(10)_" "'[$e(%K)  s %K=$e(%K,2,9999) s:%K="" %K="-"
 k %ErrorM s $zt="ALvErr^US" s %E="" i %K[" " s %K=$p(%K_"     ","     ") s:'$l(%K) %K="-"
ALvNext s o=$g(%W(%N,%Sx7r)) s:o["$$pvn^fin" o="" s:$e(o)=";" o="" s %ALx=o
 i o["[""P""",$e(%N)="s" s o=$$trw^UST(o,"[""P""","[""p""")
 i $g(d)>20120700,o["""p"""!(o["""+""") n % d  s %ALx=o,o=""  
 . f %=118,121,122 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d,100)") 
 . f %=1.18,1.21,1.22 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d,100.01)") 
 . f %=.18,.21,.22 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d,.01)") 
 . f %=18,21,22 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d)") 
 i $g(d)>20110000,o[18,o'[22,o["""p"""!(o["""+"""),o'["$s(d" s o=$$trw^UST(o,18,22)
 i $g(d)>20110000,o[21,o'[22,o["""p"""!(o["""+"""),o'["$s(d" s o=$$trw^UST(o,21,22)
 i $g(d)>20090000,o[18,o'[21,o["""p"""!(o["""+"""),o'["$s(d" s o=$$trw^UST(o,18,21)
 i $zv["MiniM",o[" w "!(o[" w:")!($e(o)="w") s %E=o_" -- ""w"" not allowed in MiniM ! -- ",o=";" 
 s:$l(o) %ALx=o
 i " ; ?-"'[%ALx x %ALx
 i %K["  ",%K'["q",%K'["f",%K'["=" f  q:$l(%K)<2  q:%K'["  "  s %K=$$trw^UST(%K,"  "," ")
 i '$l(%E),%K?8n,%N="d"!(%N="d8"),mxConfig'[":%E.d8=NO:" s %E=$$d31^MXF(%K,8)
 i $l(%E),%E'[" ok!" s %E=%N_":"_$g(^AL(%FILE,"%W",%N,-1))_$c(10)_$c(13)_%K_$c(10)_$c(13)_%E_$c(10)_$c(13)_"ERROR" q %E
 i $l(%E),%E[" ok!" s %E=%N_$c(10,10)_%E q %E
 I $d(%W(%N,%Sx7r+1)) s %Sx7r=%Sx7r+1 g ALvNext
 s:$d(%mxINFO) %mxINFO=11
 i $$n(%K,%N)
 i " Kase oBanka pers pam "[(%FILE_" "),$l(%K,"^")>%maxList s %maxList=$l(%K,"^")
 k %ALx q %Sx7r
 q
ALvErr s %ErrorM="%ALx="_$g(%ALx)_"  "_$ze_" ;"_$c(0)
 q ""
WR q
F ; mx
 N %,%R,%1
 s %ZR=$NAME(@("^"_%FILE_"("_%LII(%FILE)_")"))
 S %R=$g(@%ZR),%NEW=%R="",%KEI=%ZR
 s:$l(%R)=500 %R=$$r5(%ZR) k %mxINFO(1,"'%NEW")
 I %NEW S %gminm=0,%gmaxm=9999 q
 x %XG(%FILE) s %mxINFO(1,"'%NEW")=%ZR ;; ,%="^mM("""")" 
 i $d(^mxConfig("A")),'$$tAccess("A",%FILE) s %E="F^US ::: access denied " s %R=0 x %XG(%FILE)
 q
xgl(%F,%ZR) 
 q:'$d(%ZR)!'%F "?"
 n %,%lg  x %ZRT(%F>0)
 i %AL("%F8")'["-m",$$%mM(%F>0,%ZR)
 i %F>0 x %xgl(0),%xgl(1) q ""
 n %R,%I s %I=%ZR,%R=$$r5(%ZR) n @($tr(%LI(%FILE),"~"))
 x %XI(%FILE),%XG(%FILE),$g(%xgl(%FILE,0)),$g(%xgl(%FILE,-1)) k @%ZR
xglE q ""
xglER x "s %E=$zerr " g xglE
xglm(%ZR,%F) 
 q:'$d(%ZR)!'%F "?"  s %E="" i %FILE'=$g(%W) s %refreAL=1 d pAL^USb
 i $g(mMdatums(%ZR)) s o=$g(mxConfig("mMdatums")) i o d  q:o
 . i ","_%LI(%FILE)'[",d,",","_%LI(%FILE)'[",d8," s o="" q
 . s:","_%LI(%FILE)[",d," %=d s:","_%LI(%FILE)[",d8," %=d8
 . i mMdatums(%ZR)>($h-o) s o="" q
 . s %E=mMdatums(%ZR),o=""
 k ^ooC(%ZR),odsFlag,opD s %isChang=1,^gramatos=0
 n %,%lg,%file,o s %file=$e($p(%ZR,"("),2,99)
 i '$d(%xglm(%file)) d %xgl^USX
 i $d(%ZRTm) x $g(%ZRTm(%file,%F>0))
 i $g(%AL("%F8"))'["-m",%file'["mxConfig",%file'["kNo",%file'["mMail",$$%mM(%F>0,%ZR)
 i %F>0,'$g(^otSelect(%USID,%file,0)) s %="^otSelect(%USID,%file,"_$p(%ZR,"(",2,9),@%@(%ZR)=1
 i %F>0 x $g(%xglm(%file,0)),$g(%xglm(%file,1)) q ""
 s %="" i $g(d),(","_%LI(%FILE)[",d,"),$d(^gramatos(d,%ZR)) s %=$zr
 i $g(d8),(","_%LI(%FILE)[",d8,"),$d(^gramatos(d8,%ZR)) s %=$zr
 i '$l(%),","_%LI(%FILE)[",d,"!(","_%LI(%FILE)[",d8,") f  s %=$o(^gramatos(%)) q:%=""  i $d(^gramatos(%,%ZR)) s %=$zr q
 i $l(%) k @%
 S %=$E(","_%LII(%FILE)_",",1,%),%KEY=$L(%,",")-2
 n %R,%I s %I=%ZR,%R=$$r5(%ZR) n @($tr(%LI(%file),"~"))
 x %XI(%file),%XG(%file)
 x $g(%xglm(%file,0))
 x $g(%xglm(%file,-1)) 
 k @%ZR
xglmE q ""
xglmER x "s %E=$zerr " 
 g xglE
pLI(%I) 
 n %R,oox,oor,%1,oon s %R=$g(@%I),%B=$c(254) q:%R="" ""
 i $e(%I,1,4)="^mM(" s %I=$p(%I,",",2,99),%I=$e(%I,3,$l(%I)-2)
 s %I=$$trw^UST(%I,"""""","""")
 s %1=$e($p(%I,"("),2,99) q:'$l(%1) ""
 x %XI(%1),%XG(%1) s oor="" i $d(^mxConfig("A")),'$$tAccess("A",%1) q ""
 f oox=1:1:$l(%LI(%1),",") s oon=$tr($p(%LI(%1),",",oox),"~"),oor=oor_%B_@oon
 q oor
%mM(%F,zr,r) 
 n o,%
 s zr=$NAME(@zr) k ^ooC(zr)
 i %F>0,$d(@zr)#10=0 q ""
 s %=$tr($h,",",".") s:$l(%)<11 $p(%,".",2)=$e(100000+$p(%,".",2),2,9)
 s o=1 f  q:'$d(^mM(%_o))  s o=o+1 q:o=9
 s:'$d(r) r=$g(@zr) s:$e(r)=%B r=%USID_r s ^mM(%_o,(%F>0)_zr)=r
 i $d(@zr)
 q ""
W S %WW(%N)=%K Q
tnq(format,text,h) 
 n t,tt,tt1,ttt,%1,%2,%3
 s t="",tt1=text,ttt="",h=$g(h,";"),text=$g(text)
 f %=1:1:$l(format,";") s tt=$p(format,";",%) d:tt'=""
 . s %1=$p(tt," "),%2=$p(tt," ",2,99),%3=$p($p(text,%1,2,99),h)
 . i %3="" s %3="?"
 . s tt1=$p($p(tt1,%1),h),ttt=ttt_"||"_%2_"|"_%1_"|"_%3 s:tt1="" tt1=" "
 q " | |"_tt1_ttt
%BELL q
%n1(%n) k %WW(%n) s:%NEW %WW(%n)=@%n\1+1 q ""
N1 K %WW(%N) S:%NEW %WW(%N)=%K\1+1 Q
%zb(h) q:%j ""
 q ""
w(y1,x1,y2,x2,w,s,c) 
 q ""
wT(a,y,x) q ""
r5(%zr) n %,%R s $p(%zr,"(")="^"_%FILE,%R=$g(@%zr) q:$l(%R)<500 %R
 f %=501:500 q:'$d(@%zr@(%))  q:$l(%R)#500  s %R=%R_^(%)
 q:1_$d(@%zr) %R
w5(%zr,%R) n %,r i $zv'["MS" s @%zr=%R q ""
 i '$d(@%zr),$l(%R)<500 s @%zr=%R q ""
 i $d(@%zr@(501))
 f %=501:500 s r=$e(%R,%,%+499) q:r=""&'$d(^(%))  k ^(%) s:r'="" ^(%)=r
 s @%zr=$e(%R,1,500)
 q ""
wkv(x) q:x'[$c(2) x  
 n xx s xx=$p(x,$c(2))
 f %=2:1:$l(x,$c(2))-1 s xx=xx_""""""_$p(x,$c(2),%)
 q xx
%T N %TIM,%TIM1,%NP
 N %M S %M=$P($H,",",2)\60
 N %I,%N S %TIM=%M\60_":"_(%M#60\10)_(%M#10)
 S %N=" AM" S:%M'<720 %M=%M-720,%N=" PM" S:%M<60 %M=%M+720
 S %I=%M\600 S:'%I %I=" " 
 S %TIM1=%I_(%M\60#10)_":"_(%M#60\10)_(%M#10)_%N
 I '$D(%NP) W:'%j %TIM1 K %TIM,%TIM1
 K %NP Q
%G(%N) ; mx
 q:"o"_%B[$g(%FILE,"o") 1  q:'$d(^AL(%FILE)) 1
 i '$d(%LII(%FILE)) n %1 s %1=%FILE d ^USX q:'$d(%LII(%FILE)) 1
 s %KEM=$l(%LII(%FILE),",")
 f %G=1:1:$l(%LI(%FILE),",") q:%N=$tr($p(%LI(%FILE),",",%G),"~")
 q %G
EnterAL(oo) 
 ; mx
 q:oo[";;" ""
 s o=$p(oo,";"),oo=$tr($p(oo,";",2,999),"=",",")
 s %FILE=$e($p(oo,"("),2,99),oo=$p(oo,"(",2,999)
 s:o="" o=%FILE s ^AL(%FILE,"NAME")=o
 s ^("%LII")=$p(oo,")"),^("%LG")="%SF"_$p(oo,")",2,999)
 s ^("%LI")=$tr(oo,")")
 f o=1:1:$l(oo,",") s n=$p(oo,",",o) i n[")" d  q
 . s ^AL(%FILE,"%W",$p(n,")"),1)=" d F "
 q ""
oAL() n %FILE,oo,o,%
 s %FILE=$p($g(oAL(0,1))," ",2) q:%FILE="" "ERROR - "_$g(oAL(0,1))
 s ^AL(%FILE,"NAME")=$p(oAL(0,1)," ",3,9)
 f g=1:1 s o=oAL(1,g) q:o=""  s:$d(oo) oo=oo_","_o,^AL(%FILE,"%LG")="%SF"_oo s:o[")" oo="" 
 s oo="" f g=1:1 s o=oAL(1,g) q:o=""  s oo=oo_o_"," i o[")" s ^AL(%FILE,"%LII")=$p(oo,")") q
 s oo="" f g=1:1 s o=oAL(1,g),oo=oo_$p(o,")")_"," i o="" s ^AL(%FILE,"%LI")=$p(oo,",,") q
 f g=1:1 s o=oAL(1,g) q:o=""  d 
 .f %=1:1:6 s ^AL(%FILE,"%W",$tr(o,")"),%)=oAL(%+4,g) k:@$zr="" @$zr
 .s ^AL(%FILE,"%W",$tr(o,")"),-1)=oAL(2,g) k:@$zr="" @$zr ; name
 .s ^AL(%FILE,"%W",$tr(o,")"),-2)=oAL(3,g) k:@$zr="" @$zr ; %SEL
 .s ^AL(%FILE,"%W",$tr(o,")"),0)=oAL(4,g)  k:@$zr="" @$zr ; before show 
 k oAL q $zr
tAccess(%0,%1) 
 s %1=$g(%1,%FILE) n %,%A,%zt s %zt=$zt,$zt="tAccessE^US"
 i %0="A" q:'$d(^mxConfig("A")) 1 d  s $zt=%zt q %A
 . i '$d(mxConfigA(%1)) s %="^mxConfig(""A"",%1)",mxConfigA(%1)=1 f  s %=$q(@%) q:%=""  q:$qs(%,1)'="A"  i $p($qs(%,2),"(")=%1 s mxConfigA(%1)=0 i $qs(%,3)=%USID s mxConfigA(%1,$qs(%,2)_%B_$qs(%,4))=$p(@%,%B,2)  
 . m %A=mxConfigA(%1) q:%A
 . s %=0 f  s %=$o(%A(%)) q:'$l(%)  s %A=1 d:%["("  i %A x "s %A="_%A(%) q:%A  ;; {1076}{1086}{1089}{1090}{1091}{1087} {1088}{1072}{1079}{1088}{1077}{1096}{1077}{1085} 
 .. n o,%i,%ii s %ii=$p($p(%,"(",2),")")
 .. f o=1:1:$l(%ii,",") s %i=$p(%LII(%1),",",o) q:'$l(%i)  i $g(@%i)'=$p(%ii,",",o) s %A=0 q  
tAccessE s $zt=%zt w ";",$c(0) q 0 ; not accessed
 q

USDOS^INT^1^65495,42075^0
USDOS ; MX.Shell  ;[ 20200301 21:09:29 ]
 ; MSM, CACHE, IRIS, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2020
 ; 
 ;(1,disk)        -D:           -q daudz.disku
 ;(2,file)     -ERASE (del)  -                    -5=no path
 ;(3,fold,fnew)-RENAME/(COPY?)  -
 ;(4)          -VER.of DOS   -
 ;(5,file,atr) -CHMOD        -32=arh,(16=dir,8=disk),4=sys,2=hid,1=read
 ;(6,dir)      -MKDIR        -
 ;(7,dir)      -RMDIR        -delete dir
 ;(8,dir)      -CD           -q                   -5=no path
 ;(9,disk)        -  ?space     -s/kl^freekl^b/s^kl
 ;(10,file,atr)-  ?atr       -q zos5              -5=no path
 ;(11,d)       -  ?dir       -q tek.dir(-d)
 ;(12,f?*,atr) -  ?file ,,63 -q file^S2=30b
 ;(13,q12)     -  ?nextfile  -q 12
 ;(14)         -  ?tek.disk  -
 ;             ------------------
 i '%j w #,$zv," ",?70 i $zv["MS" w $zu(0)
 s %USER=$g(%USER,"XXX") n %USPR s %USPR="USDOS"
 s %="\[3;47;20;78w\\open save rFnd Rcomp net mMailF9"
 d %M^USMENU q
zos(%1,%2) 
 n %,o
 i $zv["MS" x "s %=$zos(%1,%2)" q %
 q ""
open k ^US($j,"mMail.read") d %GR^USDOS q    ;\A:/B: glob.restory
rFnd d %RFound q                             ;\ROUTINES FOUND
Rcomp d RCMP^UShelp q                       ;\Glob & Rout Compare
zc(exe) 
 i $zv["MS" s exe=$$TERMINAL^%HOSTCMD(exe)
 i $zv["Ca" s exe=$zf(-1,exe)
 i $zv["IRIS" s exe=$zf(-1,exe)
 q exe
net ;\ Net-info
 k r s r(110)="NBTSTAT -r"
 s r(120)="NET CONFIG"
 s r(130)="NET DIAG"
 s r(140)="NET VIEW"
 s r(150)="NET PRINT"
 s r(160)="NET USE"
 s r(170)="NET VER"
 s r(180)="NETSTAT"
 s r(190)="ARP"
 s r(200)="FTP"
 s r(210)="PING"
 s r(220)="ROUTE"
 s r(230)="TELNET"
 s r(240)="TRACERT"
 ;
 s %=$$ws^USE("r",2,44) q:%zb=27
 s %=$$zc(@%wz),%=$$zc("PAUSE")
 q
mMail ;\ Write/Read
 q
mMailF9 ;\ Write/Read mMail show
 q
Shellbat(t) 
 n %,%file s %file="shell"_$j_".bat"
 d OpenUseW
 f %=1:1 q:$p(t,$c(13),%)=""  w $p(t,$c(13),%),!
 w "EXIT",!
 d Close
 s %=$$zc("start /min shell"_$j_".bat ") 
 h:'$d(%j)
 q %
save d USGS                       ;\MSM-globals,routines==>
%RFound q
jwr(%j,%NODE) 
 n %,%1,%Node,%2
 s %NODE=$g(%NODE),%Node="" x $e(%j,2,999)
 f  s %Node=$o(^mMail(%Node)) q:%Node=""  d:%Node=%NODE!(%NODE="")
 .s %dow=$p(^mMail(%Node),$c(254),2),gList=$p(^mMail(%Node),$c(254),3)
 .q:^(%Node)[";"
 .s %dor="" s:gList="-"!($e(gList)["(") %dor=%dow,%dow=""
 .s:$e(gList)["(" %dor=%dor_"/"_$p($p(gList,"(",2),")"),gList=$p(gList,"(")
 .f %="gList","%dow","%dor" s %(%)="" d  s @%=%(%)
 ..n %x f %x=1:1:9 s %1=$p(@%,"_",%x) i %1'="" d
 ... x:$e(%1)="(" "s %1="_%1 s %(%)=%(%)_%1
 .i gList[":\",$e(%dow,1,2)=$e(gList,1,2) x "s %=$zos(3,%dow,gList)" q
 .i gList["\"  d  h 1 q
 .. s %=gList,$p(%,"\",$l(%,"\"))="x.x"  q:$$zos(2,%)=-5
 ..s %=$$Shellbat("@echo off"_$c(13)_"copy "_%dow_" "_gList_" > nul") h 1
 .i %dow["\" s %=$$jwg(%j,%dow,gList,0,gList) q
 .i %dor["\" s %=$$jrg(%j,%dor) q
 h:%j  
 q ""
jw(%j,%Node,%dow,gList) 
 s %=$$jwg(%j,%dow,gList,0,gList)
 q ""
jwg(%j,%file,gList,%Piez,%MET) 
 s (%Piez,%MET)=$g(%Piez)_$g(%MET)
 s %file=$s(%Piez:+%Piez,1:%Piez["OS"),%RL=""
 d Close
 s %=%file,$p(%,"\",$l(%,"\"))="x.x" i $zv["MS" q:$$zos(2,%)=-5 ""
 s %file="C:\M\tmpjwg."_$j,%MET=%file_" "_$g(%MET) d %GSj
 f %1=1:1:3 s %=$$zos(2,%file) q:$$zos(10,%file)-32  h 5 ; del.@%file
 d Close
 i $zv["MS" x "s %=$zos(3,%file,%file)" i 1
 e  i $$Shellbat("@echo off"_$c(13)_"copy "_%file_" > nul")
 d Close
 h:%Piez["halt"&%j  
 q ""
jrg(%j,%file,%mode,%xmsm) 
 s %=%file,$p(%,"\",$l(%,"\"))="x.x"
 i $$zos(2,%)=-5 d:'%j  q ""
 . W !,"NOT found ",%file r rrrrrr
 s %mode=$g(%mode),%xmsm=$g(%xmsm)
 d %GR 
 d Close
 q ""
gr(%j,%USID,%file,%mode,%xmsm) 
 ; mx
 k ^ooMX(%USID,"gr") s ^ooMX(%USID,"gr")=%file_"-"_$h
 s %mode=$g(%mode),%xmsm=$g(%xmsm)
 d %GR
 s ^("gr")=$h_"-"_^ooMX(%USID,"gr")
 d Close
 q:%j  
 q $h
gs(%j,%USID,%file,max,%xmsm) 
 ; mx   ^mM(max)
 k ^ooMX(%USID,"gs") s ^ooMX(%USID,"gs")=%file_"-"_$h
 s:'$g(max) max=33 s zr="^mM(999999)",n=0,ot=0
 f  s zr=$q(@zr,-1) q:zr=""  s t=$qs(zr,1)\1 s:ot-t n=n+1 s ot=t q:n>max
 i zr="" s zr="^mM"
 d OpenUseW
 w $h,!,max
 i $zv'["U) " f n=0:1 s zr=$q(@zr) q:zr=""  w !,zr,!,@zr
 i $zv["U) " f n=0:1 s zr=$q(@zr) q:zr=""  w !,$$U^MXF(.zr),!,$$U^MXF(@zr)
 w !,"**",!,"**",!,!
 d Close
 s:'n n=-1
 s ^("gs")=n_"-"_$g(^ooMX(%USID,"gs"))
 q:%j  
 q n
gsj(%j,%USID,%file,%zr,%xmsm) 
 ; mx   ^glob
 s (%zr,zr)=$NAME(@%zr),%ql=$ql(zr)
 k ^ooMX(%USID,"gs") s ^ooMX(%USID,"gs")=%file_"-"_%zr_"-"_$h
 d OpenUseW
 f n=0:1 s zr=$q(@zr) q:zr=""  w @zr,! s ^ooMX(%USID,"gs",n)=@zr
 d Close s:'n n=-1
 s ^("gs")=n_"-"_$g(^ooMX(%USID,"gs"))
 q:%j  
 q n
saveGlob(%j,%USID,%file,zr,%xmsm) 
 ; mx  save one glob or node
 k ^ooMX(%USID,"saveGlob") s ^ooMX(%USID,"saveGlob")=%file_"-"_zr_"-"_$h_" ERROR "
 s:'%j zr=$NAME(@zr) s %xmsm=$g(%xmsm)
 s ^ooMX(%USID,"saveGlob")=%file_"-"_zr_"-"_$h
 d OpenUseW
 w $$pD^MXD($h,2)," ",zr," ",$zv,!,%USID
 s zr0=$e(zr,1,$l(zr)-1)
 i $zv'["U) " f n=0:1 s zr=$q(@zr) q:zr'[zr0  w !,zr,!,@zr s:$l(%xmsm) ^ooMX(%USID,"saveGlob",n)=@zr
 i $zv["U) " f n=0:1 s zr=$q(@zr) q:zr'[zr0  w !,$$U^MXF(zr),!,$$U^MXF(@zr) s:$l(%xmsm) ^ooMX(%USID,"saveGlob",n)=$$U^MXF(@zr)
 w !! d Close
 s ^("saveGlob")=n_"-"_$g(^ooMX(%USID,"saveGlob"))
 q:%j  
 q n
b25 q
USGS 
writeDOS 
 s n=0,%L=$g(%L),%MET=$g(%MET),%FN=$g(%FN)
 s %file=$e(%MET,1,3)["OS"!($p(%L,"=",3)["OS")
 n o x "s o=$s($zv[""MS"":$zu(0),1:$znspace)"
 s %USER=$g(%USER,o)
 s:%L["=" (%file,%FN)=$p($p(%L,"="),"?"),gList=$P(%L,"=",2),%RL=""
 g %GSRS
%GSj i '%j w $$w^USE("%GSj^USDOS",3,1) q:%zb=27
 ;  ------- Save Globals (mMail) ---------
 ;   M-globals/if_____?gList              
 ; to DOS-file________?%file               
 d %GS
 q
%GSRS i '%j w $$w^USE("%GSRS^USDOS",3,1) q:%zb=27
 ; M-Globals/if_____?gList                  i..,i      %zr  ;
 ; M-Routines/if ___?%RL
 ; to DOS-file________?%file                   A:xx.xxx  B:xx.xxx
 d %GS,%RS q:%j
 g %GSRS
saveUCI(routOnly,saveTo) 
 i '$d(saveTo) j saveUCIj(%USID) q
 j saveUCIj(%USID,routOnly,saveTo)
 q
saveUCIj(%USID,routOnly,%file) 
 s ^oTQMx(%USID,"saveUCI")=0
 n %j,gList,%RL,%,%L,o,%UCIsave,z,zz
 s %j=1,%L="",o="GTM" 
 x:$zv'["GT" "s (%UCIsave,o)=$s($zv[""MS"":$zu(0),1:$znspace)"
 i $g(%file)="" s %file="C:\M\save"_$p(o,",")
 s gList="* -ROUTINE -GB -rM* -rI* -rB* -rO* -mtemp* -CacheTem* -%* -M -rm* -UTILITY -mxM* -US -mvars -o* -TK* -ZMS* -Msg* -Er* -menu* -JOB* -C -DC -NNd -vc* -mJournal -mM -iVAL -gramato* -fk0 -fd* -f -HroIndex -NNo -ceChange -bJournal -apm -aFirma -aDK"
 s %=$g(%qSelect)_$g(%qChange),%=%["isas"!(%["VISAS")!(%["VISI")!(%["isi")!(%["ALL")!(%["all")!(%["All")
 s:% gList="* -ROUTINE -rM* -rI* -rB* -rO* -mtemp* -CacheTem* -%* -M -rm* -UTILITY -mxM* -US* -mvars -o* -TK* -ZMS* -Msg* -Er* -menu* -JOB* -C -DC -mM -iVAL -gramato* -fk0 -fd* -f -HroIndex -NNo -apm -aFirma -aDK"
 k ^mmM i $zv["MS" k ^US,^M,^rm,^om,^oMX
 s z="^mM($h-400_.999999)" f  s z=$q(@z) q:'$l(z)  s zz="^mmM("_$p(z,"(",2,99),@zz=@z 
 s %RL=$g(routOnly) s:%RL="" %RL="* -%* -r -rr -rrr -TK* -oo* -Ens* "
 i $l($g(routOnly))<3 d %GS m ^oTQMx(%USID,"saveUCI","%gg")=%gg m ^oTQMx(%USID,"saveUCI","%gg")=%gm
 s ^oTQMx(%USID,"saveUCI")=$h_"  "_%file_" "_%RL_" save ^%RS started but NOT finished !! <mx fc7"
 d %RS
 s ^oTQMx(%USID,"saveUCI")=$h_"  "_%file
 q
%GS 
 s %=$p(%file,":") s:%="" %="C"
 i '%j,$e(%file,2)=":",$$zos(9,%)<0 w $$^UShelp("%file","no $zos(9,"_%_")="_$$zos(9,%)) q
 q:'$l(gList)
 n %g,%g0,%g2,%x,%GL,n,%2,%r  k %gg
 s $zt="%GSlist2^USDOS"  ;;  if <DKSER> list global
%GSlist1 
 i $zv'["Ca",$zv'["IRIS" s %g="" f n=1:1 s %g=$o(^$GLOBAL(%g)) q:'$l(%g)  s %gg(%g)=n
 i $zv["Ca"!($zv["IRIS") d
 .n gd d GetDir^%GD("","gd")
 .s %g="" f n=1:1 s %g=$o(gd(%g)) q:'$l(%g)  i %g'["." s %gg("^"_%g)=n
 g %GSlISt
%GSlist2 
 s $zt="%GSlIStE^USDOS"  ;;  if <DKSER> list global
 i $zv'["Ca",$zv'["IRIS" s %g="" f n=1:1 s %g=$o(^$GLOBAL(%g),-1) q:'$l(%g)  s %gg(%g)=n
 i $zv["Ca"!($zv["IRIS") d
 .n gd d GetDir^%GD("","gd")
 .s %g="" f n=1:1 s %g=$o(gd(%g),-1) q:'$l(%g)  i %g'["." s %gg("^"_%g)=n
%GSlIStE I '%j zw %gg,n w $zt r %
%GSlISt s %GL=$p(gList,"/"),%di=1
 s $zt="ErGS^USDOS"  ;;  if <DKSER> 
revers s %="" f  s %=$o(%gg(%)) q:%=""  d
 .i "^UTILITY ^M ^R ^r ^rm ^US "[(%_" "),gList="*" q
 .i %["^o"!(%["^us"),gList="*" q
 .f %x=1:1:$l(%GL," ") s %g=$p(%GL," ",%x) i %g'="" d
 ..s:$e(%g)'["^" %g="^"_%g
 ..i %g["(",")."'[$e(%g,$l(%g)) s %g=%g_")"
 ..i %=$p(%g,"(") s %g(%g)=1 q
 ..i %g["*",%[$p(%g,"*") s %g(%)=1 s:gList["?" gList=gList_" "_%
 ..q:$e(%g,2)'["-"  s %g=$tr(%g,"-")
 ..i %=%g k %g(%) q
 ..i %g["*",%[$p(%g,"*") k %g(%)
 g ErGSend
ErGS 
 x:$zv["MS" "s %=$zerr" s $zt=""
 i '%j,%di>0 u $p zw %,%g  w !,"<DKSER> - M_database_invalid - file=",%g r % s %di=-1 g revers
 s $zt=""
ErGSend 
 q:gList_%RL["?"  n o
 x "s o=$s($zv[""MS"":$zu(0),1:$znspace)"
 s %CMT=%file_" "_$g(%MET)_" --- "_o_" --- "_gList_" --- "_$zv
 n %iff s %iff=$p(gList,"/",2,99) s:%iff="" %iff=1
 s %if="s %zr=$q(@%zr),%=%zr[%g0&(%g2'=%zr)-1 s:'% %="_%iff
 s %s=" w !,%zr,!,@%zr "  i $zv["U) " s %s=" w !,$$U^MXF(%zr),!,$$U^MXF(@%zr) "
 i %file s %s=" w !,$tr(@%zr,$c(254),"","") "
 i %file\1=2 s %s=" w @%zr,! "
 i '%file,%file'["." s %file=%file_".ggg"  ;; ,%s="s %r=@%zr s:%r[$c(10) %r=$tr(%r,$c(10),""^"") w !,%zr,!,%r"
 s %=%file,$p(%,"\",$l(%,"\"))="x.x"  i $zv["MS" q:$$zos(2,%)=-5
 w:'%j ! 
 d OpenUseW
 w $$pD^MXD($h)_" "_$h,!,%CMT  s ^ERR=%s
 s %2=$$Uu^MXF($c(10)_$c(10)_$g(%UCIsave)_$c(10)_"{1076}{1072}{1085}{1085}{1099}{1077} {1089}{1086}{1093}{1088}{1072}{1085}{1077}{1085}{1099} {1074} {1092}{1072}{1081}{1083} "_%file_$c(10)_"saved in "_%file)
 s %nn=0,%g="" f  s %g=$o(%g(%g)),%g0="^" q:%g=""  d  q:'$d(%g)  s ^oTQMx(%USID,"saveUCI","%gg",%g)=" -saved "_$h  s ^oTQMx(%USID,"saveUCI","lastGlobal")=%g s:%g["zzzzzzz" @$zr=%2
 .s %1=%g,%g2="" u:'%j $p
 .i %1["^mM(" s %1=$p(%1,")")_".."
 .i %1[".." s %g0=$p(%1,"..",2) s:%1["..." %g0=$p(%1,"...",2) d  i 1
 ..s %1=$p(%1,".."),%1=$p(%1_",,,",",,,"),%1=$p(%1_")))))",")))))")_")"
 ..i %1["^mM(" s %=+$p(%1,"(",2) i % d  s %1="^mM("_+%_")" q
 ... s:%<0 %=-% n n,x s n=%,%=$o(^mM(""),-1),%=""
 ... i n<999 f x=1:1:n s %=$o(^mM(%),-1)\1 q:'%
 ... i n>971111 s:-n[-9 n=19_n d  i % s %=$o(^mM(%\1+.9))\1 s:'% %=99999
 ....  f x=1:1:400 s %=$o(^mM(%),-1)\1 q:'%  q:$$%D^MXD(%)<n
 ..i %g0="" s %g0=$p(%1,"(") q
 ..f  q:$l(%1,",")'>$l(%g0,",")  s %g0=","_%g0
 ..f %=1:1 s %2=$p(%1,",",%) q:%2=""  s:$p(%g0,",",%)="" $p(%g0,",",%)=%2
 ..i 0_%1'[(0_$p(%g0,"(")_"(") s:%g0 %g0="("_%g0 s $p(%g0,"(")=$p(%1,"(")
 ..i %1'[%g0 s %g2=%g0 s:%g2_0'[")0" %g2=%g2_")" s %g2=$q(@%g2),%g0="^"
 ..s %=$p(%g,"..")_".."_$e(%g0,2,99) s:$e(%g2)="^" %=%_$q(@%g2,-1)
 .e  q:'$d(@%g)
 .i $d(@%1) s:%g'[".."&(%g0="^") %g0=$tr($NAME(@%1),",",")") d
 ..s %if="s %zr=$q(@%zr),%=$tr(%zr,"","","")"")[%g0&(%g2'=%zr)-1 s:'% %="_%iff
 .s %zr=$NAME(@%1),n=0 
 .u:$zv["MS" 51 u:$zv["Ca" %file u:$zv["IRIS" %file u:$zv["MiniM" "|FILE|"_%file
 .i $d(@%1)#10=1 s %zr=$q(@%zr,-1) s:%zr="" %zr=$p(%1,"(")
 .f  x %if q:%<0  i % x %s s %nn=%nn+1,n=n+1 i $zv["MS"&$zc d  q
 ..k %g s %g=%zr
 I $zv["MS",'%file u 51 W !,"**",!,"**",!,!
 I $zv["MiniM",'%file u "|FILE"_%file w !,"**",!,"**"
 I $zv["Ca"!($zv["IRIS"),'%file u %file w !,"**",!,"**"
 d Close
 q
%RS q:'$l(%RL)
 n %r,%x,%mxWeb s %mxWeb=1 s %RL=$p(%RL,"/")
 s %="" f  s %=$o(^$ROUTINE(%)) q:%=""  d:%'["."
 .n o s o=% n % s %=$p(o," ")
 .f %x=1:1:$l(%RL," ") s %r=$p(%RL," ",%x) d
 ..i %=%r s %r(%)=1 q
 ..i %r["*",1_%[(1_$p(%r,"*")) s %r(%)=1 s:%RL["?" %RL=%RL_" "_% q
 ..q:%r'["-"  s %r=$tr(%r,"-","")
 ..i %=%r k %r(%) q
 ..i %r["*",1_%[(1_$p(%r,"*")) k %r(%)
 q:$g(%L)_%RL["?"
 s:%file'[".r" %file=$p(%file,".") s %CMT=$g(%MET)_" "_$g(%USER)_" "_%RL_" "_$$ts^MX1
 s %=%file,$p(%,"\",$l(%,"\"))="x.x"  q:$$zos(2,%)=-5  
 d OpenUseW
 w:$zv["IRIS" "IRIS/CACHE for Windows^INT^vmx.ro^~Format=IRIS.S~^RAW"
 w:$zv'["IRIS" "CACHE for Windows^INT^vmx.ro^~Format=CACHE.S~^RAW"
 w !,"%RO on ",$$ts^MX1    ;; MX^INT^1^65438,48483^0!,%CMT n r 
 s %r="" f n=1:1 s %r=$o(%r(%r)) q:%r=""  d  ;;  q:$zc
 . ;; k r x "zl @%r f %=0:1 s t=$t(@%r+@%) q:'$l(t)  s:t'["" ""&% t=t_"" ""  s r(%)=t"
 .k r f %=0:1:999 s t=$t(+%^@%r) i $l(t) s r(%)=t_$s(t'[" "&%:" ",1:"") s:'% r(%)=r(%)_"^INT^1^"_$h_"^0"
 .f %=0:1 s t=$g(r(%)) q:'$l(t)  s t=$$U^MXF(t) s:%RL["-msm" t=$$Uu^MXF(t) w !,t
 .w ! q:'$zc   ;;  q:%j
 .s n=0
 d Close
 q
%GR s %j=$g(%j) i '%j w $$w^USE("%GR^USDOS",2,2) q:%zb=27
 ;                                               routines: ^^  ;
 ; DOS-msm-file   DOS-file___?%file         /-mGlob1-mGlob2- ..
 ;         jaun(j) contr(k) _?%mode
 ;            msm-commands___?%xmsm         %f  %r  %sel=1
pKC 
  w:'%j $$yx^US(7,0)
  n oo,o2,%r,%f,%sel,%n,%nnn,%er,%ss,%g,f,timeStmp,%mMindex,o,oDelay,%wMail
  s %oldf=0,%nnn=0,%er="",%f="",%ss=0
  s %2=$p(%file,"/",2,99),%file=$p($p(%file,"/")_"  ","  ") d
  .f %=1:1:99 s f=$p($tr(%2,"+-","  ")," ",%) i f'="" s f("^"_f)=%2'["-"
 d Close
  s %er=0,o=$h 
 d OpenUse
  s zc=$zc,za=$za,zb=$zb,oDelay=$p($h,",",2)-$p(o,",",2)
  i %er s ^ooMX(%USID,"gr")=$h_" ERROR: "_%file_"-not open .. Delay="_oDelay  c $s($zv["MS":51,1:%file) q
  ;
  s $zt="grErr^USDOS"
  i $zv["MS" f %n=0:1 u 51  q:$zc<0  r %r#512 q:$zc<0  d  i %er s ^ooMX(%USID,"gr",$h)="  ERROR : %n="_%n_"  %r="_%r_"  %f="_$g(%f) q
  .q:$l(%r)=512  i '%j u $p i %n<2 w !,%r q
  .i %n#2=0  d:$e(%r)'="^"    s %f=%r,%g=$p(%f,"(") q
  .. f  u 51  r %r#512 q:$zc<0  i $e(%r)="^",%r'["Ca",%r'[" " q
  .i $e(%f)'="^" s %er=1 q
  .i $e(%f,$l(%f))'=")" s %er=1 q
  .i $g(f(%g))=0 s %f="",%r="" q
  .s %mMindex=2_%f,timeStmp=+$h
  .i $e(%f,1,4)="^mM(" k % s %="%("_$p(%f,",",2,99) d  q:%f=""!%cancel
  ..  s %cancel=0  ;; s %cancel=1   --- for exit from ^wMail
  ..  s (timeStmp,oo)=+$p(%f,"(",2),o2=$p(oo,".",2)
  ..  s:$l(o2)<6 $p(oo,".",2)=$e(o2+1000000,2,9),timeStmp=oo
  ..  i %'["^" s ^ERROR(%n)=%_"  %f="_%f_" %r="_%r_" %g="_%g,%cancel=1 q
  ..  i %r="",%f'["0^" s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)="%r?",%cancel=1 q
  ..  s @%=0,%mMindex=$o(%("")),%f=$e(%mMindex,2,999),%g=$p(%f,"(")
  ..  i $g(f(%g))=0 s %f="" q
  ..  i $d(f)>2 s %2=$o(f(0)) i f(%2),'$d(f(%g)) s %f="" q
  ..  i '$d(%wMail) s %wMail=$l($t(^wMail))
  ..  i %wMail,1_$$w^wMail(%mMindex,%r) q:%cancel
  ..  
  .i %f_")))"'["))))" s %f="",%r="" q
  .s %g=$e($p(%f,"("),2,99),%sel=1
  .i $l(%xmsm),%xmsm["%sel"  x %xmsm q:'%sel
  .i $l(%xmsm),%xmsm'["%sel" s %sel=0 d  q:'%sel
  ..  f o=1:1:$l(%xmsm," ") i %g=$p(%xmsm," ",o) s %sel=1 q
  .i %j s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)=%r
  .i '%mMindex k @%f s %nnn=%nnn-1 q
  .i '%j w *13,%f
  .i $d(@%f)#10=1 w:'%j "..ir" q:%mode["j"!(@%f=%r&(%r'["=FE"))
  .i %r["=FE",%r'[$c(254) s %rr=%r,%r="" f %=1:1:$l(%rr) d  s %r=%r_%1
  .. s %1=$e(%rr,%) q:%1'="="
  .. n a,b s a=$e(%rr,%+1),b=$e(%rr,%+2) i a_b="FE" s %1=$c(254),%=%+2 q
  .. s a=$s(a="A":10,a="B":11,a="C":12,a="D":13,a="E":14,a="F":15,1:a)
  .. s b=$s(b="A":10,b="B":11,b="C":12,b="D":13,b="E":14,b="F":15,1:b)
  .. s %1=$c(a*16+b),%=%+2
  .q:%mode["k"  s @%f=%r,%nnn=%nnn+1  ;; k=kontrole
  i $zv["MS" c 51 q
  d ReadTXT(%file,"^oFileTXT($j)") k ^omxERROR(%USID)
  f %n=1:1 s %r=$g(^oFileTXT($j,%n)) q:'$l(%r)&'$o(^(%n))  d  i %er s ^ooMX(%USID,"gr",$h)="  ERROR : %n="_%n_"  %r="_%r_"  %f="_$g(%f) q
  .i %n#2 d:$e(%r)'="^"  s %f=%r,%g=$p(%f,"(") q
  .. n % f %=1:1:99 s %n=%n+1,%r=$g(^oFileTXT($j,%n)) q:$e(%r)="^"
  .i $e(%f)'="^" s %er=1 q
  .i $e(%f,$l(%f))'=")" s %er=1 q
  .i $g(f(%g))=0 s %f="",%r="" q
  .s %mMindex=2_%f,timeStmp=+$h
  .i $e(%f,1,4)="^mM(" k % s %="%("_$p(%f,",",2,99) d  q:%f=""!%cancel
  ..  s %cancel=0  ;; s %cancel=1   --- for exit from ^wMail
  ..  s (timeStmp,oo)=+$p(%f,"(",2),o2=$p(oo,".",2)
  ..  s:$l(o2)<6 $p(oo,".",2)=$e(o2+1000000,2,9),timeStmp=oo
  ..  i %'["^" s ^omxERROR(%USID,$j,%n)=%_"  %f="_%f_" %r="_%r_" %g="_%g,%cancel=1 q
  ..  i %r="",%f'["0^" s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)="%r??",%cancel=1 q
  ..  s @%=0,%mMindex=$o(%("")),%f=$e(%mMindex,2,999),%g=$p(%f,"(")
  ..  i $g(f(%g))=0 s %f="" q
  ..  i $d(f)>2 s %2=$o(f(0)) i f(%2),'$d(f(%g)) s %f="" q
  ..  i '$d(%wMail) s %wMail=$l($t(^wMail))
  ..  i %wMail,1_$$w^wMail(%mMindex,%r) q:%cancel
  ..  
  .i %f_")))"'["))))" s %f="",%r="" q
  .s %g=$e($p(%f,"("),2,99),%sel=1
  .i $l(%xmsm),%xmsm["%sel"  x %xmsm q:'%sel
  .i $l(%xmsm),%xmsm'["%sel" s %sel=0 d  q:'%sel
  ..  f o=1:1:$l(%xmsm," ") i %g=$p(%xmsm," ",o) s %sel=1 q
  .   ;
  .s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)=%r
  .i '%mMindex k @%f s %nnn=%nnn-1 q
  .i $d(@%f)#10=1 q:%mode["j"!(@%f=%r&(%r'["=FE"))
  .i %r["=FE",%r'[$c(254) s %rr=%r,%r="" f %=1:1:$l(%rr) d  s %r=%r_%1
  .. s %1=$e(%rr,%) q:%1'="="
  .. n a,b s a=$e(%rr,%+1),b=$e(%rr,%+2) i a_b="FE" s %1=$c(254),%=%+2 q
  .. s a=$s(a="A":10,a="B":11,a="C":12,a="D":13,a="E":14,a="F":15,1:a)
  .. s b=$s(b="A":10,b="B":11,b="C":12,b="D":13,b="E":14,b="F":15,1:b)
  .. s %1=$c(a*16+b),%=%+2
  .q:%mode["k"  s @%f=%r,%nnn=%nnn+1 ;; k=kontrole
  q
grErr s $zt=""
 n o i $zv["Ca"!($zv["IRIS") x "s o=$zeof" i o<0 c %file q
 s ^ooMX(%USID,"gr")=$g(oDelay)+1_"sec. "_%file_" ERROR: za="_za_" "_$g(^ooMX(%USID,"gr"))
 d Close
 s $zt=""
 q
erGR s $zt=""
 d Close
 i $e(%file)'="^" s %X=$e(%file)_":" w $$DiList^USDOS(3,4)
 g %GR^USDOS
DKSERsav 
 ; save of globals (gList) to  DOS-file (%file) if <DKSER>!!!only
 ;---------------variant 1.---------
 ;  d save^USDOS                         ;  start of the program
save1 s %file=0,%MET=1,%RL=""
save2 s %file="C:\mm.ggg"                 ;  DOS-file
save3 s gList="mM Banka"                 ;  glob.list
save4 d %GS^USDOS
 q
GSave(gList,%file) 
 s %file=0,%MET=1,%RL=""
 d %GS^USDOS
 q
readTXT(%USID,%file,h1,h2,max) 
 ; read %file into ^oreadTXT(%USID)
 n n,r,r1,%,o,zr k ^oreadTXT(%USID) s zr=$zr,h1=$g(h1),h2=$g(h2),max=$g(max),^oreadTXT(%USID)=%file
 s:$zv'["MiniM" $zt="errReadT^USDOS"
 if $zv["Ca"!($zv["IRIS") open %file:("RS"::$CHAR(13)_$CHAR(10)):2 u %file if 1
 else  d OpenUse
 s ^oreadTXT(%USID)=^oreadTXT(%USID)_"  "_$p
 i $zv["MS" f n=1:1 r r q:$zc<0  s ^oreadTXT(%USID,n)=$tr($s($l(r)<500:r,1:$e(r,1,510)),h1,h2) i max>0,n>max q
 i $zv'["MS" f n=1:1 d  q:$zeof!(r1<0)  i max>0,n>max q
 . s r1="",r=""
 . f %=0:1:31000 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10,o=13 s r=$e(r,1,$l(r)-2) q
 . s:% ^oreadTXT(%USID,n)=$s($l(h1):$tr(r,h1,h2),1:r)
 i $zv'["MS",$zv'["Ca",$zv'["IRIS" f n=1:1 d  q:$zc<0  s:% ^oreadTXT(%USID,n)=$tr(r,h1,h2) i max>0,n>max q
 . s r1="",r=""
 . i h2=-13 f %=0:1:31333 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10 s r=$e(r,1,$l(r)-1) q
 . i h2+13 f %=0:1:31333 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10,o=13 s r=$e(r,1,$l(r)-2) q
 s ^oreadTXT(%USID)=^oreadTXT(%USID)_"  "_n-1
 d Close
 q
ReadTXT(%file,zr,h1,h2,max) 
 ;mx  read fileTXT into @zr
 s ^oERROR("ReadTXT",0)=$h_" "_%file_" "_zr
 q:"^o ^|"'[$e(zr,1,2)
 s:$zv'["MiniM" $zt="errReadT^USDOS"
 n n,r,r1,%,o k @zr s h1=$g(h1),h2=$g(h2),max=$g(max),%=0
 d OpenUse
 s ^oERROR("ReadTXT",0)=^oERROR("ReadTXT",0)_"  "_$p
 i $zv["MiniM" f n=1:1 r r q:$zeof  s @zr@(n)=$e($s($l(h1):$tr(r,h1,h2),1:r),1,510) i max,n>max q
 i $zv["MS" f n=1:1 r r q:$zc<0  s @zr@(n)=$e($s($l(h1):$tr(r,h1,h2),1:r),1,510) i max,n>max q
 i $zv["Ca"!($zv["IRIS") f n=1:1 d  q:$zeof!(r1<0)!(%>31332)  i max>0,n>max q
 . s r1="",r=""
 . f %=0:1:30000 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10,o=13 s r=$e(r,1,$l(r)-2) q
 . s:% @zr@(n)=$s($l(h1):$tr(r,h1,h2),1:r)
 s ^oERROR("ReadTXT",8)=$h_" "_(n-1)
 s @zr=n-1
 d Close
 s ^oERROR("ReadTXT",9)=$h_" "_(n-1)
 q
errReadT s $zt=""
 s:% @zr@(n)=$e($s($l(h1):$tr(r,h1,h2),1:r),1,$zv'["MS"*31_510) 
 n o s $zt="errReadE^USDOS"
 i $zv["Ca"!($zv["IRIS") x "s o=$zeof" i o<0 s @zr=n-1 c %file q
 d Close
 s ^oERROR("ReadTXT",9)=$h_" "_(n-1)
 s ^oERROR("ReadTXT",8)=" ERROR: "_$ze
 s @zr=^(8)
 q
errReadE s $zt=""
 i $g(zr)["^" s @zr=$g(n)-1 
 d Close
 q
txt2glob(zr) 
 s:'$d(zr) zr="^oFileTXT"
 f %=3:2 q:'$d(@zr@(%))  s i=^(%),r=^(%+1) x:$e(i)'="^" "s o=% f %=o:1:o+9 i $e($g(^(%)))=""^"" s i=^(%),r=^(%+1) q" d:$e(i,$l(i))'=")"  i $e(i)="^",i_12[")12" s @i=r
 . s o=% f %=o+1:1:o+5 i $d(^(%+2)),$e(^(%))'="^" s i=i_" "_^(%),r=^(%+1) q:$e($g(^(%+2)))="^"  q:i_12[")12"
 q %
TXTtoXML(%USID,sss,zr) 
 ; read file.XML into glob: @zr
 s b=-1 n win1257,code1257 s win1257=0 k ^oXMLo(%USID),^oTEST m ^oXMLo(%USID)=^oXMLo1(%USID) m ^oTEST=^oXMLo1(%USID) k ^oXMLo1(%USID)
 s code1257=" 240.253 226.198 231.241 237.243 251.221 238.216 199.240 205.244 200.211 207.246 194.181"
 s h1=$g(h1),h2=$g(h2),max=$g(max),%=0,x=0,row=1,bit=0,wide=0,bb=0,rr=""
 k @zr,ERR s b0=0,r=0,i="",iii=0,rrr="",ttt="",e="",start=0,L=0,r0="0",r1="0",x="",t="",%r0=0
 f b=0:1 d  q:r<0
 . i $l(rr)<15 s %=$q(^oXMLo(%USID)) i $l(%),$qs(%,1)=%USID s rr=rr_@% k @%
 . s %r1=%r0,%=$e(rr),rr=$e(rr,2,99999) ;; r *% i $zv'["Ca",%<0 q
 .  ;; i %="{",rr>127,rr<257,$e(rr,4)="}" s %=$c(+rr),rr=$e(rr,5,99999)
 . i %="" s r=-1 q
 . s %r=%,%=$a(%)  q:"-10-13-9-8-"[(-%_"-")  s %r0=%
 . s:$d(@sss@(%)) %r=@sss@(%) 
 . i %r="{",rr>127,rr<256,$e(rr,4)="}",$e(rr,5)="{" s %2=$g(@sss@(+rr_+$e(rr,6,8+1))) s ERR($tr(+rr_+$e(rr,6,8+1),"{"))=%2_"   "_rr i $l(%2) s (%,%r0)=+rr_+$e(rr,6,8+1),rr=$e(rr,$l(%)=7+10,99999),%r=%2
 . i %r="{",rr>127,rr<256,$e(rr,4)="}",$e(rr,5)'="{" s %2=$g(@sss@(+rr)) i $l(%2) s (%,%r0)=+rr,rr=$e(rr,5,99999),%r=%2
 . i %r="{",rr>127,rr<256,$e(rr,4)="}" s %2=$g(@sss@(+rr)) i $l(%2) s (%,%r0)=+rr,rr=$e(rr,5,99999),%r=%2
 . d:win1257&(%>150)  s:%r="<" start=1 q:'start  s r1=r0,r0=r,r=%r i r'=" "!$l(rrr) s rrr=rrr_r
 .. s o=$f(code1257," "_%_".") s:o>1 %r=$c($e(code1257,o,o+3)) s:o<1 ttt=ttt_-%_"?"
 . i rrr["1257",(rrr["WINDOWS-1257")!(rrr["windows-1257") s win1257=b
 . i $l(i) s:r'=">" i=i_r i ">"=r s:i'["/" $p(iii,",",L)=$p(i," ") i i[" "&(i'["/") s @zr@(b,L,iii,0)=rrr s rrr="",t="",L=L-1,i="" q
 . i r0="<",r'="/" s i=r,L=L+1 q
 . i $l(e) s:r'=">" e=e_r i r=">" s e="",start=0,iii=$p(iii,",",1,L) s:iii="" iii=L q
 . i t["-1257",t["WINDOWS-"!(t["windows-") s win1257=b
 . i $l(t)>32000 s r0="/>",r="",t="--ERROR--"_t
 . i r0_r="/>" s e="",$p(iii,",",L)=i s:$l(t) @zr@(b,L,iii)=t s L=L-1,i="",rrr="",t="" q
 . i r0_r="</" s e="</" s:$l(t) @zr@(b,L,iii,e)=t s L=L-1,i="",rrr="",t="" q
 . s:r=">" i="",e="" i '$l(e),'$l(i),"<>"'[r,r'=" "!$l(t) s t=t_r ;; s:%>150 t=t_%
 s @zr=b
 ;; d Close
 ;; s ^oERROR(%USID,"ReadXML",9)=$h_" "_(b-1)
 q
korrTXT(zr) 
 q ""
glo2rout(zr) 
 n n,Rout,oo,t,nn s n=2,oo="",nn=0 k ^r m ^r=@zr k ERR
 f  q:'$d(@zr@(n+1))  d
 . s n=n+1,t=@zr@(n) q:"*************  ;; "[t
 . i t'[" ",'t s Rout=$p(t,"^") s:Rout["(" Rout=""
 . q:'$l(Rout)
 . i $zv'["MiniM" x "zr  f  s n=n+1,t=$g(@zr@(n)),tt=0 s:$l(t)>255 ERR(Rout,n)=$l(t)_t s:$l(tt)>250!(tt["" ;"")!(tt[""%mxWarn"")!($zv[""MS"") t=$$Uu^MXF(t) zs:'$l(t) @Rout q:'$l(t)  zi t s nn=nn+1"
 . i $zv["MiniM" n r x "f n=n+1:1 s t=$g(@zr@(n)) s:$l(t)>250!(t["" ;"")!(t[""%mxWarn"") t=$$Uu^MXF(t) q:'$l(t)  s nn=nn+1,r(nn)=t" i nn>1,$$SAVE^%R(Rout,$na(r)) d compile^%RCOMPIL(Rout)
 . s oo=oo_Rout_":"_nn_" ",Rout="",nn=0
 q oo
listOfZN(xxx) 
 n oo,o,n,ns,%,%B s n="",oo="",%B=$c(254)
 i $zv["MiniM" s o=$v("db",15) f %=1:1:$l(o,"*") s ns=$p(o,"*",%) i ns'["%" s oo=oo_%B_ns,n=n+1
 x:$zv["Ca"!($zv["IRIS") "f %=1:1:$zu(90,0) s ns=$zu(90,2,0,%)  i ns'[""%"" s:%B_oo_%B'[(%B_ns_%B) oo=oo_%B_ns,n=n+1"
 ; ^%GD 
 q n_oo
ReadByte(%file) 
 n %,zr s:$zv["MiniM" %file=$tr(%file,"/","\") s zr="^oBytes(%USID)" k @zr,^mxMonito(%USID,"ReadBytJ")
 i $zv["Ca"!($zv["IRIS") x "s o=$zu(140,1,%file),zu=$s(o=-2:""file not found"",o=-3:""path not found"",o=-5:""access denied"",o=-12:""invalid access"",1:o)" i o'=zu q 0
 j ReadBytJ(%USID,%file) f %=0:1:99 q:$g(^mxMonito(%USID,"ReadBytJ"))  h .1 h:%>97 1
 ;; s ^mxMonito($$pD^MXD($h,2),3_%USID,"ReadBytJ")=%file_-%
 q $g(@zr,-%-1)
ReadBytJ(%USID,%file,zr) 
 s $zt="ReadBytE^USDOS"  s:'$d(zr) zr="^oBytes(%USID)"  ; read bytes
 d OpenUse s ^mxMonito($$pD^MXD($h,2),1_%USID,"ReadBytJ")=%file_" "_$t
 k @zr s ooo="",b=0
 f %=1:2 s b=b+1 r *r q:r<0  q:$zeof  s $e(ooo,%,%+1)=$e("0123456789ABCDEF",r\16+1)_$e("0123456789ABCDEF",r#16+1) s:%>30000 @zr@(b)=ooo,ooo="",%=-1
ReadBytE s:b>15000 @zr@(b)=ooo s @zr=$s(b>15000:-b,1:ooo)
 s ^mxMonito(%USID,"ReadBytJ")=b
 d Close
 q
ReadBMP(%file,zr,filtr) 
 ; mx  read file.BMP into @zr
 s:'$d(zr) zr="^oBMP" s ^oERROR("ReadBMP",0)=$h_" "_%file_" "_zr
 q:$e(zr,1,2)'="^o"  k @zr k b s b=-1
 s $zt="errReadB^USDOS"
 n b,n,r,r1,%,x,row,r0 k r s h1=$g(h1),h2=$g(h2),max=$g(max),%=0,x=0,row=1,bit=0,wide=0,bb=0
 d OpenUse
 s b0=0,r0=-1 f b=0:1 d  q:$zeof!(r<0)  ;; i max>0,b>max q
 . i b=33 s h=b(23)*256+b(22),b0=b(11)*256+b(10),bit=b(28),wide=256*b(19)+b(18),b4=4-($s(bit=24:3,1:1)*wide#4)#4
 . r *r q:$zeof  q:r<0  i bit=24,b0 r *r2  r *r3 s r=(r+r2+r3)\3_":"_r_":"_r2_":"_r3 
 . s:b<33 b(b)=r i b0,b'<b0 s x=x+1 s:x>(wide+b4) x=1,row=row+1,r0=-1 s:$d(filtr) r=r<filtr s:r'=r0 @zr@(-row,x)=r,r0=r,bb=bb+1
 s @zr=b
 d Close
 s ^oERROR("ReadBMP",9)=$h_" "_(b-1)
 q
errReadB s $zt="",b=+$g(b)
 i $g(zr)["^" s @zr=b-1 
 d Close
 q 
ReadXML(%USID,%file,zr,filtr) 
 ; read file.XML into glob: @zr
 s ^oERROR(%USID,"ReadXML",0)=$h_" "_%file_" "_zr
 k @zr s b=-1 n win1257,code1257 s win1257=0
 s code1257=" 240.253 226.198 231.241 237.243 251.221 238.216 199.240 205.244 200.211 207.246 194.181"
 s $zt="errReadX^USDOS"
 s h1=$g(h1),h2=$g(h2),max=$g(max),%=0,x=0,row=1,bit=0,wide=0,bb=0
 d OpenUse
 s b0=0,r=0,i="",iii=0,rrr="",ttt="",e="",start=0,L=0,r0="0",r1="0",x="",t="",%r0=0 ;;k ^xml
 f b=0:1 d  q:r<0
 . s %r1=%r0 r *% i $zv'["Ca",$zv'["IRIS",%<0 q
 . i $zv["Ca"!($zv["IRIS"),%<0!$zeof s r=-1 q
 . q:"-10-13-9-8-"[(-%_"-")  s %r0=% i %r1_%="196187" s t=$e(t,1,$l(t)-1)_"{315}" q
 . ;; i %r1_%="199205" s t=$e(t,1,$l(t)-1)_"{..199.205..}" q
 . s %r=$c(%) d:win1257&(%>150)  s:%r="<" start=1 q:'start  s r1=r0,r0=r,r=%r i r'=" "!$l(rrr) s rrr=rrr_r
 .. s o=$f(code1257," "_%_".") s:o>1 %r=$c($e(code1257,o,o+3)) s:o<1 ttt=ttt_-%_"?"
 . i rrr["1257",(rrr["WINDOWS-1257")!(rrr["windows-1257") s win1257=b
 . i $l(i) s:r'=">" i=i_r i ">"=r s:i'["/" $p(iii,",",L)=$p(i," ") i i[" "&(i'["/") s @zr@(b,L,iii,0)=rrr s rrr="",t="",L=L-1,i="" q
 . i r0="<",r'="/" s i=r,L=L+1 q
 . i $l(e) s:r'=">" e=e_r i r=">" s e="",start=0,iii=$p(iii,",",1,L) s:iii="" iii=L q
 . i t["-1257",t["WINDOWS-"!(t["windows-") s win1257=b
 . i $l(t)>32000 s r0="/>",r="",t="--ERROR--"_t
 . i r0_r="/>" s e="",$p(iii,",",L)=i s:$l(t) @zr@(b,L,iii)=t s L=L-1,i="",rrr="",t="" q
 . i r0_r="</" s e="</" s:$l(t) @zr@(b,L,iii,e)=t s L=L-1,i="",rrr="",t="" q
 . s:r=">" i="",e="" i '$l(e),'$l(i),"<>"'[r,r'=" "!$l(t) s t=t_r ;; s:%>150 t=t_%
 s @zr=b
 d Close
 s ^oERROR(%USID,"ReadXML",9)=$h_" "_(b-1)
 q
errReadX s $zt="",b=+$g(b)
 i $g(zr)["^" s @zr=b-1
 d Close
 q 
wrByte(%file,%glob,%len) 
 d OpenUseW
 s z=%glob f n=1:1 s z=$q(@z) q:'$l(z)  s rr=@z d
 . i %glob["^oFileExp(" w rr w:%len ! k @z q 
 . f %=0:2:$l(rr)-2 s FF=$e(rr,%+1,%+2) w $c($zh(FF))
 d Close
 q
WriteDBF(%file,formaDBF,tableDBF,tableDB2,nnnnnDBF,startTab) 
 s ooztoooo=$zt,$zt="WriteDB2^USDOS"
 i $e(tableDBF)="^" s o="",%=tableDBF,tableDBF="" f  s o=$o(@%@(o)) q:'$l(o)  s tableDBF=tableDBF_^(o)  
 i $e(tableDB2)="^" s o="",%=tableDB2,tableDB2="" f  s o=$o(@%@(o)) q:'$l(o)  s tableDB2=tableDB2_^(o)  
 d Close
WriteDB2 n rrrrrDBF,b s $zt="errReadD^USDOS",rrrrrDBF="",b=0,r=""
 i $zv["MS" open 51:(formaDBF:"R"):1 use 51
 i $zv["MiniM" open "|FILE|"_formaDBF:("rte") use "|FILE|"_formaDBF
 i $zv["Ca" open formaDBF:("R"::):1 use formaDBF
 i $zv["IRIS" open formaDBF:("R"::):1 use formaDBF
 i $zv'["MS" f b=0:1:999999 s r0=r,r="" r *r q:$zeof  q:r<0  s:b<9999 rrrrrDBF=rrrrrDBF_$c(r)
 i $zv["MS" f b=0:1:999999 s r0=r,r="" r *r q:$zc<0  s:b<9999 rrrrrDBF=rrrrrDBF_$c(r)
WriteDB x "n %FILE s %file=formaDBF h 1 d Close"
 s ^oERROR("ReadDBF",9)=$h_" "_(b-1),$zt=ooztoooo
 d OpenUseW
 s $e(rrrrrDBF,5)=$c(nnnnnDBF#256)
 w $e(rrrrrDBF,1,$s($g(startTab):startTab,1:225)),tableDBF,tableDB2,$c(r)
 d Close
 q
errReadD s $zt=$g(ooztooo) g WriteDB+1
 q
Close close $s($zv["MS":51,$zv["MiniM":"|FILE|"_%file,1:%file)
 q
OpenUse i $zv["MS" o 51:(%file:"R"):0 u 51
 i $zv["GT" o %file:"RS":1 u %file
 i $zv["Ca" o %file:("RS"::$CHAR(13)_$CHAR(10)):2 u %file
 i $zv["IRIS" o %file:("RS"::$CHAR(13)_$CHAR(10)):2 u %file
 i $zv["MiniM" open "|FILE|"_%file:("rte") u "|FILE|"_%file
 q
OpenUseW i $zv["MS" o 51:(%file:"NW"):1 use 51 q
 i $zv["Ca" o %file:("NWS"::):1 use %file q
 i $zv["IRIS" o %file:("NWS"::):1 use %file q
 d OpenUse
 q

USE^INT^1^65495,42075^0
USE ; MX select [ 01/10/2006  10:31 PM ]  ;[ 20160329 20:48:04 ]
 ; NiniM, MSM, CACHE, GT.M
 ; vmx Copyright(c) SIA ENTERS  2005-2016
yx(y,x,c) 
 q ""
R 
K 
e0 
E0 
 Q
%zb(h) 
 q ""
%zbr(r,h,y,x) 
 q:%j ""
 q r
ws(%zR,%yY,%xX,%4,%5) 
 k %v n %LineS  s %USPR=$g(%USPR,%USID)
 n %,%y0,%z0,%zRw,%y,%yM,%x,%xM,%w,%co,%0,%rest,%Scr,%z s %Scr="ws"
 s %co(1)=120,%co(3)=202,%co(0)=""
 x "s %zRw=$zr,%yY=$g(%yY,1),%xX=$g(%xX,1),%rest=1,%zb=0,%0=2"
 s %xM=$p(%xX_-79,"-",2),%yM=$p(%yY_-24,"-",2),%yY=+%yY,%xX=+%xX
 s:%yY<0 %yY=0 s:%xX<0 %xX=0 s:%yM>24 %yM=24 s:%xM>79 %xM=79
 n %zbR s %zbR=""
 d:'%j e0 x $g(%5)
 s:$g(%4)="" %4=206 s:+%4?3n %4="s %=$$yx("_%4_")" x %4
 i %zR?1.8e1"^".e,%zR'["(" n t d  s %zR="%w"
 .f %y=1:1 x "s t=$t("_$p(%zR,"^")_"+"_%y_"^"_$p(%zR,"^",2)_")" s t=$p(t,";",2) q:t=""  d
 ..s %=$p(t," ") s:%'="" %w(%y,%)=$p(t," ",2,999) q
 s %z=$g(^US("$$ws^USE",%USPR,%zR),$q(@%zR)) q:%z="" ""
 s:'$d(@%z) %z=$q(@%zR)
 s %=%zR,%y=%yY
 f %LineS=0:1 s %=$q(@%) q:%=""  s:%y<%yM %y=%y+1 d
 .  s %LineS(%LineS+1,1)=%,%LineS(%LineS+1,2)=@%
 s %yM=%y-1
 d e0
 k wsKey,wsLine,%vb
 ;  mxm -----------------------
 i %j d  q ""
 .s wsLine=+$g(^US(%USID,"ws^USE",%zR))
 .k %v,%ws,%wz,%zb s wsKey=$tr(wsKey,"RP-K","rp-k")
 .i '$g(wsLine) s %zb=27 q
 .s (%wz,%ws("$zr"))=%LineS(+wsLine,1),%zb=13
 .s (%ws(1),%ws)=$$%ws1(%wz)
 .s %v(%ws)=$s(wsKey["p":1,1:1,1:1,1:1,wsKey["r":"re",1:0)
 .i $zv'["Ca",$o(@%zRw)'="" i $o(@%zRw,-1)
 g %rest
%ws1(%wz) 
 q ""
l(%d,%col) 
 q ""
wl(%col) 
 q ""
pg(z,%d) 
 q ""
w1j(%USID,%n) 
 q
wj(%USID,%mEt) 
 q
w(%mEt,y0,x0,%20x,%rest) 
 q ""
%rest 
 q ""
%n(%q,%N) 
 q ""
wyx 
 q
n(%1,%2) 
 n %,%n,%3 f %=1:1:%ff i f(%)=%1 s %3=%f,%f=% d wyx s %f=%3 q
 q:$d(%2) %2  q $g(@%1)
%k(%QW,%k) 
 q ""
k 
 q
var(%QW,V) 
 Q ""
se(%zr,%x,gs,gk,y0,x0,%r,%8,gSEL,%10) 
 ; 2-%x      what found...
 ; 3-gs      g2_g3_(ind1)_g7_(ind3)      (x "s %g="_gs)  
 ; 4-gk
 ; 8-%8      s %SEL(-1)=%8  titul
 ; 9-gSEL    s %SEL(%k)=%g
 ; 10-%10     x %10          start
 n %1,%2,%k,%g,f,f0,%n,%file,%if,%LATV,%latv,%B
 k %SEL
 S %LATV="JQWERTYUIOPASDFGHKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{316}{311}{291}{326}{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}"
 s %LATV=$$Uu^MXF(%LATV_" /.;!#*:""""")
 s %latv=$$Uu^MXF("jqwertyuiopasdfghklzxcvbnmeuia{353}gkl{382}{269}neuialkgn{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}")
 s %B=$c(254),%8=$g(%8) s:%8="" %8="s %SEL(-1)="" ""_%x "
 x $g(%10)
 i $l(%8)>1,%8'["%SEL(" s %8="s %SEL(-1)="_%8
 s (%9,gSEL)=$g(gSEL) s:gSEL="" gSEL="s %SEL(%k)=%g"
 s y0=$g(y0,5),x0=$g(x0,40),%file=$e($p(%zr,"("),2,99)
 i '$d(%XI(%file)),$$x^USX(%file)
 i '$d(@%zr) s %SEL(0)=$NAME(@%zr)_" -nav ..."
 s %zr=$NAME(@%zr),f0=$e(%zr,1,$l(%zr)-1),%r=$g(%r,$c(254)),%if="["
 s:%x[%r %if=$p(%x,%r,2,99),%x=$p(%x,%r)
 i %if="~" s %if="$p(%zr,"")"",2,99)_"".""_$tr(%g,%LATV,%latv)[%x" d
 . s %x=$tr(%x,".~"_%LATV,".~"_%latv) q:%x'["~"
 . s %1=$p(%if,"["),%if=%1_"["""_$p(%x,"~")_""""
 . f %=1:1:$l(%x,"~") s %if=%if_"&("_%1_"["""_$p(%x,"~",%)_""")"
 s:$l(%if)<2 %if="%g"_$e(%if_"[")_"%x"
 s %gs="s %g=" f %=1:1:$l(gs,"_") s %n=$p(gs,"_",%) d
 .i $e(%n)'="(" s %gs=%gs_$$%XG(%file,%n,"@%zr")_"_%B_" q
 .s %n=$p($e(%n,2,99)_")))",")))"),%gs=%gs_$$%XI(%file,%n,"%zr")_"_%B_"
 s %11="__",gs=$p(%gs_%11,%11)
 i $e(%9)="("!%9 s gSEL="s %SEL(%k)=" f %=1:1:$l(%9,"_") d
 .s %n=$p(%9,"_",%)
 .i $e(%n)'="(" s gSEL=gSEL_$$%XG(%file,%n,"@%zr")_"_%B_" q
 .s %n=$p($e(%n,2,99)_")))",")))")
 .s gSEL=gSEL_$$%XI(%file,%n,"%zr")_"_%B_"
 s gSEL=$p(gSEL_%11,%11)
 s:gk'["=" gk="s %k="_$$%XI(%file,gk,"%zr")
 s %n=0 f %count=0:1:999999 s (%zr,f)=$q(@%zr) q:%zr'[f0!($s<1000)  x gs d
 .i @%if x gk s:%k=%g %g="~" i $l(%k),'$d(%SEL(%k)) x gSEL s %n=%n+1
 i %8'=0 s %1=$g(%SEL(-1)) k %SEL(-1) x %8 i $d(%SEL(-1)),%1'="" d
 .s %2=%SEL(-1),%SEL(-1)=%1,%1=$o(%SEL(""))-.1,%SEL(%1)=%2
 k %SEL(-1) q $d(%SEL)
%XG(%f,%n,%r) 
 n % i '$d(%XG(%f)) n %1 s %1=%f d ^USX
 q:%n="" "@%zr"
 i %n q "$p("_%r_",%B,"_+%n_")"
 s %=$p($tr(%XG(%f)," ",","),","_%n_"=$",2) s:%n %=$p(%XG(%f),"=$",%n)
 q "$p("_%r_","_$p(%,",",2)_","_+$p(%,",",3)_")"
%XI(%f,%n,%i) 
 n % s %=+$p($p($g(%XI(%f)),","_%n_"=$",2),",",4) s:%n %=%n
 q "$tr($p($p("_%i_",""("",2,9),"","","_%_"),"""""")"","""")"
%SEL(%zr,%K,%x) 
 ; %x="x %XG(%file) if ...  s o=...   s %SEL(o)=..." ; %R %I %k i1 i2 
 n %1,%2,%k,%0,%file,%I,%R,%B,i1,i2,i3,i4,i5,o,%count
 s %file=$e($p(%zr,"("),2,99) i $$x^USX(%file)
 S %1="JQWERTYUIOPASDFGHKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{316}{311}{291}{326}{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}"
 s %1=$$Uu^MXF(%1_" /.;!#*:"""""),%B=$c(254)
 s %2=$$Uu^MXF("jqwertyuiopasdfghklzxcvbnmeuia{353}gkl{382}{269}neuialkgn{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}")
 s %k=$tr(%K,%1,%2)
 s %I=$NAME(@%zr),%0=$e(%I,1,$l(%I)-1)
 f %count=0:1 s %I=$q(@%I) q:%I'[%0!($s<3000)  s %R=@%I d  x %x
 . f o=1:1:$ql(%I) x "s i"_o_"=$qs(%I,o)"
 . i $l(%R)=500,$d(@%I@(501)) s %R=%R_$g(^(501)) s %I=$NAME(^(501))
 q %count
wT(a,y,x,l) 
 q ""
clzr(%zr,i) 
 s %=%zr s:$e(%)="^" %=$p(%,"(",2,999),%=$e(%,1,$l(%)-1)
 s %=$p(%,",",i) i $e(%)="""" s %=$e(%,2,$l(%)-1)
 q %

USF^INT^1^65495,42075^0
USF ;  [ 04/05/2005  9:16 PM ]  ;[ 20170118 15:33:18 ]
 ; MSM, CACHE, GT.M,  MiniM
 ; MX Copyright(c) SIA ENTERS  2005-2016
yx(y,x,c) 
 q:%j ""
 q:$d(c) $$yx^US(y,x,c) q:$d(x) $$yx^US(y,x) q $$yx^US(y)
qs(%i,%KEY,%N,%d) 
 n %,%I,%n s %I=$qs(%i,0),%N=$tr($g(%N),"~"),%d=$g(%d)
 x:$zv'["GT.M" "f %=1:1:%KEY s %I=$d(@%I@($s(%=%KEY&$l(%N):%N,1:$qs(%i,%)))),%I=$zr"
 q:$d(@%I)#2 %I
 s:%d>0 %=$q(@%I) s:%d<0 %=$$zo500("%I@("""")",-1)
                  s:%d<0 %=$$zo500("%I@("""")",-1)
 i %'[%Zon q %I
 i %'=%I,%'="" s %I=%
 q %I
Zo(%i,%d) 
 n %,%1 s %d=$g(%d,1) s:'%d %d=1
 i %Zon="" i '$d(@("^"_%FILE)) q "^"_%FILE
 s:%i>%KEM!(%i=0) %i=%KEM
 i %i s:%I'["(" %I="^"_%FILE s %i=$p(%I,"(")_"("_$p(%LII,",",1,%i)_")"
 i %i'["("""")" s %i=$NAME(@%i)
 i %i'["(" s %i=%i_"("""")"
 s %=%i f  s %=$q(@%,%d) q:%=""  q:$l(%,",")=%KEM   ;;q:$ql(%)=%KEM
 q:%'[%Zon %I q %
r5(%zr) 
 n %,%R s $p(%zr,"(")="^"_%FILE,%R=$g(@%zr) q:$l(%R)<500 %R
 f %=501:500 q:'$d(@%zr@(%))  q:$l(%R)#500  s %R=%R_^(%)
 q:$d(@%zr)+1 %R
w5(%zr,%R) 
 n %,r i '$d(@%zr),$l(%R)<500 s @%zr=%R q ""
 i $d(@%zr@(501))
 f %=501:500 s r=$e(%R,%,%+499) q:r=""&'$d(^(%))  k ^(%) s:r'="" ^(%)=r
 s @%zr=$e(%R,1,500)
nE q ""
mxFsel(%i0,%N,%K,%SELflag) 
 n %sym,%XG,%nK,%KmxFsel,%,%1,%2,%3,%seZona,o,oo,xoo,%FILE
 k ^ose(%USID),^o60 s %N=$tr(%N,"~")
 s:'$d(%LAT) %LAT=$$Uu^MXF("QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326} .:`""")
 s:'$d(%lat) %lat="qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn"
 s %sym="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM%1234567890"
 s %1=%LAT,%2=%lat n %LAT,%lat s %LAT=%1,%lat=%2
 i $e(%K)="=" q:%K="="  s %K="("_%N_"="""_$p(%K,"=",2,9)_""").."
 i $e(%K,$l(%K))="=" s %K="("_%N_"="""_$p(%K,"=")_""").."
 i %K_"$1$a$s"[("....$1$a$s") q ""
 i %K_"$1$a$s"[("...$1$a$s") s o=%K n %K s %K=$p(o_"$1$a$s","...$1$a$s") q:o="" o  d
 . s o=$tr(%K,%LAT,%lat) s:o="" o=%K,%LAT=0,%lat=0 s %K="($tr(%I_%B_@%I,%LAT,%lat)["""_o_""").."
 s %FILE=$e($p(%i0,"("),2,99) s %KmxFsel=%K
 i $e(%i0)'="^" s (%1,%FILE)=$p(%i0,"(") d ^USX d:"PPR PAV"[%1
 . s o=%FILE_"sp" 
 . i '$d(^AL(%FILE,"%W",%N)),$d(^AL(o,"%W",%N)) s (%1,%FILE)=o d ^USX
 s %="^"_%FILE
 s:$d(%SeZona(%FILE))#2 %=%SeZona(%FILE)
 i %["^" s %seZona=$e($NAME(@%),1,$l($NAME(@%))-1)
 s %=$e(11_%K,$l(11_%K)-1,9999)
 i "::;;"[% d  q:$d(%SEL) ""  s %KmxFsel="1%N.."_%K s:%K="" %K="1%N" s %K=%K_".."
 .s %K=$p($p(%K,"::"),";;") k %SEL i $g(%SELflag),%K="" q  ;;;s:%K=$g(@%N) %K="" 
 .s %=$g(^AL(%FILE,"%W",%N,-2)) q:%=""  x %  q:$g(%SELflag)
 .s o="" f  s o=$o(%SEL(o)) q:o=""  w $$U^MXF(o),$c(9),$$U^MXF(%SEL(o)),$c(4)
 ; F12
 ; 
 k %1
 i $e($p(%K,";"))="[" s $p(%K,"[")="..;$p(%I,""("",2,99)_%R"
 s %nK=" "_%N_" "_$tr(%K,%sym_%K,%sym_"                                                       ")_" "
 s %XG="" f %=1:1:$l(%LG(%FILE),",") s %n=$tr($p(%LG(%FILE),",",%),"~") d
  . s:%nK[(" "_%n_" ") %XG=%XG_" s "_%n_"=$p(%R,%B,"_%_") "
 s:%K["^"!(%LI(%FILE)["~") %XG=%XG(%FILE)
 s:%XG'="" %XG="s %R=@%I s:$l(%R)=500 %R=$$r5(%I) "_%XG
 n %R,%NG,%GM,%nn,%nnn,%I,%I0,%KEM,%NSum,%n2
 n %,%1,%2,%3,%x,%x2,%xx,%xx2,%x1,%xecute,%g,%i
 ;; s %g=0 f %=1:1:$l(%LG(%FILE),",")  i $p(%LG(%FILE),",",%)=%N s %g=% q   ;; i $tr($p(%LG(%FILE),",",%),"~")=%N  s %g=% q
 s %i=0 f %=1:1:$l(%LII(%FILE),",") i $p(%LII(%FILE),",",%)=%N s %i=% q  ;; i $tr($p(%LII(%FILE),",",%),"~")=%N s %i=% q
 s %nn="%nn",%nnn="%nnn",%Nsum="%Nsum"
 s %x1=0,(%xx,%xx2)="",%NSum=0,%GM=$l(%LI(%FILE),","),^US(%USID,"%K")=%K
 f %=1:1:9 s (%x,%x2)=$p(%K,"..",%) d:%x'=""  I %x'="" s %xx=%xx_"("_%x_")&",%xx2=%xx2_"("_%x2_")&"
 .q:%x="1%N"  ;; sorted by %N
 .I %x="-%1" s %x="",%x1=-1 q
 .I %x="?AL" s %x="",%xecute="",(%i,%g)=0 d  q
 .. F %1=1:1:6 s %2=$g(%W(%N,%1)) I %2["%E" s %xecute(%1)=%2
 .I $e(%x,1,2)="//" s %3=$p(%x,"//",3),%2=$p(%x,"//",2),%xecute=%2,(%i,%g)=0 I %3'="" s %xecute=%3 x %2 s %x="" q
 .I $e(%x)="(",$e(%x,$l(%x))=")" s (%i,%g)=0 q
 .I $e(%x)="." s (%x,%x2)="-13509.18_"_%N_"[(-13509.18_"""_$e(%x,2,99)_""")" q
 .I "="[$e(%x) s %x=%N_"="""_$e(%x,2,99)_"""",%x2="%n2[(""^"_$e(%x2,2,99)_"^"")" q
 .s %1=$tr(%x,%LAT,%lat) s:%1="" %1=%x,%LAT=0,%lat=0 s (%x,%x2)="$tr("_%N_",%LAT,%lat)["""_%1_""""
 s %xx=$p(%xx_"&&&&&","&&&&&"),%xx2=$p(%xx2_"&&&&&","&&&&&")
 I %xx="",'$d(%xecute),'$d(%q),$l(%K) q -1
 k ^US(%USID,"mxFsel-1",%FILE) s %x=0
 I %x1=-1 k ^oM3(%USID) m ^oM3(%USID)=^US(%USID,"mxFse",%FILE)
 I %x1=-1 m ^US(%USID,"mxFse-1",%FILE)=^oM3(%USID) k ^oM3(%USID)
 s ^US(%USID,"mxASK",%FILE,%K)=%xx
 f %=1:1:%GM s %NG(%)=$tr($p(%LI(%FILE),",",%),"~") n @(%NG(%))
r2Fsel k ^US(%USID,"mxFsel",%FILE),^US(%USID,"mxFse",%FILE)
 s %I="^"_%FILE_"("""")",%nnn=0,%I0="^",%KEM=$l(%LII(%FILE),",")
 s %KEM=$l(%LII(%FILE),",")
 I $e(%i0)="^" s %=$d(@%i0) i %,%#2=0 s %I=$NAME(@%i0),%I0=$e(%I,1,$l(%I)-1)
 i %KmxFsel'="1%N.." f %nn=0:1 s %I=$q(@%I)  q:%I'[%I0  d:$ql(%I)=%KEM
 .i $d(%seZona) q:%I'[%seZona
 .I %x1=-1 q:'$d(^US(%USID,"mxFse-1",%FILE,%I))
 .x %XG,%XI(%FILE) i $d(^mxConfig("A")),'$$tAccess^US("A",%FILE) q  
 .;; i $d(%XG0(%FILE)) n %K s %XG0=0 f  s %XG0=$o(%XG0(%FILE,%XG0)) q:'%XG0  x %XG0(%FILE,%XG0) i $d(%K) s @($tr($p(%LI(%FILE),",",%XG0),"~"))=%K k %K
 .s %2=@%N
 .I $e(%KmxFsel)="=" s:%2["." %2=$p(%2_".............",".............")
 .s:%2="" %2="-"
 .i %xx'="" s @%N=%2 x "s %="_%xx i '% q:%2'["^"  s %n2="^"_%2_"^" x "s %="_%xx2 q:'%
 .s %NSum=%NSum+%2,@%N=%2
 .I $d(%xecute) x %xecute q:%K'["?AL"  n %xAL,%E,%K  d  q:%E=""
 .. s %E="",%xAL="",%K=@%N
 .. f  s %xAL=$o(%xecute(%xAL)) q:%xAL=""  x %xecute(%xAL) q:%E'=""
 .s %1=%I,%2=@%N q:%2=""  i "D8 d8 "[$p(%LII(%FILE),","),%KmxFsel'["1%N" s %2=0
 .s:$l(%2)>60 %2=$e(%2,1,60)_"__",^o60(%2)=$e(@%N,1,500)
 .I $d(^US(%USID,"mxFsel",%FILE,%2,1))!1 x " s ^("_%LII(%FILE)_")=%1"
 .s %nnn=%nnn+1,^US(%USID,"mxFse",%FILE,%I)=1
 ;
 i %KmxFsel="1%N.." s mxTEST("1%N..")=%i0
 i %KmxFsel="1%N..",%i=2,%i0["^",$qs(%i0,1)?6n s %I=%i0,%I0=$e(%I,1,$l(%I)-1)
 i %KmxFsel="1%N.." f %nn=0:1 s %I=$q(@%I)  q:%I'[%I0  d:$ql(%I)=%KEM
 .i $d(%seZona) q:%I'[%seZona  i $d(^mxConfig("A")),'$$tAccess^US("A",%FILE) q 
 .s:%i @%N=$qs(%I,+%i) x:%XG'="" %XG
 .f %3=1:1:$l(@%N,"^") s %2=$p(@%N,"^",%3) s:$l(%2)>60 %2=$e(%2,1,60)_"__",^o60(%2)=$e(@%N,1,500) d:$l(%2)
 ..s ^US(%USID,"mxFsel",%FILE,%2,%nn_"."_%3_1)=%I
 m ^ose(%USID)=^US(%USID,"mxFsel",%FILE)
 i '$d(^ose(%USID)),%seZona["(" s %seZona="" g r2Fsel
ose 
 q:'$d(^ose(%USID)) "" k ^oseooooo(%USID,-1) i $g(%SELflag) m %SEL=^ose(%USID) q ""
 n o,oo2,o2,oo,op,oMaxRetu,% s o=$NAME(^ose(%USID)),oo=0,oMaxRetu=16000 s:$zv["MiniM" oMaxRetu=7000
 f xoo=0:1 s o=$q(@o),o2="" d  q:o=""  q:$qs(o,1)'=%USID
 . i o'="",$qs(o,1)=%USID s o2=$qs(o,2)
 . i xoo,o2'=oo2 s %=oo2_$c(9)_$s(oo>1:oo,1:@op),^oseooooo(%USID,-1,xoo)=%,oo2=o2,oo=0
 . s oo=oo+1,op=o s:'$d(oo2) oo2=o2
 q:$g(%SELflag)="0" ""
 s o="" f  s o=$o(^oseooooo(%USID,-1,o),-1) q:'o  s oMaxRetu=oMaxRetu-$l(^(o))-2 q:oMaxRetu<0
 f  s o=$o(^oseooooo(%USID,-1,o)) q:'o  w $$U^MXF(^(o)),$c(4)  
 q ""
oseGet(node) 
 n o,oo,ll i '$d(node) g oseGetAl
 i '$d(^ose(%USID,node)) s o=$o(^ose(%USID,node)) q:o'[node $NAME(^ose(%USID,node))  s node=o
 s o=$NAME(^(node)),ll=0
 f  s o=$q(@o) q:o=""  q:ll>15000  q:$qs(o,2)'=node  q:$qs(o,1)'=%USID  d
 . s oo=$$zoIR^USX(@o,0),ll=ll+$l(oo)+2 i ll<15000 w $$U^MXF(oo),$c(4) k @o
 q $c(4)
oseGetAl ; get all
 q:'$d(^ose(%USID)) $NAME(^ose(%USID))  
 n o,oo,ll s o=$NAME(^ose(%USID)),ll=0
 f  s o=$q(@o) q:o=""  q:ll>15000  q:$qs(o,1)'=%USID  d
 . s oo=$$zoIR^USX(@o,0),ll=ll+$l(oo)+2 i ll<15000 w $$U^MXF(oo),$c(4) k @o
 q $c(4)
F6f 
RET 
FouStart 
vF ; mv
FOUND 
vFnext ; mv
FoundF12 
 q
%XG(%f,%n,%r) q:'$d(%XG(%f)) %n
 n % s %=$p(%XG(%f),","_%n_"=$",2) s:%n %=$p(%XG(%f),"=$",%n)
 q "$p("_%r_","_$p(%,",",2)_","_+$p(%,",",3)_")"
%XI(%f,%n,%i) q:'$d(%XI(%f)) %n
 n % s %=+$p($p(%XI(%f),","_%n_"=$",2),",",4) s:%n %=%n
 q "$tr($p($p("""_%i_""",""("",2,9),"","","_%_"),"""""")"","""")"
key 
 s %KEM=$l(%LII,","),%KEY=$l($p(","_%LII_",",","_%N_","),",")
 S:%KEY>%KEM %KEY=0 s:%KEY %NEW=%KEY
 q
zo500(%i,%d) 
 i %d'<0 s %=$q(@%i) s:%'[%Zon %=%i q %
 s %=%i
 i $zv'["GT" f  s %=$q(@%,%d) q:%=""  q:$ql(%)=%KEM
 i $zv["GT" f  s %=$q(@%,%d) q:%=""  q:$l(%,",")=%KEM
 i %'[%Zon s %=%i
 q %
 q

USMENU^INT^1^65495,42075^0
USMENU ; US*  [ 01/10/2006  10:43 PM ]  ;[ 20070324 17:08:44 ]
 ; M3-LITE, MSM-4.4x, CACHE-3x..5x, GT.M-5x
 ; Soft-in-cell  MX Copyright(c) SIA ENTERS  1997-2007
yx(y,x,c) 
 q:%j ""
 q:$d(c) $$yx^US(y,x,c) q:$d(x) $$yx^US(y,x) q $$yx^US(y)
m1xx(%) d %M q ""
%M1xx(%USID) 
 s %=$$RestMem^USX(%USID,"menu"),%=%menu
 ; JV
%M ; MENU - select 1 (with passw.), %=parametr !
 s $p(%,"\",5)=%USPR,%menu=%
%M2 
 I '%j,$zv["MSM" x "u $p:(:::::1)"
 k YY,x1,x2,y1,y2,S,%ZN,%ZN0
 I $zv["MSM" d
 .n a1,a2,a3,a4 s a1="Esc",a2="F2",a4="F9",a5="F10",a3="F5"
 .w:'%j $$w^USE("                               return?.a1 mMail?.a3 FILE?.a4 exit?.a5",24,1)
 F %=1:1:9 X "k %"_%_"  S %"_%_"=$P(%menu,""\"","_%_")"
 f YY=3:1 q:YY+$l(%menu," ")>(23-YY)
 S %ZN=$tr(%5,"^") S:%ZN="" %ZN=%USPR,$p(%menu,"\",5)=%ZN
 s %3=107
 s y1=$p(%2,"[",2),x1=$p(%2,";",2),y1=YY+1*'y1+y1
 f  s y2=y1+$l(%4," ")+2 q:y2<24  s y1=y1-1
 S x2=+$p(%2,";",4) s:'x2 x2=x1+30 s %=x2-x1+1 s:x2>79 x2=79,x1=x2-%
 w:'%j $$w^US(y1,x1,y2,x2,"b")
 i $zv'["GT.M" x "w:'%j $$yx(y1,x1+3),%1,""--"",$zu($zv[""Ca""*5),""--"",%ZN"
 F YY=1:1 S %0=$P(%4," ",YY) Q:%0=""  D
 .S %9=$T(@%0^@%ZN) S:$L(%9,"\")>4!(%9'[";\") %9=""
 .S:%9'="" $P(%4," ",YY)=%0_"^"_%ZN S:%9="" %9=$T(@%0)
 .I %9="" S %9="^"_$G(^AL(%0,"NAME")),YY(YY,3)="__^"_%0_"___"
 .E  S %9=$P(%9,"\",2,3),YY(YY,3)=%0
 .S YY(YY)=YY+y1,YY(YY,1)=%0,YY(YY,2)=$E(%9,1,x2-x1-7)
 .i %j,YY(YY,2)["izeja" s YY(YY,2)="(HIDE)"
 .s YY(YY,"c")=%3 s %=$$%lw(YY,x1,x2,107) Q
 S YY("max")=YY,%0=$g(^US(%USID,"%MENU",%menu,0),1)
 i '$d(^menu(%USPR)) s oo=$p(%menu,"\",4) f o=1:1:$l(oo," ") d
 .  s ^menu(%USPR,o)=%B_$p(oo," ",o)_%B_$p(%menu,"\")
 f YY=1:1:99,1 q:$g(YY(YY,1))=%0
 s %menuY0=YY
 i '%j d %L F  D  Q:13.27[%zb  d %L
 .s R=$$%zbr^USE("") S %3=$E(%zb,5,6)  
 .I +%zb=133 s R="s o=$$KALK^USF(40)",%zb=13 q
 .i %zb="0134" c 1 o 1 u 1 d ^%RE     q
 .i %zb=277984 d mMailF9^USDOS  s %zb=0 q
 .i %zb=277988 s R="d ^USDOS",%zb=13  q
 .i %zb=277989 d EXIT^USMENU          q
 .I "-127-8-279168"[-%zb              q
 .I %zb=13 s:R="" R=YY                q
 .I -%zb[-27,%3=65!(%3=66)  d         q
 ..w $$%lw(YY,x1,x2,107)
 ..S YY=YY-(%3=65)+(%3=66) S:YY=YY("max") YY=YY("max")-1 s:'YY YY=1
 .q  
 ;  mv
 ;;;;;;;;;zw %j r rrrrrr
w7xx i +%j=7 d  q
 .;;w "<html><title>menu</title>",!
 .;;w "<body>",!
 .k %XD82 i $$d8^MXD
 .w "<h5 align=""center"" >",$g(%XD82),"</h5>",!
 .;;w "<h5 align=""right"" >",$zu(0)," ",$zv,"</h5>",!
 .;;w "<h2 align=""center"" >",$$o^MX(%FIRMA),"</h2>",!
 .;;w "<h2 align=""center"" >",$$d8t^MXD($g(%XD82)),"</h2>",!
 .w "<table border=""1"" width=""90%"" align=""center"" >",!
 .w "<colgroup><col align=""right""><col span=""4"" align=""center"">"
 .w "</colgroup>",!
 .;;m ^mxv("YY")=YY
 .f o=1:1:99 q:'$d(YY(o))  d
 .. w "<pre><tr bgcolor=""khaki"" >"
 .. w "<td>",$$o^MX(YY(o,1)),"</td>"
 .. w "<td>",$$o^MX(YY(o,2)),"</td>"
 .. ;;w "<td>",$$o^MX(YY(o,3)),"</td>"
 .. w "</tr></pre>",!
 .w "</table>",!
 .;;w "</body></html>"
 q:%zb=27
 q:"."[R
SaveAndH 
 i R_"^^"["^^^",%j d  g %Mret
 .i $$%MSAVE(YY)
 .s ^JOB(%USID,"STOP")=1 f  h 1  q:'$d(^JOB(%USID,"STOP"))
 .h:'$d(^JOB(%USID))
 ;  mv
 I R Q:'$d(YY(R))  S YY=+R,R=$P(%4," ",+R)
 i R'[" " s:$e(R)["^" R=$e(R,2,99)
 I R[" ",%j  s o=$$%MSAVE(YY) x R             g %Mret
 I R[" " s o=$$%MSAVE(YY) x R                 g %Mret
 i R'["(",R'["," x "s %=$t("_R_")" i %'="" d  g %Mret
 . s o=$$%MSAVE(YY) d @R s %zb=0
 s o=$$%MSAVE(YY) i $d(^AL(R)),'R s o=$$Enter^USb(R)  halt:%j   g %Mret
 s o=$$ALR^USX(R) g %Mret
 q
RestMenu(%J,%menu) 
 s %=$$RestMem^USX(%J,%menu)
 q %menu
%Mret 
 S %MENU=+$O(^US(%USID,"%MENU",999),-1) q:%MENU<1
 s %menu=$g(^US(%USID,"%MENU",%MENU))
 k ^US(%USID,"%MENU",%MENU)
 g %M2
%MSAVE(y) 
 s %MENU=$o(^US(%USID,"%MENU",9999),-1)+1
 s:R'["EXIT" ^US(%USID,"%MENU",%MENU)=%menu,^(%menu,0)=YY(y,1)
 s ^(YY(YY,1))=$g(^US(%USID,"%MENU",%menu,1,YY(YY,1)))+1
 s %Scr=%MENU
 q ""
EXITxx d 00  ;\izeja
 i '%j k ^JOB(%USID) h
 h
00 
 q
%lw(y,x1,x2,c1,c2) 
 Q:'$D(YY(y)) ""   q:'$d(YY) ""
 n %,%3 s %=$g(^US(%USID,"MENU",%menu,1,YY(y,1))),%3=YY(y,"c")
 i '$d(c2) s c2=$s(%>30:247,%>11:207,1:%3)
 i c2<0 s (c1,c2)=3-$e(%3)_(7-$e(%3,2))_(7-$e(%3,3)) d
 .i c2=270 s c2=202 i YY(y,3)'["_^" s c2=242
 W:'%j $$yx(YY(y),x1+1,c1),YY(y,1),$e("_______",1,6-$l(YY(y,1)))
 w:'%j $$yx(c2)," ",YY(y,2),?x2 Q ""
%L q:'$d(YY)  q:'$d(YY(YY))
 n %,%1,x s %1=YY(YY,3),%=%1
 i %1["^" f x=1:1:9,"-" s %=$q(@($tr(%1,"_","")_"("""")"),-1)_x q:%["^"
 w:'%j $$%lw(YY,x1,x2,-1,-1) 
 w:'%j $$yx(YY("max")+y1,4+x1,%3),%,"  ",$e("               ",1,x2-x1-$l(%))
 Q

USOPEN^INT^1^65495,42075^0
USOPEN ; ;[ 20160310 22:27:24 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  1997-2016
 ; 
C q
UserDate(%1) 
 q $$NewDate^MXD
NewDate(%1) 
 q:'$d(%1) $$NewDate^MXD()  q $$NewDate^MXD(%1)
icDate(p1,p2) 
 q $$icDate^MXD(p1,p2)
d8(p1,p2) q ""
d9(d,mm) q $g(%DatUMs)
d8plus(d8,p) 
 q $$d8plus^MXD(d8,p)
mnew(m,p) 
 n %
 i p>0 f %=1:1:p s m=m+1 s:m#100=13 m=m+88
 i p<0 f %=1:1:-p s m=m-1 s:m#100=0 m=m-88
 q m
dd(x) n %
 i '$d(x)!$g(x) s %=$$d8(0) q ""
 s %=$$d8 q ""
%XD6 
D s %=$$d8(0) q
d8t(d8,mm) 
 q:'$d(mm) $$d8t^MXD(d8)  q $$d8t^MXD(d8,mm)
ZD q
pD(%H,t) 
 ; CONVERTS %H,$H ==> ggggmmdd hh:mm:ss
 q $$pD^MXD(%H,$g(t))
WeekDay(d8) 
 q $$WeekDay^MXD(d8)
time(h,r) ; Time
 n %1,%2
 s:'$d(h) h=$p($h,",",2) s %1=h\3600,%2=h#3600\60
 i '$d(r) q %1_":"_$e(%2+100,2,3)
 q %1_r_$e(%2+100,2,3)
CleAL 
 q
 ;;;;;;;;;;M-academija;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
x1 s d="06/13/00" w $tr("Dd.Mm.20Yy.g.","Mm/Dd/Yy",d)  ;;; 13.16.2000.g.
 q
x2 s x=12345,$e(x)=""  w x                             ;;; 2345
 q
x3 s x="",$e(x,3)=""   w 1,x,$l(x)                     ;;; 1  2
 q
x4 s x=12345,$e(x,9)=""  w x,$l(x)                     ;;; 12345   8
 q
korobov ; ;[ 11/24/00  12:49 PM ]
 s home=$io
 open 4 s ^OK=0
 u 4 write !,"ATDN3480229;"+$c(13)
 f  read r q:r["OK"  h 1
 u home write "Connected! :",r s ^OK=1
 u 4 w "ATH"+$c(13)
 u home w !,"Disconnected"
 close 4
 q

USPRINT^INT^1^65495,42075^0
USPRINT ; US* ; [ 08/01/2005  5:48 PM ]  ;[ 20140228 13:44:16 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX cellSoft Copyright(c) SIA ENTERS  2005-2014
%RUN 
 d R^USOPEN q:%zb=27 
 s %=$$%MMUSER^USX("^M")
 n %W s %W=$c(255) s %VaL=$s(%gm>201400:"EUR",1:"LVL")
 i '$l($g(flgPlusM)) s %="" f  s %=$o(^M(%V,%)) q:%=""  k:$p(%,":",2)=%USID ^M(%V,%) k ^rm(%USID,%V,%)
 i $l($g(flgPlusM)) q:$d(flgPlusM(%V,+%ggmm))  s flgPlusM(%V,+%ggmm)=2 n %ggmm s %ggmm=flgPlusM_":"_%USID_":*" 
 F %FileNum=1:1:33 S o=$p(%V(%V,6)," ",%FileNum) d:o'=""
 . s:o o=$p(o,+o,2,99) s %V(%V,6,$p(o,"^"))=1
 . d %FILE(o)
 d %PRINT
 q
%FILE(o) 
 n %R,%Rout,%FILE k %koko,koko,%SEL ;;s mxCHECK($h_o)=1
 s %FILE=$p(o,"^"),%Rout=$p(o,"^",2) s $p(%R,%B_0,99)=""
 s %=$$%xig^USX(%FILE) X %XG(%FILE)  s %VaL=$s(%gm>201400:"EUR",1:"LVL")
 i $e($g(xmsm),1,6)="%FILE=",xmsm'[%FILE,%FILE'="ciko" q
 i $t(@%FILE^@%Rout)'="" s oo="" d @%FILE^@%Rout q
 s o="StatusBar=1 label "_%FILE_" in rout "_%Rout_" not exist ! "_%V
 s oERROR(o)=%V,mxERROR=o
 q
%PRINT 
 k %koko,koko i $$%PrNode(%V,"^M")
 q
%PrNode(%PrNode) 
 k %d8start,ooLabels
 s:$e(%PrNode)'="^" %PrNode="^"_%PrNode
 d %Ru k ^rM($j,%V) i $l($g(flgPlusM)) s flgPlusM=""
 q ""
%Ru 
%RuRest 
 n %MiT,%Mi,%LGmax,%,%NNN,%NNE,%IT,%V4,%V4L,%V4M,%3,%i
 n %W,%M,%OLD,%Rold,%Mold,%R,%E,%NEW,%NiT,%PrFile,%zr
 s %W=$c(255),%PrFile=$p($g(%PrNode),"(")
 i %PrNode'["(" s %PrNode=%PrNode_"(%V,%ggmm)"
 i %PrNode["%V" s %PrNode=$p(%PrNode,"(")_"(%V,%ggmm"_$p(%PrNode,"%V,%ggmm",2,9) i %PrNode_"0"'[")0" s %PrNode=%PrNode_")"
 i $d(@%PrNode)!1 s %PrNode=$NAME(@%PrNode)
 k %Li
 S (%NNN,%IT)=0
 S %V4=%B_%V(%V,4.1) s:%V(%V,4.2)'="" %V4=%V4_%B_%V(%V,4.2)
 s (%V4L,%V4ML)=$L(%V4,%B),%V4M=%V(%V,4.3)
 s %3=%V(%V,3.1)
 f %=1:1:$l(%3,%B) s %i=$p(%3,%B,%) d
 .s %Mi(%)=%i,%Mi=%,%Mi(0,%)=%PrFile_"("_$tr($p(%3,%B,1,%),%B,",")_")"
 .s %Mi("%E",%)=%Mi(0,%)
 .i $qs(%PrNode,%)'="" n @%i s @%i=$qs(%PrNode,%)  
 .s (%Mi(0,-%),%Mi(1,-%),%Mi(-%))=$s($p(%PrNode,",",%)'="":@%i,1:"")
 .s %OLD(%Mi(%))="",%NEW=""
 s %Mi("%R")="",%Mi("%M")="",%Li=1 d %LiDn
 i %Li<%Mi k %Li q   ;;; dati nav atrasti ..........
 s %Li=%Mi i $o(@(%Mi(0,%Li)))
 f  s %R="" d  q:$g(%Li)<2!'$d(%V)  i %Li<%Mi,%Mi(-%Li)'="" d %LiDn q:%Li<2
 .i %Mi(-%Li)'="" s %R=$g(^(%Mi(-%Li))),%Mi(0,%Li)=$NAME(^(%Mi(-%Li)))
 .i %Mi(-%Li)="" s %Li=%Li-1
 .x:$zv["GT" "s %zr=$r" x:$zv'["GT" "s %zr=$zr"
 .i %Li=%Mi,%PrNode'[$e(%zr,1,$l(%PrNode)-1) s %Mi(-%)="",%Li=0 q
 .i %Li=%Mi,%V(%V,3.5)'="",%R'="" s %i=$o(^(%Mi(-%Li),"")) d  ;;3.5
 ..f  q:%i=""  s %MiT(%Li,%i)=^(%i),%i=$o(^(%i))              ;;3.5
 .i %R="" s %R=$g(%MiT(%Li)),%MiT(%Li)=""
 .i %R'="" d %R q:'$d(%V)  f %=1:1:%Mi s %OLD(%Mi(%))=%Mi(-%)
 .q:$g(%Li)<2  i $o(@%Mi(0,%Li))
 .s %Mi(-%Li)=$o(^(%Mi(-%Li))) s:%Li>2 @(%Mi(%Li))=%Mi(-%Li)
 q
%LiDn 
 n % i $d(@(%Mi(0,%Li)))
 F %=%Li+1:1:%Mi d  i %Mi(-%)="" s %=%-1 q
 .s %Mi(-%)=$o(^(%Mi(-%+1),"")) s @(%Mi(%))=%Mi(-%)
 .i %Mi(1,-%)'="" s (@(%Mi(%)),%Mi(-%))=%Mi(1,-%)
 .q:%Mi(-%)=""
 .s:1+$d(^(%Mi(-%))) %Mi(0,%)=$NAME(^(%Mi(-%)))
 s %Li=%
 q
%R 
 q:%Li<2  n %,%1,%2
 s %M=%Mi(0,%Li)
 s:%Li<%Mi %M=%M_%W
 s %Rold=%Mi("%R"),%Mi("%R")=%R,%Mold=%Mi("%M"),%Mi("%M")=%M
 S %IT=0,%OLD=%NEW,%NEW="",%E=%Mi(%Li)
 s:'$d(%LGmax(%E)) %LGmax(%E)=$l(@%E)+1
 s:$l(@%E)>%LGmax(%E) %LGmax(%E)=%LGmax(%E)+1
 i %V(%V)["?",%Li+1=%Mi,%Mi(%Mi)="%I" s %M=$p(%M,%W)
 i %V(%V,3.5)'="" x "s %=$$rv"_$p(%XV(%V),"$$wv",2)  ;;;;;(3.5)
 f %=3:1:%Mi s @%Mi(%)=$s(%Mi(-%)="":"*",1:%Mi(-%))
 s %1=$p(%V(%V,5),"-")
 f %=1:1:%Mi s %NEW=%NEW_" "_%Mi(%)_"="_%Mi(-%) q:%Mi(%)=%1
 i %V(%V,3.5)'="" s %v=%V(%V,3.5) n %r,%n
 F %=2:1:%V4L s %1=$p(%V4,%B,%) i '%1 s @%1=$P(%R,%B,%) d
 .s:'$d(%LGmax(%1)) %LGmax(%1)=$l(@%1)+1
 .s:$l(@%1)>%LGmax(%1) %LGmax(%1)=%LGmax(%1)+1
 I %V4M'="" S %1="" F %=%V4L+1:1 X "S %1=$O("_%V4M_"(%1))"  Q:%1=""  d
 . X "S "_%V4M_"(%1)=$P(%R,%B,%),%V4ML=%"
 S %2=$g(%MiT(%Li-1))    ;; $$%RsuM
 F %=2:1:$l(%V(%V,4.1),%B)+1,%V4L+1:1:%V4ML d
 . S $P(%2,%B,%)=$P(%2,%B,%)+$P(%R,%B,%)
 i $d(%V(%V,"4.p")) F %=2:1:$l(%V(%V,4.1),%B)+1,%V4L+1:1:%V4ML d
 .s %p=$p(%V(%V,"4.p"),%B,%-1) q:'%p
 .s %1=$P(%R,%B,%),%1=%1-$j(%1,0,%p),$p(%2,%B,%)=$p(%2,%B,%)-%1
 s %MiT(%Li-1)=%2
 i $d(%V(%V,"4.rm")),%V(%V,5)_"-"'[("-"_%E_"-") d
 . s %=$$rm^USX(%Mi("%E",%Li),%V(%V,"4.rm"))
 q:%V(%V,5)_"-"[("-"_%E_"-")
 S %NNE=" " i %M'[%W s %NNN=%NNN+1,%NNE=%NNN
 q:'$d(%Li)
 s %NiT=%E_"."_@%E
 d @(%V_"L^"_%Rout)
 q
%RsuM(%p) 
 q:%M[%W ""
 s %p=$g(%p)
 n %2,%sign S %2=$g(%MiT(%Li-1)) s %sign=$s(%p<0:-1,1:1)
 F %=2:1:$l(%V(%V,4.1),%B)+1,%V4L+1:1:%V4ML d
 .i %p s $P(%2,%B,%)=$P(%2,%B,%)+($P(%Mi("%R"),%B,%)*%sign) q
 .n %n
 .s %n=$p(%V(%V,4.1),%B,%-1),%n=$p(%Mi("%R"),%B,%)-@%n q:'%n
 .s $p(%2,%B,%)=$p(%2,%B,%)-$p(%Mi("%R"),%B,%)+%n
 s %MiT(%Li-1)=%2 k:%M'[%B @%M
 i %p,$d(%V(%V,"4.rm")),%M'[%W!(%p<-1) s %=$$wm^USX(%p)
 q ""
l(%lN,%i) 
 q:$d(%i) $$l^UST(%lN,%i) q:$d(%lN) $$l^UST(%lN) q $$l^UST

UST^INT^1^65495,42075^0
UST ;  ; [ 03/28/2005  1:10 AM ]  ;[ 20191011 20:24:39 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2016
 q
NTL ;  summa vardiem (LATVIA) ; kos
 N %,%0,N,NNN,T,TT,B,o   ; %1-ieeja    %2-izeja
 S %2="",B=" " S:%1<0 %1=-%1,%2="m{299}nus "
 s %0=$E($j(%1,0,2)\1+1000000000000,2,99)
 S:'%0 %2="nulle "
 F N=1:3:10 S NNN=$E(%0,N,N+2) I NNN D
 .S T=$$Uu^MXF("viens divi tr{299}s {269}etri pieci se{353}i septi{326}i asto{326}i devi{326}i desmit")
 .S %=NNN\100 S:%>1 %2=%2_$P(T,B,%)_" simti "
 .            S:%=1 %2=%2_$p(T,B,%)_" simts "
 .S TT=$$Uu^MXF("vien div tr{299}s {269}etr piec se{353} septi{326} asto{326} devi{326}"),%=NNN#100
 .I %>19 S %2=%2_$P(TT,B,%\10)_"desmit "_$P(T,B,%#10)_B
 .E  I %>10 S %2=%2_$P(TT,B,%-10)_"padsmit "
 .E  S %2=%2_$P(T,B,%)_B
 .S T=$$Uu^MXF("miljard s i miljon s i t{363}ksto tis {353}i")
 .s %2=%2_$P(T,B,N)_$P(T,B,NNN#10'=1+N+1)_B
 s o=$$Uu^MXF("ertuiopasdfghjklzxcvbnm{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}")
 S $E(%2)=$TR($E(%2),o,$$Uu^MXF("ERTUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}"))
 q
LS q
nt(N,w,val,p) ;; $132.25 would translate into: "One hundred thirty-two and 25/100-------dollars."  http://www.ehow.com/how_6495403_correct-spell-out-dollar-amounts.html#ixzz1pqytQoxq
 n t,tx,%2,% s w=$g(w),p=$g(p,2)_" "_w,tx="" s:'w w=60_" "_w
 i w["EN" n %1 s %1=N d NTU x "f %=1:1 q:$e(%2)'="" ""  s %2=$e(%2,2,999)" q $e(%2)_$tr($e(%2,2,999),$g(%LAT),$g(%lat))_$s($p(N,".",2):" and "_+$p($j(N,0,2),".",2)_"/100",1:"")_" --- dollars."
 s N=$j(N,0,$s(p:p,1:2)),%=+$p(N,"."),%=$e(%,$l(%)),%=$s(1[%:"s",1:"i") i $d(val) k:val["Lat" val
 s:$g(%gm)<201400 val=$g(val,"Lat"_%_";sant.") s:$g(%gm)>201400 val=$g(val,"EUR;cent")
 s %1=+$p(N,"."),N=$p(N,".",2) s:val="" N=$s('N:"",1:"."_N)
 d
 .i p["RU"!(p["r")!(val[$$Uu^MXF("{1091}{1073}"))!(val[$$Uu^MXF("{1059}{1041}")) d NTR q
 .i p["US"!(p["u")!(N["USD")!(N["$") d NTU q
 .d NTL
 s %=$s(val[";":";",val[" ":" ",1:".")
 i val["cent",N'="" s %2=%2_" "_$p(val,%)_" "_$s(p["US":"and ",1:"")_N_" "_$s(val["EUR":"euro",1:"")_"cent"_$s(N#10=1!(p["US"):"s",1:"i")
 i val'["cent"!(N="") s %2=%2_" "_$p(val,%) s:N'="" %2=%2_" "_N_" "_$p(val,%,2)
 f  q:$e(%2)'=" "  s %2=$e(%2,2,999)
 i p["US" s $p(%2,$p(val,%))=$e(%2)_$tr($e($p(%2,$p(val,%)),2,999),$g(%LAT),$g(%lat))
 q $$trw^UST(%2,"  "," ")
ntRU(s,v) ; {1095}{1080}{1089}{1083}{1086} {1090}{1077}{1082}{1089}{1090}{1086}{1084} RU,  {1074}{1090}{1086}{1088}{1086}{1081} {1087}{1072}{1088}{1072}{1084}{1077}{1090}{1088}: "{1074}{1072}{1083}{1102}{1090}{1072}:{1084}{1077}{1083}{1086}{1095}{1100}"  ({1085}{1072}{1087}{1088}{1080}{1084}{1077}{1088}: "{1076}{1086}{1083}{1083}.{1057}{1064}{1040}:{1094}{1077}{1085}{1090}")
 n R,i,A,S,t,n19
 s n19="{1086}{1076}{1080}{1085} {1076}{1074}{1072} {1090}{1088}{1080} {1095}{1077}{1090}{1099}{1088}{1077} {1087}{1103}{1090}{1100} {1096}{1077}{1089}{1090}{1100} {1089}{1077}{1084}{1100} {1074}{1086}{1089}{1077}{1084}{1100} {1076}{1077}{1074}{1103}{1090}{1100} {1076}{1077}{1089}{1103}{1090}{1100} {1086}{1076}{1080}{1085}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1076}{1074}{1077}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1090}{1088}{1080}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1095}{1077}{1090}{1099}{1088}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1087}{1103}{1090}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1096}{1077}{1089}{1090}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1089}{1077}{1084}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1074}{1086}{1089}{1077}{1084}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1076}{1077}{1074}{1103}{1090}{1085}{1072}{1076}{1094}{1072}{1090}{1100}"
 s t="",S="" s:s<0 t="{1084}{1080}{1085}{1091}{1089} ",s=-s s R=s\1 s:'R t=t_"{1085}{1091}{1083}{1100} "
 s t=$$Uu^MXF(t)
 i R f i=1:3:$l(R) s A=$e(R,$l(R)-1-i,$l(R)-i+1) d:A  s S=$$Uu^MXF(S)
 .s:i>4 S="{1084}{1080}{1083}{1083}{1080}"_$s(i=7:"{1086}{1085}",1:"{1072}{1088}{1076}")_$s(A#100\10-1&(A#10>1)&(A#10<5):"{1072}",A#10=1&(A#100\10-1):"",1:"{1086}{1074}")_" "_S
 .i i=4 s S="{1090}{1099}{1089}{1103}{1095}"_$s(A#100\10=1!(A#10>4)!(A#10=0):"",A#100\10-1&(A#10>1)&(A#10<5):"{1080}",1:"{1072}")_" "_S
 .i A#100\20=0!(A#10),A#100 s S=$p($s(A#100=1!(A#100=2):"{1086}{1076}{1085}{1072} {1076}{1074}{1077}",1:n19)," ",A#100>9&(A#100<20)*10+(A#10))_" "_S
 .s:A#100\20 S=$p("{1076}{1074}{1072}{1076}{1094}{1072}{1090}{1100} {1090}{1088}{1080}{1076}{1094}{1072}{1090}{1100} {1089}{1086}{1088}{1086}{1082} {1087}{1103}{1090}{1100}{1076}{1077}{1089}{1103}{1090} {1096}{1077}{1089}{1090}{1100}{1076}{1077}{1089}{1103}{1090} {1089}{1077}{1084}{1100}{1076}{1077}{1089}{1103}{1090} {1074}{1086}{1089}{1077}{1084}{1100}{1076}{1077}{1089}{1103}{1090} {1076}{1077}{1074}{1103}{1085}{1086}{1089}{1090}{1086}"," ",A#100\10-1)_" "_S
 .s:A\100 S=$p("{1089}{1090}{1086} {1076}{1074}{1077}{1089}{1090}{1080} {1090}{1088}{1080}{1089}{1090}{1072} {1095}{1077}{1090}{1099}{1088}{1077}{1089}{1090}{1072} {1087}{1103}{1090}{1100}{1089}{1086}{1090} {1096}{1077}{1089}{1090}{1100}{1089}{1086}{1090} {1089}{1077}{1084}{1100}{1089}{1086}{1090} {1074}{1086}{1089}{1077}{1084}{1100}{1089}{1086}{1090} {1076}{1077}{1074}{1103}{1090}{1100}{1089}{1086}{1090}"," ",A\100)_" "_S
 s t=t_S s:$l($g(v)) t=t_" "_$p(v,":")_" "_$p($j(s,0,2),".",2)_" "_$p(v,":",2)
 s $e(t)=$tr($e(t),$$Uu^MXF("{1096}{1074}{1087}{1086}{1076}{1095}{1089}{1084}{1090}{1085}{1084}"),$$Uu^MXF("{1064}{1042}{1055}{1054}{1044}{1063}{1057}{1052}{1058}{1053}{1052}"))
 q t
NTR ; ZPPROPIS ;{1057}{1059}{1052}{1052}{1040} {1055}{1056}{1054}{1055}{1048}{1057}{1068}{1070}  ;$DER$;   19890828  RUSSIA
 N RUB,KOP,I,A,MINUS,S,o
 S S=$j(%1,0,2)
 S MINUS=$$Uu^MXF($S(S<0:"{1052}{1048}{1053}{1059}{1057} ",1:"")),S=$J($S(S<0:-S,1:S),0,2)
 s KOP=S#1*100,RUB=S\1,S=$S(RUB:"",1:$$Uu^MXF("{1053}{1059}{1051}{1068}  "))
 I RUB F I=1:3:$L(RUB) S A=$E(RUB,$L(RUB)-1-I,$L(RUB)-I+1) I A D
 .I I>4 S S="{1052}{1048}{1051}{1051}{1048}"_$S(I=7:"{1054}{1053}",1:"{1040}{1056}{1044}")_$S(A#100\10'=1&(A#10>1)&(A#10<5):"{1040}",A#10=1&(A#100\10'=1):"",1:"{1054}{1042}")_" "_S
 .I I=4 S S="{1058}{1067}{1057}{1071}{1063}"_$S(A#100\10=1!(A#10>4)!(A#10=0):"",A#100\10'=1&(A#10>1)&(A#10<5):"{1048}",1:"{1040}")_" "_S
 .I A#100\20=0!(A#10),A#100 S S=$P($T(@$S(I'=4:1,A#100=1!(A#100=2):1000,1:1))," ",A#100>9&(A#100<20)*10+(A#10)+1)_" "_S
 .I A#100\20 S S=$P($T(10)," ",A#100\10)_" "_S
 .I A\100 S S=$P($T(100)," ",A\100+1)_" "_S
 s (%1,%2,S)="  "_MINUS_$tr($$Uu^MXF(S),";")
 Q
1 ;{1054}{1044}{1048}{1053} {1044}{1042}{1040} {1058}{1056}{1048} {1063}{1045}{1058}{1067}{1056}{1045} {1055}{1071}{1058}{1068} {1064}{1045}{1057}{1058}{1068} {1057}{1045}{1052}{1068} {1042}{1054}{1057}{1045}{1052}{1068} {1044}{1045}{1042}{1071}{1058}{1068} {1044}{1045}{1057}{1071}{1058}{1068} {1054}{1044}{1048}{1053}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1044}{1042}{1045}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1058}{1056}{1048}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1063}{1045}{1058}{1067}{1056}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1055}{1071}{1058}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1064}{1045}{1057}{1058}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1057}{1045}{1052}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1042}{1054}{1057}{1045}{1052}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1044}{1045}{1042}{1071}{1058}{1053}{1040}{1044}{1062}{1040}{1058}{1068}
10 ;{1044}{1042}{1040}{1044}{1062}{1040}{1058}{1068} {1058}{1056}{1048}{1044}{1062}{1040}{1058}{1068} {1057}{1054}{1056}{1054}{1050} {1055}{1071}{1058}{1068}{1044}{1045}{1057}{1071}{1058} {1064}{1045}{1057}{1058}{1068}{1044}{1045}{1057}{1071}{1058} {1057}{1045}{1052}{1068}{1044}{1045}{1057}{1071}{1058} {1042}{1054}{1057}{1045}{1052}{1068}{1044}{1045}{1057}{1071}{1058} {1044}{1045}{1042}{1071}{1053}{1054}{1057}{1058}{1054}
100 ;{1057}{1058}{1054} {1044}{1042}{1045}{1057}{1058}{1048} {1058}{1056}{1048}{1057}{1058}{1040} {1063}{1045}{1058}{1067}{1056}{1045}{1057}{1058}{1040} {1055}{1071}{1058}{1068}{1057}{1054}{1058} {1064}{1045}{1057}{1058}{1068}{1057}{1054}{1058} {1057}{1045}{1052}{1068}{1057}{1054}{1058} {1042}{1054}{1057}{1045}{1052}{1068}{1057}{1054}{1058} {1044}{1045}{1042}{1071}{1058}{1068}{1057}{1054}{1058}
1000 ;{1054}{1044}{1053}{1040} {1044}{1042}{1045}
NTU ;numeric by text USA,UK  ; T.JANKOVA  19990604 
 N RUB,KOP,I,A,MINUS,S
 S S=%1 S:'$g(S) S=0 s:S[.99 S=$j(S,0,2)
 S MINUS=$S(S<0:"MINUS ",1:""),S=$J($S(S<0:-S,1:S),0,2),KOP=S#1*100,RUB=S\1,S=$S(RUB:"",1:"NULL  ")
 I RUB F I=1:3:$L(RUB) S A=$E(RUB,$L(RUB)-1-I,$L(RUB)-I+1) I A D
 .I I>4 S S=$S(I=7:"MILLION",1:"BILLION")_$S(A#100\10'=1&(A#10>1)&(A#10<5):"",A#10=1&(A#100\10'=1):"",1:" ")_" "_S
 .I I=4 S S="THOUSAND"_$S(A#100\10=1!(A#10=0):"S",A#100\10'=1&(A#10>1):"",1:"")_" "_S
 .I A#100\20=0!(A#10),A#100 S S=$P($T(@$S(I'=4:"u1",A#100=1!(A#100=2):"u1000",1:"u1"))," ",A#100>9&(A#100<20)*10+(A#10)+1)_" "_S
 .I A#100\20 S S=$P($T(u10)," ",A#100\10)_" "_S
 .I A\100 S S=$P($T(u100)," ",A\100+1)_" HUNDRED"_$s(A\100>1:"",1:" ")_" "_S 
 s S=$tr($$Uu^MXF(S),";","")
 S S="  "_MINUS_S
 S %2=S
 Q
u1 ;ONE TWO THREE FOUR FIVE SIX SEVEN EIGHT NINE TEN ELEVEN TWELVE THIRTEEN FOURTEEN FIFTEEN SIXTEEN SEVENTEEN EIGHTEEN NINETEEN
u10 ;TWENTY THIRTY FORTY FIFTY SIXTY SEVENTY EIGHTY NINETY
u100 ;ONE TWO THREE FOUR FIVE SIX SEVEN EIGHT NINE
u1000 ;ONE TWO THREE FOUR FIVE SIX SEVEN EIGHT NINE TEN ELEVEN TWELVE THIRTEEN FOURTEEN FIFTEEN SIXTEEN SEVENTEEN EIGHTEEN NINETEEN
 q
l(%lN,%i,%x) 
 n %,%VFx4 k lUST
 q:'$d(%lN) ""
 n %b,%n,%p,%K,%w
 s $p(%b," ",$l(%lN)+1)=""
 s %lN=$tr(%lN,"^=-"_$c(176)_$c(177)_$c(178)_$c(179)_$c(202)_$c(203)_$c(205)_$c(206)_$c(207)_$c(209)_$c(199)_$c(186)_$c(197)_$c(196)_$c(195)_$c(194)_$c(193)_$c(192)_$c(190)_$c(187)_$c(182)_$c(218)_"|;#\][}{#&*!`:",%b)
 f %=1:1:$l(%lN) s:$e(%lN,%)'=" " %n=$p($p($e(%lN,%,%+99)," "),"^"),%w(%)=%n,%=%+$l(%n)-1
 s %="" f  s %=$o(%w(%)) q:%=""  d
 .s %n=$p($p($p(%w(%),"_"),"~")_"..","..")
 .s:$e(%n)?1n %n=$p(%n,+%n,2,99) s:%n="" %n="%K",%K=""
 .s:$d(@%n)#10=0 @%n=%n s %K=@%n
 .s %p=$l($p(%w(%),".",2))+(%w(%)["."*.0001)+(%w(%)["_"*.0001)
 .i '%K,%p," "'[%K s %K="- "
 .i %w(%)["~",%K\1=%K s %p=.0001
 .i %K,%p s %K=$j(%K,0,%p\1)
 .s:'$d(lUST) lUST(1)=%n s lUST(%n)=%K
 q ""
zos(%1,%2) 
 n % x "s %=$zos(%1,%2)" q %
jxml(%FILE) 
 k ^US(%USID,"xml^UST")  j xml(%USID,%FILE) f %=1:1:9 h 1 q:$d(^US(%USID,"xml^UST"))
 q:%>8 -9 q %FILE
xml(%USID,%FILE) 
 q
uni(s) 
 i %rus'[s q s
 n uni,%,%uni,%rusUNI   ;; a=&#1094;  a=garumz
 i '$d(%uni) d  f %=1:1:$l(%rus) s %uni($e(%rus,%))=$p(%rusUNI,";",%)
 . s %rusUNI="34;58;38;60;62;1105;1081;1094;1091;1082;1077;1085;1075;1096;1097;1079;1093;1098;1092;1099;1074;1072;1087;1088;1086;1083;1076;1078;1101;1103;1095;1089;1084;1080;1090;1100;1073;1102;"
 . s %rusUNI=%rusUNI_"1105;1081;1094;1091;1082;1077;1085;1075;1096;1097;1079;1093;1098;1092;1099;1074;1072;1087;1088;1086;1083;1076;1078;1101;1103;1095;1089;1084;1080;1090;1100;1073;1102"
 q $g(%uni(s),s)
p(t,h,n) 
 n o,oo i n>0 q $p(t,h,n)
 i 'n d  q oo
 . s oo=-1 f o=1:1:$l(t,h) i n=$p(t,h,o) s oo=o q
 f o=1:1:$l(t,h) s oo(o)=$p(t,h,o)
 q $g(oo(n+o+1))
trw(t,w1,w2,n) 
 i $zv["Ca"!($zv["IRIS"),'$d(n) q $replace(t,w1,$g(w2))
 n t2,%,nn s t2="",w2=$g(w2),nn=$l(t,w1) q:w1=""!(t'[w1) t
 i w2=" ",w1="  ",t'[$c(3) d  q $tr(t,$c(3))
 . f %=1:1:$l(t) i $e(t,%)=" "," "[$e(t,%+1) s $e(t,%)=$c(3)
 . f  q:$e(t)'=" "  s t=$e(t,2,999)
 f %=1:1:nn s %(%)=$p(t,w1,%)
 f %=1:1:nn s t2=t2_%(%)_$s(%<nn:w2,1:"") q:%=+$g(n)
 q:'$d(n) t2  i n'["L",n'["R" q t2
 q:t[$c(3) t  s w1=$e(w1)
 i n["L" f %=1:1:$l(t)-1 q:$e(t,%)'=w1  s $e(t,%)=$c(3)
 i n["R" f %=$l(t):-1:2 q:$e(t,%)'=w1  s $e(t,%)=$c(3)
 q $tr(t,$c(3)) 
 q

USX^INT^1^65495,42075^0
USX ; MX-SERVER [ 01/10/2006  10:11 PM ]  ;[ 20200420 11:49:30 ]
 ; MSM, CACHE, IRIS, GT.M, MiniM
 ; MX  Copyright(c) SIA ENTERS  2005-2020
 ; 
 N II,GG,%IG,%2,L,%FILE,%B,%,o,%n,%x s %=""
 S %FILE=$P(%1," "),%USPR=$G(%USPR,"%USPR"),%B=$c(254) q:"o"_%B[%FILE
 i '$l($g(%USID))!'$l(%FILE) s %mxWarng("^USX")="'$l($g(%USID)!'$l(%FILE)"_$g(%USID)_$g(%FILE) q
 i -$g(xC)[-56,$d(^mxConfig("A",%FILE)),'$d(^(%FILE,%USID)) s xC=-xC_"- access denyed",%mxWarng(xC)="^USX" q
 S II=$g(^AL(%FILE,"%LII")),GG=$g(^("%LG"))
 i $l(II)<1!($l(GG)<3) s:$d(@("^"_%FILE)) mxWarng(%FILE)=II_GG_$g(%V)_%B_$g(%I) q
 f %="II","GG" s @%=$p(@%_"    ","    ")
 S %2="s "_$p(GG,",",2)_"=$p(%R,"""_%B_""",2)"
 i (GG["~") s %2="s %B=$c(254)"
 s %x=1 F %=2:1:$L(GG,",") d
 . i GG["~" s %n=$p($p(GG,",",%),$c(13)) d  q
 . . ;;;q:%n["~~"
 . . i $e(%n)'="~" s %x=%x+1,%2=%2_","_%n_"=$p(%R,%B,"_%x_")" q
 . . s %n=$tr(%n,"~"),%2=%2_","_%n_"=$p($p(%R,%B_"""_%n_"="",2),%B)"
 . S:%>2 %2=%2_","_$P(GG,",",%)_"=$P(%R,"""_%B_""","_%_")"
 S %XG(%FILE)=%2
 s %2="n %,%q s %=$p(%I,""("",2,9),%=$p(%_0,"")0"")"
 F %=1:1:$l(II,",") S %2=%2_" s "_$p(II,",",%)_"=$p(%,"","","_%_")" d
 .s %2=%2_" s:$e("_$p(II,",",%)_")="""""""" "_$p(II,",",%)_"=$e("_$p(II,",",%)_",2,$l("_$p(II,",",%)_")-1)"
 s %2="s " d
 .f %=1:1 s %n=$p(II,",",%) q:%n=""  s %2=%2_%n_"=$qs(%I,"_%_"),"
 .s %2=$p(%2_",",",,")
 n %x1
 S %XI(%FILE)=%2,%x=$l(GG,",")+9,%x1=1  k %CON
 i GG'["~" S %CON(%FILE)="n %,%N,%B S %R=%SF,%B=$c(254) F %=2:1:"_$L(GG,",")_" S %N=$P("""_GG_""","","",%),%R=%R_%B_@%N "
 i GG["~" S %CON(%FILE)="n %,%N,%B S %R=%SF,%B=$c(254)" F %=2:1:$L(GG,",") s %n=$p(GG,",",%) d
 . ;;;q:%n["~~"
 . s:%n'["~" %x1=%x1+1,o="(%OLD("""_%n_"""),$p(%R,%B,"_%x1_"))="_%n
 . s:%n["~" o="$p(%R,%B,"_%x_")="""_$tr(%n,"~")_"=""_"_$tr(%n,"~"),%x=%x+1
 . s %CON(%FILE)=%CON(%FILE)_","_o
 S %LG(%FILE)=GG,%LII(%FILE)=II,%LI(%FILE)=$p($g(^AL(%FILE,"%LI"))," ")
 q
%XG(%1) 
 s %1=$p(%1,"(") s:$e(%1)="^" %1=$e(%1,2,22) q:'$l(%1) 0
 i $d(^AL(%1)) d ^USX q %1
 q 0
x(%1) d X q ""
xe(%USID,%xecute) 
 s %xUSX=%xecute s $zt="Erx^USX"
 n % x %xecute
 q
get(%1,%2) 
 n %n,%
 f %=1:1:$l(%1," ") s %n=$p(%1," ",%) i %n'="",'%n s @%n=$g(@%n,$g(%2))
 q ""
wm(%rm,%nn) 
 n %,%1,%r,%n,%x,%im,%j,%jq,%lrm,%rmx
 s %j=+%rm,%jq=0 i %rm s %rm=%V(%V,3),%nn=%V(%V,"4.rm")
 f %1=$l(%rm,$c(254)):-1:1 d
 .i %j<-1,%1>($l(%rm,$c(254))+1-%j) q
 .f %x=1:1:$l(%nn,$c(254)) s %n=$p(%nn,$c(254),%x) d:%V(%V,5)_"-"'[("-"_%n_"-")
 ..s %="" f  s %=$o(@%n@(%)) q:%=""  s %jq=@%n@(%)   d:%jq
 ...i %j s:%j>0 %jq=%jq-$j(%jq,0,%j) s:%j<0 %jq="-"_%jq q:'%jq
 ...s $p(%rm(%1,$c(255)_%),$c(254),%x)=%jq
 ...q:%V(%V)'["-"
 ...s $p(%rm(%1,$c(255)_%),$c(254),%x)="-"_%jq
 .s %im=$p(%rm,$c(254),1,%1) x "i $o(^rm(%USID,"_$tr(%im,$c(254),",")_",0))"
 .s %="" f  s %=$o(%rm(%1,%)) q:%=""  d 
 .. s %r=$g(^(%)),%lrm=$l(%rm(%1,%),$c(254))
 .. i %rm(%1,%)'["++",%r'["++" d  q
 ... f %x=1:1:%lrm s $p(%r,$c(254),%x)=$p(%r,$c(254),%x)+$p(%rm(%1,%),$c(254),%x)
 ... s ^(%)=%r
 .. n v,s
 .. f %x=1:1:%lrm s %rmx=$p(%rm(%1,%),$c(254),%x),s=$p(%r,$c(254),%x),$p(%r,$c(254),%x)=$$sv^fin("s++%rmx")
 .. s ^(%)=%r
 q ""
nE(%E) n % f %=1:1:99,0 q:$p(%V(%V,3.1),%B,%)=%E
 q %
rm(%e,%nn) 
 n %x,%n,% k %LineVAL
 i %e'[")" d  i '% s mxERROR=%e_" %e  $$rm^USX(%e,%nn) ?? " q ""
 .s %=$$nE(%e) q:'%
 .s %e=$p(%V(%V,3.1),%B,1,%),%e="^rm(%USID,"_$tr(%e,%B,",")_")"
 s $p(%e,",")="^rm(%USID,%V" 
 s:'$d(%nn) %nn=$g(%V(%V,"4.rm")) q:%nn="" ""
 f %x=1:1:$l(%nn,%B) s %n=$p(%nn,%B,%x),%=$g(@%n) k @%n s @%n=%
 i '$d(%V(%V,"rm")) s %=$c(255) d  ;; s:$zv["U_"&000 %=$c(55555) d
 .i $o(^rm(%USID,%V,%ggmm,%))'="" f  s %=$o(^(%)) q:%=""  s %V(%V,"rm",%)=$g(^(%))
 .i '$d(%V(%V,"rm")) f  s %=$o(^rm(%USID,%V,%)) q:%=""  s %V(%V,"rm",%)=^(%)
 .k ^rm(%USID,$j,%V) m ^rm(%USID,$j,%V)=%V(%V,"rm") k %V(%V,"rm") s %V(%V,"rm")=1
 s %="" i $e(%e,$l(%e))'=")" s %e=$e(%e,1,$l(%e)-1)
 f  s %=$o(^rm(%USID,$j,%V,%)) q:%=""  d:$g(%V(%V,4))["*"!($d(@%e@(%))#10)
 .s %rm=$g(@%e@(%)),%1=$e(%,2,99)
 .f %x=1:1:$l(%nn,%B) d
 .. s %n=$p(%nn,%B,%x),@%n@(%1)=$p(%rm,%B,%x)
 .. q:@%n@(%1)'["++"  n v,%
 .. f %=2:1:$l(@%n@(%1),"++") s v=$e($p(@%n@(%1),"++",%),1,3) d:v'=""
 ...  s %LineVAL(v)=$g(%LineVAL(v),%B)_%n_%B
 q ""
wv(%m,%g) 
 n %l,%i,% s %l=$l(%g,$c(254)),%i=$p($p(%m,"(",2),")")
 s @%i="" f  s @%i=$o(@%m) q:@%i=""  s %r=$g(^(@%i)) d  s ^(@%i)=%r
 .f %=1:1:%l s %n=$p(%g,$c(254),%) i %n'="" s:$g(@%n) $p(%r,$c(254),%)=@%n+$p(%r,$c(254),%)
 q ""
rv(%m,%g) 
 n %l,%i,%r,%rr s %l=$l(%g,%B),%i=$p($p(%m,"(",2),")")
 f %=1:1:%l s %n=$p(%g,%B,%) k:%n'="" @$p(%n,"(")
 s @%i="" f  s @%i=$o(%MiT(%Li,@%i)) q:@%i=""  d
 .s %r=%MiT(%Li,@%i),%rr=$g(%MiT(%Li-1,@%i)) k %MiT(%Li,@%i)
 .f %=1:1:%l s %n=$p(%g,%B,%) d:%n'=""
 ..x "s "_%n_"=$p(%r,%B,%)"
 ..s $p(%rr,%B,%)=$p(%rr,%B,%)+$p(%r,%B,%)
 .s %MiT(%Li-1,@%i)=%rr
 q ""
%xgl 
 s (%xgl(0),%xgl(1),%xgl(-1))=";"  q:'$d(^AL(%FILE,"Gf"))
 F %=-1,0,1 S %xgl(%)=$G(^AL(%FILE,"Gf",$P("OFF PRE ON"," ",2+%)))
 k %xglm  m %xglm(%FILE)=%xgl
 Q
X 
 N A S A=%1 D USX 
 q
%xig(%1) 
 s (%XG(%1),%XI(%1))="" d:$d(^AL(%1)) X
 q ""
%MMUSER(%PrFile,%Vch) 
 n %v,%1,%2,%,%n,L,oo,o
 S L=$T(@%V^@%USPR) Q:L="" ""
 n Vq s Vq=""
 F %L=2:1:15 S %1=$P(L,"\",%L) D  S %v(%L)=%1
 .s %=$p($g(%Vch),"\",%L) s:$l(%) %1=%
 .s %1=$p(%1_"     ","     ") s:%1="-" %1=""
 .i $e(%1)="@" d
 ..  s %=$p($e(%1,2,99)," ") s:%="" %=%V
 ..  s %2=$p($t(@%+(%=%V)^@%USPR),"\",%L)
 ..  s:%2="" %2=$g(@%) s %1=$p(%2_" "_$p(%1," ",2,99)_"   ","   ")
 .i %L<8 s Vq=Vq_" ;"_%L_" ?%v("_%L_") "
 s:%v(3)'[%B %v(3)=$tr(%v(3),",",%B)
 i %v(4)["@" s $p(%v(4),"@",2)=@$p(%v(4),"@",2),%v(4)=$tr(%v(4),"@")
 s %v(4)=$tr(%v(4)," ",%B),%=$p(%v(4),"=",2) 
 f o=1:1:$l(%,%B) s oo=$p(%,%B,o) s:%B_%v(3)_%B[(%B_oo_%B) $p(%,%B,o)=1
 f o=1:1:$l(%,%B) s oo=$p(%,%B,o) s:%B_$p(%v(4),"=")_%B[(%B_oo_%B) $p(%,%B,o)=1
 s:%[(%B_1) %=$$trw^UST(%,%B_1),$p(%v(4),"=",2)=%
 S:%B_%B_%v(3)'[(%B_%B_"%V"_%B) %v(3)="%V"_%B_"%ggmm"_%B_%v(3)
 S:$E(%v(5))="-" %v(5)=$P(%v(3),%B,2)_%v(5)
 S:%B_%v(3)_%B'[(%B_$P(%v(5),"-")_%B) %v(5)=$P(%v(3),%B,2)
 f %=1:1:$l(%v(3),%B) s %n=$p(%v(3),%B,%) i $e(%n)["-" d
 . s %v(5)=%v(5)_%n,$p(%v(3),%B,%)=$e(%n,2,99)
 S %v(6)=" "_$tr(%v(6),","," ")_" "
 i mxConfig[":^z5:",%v(6)["ciko",%v(6)'["z5" s %v(6)=%v(6)_"z5 "
 i %v(7)[" " x %v(7)
 s %v(4)=$g(%v(14))_%v(4) k %v(14)
 i $$%XV(%PrFile)
 merge %V(%V)=%v
 q ""
%XV(%PrFile) 
 N H,%,%2,%3,%4,%4M,%E,x,%22,o 
 s %PrFile="^"_$tr(%PrFile,"^","")
 f %="%v(3)","%v(4)" s:@%'[%B @%=$tr(@%,",",%B)
 s %v(3.5)=$p(%v(3),"*",2),%v(3.1)=$p(%v(3),"*")
 i %v(3.5)["(" f %=1:1:$l(%v(4),%B) d
 .s x=$p(%v(4),%B,%)
 .q:$tr(x,"()",",,")'[$tr(","_$p(%v(3.5),"(",2),"()",",,")
 .s $p(%v(4.5),%B,%)=x s $p(%v(4),%B,%)=1 q
 s %v(4.3)="",%=%v(4)
 i %v(4)'["*)",%v(4)'["(*" s %v(4.3)=$p(%v(4),"*",2),%=$p(%v(4),"*")
 s %v(4.2)=$p(%,"=",2),%v(4.1)=$p(%,"=")
 f %=1:1:$l(%v(4.1),%B) s x=$p(%v(4.1),%B,%) d:",*)"[$e($p(x,"(",2)_0)
 .s x=$p(x,"("),$p(%v(4.1),%B,%)=2
 .s %v("4.rm")=$g(%v("4.rm"))_$s($d(%v("4.rm")):%B,1:"")_x
 S %3=%v(3.1),%4=%v(4.1),%4M=%v(4.3)
 s %2="" f %=1:1:$l(%4,%B) s %n=$p(%4,%B,%) d:%n!%2!(%n["_")
 .q:%n=+%n
 .i %n["_" s %n=$l($p(%n,".",2))_$p($p(%n,"."),"_")
 .s:%n %2=+%n,%n=$p(%n,+%n,2,99),$p(%4,%B,%)=%n
 .s $p(%v("4.p"),%B,%)=%2
 s %v(4.1)=%4 s:$l(%v(4.2)) %4=%4_%B_%v(4.2)
 s %v(.34)=%3_%B_%4
 s %4=$L(%v(4.1),%B)+1_%B_%4,H=""""_%B_""""
 s %2="n %zr S %zr=$NAME("_%PrFile_"("_$tr(%3,%B,",")_")),%R=$g(@%zr) i $e(%zr,1,$l(%zr)-1)[$e($g(%V(%V,""xMrm"")),1,$l($g(%V(%V,""xMrm"")))-1) s ^("
 s:'$d(%V(%V,"xMrm")) %2="S ooozr=$NAME("_%PrFile_"("_$tr(%3,%B,",")_")),%R=$g(@ooozr),^("
 s %E=$p(%3,%B,$L(%3,%B))
 s %2=%2_%E_")=" F %=2:1:%4 d
 .s %1="_" s:%=2 %1="" i $p(%4,%B,%) s %2=%2_%1_H
 .e  s %2=%2_%1_H_"_($p(%R,"_H_","_%_")+"_$P(%4,%B,%)_")"
 f %=%4+1:1:$L(%4,%B) s %2=%2_"_"_H_"_"_$P(%4,%B,%)
 i %4M'="" s %2=%2_"_"_%B_"_$P(%R,%B,"_($L(%4,%B)+1)_",99) N I,% S I="""" F %="_($L(%4,%B)+1)_":1 S I=$O("_%4M_"(I)) Q:I=""""  S:"_%4M_"(I) $P(^("_%E_"),%B,%)=$P(%R,%B,%)+"_%4M_"(I)"
 i %v(3.5)'="" s %2=%2_" i $d(^("_%E_",1))+1,1!$$wv^USX("""_%v(3.5)_""","""_%v(4.5)_""")"
 i $g(%v("4.rm"))'="" s %2=%2_" i 1!$$wm^USX("""_%v(3.1)_""","""_%v("4.rm")_""") "
 s %XV(%V)=%2
 q ""
wParVM(%USID,%n,%q) 
 q ""
VarsMe1(%zr) 
 n %1,%2,%3,% s %="%",%3="",%1=251 i $d(@%zr@(1))
 f  s %=$o(@%) q:%=""  i %'="%",%'?1"%"1n,$d(@%)#2,$l(@%)<999 d
 .s %3=%3_$c(4)_%_"="_@% q:$zv["M3"  q:$l(%3)>15000
 .i $l(%3)>250 f  d  q:$l(%3)<250
 .. s ^(%1)=$e(%3,1,250),%3=$e(%3,251,9999),%1=%1+250
 s ^(%1)=%3_$c(4)
 q $d(@%zr)
SaveJob(%1,%2,LiOfMvar) 
 n %mxWeb     job SaveMem(%1,%2,$ZPARENT):(:1):1   q $d(^oAllVars(%1,%2))
SaveMem(%1,%2,LiOfMvar) 
 s:'$d(%2) %2=$g(%1),%1=%USID
 n % s:0[$g(%2) %2=0 s:0[$g(%1) %1=%USID i %2'<0,$d(%mxWeb) q %2
 k ^oAllVars(%1,%2) s ^(%2,"$j")=$j i $g(LiOfMvar) s ^("$j")=+LiOfMvar,LiOfMvar=""
 i $l($g(LiOfMvar)) d  q $g(%11)
 . i LiOfMvar="%FILE" s %=$tr(%LI(%FILE),",~"," ") q:'$l(%)  s LiOfMvar=%_" %xgl() %xglm() %G() %W() %FILE %gFILE %GM %I %LG %K %KEM %N %B %SF %NEW %LIv" 
 . s ^oAllVars(%1,%2,-1)=LiOfMvar
 . f %11=1:1:$l(LiOfMvar," ") s %=$p(LiOfMvar," ",%11) i $l(%) x:%["()" "s %=$p(%,""()"") m:$d(@%) ^oAllVars(%1,%2,%)=@% i $d(^oAllVars(%1,%2,%))" s:$d(@%)#2 ^(%)=@%
 i $d(%mxWarng) k ^o($j,"%mxWarng") s %=$s($zv["GT":"$R",1:"$zr") x "m @"_%_"=%mxWarng s @"_%_"=$g(%mxForma)_"" ""_$$pD^MXD($h,2) k %mxWarng"
 s %="%" g:$zv'["MS" SaveMem3 
 f  s %=$o(@%) q:%=""  i $e(%)'="$"," %0 %1 %2 %USID o oo ooo "'[(" "_%_" ") d:$d(@%)>1  i $d(@%)#2 s ^(%)=$e(@%,1,500)  i $l(@%)>500 f %22=501:500:$l(@%) s ^(%,%22)=$e(@%,%22,%22+499) i $d(^oAllVars(%1,%2,%))
 . n %11 s %11=%_"("""")"
 . f  s %11=$q(@%11) q:%11=""  i $d(@%11)#2 s ^(%11)=$e(@%11,1,500) d
 .. i $l(@%11)>500,'$d(^(%11,1)) d  i $d(^oAllVars(%1,%2,%))
 ... f %22=501:500:$l(@%11) s ^(%22)=$e(@%11,%22,%22+499)
 q ""
SaveMem3 
 s ^oAllVars(%1,%2,1)=$h,%="%" ;; s:$zv["M3" %="%1J"
 f  s %=$o(@%) q:%=""  i $e(%)'="$",$e(%,1,2)'?1"%"1n," %USID %msm8uni cMSM2Uni "'[(" "_%_" ") s:$d(@%)#2 ^(%)=@% i $d(@%)>1 m ^oAllVars(%1,%2,%)=@% i $d(^oAllVars(%1,%2,%)) 
 q ""
CopySave(%) 
 n %1
 k ^oAllVars(%USID,%),^oM3(%USID)
 m ^oM3(%USID)=^oAllVars(%USID,0) m ^oAllVars(%USID,%)=^oM3(%USID)
 k ^oM3(%USID)
 s %=0,%1="" f  s %=$o(^oAllVars(%USID,%)) q:%=""  s %1=%1_%_$c(4)
 q %1
RestMeKi(%USID,%xxx0,%noKILL) 
 q:'$d(^oAllVars(%USID,%xxx0)) ""
 i $$RestMem(%USID,%xxx0,$g(%noKILL))
 k ^oAllVars(%USID,%xxx0)
 q 1
RestAdd(%1,%2) 
 i $d(^oAllVars(%1,%2,1))
 n % s %=999 f  s %=$o(^(%)) q:'$l(%)  i $e(%)'="$",'$d(@%) m @%=^oAllVars(%1,%2,%)
 q 1
RestMem(%1,%2,%3) 
 s:'$d(%2) %2=$g(%1),%1=%USID s %3=$g(%3) n %
 i %3>0,$g(^oAllVars(%1,%2,"$j"))=%3 kill (%1,%2,%3,%USID,%mxWeb,%mxSheet)
 i %2<0,$d(%mxWeb),$j=$g(^oAllVars(%1,%2,"$j")),$g(%session)=$g(^("%session")) q $j
 s:0[$g(%1) %1=%USID s:0[$g(%2) %2=0 ;; i %2'<0,$d(%mxWeb) q %2
 h:'$d(^oAllVars(%1,%2,"$j")) .1   q:'$d(^oAllVars(%1,%2,"$j")) -1  
 i %3>0,^("$j")-%3 q -%3_" -- saved.job="_^("$j")
 i %3'>0,'$d(%mxWeb),^("$j")-$j,%1'["*" q -1
 i $l($g(^oAllVars(%1,%2,-1))) n %11,LiOfMvar s LiOfMvar=^(-1) d  g RestMemE
 . f %11=1:1:$l(LiOfMvar," ") s %=$p(LiOfMvar," ",%11) i $l(%),%'="%" s %=$p(%,"("),@%=$g(^(%)) i $d(^(%))>1 k @% m @%=^oAllVars(%1,%2,%) i $d(^oAllVars(%1,%2,%))
 i $zv'["MS" s %=999 f  s %=$o(^(%)) q:%=""  d:$e(%)'="$"
 .if %1'["*" q:" oo o ERR mxMsgBox mxERROR %USID %RestMem % %1 %2 "[(" "_%_" ")
 .if %1'["*" i %3'>0,$e(%)="%",'$d(%mxWeb),$d(@%) q:"%LANG %YX %omPrint %mxSheet %mxForma %XD81 %XD82 %gm %DatUMs %DATUMS %MENESI %GADS %DAYS %YEAR %XD81m %XD82m "[(%_" ")
 .i $d(^(%))=1 s @%=^(%) q
 .k @% m @%=^oAllVars(%1,%2,%)
 i $zv["MS" s %=999 f  s %=$o(^(%)) q:%=""  d:$e(%)'="$"
 .q:" oo o ERR mxMsgBox mxERROR %USID %RestMem % %1 %2 "[(" "_%_" ")
 .i %3'>0,$e(%)="%",$d(@%) q:"%LANG %YX %omPrint %mxSheet %mxForma %XD81 %XD82 %gm %DatUMs %DATUMS %MENESI %GADS %DAYS %YEAR %XD81m %XD82m "[(%_" ")
 .k @% i $d(^(%))#2 s @%=^(%) d:$l(@%)=500
 ..n %22
 ..f %22=501:500 q:'$d(^oAllVars(%1,%2,%,%22))  s @%=@%_^(%22)
 ..i $d(^oAllVars(%1,%2,%))
RestMemE s %=999 f  s %=$o(%RestMem(%)) q:%=""  s @%=%RestMem(%) k %RestMem(%)
 q ""
1(%) s %RestMem(%)=$g(@%) q 1
v(%Vch,oov,oov2) 
 n oovL,v 
 s oovL=$tr($p(%Vch,"\",3,4),"\,=","   ")_" %I "
 s oovL=$$trw^UST(oovL,"(*)")
 i $g(oov)?8n d  s oov="s:d8<"_oov_" flagSTOP=1 "_$g(oov2)
 . n x,o k %d8start
 . f x=1:1:99 s o=$p($p(%Vch,"\",6)," ",x) s:$l(o) %d8start(o)=oov
 q $$%v($p(%Vch,"\"),%Vch,,,$g(oov))_$$%vL($p(%Vch,"\"),,,,oovL)    
 ;
%v(%V,%Rout,xMcode,%PrFile,oov) 
 n %Vch s %Vch=$g(%Rout) i $l(%Vch,"\")<4 s %Vch=""
 i %V["^" s %Rout=$p(%V,"^",2),%V=$p(%V,"^")
 s %PrFile=$g(%PrFile,"^M")
 n o,oo,%FILE,%W,%uspr s %uspr=%USPR
 n %USPR k %rVstop(%V),%koko
 s %USPR=%Rout,%V(%V)="1F",%W=$c(255)
 i $t(@%V^@%USPR)=""  d  q mxERROR
 . s mxERROR="line "_%V_"^"_%USPR_" not exist.."
 i $$%MMUSER(%PrFile,%Vch)
 k ^oMX(%USID,"%V",%V) m ^oMX(%USID,"%V",%V)=%V 
 k vbak 
 s xVw="d "_%V_"^"_%Rout
 i $zv["Ca" do DISABLE^%NOJRN ;;i $SortBegin(^M(%V,%ggmm))
 k @%PrFile@(%V,%ggmm),^rm(%USID,%V,%ggmm),^oMX(%USID,"v",%V)
 i '$l($g(flgPlusM)) s %="" f  s %=$o(^M(%V,%)) q:%=""  k:$p(%,":",2)=%USID ^(%) k ^rm(%USID,%V)
 i $l($g(flgPlusM)) q:$d(flgPlusM(%V,+%ggmm)) 0 s flgPlusM(%V,+%ggmm)=1 n %ggmm s %ggmm=flgPlusM_":"_%USID_":*"  
 F %FileNum=1:1:33 S o=$p(%V(%V,6)," ",%FileNum) d:o'=""
 .s:o o=$p(o,+o,2,99) d %FILE^USPRINT(o_"^"_%Rout)
 i $zv["Ca" do ENABLE^%NOJRN  ;;i $SortEnd(^M(%V,%ggmm))
 q $d(@%PrFile@(%V))
%vL(%V,%PrNode,xMcodeL,%PRRvL,oovL) 
 n %E,%NNN,d8,sd,sk,%vL s %NNN=0
 i $l($g(flgPlusM)),$d(flgPlusM(%V,%ggmm))!111 n %ggmm s %ggmm=flgPlusM_":"_%USID_":*"
 i $d(%PrNode),%PrNode_%V'["^" s %V=%V_"^"_%PrNode k %PrNode
 i %V["^" s %Rout=$p(%V,"^",2)
 s %V=$p($p(%V,"^")_"LLLLLLLL","LLLLLLLL")
 m %V=^oMX(%USID,"%V",%V)
 s %vL=%V_"L",%PrNode=$g(%PrNode,"^M(%V)")
 q:'$d(@%PrNode) $NAME(@%PrNode)
 i $t(@%vL^@%Rout)="" q "line "_%vL_"^"_%Rout_" not found.."
 n %Li,%Mi,%M,%MiT
 i $zv["Ca" do DISABLE^%NOJRN
 i $$%PrNode^USPRINT(%PrNode)
 i $zv["Ca" do ENABLE^%NOJRN
 q 1_%USPR_"."_%V_%PrNode
qerr s $zt="" h 1 q "ERROR:ta^USX("_%j_","_p1_") "_$h_-$j_" zc="_zc
wDOS(%dos,text) 
 ; o 51:(%dos:"W"):0
 ; u 51 w:$d(text) text w:'$d(text) !,$h,!,%USPR,!
 q ""  ; c 51 q ""
MsgVM1 ;;;;(%ListVM) ;;  FromM.VM1 ==> to  M  !!!!
 f %=2:2:$l(%ListVM,$c(4)) d
 . s %1=$p(%ListVM,$c(4),%),%2=$p(%ListVM,$c(4),%+1)
 . i %2="",%1[" " x %1 q
 . x "s "_%1_"="""_%2_""""
 q
MsgMVj(%VarList) 
 q $$MsgVMV("  ",%VarList)
MsgVM ; MVM ;;;(%ListVM)  ;;  job 
 k ^MsgVM(%USID),^(%USID,1)
 n %MsgVMxx  ;;; h 3  
 f %=2:2:$l(%ListVM,$c(4)) d
 . s %1=$p(%ListVM,$c(4),%),%2=$p(%ListVM,$c(4),%+1)
 . i %1="%MVMkey" s %MVMkey=%USID       ;;;%2
 . s %MsgVMxx(%1)=%2,^(%1)=%2
 s ^MsgVM(%USID)=1
 q
MsgVMV(%,%VarList) 
 k %MsgMV s %MsgMV=%_$c(4),%VarList=$g(%VarList)
 i $g(%ErrorM)'="" s %VarList=%VarList_" %ErrorM"
 n %1,%2,%3,% s %2=""
 s %MsgMV=%MsgMV_$g(%VarList)_$c(4)_"$j="_$j_$c(4)
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d:$e(%)="@"
 . s %2=%2_" "_$e(%,2,99)_" "_$tr($g(@($e(%,2,99))),","_$c(4),"  ")
 s %VarList=%VarList_%2_" %VarList "
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d
 .q:"@"[$e(%_"@")
 .i $d(@%)#2 s %MsgMV(%1)=$c(4)_%_"="_$e(@%,1,15000) d:$l(@%)>15000 
 ..f %2=15001:15000:$l(@%) s %MsgMV(%1*100000_"."_%2)=$e(@%,%2,%2+14999)
 .q:$d(@%)<2
 . s %3=%_"("""")" f %4=1:1 s %3=$q(@%3) q:%3=""  i $d(@%3)#2 d
 .. s %MsgMV(%1*100000+%4)=$c(4)_%3_"="_$e(@%3,1,15000)
 .. i $l(@%3)>15000 f %2=15001:15000:$l(@%3) s %MsgMV(%1*100000+%4_"."_%2)=$e(@%3,%2,%2+14999)
 s %1=0,%2="%MsgMV"
 f  s %2=$q(@%2) q:%2=""  s %1=%1+$l(@%2) q:%1>15000  s %MsgMV=%MsgMV_$c(4)_@%2 k @%2
 q:$zv'["U) " %MsgMV  q $$U^MXF(%MsgMV)
GetList(%,%VarList) 
 k %MsgMV s %MsgMV=%_$c(4),%VarList=$g(%VarList)
 i $g(%ErrorM)'="" s %VarList=%VarList_" %ErrorM"
 n %1,%2,%3,% s %2=""
 s %MsgMV=%MsgMV_$g(%VarList)_$c(4)_"$j="_$j_$c(4)
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d:$e(%)="@"
 . s %2=%2_" "_$e(%,2,99)_" "_$tr($g(@($e(%,2,99))),","_$c(4),"  ")
 s %VarList=%VarList_%2_" %VarList "
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d
 .q:"@"[$e(%_"@")
 .i $d(@%)#2 s %MsgMV(%1)=$c(4)_%_"="_$e(@%,1,8000) d
 ..i $l(@%)>8000 f %2=8001:8000:$l(@%) d
 ... s %MsgMV(%1*100000_"."_%2)=$e(@%,%2,%2+7999)
 .q:$d(@%)<2
 . s %3=%_"("""")" f %4=1:1 s %3=$q(@%3) q:%3=""  i $d(@%3)#2 d
 .. s %MsgMV(%1*100000+%4)=$c(4)_%3_"="_$e(@%3,1,8000)
 ..i $l(@%3)>8000 f %2=8001:8000:$l(@%3) d
 ... s %MsgMV(%1*100000+%4_"."_%2)=$e(@%3,%2,%2+7999)
 s %1=$l(%MsgMV),%2="%MsgMV" f  s %2=$q(@%2) q:%2=""  s %1=%1+$l(@%2) d
 . i %1<8000 s %MsgMV=%MsgMV_$c(4)_@%2 k @%2
 q %MsgMV
latv1(%) 
 s %="e{275}{274}u{363}{362}i{299}{298}a{257}{256}s{353}{352}g{291}{290}k{311}{310}l{316}{315}z{382}{381}c{269}{268}n{326}{325}..{1081}{1049}{1094}{1062}{1091}{1059}{1082}{1050}{1077}{1045}{1085}{1053}{1075}{1043}{1096}{1064}{1097}{1065}{1079}{1047}{1093}{1061}{1098}{1066}{1092}{1060}{1099}{1067}{1074}{1042}{1072}"
 s %=%_"{1040}{1087}{1055}{1088}{1056}{1086}{1054}{1083}{1051}{1076}{1044}{1078}{1046}{1101}{1069}{1103}{1071}{1095}{1063}{1089}{1057}{1084}{1052}{1080}{1048}{1090}{1058}{1100}{1068}{1073}{1041}{1102}{1070}"
 n o s o="..|."
 s %=%_$c(254)_o_$c(179)_"."_$c(186)_"."_$c(182)_"."_$c(197)_"."_$c(199)_"."_$c(180)_"."_$c(195)_"."_$c(196)_"."_$c(205)_"."_$c(213)_"."_$c(209)_"."_$c(187)_"."_$c(218)
 q $$Uu^MXF(%_"."_$c(193)_"."_$c(194)_"."_$c(192)_"."_$c(212)_"."_$c(190)_"."_$c(202)_"."_$c(201)_"."_$c(200)_"."_$c(203)_"."_$c(206)_"."_$c(207)_"."_$c(178)_"."_$c(176)_"."_$c(177)_"."_$c(178)_".")  
%ALstart(%FILE) 
 q 1
ALwrite(%List) 
 n %h s %h=$c(4),%B=$c(254),%Lg="",%Lii="",%FILE=""
 f %=1:4:999 s %1=$p(%List,%h,%,%+3) q:$p(%1,%h,4)=""  d
 . s %K=$p(%1,%h),%n=$p(%1,%h,2),%g=$p(%1,%h,3),%FILE=$p(%1,%h,4)
 . i %g<0,%K="" s %=9999 q
 . i %g<0 s:+%K'=%K %K=""""_%K_"""" s $p(%Lii,",",-%g)=%K
 . i %g>0 s $p(%Lg,%B,%g+1)=%K
 i %<999,%FILE'="" s @("^"_%FILE_"("_%Lii_")")=%Lg,(%Lg,%Lii)=""
 q
readI(%i,%xColumn) 
 x "s $zt=""Err^USX"""
 I %i'["^"!(%i'["(") q "-^-(-?-)-"
 I $d(@%i)#2=0 q "00"
 s %R=$g(@%i),%I=$NAME(@%i) d:$l(%R)=500  n %1 s %1=$e($p(%i,"("),2,99)
 .n % f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 x %XG(%1),%XI(%1) i $d(^mxConfig("A")),'$$tAccess^US("A",%1) s %R="" x %XG(%1) q 0
 q 1
zo(%i,%di,%MV) 
 i %i["("""""""")" s ^ERROR(%i)="zo^USX" q ""
 n %,%I,%R,%IR,%n,%1 s %R=""
 s %1=$e($p(%i,"("),2,99)
 i $g(%LII(%1))=""!($g(%LI(%1))="") d
 .  n %i,%di,%MV d ^USX s %LI(%1)=$g(^AL(%1,"%LI"))
 i '%di s %R=$g(@%i),%I=$NAME(@%i) d:$l(%R)=500  i 1
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 e  s %I=$$zo500(%i,%di) i $l(%I),%I'["("""")" s %R=$g(@%I) d:$l(%R)=500
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 x %XG(%1),%XI(%1) s %IR=%I
 i $d(^mxConfig("A")),'$$tAccess^US("A"),%i'["("""")" s %I=%i,%R=$g(@%i) x %XG(%1),%XI(%1) q $$MsgVMV("$$zo^USX",%MV)
 f %=1:1 s %n=$p(%LI(%1),",",%) q:'$l(%n)  d:%n["~"  s %IR=%IR_$c(9)_@%n
 . i %n'["~~" s %n=$tr(%n,"~") q
 . s %n=$tr(%n,"~") s:'$d(%XG0(%1,%)) %XG0(%1,%)=$p($g(^AL(%1,"%W",%n,0)),";",2,99)
 . s o=%XG0(%1,%) n %K,%1,% x o s:$d(%K) @%n=%K
 i %R="" s %IR=""
 q $$MsgVMV("$$zo^USX",%MV)
 ; ; q $$GetList("$$zo^USX",%MV)
mxGetBlo(h4,h5,BloSize) 
  ; ; %zr  %zr0 
 q:%zr'[%zr0 ""  n blok,%r,%,o500 s blok=""
 s h4=$g(h4,$c(4)),h5=$g(h5,$c(5)),BloSize=$g(BloSize,10000)
 f  s %zr=$q(@%zr) q:%zr'[%zr0  d  s %zr=o500  q:$l(blok)>BloSize
 .s %r=@%zr,o500=%zr
 .i $l(%r)=500 f %=501:500 q:$g(@%zr@(%))=""  s %r=%r_@%zr@(%),o500=$NAME(@%zr@(%))
 .i h4<0 s blok=blok_%r_h5 q
 .s blok=blok_%zr_h4_$tr(%r,%B,h4)_h5
 q blok
zoIRg(%i,%di) ; 20060214
 n %,%IR,o,%Zon,%oP1,%oll s o=%i,%oP1="",%oll=0 k ooozoIRg
 i $d(@%i)#2 x:$zv'["GT" "s o=$q(@o,-1)" i o="" s o=$$zoIR(%i,0)_$c(4),ooozoIRg(0)=o w o q 0
 s %=$p($g(%i)_"))))","))))"),%Zon=$p(%_"""""""","""""""")
 q:o="" $c(4)
 f %=0:1 s %IR=$$zoIR(o,%di),%1=$p(%IR,$c(9)) q:o=%1  q:%1'[%Zon  d
 . s %oll=%oll+$l(%IR)+1 i %oll>15000 s ooozoIRg(%)=%oP1,%oP1="",%oll=$l(%IR)+1
 . s o=%1,%oP1=%oP1_%IR_$c(4)
 s:$l(%oP1) ooozoIRg(%)=%oP1
 q %
zoIRn(%i,%di,%3) 
 s %="",ooo="" i $$zoIRo(%i,%di,99999)
 f  s %=$o(^o(%USID,%),-1) q:'%  s ooo=^(%)_$c(4)_ooo q:$l(ooo)>25000
 q ooo
zoIRo(%i,%di,%3) 
 n %,%IR,o,%Zon s o=%i,%3=$g(%3,99999) q:o="" 0  k ^o(%USID)
 i $d(@%i)#2 x:$zv'["GT" "s o=$q(@o,-1)" i o="" s ^o(%USID,1)=$$zoIR(%i,0) q 1
 s %=$p($g(%i)_"))))","))))"),%Zon=$p(%_"""""""","""""""")
 f %=1:1:%3 s %IR=$$zoIR(o,%di),%1=$p(%IR,$c(9)) q:o=%1  q:%1'[%Zon  d
 . s o=%1,^o(%USID,%)=%IR 
 q %-1
zoIR(%i,%di,%Zon) 
 n %,%I,%R,%IR,%n,%1,o
 s %1=$e($p(%i,"("),2,99)
 i $g(%LII(%1))=""!($g(%LI(%1))="") d
 .  n %i,%di,%MV d ^USX s %LI(%1)=$g(^AL(%1,"%LI"))
 i '%di s %I=$NAME(@%i),%R=$g(@%I) d:$l(%R)=500  i 1
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 e  s %I=$$zo500(%i,%di) s:%I="" %I=%i s %R=$g(@%I) d:$l(%R)=500
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 x %XG(%1),%XI(%1) s %IR=%I
 i $d(^mxConfig("A")),'$$tAccess^US("A",%1) q %IR
 f %=1:1 s %n=$p(%LI(%1),",",%) q:'$l(%n)  d:%n["~"    s %IR=%IR_$c(9)_$s($l(@%n)<1023:@%n,1:$l(@%n)_">1023")
 . i %n'["~~" s %n=$tr(%n,"~") q
 . s %n=$tr(%n,"~") s:'$d(%XG0(%1,%)) %XG0(%1,%)=$p($g(^AL(%1,"%W",%n,0)),";",2,99)
 . s o=%XG0(%1,%) n %K,%1,% x o s:$d(%K) @%n=%K
 q %IR
zo500(i0,di) 
 n i,%KeM s i=i0 i i0'[%FILE n %FILE s %FILE=$e($p(i0,"("),2,99)
 s %KeM=$g(%KEM(%FILE)) s:'%KeM (%KeM,%KEM(%FILE))=$l(%LII(%FILE),",")
 i 'di q:$ql(i)=%KeM i0
 i di'<0 f  s i=$q(@i) q:'$l(i)  q:$ql(i)=%KeM
 i di<0 f  s i=$q(@i,-1) q:'$l(i)  q:$ql(i)=%KeM
 q:'$l(i) i0  q:$o(mxConfig("^"))'["^" i 
 n % s %=$o(mxConfig($p(i0,"("))) q:'$l(%) i0  q:i'[% i0
 q i
vFoundI(%i,f) 
 n %FILE,%,zr  s f=$g(f)
 s %FILE=$e($p(%i,"("),2,99)
 I f=0 k ^rMX(%USID,"vFoundI",%FILE) q 0
 s %="^rMX(%USID,""vFoundI"",%FILE,"_$p(%i,"(",2,99) I f>0 s @%=f q f
 s %=$d(@%),zr=$NAME(@%)
 I %<1 s %=$q(@zr) I %["vFoundI" s %="^"_%FILE_"("_$p(%,",",4,99)
 q %
CheckSyn(%RN,text) 
 ; Syntaxis checking
 q:$zv["GT" "ok"    ;;;;;;; GT.M - no checking... ;;;;
 q:$zv["MiniM" "MiniM"    ;;;;;;; MiniM - no checking... ;;;;
 n LN,OFS,%,LBL,K,LINE,zt,error s text=$g(text)
 x "s zt=$zt,$zt=""erChSy"""
 i %RN[" ",text="" s text=" "_%RN
 i text[$c(4) s text=WMcode(text)
 i text'="" s %RN="r" x "zr  zi text zs r zl r zs r::1" S LN=$ZA,OFS=$ZB
 i text=""  x " zl @%RN ZS @%RN::1" S LN=$ZA,OFS=$ZB
 I LN=0,OFS=0 Q "ok!"
 S LBL="",K=0
 F %=1:1:LN S LINE=$T(+%^@%RN) Q:LINE=""  d
 . S K=K+1 I $P(LINE," ")'="" S K=0,LBL=$P(LINE," ")
 s LINE=text S:'$l(text) LINE=$T(+LN^@%RN)
 x:$zv'["MiniM" "s $zt=zt" s error="?"
 i $l(LINE,"(")-$l(LINE,")") s error=")("
 i $l(LINE,"""")#2=0 s error=""""""
 q +LN_":"_LBL_"+"_K_"c"_OFS_"@"_error_"@"_LINE
erChSy x "s %=%USID_"".CheckSyntax^USX: name of routine is unvalid !! ""_$ze"
 s $zt=zt q %_";"_$c(0)
MWcode(%1) 
 n %,%2,%3,s
 s %=$c(179)_$c(186)_$c(182)_$c(197)_$c(199)_$c(180)_$c(195)_$c(196)_$c(205)_$c(213)_$c(209)_$c(187)_$c(218)_$c(193)_$c(194)_$c(192)_$c(212)_$c(190)_$c(202)_$c(201)_$c(200)_$c(203)_$c(206)_$c(207)_$c(178)_$c(176)_$c(177)_$c(178)
 q:$tr(%1,%_%1,%)="" %1
 s %2="" f %3=1:1:$l(%1) s s=$e(%1,%3) d:%[s  s %2=%2_s
 . s s=$c(4)_$e(1000+$a(s),2,9)
 q %2
WMcode(%2) 
 i %2'[$c(4) q %2
 s %1=$p(%2,$c(4))
 f %=2:1:$l(%2,$c(4)) s s=$p(%2,$c(4),%),%1=%1_$c($e(s,1,3))_$e(s,4,999)
 q %1
uci q
ic(%USID,%) 
 n %1
 i $g(%)'="",$$RestMem^USX(%USID,%)
 i $$icDate^MXD(%XD81,%XD82)
 q 1
xEmpty() 
 q ""
fo(fo) 
 n %,%1,%2
 s %=$$trw^UST(fo,"s~","$$s^USX("""),%=$$trw^UST(%,"v~","$$v^USX(""") q:%=fo fo
 f %=2:1:$l(fo,"~") s %1=$p(fo,"~",%) d
 . f %2=2:1:99 q:",_*\/ #+-)?!"[$e(%1_" ",%2)
 . S $p(fo,"~",%)=$e(%1,1,%2-1)_""")"_$e(%1,%2,999)
 s %=$$trw^UST(fo,"s~","$$s^USX("""),%=$$trw^UST(%,"v~","$$v^USX(""")
 q %
xForma(%I,%xForma) 
 n %FILE,% s %xForma=+$g(%xForma)
 s %FILE=$e($p(%I,"("),2,99) q:%FILE="" "?? %I non correct"
 i '%xForma q "?? "_%xForma
 k ^xForma s %j=+%j_" xForma "
 i $d(^AL(%FILE,"%xForma",%xForma)) x ^(%xForma) s %j=+%j q %xForma
 f %=9:-1:2 i $d(^(%)) x ^(%) q
 s %j=+%j n %1 i '$g(%xForma) q %xForma
 s %=%FILE_"^AL" x "s %1=$t("_%_")" i $l(%1) d @% q %FILE
 q "?? "
 q

USb^INT^1^65495,42075^0
USb ; ;[ 20190219 13:36:55 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 k koko,%NG,%xgl,%NEW,%US,%AL
 i $$icFIRMA^fir
 s %FILE=$tr(%FILE," ","") i $l(%FILE),$d(^mxConfig("A",%FILE)),'$d(^(%FILE,%USID)) q
pAL n o,%,%n,%1,%zt,u s %="",o=""
 f  s %=$o(^AL(%FILE,%)) q:%=""  s %(%)=$g(^(%)) d
 . f  s o=$o(^AL(%FILE,%,o)) q:o=""  d
 ..  i $e(o,1,2)="t_" d  q
 ...    i %'=%USID s o(o)=^(o) ;; k:$h-%(%)>222 ^AL(%FILE,%) q
 ...    else  s %AL(o)=^(o)  ;; s:%(%)-$h ^AL(%FILE,%)=$h,%(%)=$h ;; m %AL(%)=^AL(%FILE,%)
 ..  m %AL(%)=^AL(%FILE,%)
 ;
 k %AL("blank"),%AL(1),^AL(%FILE,"t_FontName"),^("CAP"),^("%FOK")
 k %W s %n=99,%W=%FILE f  s %n=$o(%AL("%W",%n)) q:%n=""  s %2=1 d
 . f %=-2,-1,1:1:9 i $p($g(%AL("%W",%n,%)),";")'="" d
 .. i %>0 s %W(%n,%2)=%AL("%W",%n,%),%2=%2+1 q
 .. s (o,%W(%n,%))=%AL("%W",%n,%) i o[18,$e(%n)="s" d  s %W(%n,%)=o
 k %AL("%W"),o("t_FontName"),o("t_Number")  m o=%AL m %AL=o k ^oAL m ^oAL=%AL
 ;  s o="" f  s o=$o(o(o)) q:o=""  i '$d(%AL(%USID,o)) s %AL(%USID,o)=o(o)
 S %1=%FILE D ^USX,%xgl^USX
 q:'$d(%CON(%FILE))  ;; -------------------
 s %gFILE="^"_%FILE,%SF=""
 S %LI(%FILE)=$G(^AL(%FILE,"%LI")),%LII(%FILE)=$g(^AL(%FILE,"%LII"))
 s %KEM=$L(%LII(%FILE),","),%LG="%SF"
 F %=1:1 S %N=$P(%LI(%FILE),",",%) Q:%N=""  S:","_%LII(%FILE)_","'[(","_%N_",") %LG=%LG_","_%N
 S %GM=%-1,%LG(%FILE)=%LG,o=0
 ;; f  s o=$o(o(o)) q:'$l(o)  s:$l(o(o),":")>%GM (o(o),^AL(%FILE,o),%AL(%USID,o))=$p(o(o),":",1,%GM) s:'$d(%AL(%USID,o)) %AL(%USID,o)=o(o)
 f %G=1:1:%GM s %N=$p(%LI(%FILE),",",%G) s:%N["~" %N=$tr(%N,"~") d
 .s %NG(%G)=%N,@%N=$g(@%N,"-"),%G(%N)=@%N,%W(%N)=$g(%W(%N,0)),%W(%N,-1)=$g(%W(%N,-1))
 S (%E,%K,%R)="",%B=$c(254),%G=1,%FIN=0
 i $g(%refreAL) k %refreAL q
CapEr s %zt=$zt,$zt="Err^USb" x $G(^AL(%FILE,"START")) s $zt=%zt
 i $g(^AL(%FILE,"START"))[" show last ",'$d(^otSelect(%USID,%FILE)),$o(%tSelect("^"_%FILE_"("))'[("^"_%FILE_"(") d
 . n o,%I,%1 s %1=0,%="^mM("""")" f o=1:1:9999 s %=$q(@%,-1) q:'$l(%)  i $qs(%,2)[("1^"_%FILE_"(") s %I=$e($qs(%,2),2,999) i $d(@%I) s ^otSelect(%USID,%FILE,%I)=1,%1=%1+1 i o>100 q:%1>2
 k ^mxAL(%USID,%FILE)
 k ^AL(%FILE,"ColumnWidth"),^("blank"),^("Fx"),^("prKadr") i "PPR PAV"[%FILE k ^("Tf")
 g RUN^US
e0 
E0 
%USID i '$d(%USID) s %USID="GTM" i $zv'["MiniM" x:$zv'["GT.M" "s %USID=$zu($s($zv[""Ca"":5,1:0))"
 x:$zv["MiniM"&'$d(%USID) "s %USID=$znspace" s ^JOB(%USID)=$h
 q
Enter(%,%Ymn,%Ymx,%Xmn,%Xmx,%ww,%Zona) 
 s:%["^" %=$e($p(%,"("),2,99) s %FILE=%
 d USb
 q ""
Err s %mxWarng(0)=$g(^AL(%FILE,"START"))_" --- ERROR IN START-COMMAND --- "_$zr q

UShelp^INT^1^65495,42075^0
UShelp  ;[ 20191012 17:58:34 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS 2005-2018
 q ""
Rcomp(f,Rout,UCI2) ; f=0/1 (short/full form)
 ; routines compare between UCI's
 k oRcomp n %UCI x:$zv["MiniM"!($zv["Ca")!($zv["IRIS") "s %UCI=$znspace"  x:'$d(%UCI) "s %UCI=$zu(0)"
 n o,%,x,z,zz,t,m,n,e,xzr s e="" s:'$d(UCI2) UCI2=%UCI
 i " "[$g(Rout) q " Rout=?? "
 i $zv["Ca"!($zv["MiniM")!($zv["IRIS") q:'$d(^$ROUTINE(Rout)) Rout_" - not exist in "_%UCI
 i $zv["Ca"!($zv["MiniM")!($zv["IRIS") x "zn UCI2 s %=$d(^$ROUTINE(Rout)) zn %UCI" q:'% Rout_" - not exist in "_UCI2
 i $zv["MS" d
 . x "S %UI=$S(UCI2?3U:$ZU(UCI2),1:$ZU($P(UCI2,"",""),$P(UCI2,"","",2)))"
 . x "S %UI=32*$P(%UI,"","",2)+%UI,%HI=$V(2,$J,2)"       ; %HI=0  %UI=1
 k ^r s zz=1
 s ^r(1)=" ;"_Rout_"_1_"_UCI2
 s ^r(0)=" ;"_Rout_"_0_"_%UCI
 s %="V 2:$J:%UI:2  zr  zl:$d(^ (Rout)) @Rout  V 2:$J:%HI:2"
 ;
 i $zv["Ca"!($zv["MiniM")!($zv["IRIS") d
 . zn UCI2 n r f %=1:1 Q:'$l($t(+%^@Rout))  S r(%)=$t(+%^@Rout)
 . zn %UCI m ^r(1)=r s m(1)=+$o(^r(1,9999),-1)
 i $zv["MS" x "x %  f %=1:1 q:'$l($T(+%))  s ^r(1,%)=$t(+%),m(1)=%"
 f %=1:1 q:'$l($t(+%^@Rout))  S ^r(0,%)=$t(+%^@Rout),m(0)=%
 i '$d(^r(1,1)) q " ..not exist in "_UCI2
 s o="" i $g(m(0))-$g(m(1)) s o=$g(m(0))_":"_$g(m(1))
 i o="" f n=2:1:m(1) i $$Uu^MXF(^r(0,n))'=$$Uu^MXF(^r(1,n)) s o=n_".."_$e(^r(0,n),1,12) q
 ;
 q:o=""!'f o
 ;
 f x=0,1 s me=-1,nn=0 f n=1:1:m(x) d
 .s t=$p(^r(x,n)," ") i t'="" s me=$p(t,"("),nn=0,t(me,x)="   ----- "_n
 .s nn=nn+1,(t(me,x,nn),t)=^r(x,n)
 .f %=-7:1:7 i t=$g(t(me,'x,nn+%)) k t(me,x,nn),t(me,'x,nn+%) q
 .q:'$d(t(me,x,nn))!'$d(t(me,'x,nn))  
 .s t2=t(me,'x,nn) s t(me,x,nn)=t,t(me,'x,nn)=t2
 s me="" f  s me=$o(t(me)) q:me=""  d  k:$d(t(me,0))+$d(t(me,1))<5 t(me)
 .f x=0,1 s n=0 f  s n=$o(t(me,x,n)) q:'n  k:"     "[t(me,x,n) t(me,x,n)
 k ^r m oRcomp=t 
 q ""

USm^INT^1^65495,42075^0
USm ;US.m -setup^AL [ 03/28/2005  1:06 AM ]  ;[ 20070204 19:51:29 ]
 ; M3-LITE, MSM-4.4x, CACHE-3x..5x, GT.M-5x
 ; Soft-in-cell  MX Copyright(c) SIA ENTERS  1997-2007
 ; 
 q
SelALGlo(%all) 
 n %,%1,%s k %SEL s %=""
 s %s="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM%1234567890"
 f  s %=$o(^AL(%)) q:%=""  i $tr(%,%s_%,%s)=%,'%,$e(%)'=0 i $d(^AL(%,"NAME")) s %1="^"_% d
 . i '$g(%all),$d(@%1) k @%1@("-") s:$d(@%1) %SEL(%)=^AL(%,"NAME") q
 . q:'$g(%all)  i '$d(@%1) s %SEL($c(254)_%)=^AL(%,"NAME")
 q $d(%SEL)

ZSTU^INT^1^65495,42075^0
mx ; d TCPSTART^APIMGR  ;[ 20200122 21:00:24 ]
tcp j tcp^MX1  ;; j trm^MX1   ;; j web^MX1
 q

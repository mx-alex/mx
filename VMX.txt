akos  
  * -%* -r -rr -rrr -TK* -oo* -Ens*
MX
MX ;[ 20191012 17:58:39 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS 2005-2017
QQMENU0 ; TKWEB  ; feast load menu in the frame "QQMENU"
 Q
QQMENU ; TKWEB  ; create menu in the frame "QQMENU"
 Q
T1menuA ; Example : convert something to '^T1menu'
 Q
T1menu ; it called from QQMENU and create HTML-page "menu" from ^T1menu
 Q
treeMap(line,t) 
 Q t
QQFORM0 ; TKWEB  ; feast load in frame "QQFORM"
 Q
QQFORM ; TKWEB   ; frame for forms - main users frame
 Q
QQCOMM ; TKWEB  ; frame for comments and error-messages
 Q
XX ; TKWEB  ; execution m-command from ..&A=xxxxxxxxx
 q
oxxxo ;          execute m-command from ..&A=xxxxxxxxx
 Q
QQEMPT ; TKWEB  ; empty page 
 Q
 ;  
 ;----------------------------------------------------------------
 ; Sub Code1()
 ;   Const ForReading = 1, ForWriting = 2, ForAppending = 8
 ;  Dim fs, f
 ; Set fs = CreateObject("Scripting.FileSystemObject")
 ;    Set f = fs.OpenTextFile("c:\Norway\code1.txt", ForAppending, 0)
 ;   f.writeLine ("***********")
 ;  f.Close
 ; End Sub
 ;----------------------------------------------------------
 ;Sub Code2()
 ;Dim z
 ;Set fs = CreateObject("Scripting.FileSystemObject")
 ;Set a = fs.CreateTextFile("c:\testfile.txt", True)
 ;St1 = "var item"
 ;St2 = " = null;" + Chr(13) + Chr(10) + "item"
 ;St3 = " = new MTMenu();" + Chr(13) + Chr(10) + "item"
 ;St4 = ".addItem("""
 ;St5 = """);/n"
 ;St = St1 + St2 + St3 + St4
 ;z = Len(St1)
 ;St1 = St1 + "_1"
 ;St1 = Left(St1, z + 1) + LTrim(Str(23))
 ;    StI = Left(StI, Len("item") + 1) + _
 ;    LTrim(Str(Val(Mid(StI, Len("item") + 2, Len(StI) - Len("item") - 1)) + 1)): y = 1: _
 ;    St = St1 + StI + St2 + StI + St3 + StI + St4 + Cells(yy, 1).Value + St5: _
 ;    If (Cells(yy, 2).Value <> "") Then _
 ;    Submenu = Left(StI, Len("item")) + Submenu1 + StI + Submenu2: a.write Submenu: _
 ;    y = 0: St = Left(StI, Len("item")) + St4 + Cells(yy, 1).Value + St5: _
 ;    a.write St: z = Len(StI): _
 ;    StI = Left(StI, Len("item") + 1) + _
 ;    LTrim(Str(Val(Mid(StI, Len("item") + 2, Len(StI) - Len("item") - 1)) + 1)): _
 ;    St = St1 + StI + St2 + StI + St3: y = 0: _
 ;    a.write St: GoTo Line1
 ; 
 ;a.writeLine (St)
 ;a.write St1
 ;a.Close
 ; 
 ;End Sub
 ;Sub main()
 ;Dim yy, xx, Submenu
 ;xx = 2
 ; 
 ;Set fs = CreateObject("Scripting.FileSystemObject")
 ;Set a = fs.CreateTextFile("c:\code.html", True)
 w "<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.01 Transitional//EN"">",!
 w "<html><head><title>[insert your title here]</title>",!
 w "<script type='text/javascript'>",!
 w "var relocateURL = "" / "";""",!
 w "if (parent.frames.length == 0) {",!
 w "  if (document.images) { location.replace(relocateURL); }",!
 w "  else                 { location = relocateURL;        }",!
 w "}</script>",!
 ;
 w "<script type=""text/javascript"" src=""mtmcode.js""></script>",!
 ;
 w "<script type=""text/javascript"">",!
 w "MTMDefaultTarget = ""text"";",!
 w "var MTMIconList = null;",!
 w "MTMIconList = new IconList();",!
 w "MTMIconList.addIcon(new MTMIcon(""menu_link_external.gif"", ""http://"", ""pre""));",!
 w "MTMIconList.addIcon(new MTMIcon(""menu_link_pdf.gif"", "".pdf"", ""post""));",!
 ;a.writeLine ("")
 ;
 ;Submenu = ""
 ;Submenu1 = ".makeLastSubmenu("
 ;Submenu2 = ");" + Chr(13) + Chr(10) + Chr(13) + Chr(10)
 ;Memo = 0
 ;St = ""
 ;StI = "menu"
 ;St1 = "var "
 ;St2 = " = null;" + Chr(13) + Chr(10)
 ;St3 = " = new MTMenu();" + Chr(13) + Chr(10)
 ;St4 = ".addItem("""
 ;St5 = """);" + Chr(13) + Chr(10)
 ;
 ;If (Cells(1, 1).Value = "") Then GoTo Line2
 ;St = St1 + StI + St2 + StI + St3 + StI + St4 + Cells(1, 1).Value + St5
 ;StI_1 = StI
 ;a.write St
 ;
 ;For yy = 2 To 148
 ;    If (Cells(yy, 1).Value = "") Then Exit For
 ;    
 ;    If (Cells(yy, xx + 1).Value = "1") Then
 ;    xx = xx + 1
 ;    If (StI_1 <> StI) Then
 ;    StI = StI_1
 ;    StI = Left(StI, InStrRev(StI, "_")) + _
 ;    LTrim(Str(Val(Mid(StI, InStrRev(StI, "_") + 1)) + 1))
 ;    StI_1 = StI
 ;    Else
 ;    StI = StI + "_1": StI_1 = StI: Memo = 1
 ;    End If
 ;    St = St1 + StI + St2 + StI + St3 + StI + St4 + Cells(yy, 1).Value + St5: _
 ;    a.write St: GoTo Line1
 ;    End If
 ;    
 ;    While ((Cells(yy, xx).Value = "") * (Cells(yy, 1).Value <> ""))
 ;    Submenu = Left(StI, InStrRev(StI, "_") - 1) + Submenu1 + StI + Submenu2: _
 ;   a.write Submenu: StI_1 = StI: StI = Left(StI, InStrRev(StI, "_") - 1): _
 ;   xx = xx - 1
 ;   Wend
 ;
 ;    If (Cells(yy, xx).Value <> "") Then _
 ;    St = StI + St4 + Cells(yy, 1).Value + St5: a.write St: GoTo Line1
 ;  
 ; Line1:
 ; Next
 ; 
 ;     While (xx > 2)
 ;     Submenu = Left(StI, InStrRev(StI, "_") - 1) + Submenu1 + StI + Submenu2: _
 ;     a.write Submenu: StI = Left(StI, InStrRev(StI, "_") - 1): xx = xx - 1
 ;     Wend
  
 ;a.writeLine ("</script>")
 ;a.writeLine ("</head>")
 ;a.writeLine ("<body onload=""MTMStartMenu(true)"" bgcolor=""#000033"" text=""#ffffcc"" link=""yellow"" vlink=""lime""  alink=""red"">")
 ;a.writeLine ("</body>")
 ;a.writeLine ("</html>")
 ; 
 ; 
 ;
 ;Line2: a.Close
 ;
 ;End Sub
MXPOST ; TKWEB
 Q
MXCALC ; TKWEB
 Q
ERCALC 
 Q
MXWEB ; TKWEB-(this comment enables this linetag to be reference from web)
MXGET ; TKWEB
 Q
ii(oo) 
 q ""
UCI(%UCI) n %
 x:$zv["Mini"!($zv["Ca")!($zv["IRIS") "s %=$znspace" x:'$d(%) "s %=$p($zu(0),"","")"
 s %UCI="UNDEF" s:$d(%) %UCI=% 
 q %UCI
 ;
sv j comX4(12) q
comX4(comPort,b,zr) 
 s zr=$g(zr,"^sv"),b=$g(b,9600),ComPort="COM"_comPort  ;; ,terminat=$g(terminat,13)
 s $zt="comR4^MX"  close ComPort  h 1  k @zr s @zr="START-$j="_$j,oldQ=0  ;; ,oldH=0
 ;OPEN comX ;;;:(:::"  801x0":b):5 s o=$TEST  ;; h 1 ;; 20150224
 OPEN ComPort:(:::" 8     ":b):5 h 1
 s @zr=$j f %=1:1:99 s @zr@(%)=0
 ;; w *-3 ;; 20150129   ;; q  ;;USE comX:(:"SI") f o=1:1:999 r *a:0  ;; read com-port, even $c(3)  !! 
 USE ComPort:(:::" 8     ":b)
comR4 
 i $g(@zr)="" CLOSE ComPort HALT
 ;; s jsv=$j i $ze["<ENDOFFILE" CLOSE ComPort HALT
 s Q="" f x=0:1:99 r *o:1 q:o=-1!(o=13)  s Q=Q_$c(o)
 i '$l(Q),o<0 w *-3 f x=0:1:32000 r *o:0   ;; 20161122 
 g:oldQ=Q!'$l(Q) comR4  s %=$H,oldQ=Q
 ;; i oldH=%,'Q g comR4
 s sec=+%_$e(100000+$p(%,",",2),2,9) i '$d(@zr@(sec)) s o=+$o(@zr@(0)) k @zr@(o)
 s @zr@(sec)=Q  g comR4
 q
comWrite(Port,text,zr,b) 
 k:'$l($g(zr)) zr k:'$l($g(b)) b 
 s zr=$g(zr,"^comWrite"),b=$g(b,9600),ComPort="COM"_+Port  s @zr@(Port,$$pD^MXD($h,2))="?"  ;; ,terminat=$g(terminat,13)
 OPEN ComPort:(:::" 8     ":b):5
 USE ComPort:(:::" 8     ":b)
 WRITE text,$c(13),text,$c(13)    ;; *-3
 CLOSE:000 ComPort s @zr@(Port,$$pD^MXD($h,2))=text
 q
comRtest(Port) 
 s b=9600,ComPort="COM"_+Port,ts=$$pD^MXD($h,2) n o,x,Q
 OPEN ComPort:(:::" 8     ":b):5 h 1
 USE ComPort:(:::" 8     ":b)
 s Q="" f x=0:1:99 r *o:1 q:o=-1!(o=13)  s Q=Q_$c(o)
 CLOSE ComPort s ^test(Port,ts)=Q_$$pD^MXD($h,2)
 q

MX1
MX1 ; ;[ 20191012 22:29:25 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 q
c2(m,server,port,uci) 
 n %io,%,r s %io=$p s %15=$c(15)
 i $g(port) CLOSE "|TCP|2" d  i '%chanel2 u %io s %mxWarng(-1)=%chanel2 q %chanel2
 . s %chanel2="ERROR ::: -- not connected to :"_server_":"_port_":"_uci 
 . OPEN "|TCP|2":(server:port::$c(15)):2 s %="w $j,"" "",$zv ;; UCI="_uci_"  "_%15
 . i $t USE "|TCP|2" d:$zv[-64  WRITE %,*-3 READ r:1 WRITE %,*-3 READ r:1 s %chanel2=$e(r,1,$l(r)-2)_" "_server_":"_port_":"_uci q
 .. i $zv["Ca" n curdev x "s curdev=##class(%SYS.NLS.Device).%New() s curdevState0=curdev.State,curdev.State=0,curdevState1=curdev.State"
 s r=%chanel2
 i r u "|TCP|2" w m," ; ",$c(0),%15,*-3 r r:7 s r=$e(r,1,$l(r)-2)
 u %io i m[(";CL"_"OSE;"),%chanel2 CLOSE "|TCP|2" s %chanel2=";CLO"_"SED; "_%chanel2
 q r
tcpMiniM ; vmx-CONCURRENT-SERVER with tcp port 2233  (minim)  ;
 k ^mxMonito s io="|TCP|:2233"  s ^mxMonito($$ts,1,-$j)="START tcpMiniM "
 OPEN io ;;  USE io:(/MODE="rwb":/TERM=$c(0))
tcpLmi k:000 ^oooRead1 s $ztrap="tcpErrMi^MX1"
 USE io:/ACCEPT ;;  h 1 r *%1 ;; i %1<0 g tcpLmi 
 ;; s %=$c(%1) i %1>-1 f  r *%1:0 q:%1<0  s:%1>0 %=%_$c(%1)
 ;; s ^mxMonito($$ts,1,$j)=%_-$l(%) i %'["UCI=" u 0 g tcpMiniM  ;; d:000  close $io  g tcpMiniM
 . i %'["Accept" w 0,$c(15),$c(0),*-3 q
 . s %=$c(13)_$c(10) n %mxWeb
 . s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 . w %mxWeb_1_%_%_$c(0),*-3
 s ^mxMonito($$ts,1,-$j)="START tcpMiniM "_io
 s:000 ^oooRead1=% g:111 tcpChild^MX1   j:000 tcpChild^MX1:(:$io) ;;  h 1
 s ^mxMonito($$ts,1,-$j)="START tcpMiniM ->> j tcpChild^MX1 "
 g tcpLmi
 q
web s io="|TCP|"_$j OPEN io:(:80:"MA"):200 USE io:(:80:"RAWCD":"":32000:32000)
 s ^mxMonito($$ts,0,-$j)=io_"  --- 80 "
 READ %  j webChild:(:5:$io:$io)  s ^mxMonito($$ts,1,-$j)=io_"  --- 80 "
 h 1 g web+2
 q
webChild USE $io:(:80:"RAWCD":"":32000:32000) s:000 ^mxMonito($$ts,0,-$j)=$io
 READ:1 ooo s o=$p($p(ooo,"MX=",2),"-"),port=$s(+o=3:2233,$zv[-64:2264,1:2232),uci=$p(o,+o,2,22)
 s %USID="web",shee=0,^mxMonito($$ts,0,-$j)=$io_";;"_ooo
 i 'o s ooo="",port=80,uci="%SYS" d  n o g webReply
 . s:o["{" o=$$u8^MXF(.o) s o=$p(o,";;") s:'$l(o) o="s ooo=1234567890"
 . f %=$l(o)-2:-1:1 s x=$e(o,%) i x="%" s x=$e(o,%,%+2),x=$f("%20  %22""  %23#  %3E> %3C<",x) s:x $e(o,%,%+2)=$e("%20  %22""  %23#  %3E> %3C<",x)
 . k %,x x o
 . s Html=$$U8^MXF(ooo),^mxMonito($$ts,1,-$j)=$g(o)_";;"_$l(ooo)_";;"_$e(ooo,1,333)
 f %=3:1:99 i $e(uci,%)?1n!($e(uci,%)=" ") s shee=$p($e(uci,%,99)," "),uci=$e(uci,1,%-1) q
 s:$l(shee)<2 shee="1_" ;; s:$l(uci)<3 uci="VMX"
 i o,uci'["%" zn uci
 d getStart s $p(ooo,";--;",2)=" %mxPort="_port_";"_uci_";"_shee_";"_%session_";"_%USID_"; "
 s Html=$$U8^MXF(ooo) s ^mxMonito($$ts,1,-$j)=$p(ooo,";--;",2)
webReply s %=$c(13)_$c(10),%1=$l(Html)
 s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 w %mxWeb_%1_%_%_Html,*-3 k:000 ooo,Html,uci,port,shee d:$d(o) saveMem
 q
tcpErrMi h 1 x "s view=$view(""err"",1)" s ^mxMonito($$ts,999,$j)=$ze_"  io="_$g(io)_" view="_view
 ;; close io  g tcpMiniM
 q
tcpError h 1 s ^mxMonito($$ts,999,$j)=$ze_"  io="_$g(io)
 c:$d(io) io h 1   ;; goto tcp+2
tcp ; MX-CONCURRENT-SERVER with tcp on port 2232(32-bit) or 2264(64-bit) or 2233(minim) or 5264 (IRIS) ;
 g:$zv["MiniM" tcpMiniM  g:$zv["MS" tcpMSM  q:$zv'["Ca"&($zv'["IRIS")  s io="|TCP|"_$j
 i $zv["IRIS" OPEN io:(:5264:"MA"):200  USE io:(:5264:"RAWCD":"":32000:32000) g tcpL
 OPEN:$zv'["-64" io:(:2232:"MA"):200   OPEN:$zv["-64" io:(:2264:"MA"):200 
 USE:$zv'["-64" io:(:2232:"RAWCD":"":32000:32000)   USE:$zv["-64" io:(:2264:"RAWCD":"":32000:32000)
tcpL 
 s $ztrap="tcpError^MX1"
 READ %   j tcpChild^MX1:(:5:$io:$io)
 ;; s ^mxMonito($$ts,0,$j)="%SYS -- START j tcpChild^MX1 "_$g(%)
 h 1 g tcpL
 q
 ;; i $zv["Ca" s ip=$zu(67,15,$j),o=$d(^mxSYSTEM("mxDenyIP",ip_1)) d  g:o tcpL
 ;; . s ^mxMonito($$ts,0,$j)=ip_" "_p_" "_$tr(%accept_" job="_$j_" $za="_$za_" $zb="_$zb_" $zc="_$zc,$c(0),"o")
 ;; . i o s o=o_$zr,@$zr=@$zr_" ::: access denyed ::: "_o
tcpChild ;; s ^mxMonito($$ts,0,$j)="%SYS -- START j tcpChild^MX1 "
 k ooo s ooo="" 
 i $zv["MS" USE 56 g tcpChilR^MX1
 i $zv["MS" USE 56 s uci=-1 d  g:'u tcpChild  V 2:$J:v*32+u:2 g tcpChilR^MX1   ;; msm-mx---EXCEL  -- not web
 . n r,zu,% s r="" f  read *%:1 q:%<0  s r=r_$c(%)
 . s uci=$e($tr($p($p(r," UCI=",2)," "),""""),1,3) x r w 0_$c(0)_$c(15),*-3 i $l(uci)<3 s v=0 q
 . S zu=$ZU(uci_",MXM"),u=$P(zu,","),v=$P(zu,",",2) ;; V 2:$J:v*32+u:2
 . h 2 s ^mxMonito($$ts,2,-$j)=uci_"   r="_r 
 i $zv["MiniM" USE $io:(/MODE="rwb":/TERM=$c(0))
 i $zv["Ca" USE:$zv'[-64 $io:(:2232:"RAWCD":"":32000:32000) USE:$zv[-64 $io:(:2264:"RAWCD":"":32000:32000)
 i $zv["IRIS" USE $io:(:5264:"RAWCD":"":32000:32000)
 s ^mxMonito($$ts,1,$j,"$io")=$io
 ;; i $d(^oooRead1) s ooo=^oooRead1,o=$tr($p($p(ooo," UCI=",2)," "),"""") s:$e(ooo,1,3)="GET" o=$p($p(ooo,"UCI=",2),";") s ^mxMonito($$ts,2,-$j)=ooo k ^oooRead1
tcpChil2 s $ztrap="saveMem^MX1",ooo=""
 i $zv'["MiniM" f  READ:600 ooo d:ooo=""  s uci=$tr($p($p(ooo," UCI=",2)," "),"""") s:ooo["OPTIONS" ^mxMonito($$ts,0,-$j)=ooo s:$e(ooo,1,3)="GET" o=$p($p($p(ooo,"UCI=",2),";",1,6)," "),uci=$p(o,";") q:$l(uci)>2
 . i $g(%session),$d(%mxWeb),$znspace'="%SYS",$g(%gm),$g(^oAllVars($g(%USID,-2.2),-%session,"$j"))=$j s %=%session n YX,Y,X,ooo,%session,%mxWeb  i $$SaveMem^USX(%USID,-%)
 i $zv["MiniM" f  READ *%:60  d:%>-1  s uci=$tr($p($p(ooo," UCI=",2)," "),"""") s:$e(ooo,1,3)="GET" o=$p($p($p(ooo,"UCI=",2),";",1,6)," "),uci=$p(o,";") q:$l(uci)>2
 . s ^mxMonito($$ts,3.1,-$j)=% 
 . s:%>0 ooo=$c(%) f  READ *%:0 q:%<0  s:%>0 ooo=ooo_$c(%)
 . s ^mxMonito($$ts,3.2,-$j)=ooo
 . ;;  i '$l(ooo),$g(%session),$d(%mxWeb),$znspace'="%SYS" k YX,Y,X,ooo i $$SaveMem^USX(%USID,-%session)
 ;; q:'$l(o)
 s ooooREAD=-99 s $ztrap="mxErrChR^MX1"
 i $znspace="%SYS",$l(uci)>2,$l(uci)<9 zn uci
 i $e(ooo,1,3)'="GET" w uci,0,$c(0),$c(15),*-3 g tcpChilR^MX1  ;; mx-EXCEL
 q:'$l(uci)
 ;; s ^mxMonito($$ts,3,$j)="START tcpChild^MX1  ooo="_ooo_-$l(o)_$g(o)
 i $e(ooo,1,3)="GET" s %mxWeb=1 d    ;; mx-WEB
 . ;; s %1=+$g(%session)
 . i o["%session" f %="YX","%USID","%mxSheet","%session" s @%=$p($p(o,";"_%_"=",2),";")
 . i o'["%session" s %USID=$p(o,";",3),%mxSheet=$p(o,";",2),%session=0,YX="" 
 . i '%session s ^mxMonito($$ts,3.3,$j)="START tcpChild^MX1  o="_o h 1
 . s %1omCode=$p($p(ooo,";=",2,999),";];") s:%1omCode["{" %1omCode=$$u8^MXF(.%1omCode)
 . f %=$l(%1omCode)-2:-1:1 s o=$e(%1omCode,%) i o="%" s o=$e(%1omCode,%,%+2),o=$f("%20  %22""  %23#  %3E> %3C<",o) i o s o=$e("%20  %22""  %23#  %3E> %3C<",o),$e(%1omCode,%,%+2)=o
 . s %mxForma=%mxSheet i '%session d getStart q
 . ;
 . ;; s ^mxMonito($$ts,4,$j)=YX_" "_%USID_" "_%mxSheet_" %session="_%session_" ooo="_ooo_"   o="_o
 . i YX="-2" s:000 %session=$g(^ooomxWeb(%USID,0)) s %=0,ooo="" x "f  s %=$o(^oSaveAsT(%USID,""web_MX_JS"",%)) q:'%  s o=$p(^(%),""// "") s ooo=ooo_o" q
 . s %oldJob=$g(^oAllVars(%USID,-%session,"$j")) 
 . i %oldJob'=$job s %=%session x "n YX,ooo,%session,%1omCode,%mxSheet,%mxForma  i $$RestMem^USX(%USID,-%)" s ^oAllVars(%USID,-%session,"$j")=$job,%mxWeb=1
 . i YX=%mxSheet d getForma q
 . i $l(%1omCode)>11,'YX s %changed=$g(%changed)+1
 . s Y=+YX,X=+$p(YX,"-",2),%qSelect=$g(%qSelect),%ySelect=$g(%ySelect,1),%xSelect=$g(%xSelect,1),%B=$c(254)
 . s %1ooooYX=YX,ooo=""
 . i Y&X!(YX="0"),$l(%1omCode)>1 d  q
 .. s:Y Yrc=$g(^oYrc(%USID,%mxSheet,Y),Y),%YXy=Y,%YXx=X
 .. i Y,X s %1=$g(^oTQMo(%USID,%mxSheet,Yrc,X)),%2=$g(^oRC(%USID,%mxSheet,Yrc\1,X)),%3=$g(^oYX(%USID,%mxSheet,Y,X)) 
 .. x "n %1,%2,%3,%1ooooYX "_%1omCode s ooo=$g(ooo),YX=%1ooooYX
 .. i ooo="",YX d
 ... i $e(%2,1,6)="?$$B~ " f %=3:2 s o=$p($p(%2," ",1,15),"?",%) q:'$l(o)  x "n %,YX s $p(%2,""?"","_%_")="_o
 ... s ooo=%1_";;oRC="_%2_";;oRC=;;oYX="_%3
 s Html=YX_";"_%USID_";"_%mxSheet_";"_%session_";="_$$U8^MXF(.ooo)
 s %=$c(13)_$c(10),%1=$l(Html)+1
 ;; s %mxWeb="HTTP/1.1 206 Partial Content"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Accept-Ranges: bytes"_%_"Content-Range: bytes 1-"_%1_"/"_%1_%_"Cache-Control: no-cache"_%_"Connection: " ;; ..
 s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 ;; s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: http://www.armex.pro/links.txt"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 ;; s ^mxMonito($$ts,7,$j)=$g(%1omCode)_"  ooo="_ooo
 w %mxWeb_%1_%_%_Html_$c(0),*-3
 i $g(%1omCode)[";$$SaveMem;" x "n YX,Y,X,Html,ooo,%mxWeb,o,%1omCode i $$SaveMem^USX(%USID,-%session)"
 k Html,ooo,%accept s %mxWeb=1
 g tcpChil2
saveMem i $l($g(%USID)),$g(%session)>0,$g(%gm) n ooo i $$SaveMem^USX(%USID,-%session)
 q
getStart 
 s:'$l(%USID) %USID=$e($p($p($p(ooo,"UCI=",2),";",3)," "),1,22) 
 ;; s (^(0),%session)=$g(^ooomxWeb(%USID,0),1)+1
 i '$l(%USID) s ooo="<HTML><BODY> -- "_ooo_$zv_" -- user not exists -- ERROR -- </BODY></HTML>" q
 i '$d(^oRC(%USID)) s ooo="<!DOCTYPE HTML><BODY> -- "_ooo_$zv_" -- not exists in "_$zr_" -- ERROR -- </BODY></HTML>" q
 s (^ooomxWeb(%USID,0),%session)=$g(^ooomxWeb(%USID,0))+1
 s %=0,ooo="" d  s:000 ^mxMonito($$ts,7,$j)=$l(ooo)
 . f  s %=$o(^oSaveAsT(%USID,"web_MX_HTML",%)) q:'%  s o=$p(^(%),"// ") s ooo=ooo_o
 . s %="" f  s %=$o(^oAllVars(%USID,%)) q:'%  i %<(-%session) k ^(%)
 x "n YX,Y,X,Html,ooo,%mxWeb,o,%1omCode s %=%session n %session i $$SaveMem^USX(%USID,-%)"
 s ^mxMonito($$ts,6,$j)=$g(YX)_" web %USID="_$g(%USID)_" "_%mxSheet_" $l(ooo)="_$l(ooo)_$zv
 q
getForma n %
 s ooo="",%=%USID n %USID s %USID=$p(%,".")
 i $l(%1omCode)>11 x:'$d(%DatUMs)!'$d(%gm) ";; n %mxSheet,%mxForma,%1omCode,YX,ooo ;; i $$RestMem^USX(%USID,-%session)" d
 . s %="%" f  s %=$o(^oRC(%USID,%mxForma,"?.var",%)) q:'$l(%)  s:'% @%=^(%)
 . x %1omCode  n %mxSheet,%mxForma,%1omCode,YX,ooo  i $$SaveMem^USX(%USID,-%session)
 s %=$o(^oYrc(%USID,%mxSheet,0,0)) i % s YX="[=",ooo=^(%) k ^(%) q 
 q:'$l(%1omCode)
 n %0,Yrc,%insRows,ym,xm,xi,X,Y,%11,%,%1,%22,%123,%formatC
 s Yrc=0,%insRows=0,ym=2,xm=5,xi=5,%formatC=$g(^vmxExcel(%USID,%mxSheet,".format"))
 s Y=0 f  s Y=$o(^cYX(%USID,%mxSheet,Y)) q:'Y  s X=1 f  s X=$o(^cYX(%USID,%mxSheet,Y,X)) q:'X  i $d(^(X,2)) s ^oTQMo(%USID,%mxSheet,Y,X)=$g(^oTQMo(%USID,%mxSheet,Y,X))_";;oRC=?$$Image cYX Size=222"
 f  s Yrc=$o(^oTQMo(%USID,%mxSheet,Yrc)) d:Yrc  i 'Yrc s ^oYrc(%USID,%mxSheet,0,999999)=ooo q
 . s:Yrc["." %insRows=%insRows+1 s Y=Yrc\1+%insRows,o="",X=.2,%123=.123,%11=0 s:Y>ym ym=Y
 . i Yrc'["." f  s X=$o(^oTQMo(%USID,%mxSheet,Yrc,X)) q:'X  s %1=$g(^(X)),%2=$g(^oRC(%USID,%mxSheet,Yrc,X)) d  q:$l(o)>10000
 .. s %="" i X>1,$l(%2)!$l(%1) s %=$f(%formatC,"]"_Yrc_-X_":") i % s %=$p($e(%formatC,%,%+210),"]")
 .. i $e(%2,1,3)="?$$" d  s %=""
 ...  n % s %=$p($p(%2," "),"::",2,9) i $l(%) s %0=%2,%2="" i @% s %2=%0 
 .. s:%2'=%1&$l(%2) %1=%1_";;oRC="_%2 s:$l(%) %1=%1_" ;f;"_% q:'$l(%1)  s:"00.0-  "'[%1 %11=X 
 .. s o=o_"[="_$s(%123+1=X:"~",1:Y_-X_"-")_%1,%123=X
 . i Yrc["." f  s X=$o(^oTQMo(%USID,%mxSheet,Yrc,X)) q:'X  s %1=$g(^(X)) i $l(%1) s o=o_"[="_$s(%123+1=X:"~",1:Y_-X_"-")_%1,%123=X  s:"00.0-  "'[%1 %11=X q:$l(o)>10000
 . i $l(ooo)+$l(o)>10000 s ^oYrc(%USID,%mxSheet,0,Yrc)=ooo,ooo=""
 . s:%123>xm xm=%123 s:%11>xi xi=%11 s:Y'=Yrc ^oYrc(%USID,%mxSheet,Y)=Yrc s ooo=ooo_o
 k ^oY m ^oY=^oYrc(%USID,%mxSheet,0)   s YX="[=",o=$o(^oYrc(%USID,%mxSheet,0,0)),ooo=ym_-xm_-xi_^(o) k ^(o)
 ;; s ^mxMonito($$ts,6,$j)=YX_" web "_%USID_" "_%mxSheet_" $l(ooo)="_$l(ooo)
 q
tcpChilR 
 i $zv'["MiniM" READ %1omCode
 i $zv["MiniM" READ *% s %1omCode=$c(%) f  READ *% q:%<1  s %1omCode=%1omCode_$c(%)
 s:$e(%1omCode,1,4)["zw" ^mxMonito($$ts,0_$g(%USID))=%1omCode_" ::: "_$zt
 s $ztrap="mxErrChR^MX1",%oorxxxw="1"
 i $e(%1omCode,1,5)="CLOSE" w $j,":CLOSE:",0,$c(0),$c(15),*-3 close $p hang 2 HALT
 i '$d(%oorxxxU) s %oorxxxU="" s:$zv["U) " %oorxxxU=1
 i $l(%oorxxxU) s %oorxxxU=$f(%1omCode,"{") d:%oorxxxU
 . n %1,%,s f %=%oorxxxU-1:1:$l(%1omCode) i $e(%1omCode,%)="{" f %1=4,5,6 s s=$e(%1omCode,%+%1) i s="}" s s=$e(%1omCode,%+1,%+%1-1) i s\1=s,s<66200,s>250 s $e(%1omCode,%,%+%1)=$c(s) q
 x %1omCode w 0_$c(0)_$c(15),*-3  ;; w:$g(%oorxxxw)'="0" 0,$c(0),$c(15),*-3
 g tcpChilR
 q
tcpChilRformsm ;; not correct  work
 i $zv["Ca"!($zv["IRIS") READ %1omCode i 1 ;; i $zv["MS" s ^mxMonito($$ts,$g(%USID)_" ")=$e(%1omCode,1,500)
 else  s %1omCode="" f  READ *% q:%<1  s %1omCode=%1omCode_$c(%)
 i $zv["MS" s ^mxMonito($$ts,0)=$e(%1omCode,1,500)
 i $e(%1omCode),$e(%1omCode,1,7)-1000000>0 s %1omCode=$e(%1omCode,8,999999) f %2=1:1:999 d  q:%<0
 . s ^mxMonito($$ts,%2)=1000000_$e(%1omCode,1,500)
 . w 0_$c(0)_$c(15),*-3 s %1="" f  READ *% q:%<1  s %1=%1_$c(%)
 . s ^mxMonito($$ts,%2)=$e(%1,1,500)
 . s %=$e(%1,1,8)-1000000 s:%>0 %1=$e(%1,8,999999) s %1omCode=%1omCode_%1  
 s $ztrap="mxErrChR^MX1",%oorxxxw="1"
 i $e(%1omCode,1,5)="CLOSE" w $j,":CLOSE:",0,$c(0),$c(15),*-3 close $p hang 2 q
 i '$d(%oorxxxU) s %oorxxxU="" s:$zv["U) " %oorxxxU=1
 ;; i $zv["MS" s ^mxMonito($$ts,$g(%USID)_2)=$e(%1omCode,1,500)
 . n %1,%,s f %=%oorxxxU-1:1:$l(%1omCode) i $e(%1omCode,%)="{" f %1=4,5,6 s s=$e(%1omCode,%+%1) i s="}" s s=$e(%1omCode,%+1,%+%1-1) i s\1=s,s<66200,s>250 s $e(%1omCode,%,%+%1)=$c(s) q
 x %1omCode w 0_$c(0)_$c(15),*-3  ;; w:$g(%oorxxxw)'="0" 0,$c(0),$c(15),*-3
 ;; i $zv["MS" s ^mxMonito($$ts,$g(%USID)_2)=$e(%1omCode,1,500)
 g tcpChilR
 q
mxErrChR 
 s ^mxMonito($g(ooooREAD)+.1,$g(%USID)_" ::: ERROR in : ")=$g(%1omCode)_$ze_" $zt="_$zt_" %mxForma="_$g(%mxForma)_" y="_$g(%YXy)_" x="_$g(%YXx),$zt=""
 s e=$tr(@$zr,$c(0))_" ERROR ::: "_$ze_" ::: "_$g(%1omCode) s:$zv["U) " e=$$U8^MXF(e)
 s %=$ze,^mxMonito($$ts,$g(%USID)_" ::: ERROR in : ")=e_" ::: "_% s e=$$trw^UST(e,"<mx","<.mx")
 i %["<DISCONNECT>" close $p hang 1 HALT   ;; hang 120
 i %["<WRITE>" close $p hang 1 HALT   ;; hang 120
 s $ec=""  w:'$d(%mxWeb) "ERROR ::: ",$$trw^UST(e,"<mx","<.mx"),0,$c(0),$c(15),*-3 
 s %=$c(13)_$c(10)
 i $d(%mxWeb) s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 i $d(%mxWeb) s Html=$g(YX)_";"_$g(%USID)_";"_$g(%mxSheet)_";=ERROR ::: "_$$U8^MXF(e) w %mxWeb_($l(Html)+1)_%_%_Html,$c(0),*-3  s ooo=""  g tcpChil2   ;;; HALT
 I %["<NAMESPACE>" h 1 close $p h 1 HALT
 g tcpChilR
 q
TCP(PORT) 
o ;  Start MX-SERVER with TCP.
audi 
x 
xx 
getPORT 
mxRead 
readX 
erMXserv q 
W(%) w $c(0,0),$c($l(%)\256),$c($l(%)#256),%
 q
GTMread ;;w !,"gtm : WRITE /WAIT(%ZNTimeS) :  %ZNCmd=",%ZNCmd,"  SOCKET=",%ZNSock
 q
enterYX(%USID,%mxSheet,%y,%x,%N,%K) q:'$d(%mxWeb) 0
 ;;  20190503  ;; i $e(%K)="<",$e(%K,1,3)'="<mx" q " "_%y_"-"_(%x+1)
 n %,%1,oo,%mxForma,%ooSheet,%mxIndex,%in,%n,%E,oRCresult,%oldoYXq,ooooooYX,%G,%goY,%goX
 n gotoYXyy,gotoYXxx,%oRCmCod,%TQMmCod s %ooSheet=%mxSheet,%qChange=%K
 s %mxForma=$p(%mxSheet,"--"),%G=0,%YXy=%y,%YXx=%x,%E="",%GM=0,%flagEdi=$g(%flagEdi),%K(0)=%K 
 s (%nn,%tabRow)=$$%0Yrc^MXTQM2(%y) s:$e($g(^oRC(%USID,%mxForma,%y,%x)),1,2)["?_" %Yrc=%y
 s %oldoYXq=$g(^oYX(%USID,%mxSheet,%y,%x)),%in=$g(^oRC(%USID,%mxForma,%Yrc,%x))
 i %oldoYXq'=%K,$d(^onChange(%USID,%mxForma,%y,%x)) s %oRCmCod=^(%x),%qChange=%K,%yChange=%y,%xChange=%x
 i %tabRow,%Yrc<%YXy,%YXy-%Yrc+1'=%tabRow s %E=%tabRow_" %Yrc="_%Yrc_"  %YXy="_%YXy g enterYXe
 i $e(%in)="?",$e(%in,1,3)'="?$$" s %N=$tr($p(%in," "),"?_") i "%oo"'[%N,%in[" ;;; ",%N'="%mxIndex" s %oRCmCod=$p(%in," ;;; ",2,99) s:$e($g(^(%x+1)),1,3)="?.." %oRCmCod=%oRCmCod_$e(^(%x+1),4,999)
 i '%tabRow,$e(%K)="="!($e(%K,$l(%K))="=") d  g:$l($g(%E)) enterYXe i $d(%1) x:$e(%K)="=" "s %K"_%K x:$e(%K,$l(%K))="=" "s %K="_$e(%K,1,$l(%K)-1)    ;;  ;;  to-do !! $$formuExc()  
 . s %1=$tr(%K,"+-/*()^_=[]':\#,.;","                 ") i $tr(%1," """)="" k %1 q
 . q:%K["$"!(%K["^")!(%K["_")!(%K["'")!(%K["%")!(%K["[")!(%K["""")!($e(%K)'="=")!%K
 . f %=1:1:$l(%1," ") s %n=$p(%1," ",%) i $l(%n),'%n,$e(%n)'="$",'$d(@%n) s %E=$g(%E)_%n_"--< undef >  "
 i $e(%in)'="?"!($e(%in,1,3)="?$$"),'%tabRow,'$d(%oRCmCod) s ^oYX(%USID,%mxSheet,%y,%x)=%K g enterYXe
 i 0_%mxForma["0t." s %FILE=$e(%mxForma,3,99),%GM=$l(%LI(%FILE),",") 
 else  i %tabRow s %=$g(^oRC(%USID,%mxForma,"?$$TQM",1)),%=$p(%," ",3) i $e(%)="^",%[")" d
 . s %oRCmCod="i '$l($g(%E)),1_$d("_%_") s @$zr@(%N)=%K",%FILE=$e($p(%,"("),2,99),%LII(%FILE)=$e($p(%,"(",2,99),1,$l(%)-1),%GM=0 
 i %tabRow s %=1,%1=-1 f  s %=$o(^oRC(%USID,%mxForma,%Yrc,%)) q:'%  s o=^(%),%n=$p(o," ") i $e(%n,1,2)="?_" s %n=$e(%n,3,99),%1=%1+1,@%n=$p($g(^oYX(%USID,%mxSheet,%y,%)),"<mx ") s:%n["%mxIndex" @%n=%_o s:%n=%N %G=%1 i %G>1 s:$p(o,";")[" ] " %GM=%1
 i %tabRow,%x'>%mxIndex!(%G<2)!'%GM,%flagEdi'[(%y_" "_%mxSheet_" ") d
 . s %flagEdi=%y_" "_%mxSheet_" ",%YX(%y,2)="<mx ic19.-2"
 . n %x x $p(%mxIndex,";;;",2) i '%G,%K="-" s o=$p(%mxIndex,";-;",2) i $l(o) x o s oo="<mx ic46.-2",%E=1
 ;
 i ($e(%K)="=")!($e(%K,$l(%K))="=") d  g:$l(%E) enterYXe i $d(%1) x:$e(%K)="=" "s (oo,%K)"_%K x:$e(%K,$l(%K))="=" "s (oo,%K)="_$e(%K,1,$l(%K)-1)  ;;  ;;  to-do !! $$formuExc()  
 . s %1=$tr(%K,"+-/*()^_=[]':\#,.;","                 ") i $tr(%1," """)="" k %1 q
 . q:%K["$"!(%K["^")!(%K["_")!(%K["'")!(%K["%")!(%K["[")!(%K["""")!($e(%K)'="=")!%K
 . f %=1:1:$l(%1," ") s %n=$p(%1," ",%) i $l(%n),'%n,$e(%n)'="$",'$d(@%n) s %E=$g(%E)_%n_"--< undef >  "
 i '$d(%oRCmCod) g:'%G&%E!(%N="%mxIndex") enterYXe 
 i %tabRow,%flagEdi'[(%y_" "_%mxSheet_" ") s:%G&%GM %YXx=+%mxIndex g enterYXe
 i '$d(%oRCmCod),'$l(%N) s ^oYX(%USID,%mxSheet,%y,%x)=%K g enterYXe
 s:'$l(%K) %K=$g(%WW(%N)) s:%K["<mx "!($e(%K)="?") oo=%K
 i 0_%mxForma["0t.",%G d  i '$l(%K) s:%tabRow>1&'$l(%oldoYXq)&(%'=%N) %K=$g(^oYX(%USID,%mxSheet,%y-1,%x)),oo=%K i '$l(%K) s %E="-- enter info in this cell ! --" g enterYXe
 . s %=%LII(%FILE),%=$p(%,",",$l(%,",")) q:%'=%N  s:$l(%K) @%N=%K,%NEW=$d(@("^"_%FILE_"("_%LII(%FILE)_")"))
 ;;;;;;;;;;;;;;;;;; i %GM!'%tabRow s oRCresult=$$oRC^MXTQM2(%K,%mxForma,%y,%x)
 ;; k ^ERR f %="%YXy","%YXx","%y","%x","%mxIndex","%G","%GM","%goY","%goX","%N","%Yrc","%tabRow","%flagEdi","%TQMformu","%oRCformu" s ^ERR(%)=$g(@%,"<undef>")
  s @%N=%K  x $g(%oRCmCod) x:%tabRow $g(%TQMmCod)
 i $l($g(%E)),$e(%E,1,4)'="%SEL" s @%N=%oldoYXq q " - "_%G_%N_";;=%E=;;"_$$trw^UST(%E,$c(10),"<br>   ")
 i %K(0)'="=%N","ooo"'[%N,%N'?1"%".n s (@%N,^oYX(%USID,%mxSheet,%YXy,%YXx))=$p(%K,"<mx ")   
 i %ooSheet'=%mxSheet q %mxSheet 
 i $d(%SEL) q " - "_%G_%N_";;=%E=;;"_$g(%E)_";;=%E=;;=SEL=;;"_$$ooo2^MXF("%SEL")
 i $d(%YX) x "n %YXy,%YXx  s ooooooYX=$$oYXshowM^MXTQM2(%mxSheet)"
enterYXe s %goY=%YXy,%goX=%YXx+1 s:%K(0)'=%K&'$d(oo) oo=%K 
 ;;  s:$l(%oldoYXq)&(%K'=%oldoYXq)&'$d(oo) oo=%K_"<mx ic19 fb @"_%oldoYXq i $d(oo),'$l(oo) s oo="  "
 i %G,%GM'<%G s:%YXx'>%mxIndex %YXx=+%mxIndex  s:%G=+$g(%GM) %YXx=+%mxIndex,%goY=%YXy+1 s %goX=+$o(^oRC(%USID,%mxForma,%Yrc,%YXx)) s:'%goX %goX=+$o(^oRC(%USID,%mxForma,%Yrc,+%mxIndex))
 i '%G,$l(%N),'%tabRow s o=$g(%EnterLi(%mxForma)) d:'$l(o)  i o[%N s o=$p(o," "_%N_" ",2,9) i $l(o) f %=1:1:9 s %n=$p(o," ",%) q:%n="//"  i $l(%n) s o=$g(^oRC(%USID,%mxForma,"?var",%n)) s:o gotoYXyy=o+(%n=%N),gotoYXxx=+$p(o,"-",2) q
 . s %=0 f  s %=$o(^oRC(%USID,%mxForma,"?$$EnterList",%)) q:'%  s o=o_" "_$p(^(%)," ",2,99) 
 . s %EnterLi(%mxForma)=o_" "
  ;; k ^ERR f %="%YXy","%YXx","%y","%x","%mxIndex","%G","%GM","%goY","%goX","%N","%Yrc","%tabRow","%flagEdi","%oRCmCod","oo","%oldoYXq" s ^ERR(%)=$g(@%,"<undef>")
 q:$g(%n)[":)" 1
 s:$g(gotoYXyy) %goY=gotoYXyy s:$g(gotoYXxx) %goX=gotoYXxx s:$g(%E) %E=";;=%E=;;"_%E_";;=%E=;;"
 q " "_%goY_"-"_%goX_" "_%G_%N_$g(%E)_";;=YX=;;"_$g(ooooooYX)_";;=YX=;;=oo=;;"_$g(oo)
 q
ts() q $$pD^MXD($h,2)
mxMSMtcp 
tcpMSM ; vmx-CONCURRENT-SERVER with tcp port 2666  (msm)  ;
 k ^mxMonito s io=56,^mxMonito($$ts,1,-$j)="START tcpMSM port 2666 "
initMSM ; Process the init state MSM
 x "S nt=($ZB($V(0,-4,2),#F,1)=10)"    ; Determine OS type, NT or not NT
 close 56 open 56:(:nt*8):"TCP"   ; Open and initialize the device
 ;; s %=$c(%1) i %1>-1 f  r *%1:0 q:%1<0  s:%1>0 %=%_$c(%1)
 ;; s ^mxMonito($$ts,1,$j)=%_-$l(%) i %'["UCI=" u 0 g tcpMiniM  ;; d:000  close $io  g tcpMiniM
 use 56   s %lddb=$KEY,rr(0)=%lddb g listeMSM
 q
listeMSM ; Process the ntlisten state
 use 56:(%lddb)
 s ^mxMonito($$ts,1,-$j)="listeMSM %lddb="_%lddb_"   nt="_nt  h 1 
  x "W /SOCKET("""",2666) S %xddb=$KEY,lza=$ZA,lzb=$ZB,lzc=$ZC,%ddb=$ZH(%xddb)"
 s ^mxMonito($$ts,1,-$j)="%xddb="_%xddb_" lza="_lza_"  lzb="_lzb_"  lzc="_lzc_"  %ddb="_%ddb h 1 
 I lzc&(lzb=-8) G listeMSM
 I lzc G initMSM
 ; Save the caller address
 x "S addr=$V(%ddb+16,-3,0)"
 x "S %(""ADDRESS"")=$V(addr+13,-3,$V(addr+12,-3,1),9)"
 x "U 56:$ZH(+%ddb)"
 ;
 ;;; Associate the ddb with this job :
 ;;x "V %ddb+46::$J-$V(272,-4,4):2"
 ;;; Check for accept error :
 ;;I lzc&(lzb=-8) G listeMSM
 ;;I lzc G initMSM
 ;; g x
 s ^mxMonito($$ts,1,-$j)="START MSM "_io
 ;
 d tcpChild^MX1
 h 2 g listeMSM
 q
nspace(name)  
  ; zn "%SYS" d ^DATABASE
  zn "%SYS"
  x "s o=##class(Config.Configuration).AddNamespace(name,name,name)" 
  q o
 q

MX2
MX2 ;[ 20191011 20:14:18 ]
 ; M3-LITE, MSM, CACHE, GT.M-5x
QQ ; TKWEB ; start mxWeb 
 s %USID=$g(%("FORM","U")),oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) a="127.0.0.1"
 i %USID="" s %USID=a s:%USID="127.0.0.1" %USID="es"
 s:%USID %USID="u"_$p(%USID,".",4)
 s:$l(a) ^o(a)=%USID
 w "<html>" k ^oProc m ^oProc=% s ^oProc("ADDRESS")=a
 ;;w "<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.0 Frameset//EN"">",!
 w "<head><title>mxWeb</title>",!
 ;w "<SCRIPT></SCRIPT>",!
 w "<HTA:APPLICATION ID=""WL"" APPLICATIONNAME=""WebLink"" ICON=""http://localhost/gb/weblink1.ico""",!
 W " CONTEXTMENU=""NO"" SCROLL=""NO"" SINGLEINSTANCE=""YES"" VERSION=""2.0"" WINDOWSTATE=""maximize"">",!
 w "</head>",!
 w "<frameset frameborder=0 framespacing=0 border=0 cols=* rows=55,*>",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQTITL^MX"" application=yes name=QQTITL noresize scrolling=no >",!
 w "<frameset frameborder=0 framespacing=0 border=0 cols=""225,*"" rows=""*"">",!
 w "<frameset frameborder=0 framespacing=0 border=0 cols=""*"" rows=""0,*"">",!
 w "<frame marginwidth=0 marginheight=0 application=yes name=""code"" noresize >",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQMENU^MX"" application=yes name=QQMENU noresize >",!
 w "</frameset>",!
 w "<frameset rows=95%,5% >",!
 w "<SCRIPT> </SCRIPT>",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQFORM^MX"" application=yes name=QQFORM noresize scrolling=auto >",!
 w "<frame marginwidth=0 marginheight=0 src=""http://localhost/gb/QQEMPT^MX"" application=yes name=QQCOMM noresize scrolling=no >",!
 w "</frameset></html>"
 Q
QQTITL ; TKWEB ; frame title
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s %USID=^o(a),oxxxo=$p(oooo,"&A=",2,99)
 i oxxxo="" s oxxxo="d w7^MX"
 d getVars
 w "<HTML>"
 w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQTITL</TITLE></HEAD><BODY>",!
 w "<table width=1020 border=0 cellspacing=0 cellpadding=0 "
 w " align=center style=""position: absolute; left: 0; top: 0"">",!
 ;;W "<tr valign=""top""> ",!
 ;;w "<td width=1020 colspan=2 height=30 bgcolor=#FFFFFF>"
 ;;w "<img src=""toppen.jpg"" width=""2100"" height=30 ></td></tr>",!
 w "<tr><td width=1020 colspan=2 height=30>",!
 f o=1:1:6 w "<img src=blaknapp.jpg width=170 height=30>"
 w "</td></tr>",!
 W "</table>",!
 w "<SCRIPT></SCRIPT>",!
 d oxxxo
 Q
w7 
 f o=%USID k ^MsgVM(o),^MsgMV(o),^MsgMVM(o),^MsgVMV(o),^mxM(o)
 ;;s $zt="Ervb^USX"
 i $$NewDate^MXD
 s %XD81=$g(%XD81,20020101),%XD82=$g(%XD82,20021231)
 i $$icDate^MXD(%XD81,%XD82)
 i $$icFIRMA^fir(1)
 w "<table bgcolor=silver width=100% style=""position: absolute; left: 0; top: 30"">"
 w "<tr><td> ",$$u^MX($g(%FIRMA)),"</td><td> ",$$u^MX($g(%DatUMs)),"</td> "
 w "<td>",%UCI,"</td>"
 w "</tr></table>"
 Q
QQMENU ; TKWEB  ; frame of the menu
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99) s:oxxxo="" oxxxo=" d mxMENU "
 d getVars
 W "<HTML>"
 ;w "<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.0 Frameset//EN"">",!
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQMENU</TITLE>",!
 ;w "<SCRIPT type=""text/javascript"" language=""JavaScript"" >",!
 ;------------------------- SCRIPT ---------------------------
 w "<SCRIPT language=JavaScript >",!
 w "function jsMXmenu(line) {",!
 w "o21=new String; id=new String",!
 w "yMax=MENU.rows.length;",!
 w "if (line==yMax) {yMax=0;}",!
 w "o21=MENU.rows(line).getAttribute('VALUE'); le=o21.length-1",!
 w "vi=MENU.rows(line+1).style.display ; ",!
 w "im=MENU.rows(line).all.length-1 ; ",!
 w "id=MENU.rows(line).all[im].getAttribute('id') ;",!
 w "if ((id.charAt(0)=='o')&&(vi=='none'))   {",!
 w "  MENU.rows(line).all[im].style.display='inline'; ",!
 w "  MENU.rows(line).all[im-1].style.display='none';}",!
 w "if ((id.charAt(0)=='o')&&(vi=='inline')) {",!
 w "  MENU.rows(line).all[im].style.display='none'    ; ",!
 w "  MENU.rows(line).all[im-1].style.display='inline';}",!
 ;
 ;w "window.alert(id)",!
 w "for (y=line+1; y<yMax; y++) {",!
 w " o21=MENU.rows(y).getAttribute('VALUE');",!
 w " if (o21.charAt(le)=='1') {MENU.rows(y).style.display='none';",!
 w "   im=MENU.rows(y).all.length-1 ; ",!
 w "   id=MENU.rows(y).all[im].getAttribute('id') ;",!
 w "   if (id.charAt(0)=='o') {",!
 w "     MENU.rows(y).all[im-1].style.display='inline'; ",!
 w "     MENU.rows(y).all[im].style.display='none';}    ",!
 w "  }",!
 w " if (o21.charAt(le)!='1') break;",!
 w "}",!
 w "if (vi=='inline') {yMax=0;}",!
 ;
 w "for (y=line+1; y<yMax; y++) {",!
 w " o21=MENU.rows(y).getAttribute('VALUE');",!
 w " if (o21.charAt(le)!='1') break;",!
 w " if ((o21.charAt(le)=='1')&&(o21.charAt(le+1)!='1')) "
 w "              {MENU.rows(y).style.display='inline';}",!
 w "}"
 w "} </SCRIPT>",!
 ;-------------------------------------------------------------
 w "</HEAD>",!
 w "<BODY bgcolor=#b6c4d5 >",! ;;onload='jsMXmenuStart()' >",!
 d oxxxo
 Q
T1menuA ; Example : conv some enother table to '^T1menu'
 s %B=$c(254)
 s o="" f n=1000:1000 s o=$o(^menu(o)) q:o=""   d
 . s ^T1menu(n)=%B_2_%B_%B_o_%B_%B_%B_"closed",oo=""
 . f nn=100:100 s oo=$o(^menu(o,oo)) q:oo=""  d
 ..  s ^T1menu(n+nn)=%B_1_%B_^menu(o,oo),%=$zr
 ..  i nn=100 s $p(^T1menu(n),%B,5)=$p(^menu(o,oo),%B,3)
 ..  s f=$p(^menu(o,oo),%B,2) q:f=""
 ..  i $d(^AL(f)) s $p(@%,%B,5)=$g(^AL(f,"NAME"))
 Q
mxMENU ;  create frame 'QQMENU'
 d:'$d(^T1menu) T1menuA
 w "<table id=MENU border=0 cellpadding=0 cellspacing=0 >",!
 s o="" f n=0:1 s o=$o(^T1menu(o)) q:o=""  s oo=^(o) d
 . w:n#9=0 "<SCRIPT> </SCRIPT>",!
 . s o21=$p(oo,%B,2),mo=$p(oo,%B,3),mtxt=$p(oo,%B,4),text=$p(oo,%B,5)
 . s ref=$p(oo,%B,6),img=$p(oo,%B,7) s:"- "[text text=mo_" "_mtxt
 . w "<tr title='",$$u^MX(text),"' value=",o21
 . i o21[2 w " onclick=""jsMXmenu(",n,")""; "
 . w " STYLE=""cursor: hand; "
 . w:$e(o21)=1 " display:none; "
 . w " font: icon; "
 . w " margin: 0; padding: 0; border-width: 0; "
 . w " overflow: hidden; color:#112299; "
 . w " "" ><td VALIGN=TOP nowrap >"          ;;;;;;;;;;;;;
 .f o1=1:1:$l(o21) i $e(o21,o1)=1 s oo21=$o(^T1menu(o)) d
 .. i $e(o21,o1+1)=1 w "<img src='menu_bar.gif'>" q
 .. i oo21'="" s oo21=$p(^(oo21),%B,2)
 .. i o21=oo21 w "<img src='menu_tee.gif'>"
 .. else    w "<img src='menu_corner.gif'>"
 .d
 .. i img["closed" d  q
 ...    w "<img id=c",n," src='menu_folder_closed.gif'>"
 ...    w "<img id=o",n," src='menu_folder_open.gif' "
 ...    w " STYLE='display:none;'>"
 .. i $l(img)<3    w "<img id=i",n," src='menu_link_ie.gif'>" q
 .. w "<img id=i",n," src='",img,"'>"
 . ;
 .s x=" w """_n_"""",b=" -- ",tt="b,o21,b,mtxt,b,text,b,ref,b,img"
 .f nn=1:1:$l(tt,",") s x=x_","""_$$u^MX(@($p(tt,",",nn)))_""""
 .d
 .. i $l(ref)>2 w "<a href='",ref,"' >",$$u^MX(text)," </a>" q
 .. i o21_.2[2.2 w mtxt," ",$$u^MX(text) q
 .. w "<a href='XX^MX?&A=",x," ;' target=QQCOMM >",$$u^MX(text)," </a>"
 .w "</td></tr>",!
 w "</table>"
 Q
QQFORM ; TKWEB   ; frame of forms
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99) s:oxxxo="" oxxxo=" k %XD81 i $$d8^MXD "
 W "<HTML>"
 d getVars
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQFORM</TITLE></HEAD>",!
 W "<BODY alink=#437a70 bgcolor=#b6c4d5 leftmargin=0 link=#7d354b marginheight=2 marginwidth=0 text=#222222 topmargin=2 vlink=""#7d354b"" xxOnLoad=xOnLoad()>",!
 W "<table border=0 valign=top cellpadding=0 cellspacing=0 width=542 height=425 style=""position: absolute; left: 44; top: 168"">",!
 W "<tr valign=top> ",!
 W "<td align=center height=61 width=500 > ",!
 W "<p><b><font color=""#5B7693""><font face=""Britannic Bold"" size=""7""> - mxWeb - </font>",!
 W "<font color=#5B7693><br><font size=5 >",$$u^MX($g(^mvars(%USID,0,"%FIRMA"))),"</font></td></tr></table>",!
 ;;;
 ;W "<tr><td valign=top align=center width=55 height=25 ><b>UserName </b></td>",!
 W "<table border=1 valign=top cellpadding=0 cellspacing=0 style=""position: absolute; left: 155; top: 268"">",!
 W "<tr><td valign=top align=center width=55 height=25 style=""align: right "" ><b>UserName </b></td>",!
 W "<td valign=top width=211 height=25 > ",!
 W "<input type=text size=26 maxlength=30 name=UserName tabindex=1 value=CASIO ></td></tr>",!
 W "<tr><td valign=top align=center width=55 height=25 ><b>Password </b></td>",!
 W "<td valign=top width=211 height=25 > ",!
 W "<input type=password size=26 maxlength=25 name=Password tabindex=2 value=CASIO ></td></tr>",!
 W "<tr><td></td><td align=left height=45 width=211> ",!
 W "<p align=left> ",!
 W "&nbsp; <input type=image src=""login.gif"" width=93 height=22 border=0 ></td></tr></table>",!
 d oxxxo
 Q
QQCOMM ; TKWEB  ; frame of comments
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99)
 W "<HTML>"
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>mx-QQCOMM</TITLE></HEAD><BODY>",!
 d oxxxo
 Q
XX ; TKWEB  ; execut &A=oxxxo
 s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")) s:'$l(a) (a,%("ADDRESS"))="127.0.0.1"  s %USID=^o(a)
 s oxxxo=$p(oooo,"&A=",2,99)
 W "<HTML><HEAD><TITLE>mx-XX</TITLE></HEAD><BODY>",!
 d oxxxo
 q
oxxxo ;        ; execut &A=oxxxo
 n (%USID,oxxxo,%) s %j=7,^o("oxxxo")=oxxxo
 i oxxxo'[";!fast!;" s %=$$RestMem^USX,oxxxo=$g(^o("oxxxo"))
 d getVars
 i oxxxo'[";/:\;" x oxxxo i 1
 else  f zxxxo=1:1:$l(oxxxo,";/:\;") s o=$p(oxxxo,";/:\;",zxxxo) x o
 i $g(oxxxo)'[";!fast!;",$g(oxxxo)'[";!rest!;",$$SaveMem^USX
 w "</BODY></HTML>"
 Q
getVars ; get m-vars from enother frames
 n o,oo
 s oo="" f  s oo=$o(%("FORM",oo)) q:oo=""  i oo["_t" d
 . s o=$p(oo,"_") i $l(o) s ^mvars(%USID,0,o)=%("FORM",oo)
 Q
bfRead(f) 
 ; binary files reading
 n o,x o "file":(f:"RI") k ^r
 f o=1:1 u "file" r *x q:$zc  s ^(o\20)=$g(^r(f,o\20))_","_x
 c "file" q o
QQEMPT ; TKWEB  ; empty page
 W "<html><body bgcolor=#b6c4d5>" x "s %UCI=$zu($zv[""Ca""*5)"
 w "<p align=center>",$$d8t^MXD($$pD^MXD($h))," ",%UCI," ",$zv,"</p></body></html>"
 Q
MXTKWEB ; TKWEB   ; frame of ^oTQMret(%USID) --> ^|"%SYS"|omxTKWEB(%mxTKWEB)
 ;;;s oooo=$g(%("COMMAND")),a=$g(%("ADDRESS")),%USID=^o(a)
 ;;;s oxxxo=$p(oooo,"&A=",2,99) s:oxxxo="" oxxxo=" k %XD81 i $$d8^MXD "
 s %mxTKWEB=1 s ^oMonito($h)=$g(oxxxo)_$g(%mxTKWEB)
 s nuf=$g(^oe(%mxTKWEB)),y="",w="" f o="YY","XX" s @o=$g(^oExcelSh(nuf,o))
 s %UCI=$p(nuf,":"),%USID=$p(nuf,":",2),%FORM=$p(nuf,":",3)
 f %=1:1:$l(XX," ") s o=$p(XX," ",%),$p(w,":",+o)=$p(o,":",2)
 f %=1:1:$l(w,":") s o=$p(w,":",%) s:o $p(w,":",%)=o*1.4\1 s:'$l(o) $p(w,":",%)=$p(w,":",%-1)
 f %=1:1:$l(YY," ") s o=$p(YY," ",%),$p(y,":",+o)=$p(o,":",2),$p(y,":",+o)=($p(y,":",+o)\1)
 ;;f %=1:1:$l(y,":")+99 s o=$p(y,":",%) s:o $p(y,":",%)=o*1 s:'$l(o) $p(y,":",%)=$p(y,":",%-1)
 W "<HTML>"
 ;;d getVars
 ;w "<META http-equiv=""Content-Type"" content=""text/html; charset=windows-1257"">",!
 w "<HEAD><TITLE>-mx-oTQMret-oTKW-</TITLE></HEAD>"
 W "<BODY alink=#437a70 bgcolor=#b6c4d5 leftmargin=0 link=#7d354b marginheight=1 marginwidth=0 text=#222222 topmargin=2 vlink=""#7d354b"" xxOnLoad=xOnLoad()>"
 ;;w y
 W "<table border=0 valign=top cellpadding=0 cellspacing=0 >"
 W "<tr valign=top> "
 W "<td align=center height=6 width=500 > "
 ;W "<p><b><font color=""#5B7693""><font face=""Britannic Bold"" size=""3"">mxWeb "_$g(%ns)_" "_$g(%USID)_" "_$g(%FORM)  ;;_" </font>",!
 W "<p><b><font color=""#5B7693"">",nuf,"  %UCI=",%UCI," </font>"
 ;;W "<font color=#5B7693><br><font size=5 >",$$u^MX($g(^mvars(%USID,0,"%FIRMA"))),"</font></td></tr></table>",!
 ;;;
 ;W "<tr><td valign=top align=center width=55 height=25 ><b>UserName </b></td>",!
 ;;;W "<table border=1 valign=top cellpadding=0 cellspacing=0 style=""position: absolute; left: 155; top: 268"">",!
 ;;;W "<tr><td valign=top align=center width=55 height=25 style=""align: right "" ><b>UserName </b></td>",!
 ;;;W "<td valign=top width=211 height=25 > ",!
 ;;;W "<input type=text size=26 maxlength=30 name=UserName tabindex=1 value=CASIO ></td></tr>",!
 ;;;W "<tr><td valign=top align=center width=55 height=25 ><b>Password </b></td>",!
 ;;;W "<td valign=top width=211 height=25 > ",!
 ;;;W "<input type=password size=26 maxlength=25 name=Password tabindex=2 value=CASIO ></td></tr>",!
 ;;;W "<tr><td></td><td align=left height=45 width=211> ",!
 ;;;W "<p align=left> ",!
 ;W "&nbsp; <input type=image src=""c:/mx/lamxxxer.gif"" width=55 height=22 border=0 ></td></tr></table>"
 ;;;d oxxxo
 ;;;W "<table border=1 valign=top cellpadding=0 cellspacing=0 style=""position: absolute; left: 155; top: 268"">",!
 W "<table border=0 valign=top cellpadding=0 cellspacing=1 <font color=""#2B3633"" size=1 /font> >"
 k flagTabl s %YXy=0,flagTabl=0,yy=10,h=1,y2=0,%YXxm=0,%th=0
 f %2yy=1:1:99 s %YXy=$o(^oe(nuf,%YXy)),y2='flagTabl+y2 q:'%YXy  q:'$o(^oe(nuf,%YXy,2))  d:00 MXTKWEBt s ww=11,%=$p(y,":",y2) s:%="" %=h s h=% i h f %YXx=2:1 s:'$o(^oe(nuf,%YXy,%YXx-.1)) %YXx=0 d:%YXx  i '%YXx w "</tr>" s yy=yy+h+5+(''flagTabl*2) q
 . i %YXx=2 s %0=$g(^oe(nuf,%YXy,0)) s:%0 %th=0,flagTabl=%0 i '%th,'%0,$g(^oe(nuf,%YXy+3,0))+$g(^oe(nuf,%YXy+4,0)) s %th=1 d MXTKWEBt
 . i %YXx=2,flagTabl,'%0 k flagTabl s flagTabl=0 w "</table><table border=0 valign=top cellpadding=0 cellspacing=0 ><tr>" 
 . i %YXx=2 w "<tr>"  ;;,"<td>",%th,"</td>","<td>",flagTabl,"</td>","<td>",%0,"</td>"
 . q:'$p(w,":",%YXx)  s oo=$g(^(%YXx)) w:oo["$$B " $$ooB(oo) s:"?"[$e(oo) oo=""  s:%YXx>%YXx %YXxm=%YXx
 . i flagTabl,oo=0!(oo&$p(oo,".",2)),%YXx>3 s oo=$j(oo,0,2),flagTabl(%YXx)=2 s:'oo oo=""
 . i $g(flagTabl(%YXx))=2,oo=0!oo s oo=$j(oo,0,2) s:'oo oo=""
 . s a=" " i %YXx>3&oo!$g(flagTabl(%YXx)) s a=" align=right " 
 . s cc=" " i a=" ",$l(oo)>2,%th,$g(^oe(nuf,%YXy,%YXx+1))="" s cc=" COLSPAN=2 "
 . s o="""#3B5673"" size=2" s:$e(oo)="=" o="""#2B2623"" size=2",oo=$$funExcel(oo) s font="<font color="_o_" /font>"
 . ;;w "<td wrap height="_(h+5)_" style=""position: absolute; height: "_(h+5)_"; width:"_$p(w,":",%YXx)_"; left:"_ww_"; top:"_yy_""" "_a_cc_$$MXTKWEBf(.oo)_" >"_font_"<NOBR>",$$u^MX($e(" "_oo_" ",1,50)),"</NOBR></td>"
 . i %th w "<th BGCOLOR=""#a6b4c5"" width="_$p(w,":",%YXx)_" wrap height="_(h+5)_" "_a_cc_$$MXTKWEBf(.oo)_" >",font,$$u^MX(" "_oo_" "),"</th>"
 . i '%th w "<td width="_$p(w,":",%YXx)_" wrap height="_(h+5)_" "_a_cc_$$MXTKWEBf(.oo)_" >",font,"<NOBR>",$$u^MX(" "_oo_" "),"</NOBR></td>"
 . ;;w "<td style=""border-right: 1px solid gray; border-bottom: 1px solid gray;"" width="_$p(w,":",%YXx)_a_$$MXTKWEBf(.oo)_" ><font color=""#6B8693"" size=2 /font>",$$u^MX(" "_oo),"</td>"
 . s ww=ww+$p(w,":",%YXx)+1
 . i cc[2 s %YXx=%YXx+1
 w "</table>"
 d
 .W "<table border=0 valign=top cellpadding=0 cellspacing=1 style=""font: size=1"" >"
 .s %YXy=0,%YXxm=20
 .f  s %YXy=$o(^oe(nuf,%YXy)) q:'%YXy  w "<tr><td>",%YXy,"</td>" f %YXx=0:1:%YXxm s oo=$g(^oe(nuf,%YXy,%YXx)) s:$e(oo)="?" oo="" w "<td>",font,$$u^MX(oo),"</td>" i %YXx=%YXxm w "</tr>"
 .w "</table>"
 .q
 w "<table border=1><tr><td> UCI=",%UCI,"</td><td> %USID=",%USID,"</td><td> %mxForma=",%FORM,"</td><td>   ",$$pD^MXD($H,2),"</td><td><input type=image src=""c:/mx/lamer.gif"" width=55 height=22 border=0 ></td></tr>"
 w "</table>"
 i $zv["Ca"!($zv["IRIS") x "s %fromUCI=$zu($zv[""Ca""*5)" i %fromUCI="%SYS" zn %UCI d  zn %fromUCI
 .n %UCI,%fromUCU x "s %UCI=$zu($zv[""Ca""!($zv[""IRIS"")*5)"
 .W "<table border=1 valign=top cellpadding=0 cellspacing=1 style=""font: size=1"" >"
 .s %form=0  w "<tr><td>",%UCI,"</td>"
 .f  s %form=$o(^oTKMe0(%USID,%form)) q:%form=""  w "<td>",%UCI,":",%USID,":",%form,"</td>"
 .w "</tr></table>"
 .q
 i $zv["Ca"!($zv["IRIS") x "s %fromUCI=$zu($zv[""Ca""*5)" i %fromUCI="%SYS" zn %UCI d  zn %fromUCI
 .s %mxForma=%FORM,%j=1,o=$$NewDate^MXD
 .k ^oTQM(%USID) m ^oTQM(%USID)=^oTQMe0(%USID,%mxForma)  s o=$$TQM^MXTQM()
 .W "<table border=0 valign=top cellpadding=0 cellspacing=1 style=""font: size=1; color=green "" >"
 .s %YXy=0,%YXxm=20
 .f  s %YXy=$o(^oTQMret(%USID,%YXy)) q:'%YXy  w "<tr><td>",%YXy,"</td>" f %YXx=0:1:%YXxm s oo=$g(^oTQMret(%USID,%YXy,%YXx)) s:$e(oo)="?" oo="" w "<td>",font,$$u^MX(oo),"</td>" i %YXx=%YXxm w "</tr>"
 .w "</table>"
 .q
 w "<a href='http://www.gismeteo.ru/towns/26406.htm'><img src='http://informer.gismeteo.ru/graph/G26406-1.GIF' border=0></a>"
 w "</BODY></HTML>"
 Q
MXTKWEBt s:$g(^oe(nuf,%YXy,1))="~" $p(y,":",%YXy)=0
 ;;s o=$g(^oe(nuf,%YXy+1,1)) i o-1,$o(^oe(nuf,%YXy))'["." q
 ;;i $g(^oe(nuf,%YXy,1))_$g(^oe(nuf,%YXy-1,1))="__" q
 w "</table><table border=1 valign=top cellpadding=0 cellspacing=0 >" ;;s flagTabl=-%YXy
 ;;s o=$o(^oe(nuf,%YXy)) i o["." s flagTabl=$p(o,".",2)+2 
 ;;w "</table>" W "<table style=""border-left: 1px solid black; border-top: 1px solid black;"" valign=top cellpadding=0 cellspacing=1 >" s flagTabl=%YXy
 q
MXTKWEBf(oo) 
 q:oo'["<mx " ""  s f=$p(oo,"<mx ",2,9),oo=$p(oo,"<mx ")
 i $p(f,"ic",2) ;; w " BGCOLOR=""#b6d4d5""" 
 q ""
funExcel(oo,z,%y,%x) 
 n %,%1,%2,y1,y2,o,o9,y  s o9="1234567890,:",%y=$g(%y,%YXy),%x=$g(%x,%YXx)
 q:$e(oo)'="=" oo s:'$d(z) z=$name(^oe(nuf))
 s %1=$p(oo,":"),%2=$p(oo,":",2),y1=$tr(%1,o9_%1,o9),y2=$tr(%2,o9_%2,o9)
 s:oo["=SUBTOTAL(" y1=$p(y1,",",2) s y1=+y1,y2=+y2
 i y1+1=y2,+$g(@z@(y2,0))=1 f %=y2:1 q:'$g(@z@(%,0))  s y2=% 
 i 11111_oo["1111=SUM(" f y=y1:1:y2 s oo=oo+$g(@z@(y,%x))
 i 1_oo["1=SUBTOTAL(9," f y=y1:1:y2 s oo=oo+$g(@z@(y,%x))
 i 1_oo["1=SUBTOTAL(3," f y=y1:1:y2 s oo=oo+''$l($g(@z@(y,%x)))
 q:oo["." $j(oo,0,2)  q oo
sysTKWEB(%) s %sys="MGR,MXM" s:$zv["Ca" %sys="USER"  s:'$g(%) %=1
 x "s %UCI=$zu($zv[""Ca""*5),nuf=%UCI_"":""_%USID_"":""_%mxForma"
 k ^|%sys|oe(+%) m ^|%sys|oe(+%)=^oTQMe(%USID) s ^|%sys|oe(+%)=nuf
 k ^|%sys|oe(nuf) m ^|%sys|oe(nuf)=^oTQMe(%USID)
 k ^|%sys|oExcelSh(nuf) m ^|%sys|oExcelSh(nuf)=^oExcelSh(%USID,%mxForma)
 q %
ooB(oo) q ""  
 w "<td><FORM width=5 height=4 NAME=""Form1"" ACTION="""_$$u^MX("//localhost.MXTKWEB^MX2:1")_""">"
 ; {1072}<INPUT TYPE="hidden" NAME="info" VALUE="{1047}{1072}{1087}{1080}{1089}{1100} {1074}{1072}{1073}{1072}{1085}{1102} {1085}{1072}{1072}{1074}{1086}{1089}{1082}{1088}{1077}{1089}{1077}{1085}{1100}{1077}">
 ;{1072} <INPUT TYPE="radio" NAME="sex" VALUE="Male" CHECKED> {1052}{1091}{1078}{1080}{1082}<BR>
 ; {1072}<INPUT TYPE="radio" NAME="sex" VALUE="Female"> {1041}{1072}{1073}{1072}<BR>
 ; {1072} {1048}{1084}{1103}:<BR>
 ; {1072}<INPUT TYPE="text" NAME="textfield" VALUE="{1042}{1072}{1089}{1103} {1055}{1091}{1087}{1082}{1080}{1085}" SIZE="30" MAXLENGTH="60"><BR>
 ; {1072} {1055}{1072}{1088}{1086}{1083}{1100}:<BR>
 ;{1072} <INPUT TYPE="password" WIDTH="10" NAME="passwd"><BR><BR>
 w "<INPUT TYPE=""submit"" VALUE="" "" width=4 height=3 >"
 w "</FORM></td>"
 q ""
GTMLINK(port) 
   ;Based on Socket Examples from fscwitte@users.sourceforge.net
   ; NO ^ROUTINE ENTRY
   n ver
   s:port="" port=8000
   s ver=$e($zv,1,10)
     i ver["GT.M" j START^%MLINK(port) q
     i ver["Cache" j srv^%MLINK(port) q
   QUIT
   ;
START(%ZNPort)   ;Start the Server
   ;S %ZNPort=800
   S %ZNDev="SCK$"_$J
   O %ZNDev:(ZLISTEN=%ZNPort_":TCP":NODELIMITER:ATTACH="listener"):60:"SOCKET"
   E  Q
   ; USE fills $KEY with "BOUND|socket_handle|portnumber"
   U %ZNDev
   ;
   ; Start listening, sets $KEY to "LISTENING|socket_handle|portnumber"
   W /LISTEN(1)
   ;
   ; Wait for connection, $KEY will be "CONNECT|socket_handle|remote_ipaddress"
1 
   F  D  q:$KEY]""
   . W /WAIT(60)
   . I $KEY]"" Q
   ;
   ; Store the connection socket in local variable,
   S %ZNSock=$piece($KEY,"|",2)
   C %ZNDev:(SOCKET="listener") J START^GTMLINK ;close listener and start another GT.M Link to listen port
   S $ZTRAP="GOTO ERROR^GTMLINK"
2   U %ZNDev:(SOCKET=%ZNSock)
   W "glc_READY:",$c(0)
   ;
   s qqnump=$j
   x "s qW=##class(%Library.qWORD).%New()"
   x "s qARM=##class(%Library.TqARM).%New()"
     s qqlang=1
3       F  D      
   . s %ZNData=$$GETDATA() q:%ZNData=""
   . i %ZNData="" q
   . q:%ZNData=$c(1)
   . I %ZNData="glc_EXIT:" W "glc_DISCONNECTED:",$c(0) s ^tmplink("close",$j)=$h_"~EXIT" C %ZNDev H
   . I $P(%ZNData,":",1)="glc_EXECUTE" D
   .. W $c(1,2,3,4,5,6,7,8,9)
   .. I %ZNData["getsessionid=1" k:$d(^%session($JOB)) ^%session($JOB) s ^%session($JOB)=$h
   .. F %ZTemp=0:1:9 s %Var="P"_%ZTemp,@%Var=$p(%ZNData,$c(1),%ZTemp+2)
   .. S %ZNCommand=$P($P(%ZNData,":",2,9999),$c(1),1)
   .. S:%ZNCommand[($c(5)_"xmldata=1") %ZNCommand=$p(%ZNCommand,$c(5)_"xmldata=1",1)
   .. S P9=""  
   .. X:%ZNData'["getsessionid=1" %ZNCommand
   .. s:%ZNData["getsessionid=1" P0=$JOB
   .. F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   .. W "glc_EXRESPONSE:<registry>",P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$c(1)
   .. W $c(9,8,7,6,5,4,3,2,1)
   s ^tmlink("close",$j)=$h
   C $I
   H
GETDATA() 
         n c,d,end,c1
         S (d,end,c1,c)=""
         d FINDST
         f  d  q:end=1
         .R *c:60 q:'$T
         .S d=d_$C(c)
         .S c1=c1_c
         .s:c1[987654321 d=$p(d,$c(9,8,7,6,5,4,3,2,1),1),end=1
         .q
         s ^tmlink("open",$j)=d
         q d
FINDST 
         n c,end,str
         s (c,end,str)=""
         f  d  q:end=1
         .R *c:60 q:'$T
         .q:(c<1)!(c>9)
         .s str=str_c
         .s:str[123456789 end=1
         .q
         q
ERROR 
   W $c(1,2,3,4,5,6,7,8,9)
   F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   s ^GTMERROR($j,$h)=$TR($ZSTATUS,$C(13,10),"")
   U %ZNDev:(SOCKET=%ZNSock)
   W "glc_ERROR:"_$TR($ZSTATUS,$C(13,10),""),$C(1),"<registry>",P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$C(1),$c(9,8,7,6,5,4,3,2,1)
   g 3
sererror 
   W $c(1,2,3,4,5,6,7,8,9)
   F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   s ^GTMERROR($j,$h)=$ZERROR
   W "glc_ERROR:"_$zerror,$C(1),"<registry>",P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$C(1),$c(9,8,7,6,5,4,3,2,1),*-3 
   g 4
srv(port) 
     n dev,mode,jobflag,id,end
     S dev="|TCP|"_port
 ;; // 4 transfer to job open socket        
    s $zt="error" 
    S mode="AS" 
    s end=""
    S jobflag=4
    O dev:(:port:mode::32767:32767) 
    f  d  q:end=1
    .U dev R x:30 ;; // wait connection
    .i $T J srvj(port):(:jobflag:$IO:$IO):0 s end=1
    .q
error 
   c dev  
   j srv^%MLINK(port)
  q
srvj(port) 
   n id,in,d,str,dev
   s $zt="sererror"
   s d=""
   W "glc_READY:"_$c(0),*-3  
4  F  D          
   . s %ZNData=$$GETDATA() q:%ZNData=""
   . i %ZNData="" q
   . q:%ZNData=$c(1)
   . I %ZNData="glc_EXIT:" W "glc_DISCONNECTED:",$c(0) s ^tmplink("close",$j)=$h_"~EXIT" H
   . I $P(%ZNData,":",1)="glc_EXECUTE" D
   .. s value=""
   .. W $c(1,2,3,4,5,6,7,8,9)
   .. I %ZNData["getsessionid=1" k:$d(^%session($JOB)) ^%session($JOB) s ^%session($JOB)=$h
   .. F %ZTemp=0:1:9 s %Var="P"_%ZTemp,@%Var=$p(%ZNData,$c(1),%ZTemp+2)
   .. S %ZNCommand=$P($P(%ZNData,":",2,9999),$c(1),1)
   .. S:%ZNCommand[($c(5)_"xmldata=1") %ZNCommand=$p(%ZNCommand,$c(5)_"xmldata=1",1) 
   .. s P9=""
   .. ;; //s:($tr(%ZNCommand," ")'="")&(%ZNData'["getsessionid=1") %ZNCommand=$$GetFunc(%ZNCommand)
   .. d:%ZNData'["getsessionid=1" Ex(.%ZNCommand)
   .. i %ZNData'["getsessionid=1" s ^Aaa("com")=%ZNCommand x %ZNCommand
   .. s:%ZNData["getsessionid=1" P0=$JOB
   .. F %ZTemp=0:1:9 S %Var="P"_%ZTemp I '$D(@%Var) S @%Var=""
   .. W "glc_EXRESPONSE:<registry>",value,$C(1),P0,$C(1),P1,$C(1),P2,$C(1),P3,$C(1),P4,$C(1),P5,$C(1),P6,$C(1),P7,$C(1),P8,$C(1),P9,$c(1)
   .. W $c(9,8,7,6,5,4,3,2,1),*-3 
   ..q
   .q
   Q       
Ex(Cmd) 
   q:Cmd=""
   f  q:($e(Cmd)'=" ")!(Cmd="")  s Cmd=$e(Cmd,2,32000)
   q:Cmd=""
   i $e(Cmd)="$" s Cmd="s value="_Cmd q
   i $e(Cmd)="=" s Cmd="s value"_Cmd q
   q
   ;  //end//  GT.M Link Server - by paulo.rogerio@zipmail.com.br  ; Compiled April 3, 2007 11:16:22
 ;; {1052}{1086}{1078}{1085}{1086} {1074}{1099}{1082}{1080}{1085}{1091}{1090}{1100}
 ;; s{1072}qqnump=$j
 ;; s{1072}qW=##class(%Library.qWORD).%New()
 ;; s{1072}qARM=##class(%Library.TqARM).%New()
 ;; s{1072}qqlang=19
 ;; {1056}{1072}{1073}{1086}{1090}{1072}{1077}{1090} {1083}{1077}{1090} 15 {1087}{1086} cache {1080} GT.M
 ;; 123456789 - {1087}{1072}{1082}{1077}{1090} {1074}{1085}{1072}{1095}{1072}{1083}{1077} {1087}{1077}{1088}{1077}{1076}{1072}{1095}{1080}
 ;; 987654321 - {1074} {1082}{1086}{1085}{1094}{1077}
 ;; {1064}{1083}{1077}{1090} {1076}{1072}{1085}{1085}{1099}{1077} {1082}{1072}{1082} {1087}{1086}{1090}{1086}{1082}{1086}{1084} , {1090}{1072}{1082} {1080} {1090}{1080}{1087}{1072} {1087}{1086} {1082}{1086}{1084}{1072}{1085}{1076}{1077} {1072}{1085}{1072}{1083}{1086}{1075}{1072} VisM
 ;; {1054}{1090}{1076}{1077}{1083}{1100}{1085}{1086} {1084}{1086}{1078}{1085}{1086} {1087}{1077}{1088}{1077}{1076}{1072}{1074}{1072}{1090}{1100} {1080} {1087}{1086}{1083}{1091}{1095}{1072}{1090}{1100} {1088}{1077}{1075}{1080}{1089}{1090}{1088}{1099} {1086}{1090} P0 {1076}{1086} P9

MXD
MXD ;  [ 04/26/2006  6:08 PM ]  ;[ 20170821 15:08:20 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx ( multi-user virtual EXCEL incorporated into the database )
 ; vmx Copyright(c) 2005-2016, SIA ENTERS, Latvia, Reg.Nr.42102022219
 ; registered by Agency INTELS, Riga, Latvia, reg.40003134156, on June 28, 2005, Nr.178
 ; 
pD(%H,t) ;CONVERTS %H,$H TO ggggmmdd
 i $e(%H,1,4)="^mM(" s %H=+$e(%H,5,99),%H=$tr($e(%H,1,$l(%H)-1),".",",")
 n time,o s time=""
 i $g(t) s o=$s(%H[".":".",1:","),time=+$e($p(%H,o,2),1,5) s:'time time="" d:time
 .s time=" "_$e(time\3600+100,2,3)_":"_$e(time#3600\60+100,2,3)_":"_$e(time#60+100,2,3)
 n %LY,%R,%Y,%D,%M,%I,%DAT1 s %H=$g(%H,$h)\1,%H=%H>21914+%H
 S %LY=%H\1461,%R=%H#1461,%Y=%LY*4+1841+(%R\365),%D=%R#365,%M=1
 I %R=1460,%LY'=14 S %D=365,%Y=%Y-1
 F %I=31,(%R>1154)&(%LY'=14)+28,31,30,31,30,31,31,30,31,30 Q:%I'<%D  d
 .s %M=%M+1,%D=%D-%I
 I %D=0 S %Y=%Y-1,%M=12,%D=31
 q:$g(t)=-1 time  q %Y_$e(100+%M,2,3)_$e(100+%D,2,3)_time
dmE(%d,%8) 
 i '$d(%d),@%N="-" q "-"
 i +$g(%d)>2000 s %d=$tr(%d,1234567890_%d,1234567890),%d=$$dmg(%d)
 n %2 s:$g(%d) %2=$p(%d," ",2,9),%d=$p(%d," ") s:'$d(%d) %2=$p(@%N," ",2,9)
 n %o,% s:'$g(%8)&'$g(%d) %8="8+" s:+$g(%d)=8 %8=%d s:'$g(%8) %8=8
 i $g(%d) s %d=$tr(%d,"-/{1102}123456780.9"_%d,"...123456780.9"),%o=$$dmg(%d,%8),%=$$d31(%o,%8) s:%'?8n %d=$$dmg(%o) q:'$l(%2) %d q %d_" "_%2
 s @%N=$tr(@%N,"-/{1102}123456780.9"_@%N,"...123456780.9"),%o=$$dmg(@%N,%8),%=$$d31(%o,%8)
 s:%'?8n %E=% s:%E="" (oo,@%N)=$$dmg(%o) s:$l($g(%2)) (oo,@%N)=oo_" "_%2
 q @%N
gmd(d8,p2) 
 i $g(p2)=8,d8>999 q $e($tr(d8,1234567890_d8,1234567890),1,8)
 i +d8?8n q $e(+d8,1,4)_"."_$e(+d8,5,6)_"."_$e(+d8,7,8)
 q:'$d(p2) $$dmg(d8) q $$dmg(d8,p2)
mdg(d8,p2) q:+d8'?8n d8
 q:$g(p2)'["/" $e(+d8,5,6)_"."_$e(+d8,7,8)_"."_$e(+d8,1,4) q $e(+d8,5,6)_"/"_$e(+d8,7,8)_"/"_$e(+d8,1,4)
 q d8
dmg(d8,p2) s:$g(%LANG)="" %LANG="LV"
 n o1,o2,o3,% s p2=$g(p2) s:d8<0 d8=$e(d8,2,99) q:'d8 d8  s:$p(d8,"/",2) d8=$tr(d8,"/",".")
 s o1="janv{257}ris febru{257}ris marts apr{299}lis maijs j{363}nijs j{363}lijs augusts septembris oktobris novembris decembris"
 s:%LANG["RU" o1="{1103}{1085}{1074}{1072}{1088}{1103} {1092}{1077}{1074}{1088}{1072}{1083}{1103} {1084}{1072}{1088}{1090}{1072} {1072}{1087}{1088}{1077}{1083}{1103} {1084}{1072}{1103} {1080}{1102}{1085}{1103} {1080}{1102}{1083}{1103} {1072}{1074}{1075}{1091}{1089}{1090}{1072} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1103} {1086}{1082}{1090}{1103}{1073}{1088}{1103} {1085}{1086}{1103}{1073}{1088}{1103} {1076}{1077}{1082}{1072}{1073}{1088}{1103}"
 s:"DE"[%LANG o1="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 s:"EN GB"[%LANG o1="January February March April May June July August September October November December"
 s:%LANG="UA" o1="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 i '$g(p2) q:+d8?6n $e(d8,1,4)_".gada  "_$p(o1," ",$e(d8,5,6))
 I d8?8n,d8>19000000,d8<21110000 s:p2-8=0 %E=$$d31(d8,p2) q $e(d8,7,8)_"."_$e(d8,5,6)_"."_$e(d8,1,4) 
 i d8'["." q d8
 i '$p(d8,".",3) s $p(d8,".",3)=$e($$d8,1,4)
 s o1=$e(100+$p(d8,"."),2,3),o2=$e(100+$p(d8,".",2),2,3),o3=$p(d8,".",3),o3=$s(o3<100:o3+2000,1:o3)
 i p2=8 s %=$$d31(o3_o2_o1,8) q:'$l(%) o3_o2_o1 q %
 q o3_o2_o1
d8t(d8,mm) 
 n o1,o2 s:$g(%LANG)="" %LANG="LV"
 s o1="janv{257}ris febru{257}ris marts apr{299}lis maijs j{363}nijs j{363}lijs augusts septembris oktobris novembris decembris"
 s:%LANG["RU" o1="{1103}{1085}{1074}{1072}{1088}{1103} {1092}{1077}{1074}{1088}{1072}{1083}{1103} {1084}{1072}{1088}{1090}{1072} {1072}{1087}{1088}{1077}{1083}{1103} {1084}{1072}{1103} {1080}{1102}{1085}{1103} {1080}{1102}{1083}{1103} {1072}{1074}{1075}{1091}{1089}{1090}{1072} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1103} {1086}{1082}{1090}{1103}{1073}{1088}{1103} {1085}{1086}{1103}{1073}{1088}{1103} {1076}{1077}{1082}{1072}{1073}{1088}{1103}"
 s:"DE"[%LANG o1="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 i "EN GB"[%LANG s o1="January February March April May June July August September October November December" i d8?8n,"GB EN"[$g(mm) q $p(o1," ",$e(d8,5,6))_" "_$e(d8,7,8)_", "_$e(d8,1,4)
 s mm=$g(mm,o1)
 s:d8<0 d8=-d8 q:'d8 ""  q:+d8?6n $e(d8,1,4)_".gada  "_$p(mm," ",$e(d8,5,6))
 I '$p(d8,"-",2),d8>0 q $e(d8,1,4)_".gada "_$e(d8,7,8)_"."_$p(mm," ",$e(d8,5,6))
 s o1=$e(+d8,1,4)_".gada "_$e(+d8,7,8)_"."_$p(mm," ",$e(+d8,5,6)),o2=+$p(d8,"-",2)
 q o1_" - "_$e(o2,1,4)_".gada "_$e(o2,7,8)_"."_$p(mm," ",$e(o2,5,6))
d8(d,d31,dBas) 
 s d=$g(d)
 i d="",$g(%YXy),$g(%YXx) q:+$g(oYX(%YXy-1,%YXx-1))?8n +oYX(%YXy-1,%YXx-1)  q:+$g(oYX(%YXy-1,%YXx))?8n +oYX(%YXy-1,%YXx)
 i $l(d)>4!'d,+d'?8n q $$pD($h)
 i +d?8n!'$d(dBas) q:$$d31(+d,$g(d31))'="" $$d31(+d,$g(d31)) q +d
 s:+dBas'?8n dBas=$$pD($h+dBas) s:d<10 d=0_+d s:$l(d)=3&(d=+d) d=0_d s:$l(d)<5 d=$e(+dBas,1,8-$l(d))_d q:$$d31(d,8)'="" $$d31(d,8)
 q d
d31(d,N,dmin) 
 q:'$g(N) 28+$e(3_($e(d,3,4)#4=0)_3232332323,$e(d,5,6)) s dmin=$g(dmin,19000101)
 i N>1111 q:-d'[-N "ERROR: d="_+d_", is off range "_N  s N=$l(+N)
 i N<9,$l(+d)<N q:'d "enter date "_$e("ggggmmdd",1,+N)  q "ERROR: d="_+d_", is too short, length must "_N
 i N'["+",N<9,d>$e($$pD($h),1,$l(+d)),d>($g(%gm(1))_31),$g(%gm(1))?6n q "ERROR: d="_+d_" > {353}odien/today="_$$pD($h)
 i d<dmin q "ERROR: "_+d_" < "_dmin
 i d>20990101 q "ERROR: "_+d_" > 20990101"
 i N>5,$e(d,5,6)<1!($e(d,5,6)>12) q "ERROR: d="_+d_", MONTH="_$e(d,1,6)
 i N>7,$e(d,7,8)=33,mxConfig[":ggggmm33:" q ""
 i N>7,$e(d,5,6)=12,$e(d,7,8)>31,$e(d,7,8)<35 q ""   ;;;;;;;;;;;;; mxConfig[":ggggmm33:"
 i N>7,($e(d,7,8)<1&(mxConfig'[":ggggmm00:"))!($e(d,7,8)>(28+$e(3_($e(d,3,4)#4=0)_3232332323,$e(d,5,6)))) q "ERROR: DAY="_$e(d,1,8)
 q ""
dmgCheck(d,dMin) 
 n %,d0 s d0=d s:$g(dMin)?4n dMin=dMin_"0101"
 g:d?8n dmgChecE s d=$tr(d,"/ \{1102}.1234567890"_d,".....1234567890")
 i d>1900,$p(d,".",2),$p(d,".",3) s d=$tr(d,".")_$e($p(d,".",2)+100,2,3)_$e($p(d,".",3)+100,2,3) g dmgChecE
 i $p(d,".",3)>1900 s d=$p(d,".",3)_$e($p(d,".",2)+100,2,3)_$e($p(d,".")+100,2,3) g dmgChecE
 i $p(d,".",3) s d=$p(d,".",3)+2000_$e($p(d,".",2)+100,2,3)_$e($p(d,".")+100,2,3) g dmgChecE
 n d00 s d00=$$pD($h)
 i $p(d,".",2) s d=$e(d00,1,4)_$e($p(d,".",2)+100,2,3)_$e($p(d,".")+100,2,3) g dmgChecE
 i d>99 s d=$e(d00,1,4)*10000+d g dmgChecE
 i d s d=$e(d00,1,6)*100+d g dmgChecE
dmgChecE i d?8n s %E=$$d31(d,8,$g(dMin)) q:'$l($g(%E)) $$dmg(d) q d0 
 s %E=d0_" : ERROR in DATE" s:'d %E=" date is null "  q d0
d8plus(d8,p) 
 q:'p d8
 n %,%1,%2,%3 s %3=d8#100,%2=$e(d8,5,6),%1=$e(d8,1,4) i p+%3<29,p+%3>0 q d8+p
 i p>0 f %=1:1:p s %3=%3+1 d:%3>27
 .i 28+$e(3_($e(%1,3,4)#4=0)_3232332323,%2)<%3 s %3=1,%2=%2+1
 .i %2>12 s %2=1,%1=%1+1
 i p<0 f %=1:1:-p s %3=%3-1 d:%3<1
 .s %2=%2-1 s:%2<1 %2=12,%1=%1-1 s %3=28+$e(3_($e(%1,3,4)#4=0)_3232332323,%2)
 q %1*100+%2*100+%3
daStatus(%d,%0) 
 s %0=$g(%0,$$d8) s:$p(%d,".",2) %d=$$dmg(%d) q:%d'?8n ""  s:$p(%0,".",2) %0=$$dmg(%0)
 q:%d<%0 "EX<mx ic7"  q:%d<(%0+100) "W<mx ic44"
 q "ok<mx ic2 fc10"
multD(d1,d2,p,K,d00) 
 n %,d s d=d1,d00=$g(d00) f %="d1","d2","d00" s:$p(@%,".",2) @%=$$dmg(@%)
 i p["{1088}{1072}{1079}" q:(d00<d1!(d00>d2))&d00 0  q:d1'>d2 1 q 0
 f %=1:1:999999 s d=$$nextD(d,d2,p) q:d>d2!'d  i $g(K),%>K q
 q %-1
nextD(d8,d8m,p) 
 n d,%,d s d=0 s:d8["." d8=$$dmg(d8) s:d8m["." d8m=$$dmg(d8m) q:d8'?8n 0  q:d8m'?8n 0
 q:d8>d8m 0 q:d8=d8m d8
 i p="{1075}{1086}{1076}" s d=d8+10000 q:d>d8m 0 q d
 i p["{1085}{1077}{1076}{1077}" s d=$$d8plus(d8,7) q d
 i p["{1076}{1077}{1082}{1072}" s d=$$d8plus(d8,10) q d
 i p["{1084}{1077}{1089}{1103}" s d=d8+100,%=$e(d,5,6) s:%>12 d=$e(d,1,4)+1_$e(%-12+100,2,3)_$e(d,7,8)
 i p["{1082}{1074}{1072}{1088}" s d=d8+300,%=$e(d,5,6) s:%>12 d=$e(d,1,4)+1_$e(%-12+100,2,3)_$e(d,7,8)
 i p["{1087}{1086}{1083}{1091}" s d=d8+600,%=$e(d,5,6) s:%>12 d=$e(d,1,4)+1_$e(%-12+100,2,3)_$e(d,7,8)
 i d#100>28 s %=$e(d,1,6)_$$d31(d) q:%<d %
 q d
icDate(p1,p2) 
 n m,%,%1,%2  s:$g(%LANG)="" %LANG="LV"
 s %XD81=p1,%XD82=p2,%gm=p2\100,%gm0=%gm\100*100,%gm1=%gm0+1
 s m=0 f %=%gm:-1:%gm-100 s:%#100=0 %=%-88  s %gm(m)=%,m=m-1
 s m=0 f %=%gm:+1:%gm+100 s:%#100=13 %=%+88 s %gm(m)=%,m=m+1
 s %ggmm=$s(-%gm[-2:%gm,1:%gm#10000)_":"_%USID
 k %Quarter i "01 04 07 10"[$e(%XD81,5,6),$e(%XD81,1,6)+2=%gm,$e(%XD82,7,8)>29 s %Quarter=%gm#100\3_" quarter "_$e(%gm,1,4)
 S %MONTHS="jan feb mar apr mai j{363}n j{363}l aug sep okt nov dec"
 s menesi="janv{257}ris febru{257}ris marts apr{299}lis maijs j{363}nijs j{363}lijs augusts septembris oktobris novembris decembris"
 s menesa="janv{257}r{299} febru{257}r{299} mart{257} apr{299}l{299} maij{257} j{363}nij{257} julij{257} august{257} septembr{299} oktobr{299} novembr{299} decembr{299}"
 s MENESI="JANV{256}RIS FEBRU{256}RIS MARTS APR{298}LIS MAIJS J{362}NIJS J{362}LIJS AUGUSTS SEPTEMBRIS OKTOBRIS NOVEMBRIS DECEMBRIS"
 d:%LANG="RU" 
 .S %MONTHS="{1103}{1085}{1074} {1092}{1077}{1074} {1084}{1072}{1088}{1090} {1072}{1087}{1088} {1084}{1072}{1081} {1080}{1102}{1085}{1100} {1080}{1102}{1083}{1100} {1072}{1074}{1075} {1089}{1077}{1085} {1086}{1082}{1090} {1085}{1086}{1103} {1076}{1077}{1082}"
 .s menesi="{1103}{1085}{1074}{1072}{1088}{1100} {1092}{1077}{1074}{1088}{1072}{1083}{1100} {1084}{1072}{1088}{1090} {1072}{1087}{1088}{1077}{1083}{1100} {1084}{1072}{1081} {1080}{1102}{1085}{1100} {1080}{1102}{1083}{1100} {1072}{1074}{1075}{1091}{1089}{1090} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1100} {1086}{1082}{1090}{1103}{1073}{1088}{1100} {1085}{1086}{1103}{1073}{1088}{1100} {1076}{1077}{1082}{1072}{1073}{1088}{1100}"
 .s menesa="{1103}{1085}{1074}{1072}{1088}{1103} {1092}{1077}{1074}{1088}{1072}{1083}{1103} {1084}{1072}{1088}{1090}{1072} {1072}{1087}{1088}{1077}{1083}{1103} {1084}{1072}{1103} {1080}{1102}{1085}{1103} {1080}{1102}{1083}{1103} {1072}{1074}{1075}{1091}{1089}{1090}{1072} {1089}{1077}{1085}{1090}{1103}{1073}{1088}{1103} {1086}{1082}{1090}{1103}{1073}{1088}{1103} {1085}{1086}{1103}{1073}{1088}{1103} {1076}{1077}{1082}{1072}{1073}{1088}{1103}"
 .s MENESI="{1071}{1053}{1042}{1040}{1056}{1068} {1060}{1045}{1042}{1056}{1040}{1051}{1068} {1052}{1040}{1056}{1058} {1040}{1055}{1056}{1045}{1051}{1068} {1052}{1040}{1049} {1048}{1070}{1053}{1068} {1048}{1070}{1051}{1068} {1040}{1042}{1043}{1059}{1057}{1058} {1057}{1045}{1053}{1058}{1071}{1041}{1056}{1068} {1054}{1050}{1058}{1071}{1041}{1056}{1068} {1053}{1054}{1071}{1041}{1056}{1068} {1044}{1045}{1050}{1040}{1041}{1056}{1068}"
 d:"EN GB"[%LANG
 .s menesi="January February March April May June July August September October November December"
 .s menesa="January February March April May June July August September October November December"
 .s MENESI="January February March April May June July August September October November December"
 d:"DE"[%LANG
 .s menesi="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 .s menesa="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 .s MENESI="Januar Februar M{257}rz April Mai Juni Juli August September Oktober November Dezember"
 d:%LANG="UA"
 .s menesi="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 .s menesa="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 .s MENESI="{1057}i{1095}{1077}{1085}{1100} {1051}{1102}{1090}{1080}{1081} {1041}{1077}{1088}{1077}{1079}{1077}{1085}{1100} {1050}{1074}i{1090}{1077}{1085}{1100} {1058}{1088}{1072}{1074}{1077}{1085}{1100} {1063}{1077}{1088}{1074}{1077}{1085}{1100} {1051}{1080}{1087}{1077}{1085}{1100} {1057}{1077}{1088}{1087}{1077}{1085}{1100} {1042}{1077}{1088}{1077}{1089}{1077}{1085}{1100} {1046}{1086}{1074}{1090}{1077}{1085}{1100} {1051}{1080}{1089}{1090}{1086}{1087}{1072}{1076} {1043}{1088}{1091}{1076}{1077}{1085}{1100}"
 S %MONTH=$P(MENESI," ",%gm#100)
 s %XD81m=p1\10000_"."_$p(%MONTHS," ",$e(p1,5,6))_"."_$e(p1,7,8)
 s %XD82m=p2\10000_"."_$p(%MONTHS," ",$e(p2,5,6))_"."_$e(p2,7,8)
 s %2=$$d8plus(p2,1)
 s %XD82m1=%2\10000_"."_$p(%MONTHS," ",$e(%2,5,6))_"."_$e(%2,7,8)
 i p1#100=1,p2#100>31 s $p(%XD82m,".",3)="",$p(%XD81m,".",3)=""
 S %1=-3 F %=1910:1:%gm\100 S %1=(%#4=0)+%1+365
 S %MAXDAY=28+$E(3_(%gm\100#4=0)_3232332323,%gm#100)
 F %=1:1:%gm#100-1 S %1=28+$E(3_(%gm\100#4=0)_3232332323,%)+%1
 s %WEEKDAY(1)=%1+1#7
 s %1=%XD82#100+%1,%1=%1#7+1
 s %YEAR=$e(%XD82,1,4)
 s %DATUMS=%gm\100_".gada "_$p(MENESI," ",$e(%gm,5,6))
 i -%XD82'[-%gm!(-%XD81'[-%gm) d
 .s %1=$p(menesa," ",$e(%XD81,5,6)),%2=$p(menesa," ",$e(%XD82,5,6))
 .s %1=$e(%XD81,1,4)_".gada "_$e(%XD81,7,8)_"."_%1
 .s %2=$e(%XD82,1,4)_".gada "_$e(%XD82,7,8)_"."_%2
 .s %DatUMs=%1_"-"_%2 s:$e(%1,1,4)<$e(%2,1,4) %DatUMs=$$trw^UST(%DatUMs,".g.01.{1103}{1085}{1074}{1072}{1088}{1103}")
 .s:+%DatUMs?4n %DatUMs=$$trw^UST(%DatUMs,"-"_+%DatUMs_".gada "," - ")
 . ;; i $g(%LANG)["RU" s %DatUMs=$$trw^UST(%DatUMs,".gada "," {1075}. ")
 e  s %="" d
 .i %XD81#100-1!(%XD82#100-$$d31(%gm)) s %=$e(%XD81#100+100,2,3)_-$e(%XD82#100+100,2,3) s:%XD81=%XD82 %=$e(100+%,2,3)
 .s %DatUMs=$e(%XD82,1,4)_".gada "_$s(%:%_".",1:"")_%MONTH
 i %XD82-%XD81=1130 s %DatUMs=$e(%XD82,1,4)_".gads"
 s:%LANG="RU" %DatUMs=$$trw^UST(%DatUMs,".gada",".{1075}{1086}{1076}"),%DatUMs=$$trw^UST(%DatUMs,".gads",".{1075}{1086}{1076}")
 s:%LANG="UA" %DatUMs=$$trw^UST(%DatUMs,".gada",".{1088}{1086}{1082}{1091}"),%DatUMs=$$trw^UST(%DatUMs,".gads",".{1088}{1086}{1082}{1091}")
 s:"EN GB"[%LANG %DatUMs=$$trw^UST(%DatUMs,".gada",".year"),%DatUMs=$$trw^UST(%DatUMs,".gads",".year")
 s:"DE"[%LANG %DatUMs=$$trw^UST(%DatUMs,".gada",".Jahrs"),%DatUMs=$$trw^UST(%DatUMs,".gads",".Jahrs")
 s GADS=$p(%DATUMS,"  "),%B=$c(254),DATUMS=%DATUMS
 s (d8today,%d8today)=$$pD($h),d8arhiv=$e(%d8today,1,4)-2*10000,%oldDate=%d8today-20000
 s:%XD82<%d8today %oldDate=%XD82-20000
 q ""
NewDate(%1) 
 k oVVVo
 n %2,p1,p2,e
 s (%1,p1)=$g(%1) s:'p1 p1=$g(^ParVM(%USID,"UserDate"))
 s p2=$p(p1,"-",2),p1=$p(p1,"-") i 'p2,%1["-" s p2=$$pD(+$h) i %1'["." s:+p1?4n p2=$e(p2,1,4),p1=+p1_-p2
 i 'p1 s (p1,p2)=$$pD($h)
 s %1=+p1,%2=+p2 s:'%2 (p2,%2)=$p(p1,"-",2)
 s:%2=0 %2=$$pD($h) s:'%2 %2=+%1
 i %1?4n,%1>1990,%1<2099 s %1=%1_"0101"
 i %2?4n,%2>1990,%2<2099 s %2=%2_1231
 f %="%1","%2" d
 .s:@%<99 @%=$s(%[1:$$pD($h),1:%1)\100*100+@%
 .q:@%>20991231  q:13579[$l(@%)
 .i $e(@%,1,4)>1990,$e(@%,1,4)<2099 s @%=$e(@%_$s(%[1:"01",1:33),1,8)
 s %=%2#10000 i %#100=33,p2#100-33 d
 . s %=$e(3_($e(%2,3,4)#4=0)_3232332323,%\100)+28
 . s %2=%2\100*100+%
 s p1=+%1,p2=+%2 s:p1>p2 p1=p2,p2=+%1
 s e=""  f %="p1","p2" d
 .i $e(@%,1,4)>2099!($e(@%,1,4)<1990) s e=" ?Gads="_$e(@%,1,4)_"?"
 .i $e(@%,5,6)>12!($e(@%,5,6)<1) s e=" ?M{275}n.="_$e(@%,5,6)_"?"     
 .i $e(@%,7,8)>33!($e(@%,7,8)<1) s e=" ?Diena="_$e(@%,7,8)_"?"    
 .i @%>20990101!(@%<19900000) s e=" ? "_@%_" ?"
 .s:@%'?8n e=" ? "_@%_" ? ggggmmdd "
 i e="",$$icDate(p1,p2)
 q e
Week(d8,%2) 
 i +d8'?8n!(d8>20990000)!(d8<18400000) q "-- error --   d8="_d8
 n %,w f %=$e(+d8,1,4)_"0101":-1 q:'$$WeekDay(%) 
 f w=1:1 s %=$$d8plus(%,7) q:%>d8
 q w
 n %0x,% s %2=$g(%2),%0=0 f %=$e(d8,1,4)_"0101":1 s %0=%0+1 q:'$$WeekDay(%)  
 i %'<d8 q $$Week($e(d8,1,4)-1_1231)+(d8<20100199)  ;; is error in 2009 calendar of weeks LATVIA !!
 q:+$e(d8,5,6)=1 (d8#100)-%0-1\7+1
 s %0=31-%0+(d8#100)-1 F %=2:1:$e(d8,5,6)-1 S %0=28+$e(3_($e(d8,3,4)#4=0)_3232332323,%)+%0
 q %0\7+1
WeekDay(d8,%2) 
 i d8<($h+999),d8>($h-999) s d8=$$pD(+d8)
 i d8<999,d8=+d8 s d8=$$pD($h+d8)
 n %1,%,gggg,o s gggg=$e(d8,1,4),%LANG=$g(%LANG,"LV")
 S %1=-2 F %=1910:1:gggg-1 S %1=%#4=0+%1+365
 F %=1:1:$e(d8,5,6)-1 S %1=28+$e(3_(gggg#4=0)_3232332323,%)+%1
 s o=%1+$e(d8,7,8)#7,%="Sv{275}tdiena pirmdiena otrdiena tre{353}diena ceturtdiena piektdiena Sestdiena "
 s:$g(%LANG)["RU" %="{1042}{1086}{1089}{1082}{1088}{1077}{1089}{1077}{1085}{1100}{1077} {1087}{1086}{1085}{1077}{1076}{1077}{1083}{1100}{1085}{1080}{1082} {1074}{1090}{1086}{1088}{1085}{1080}{1082} {1089}{1088}{1077}{1076}{1072} {1095}{1077}{1090}{1074}{1077}{1088}{1075} {1087}{1103}{1090}{1085}{1080}{1094}{1072} {1057}{1091}{1073}{1073}{1086}{1090}{1072} "
 s:"EN GB"[%LANG %="Sunday Monday Tuesday Wednesday Thursday Friday Saturday "
 s:"DE"[%LANG %="Sonntag Montag Dienstag Mittwoch Donnerstag Freitag Samstag "
 s:"UA BY"[%LANG %="{1053}{1077}{1076}i{1083}{1103} {1087}{1086}{1085}{1077}{1076}i{1083}{1086}{1082} {1074}i{1074}{1090}{1086}{1088}{1086}{1082} {1089}{1077}{1088}{1077}{1076}{1072} {1095}{1077}{1090}{1074}{1077}{1088} {1087}'{1103}{1090}{1085}{1080}{1094}{1103} {1057}{1091}{1073}{1086}{1090}{1072} "
 s:$g(%2)[" " %=%2
 q o_$p(%_%," ",o+1)
tsts(%1,%2) 
 n m,%,h s h=":"
 s:$p(%1,h)["." $p(%1,h)=$$dmg($p(%1,h)) s:$p(%2,h)["." $p(%2,h)=$$dmg($p(%2,h)) 
 s:'%1 %1=$e(%2,1,6)_"01" s:'%2 %2=$e(%1,1,6)_$$d31($e(%1,1,6))
 s m=$p(%2,h,2)*60+$p(%2,h,3)-($p(%1,h,2)*60)-$p(%1,h,3)
 s %=+%1 f  q:%'<%2  s m=m+1440,%=$$d8plus(%,1)
 q m
t1t2(t1,t2) 
 n %1,%2,%3 s:$l(t1,":")=2 t1=":"_t1,t2=":"_t2,%3=2 s %1=+t1,%2=+t2 s:%2<%1 %2=%2+24
 s %1=%1*3600+($p(t1,":",2)*60)+$p(t1,":",3),%2=%2*3600+($p(t2,":",2)*60)+$p(t2,":",3)
 s %1=%2-%1,%1=$e(%1\3600+100,2,3)_":"_$e(%1-(%1\3600*3600)\60+100,2,3)_":"_$e(%1#60+100,2,3)
 q:$d(%3) $p(%1,":",2,3)  q %1

MXF
MXF ;  [ 04/26/2006  6:08 PM ]  ;[ 20090514 13:53:39 ]
 ; MSM, CACHE, GT.M,  MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 ; 
m(%) ; $$RunLine
 n %n i $d(%),% s %n=om n om s om=%n,$p(om,"/",2)=$e("         ",1,%-1)_$p($p(om,"/",2)," ",%) 
 s ossso3ss=$p(om,"/",3),occco4cc=$p(om,"/",4),%5sv=$p(om,"/",5),%oiiio2i=$p(om,"/",2)
 i $e(%5sv,1,2)="n " s o=$e(%5sv,3,999),%5sv="" f %=1:1:$l(o,",") s %n=$p(o,",",%),%3=@%n n @%n s @%n=%3
 x $p(om,"/",7,99) s %n=$p(om,"/",6) s:$e(%n)=";" %n="" i %n="xmsm",$l(xmsm) s %n="i "_xmsm
 i $e(%n,1,2)="i " x %n_" s %n=""""" q:$l(%n) -.1  ;; s %n=""
 i $l(%n),$d(@%n)>9 d  q:'$d(%n) -.1
 . s %omUSIDn="" f  s %omUSIDn=$o(@%n@(%omUSIDn)) q:'$l(%omUSIDn)  x "s %="_@%n@(%omUSIDn)  i '% k %n q   
 s:'$l(occco4cc) occco4cc="occco4cc" s %ztTQMm=$zt,$zt="ERRm^MXF" 
 ;; i $d(%maxLoom) s %maxLoom=%maxLoom-1 i %maxLoom<0 s %mxWarng("$$m^MXF:%maxLoom:limitOff")=om q
 f %oiiio2x=1:1:$l(%oiiio2i," ") s %i0=$p(%oiiio2i," ",%oiiio2x),(%ii,%iiB)=$tr(%i0,":-+",",") d:$l(%ii)
 . s %omUSIDn=$s($e(om,1,20)["^||om(":"^||om(""",1:"^om(""")_%USID_""","_%oiiio2x_","_%iiB_",""%ii"")"
 . s %omNewii=$o(@(%omUSIDn)) i '$l(%omNewii) s ^("%ii")=%ii d  q
 .. f %=1:1:$l(ossso3ss," ") s ^($p(ossso3ss," ",%))=@($p(ossso3ss," ",%))
 .. f %=1:1:$l(occco4cc," ") s ^($p(occco4cc," ",%))=@($p(occco4cc," ",%))
 .. i $l(%5sv) f %=1:1:$l(%5sv," ") s ^($p(%5sv," ",%))=@($p(%5sv," ",%))
 .. f %2=$l(%ii,","):-1:1 s $p(%omUSIDn,",",%2+2)=""""_$c(254)_"""" d:$p(%i0,":",%2)'["-"
 ...  s @(%omUSIDn)=%ii
 ...  f %=1:1:$l(ossso3ss," ") s %n=$p(ossso3ss," ",%) s:@%n ^(%n)=$g(^(%n))+@%n
 ...  i $l(%5sv) f %=1:1:$l(%5sv," ") s %n=$p(%5sv," ",%) s:$l(@%n) %o5=$g(^(%n)),^(%n)=$$sv^fin("%o5++"_%n)
 . i '%zvMSM f %=1:1:$l(occco4cc," ") s %n=$p(occco4cc," ",%),%8o=@%n i "  - .%"'[%8o s %8=^(%n) i %8'=%8o,%B_%8_%B'[(%B_%8o_%B),$l(%8)<20000 s ^(%n)=$s('$l(%8):%8o,1:%8_%B_%8o)
 . i %zvMSM s o=$zr f %=1:1:$l(occco4cc," ") s %n=$p(occco4cc," ",%),%8o=@%n i "  - .%"'[%8o s %8=^(%n) i %8'=%8o,%B_%8_%B'[(%B_%8o_%B) d
 .. i $l(%8)+$l(%8o)<510 s ^(%n)=$s('$l(%8):%8o,1:%8_%B_%8o) q
 .. i %8=".!." s %zvMSMo1=$g(%zvMSMo1,1000111)+1,^(%n,%zvMSMo1)=$e(%8o,1,510+%zvMSM) q:1_$d(@o)
 .. s ^(%n,1000000)=%8,^(1000001)=%8o s:1_$d(@o) ^(%n)=".!."
 . f %=1:1:$l(ossso3ss," ") s %n=$p(ossso3ss," ",%) s:@%n ^(%n)=$g(^(%n))+@%n
 . ;;   20191120    i $l(%5sv) f %=1:1:$l(%5sv," ") s %n=$p(%5sv," ",%) s:$l(@%n) %o5=$g(^(%n)),^(%n)=$$sv^fin("%o5++"_%n)
 . f %2=$l(%ii,","):-1:1 s $p(%omUSIDn,",",%2+2)=""""_$c(254)_"""" d:$p(%i0,":",%2)'["-"
 .. s @(%omUSIDn)=%ii
 .. f %=1:1:$l(ossso3ss," ") s %n=$p(ossso3ss," ",%) s:@%n ^(%n)=$g(^(%n))+@%n
 .. ;;  20191120  i $l(%5sv) f %=1:1:$l(%5sv," ") s %n=$p(%5sv," ",%) s:$l(@%n) %o5=$g(^(%n)),^(%n)=$$sv^fin("%o5++"_%n)
 s $zt=%ztTQMm q 1
ERRm n %n,% s $zt=%ztTQMm,%mxWarng("$$m^MXF:"_$ze_" row="_%YXy_" col="_%YXx)=$g(zi)_":::"_$g(%ii)_" :::"_$g(%oiiio2i)_":::"_$g(%oiiio2x)
 i $l($g(%ii)) f %=1:1:$l(%ii,",") s %n=$p(%ii,",",%) i '$l($g(@%n)) s %mxWarng("$$m^MXF:"_$s('$d(@%n):"<undef>index",1:"empty_index:")_" y="_%YXy_" x="_%YXx)=%n_" ::: "_$g(zi)_" ::: "_%ii
 q -1
B(z,x) n %zrXXoo,%x2 s %zrXXoo=$zr,%x2=$g(x),x=$g(x,%YXx) s:%x2["c" x=%YXx  ; onSelect - izlecosas pogas
 i x s:x<2!(x["+")&(%x2'["c") x=x+%YXx s:x>255 x=2
 i $e(z,1,3)="$$B" s ^omxMacro(%USID,%mxForma,%YXy,x)=z q:1_$d(@%zrXXoo) 1 
 i " "[$e(z),z'["xForma=" s ^omxMacro(%USID,%mxForma,%YXy,x)="$$B 9] 9 o[__ . 10/3:6 "_$e(z,2,480) q:1_$d(@%zrXXoo) 1
 i "1 * "[$e(z,1,2) s ^omxMacro(%USID,%mxForma,%YXy,x)="?$$B    xForma=1  "_$e(z,3,480) q:1_$d(@%zrXXoo) 1
 ; xForma=a 5 s ... 
 i $e(z)="^" s %=$p($e(z,2,99),"("),z="xForma="_$s($d(^AL(%)):"     s @(""x""_""Forma"")="""_$$kav2(z)_""" ",1:"xZRobj     s xZR="""_$$kav2(z)_"""")
 i $e($tr(z," "),1,7)="xForma=" s ^omxMacro(%USID,%mxForma,%YXy,x)="$$B 9-6"_$s(%x2["c":%x2,1:"")_" 9-2 o[__ xForma="_$p($p(z,"xForma=",2)," ")_" 10/3:6 "_$p($p(z,"xForma=",2,9)," ",3,999)  q:1_$d(@%zrXXoo) 1
 q:1_$d(@%zrXXoo) 0
R(z,x) n %zrXXoo s %zrXXoo=$zr,x=$g(x,%YXx)  ; on-Right-Click
 i x s:x<2!(x["+") x=x+%YXx s:x>255 x=2
 i $e(z)="^",$d(@z),'$d(^AL($e($p(z,"("),2,99))) q:1_$d(@%zrXXoo) z
 i $e(z)="^",'$d(@z) q:1_$d(@%zrXXoo) z
 i $e(z)="^" s ^omxGlobR(%USID,%mxForma,%YXy,x)=z q:1_$d(@%zrXXoo) 1
 k ^omxGlobR(%USID,%mxForma,%YXy,x)
 i "1 * "[$e(z,1,2) s ^omxRight(%USID,%mxForma,%YXy,x)="?$$B    xForma=*  n %N s %N="""_$g(%N,"o")_""" "_$e(z,3,480) q:1_$d(@%zrXXoo) 1
 ; xForma=a 5 s ... 
 i $e(z,1,7)="xForma=" d  s ^omxRight(%USID,%mxForma,%YXy,x)="?$$B       n %N s %N="""_%N_""" "_z q:1_$d(@%zrXXoo) 1
 . n % s %=$p(z," ",2,999) s:% %=$e(%,2,999) s:% %=$e(%,2,999) s z=$p(z," ")_"  "_%
 q:1_$d(@%zrXXoo) 0
T(oXecute,%YXxx,gotoYX)   ; on-Timer
 n %zrXXoo,%1,%2 s %zrXXoo=$zr,%YXxx=$g(%YXxx,%YXx)
 k ^onEvents("Timer",%USID,%mxForma,%YXy,%YXxx)
 s ^onEvents("Timer",%mxForma,%YXy,%YXxx)="n %N,%K,%y,%x s %y="_+%YXy_",%x="_%YXxx_",%K=$g(^oYX(%USID,%mxSheet,%YXy,%YXxx)),%N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo,%YXo "_oXecute_"  s:$d(oo) %YX(%y,%x)=oo"
 q:1_$d(@%zrXXoo) 1
S(oXecute,%YXxx,gotoYX)   ; on-Select
 n %zrXXoo,%1,%2,% s %zrXXoo=$zr,%YXxx=$g(%YXxx,%YXx)
 k ^onSelect(%USID,%mxForma,%YXy,%YXxx)
 s (%,^onSelect(%USID,%mxForma,%YXy,%YXxx))="n %N,%K s %K=$g(^oYX(%USID,%mxSheet,%ySelect,%xSelect)),%N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo,%YXo "_oXecute_"  s:$d(oo) %YX(%ySelect,%xSelect)=oo s %ySelect(0)=%ySelect,%xSelect(0)=%xSelect"
 k ^onEvents("cellSelect",%USID,%mxForma,%YXy,%YXxx) s @$zr=%
 ;;;s ^(%YXxx)="k gotoYXxx,gotoYXyy,oo i $$noTrack^MXF() k %YXo "_oXecute_"  s:$d(oo) %YX(%YXy,"_%YXxx_")=oo "  ;; ?????????? loop !!!
 q:1_$d(@%zrXXoo) 1
noTrack() n % q 1  q:'$d(%YXo) 1
C(oXecute,%YXxx) 
   ; on-Change
 n %zr,%1,%2,% s %zr=$zr,%YXxx=$g(%YXxx,%YXx)    ;; %qChange = last_changed_cell_new_value
 i %YXxx s:%YXxx<2!(%YXxx["+") %YXxx=%YXxx+%YXx s:%YXxx>255 %YXxx=2
 s (%,^onChange(%USID,%mxForma,%YXy,%YXxx))="n %N s %N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo "_oXecute_"  s:$d(oo) %YX(%yChange,%xChange)=oo k oo "
 k ^onEvents("cellChange",%USID,%mxForma,%YXy,%YXxx) s @$zr=%
 q:1_$d(@%zr) 1
D(%,x) ; on-DD-click
 n %zr s:$e(%,1,2)="^ " $e(%)="" s x=$g(x,%YXx) i x s:x<2!(x["+") x=x+%YXx
 s %zr=$zr,%=$$trw^UST($$trw^UST(%,";;; ",";||2 "),";|| ",";||2 ")
 s ^onSeleDD(%USID,%mxForma,%YXy,x)="n %N s %N="""_$g(%N,"o")_""" k gotoYXxx,gotoYXyy,oo "_%
 q:1_$d(@%zr) 1
L(%indeSEL,%textSEL,%mxForma) 
 ; on-left-click:  set dropDown and form-Call from list (with param.)
 n %,o,%n,%i s %i="" f %=1:1:$l(%indeSEL,",") s %n=$p(%indeSEL,",",%) i $g(@%n)="" k %textSEL q
 q:'$d(%textSEL) -1 s o="" f %=1:1:$l(%textSEL,",") s %n=$p(%indeSEL,",",%),o=o_%B_$g(@%n)
 x "s ^oYXiSeLi(%USID,%mxForma,%YXy,%YXx,"_%indeSEL_")=%mxForma_o"
 q %indeSEL_%B_%textSEL_%B_%mxForma
IR(%i,%di) 
 n %,%I,%R,%IR,%n,%1,o
 i '%i,$zv'["MiniM" s $zt="Ervb^USX"
 s %1=$e($p(%i,"("),2,99)
 i $g(%LII(%1))=""!($g(%LI(%1))="") d
 .  n %i,%di,%MV d ^USX s %LI(%1)=$g(^AL(%1,"%LI"))
 i '%di s %I=$NAME(@%i),%R=$g(@%I) d:$l(%R)=500  i 1
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 e  s %I=$$zo500^UST(%i,%di) s:%I="" %I=%i s %R=$g(@%I) d:$l(%R)=500
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 q:'$l(%R) -1  x %XG(%1),%XI(%1) s %IR=%I
 f %=1:1 s %n=$p(%LI(%1),",",%) q:'$l(%n)  d:%n["~"    s %IR=%IR_$c(9)_$s($l(@%n)<1023:@%n,1:$l(@%n)_">1023")
 . i %n'["~~" s %n=$tr(%n,"~") q
 . s %n=$tr(%n,"~") s:'$d(%XG0(%1,%)) %XG0(%1,%)=$p($g(^AL(%1,"%W",%n,0)),";",2,99)
 . s o=%XG0(%1,%) n %K,%1,% x o s:$d(%K) @%n=%K
 q %IR
sel(mode,from,t) 
 ; select 1 items from nodes or list
 q:t="" t
 n i,oo,o,omax,y,ymax,o1,o2,x,zr,q
 s omax=0,ymax="$$sel^USF(...) - not selected item "_t_" from "_from
 d:'$d(%LAT) %lat^fin s o1=%LAT,o2=%lat,t=$tr(t,o1,o2)
 i mode="maxtrue",$e(from)="^",from[",y," d  q:ymax>1 $p(ymax," ",2,99)
 .s x=+$p(from,",y,",2),zr=$p(from,",y,")_")",zr=$NAME(@zr)
 .s y="" f  s y=$o(@zr@(y)) q:y=""  s q=$g(^(y,x)) i q'="" d  q:o=2
 .. s oo=$e($tr(q,o1,o2),1,$l(t)+2),o=$l(t)-$l($tr(t,oo))
 .. f i=1:1:$l(t)+1 q:oo'[$e(t,1,i)
 .. s o=o+i-1/$l(t) i o>omax s omax=o,ymax=o_" "_y_" "_o_" "_q
 q -1
XQ(%oXecute) s $zt="Xerror^MXF" n Q x %oXecute q $g(Q)
X1(%oXecute) s $zt="Xerror^MXF" x %oXecute q 1
X(%oXecute) s $zt="Xerror^MXF" x %oXecute q 1
mks(%reportN,%kursSta) s:'$d(%kursSta) %kursSta=kursStar
 i $g(%reportN) s o=$$m(+%reportN) x %kursSta_" i 11_$$m(+%reportN) q" q .2
 s o=$$m x %kursSta_" i 11_$$m q" q .2
 q 0
Xerror s mxERROR=$g(%mxForma)_" ERROR ::: "_$tr(%oXecute,$c(0))_" ::: $ZTRAP="_$ZTRAP_" $$X^MXF: $ZERROR="_$ZERROR
 q mxERROR
pD(%H,t) 
 ;CONVERTS %H,$H to ggggmmdd
 q:'$d(%H) $$pD^MXD q:'$d(t) $$pD^MXD(%H) q $$pD^MXD(%H,t)
dmE(%d,%8) 
 q:'$d(%d) $$dmE^MXD q:'$d(%8) $$dmE^MXD(%d) q $$dmE^MXD(%d,%8)
dmg(d8,p2) 
 q:'$d(p2) $$dmg^MXD(d8)  q $$dmg^MXD(d8,p2) 
d8t(d8,mm) 
 q:'$d(mm) $$d8t^MXD(d8)  q $$d8t^MXD(d8,mm)
d8(d,d31,dBas) 
 s d=$g(d)
 i d="",$g(%YXy),$g(%YXx) q:+$g(oYX(%YXy-1,%YXx-1))?8n +oYX(%YXy-1,%YXx-1)  q:+$g(oYX(%YXy-1,%YXx))?8n +oYX(%YXy-1,%YXx)
 i $l(d)>4!'d,+d'?8n q $$pD($h)
 i +d?8n!'$d(dBas) q:$$d31(+d,$g(d31))'="" $$d31(+d,$g(d31)) q +d
 s:+dBas'?8n dBas=$$pD($h+dBas) s:d<10 d=0_+d s:$l(d)=3&(d=+d) d=0_d s:$l(d)<5 d=$e(+dBas,1,8-$l(d))_d q:$$d31(d,8)'="" $$d31(d,8)
 q d
d31(d,N) 
 q:'$g(N) 28+$e(3_($e(d,1,4)#4=0)_3232332323,$e(d,5,6))  q $$d31^MXD(d,N)
d8plus(d8,p) 
 q:'p d8  q $$d8plus^MXD(d8,p)
daStatus(%d,%0) 
 s %0=$g(%0,$$d8) s:$p(%d,".",2) %d=$$dmg(%d) q:%d'?8n ""  s:$p(%0,".",2) %0=$$dmg(%0)
 q:%d<%0 "EX<mx ic7"  q:%d<(%0+100) "W<mx ic44"
 q "ok<mx ic2 fc10"
Week(d8,%2) 
 q 0
p(oo,o,o2) 
 s o2=$g(o2," ") q $p($p(oo,o_"=",2),o2)
m2u(oo) ; msm8code  --> &#unicode;
 n o,uu,o1,x s uu="" d:'$d(%msm8uni) %msm8uni
 f o=1:1:$l(oo) s o1=$e(oo,o),x=$f(%msm8uni,o1) s:x o1="&#"_$e(%msm8uni,x,x+3)_";" s:o1=" " o1="&nbsp;" s uu=uu_o1
 q uu
u2m(oo) ; &#unicode; --> msm8code
 n o,uu,o1,x,% s uu="" d:'$d(%msm8uni) %msm8uni  s:oo["&nbsp;" oo=$$trw^UST(oo,"&nbsp;"," ")
 f %=2:1:$l(oo,"&#") s %=$p(oo,"&#",%) s:%'[";" uu=uu_"&#"_% i %[";" s x=$f(%msm8uni,$e(10000+$p(%,";"),2,9)) s:'x uu=uu_"&#"_x s:x uu=uu_$e(%msm8uni,x-5)_$p(%,";",2,999)
 q uu
quot(o) 
 i o["&" s o=$$trw^UST(o,"&","&amp;")  ; &#38;
 i o[">" s o=$$trw^UST(o,">","&gt;")   ; &#62;
 i o["'" s o=$$trw^UST(o,"'","&apos;") ; 
 i o["""" s o=$$trw^UST(o,"""","&quot;")  ; &#34;
 ;; i o[$c(8364) s o=$$trw^UST(o,$c(8364),"&euro;")    ; &euro; = &#8364;   {1040}
 q o
%msm8uni n %,%1,o k %msm8uni  s %msm8uni="",%msm8uni(1)="",%msm8uni(2)=""
 s %=".2548226.1810256.1980257.2110268.2100269.2400274.2410275.2420290.2140291.2150298.2160299.2440310.2430311.2460315.2450316.2520325.1830326.2080352.2530353.2220362.2210363.2480381.2470382.1281040."
 s %=%_"1291041.1301042.1311043.1321044.1331045.1341046.1351047.1361048.1371049.1381050.1391051.1401052.1411053.1421054.1431055.1441056.1451057.1461058.1471059.1481060.1491061.1501062.1511063.1521064.1531065.1541066.1551067.1561068."
 s %=%_"1571069.1581070.1591071.1601072.1611073.1621074.1631075.1641076.1651077.1661078.1671079.1681080.1691081.1701082.1711083.1721084.1731085.1741086.1751087.2241088.2251089.2261090.2271091.2281092.2291093.2301094.2311095.2321096."
 s %=%_"2331097.2341098.2351099.2361100.2371101.2381102.2391103.1841105.1898470.1888721."
 i $zv'["U) " f %1=2:1 s o=$p(%,".",%1) q:'$l(o)  s ^unicode(+$e(o,4,7))=$c(+$e(o,1,3)),%msm8uni=%msm8uni_$c(+$e(o,1,3))_$e(o,4,7)
 i $zv["U) " f %1=2:1 s o=$p(%,".",%1) q:'$l(o)  s ^unicode(+$e(o,4,7))=$c(+$e(o,4,7)),%msm8uni=%msm8uni_$c(+$e(o,4,7))_$e(o,4,7)
 f %1=2:1 s o=$p(%,".",%1) q:'$l(o)  s:$e(o,1,3)<254 %msm8uni(1)=%msm8uni(1)_$c(+$e(o,1,3)),%msm8uni(2)=%msm8uni(2)_$c(+$e(o,4,7))
 s %unicode=%
 q
kav2(t) i $zv["Ca"!($zv["IRIS") q $replace(t,"""","""""")
 q $$trw^UST(t,"""","""""")
U(t) ; to UNICODE { >253 }
 q:$d(%dba8bit) t  i $d(%mxWeb),$zv'["U) " q $$U8(t)
 n U,%,fu i $zv'["U) ",'$d(%mxWeb) s %dba8bit=8 q $$U8(t)
 f %=1:1:$l(t) i $a($e(t,%))>254 s fu=% q  
 q:'$d(fu) t  s U=$e(t,1,fu-1)
 f %=fu:1:$l(t) s U=U_$s($a($e(t,%))<254:$e(t,%),$a($e(t,%))>255:"{"_$a($e(t,%))_"}",$a($e(t,%))=254:"{"_8226_"}",1:$e(t,%))  
 q U
Uu(t) q:t'["{" t  q:$zv'["U) " $$u8(t) n %,s,s8,%1 ; from { unicode } to unicode  $c(U) 16-bit
 f %=1:1:$l(t) i $e(t,%)="{" f %1=4,5,6 s s=$e(t,%+%1) i s="}" s s=$e(t,%+1,%+%1-1) s:s=8226 s=254 i s\1=s,s<66200,s>253 s $e(t,%,%+%1)=$c(s) q
 q t
U8(t) ; msm 8 bit to {UNICODE>253}
 i $zv["U) " q:'$d(%mxWeb) t  k %dba8bit q $$U(t)  
 q:$tr(t," 0123456789.-+:~=[]{}()qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM")="" t
 n U,%,fu,%1  d:'$d(%msm8uni) %msm8uni
 f %=1:1:$l(t) i " 0123456789.-+:~=[]{}()qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"'[$e(t,%),%msm8uni[$e(t,%) s fu=% q
 q:'$d(fu) t  s U=$e(t,1,fu-1),%1=0
 f %=fu:1:$l(t) s %1=1 s:" 0123456789.-+:~=[]{}()qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"[$e(t,%) U=U_$e(t,%),%1=0 s:%1 %1=$f(%msm8uni,$e(t,%)),U=U_$s(%1:"{"_+$e(%msm8uni,%1,%1+3)_"}",1:$e(t,%))
 q U
u8(t) q:t'["{" t  q:$zv["U) " $$Uu(t)  n %,s,s8,%1 d:'$d(%msm8uni) %msm8uni ; {unicode} --> msm8code
 f %=1:1:$l(t) i $e(t,%)="{" f %1=4,5 s s=$e(t,%+%1) i s="}" s s=$e(t,%+1,%+%1-1) i s\1=s,s<66200,s>255 s s8=$f(%msm8uni,$e(10000+s,2,9)) i s8 s $e(t,%,%+%1)=$e(%msm8uni,s8-5) q
 q t
SaveXML(%j,%USID,file,b,codePage) 
 ; Save ^oXMLf(y,x) to file
 s %code3=$c(231)_$c(199)_$c(251)_$c(219)_$c(238)_$c(206)_$c(226)_$c(194)_$c(240)_$c(208)_$c(236)_$c(204)_$c(237)_$c(205)_$c(239)_$c(207)_$c(254)_$c(222)_$c(232)_$c(200)_$c(242)_$c(210)
 n q,qq,y,x,%10 s %10=$c(10),%code3="eEuUiIaAsSgGkKlLzZcCnN"
 s (qq,y,x)="",codePage=$g(codePage)
 i $zv["MS" o 51:(file:"W"):0 u 51
 i $zv'["MS" OPEN file:"NWS":1 u file
 f  s y=$o(^oXMLf(y)) q:'y  s x=1 f  s x=$o(^oXMLf(y,x)) q:'x  s q=^(x) i "?="'[$e(q),"   -       . "'[q d
 .  i codePage=1257 s q=$tr(q,$$Uu("{275}{274}{363}{362}{299}{298}{257}{256}{353}{352}{291}{290}{311}{310}{316}{315}{382}{381}{269}{268}{326}{325}"),%code3)
 .  i $g(b)'="" s:$e(q,$l(q))'="=" q=q_b
 .  s qq=qq_q i '$o(^(x)) d:qq[%10  w qq,%10 s qq=""
 ..  s o=qq_%10_"!! {1074} {1090}{1077}{1082}{1089} {1077}{1089}{1090}{1100} {1085}{1077}{1085}{1091} : "_%10_$p(qq,%10)_"*"_%10_" - {1101}{1090}{1086}{1090} {1083}{1080}{1096} <Alt/Enter> {1091}{1076}{1072}{1083}{1077} SaveXML^MXF !!"
 ..  s ^omxWarng(%USID,file_" row="_$e(y+100000,2,9)_",column="_x)=o_%10_%10,qq=$tr(qq,%10)
 i $zv["MS" x "close 51 h 1" q:%j
 i $zv'["MS" x "close file h 1" q:%j
 q file
%latRU n %1,%2
 s %2="{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}"
 s %1="{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}"
 S %LAT=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}{1105} ""/-.'`&")
 s %lat=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn{1077} ")
 s oLat1=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}{1105}")
 s oLat2=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn{1077}")
 q 
%lat n %1,%2 s (%1,%2)=""
 s %rus=$$Uu("{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}")
 s %RUS=$$Uu("{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}")
 i $g(%LANG)["RU" d %latRU q
 S %LAT=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257} ""/-.'`&")
 s %lat=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuia{353}{291}{311}{316}{382}{269}{326}euia ")
 s oLat1=$$Uu(%1_"QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}")
 s oLat2=$$Uu(%2_"qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn")
 q 
AddrR1C1(a) 
 n R,C s oCellAdr=a,a=$tr(a,"$")
 s a=$tr(a,"qwertyuiopasdfghjklzxcvbnm","QWERTYUIOPASDFGHJKLZXCVBNM")
 s R=+$tr(a,"1234567890"_a,"1234567890")
 s:$l(a,2) C=$a(a)-64 s:'$l(a,2) C=$a(a)-64*26+$a($e(a,2))-64
 s oCellRow=+R,oCellCol=+C
 q "R"_+R_"C"_+C
AB(x) 
 s x=x\1 q:x>255!'x "oo"_x  q:x<27 $e("ABCDEFGHIJKLMNOPQRSTUVWXYZ",x)
 q $e("ABCDEFGHIJKLMNOPQRSTUVWXYZ",x-1\26)_$e("ABCDEFGHIJKLMNOPQRSTUVWXYZ",x-1#26+1)
EAN13(o) 
 ; MX : printing barcode with font EAN-13
 n S,oAB,x,b1,EAN13,o7
 s o=$tr(o,1234567890_o,1234567890),b1=$e(o),o=$e(o_"0000000000",1,12)
 s S=$e(o,12)+$e(o,10)+$e(o,8)+$e(o,6)+$e(o,4)+$e(o,2)*3
 s S=S+$e(o,11)+$e(o,9)+$e(o,7)+$e(o,5)+$e(o,3)+$e(o,1)#10*-1+10#10
 s oAB=$p("oooooo.oo1o11.oo11o1.oo111o.o1oo11.o11oo1.o111oo.o1o1o1.o1o11o.o11o1o.",".",$e(o)+1)
 s o=$e(o,2,12)_S
 s o7=$tr($e(o,7,12),"0123456789","PQRSTUVWXY")
 f x=1:1:6 s:$e(oAB,x) $e(o,x)=$tr($e(o,x),"0123456789","@ABCDEFGHI")
 s EAN13=$e("!""#$%&'()*",b1+1)_"|"_$e(o,1,6)_"|"_o7_"|"
 q:$e(EAN13)="'" "'"_EAN13 q EAN13
code35(t) 
 s:'$d(%code35) %code35=$c(231)_$c(199)_$c(251)_$c(219)_$c(238)_$c(206)_$c(226)_$c(194)_$c(240)_$c(208)_$c(236)_$c(204)_$c(237)_$c(205)_$c(239)_$c(207)_$c(254)_$c(222)_$c(232)_$c(200)_$c(242)_$c(210)_$c(6)_$c(20)
 q $tr(t,%code35,$$Uu("{275}{274}{363}{362}{299}{298}{257}{256}{353}{352}{291}{290}{311}{310}{316}{315}{382}{381}{269}{268}{326}{325}"_$c(254)_$c(254)))
code1257(t) 
 s:'$d(code1257) code1257=$c(231)_$c(199)_$c(251)_$c(219)_$c(238)_$c(206)_$c(226)_$c(194)_$c(240)_$c(208)_$c(236)_$c(204)_$c(237)_$c(205)_$c(239)_$c(207)_$c(254)_$c(222)_$c(232)_$c(200)_$c(242)_$c(210)
 q $tr(t,$$Uu("{275}{274}{363}{362}{299}{298}{257}{256}{353}{352}{291}{290}{311}{310}{316}{315}{382}{381}{269}{268}{326}{325}"),code1257)
nodeComp(n1,n2,leno) 
 q:'$d(@n1) "-"_n1  q:'$d(@n2) "-"_n2  
 n %1,%2,%,o,%1o,%2o s n1=$name(@n1),n2=$name(@n2),%1=$ql(n1),%2=$ql(n2)
 s o="",leno=$g(leno,15000),%1o=$e(n1,1,$l(n1)-1),%2o=$e(n2,1,$l(n2)-1)
 f  s n1=$q(@n1) q:n1=""  q:$ql(n1)<%1  q:$name(n1,%1)'=n1  s %=%2o_$p(n1,%1o,2,9) i $g(@n1)'=$g(@%) s o=o_$qs(n1,$ql(n1))_"="_$g(@n1)_"  "_$c(254) q:leno=1  i $l(o)>leno s o=o_" ... "_n1_" ... " q
 q:leno=1&$l(o) o
 f  s n2=$q(@n2) q:'$l(n2)  q:$ql(n2)<%2  q:$name(n2,%2)'=n2  s %=%1o_$p(n2,%2o,2,9) i '$d(@%),$l(@n2) s o=o_$c(254)_$qs(n2,$ql(n2))_$c(254) i $l(o)>leno q:leno=1  s o=o_" ... "_n2 q
 q o
globComp(globNode,UCI2) 
 n n,i0,i2,zr,ii,zr0
 k ^ogloComp(%USID) k ^ogloCom(%USID) m ^ogloComp(%USID,0)=@globNode
 x "m ^ogloComp(%USID,2)=^|UCI2|"_$e(globNode,2,999)
 m ^ogloCom(%USID)=^ogloComp(%USID,0) m ^ogloCom(%USID)=^ogloComp(%USID,2)
 k globComp s zr=$NAME(^ogloCom(%USID)),n=0,zr0=$e(zr,1,$l(zr)-1)
 f i=1:1 s zr=$q(@zr) q:zr'[zr0  s ii=$p(zr,",",2,99) d
 .i globNode["^AL",zr["ColumnWidth"!(zr[",""t_") q
 .s:ii="" ii="1)"
 .s i0="^ogloComp(%USID,0,"_ii,i2="^ogloComp(%USID,2,"_ii
 .i $g(@i0)'=$g(@i2) s n=n+1,globComp(i)=ii
 q n
 ;
SUM(rr) q 0
sume(ss,se,o) 
 s:$g(o)="" o="^" i se[$c(10),se'[o s o=$c(10)
 q:se'[o ss+se  n e
 f e=1:1:$l(se,o) s ss=ss+$p(se,o,e)
 q ss
re(%R,%B,o,ee) 
 n e,%,max,g,gg k re s gg="",max=1,o=$g(o,"^"),%B=$g(%B,$c(254)) 
 i o s gg=o,o="^"
 i %R'[o,$g(ee)'["*" s re(1)=%R q %R
 f %=1:1:$l(%R,%B) s g=$p(%R,%B,%) s:$l(g,o)>max max=$l(g,o)
 s:$g(ee)<1 ee=max
 f %=1:1:$l(%R,%B) s g=$p(%R,%B,%) f e=1:1:max s ge=$p(g,o,e) d
 .  i ge="",gg'[% s ge=$p(g,o,e-1),$p(g,o,e)=ge
 .  s $p(re(e),%B,%)=ge,re(e,%)=ge
 q $g(re(+ee\1))
reSplit(%I,%e) 
 k %re n %R,%FILE,o,%,%n,%max,%eee 
 s %max=1,%eee=9999,%e=$g(%e) s:%e %eee=+%e,%e=$p(%e,+%e,2) s:'$l($g(%e)) %e="^" 
 s %FILE=$e($p(%I,"("),2,99) i '$d(%LI(%FILE)) s %1=%FILE d ^USX
 s %R=$g(@%I) s:$l(%R)=500 %R=%R_$g(@%I@(501)) s:$l(%R)=1000 %R=%R_$g(@%I@(1001))
 f %=1:1 s %n=$tr($p(%LI(%FILE),",",%),"~") q:'$l(%n)  d 
 .f %ee=1:1 s o=$p(@%n,%e,%ee) s:%ee=1!$l(o) %re(%n,%ee)=o s:%ee>%max %max=%ee q:$p(@%n,%e,%ee+1,999)=""
 .s o=$o(%re(%n,%eee+.1),-1) s:o @%n=%re(%n,o)
 q %max
zrJoin(%zr,%n) 
 q:'$d(@%zr) ""  s:'$d(%n) %n=999999 q:'%n $g(@%zr@(%n))
 n %R s %R=$g(@%zr) s:%R=".!." %R="" i $d(@%zr@(%n))
 f  s %n=$o(^(%n)) q:'$l(%n)  i %n,$d(^(%n))#2 s %R=%R_$s($l(%R):%B,1:"")_^(%n)  
 q %R
reJoin(%) 
 q %R
checkSyn(code)  ;; cache  iris  only
 s code(0)=1,code(1)=" "_code n o,e,l
 i $zv["Ca"!($zv["IRIS") d  q $s($l(o)<4!(o["<NOLINE>"):"",1:$g(%mxForma)_" syntax_error: "_o)
 . s o=$$CHECK^%R(.code,.e,0),o=$$FMTERR^%R(.e,.code,.l),o=$p($g(l(1)),":",3,33)
 . i o["Command not valid within" s o="" 
 q ""
checkVrs(%code) 
 n %1,%2,%,%3,%oo s %oo=""
 s %1="QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890%"
 s %2="",$p(%2," ",$l(%code))=" "
 s %code=$tr(%code,%1_%code,%1_%2)
 f %=1:1:$l(%code," ") s %3=$p(%code," ",%) d
 . i $l(%3),$l(%3)<9,'%3,$e(%3,2,9)'["%" s %oo(%3)=$g(%3)
 s %3="" f  s %3=$o(%oo(%3)) q:%3=""  s %oo=%oo_%3_"="_%oo(%3)_"  "
 q %oo
mxLock(%ZR,lockTime,%E) 
 i '$g(lockTime) k ^omxLock(%ZR) q ""
 n o,Lock s Lock=$h_%B_lockTime_%B_%USID_%B_$g(%E)
 s o=$g(^omxLock(%ZR)) i $p(o,%B,3)=%USID!'o s ^(%ZR)=Lock q ""
 i $p($h,",",2)-$p(o,",",2)>$p(o,%B,2) s ^(%ZR)=Lock q ""
 i $h-o s ^(%ZR)=Lock q ""
 q o
EnterAL(oo) 
 ;?$$EnterAL ^FILE(i1,i2,i3)=f1,f2,f3,f4 name m-command-start
 q:oo[";;" ""
 n o,%FILE
 s %FILE=$p($p(oo,"("),"^",2),o=$p(oo," ",3) s:o="" o=%FILE s ^AL(%FILE,"NAME")=o
 s ^("START")=$p(oo," ",4,999)
 s o=$p(oo," ",2),o=$p(o,"(",2,99),^("%LI")=$$trw^UST(o,")=",",")
 s ^("%LG")="%SF,"_$p(o,")=",2,999)
 s o=$p(o,")="),^("%LII")=o,o=$p(o,",",$l(o,",")),^AL(%FILE,"%W",o,1)=" d F "
 q ""
ZR(%ZR,%na,%set) 
 i $e(%ZR)'="^" q "er:???:%ZR="_%ZR_":%na="_%na  ; error %ZR
 i $g(%na)="" q "er:$l(%na)=0:%ZRdelete:%ZR="_%ZR_":%na="_%na
 i '$d(%set) n %1,%,%2 d  q %2  ; read property
 .i $d(^ZR(%ZR,%na)) s %2=$g(^(%na)) q
 .s %1=$e($p(%ZR,"("),2,99)
 .i '$d(^AL(%1,"%LG")) s %2="er:?%LG?:%ZR="_%ZR_":%na="_%na q
 .s %1=^("%LG")
 .f %=1:1:$l(%1,",") i $tr($p(%1,",",%),"~")=%na s %2=$p($g(@%ZR),%B,%) q
 .i '$d(%2) s (%na,%2)="er:???%LG???:%ZR="_%ZR_":%na="_%na
 q:'%set "ok:get:%ZR="_%ZR_":%na="_%na
 i $d(@%na)#2=0 s @%na=0 q "er:%na<UNDEF>:%ZR="_%ZR_":%na="_%na
 i $g(^ZR(%ZR,%na))'=@%na s ^ZR(%ZR,%na)=@%na i $l(@%na) s ^ZR(%na,$e(@%na,1,55))=%ZR
 q "ok:set:%ZR="_%ZR_":%na="_%na
ZRnaList(%na,%K) 
 n %ZR,o,% s o="" d %lat 
 s %K=$tr($p(%K,";;"),oLat1_" ""/-.'`&",oLat2)
 f  s o=$o(^ZR(%na,o)) q:o=""  s %ZR=^(o)  d
 . q:$tr(o,oLat1_" ""/-.'`&",oLat2)'[%K
 . i '$d(@%ZR) k ^ZR(%ZR) q
 . i $d(^ZR(%ZR,%na)) s %(o)=^ZR(%ZR,%na) q
 . s %="^" f  s %=$o(^ZR(%)) q:%'["^"  i '$d(@%) k ^ZR(%)
 . s %="^" f  s %=$o(^ZR(%)) q:%'["^"  i $d(^ZR(%,%na)) d  q
 . . s ^ZR(%na,$e(^ZR(%,%na),1,55))=%
 . . s %(o)=^ZR(%,%na)
 q:$d(%)<2 %na_"?"_%K
 s o="",%=1 k ^ose(%USID)
 f  s o=$o(%(o)) q:o=""  s ^(%)=$g(^ose(%USID,%))_%(o)_$c(4) s:$l(^(%))>12000 %=%+1
 q:%=1 ^(1)  q ""
wR(%F,%I,%LIST,%1,%2,%3,%4,%5,%6,%7,%8,%9,%10,%11,%12,%13,%14,%15) 
 n %n,%,%0,%FILE,%R f %=1:1:$l(%LIST,",") s %n=$p(%LIST,",",%),%0="%"_%,@%n=@%0
 s %FILE=$$%XG^USX(%I),%R="" x %CON(%FILE)
 s:%F>0 @%I=%R
 i $$%mM^US(%F,%I)
 q 1
orFiltr(oo,o1,o2) 
 s:$e(o1)="-" o1=$e(o1,2,99) i $d(o2) s:$e(o2)="-" o2=$e(o2,2,99) 
 i oo["=" n o s o="="_$tr(oo,"+- ","==")_"=" q:o[("="_o1_"=") 1  q:'$d(o2) 0 q:o[("="_o2_"=") 1 q 0
 i $e(oo)["-" s o=oo n oo s oo=$tr(o,"-","+")
 n o,f,x s f=0 q:'$l(oo) 1
 f x=1:1:$l(oo,"+") s o=$p(oo,"+",x) i $l(o),"-"_o1[("-"_o) s f=1 q
 q:f 1 i $d(o2) f x=1:1:$l(oo,"+") s o=$p(oo,"+",x) i $l(o),"-"_o2[("-"_o) s f=1 q
 q f
save1rou(R) 
 n x,f,% s f="c:\m\"_R_".1",x="f %=1:1:9999 s t=$t(+%) w:$l(t) !,t"
 i $zv'["MS" x "zl "_R_"   o f:""WNS"":1 u f w $zv,$h,!,$zu(5),!,R x x  c f" q
 x "zl "_R_"   o 51:(f:""W""):0 u 51 w $zv,$h,!,$zu(0),!,R x x  c 51 "
 q
rest1rou(R) 
 s f="c:\m\"_R_".1"
 i $zv'["MS" x "o f:""RS"":1 u f ZLOAD  c f  ZSAVE "_R q
 x "o 51:(f:""R""):1 u 51 ZLOAD  c 51 ZSAVE "_R
 q
AL1(%ZR,%na) 
 q $$q(%ZR,%na)
q(%ZR,%na) 
 i $e(%ZR)'="^" q "er:???:%ZR="_%ZR_":%na="_%na  ; error %ZR
 i $g(%na)="" q "er:$l(%na)=0:%ZR="_%ZR_":%na="_%na
 n %1,%,%2 s %1=$e($p(%ZR,"("),2,99)
 i '$d(%LG(%1)) d ^USX i $g(%LG(%1))'["," q "er:?%LG?:%ZR="_%ZR_":%na="_%na
 s %1=%LG(%1)
 f %=1:1:$l(%1,",") i $tr($p(%1,",",%),"~")=%na s %2=$p($g(@%ZR)_$g(@%ZR@(501)),%B,%) q
 q:$d(%2) %2 
 s err="er:???%LG???:%ZR="_%ZR_":%na="_%na_"  %LG="_%1
 q ""
iiiLine s (iii,%mxIndex)=$o(^oMX(%USID,%V,iii)) q:'iii  s o=99
 f  s o=$o(^oMX(%USID,%V,iii,o)) q:'$l(o)  s @o=^(o) s:@o="*" @o=@o_"<mx ic15.99"
 q
%YX(%yxq,%YXyy,%YXxx) 
 n %q,%x,%y,%,%1,%2,%yy,%xx,%e,oo,%n s %y=$g(%YXy,1),%x=$g(%YXx,1),%e=""
 i $e(%yxq)="?" s %n=$p(%yxq," "),%yy=0 d  q 1_%yxq
 . i %n'["_" s %n=$e(%n,2,99),%=$p($g(^oRC(%USID,%mxForma,"?var",%n)),";",2,999) x % s:$d(@%n) %YX(%n)=$g(@%n) s:$d(oo) %YX(%n)=$g(oo) k oo q
 . f  s %yy=$o(^oRC(%USID,%mxForma,%yy)) q:'%yy  s %xx=1 f  s %xx=$o(^oRC(%USID,%mxForma,%yy,%xx)) q:'%xx  i $e(^(%xx),1,$l(%n))=%n s %=$p(^(%xx),";",2,999) x % s %=$tr(%n,"?_") s:'$d(oo)&$d(@%) oo=$g(@%) d  k oo  
 .. i $d(oo) s %YX($s($g(%YXyy):%YXyy,%n["_":%YXy,1:%yy),$s($g(%YXxx):%YXxx,1:%xx))=oo
 f %=1:1:$l(%yxq," ") s %1=$p(%yxq," ",%),%q=$p(%1,"=",2,999) s:%q="" %q="%e" d:$l(%1)
 . i %1'["=" s %q=$$trw^UST(%1,"[]"," ") s:$e(%q,1,3)="<mx" %q="<mx "_$e(%q,4,999),%q=$g(%YXq)_%q s %YX(%y,%x)=%q q
 . s %2=$p($p(%1,",",2),"="),%1=$p(%1,",") s:%1 %y=%1,%1="" s:%2 %x=%2,%2=""
 . x:$l(%1) "s %y="_%1 x:$l(%2) "s %x="_%2
 . x "s %YX(+%y,+%x)="_%q q:%y_%x'[":"
 . f %yy=+%y:1:+$p(%y,":",2) f %xx=+%x:1:+$p(%x,":",2) x "s %YX(%yy,%xx)="_%q
 q 1
CalcF11(%t) 
 n %x,%,%1,%d,%b,o s %x="",%d="|",%b="    ---------------------------"
 q:%t["::" ""  q:%t=""&0000 "EXIT" q:$e(%t,1,4)="EXIT" %t_%b q:%t'[%d %t_%d
 q:"zw"[%t %t  i $e(%t,1,3)[" ","wWzZsS"[$e(%t) q %t
 q:%t[(%b_%d_%b_%d_%b_%d) "EXIT" ;; q:%t[(%b_%d_%b_%d_%b_%d) ""
 f %=1:1:$l(%t,%d) s %1=$p($p(%t,%d,%),"  "),$p(%t,%d,%)=%1 d
 . i %1["---" s %t="" q
 . i "QWERTYUIOPASDFGHJKLZXCVBNM%$qwertyuiopasdfghjklzxcvbnm"[$e(%1_1),%1'[" ",%1'="zw",%1'="w" x "s o="_%1 s $p(%t,%d,%)=o_"    "_%1,%1=o
 . i "+...+0..+//+::+**+======"[%1 s %1="" s:%>1 $p(%t,%d,%)=%b q
 . i $l($p(%1,"="))>0,$l($p(%1,"=",2,99))>0,'%1 x "s "_%1 q
 . i %>1!(%1'=+%1) s:"1234567890."[$e(%1) %1="+"_%1
 . s %x=%x_%1 q:%=1&($e(%1)'="+")  q:$l($p($p(%t,%d,%+1),"  "))
 . s %1=$p($p(%t,%d,%),"  ")_"   ",%1=%1_$e("                                ",$l(%1),15)
 . x "s %x="_%x s $p(%t,%d,%)=%1_"= "_%x_"  =",%x=""  
 q:$l(%t) %t_%d q ""
mJournal(%t,%y,%x,%q,%n) 
 q:'%t "" q:'$d(^mJournal(%t,0)) "" q:$zv["MS" "" s %mxSheet=$p(^(0),%B,2) 
 n %,o,%Yrc s:$l($g(%n)) %=$tr($g(@%n),%B) i $$%0Yrc^MXTQM2(%y)
 s:'$d(%) %=$tr($g(^oYX(%USID,%mxSheet,%y,%x)),%B),%n=$e($p($g(^oRC(%USID,%mxForma,%Yrc,%x))," "),2,99)
 s o=$o(^mJournal(%t,999999),-1)+1,^(o)=%y_%B_%x_%B_$g(%n)_%B_%_%B_%q
 q %
getJourn(%1,%2) 
 q $$getJourn^MXTQM(%1,%2)
ooo2(o) n ooo,% s ooo="" f  s o=$q(@o) q:'$l(o)  d  s ooo=ooo_$c(4)_@o_$c(5)
 . f %=1:1:$ql(o) s ooo=ooo_$s($qs(o,%)["<:>":$p($qs(o,%),"<:>",2),1:$qs(o,%))_$c(4)
 q ooo
oooYX() n ooo,y,x,%,%Yrc s ooo="",%="%"
 f  s %=$o(%YX(%)) q:'$l(%)  s x=$g(^oRC(%USID,%mxForma,"?var",%)) s:x %YX(+x,+$p(x,"-",2))=%YX(%) k %YX(%)
 s y=0 f  s y=$o(%YX(y)) q:'y  s %="%" f  s %=$o(%YX(y,%)) q:'%  d:$$%0Yrc^MXTQM2(y)  k %YX(y,%)
 . s x=0 f  s x=$o(^oRC(%USID,%mxForma,%Yrc,x)) q:'x  i $p($p(@$zr,"?_",2)," ")=% s %YX(y,x)=%YX(y,%) q
 f  s y=$o(%YX(y)) q:'y  s x=0 f  s x=$o(%YX(y,x)) q:'x  q:$l(ooo)+$l(%YX(y,x))>22000  s ooo=ooo_y_-x_"-"_%YX(y,x)_$c(4) k %YX(y,x)
 k:$l(ooo)<10000 %YX
 q ooo
%SEL(%f,%k) ;; q:'$d(%ALx)
 s %f=$name(@%f,0),%k=$tr(%k,oLat1_" .",oLat2) q:$l($g(%E))!$d(%SEL)!($l(%k)<2)
 f  s %f=$q(@%f) q:'$l(%f)  i $d(@%f)#2,$tr(%f_@%f,oLat1_" .",oLat2)[%k s %SEL($qs(%f,1))=@%f,%E="%SEL"
 q
comment(s,mode) 
 ; ^list from comment of the cell
 n %,o,n,q s n=0 i mode'="^" q 0
 s s=$tr(s,$c(10)_$c(13),%B_%B) i $l(s,"^")>2,s'[%B s s=$$trw^UST(s,"^",%B_"^")
 f %=1:1:$l(s,%B) s o=$p(s,%B,%) i $l(o) s n=n+1,q=$p(o,"^"),o=$p(o,"^",2) s:o["("&(o[")") o="^"_o s %SEL(n)=o s:$l(q) %SEL(n-.9)=q
 q n
 q

MXGTM
MXGTM ; for GTM ; ;[ 20190602 22:24:47 ]
 q
FREAD ; terminal gtm !!
 x "zprint ^FREAD" 
 read "File > ",sd set retry=0 set $ztrap="BADAGAIN" 
 open sd:(readonly:exception="do BADOPEN") use sd:exception="goto EOF"
 for  use sd read x use $principal write x,!
EOF 
 if '$zeof zmessage +$zstatus 
 close sd quit 
BADOPEN 
  set retry=retry+1 if retry=2 open sd
  if retry=4 halt
  if $piece($zstatus,",",1)=2 do
  . write !,"The file ",sd," does not exist. Retrying in about 2 seconds ..."
  . hang 2.1
  . quit
  if $piece($zstatus,",",1)=13 do
  . write !,"The file ",sd," is not accessible. Retrying in about 3 seconds ..."
  . hang 3.1 
 . quit 
 quit 
BADAGAIN 
 w !,"BADAGAIN",!
 quit 
 ;
tcp ; GT.M native master server
  s timeo=30
  s port=2233  ;; 6331
  s tcp="|TCP|"_port
  o tcp:(ZLISTEN=port_":TCP":NODELIMITER:ZNODELAY:ATTACH="listener"):timeo:"SOCKET"
  e  q
  ;u tcpdev:morereadtime=100
  u tcp
 x " w /listen(1)"
  f  d  q:$key]""
  . x "w /wait(timeo)"
  . i $key]"" q
  s socket=$p($key,"|",2)
 close tcp:(SOCKET="listener")
 j tcp^MXGTM
 use tcp:(NODELIMITER:ZNODELAY:SOCKET=socket) ;; j listen^%mwire
  ;c tcp:(SOCKET="listener")
  ;u tcp:(NODELIMITER:ZNODELAY:SOCKET=socket)
  ;;   d command
L s ooo=""
 f  READ *%:60  d:%>-1  s uci=$tr($p($p(ooo," UCI=",2)," "),"""") s:$e(ooo,1,3)="GET" o=$p($p($p(ooo,"UCI=",2),";",1,6)," "),uci=$p(o,";") q:$l(uci)>2!111
 . ;; s ^mxMonito($$ts,3.1,-$j)=% 
 . s:%>0 ooo=$c(%) f  READ *%:0  s ooo=ooo_$c(%)  q:%<0  
 . ;; s ^mxMonito($$ts,3.2,-$j)=ooo
 s Html=$l(ooo)_-987654321
 s %=$c(13)_$c(10),%1=$l(Html)
 s %mxWeb="HTTP/1.1 200 OK"_%_"Content-type: text/html"_%_"Access-Control-Allow-Origin: *"_%_"Cache-Control: no-cache"_%_"Content-Length: "
 w %mxWeb_%1_%_%_Html,$c(0),*-3 ;; k:000 ooo,Html,uci,port,shee ;;  d:$d(o) saveMem
 use 0  w ooo,!,$key,!,Html 
 use tcp
 g L
mwireVersion 
  ;;Build 22
  ;
mwireDate 
  ;;06 July 2011
  ;
version 
  ;
  s output="+M/Wire "_$p($t(mwireVersion+1),";;",2,2000) ;_separatorend;
  w output
  QUIT
  ;

MXTQM
MXTQM ;  [ 03/28/2005  1:14 AM ]  ;[ 20191126 21:53:54 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx ( multi-users virtual EXCEL incorporated into the database )
 ; Copyright (c) 2005-2019, SIA ENTERS, Latvia, 42102022219
 ; registered by Agency INTELS, Riga, Latvia, 40003134156, on June 28, 2005, Nr.178
 q
TQM(o) ; Create & Processed ^oTQMo(%USID,%mxForma)
 s %UCI=$$UCI^MX(),%USID000=$g(%USID(0)) k:$zv["MiniM" ^mxMonito
 d:$zv["Ca" DISABLE^%NOJRN n %zvMSM,gotoForm,oXoooooo,oFlgLANG  s %zvMSM=$s($zv["MS":1,1:+$g(%zvMSM))
 n oo,ooo,%ooOOooo,%oXoOxx1,oOOiii,oOOqqq,oOOqqq14,%noOOooo,%,%1,%2,%3,%3mapGlo,%1globYX,%2globYX,%4,%3flag,%0,%N
 n yyROW,%yyROWnn,yyPLUSoo,xxCOL,flagItog,flagIton,flagItos,%MxEXCEL,%YXy,%YXx,%Yrc,mxLvarYX,%mVarsYX
 n %mxIndeQ,%l,%lX,%E,ERRinTQM,butCount,%mxSheet,%tabRow1,%tabRow,%zTQMo,%insRows,%lastTab 
 s butCount=0,%mxIndeQ=999999,%mxIndex="",%j=$g(%j,1),%B=$c(254) s:'$l($g(%mxForma)) %mxForma=0 s %mxSheet=%mxForma k %insRange,%InsRange
 ; i %mxForma'="datums",'%mxForma s ^mJournal(%USID,$$pD^MXF($h,2),"%mxForma")=%mxForma
 s %=$g(%USID("EnterCodePass")) k:%=6152!("ATG VMXIRIS"[%UCI)!$d(%mxWeb) %
 i $d(%) s o=$g(^mxConfig(1)) i o,o-% HALT
 i $d(%) i $d(^mxConfig(2)) s o=$g(^(2,%USID)) HALT:'o&'%  i o>9,o-% HALT
 i $d(%) i $d(^mxConfig("F",%mxForma)),'$d(^(%mxForma,%USID)) HALT
 s $zt="ErrTQM^MXTQM" i %USID'=$g(%USID000),$l($g(%USID000)) d
 .s %=" --- {1080}{1079}{1084}{1077}{1085}{1077}{1085}{1080}"
 .s %mxWarng(-1)=%_"e {1080}{1076}{1077}{1085}{1090}{1080}{1092}{1080}{1082}{1072}{1090}{1086}{1088}{1072} {1082}{1083}{1080}{1077}{1085}{1090}{1072} MX !! --- (( "_%USID
 .s %USID=%USID000 
 k oYX,%YX,%YXi s o=%USID,(oSheetYX,%)=%mxForma 
 k ^oTQMo(o,%),^oTQMo2(o),^oTQMret(o,%),^oErr(o),^onEvents(o,%)
 k ^omxMacro(o,%),^omxGlobA(o,%),^onSelect(o,%),^onChange(o,%),^oYX(o,%)
 k ^omxRight(o,%),^omxGlobR(o,%)  ; onRightClick
 k ^onSeleDD(o,%)  ; sel and xecute m-comm mapped with selected item from DD-API list
 i $d(%mxWeb) m ^oTQMo(o,%)=^oRC(o,%) k ^oYrc(o,%) q:'$d(^oRC(o,%)) 0  d
 . s %1=0,%2=0 f  s %1=$o(^vmxExcel(o,%,".Hyperlinks",%1)) q:'%1  f  s %2=$o(^vmxExcel(o,%,".Hyperlinks",%1,%2)) q:'%2  s %3=^(%2),^(%2)=$g(^oTQMo(o,%,%1,%2),0)_"<mx ;.Hyp="_%3
 i '$d(%mxWeb) k ^oRC(o,%) m:$d(^oTQM(o,%)) ^oTQMo(o,%)=^oTQM(o,%),^oRC(o,%)=^oTQM(o,%) m:'$d(^oTQM(o,%)) ^oTQMo(o,%)=^oTQM(o),^oRC(o,%)=^oTQM(o) s ^vmxExcel(o,%,"M=EXCEL")=$g(mxConfig("M=EXCEL",%mxForma))  
 s %2max=0,(%,%MxEXCEL)=$g(^vmxExcel(o,%,"M=EXCEL")),%1=$p(%," "),%2=$p(%," ",2),%3mapGlo=$p(%," ",3)
 i $zv'["Ca",$zv'["IRIS",%["^||" s:%1["^||" %1="" s:%2["^||" %2=-9 s:%3["^||" %3=""  
 k:'$l(%3mapGlo) %3mapGlo i "M o . e"'[%1 s %mVarsYX=%1 
 s:"o."[%2 %2=-9 s:$e(%2)="^" %2globYX=%2,%2=-9 s:'%2 %mVarsYX=%2
 i %[";n%oTQMall" n %oTQMall s %oTQMall=1
 q:'$d(^oRC(%USID,%mxForma)) "ERROR :::  not exist "_$zr 
 x $p(%,";",2,999) s (yyROW,xxCOL,%2,%1,%0)=0,%zTQMo=$name(^oTQMo(%USID,%mxForma)) k yFORMAT n %oRChange  
 f  s %1=$o(^oTQMo(%USID,%mxForma,%1)) q:'%1  i $o(^(%1,1)) s %2=1 f  s %2=$o(^(%2)) q:'%2  s:%2>%2max %2max=%2 i $e(^(%2))="?" s %=^(%2),%4=$e(%,1,5) d:%4'["^^"
 . i $e(%,1,3)["=" s %=$p(%,"=",2,999) s:$e(%)'=" " %=" s oo="_% s (^oRC(%USID,%mxForma,%1,%2),@%zTQMo@(%1,%2))="?"_$s($e(%,1,3)["_"!%0:"_",1:"")_"o ;"_% q
 . i $e(%,1,9)["?_%mxInde" s:%[" f  s " @$zr=$$trw^UST(%," f  s "," f %mxIndeO=1:1:9999999 s ") q   
 . i $e(%,1,12)["?$$EnterList" k:'$d(%mxWeb) @%zTQMo@(%1,%2) q
 . i $e(%,1,12)["?$$ReadTable" d  q
 .. n oOOqqq s oOOqqq=% n %22,%n,%,%i,%node,%mNode,%mComm,yyRow s yyRow=%1
 .. s @%zTQMo@(%1,1)="~",@%zTQMo@(%1+1,1)="~",%=""
 .. s %mComm=$p(oOOqqq," ",3,999),%node=$p(oOOqqq," ",2) s:oOOqqq[" ; " %mComm=$p(oOOqqq," ; ",2,999)
 .. f %22=%2:1 q:'$o(@%zTQMo@(%1+1,%22-1))  s %n=$p($g(^(%22)),"<") s:%n["*" (%i,%n)=$tr(%n,"*") s:%n=")" %i=%22 q:%n=")"  s:$l(%n)&'%n %="s "_%n_"=$g(^("_%22_")) "_% d
 .. . s:$l(%node) %mNode=" s @%node@(@%i,"""_%n_""")="_%n_$g(%mNode)
 .. i $g(%i) s %mNode="",%="" f %22=%2:1 q:'$o(@%zTQMo@(%1+1,%22-1))  s %n=$g(^(%22)) s:%n %mNode=" s $p(@%node@(@%zTQMo@(%1,"_%i_")),%B,"_+%n_")=$g(@%zTQMo@(%1,"_%22_")) "_%mNode
 .. k:'$d(%i) %mNode s %mComm="n %,%11,%1,%2,o "_%mComm i $l(%node),$e(%node)'="^" k @%node 
 .. f %1=%1+2:1 q:'$o(@%zTQMo@(%1,1))!($o(^(1))>%22)  x %,$g(%mNode),%mComm k @%zTQMo@(%1) s ^(%1,1)="~"
 . i "^.@"'[$e(%4,2),%4'["*" q 
 . i %4["**",%2<$s($p(%,"**",2):$p(%,"**",2),1:250),%2<%2max&('$o(^(%2))!111),'$l($g(^(%2+1))) s @$zr=%,%oRChange(%1,%2+1)=%
 . i %4["*" s %4=%4_-1,%4=$p(%4,"-",2) s:%4 (^(%2),%oRChange(%1,%2))=$g(@%zTQMo@(%1,%2-%4)) q  
 . i %="?^" k ^(%2) x "f o=1:1:9 s %=$g(@%zTQMo@(%1-o,%2)) i $l(%)>2 s (%oRChange(%1,%2),@%zTQMo@(%1,%2))=% q" q 
 . s %=$p($e(%,3,99)," ") i %=1 s %=$tr($p(^(%2)," ",2,999),"""","'") d  q
 .. i '$d(helpShow(%mxForma,%1,%2)) s helpShow(%mxForma,%1,%2)=%,^(%2)="?o ; s oo="""_%_""" "
 .i %=".",%4["..",$e($g(^(%2-1)))="?" s ^(%2-1)=^(%2-1)_" "_$p(^(%2)," ",2,999) k ^(%2) q
 . q:"o %2..??"[%!%  s @%=$p(^(%2)," ",2,999) x "f  q:$e(@%)'="" ""  s @%=$e(@%,2,999)" 
 . s:$e(@%)=";" @%=$e(@%,2,999) s %noOOooo=%,^(%2)="",o=%2+1
 . i $e($g(^(o)),1,3)="?.." s @%noOOooo=@%noOOooo_$p(^(o),"..",2,999),^(o)="",o=o+1
 . i $e($g(^(o)),1,3)="?.." s @%noOOooo=@%noOOooo_$p(^(o),"..",2,999),^(o)=""
 . i $zv'["MS"!($l(@%noOOooo)<512) s ^omxForma(%USID,%mxForma,"?.var",%noOOooo)=@%noOOooo,^oRC(%USID,%mxForma,"?.var",%noOOooo)=@%noOOooo k ^oRC(%USID,%mxForma,%1,%2) i $d(@%zTQMo@(%1,%2))
 ;; s %=9999999999 f  s %=$o(@%zTQMo@(%),-1) q:'%  q:$g(^(%,1))'["~"  k @$zr 
 i $d(%oRChange) m ^oRC(%USID,%mxForma)=%oRChange,^oTQMo(%USID,%mxForma)=%oRChange k %oRChange
 s %="" f  s %=$o(^oRC(%USID,%mxForma,"?.var",%)) q:'$l(%)  s @%=^(%) 
 s ^oRC(%USID,%mxForma,"?$$TQM",1)=%MxEXCEL
 i $d(%mVarsYX) k @%mVarsYX m @%mVarsYX=^oTQM(%USID,%mxForma),mxLvarYX=%mVarsYX
 s (yyROW,%mxIndex,%oXoOxx1,%YXy,%tabRow,oOOqLANG,%insRows)="",oFlgLANG=("LV"'[$g(%LANG))_$g(%LANG)
 f  s yyROW=$o(@%zTQMo@(yyROW)) q:'yyROW  d  d:$d(%lX) %lX d:%YXy>999999 r999999 q:yyROW<0  m:$d(%mVarsYX) @%mVarsYX@(%YXy)=@%zTQMo@(yyROW) 
 . i %USID'=$g(%USID000),$l($g(%USID000)) d  s yyROW=-yyROW,%USID=%USID000 q
 ..s %=yyROW_"  "_%mxForma_" -- {1079}{1072}{1073}{1083}{1086}{1082}{1080}{1088}{1086}{1074}{1072}{1085}{1086}"
 ..s %mxWarng(-2)=%_"  !! {1087}{1077}{1088}{1077}{1082}{1083}{1102}{1095}{1077}{1085}{1080}{1077} {1085}{1072} {1076}{1088}{1091}{1075}{1086}{1075}{1086} {1072}{1073}{1086}{1085}{1077}{1085}{1090}{1072} !!  "_%USID
 . s xxCOL=1,%oXoOxx1=$g(@%zTQMo@(yyROW,1)),%xxxHideRow=0 
 . ;; s:yyROW["." %YXy=%YXy+1 s:yyROW'["." %YXy=%YXy+yyROW-%yROWold,%yROWold=yyROW
 . s %YXy=yyROW\1+%insRows
 . s %tabRow=$s($e(%oXoOxx1)="_":%tabRow+1,1:0),^oYX(%USID,%mxForma,%YXy,0)=yyROW_$s(%tabRow:-%tabRow,1:"")
 . i %tabRow d
 .. i %tabRow=1 s %tabRow(1)=%YXy,%tabRow(1)=yyROW k %tabRow1 m %tabRow1=@%zTQMo@(yyROW) q
 .. s %=$d(@%zTQMo@(yyROW,-1.11)) f  s %=$o(%tabRow1(%)) q:'%  s:$e($g(^(%)))["?" %tabRow1(%)=^(%) s:$e(%tabRow1(%))="?" ^(%)=%tabRow1(%)
 . f  s (%YXx,xxCOL)=$o(@%zTQMo@(yyROW,xxCOL)) q:'xxCOL  d  q:xxCOL<0  i $l($g(oOOqLANG)) s (@%zTQMo@(yyROW,xxCOL),^oYX(%USID,%mxSheet,%YXy,xxCOL))=oOOqLANG,oOOqLANG=""  
 .. s oOOqqq=^(xxCOL),oOOiii=$zr,%N="oooooooo" s:'$d(%tabRow) %tabRow=0 i $e(oOOqqq,1,3)'="?$$" s:"?"[$e(oOOqqq)&$d(%mxWeb) ^(xxCOL)="" i yyROW["."!'$d(%mxWeb) k:'$d(%oTQMall)&(oOOqqq'["<mx ") ^(xxCOL) q:$l(oOOqqq)<2
 .. i $e(oOOqqq)'="?" k:%tabRow>$d(%mxWeb)&'$d(%oTQMall) ^(xxCOL) s:$g(oFlgLANG) oOOqLANG=$g(^mxDictio(%LANG,$e($$U^MXF(oOOqqq),1,255))) q:%tabRow  s:$e(oOOqqq)'="="&(" 0 - "'[oOOqqq) ^oYX(%USID,%mxSheet,%YXy,xxCOL)=oOOqqq q
 .. s %3flag=$p(oOOqqq,";")'["-"
 .. s oOOqqq14=$e(oOOqqq,1,4),oOOqqq1=$s(oOOqqq14'["*":oOOqqq,1:"") q:oOOqqq14[".."
 .. k oo s %=0 i $e(oOOqqq,1,3)="?$$" d  s o=$p($p(oOOqqq," "),":") s:$l(o) ^oRC(%USID,%mxForma,o,%YXy_-%YXx)=oOOqqq i $p(oOOqqq," ")'["::" s %=1 i $e(oOOqqq,1,7)="?$$Diagr" s %=0 q
 .. . i $d(%mxWeb),$p(oOOqqq," ")["::" s $p(oOOqqq," ")=$$trw^UST($p(oOOqqq," "),"::",":")
 .. i % d  s o="" q:$e(oOOqqq,1,4)'["?$$B"  x:oFlgLANG "s %=$p($g(@oOOiii),"" "",4) s:$l(%)>2 %=$tr($g(^mxDictio(%LANG,$$u8^MXF(%))),"" "",""_"") s:$l(%) $p(@oOOiii,"" "",4)=%" q
 .. . n o s o=$p($p(oOOqqq," "),":",2) i $l(o) x "s o="_o s:o $p(oOOqqq," ")=$p($p(oOOqqq," "),":"),@oOOiii=oOOqqq  i 'o s @oOOiii="",oOOqqq="" q
 .. . i $e(oOOqqq,1,10)="?$$SaveMem" s %=$p(oOOqqq," ",2) s:%="" %=%mxForma i 1_$$SaveMem^USX(%USID,$j_%) s @oOOiii="" q
 .. . i $e(oOOqqq,1,10)="?$$RestMem" s %=$p(oOOqqq," ",2) s:%="" %=%mxForma d  s @oOOiii="" q
 .. . . s %1=$p(oOOqqq," ",3) s:$e(%1)="(" %1=$e(%1,2,$l(%1)-1) n:$l(%1) @(%1)
 .. . . n oOOiii,oo,yyROW,xxCOL,%noOOooo,oOOqqq,o,%YXy,%YXx,%tabRow,%mxForma,%mxWarng,%insRows
 .. . . s %1=$$RestMem^USX(%USID,$j_%)
 .. . i $e(oOOqqq,1,10)="?$$RunLine" s %=$$RunLine(yyROW,%YXx),@oOOiii="" q
 .. . s oXoooooo=$p(oOOqqq," ;;; ",2,99) i $l(oXoooooo)>1 x oXoooooo
 .. . i $l(oOOqqq,"?")>2 s oOOqqq=$$InsVar6(oOOqqq),@oOOiii=oOOqqq
 .. . i $p(oOOqqq," ")["--"!($e(o,1,7)="?$$B 0 ") s @oOOiii="" q
 .. . i $e(oOOqqq,1,6)["?$$B~ ",$d(%mxWeb) s @oOOiii="?$$B"_$p(oOOqqq,"~",2,99) q
 .. . i $e(oOOqqq,1,7)="?$$RunX" s %=$$RunX(yyROW,%YXx,oOOqqq),@oOOiii="." q
 .. . i $e(oOOqqq,1,5)["?$$B~" s o=$p(oOOqqq," ",4),o=$s(o="":%B,$e(o,1,2)["[":$p(o,"[",2,22),1:o),@oOOiii=$tr(o,"_[]"," "),o=".<mx <$$B "_$p(oOOqqq," ",2,999)_" /$$B>",o=$$S^MXF("s oo="""_$$kav2^MXF(o)_"""") q
 .. . i $e(oOOqqq,1,4)["?$$B" s:'$d(%mxWeb) butCount=butCount+1 d:butCount>220!(butCount>99&%tabRow)  q
 .. .. s butCount=butCount-1,o=$p(oOOqqq," ",4),o=$s(o="":%B,$e(o,1,2)["[":$p(o,"[",2,22),1:o)
 .. .. s @oOOiii=$tr(o,"_[]"," "),o=".<mx <$$B "_$p(oOOqqq," ",2,999)_" /$$B>",o=$$S^MXF("s oo="""_$$kav2^MXF(o)_"""")
 .. q:" ?$.@*^012"[$e(oOOqqq14,2)  s (%N,%noOOooo)=$tr($p($p(oOOqqq," "),";"),"?_"),oXoooooo=$p(oOOqqq,";",2,999)
 .. i %noOOooo="%l" k %l m %l=^oYX(%USID,%mxSheet,%YXy) m %l=@%zTQMo@(yyROW) k %l(0)
 .. i $d(%YX),$d(%YX(%YXy,%YXx)) s @%N=%YX(%YXy,%YXx) k %YX(%YXy,%YXx)
 .. i $p($p(oOOqqq," ",1,5),";")_" "[" oo " s oo=$g(@%noOOooo),@%noOOooo=$p(oo,"<mx ")
 .. i $e(oOOqqq14,2)'="_" s %noOOmod=$p(oOOqqq," ; ")_" " d  q
 ... s:"oo %1 "'[%noOOooo ^oRC(%USID,%mxForma,"?var",%noOOooo)=%YXy_-%YXx_"---"_oOOqqq d  i oXoooooo="" s:$d(@%noOOooo)#2 ^oYX(%USID,%mxSheet,%YXy,%YXx)=$p(@%noOOooo,"<mx ") q
 ... . i %noOOmod[(" zw ") x oXoooooo n %,o s o=%noOOooo f %=1:1 s o=$q(@o) q:'$l(o)  s %YX(%YXy+%,%YXx)=o,%YX(%YXy+%,%YXx+1)=$g(@o)
 ... . q:$l(oXoooooo)>1
 ... . i '%noOOooo,$l(%noOOooo)<33,"o"'[%noOOooo,$l($g(@%noOOooo)) d:$g(oFlgLANG)  s @oOOiii=$e(@%noOOooo,1,$s('%zvMSM:31500,1:%zvMSM+509)) s:$d(%3mapGlo)&%3flag %3mapGlo(%noOOooo)=$p(@oOOiii,"<mx ") q
 ... . . s %=$p(@%noOOooo,"<mx ") i $l(%)>2 s %=$g(^mxDictio(%LANG,$e(%,1,255))) i $l(%) s:$l($p(@%noOOooo,"<mx ",2)) %=%_"<mx "_$p(@%noOOooo,"<mx ",2) s @%noOOooo=%
 ... q:$l(%noOOooo)>31 
 ... i oXoooooo["$$RestMem^" d  s @oOOiii="" q
 ... . n oOOiii,oo,yyROW,xxCOL,%noOOooo,oOOqqq,o,%YXy,%YXx,%tabRow,%mxForma,%insRows
 ... . x oXoooooo
 ... k gotoForm x oXoooooo
 ...  i $d(%insRange),%insRange>0 n %1,%2,%3,% s %1=$p(%insRange," ",2),%2=$p(%1,":",2),%3=$o(@%zTQMo@(9999999),-1) d:%1&%2  s %InsRange=%insRange k %insRange  m ^ERR=@%zTQMo
 ... . f %=%3:-1:%2+1 m @%zTQMo@(%2-%1+1*%insRange+%)=@%zTQMo@(%) k @%zTQMo@(%) 
 ... . f %3=1:1:%insRange f %=%1:1:%2 m @%zTQMo@(%2-%1+1*%3+%)=@%zTQMo@(%)
 ... i "o oo ooo"'[%noOOooo,%noOOooo'["%" s %=$p($g(@%noOOooo),"<mx ") s:$l(%)>510 %=$e(%,1,$s('%zvMSM:31500,1:%zvMSM+509)) s ^oYX(%USID,%mxSheet,0,%noOOooo)=%,^oYX(%USID,%mxSheet,%YXy,%YXx)=%
 ... i $d(oo) d:$g(oFlgLANG)  s:$l(oo)>505 oo=$e(oo,1,$s('%zvMSM:31500,1:%zvMSM+509)) s:$g(%oXoOxx1)'["~" @oOOiii=oo
 ... . s %=$p(oo,"<mx ") i $l(%)>2 s %=$g(^mxDictio(%LANG,$e($$U^MXF(%),1,255))) i $l(%) s:$l($p(oo,"<mx ",2)) %=%_"<mx "_$p(oo,"<mx ",2) s oo=%
 ... i $d(%3mapGlo) s:%3flag %3mapGlo(%noOOooo)=$p($g(oo),"<mx ") i %3mapGlo[%noOOooo s %=$tr(%3mapGlo,"()",",,") i %[(","_%noOOooo_",") k %3mapGlo(%noOOooo)
 ... i $d(%mVarsYX),$l($g(@oOOiii)) s @%mVarsYX@(%YXy,+xxCOL)=$p(@oOOiii,"<mx ")
 ... i $d(mxERROR) s xxCOL=-xxCOL,yyROW=-yyROW q
tabRow .. i $e(oOOqqq14,2)="_" s %lastTab=%YXy d  q
 ... i %noOOooo="%l" k %l m %l=@%zTQMo@(yyROW) q
 ... i oXoooooo="","oo "'[%noOOooo d  q
 ...  .  i %oXoOxx1["~" q
 ...  .  s o=$g(@%noOOooo),%=$p(o,"<mx ") i $g(oFlgLANG),$l(%)>2 s oOOqLANG=$g(^mxDictio(%LANG,$e(%,1,255))) i $l(oOOqLANG) s %=oOOqLANG i $l($p(o,"<mx ",2)) s o=%_"<mx "_$p(o,"<mx ",2)
 ...  .  i $l(o)>510 s %=$e(%,1,$s('%zvMSM:31500,1:%zvMSM+509)),o=$e(o,1,$s('%zvMSM:31500,1:%zvMSM+509)) 
 ...  .  s @oOOiii=o s:$d(mxLvarYX) @mxLvarYX@(%YXy,+xxCOL)=%
 ...  .  s ^oYX(%USID,%mxSheet,%YXy,%YXx)=%,^(%noOOooo)=%
 ... i %noOOooo="%mxIndex" s %mxIndex="" n %l i %oXoOxx1["~" s %oXoOxx1=%YXx d  i %noOOooo<9999999 s xxCOL=-1 q
 ... . n %n,oo f %noOOooo=1:1:9999999 s %mxIndex="" x oXoooooo q:%mxIndex=""  d
 ... .. s %YXx=%oXoOxx1
 ... .. f  s %YXx=$o(@%zTQMo@(yyROW,%YXx)) q:'%YXx  s %=$g(^(%YXx)) i $e(%,1,2)="?_" s %n=$tr($p(%," "),"?_*") i $l(%n),'%n s oo=$g(@%n) x $p(%,";",2,999)   
 ... x oXoooooo i $d(oo),$l(oo)>509,%zvMSM  s:%zvMSM=1 oo=$p(oo,"<mx ") s oo=$e(oo,1,%zvMSM+509)
 ... i %noOOooo="%mxIndex" d  q:xxCOL<0  i $d(%l)>9 m @%zTQMo@(yyROW)=%l s @oOOiii=$g(oo),xxCOL=-1 q 
 ... . i '%tabRow,oXoooooo["=%tabRow" k @%zTQMo d  q
 ... . . n % s %=yyROW_$c(10)_oXoooooo_$c(10)_$g(%mxForma)_" ERROR:_%mxIndex>(%tabRow=0) -  {1085}{1072}{1076}{1086}" 
 ... . . s (%mxWarng(yyROW),mxERROR)=%_" {1085}{1072}{1076}{1086} {1091}{1074}{1077}{1083}{1080}{1095}{1080}{1090}{1100} {1088}{1072}{1079}{1084}{1077}{1088} {1090}{1072}{1073}{1083}{1080}{1094}{1099} !! "_%mxIndex
 ... . i yyROW[".5" k @%zTQMo s (%mxWarng(yyROW),mxERROR)=yyROW_$c(10)_oXoooooo_$c(10)_$g(%mxForma)_" ERROR:_too-many-rows-%mxIndex>"_%mxIndex,%tabRow=0 q
 ... . s %mxIndeQ=%mxIndeQ-1 i %mxIndeQ<0 k @%zTQMo s xxCOL=-1,(%mxWarng(yyROW),mxERROR)=$g(%mxForma)_" ERROR : %mxIndeQ>999999 : Row="_(yyROW\1),%mxIndex=0 q
 ... . i %mxIndex="" s xxCOL=-1,@%zTQMo@(%tabRow=1+yyROW,1)="_~",%1=yyROW\1,%2=+$e($p(yyROW,".",2)_"000000",1,6) d  q
 ... .. k %tabRow1 i %2>1 k @%zTQMo@(yyROW),^oYX(%USID,%mxSheet,%YXy) s %YXy=%YXy-1,%2=%2-1,%insRows=%insRows-1
 ... .. i %2,$d(%mxWeb),$d(^vmxExcel(%USID,%mxForma,".RowHeight")) s @$zr=$p(@$zr,":",1,%1)
 ... . s @oOOiii=oOOqqq s:$d(%mVarsYX) @%mVarsYX@(%YXy,+xxCOL)=oOOqqq 
 ... . i $d(%3mapGlo),%3flag,%oXoOxx1'["_" s %3mapGlo(%noOOooo,%YXy)=$p(oOOqqq,"<mx ")
 ... . s o=$g(@%zTQMo@(yyROW\1+1,1)) s:o="-" o="_"
 ... . i o'["_",%oXoOxx1'["_" d
 ... .. m @%zTQMo@(yyROW+.000001)=@%zTQMo@(yyROW) k @%zTQMo@(yyROW+.000001,1) s %insRows=%insRows+1
 ... .. s %tabRow=$e($p(yyROW,".",2)_"000000",1,6)+1
 ... .. i %tabRow=1 s %tabRow(1)=%YXy d
 ... .. . i oXoooooo_$g(^oRC(%USID,%mxForma,yyROW,%YXx))'[" ;;; " s ^(%YXx)=$g(^(%YXx))_" ;;; s %YX(%YXy,2)="".<mx ic19.-2"" "
 ... s oo=$g(oo) i $g(oFlgLANG),$l(oo) s o=$p(oo,"<mx ") i $l(o)>2 s %=$g(^mxDictio(%LANG,$e(o,1,255))) s:$l(%) o=$p(oo,"<mx ",2),oo=%_$s($l(o):"<mx "_o,1:"")
 ... s @oOOiii=oo s:$d(%mVarsYX) @%mVarsYX@(%YXy,+xxCOL)=oo i $d(%3mapGlo),%3flag,%oXoOxx1'["_" s %3mapGlo(%noOOooo,%YXy)=$p(oo,"<mx ")
 ... q:'$l(oo)
 ... s %=$p(oo,"<mx ") s:$l(%)>511 %=$e(%,1,$s('%zvMSM:31500,1:%zvMSM+509))
 ... s ^oYX(%USID,%mxSheet,%YXy,%YXx)=% s:"o oo"'[%noOOooo ^(%noOOooo)=%
 i $d(%YX),'%insRows s %1=0 f  s %1=$o(%YX(%1)) q:'%1  s %2=0 f  s %2=$o(%YX(%1,%2)) q:'%2  s @%zTQMo@(%1,%2)=%YX(%1,%2),^oYX(%USID,%mxForma,%1,%2)=%YX(%1,%2) k %YX(%1,%2)
 i $d(%mxWeb) s %1=999+$g(%lastTab) d:$e(%mxForma,1,4)'="web_"
 . ;; f %=%YXy:1 q:$g(^oTQMo(%USID,%mxForma,%,1))'["_"  s %YXy=%YXy+1
 . s:'$d(^oYX(%USID,%mxForma,%YXy,2)) ^(2)=%mxForma q:'$d(^vmxExcel(%USID,%mxForma,".RowHeight"))
 . s o=$p($p(@$zr,"*"),":",1,%YXy) s:'$l($p(o,":",%YXy)) $p(o,":",%YXy)=":"
 . f %=%YXy:-1:2 i $p(o,":",%) q:%YXy-%<9  s @$zr=$p(o,":",1,%)_":*"_$s(%YXy-%>%1:%1,1:%YXy-%) q
 i $d(mxERROR) d:$zv["Ca" ENABLE^%NOJRN  q $g(%YXy)_" mxERROR "_$g(mxERROR)
eErrTQM s:$zv["MiniM" ^mxMonito($g(ooooREAD)+.7,$g(%mxForma)_" ")="eErrTQM" s $ze=""
 s yyPLUSoo=0
 s yyROW="",$zt="TQMe^MXTQM",$ze="" i $d(%2globYX) d
 .f  s yyROW=$o(@%zTQMo@(yyROW)) q:yyROW=""  s:yyROW["." yyPLUSoo=yyPLUSoo+1 d
 .. s y=yyROW\1+yyPLUSoo 
 .. i $d(%2globYX),$d(@%2globYX@(y)) m ^oTQMo2(%USID,%mxForma,y)=@%2globYX@(y)
 .. m ^oTQMo2(%USID,%mxForma,y)=@%zTQMo@(yyROW) 
 .k @%zTQMo m @%zTQMo=^oTQMo2(%USID,%mxForma) 
 ;
TQMe k ^oTQMo2(%USID,%mxForma)
 s $zt="ErrTQM^MXTQM"
 d:$zv["Ca" ENABLE^%NOJRN 
 q $g(yyROW)
ztRunEnd q
%lX i $d(%lX) m @%zTQMo@(yyROW)=%lX k %lX
 q
lineItog q
oHideRow q
nPLUS(oOOqqq) 
 q "%nPLUS"
xPLUS(oOOqqq) 
 q "%nPLUS"
x3 q
RunX(%startYY,%YXx,oOOqqq00) 
 n yyROW,%1,oo,o,%YXy,oXoooooo,oOOqqq,%YXyMaxm
 s $et="d ErrTQM^MXTQM",%YXyMaxm=$p(oOOqqq00," ",2) s:'%YXyMaxm %YXyMaxm=999999
 s %YXy=%startYY f  s %YXy=$o(@%zTQMo@(%YXy)) q:%YXy>%YXyMaxm!'%YXy  d:$e($g(@%zTQMo@(%YXy,%YXx)))="?"
 .s oOOqqq=$e(^(%YXx),2,999) i "$*._?;:^"[$e(oOOqqq)!oOOqqq q
 .k oo s %1=$p(oOOqqq,";"),%N=$p(%1," "),yyROW=%YXy,oXoooooo=$p(oOOqqq,";",2,999)
 .i " oo %l "'[%N s:%1[" oo "!($l(oXoooooo)<3) oXoooooo="s (oo,@%N)=$g(@%N) "_oXoooooo
 .x oXoooooo
 .s @%zTQMo@(%YXy,%YXx)=$e("'"_$g(oo),1,510) s:$l($g(mxLvarYX)) @mxLvarYX@(%YXy,%YXx)=$g(oo) 
 q ""
RunLine(%startYY,%startXX,startGlo) 
 n %1,%2,oo,o,%YXx,%,%omVars,oXoooooo,%E,%zt s %zt=$zt,$zt="ErrTQM^MXTQM"  ;;$et="d ErrTQM^MXTQM",
 s o=$g(@%zTQMo@(%startYY,%startXX)),%2=$p($p(o," "),":",2,9) i $l(%2) x "s %2="_%2 q:'%2 ""
 s %1=$p(o,"/",1,5),%2=$p(o,"/",6,99) i %1["/" d  s o=%1 s:$l(%2) o=o_"/"_%2  
 . f %="/ "," /","  " f  q:%1'[%  s %1=$$trw^UST(%1,%,$s(%["/":"/",1:" "))
 s o=$p(o," ",2,999),%RunName=0
 i o["/" s %RunName=$p(o,"/") s:%RunName="" %RunName=0 k ^mxReestr("RunLine",%USID,%mxForma,%RunName) s ^mxReestr("RunLine",%USID,%mxForma,%RunName,0,0)=o
 i '%startYY s %RunName=%startXX,o=$g(^mxReestr("RunLine",%USID,%startYY,%RunName,0,0)) q:'$l(o) -1_" "_%startYY_" "_%RunName
 s:$zv'["Ca"&($zv'["IRIS") $p(%RunName,"/")=$tr($p(%RunName,"/"),"|") s %=%RunName s:o["/" $p(o,"/")=% ;;  i %,%'["+",$d(^om(%USID,+%)) k ^om(+%,%USID) m ^om(+%,%USID)=^om(%USID)
 k:%'["+"&% ^om(%USID) i $d(^om(%USID)) n %mxPrint
 i $zv["Ca"!($zv["IRIS") x:%["^||om(" "k:%'[""+""&% ^||om(%USID) s %=$d(^||om(%USID))" n:% %mxPrint
 i $l(o)>5 k %om,om,formulaL s om=o,%2=$p(om,"/",2) m:$g(startGlo)'="" ^om(%USID)=@startGlo d
 .f %=2:1:6 s:$e($p(om,"/",%))="@" $p(om,"/",%)=@($e($p(om,"/",%),2,99))
 .s om(2)=$tr($p(om,"/",2,4),"+-")
 .f %=1:1:$l(%2," ") s %omPrint(%)="^om(%USID,"_%_","_$e("o,o,o,o,o,o,o,o,o,o,",1,$l($p(%2," ",%),":")*2-1)_")",%omPrint=%omPrint(1) s:%RunName["^||om(" $p(%omPrint(%),"(")="^||om"
 .f %=1:1:$l(%2," ") s %omPrint(-%)="^om(%USID,"_%_","_$p("-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999,-99999999",",",1,$l($p(%2," ",%),":"))_")" d
 .. s:%RunName["^||om(" $p(%omPrint(-%),"(")="^||om"
 .s %1=$tr($p(om,"/",3,4),"/:+-","  ")
 .f %=1:1:$l(%1," ") s o=$p(%1," ",%) i $l(o),'o,o'="om" s @o=""
 .s %1=$tr($p(om,"/",2),"/:+-","  ")
 .f %=1:1:$l(%1," ") s o=$p(%1," ",%) i $l(o),'o s:000 @("x"_o)=$g(@("x"_o)) s:$g(@o)="" @o=o_"<mx ic3"
 i '%startYY n mxReestr,%YXy m mxReestr=^mxReestr("RunLine",%USID,%startYY,%RunName) s %YXx=0,%YXy=0
 i '%startYY f  s %YXy=$o(mxReestr(%YXy)) q:'%YXy  s oXoooooo="" f  s %YXx=$o(mxReestr(%YXy,%YXx)) d:%YXx  i '%YXx x oXoooooo q
 .s o=mxReestr(%YXy,%YXx)
 .i $e(o)="{" s xRunLine(%YXy,%YXx)="s %YXx="_%YXx_" "_$p($e(o,2,999)_"}}}}}","}}}}}"),o="x xRunLine("_%YXy_","_%YXx_")"
 .q:$e(o)="?"  f %=1:1:9 q:$e(o)'=" "  s o=$e(o,2,999)
 .f %=1:1:9 q:$e(o,$l(o))'=" "  s o=$e(o,1,$l(o)-1)
 .s oXoooooo=oXoooooo_"  "_o,formulaL(%startYY)=oXoooooo 
 i '%startYY x:$l($g(startGlo)) "k @startGlo m @startGlo=^om(%USID)" q $g(%RunName)
 f %YXx=%startXX+1:1 s o=$g(@%zTQMo@(%startYY,%YXx)) s:$e(o)=";" @$zr="?o ; " q:"?;.(+-='*#@~:/$0123456789"[$e(o)  s o=@$zr,@$zr="?o ; " d
 .s:$d(%RunName)&%RunName'["+" ^mxReestr("RunLine",%USID,%mxForma,%RunName,%startYY,%YXx)=o
 .i $e(o)="{" s xRunLine(%startYY,%YXx)="s %YXx="_%YXx_" "_$p($e(o,2,999)_"}}}}}","}}}}}"),o="x xRunLine("_%startYY_","_%YXx_")"
 .f %=1:1:9 q:$e(o)'=" "  s o=$e(o,2,999)
 .f %=1:1:9 q:$e(o,$l(o))'=" "  s o=$e(o,1,$l(o)-1)
 .s o(%YXx)=o
 s %=0 f  s %=$o(o(%)) q:'%  s:o(%)="x" o(%+1)=""""_$$trw^UST($g(o(%+1)),"""","""""")_"""" d
 .s oXoooooo=$g(oXoooooo)_"  s %YXx="_%_" "_o(%)
 i $d(oXoooooo) s (formulaL(%startYY),formulaL)=oXoooooo,%maxLoom=9999999 x oXoooooo
 s $zt=%zt q ""
ErrTQM n o s:$e($g(%MxEXCEL))'=" " %MxEXCEL="       "_$g(%MxEXCEL) k %3mapGlo
 g:$d(ERRinTQM) TQMe 
 x:$zv["GT" "s o=$ZSTATUS_$c(10)"
 x:$zv'["GT" "s o=$ze_$c(10)"
 s o=$g(%mxForma)_" TQM-ERROR"_"-"_$c(10)_o_" Row="_$g(%YXy)_" Column="_$g(%YXx)_$c(10)_"    %I="_$g(%I)_"  z="_$g(z)_"  %zr="_$g(%zr)_" $zr="_$zr
 s o=o_$c(10)_$g(oXoooooo),o=$tr(o,$c(0),"o"),o=$$trw^UST(o,"<mx","<.mx"),oXoooooo=$$trw^UST($g(oXoooooo),"<mx","<.mx")
 i $g(%YXy),$g(%YXx) s o=$e(o,1,250)_" ... "_$c(10)_(%YXy_-%YXx)_$c(10)_$g(^oTQM(%USID,%mxForma,+%YXy,+%YXx)) d
 . s ^oTQMo(%USID,%mxForma,+%YXy,+%YXx)=$s($zv'["MS":o,1:$e(o,1,500)),%YX(+%YXy,+%YXx)=oXoooooo_" ::: ERROR ::: "_$ze_" <mx ic1.99 __ |o| fc46 fb fs12"
 s ^oErr(%USID,+$g(ooooREAD),+$g(%YXy),+$g(%YXx))=$e($g(oXoooooo),1,510),%mxWarng(+$g(%YXy)_-$g(%YXx))=o,%mxWarng(+$g(%YXy)_-$g(%YXx)_" m-command : ")=$g(oXoooooo)
 s ^("oi")=$e($g(oOOiii),1,510),^("oq")=$e($g(oOOqqq),1,510),^("er")=$e(o,1,510)
 i $l($g(oXoooooo))>3 d
 .s %="QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890",%=$tr(oXoooooo,%)
 .s %=$tr(oXoooooo,%,$e("                                                   ",1,$l(%)))
 .n %n,o f o=1:1:999 s %n=$p(%," ",o) i $l(%n),$e(%n)'="0",'%n,$d(@%n)#2 s ERRinTQM(%n)=$e(@%n,1,510)
 s:$zv["MiniM" ^mxMonito(+$g(ooooREAD),$g(%mxForma)_" ERROR")=o,ooooREAD=$g(ooooREAD)+1000
 s ERRinTQM=o,$ec="" g TQMe
 q
oTQMret(o) 
 q TQMA(o)
TQMA(%TQMreto) ; Return by %MaxRetu byte from the ^oTQMo(%USID,%mxForma) to MX-CLIENT
 n o,oo,yyROW,xxCOL,%yyROWnn,oozoozoQ,oozoozoq,%,%1,%2,%3,%2mapVar,oooTQMAo,%MaxRetu,%z
 s %z="^oTQMret(%USID,%mxForma)" s:$d(@%z)<9 %z="^oTQMo(%USID,%mxForma)" s %z=$name(@%z)
 s (%,%MxEXCEL)=$g(mxConfig("M=EXCEL",%mxForma)),%1=$p(%," "),%2mapVar=$p(%," ",2) s:"^?;*o.M"[$e(%2mapVar) %2mapVar=-9
 s %MaxRetu=27000,%unicode=0 s:$zv["U) " %unicode=16 s:$zv["MS" %MaxRetu=15000
 i %TQMreto<2 s o=$$TQM(1) q:$d(%mxWeb) $o(^oYX(%USID,%mxSheet,999999),-1)_%mxSheet_" $$TQM="_o  s @%z=.1 d
 . i $l($g(flagLANG))>1 s oFlgLANG=flagLANG k:flagLANG[2 ^omxDicti k:flagLANG'["*" flagLANG
 i $g(mxERROR)'="" s o="mxERROR "_$g(%mxForma)_" mxERROR="_mxERROR_"  gotoForm="_$g(gotoForm),%mxWarng("TQMA")=o k mxERROR
 i $g(mxMsgBox)'="" s o="mxERROR "_$g(%mxForma)_" mxMsgBox="_mxMsgBox
 q:'$g(@%z) ""  s $zt=""
 s %MaxRetu=27000,%unicode=0 s:$zv["U) " %unicode=16 s:$zv["MS" %MaxRetu=15000
 s yyROW=$g(@%z),oooTQMAo="",o=$c(4)_$c(5)
 f  s yyROW=$o(@%z@(yyROW)) q:yyROW=""  d  q:xxCOL<0
 . s xxCOL=0,(%,oo)="",%yyROWnn=yyROW\1
 . i '%2mapVar,1_$d(^(yyROW,1)) f  s %=$o(^(%)) q:'$l(%)  s @%2mapVar@(%yyROWnn,%)=$p(^(%),"<mx ")
 . s:yyROW["." %yyROWnn=%yyROWnn_"+"_+$e($p(yyROW,".",2)_"000000",1,6)
 . f  s xxCOL=$o(@%z@(yyROW,xxCOL)) d:xxCOL  q:xxCOL<1  i $e(oozoozoQ)="<",$p(oozoozoQ,"<mx ",2,9)["~~" q
 .. s oozoozoQ=^(xxCOL) i $e(oozoozoQ)="?","$ -"'[$e(oozoozoQ,2) s oozoozoQ=""
 .. i '$l(oozoozoQ),xxCOL>1 q
 .. i $l($g(oFlgLANG))>1,$l(oozoozoQ)>1,$l(oozoozoQ)<255 d  i $d(@%z@(yyROW,xxCOL))
 .. . s oozoozoq=$tr($p(oozoozoQ,"<mx")," 1234567890-+.,") q:'$l(oozoozoq)
 .. . s %=$g(^mxDictio($e(oFlgLANG,1,2),oozoozoq))
 .. . i $l(%) s oozoozoQ=%_$s(oozoozoQ=oozoozoq:"",1:$p(oozoozoQ,"<mx",2,9)) q
 .. . s:oFlgLANG[2 ^omxDicti($e(oFlgLANG,1,2),oozoozoq)=%B i oFlgLANG[3,$e(oozoozoQ)'="?" s oozoozoQ=oozoozoQ_"<mx ic19"
 .. i $l(oo)<10000 s oo=oo_o_%yyROWnn_","_xxCOL_","_$s(%unicode:$$U^MXF(.oozoozoQ),1:oozoozoQ),%yyROWnn=""
 .. else  s:$l(oo)<%MaxRetu oo=oo_o_","_xxCOL_","_$e($s(%unicode:$$U^MXF(.oozoozoQ),1:oozoozoQ),1,2000)
 . i $l(oooTQMAo)+$l(oo)>%MaxRetu d:'$l(oooTQMAo)  s xxCOL=-1,yyROW=yyROW-.00000001 q
 .. n oo,x,maxo f maxo=2000:-100:100,10 s x=0,oo=0 d  q:oo<%MaxRetu 
 ...  f  s x=$o(@%z@(yyROW,x)) q:'x  s:$l(^(x))>(maxo+3) ^(x)=$e(^(x),1,maxo)_"..~" s oo=oo+$l(^(x))+9 
 . s oooTQMAo=oooTQMAo_oo
 s @%z=yyROW
QTQMA q $g(oooTQMAo)
insLine(%n,%x) 
 q:$g(%om(1,%n))=@%n ""  k %om(1) s %om(1,%n)=@%n s:'$d(%x) %x="s @%n=@%n_""<mx _^ fb ic19.999 """ x %x
 i 1_$d(@z@(1)) n % s %=9999 f  s %=$o(^(%)) q:'$l(%)  i %'=%n s @%=""
 s z=z0 q @%n
InsVar6(oo) 
 n ooo,%flaG,%3ooo564,%n9,o q:oo["??" oo    ;; =$$trw^UST(oo,"??","<Q.W.E.S.T>")
 s ooo=$e($p(oo," ",1,6),2,999),oo=$p(oo," ",7,999)
 f %3ooo564=2:2:$l(ooo,"?") s %n9=$p(ooo,"?",%3ooo564) i $l(%n9),$e(%n9)'?1n,$p(ooo,"?",%3ooo564,99)["?" s:$l(%n9," ")>1 ooo=ooo_" "_$p(oo," ",1,$l(%n9)-1),oo=$p(oo," ",$l(%n9),999) d
 . s %n9=$s($tr(%n9,"^%qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890(""),")="":"s %n9=$g("_%n9_")",1:"n oo,ooo s %n9="_%n9) x %n9 s $p(ooo,"?",%3ooo564)=$tr(%n9," ?","__"),%flaG=1
 s:$d(%flaG) ooo=$tr(ooo,"?") k %flaG
 i $l(oo,"?")>2 f %3ooo564=2:2:$l(oo,"?") s %n9=$p(oo,"?",%3ooo564) i $l(%n9),$e(%n9)'?1n,$p(oo,"?",%3ooo564,99)["?" d
 . s %n9=$s($tr(%n9,"^%qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890(""),")="":"s %n9=$g("_%n9_")",1:"n oo,ooo s %n9="_%n9) x %n9 s $p(oo,"?",%3ooo564)=$tr(%n9,"?","_"),%flaG=1
 s:$d(%flaG) oo=$tr(oo,"?")
 s ooo="?"_ooo_" "_oo  ;; s:ooo["<Q.W.E.S.T>" ooo=$$trw^UST(ooo,"<Q.W.E.S.T>","?")
 q ooo
InsVar2(%oooot,%ooooh) 
 ; Insert value of xxxxx?var?xxxxx
 s %ooooh=$g(%ooooh,"?") q:%ooooh="" %oooot
 n %1ooo564,%2ooo564,%ooo564,%maXoo56
 i %oooot["??" q %oooot   ;; s %oooot=$$trw^UST(%oooot,"??","<Q.W.E.S.T>")
 s %maXoo56=$l(%oooot,%ooooh) s:%maXoo56#2=0 %maXoo56=%maXoo56-1 q:%maXoo56<3 %oooot
 s %oooot=%oooot_"ooxxooxxooxx"
 s %2ooo564="%qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890("")"
 f %1ooo564=2:2:$l(%oooot,%ooooh) s %ooo564=$p(%oooot,%ooooh,%1ooo564) i "%1%2"'[%ooo564 d
 . i '%ooo564,"""()0"'[$e(%ooo564),$l(%ooo564)<9!(%ooo564["("),$tr(%ooo564,%2ooo564)="",$e(%ooo564,2,99)'["%" d  q
 .. s $p(%oooot,%ooooh,%1ooo564)=$g(@%ooo564,0)
 . q:").,;*#!~`=<>"[$e(%ooo564)
 . ;; i %ooo564["<Q.W.E.S.T>" s %ooo564=$$trw^UST(%ooo564,"<Q.W.E.S.T>","?")
 . ;; i %ooo564["<S.P.A.C.E>" s %ooo564=$$trw^UST(%ooo564,"<S.P.A.C.E>"," ")
 . x "s %ooo564="_%ooo564
 . s $p(%oooot,%ooooh,%1ooo564)=$tr($tr(%ooo564,"?")," ")
 i %oooot'["?(",%oooot'[")?" q $tr($e(%oooot,1,$l(%oooot)-12),"?")
 f %1ooo564=2:2:$l(%oooot,%ooooh) s %ooo564=$p(%oooot,%ooooh,%1ooo564) i $e(%ooo564)="(",$e(%ooo564,$l(%ooo564))=")" d
 . i $e(%ooo564,2,99)'["%" d  q
 .. s $p(%oooot,%ooooh,%1ooo564)=$g(@%ooo564,0)
 . ;; i %ooo564["<Q.W.E.S.T>" s %ooo564=$$trw^UST(%ooo564,"<Q.W.E.S.T>","?")
 . x "s %ooo564="_%ooo564
 . s $p(%oooot,%ooooh,%1ooo564)=$tr($tr(%ooo564,"?")," ")
 q $tr($e(%oooot,1,$l(%oooot)-12),"?")
oRC(%q,%sheetNa,Y,X) 
 q $$oRC^MXTQM2(%q,%sheetNa,Y,X)
oYX123(%q,%sheetNa,%Y,%X,%mxRange) 
 q $$oYX123^MXTQM2(%q,%sheetNa,%Y,%X,$g(%mxRange))
oYX(%q,%sheetNa,%Y,%X,%mxRange) 
 q:$d(%mxRange) $$oYX^MXTQM2(%q,%sheetNa,%Y,%X,%mxRange)  q $$oYX^MXTQM2(%q,%sheetNa,%Y,%X)
%YXo(q,%sheetNa,Y,X) 
 k:$g(%YXo("S"))'=%sheetNa %YXo s %YXo("S",-1)=$g(%YXo("S")),%YXo("S")=%sheetNa,%YXo("Q")=q
 s %YXo(-3)=$g(%YXo(-2)),%YXo(-2)=$g(%YXo(-1)),%YXo(-1)=$g(%YXo(0)),%YXo(0)=Y_-X
 q q
autoFiYX(%sheetNa,%n) 
 n Y,X,y,x,o,%0,%mxForma s %mxForma=$p(%sheetNa,"--")
 s (Y,oYXy)=oYXy(%sheetNa),oYXx=oYXx(%sheetNa),X=0,%0=$$%0Yrc^MXTQM2(Y) q:'%0 0
 d
 . f X=oYXx:1:255 s o=$g(^oRC(%USID,%mxForma,%Yrc,X)) q:o_" "[("?_"_%n_" ")  i '$o(^(X)) s X=0 q
 . s:X=255 X=0 q:X  s Y=Y+1
 . f X=+oYXx:-1:0 s o=$g(^oRC(%USID,%mxForma,%Yrc,X)) q:o_" "[("?_"_%n_" ")
 q:X Y_-X  q "Y="_Y_"  X="_X_"  %n="_%n_"  oSheetYX="_%sheetNa_"  oYXx="_oYXx_"  oYXy="_oYXy
oRowRead(oSheetYX,%Y) 
 n %mxForma,%1,%Yrc,% s %mxForma=$p(oSheetYX,"--") s:'$g(%Y) %Y=$g(oYXy(oSheetYX)) 
 q:'$$%0Yrc^MXTQM2(%Y) 0  n %x,%n s %x=1
 f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $e(^(%x),1,2)="?_" s %n=$p($e(^(%x),3,99)," ") d
 . i $l(%n),'%n,%n'["*",%n'["%","o oo"'[%n s:$d(^oYX(%USID,oSheetYX,%Y,%x))#2 @%n=$p(^(%x),"<mx ") s:$d(^(%n))#2 @%n=$p(^(%n),"<mx ")
 q %Y
oRowShow(%Y) 
 n %mxForma,%1,%Yrc,% s %mxForma=$p(oSheetYX,"--") s:'$g(%Y) %Y=$g(oYXy(oSheetYX)) 
 q:'$$%0Yrc^MXTQM2(%Y) 0  n %x,%n s %x=0
 f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $e(^(%x),1,2)="?_" s %n=$p($e(^(%x),3,99)," ") d
 . i $l(%n),'%n,%n'["*",%n'["%",$d(@%n)#2 s ^oYX(%USID,oSheetYX,%Y,%x)=@%n i "o oo"'[%n s ^(%n)=@%n,%YX(%Y,%x)=@%n
 q %Y
oYXshowM(oSheetYX) 
 q $$oYXshowM^MXTQM2(oSheetYX)
newRC(%before,%SheetYX) 
 s %SheetYX=$g(%SheetYX,oSheetYX) q $$newRC(%before,%SheetYX)
r999999 f %=999:1:999999 k @%zTQMo@(%)
 s yyROW=-1 q
%YXnn(%node,%tAbleNr) 
 q $$%YXnn^MXTQM2(%node,%tAbleNr)
getObj(%zrO,%di,%000) 
 i $e(%zrO)'="^" q:'$l(%zrO) $g(%mxForma)_" error : getObj^MXTQM : not args(%zrO)"  s:1_$d(^(%zrO)) %zrO=$zr
 s %zr=$name(@%zrO),%objName=$p($e(%zr,2,999),"("),%objLeve=$ql(%zr),%objLeNa=%objLeve_%objName
 i $e(%objName,1,2)="om","omo om0 om1 om2 om3 om4"[%objName q $$getObjom(%zrO,$g(%di))  
 i $e(%objName,1,4)="||om","||om0 ||om1 ||om2 ||om3 ||om4"[%objName q $$getObjom(%zrO,$g(%di))  
 i '$d(mxObjooo(%objLeNa)) s mxObjooo(%objLeNa)="",%59=0 d  s:%59 mxObjooo(%objLeNa)=" "_mxObjooo(%objLeNa)
 . n %x,%1,% s %="%",%1="",%x=0 n:$g(%000)>10 %000
 . f  s %=$o(^mxObjooo(%objName,%objLeve,%)) q:'$l(%)  s %59=%59+1 i %'["%",%'="o",'%,$e(%)'?1n,$e(^(%))'="-" s mxObjooo(%objLeNa,%)="",%1=%1_","_%,%x=%x+1,%59=%59-1 q:%x>125
 . i $l(%1) s mxObjooo(%objLeNa)="s ("_$e(%1,2,99999)_")="""_$g(%000)_"""",%1="" 
 . q:'$l(%)  f  s %=$o(^mxObjooo(%objName,%objLeve,%)) q:'$l(%)  s %59=%59+1 i %'["%",%'="o",'%,$e(%)'?1n,$e(^(%))'="-" s mxObjooo(%objLeNa,%)="",%1=%1_","_%,%x=%x+1,%59=%59-1 q:%x>250
 . i $l(%1) s mxObjooo(%objLeNa)=mxObjooo(%objLeNa)_" s ("_$e(%1,2,99999)_")="""_$g(%000)_"""" 
 s %di=$g(%di),%diNextO=$s($e(%di):1,'%di:0,1:-1),%000=$g(%000)
getObjdi i %diNextO s %59=$o(@%zr,%diNextO) s:$l(%59) %zr=$name(^(%59)) i '$l(%59) d  q:'$l(%59) ""
 . s %=$s(%diNextO>0:$name(@%zr@($c(255)_$c(255))),1:%zr)
 . f  s %=$q(@%,%diNextO) q:'$l(%)  i $ql(%)-1=%objLeve,%zr'=$name(@%,%objLeve) s (%59,%zr)=$name(@%,%objLeve) q
 i %000=11,1_$d(@%zr@(1)) s %="%"_$c(255) x "f  s %=$o(^(%)) q:'$l(%)  s @%=$g(^(%))" q %zr  
 i $l(%di)>4,$l($o(@%zr@(9999))) d  q %zr
 . f %59=2:1:$l(%di," ") s %=$p(%di," ",%59),(%80,@%)=$g(^(%),%000) ;; d:%80=".!."
 ..  s %8o="" x "i $o(^(%,999999)) n i s i=999999 f  s i=$o(^(i)) q:'i  i %B_%8o_%B'[(%B_^(i)_%B) s %8o=$e(%8o_$s($l(%8o):%B,1:"""")_^(i),1,32000)" s @%=%8o i $d(@%zr@(%))  
 x mxObjooo(%objLeNa)
 s %="%"_$c(255) i $d(@%zr@(1))
 f  s %=$o(^(%)) q:'$l(%)  s:$d(mxObjooo(%objLeNa,%)) @%=$g(^(%)) i '$d(mxObjooo(%objLeNa,%)) d  i $d(@%zr@(%))
 . q:$e($g(^mxObjooo(%objName,%objLeve,%)))="-"  s ^(%)="-" q:%
 . q:$tr(%,"^$@~!*#()-+.,&<>_=?:;")'=%!($e(%)?1n)  s ^(%)="",@%=$g(@%zr@(%),%000) k mxObjooo(%objLeNa)
 i %di["%YX" s %="%"_$c(255) f  s %=$o(mxObjooo(%objLeNa,%)) q:'$l(%)  s %YX(%)=@%
 q %zr
getObjom(%zrO,%di) 
 n %i,%,%ii,%zr,%2,i,%qs12  s %zrO=$name(@%zrO),%=$ql(%zrO),%zr=$name(@%zrO@("%ii")),%qs12=$qs(%zr,1)_$qs(%zr,2),%2=$name(@%zr,2)
 i $g(%di) f  s %zr=$q(@%zr,+%di) q:'$l(%zr)  q:$ql(%zr)<(%+1)  q:$qs(%zr,%+1)="%ii"   
 q:'$l(%zr) ""  q:$qs(%zr,1)_$qs(%zr,2)'=%qs12 ""  s %zr=$name(@%zr,%)
 s %="%"_$c(255) f  s %=$o(%om(%2,%)) q:'$l(%)  s @%=""
 s %="%"_$c(255) i $d(@%zr@(%))
 f  s %=$o(^(%)) q:'$l(%)  s @%=^(%),%om(%2,%)="" i @%=".!." s %8o="" x "i $o(^(%,999999)) n i s i=999999 f  s i=$o(^(i)) q:'i  i %B_%8o_%B'[(%B_^(i)_%B) s %8o=$e(%8o_$s($l(%8o):%B,1:"""")_^(i),1,32000)" s @%=%8o i $d(@%zr@(%))  
 ;; f  s %=$o(@%zr@(%)) q:'$l(%)  s @%=@%zr@(%),%om(%2,%)="" i @%=".!." s %8o="" x "i $o(^(%,999999)) n i s i=999999 f  s i=$o(^(i)) q:'i  i %B_%8o_%B'[(%B_^(i)_%B) s %8o=$e(%8o_$s($l(%8o):%B,1:"""")_^(i),1,32000)" s @%=%8o i $d(@%zr@(%))  
 s %ii=$g(@%zr@("%ii")) i $l(%ii) f %=1:1:$l(%ii,",") s %i=$p(%ii,",",%),@%i=$qs(%zr,%+2) s:%B=@%i @%i=%B_"<mx ic15.99"
 q %zr
o2(%zr,i1,i2) 
 s:'$l(i1) i1=$o(@%zr@("")) s i2=$o(@%zr@(i1,i2)) 
 i '$l(i2) s i1=$o(@%zr@(i1)) s:$l(i1) i2=$o(@%zr@(i1,"")) 
 q:'$l(i1)!'$l(i2) "" q:$d(^(i2)) $zr
 q -1
Otkat(%o1,%zr) 
 s:'$d(%zr) %zr=$g(%zrOtkat)
 q $$Otkat^MXTQM2(%o1,%zr)
F9oo() q $$F9oo^MXTQM2()
RUN(%mxFormR) 
 ; Processed %mxForma 
 q $$RUN^MXTQM2(%mxFormR)
getJourn(%1,%2) 
 s:'$d(%1) %1="" s:'$d(%2) %2="%mxForma" n % s %=%1 
 i '%2 f  s %=$o(^mJournal(%),-1) q:'%  i %B_^(%,0)[(%B_%USID_%B),^(0)'["datums",'$p(^(0),%B,2) s %=$p(^(0),%B,2) q
 i %2=1 f  s %=$o(^mJournal(%),-1) q:'%  i %B_^(%,0)[(%B_%USID_%B),$p(^(0),%B,2)=$g(%mxForma) q
 q %
RestVars(%) 
 q 1

MXTQM2
MXTQM2   ;[ 20190127 21:31:45 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX-technology  ( Virtual Multi-channel EXCEL incorporated into the database )
 ; vmx Copyright(c) 2005-2018, SIA ENTERS, Latvia, Reg.Nr.42102022219
 ; registered by Agency INTELS, Riga, Latvia, reg.40003134156, on June 28, 2005, Nr.178
 ;
RUN(%mxFormR) ; Processed %mxFormF from %mxForma 
 i $g(%mxForma)=%mxFormR q "recursiv"
 i '$d(^oRC(%USID,%mxFormR)) s (o,%mxWarng("RUN^MXTQM2("_%mxFormR))="  -- not exists "_$name(^oRC(%USID,%mxFormR)) q o
 n %mxForma,%mxSheet,%YX,%mxWeb,o,%,%oRChange
 s (%mxForma,%mxSheet)=%mxFormR,%mxWeb=1 ;; k ^oTQMo(%USID,%mxForma)
 i $$TQM^MXTQM(1)
 q 1_%mxFormR_"-ok."
F9oo() 
 q:'$g(%YXx) ""  q:$g(%mxForma)="" ""  n %zr s %zr=$zr
 n oo,t,%,o s oo="" i $d(^ceChange(%USID,%mxForma,%YXx)) d
 . s t=%B_$d(^(%YXx,1)) f o=1:1:9999 s t=$o(^(t),-1) q:t=""  i $p(t,"r",2)=%YXy s oo=^(t) q 
 i $l(oo) s ^($h*1000000_"r"_%YXy)=oo q:1_$d(@%zr) oo
 s %="" f  s %=$o(^ceChange(%)) q:%=""  i $d(^ceChange(%,%mxForma,%YXx)) d
 . s t=%B_$d(^(%YXx,1)) f o=1:1:9999 s t=$o(^(t),-1) q:t=""  i $p(t,"r",2)=%YXy s oo=^(t) q 
 i $l(oo) s ^($h*1000000_"r"_%YXy)=oo
 q:1_$d(@%zr) $$U^MXF(oo)
%0Yrc(y) n %
 s %Yrc=$g(^oYX(%USID,%mxForma,+y,0)),%=$p(%Yrc,"-",2) i % s %Yrc=%Yrc-%+1 q +%
 s %=+$e($p(%Yrc,".",2)_"000000",1,6),%Yrc=%Yrc\1 q:% %+1  s %=+$e($p($g(^oYX(%USID,%mxForma,1+y,0)),".",2)_"000000",1,6)  
 q +%
%0Yvar(y,x) 
 i $$%0Yrc(y) 
 i $e($g(^oRC(%USID,%mxForma,+y,+x)),1,2)["?_" q $tr($p($g(^oRC(%USID,%mxForma,+y,+x))," "),"?_")
 q $tr($p($g(^oRC(%USID,%mxForma,+%Yrc,+x))," "),"?_")
oYXshowM(%mxSheet) 
 n %mxForma,%Yrco,%,%1,%2,%3,%y,%x,%0,%n,%nn,yxq s %mxForma=$p(%mxSheet,"--")
 s %=$g(mxConfig("M=EXCEL",%mxForma)) s:'$l(%) %=$g(^oRC(%USID,%mxForma,"?$$TQM",1))
 s %1=$p(%," "),%2=$p(%," ",2),%3=$p(%," ",3) s:$l($g(%E)) (%,%1,%2,%3)="" s:"o."[%2 %2="" s yxq="" s:$e(%1)'="^" %1=""
 f o=2:1:9 s %n=$p($tr(%3,"()",",,"),",",o) q:'$l(%n)  i $g(@%n)="" s %3="" q 
 s o=9999999 f  s o=$o(%YX(o)) q:'$l(o)   d:'o
 . s %=$g(^oRC(%USID,%mxForma,o)) s:'% %=$g(^oRC(%USID,%mxForma,"?var",o)) 
 . i % s %YX(+%,+$p(%,"-",2))=%YX(o) s:$p(%YX(o),"<mx ")'="." (^oYX(%USID,%mxSheet,+%,+$p(%,"-",2)),@o)=$p(%YX(o),"<mx ") k %YX(o) q
 . s %y=+$g(%YXy),%0=$$%0Yrc(%y) i '%0 k %YX(o) q
 . s %x=1 
 . f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  s %=$g(^(%x)) i $p($e(%,3,99)," ")=o s %YX(%y,%x)=%YX(o) s:$p(%YX(o),"<mx ")'="." (^oYX(%USID,%mxSheet,%y,o),^(%x))=$p(%YX(o),"<mx ") k %YX(o) q
 ;
 s %y=0 f  s %y=$o(%YX(%y)) q:'%y   s o=9999999 f  s o=$o(%YX(%y,o)) q:'$l(o)  d:'o
 .s %=$g(^oRC(%USID,%mxForma,o)) s:'% %=$g(^oRC(%USID,%mxForma,"?var",o)) i % s %YX(+%,+$p(%,"-",2))=%YX(%y,o) k %YX(%y,o) q
 .s %0=$$%0Yrc(%y) i '%0 k %YX(%y,o) q
 .s %x=1 
 .f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $p($e($g(^(%x)),3,99)," ")=o s %=$p(%YX(%y,o),"<mx ") s:%'="." (^oYX(%USID,%mxSheet,%y,o),^(%x))=% s %YX(%y,%x)=%YX(%y,o) k %YX(%y,o) q
 ;
 s %y=0 f  s %y=$o(%YX(%y)) q:'%y  i $l(yxq)<9999 s %x=0,%0=$$%0Yrc(%y) f  s %x=$o(%YX(%y,%x)) q:'%x  d
 . s (%n,%nn)=$g(^oRC(%USID,%mxForma,%Yrc,%x)) s:$e(%n)'="?" %n=""
 . s yxq=yxq_%y_";"_%x_";"_%YX(%y,%x)_$c(4),%=$p(%YX(%y,%x),"<mx ") i $l(%)>511,$zv["MS" s %=$e(%,1,511) 
 . k %YX(%y,%x) s %n=$p($e(%n,2,99)," ") s:$e(%n)="_" %n=$e(%n,2,99)
 .  q:".@$*"[$e(%n)!%n  q:" %q %n % %1 %2 o oo %Y %X %q %y %x "[(" "_%n_" ")  q:%="."  i $e(%n)'="%",$g(%YXy)=%y s @%n=%
 .  s (^oYX(%USID,%mxSheet,%y*''%0,%n),^oYX(%USID,%mxSheet,%y,%x))=% q:$p(%nn,";")["-"  
 .  i $e(%)'="?" s:$l(%1)&'%1 @%1@(%y,%x)=% s:$l(%2)&'%2 @%2@(%y,%x)=%
 .  q:'$l(%3)  i %3[%n q:","_$tr($p(%3,"(",2,9),")",",")[(","_%n_",")
 .  i '%0,123'[%2 s @%3@(%n)=% q
 .  i %0>0 s:123'[%2&$d(@%3@(%n,%0)) @%3@(%n,%0)=% s:%2>0&$d(@%3@(%n)) @%3@(%n)=%
 ;
 q $$U^MXF(yxq)
newRC(%before,%SheetYX) 
 n o,%yy,%xx,%n,%,%1,%2,%y,%33,%newVars,%mxForma s %newVars="%",%SheetYX=$g(%SheetYX,oSheetYX),%mxForma=$p(%SheetYX,"--")
 ;; s %=$g(mxConfig("M=EXCEL",%mxForma)),%33=$p(%," ",3),%3=$g(%3,%33)
 s %yy=0 f  s %yy=$o(^oRC(%USID,%mxForma,%yy)) q:'%yy  s %xx=0 d
 . f  s %xx=$o(^oRC(%USID,%mxForma,%yy,%xx)) q:'%xx  s %=$p($g(^(%xx))," ") i $e(%)="?" d
 .. s %n=$tr($e($p(%," "),2,99),"_?") q:".@$*0%"[$e(%n)  q:"ooo"[%n!%n
 .. s:" "_%before_" "'[(" "_%n_" ") %newVars=%newVars_","_%n
 q %newVars
Otkat(%o1,%zr) 
 s:'$d(%zr) %zr=$g(%zrOtkat)  q:$g(%E)'="" 0
 q:%zr'["^" "" n %,%i,o,h,%zt ;;f %=$ql(%zr):-1:1 s %i=$qs(%zr,%) i %i="" s %zr="" q
 s %zt=$zt,$zt="OtkatE^MXTQM2",%zr=$name(@%zr)
 q:$h*100000+$p($h,",",2)-2<$g(^bJournal(%USID,%zr)) ""
 i %o1="0" s ^bJournal(%USID,%zr)=$h*100000+$p($h,",",2),h=$$pD^MXD($h,2)
 i %o1="0",$d(@%zr) d  q:o "" m ^bJournal(%USID,%zr,h)=@%zr s o=1 f  s o=$o(^bJournal(%USID,%zr,o)) q:'o  i o+999<h k ^bJournal(%USID,%zr,o)
 . s o=$o(^bJournal(%USID,%zr,h),-1) q:'o 
 . i $l($$nodeComp^MXF($name(^bJournal(%USID,%zr,o)),%zr,1)) s o=0 
 . ;;f  s %z=$q(@%z) s:$l(%r) %r=$q(@%r) q:'$l(%r_%z)  s:'$l(%z)!'$l(%r) o=0 q:'o  i @%z'=@%r s o=0 q 
 n %1 s %1="{1042}{1077}{1088}{1085}{1091}{1090}{1100} {1074} {1089}{1086}{1089}{1090}{1086}{1103}{1085}{1080}{1077} {1085}{1072}"
 s %1=%1_" {1091}{1082}{1072}{1079}{1072}{1085}{1085}{1099}{1081} {1084}{1086}{1084}{1077}{1085}{1090} {1074}{1088}{1077}{1084}{1077}{1085}{1080}:"
 i %o1="s" k %SEL s o=0 f  s o=$o(^bJournal(%USID,%zr,o)) q:'$l(o)  s %SEL("R")="",%SEL(0)=%1,%SEL(o)=$$nodeComp^MXF($name(^bJournal(%USID,%zr,o)),%zr,200) d 
 . s %=0 f  s %=$o(%SEL(%)) q:%=o  i %SEL(%)=%SEL(o) k ^bJournal(%USID,%zr,%),%SEL(%) 
 . ;;
 . ;;f  s %z=$q(@%z) q:%z=""  s %r="%r"_$e(%z,3,99) i @%z'=$g(@%r) s %=$ql(%z),%SEL(o)=$e($g(%SEL(o))_"  "_%B_$qs(%z,%)_"="_@%z,1,250)
 i %o1 k @%zr m @%zr=^bJournal(%USID,%zr,%o1) s ^bJournal(%USID,%zr)=$h*100000+$p($h,",",2)
 q ""
OtkatE s $zt=$g(%zt) q ""
oRC(%q,%sheetNa,Y,X) 
 n %0,%,%oldCell,oCeValue,%qoo s oCeValue=%q,%qoo=11 i $l(%q)>1 s %qoo=$e(%q,$l(%q)-1,$l(%q))
 i %qoo=".." s %qSearch=$p(%q,"..") i $l(%qSearch) s %YXy=Y,%YXx=X,%qSelect=%q,%ySearch=Y,%xSearch=X,%YX("qSearch")=%q q %q
 i $d(^oYXselec(%USID,%sheetNa,Y,X)) s %oldCell=^(X) 
 k oRCerr,gotoYXyy,gotoYXxx s %YXsheet=%sheetNa n %mxSheet,%mxForma s %mxSheet=%sheetNa,%mxForma=$p(%mxSheet,"--")
 ;; n $et s $et="s %E=$ze_$c(10)_$g(%in),$ec="""" "
 n %in,%y,%x,%nn,%nALoooo,%N,%nNext,gotoName,%shin,%Xcomm,%E,o,%2,%3,%3flag s %shin=$p(%sheetNa,"--")
 s (%0,%nn,%tabRow)=$$%0Yrc(Y) s:$e($g(^oRC(%USID,%mxForma,Y,X)),1,2)["?_" %Yrc=Y
 s %in=$g(^oRC(%USID,%mxForma,%Yrc,X))
 i $e(%in,1,3)="?_*" f %=+X:-1:2 i $e($g(^(%)),1,2)="?_",$e(^(%),1,3)'["*" s %in=^(%) q
 q:'%0 "" i %q'="---" q:$e(%in,1,2)'="?_" ""    ;; only for %0>0 (mx-tabel)
 f %=X+11:-1:0 i $e($g(^(%)),1,2)="?_",$p(^(%)," ; ")["[" q
 q:'% ""
 i %q="-",$e(%in,1,2)'="?_"!($e(%in,1,10)="?_%mxIndex"),$g(^oRC(%USID,%mxForma,%Yrc,X+1))["?_" d  q ""
 . s o=$p(%in,";-;",2,99) i $l(o)>3 s %YX(Y,X)="<mx <$$B 30 12 o[--- . 5/2 "_o_"  s %YX("_+Y_","_+X_")="".<mx ic46.99"" ; %YX /$$B> ic19.99",gotoYXxx=X-1 q
 . s %YX(Y,X)="<mx <$$B 30 12 o[--- . 1/2 k %E s o=$$oRC^MXTQM2(""---"","""_%sheetNa_""","_Y_","_(X+1)_") ; %YX /$$B> ic19.99",gotoYXxx=X-1
 i %q'="---" q:$e(%in,1,10)="?_%mxIndex" ""
 s:";;.."'[%qoo ^oYX(%USID,%mxSheet,Y,X)=%q s gotoYXyy=Y,gotoYXxx=X+1,oRCyyyyy=Y,oRCxxxxx=X
 ;; %Yrc ;;  i %in[";_",%0<Y f %=+Y:-1:+%0 i $e($g(^oRC(%USID,%mxForma,%,X)),1,2)="?_" s %in=^(X) q
 ;; i $e(%in,1,3)="?_*" f %x=+X:-1:2 i $e($g(^(%x)),1,2)="?_",$e(^(%x),1,3)'["*" s %in=^(%x) q
 s (%command,%Xcomm)=$p(%in,";;;",2,9),(%n,%N,%nALoooo)=$p($e(%in,3,99)," "),oRCerr=Y_-X_" "_%nALoooo_" "_%Xcomm
 i " o %1 %2 Y X y x %y %x "[%n s (%n,%nALoooo)=%n_"o1o2o3" n @%n s @%n=""  ;; =$g(@%n)
 i %q="" s %=0 i $p(%in,";")'[" [",$g(%YXy(-1))-Y f %=X-1:-1:2,-99.65 q:$l($g(^oYX(%USID,%mxSheet,Y,%)))
 i %q="",%<0 q ""
 i %q="",$p(%in,";")["^",Y>1 s %q=$p($g(^oYX(%USID,%mxSheet,Y-1,X)),"<mx ") i $p(%in,";")["^+1" d  s:% %q=%q+1
 . f %=X-1:-1:2 i $g(^oYX(%USID,%mxSheet,Y-1,%))'=$g(^oYX(%USID,%mxSheet,Y,%)) s %q=1,%=0 q
 i %qoo=";;",%Xcomm'["%SEL",$l($g(%FILE)),$d(^AL(%FILE)) d  q:$d(%SEL) "%SEL:%E:"_%q
 . n %K,%G,%N,% s %K=%q,%N=%nALoooo,%G(%N)="" k %SEL
 . s o=$$mxFsel^USF(%FILE,%nALoooo,%q,1) m:'$d(%SEL) %SEL=^ose(%USID)
 i %qoo=";;",%Xcomm'["%SEL",%Xcomm'["%SEL" d  q:$d(%SEL) "%SEL:%E:"_%q
 . n %N s %N=%nALoooo,%=$g(ALanalog(%N))
 . i $l(%) s %N=$p(%,"^"),%=$p(%,"^",2) s:$l(%) %FILE=% d  q:$d(%SEL)
 .. n %K,%G,% s %K=%q,%G(%N)="" k %SEL
 .. s o=$$mxFsel^USF(%FILE,%N,%q,1) m:'$d(%SEL) %SEL=^ose(%USID) 
 . s %="" f  s %=$o(^AL(%)) q:%=""  i $d(@("^"_%)),$g(^AL(%,"%W",%nALoooo,-2))["$$" d  q:$d(%SEL)
 .. n %K,%FILE,%G s %FILE=%,%K=%q,%G(%N)="" k %SEL n %
 .. s o=$$mxFsel^USF(%FILE,%N,%q,1) m:'$d(%SEL) %SEL=^ose(%USID) 
 i %q'["---",%Xcomm["%SEL" x "n %1,%2,%3,%0,o,%N,%K s (%K,o)=%q,%E="""",%N=%nALoooo "_%Xcomm i %E'="",$e(%E,1,4)'="%SEL" s @%nALoooo=$g(%oldCell) q %E_" -- not found --:%E:"_%q
 i %Xcomm["%SEL" q:$d(%SEL) "%SEL:%E:"_%q 
 s:%q="--"!(%q="__") %Xcomm="",%q="--"
 i %q="--" s gotoYXyy=0,gotoYXxx=0,%1=1,%YX(Y,X)="" d  q:gotoYXyy ":%E:"_%q  s %1=0 d  q ":%E:"_%q
 . n %0,%Yrc i %1 f %1=%YXy+1:1 s %0=$$%0Yrc(%1) i '%0 s %1=%Yrc-.2 q
 . f  s %1=$o(^oRC(%USID,%mxForma,%1)) q:'%1  s %2=1 f  s %2=$o(^oRC(%USID,%mxForma,%1,%2)) q:'%2  d
 .. s %=^(%2) q:$e(%)'="?"  q:".^*$ "[$e(%,2)
 .. i %[" ;;; " s gotoYXyy=%1,gotoYXxx=%2,%2="e",%1="e"
 i %q="~",%Xcomm'["~" s gotoYXyy=Y_"]",%Xcomm="",%=$o(^oYX(%USID,%mxSheet,Y,X,""),-1) i %,^(%)'="~" s %YX(Y,X)="~"_^(%)_"<mx ic9.99" x $g(^oRC(%USID,%mxForma,%Yrc,"~"))
 s %nn=%0,%rowEmpty='$l(%q) i %q'="---","..;;"'[%qoo s @%nALoooo=%q
 s %=$g(mxConfig("M=EXCEL",%shin)),%2=$p(%," ",2),%3=$p(%," ",3),%1=$p(%," ") s:$l($g(%E)) (%,%1,%2,%3)="" s:"o."[%2 %2=-9
 i $l(%3),%q'["---" s o=$tr(%3,"()",",,") f %=2:1 s %x=$p(o,",",%) q:'$l(%x)  s:%x=%nALoooo!'$l($g(@%x))!(";;.."[%qoo) %3=""
 i %q["---",%Xcomm'["=""---""",$l(%3) s (%command,%Xcomm)=""
 i $g(%YXy(-1))-Y,%q'["---",'$l(%3)!%2 s %x=1 f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i %x-X s %=$g(^(%x)) i $e(%,1,2)="?_" s %=$e($p(%," "),3,99) d
 . q:"   %nn %mxIndex Y X %y %x o oo * ^ "[(" "_%_" ")  q:%=%nALoooo
 . s:$d(^oYX(%USID,%mxSheet,Y,%x))#2 @%=$p(^(%x),"<mx ") s:$d(^(%))#2 @%=$p(^(%),"<mx ") s:$l(@%) %rowEmpty=0 
 . i "123"'[%2 i %q="~",%Xcomm'["~" s (@%@(%0),^oYX(%USID,%mxSheet,Y,%x),@%)="~"_@%  ;; -oRC()
 k oo i ";;.."[%qoo,%Xcomm'[%qoo q:%Xcomm="" "" q %q
 s %E="" i %q="----" s %in="]"_%in,%Xcomm=""
 ;
 i %q'["---",$l(%Xcomm)>2,'%Xcomm x "n %1,%2,%3,%0,o,%N,%q,%K s (%K,o)=$g(@%nALoooo),%E="""",%N=%nALoooo "_%Xcomm i %E'="",$e(%E,1,4)'="%SEL" s @%nALoooo=$g(%oldCell)
 ;
 s:%tabRow (%nn,%0)=+%tabRow s Y=oRCyyyyy,X=oRCxxxxx  ;; -oRC()
 i $d(oo) s %YX(Y,X)=oo i ";;.."[%qoo,$l(oo)>1,";;.."[$e(oo,$l(oo)-1,$l(oo)) q oo 
 q:%nALoooo["o1o2o3"!($e(%E,1,4)="%SEL") $g(%E)_":%E:"_$g(@%nALoooo)
 i %q'["---","..;;"'[%qoo s ^oYX(%USID,%mxSheet,Y,X)=%q s:"o oo"'[%nALoooo ^(%nALoooo)=%q
 i $l(%1),"M"'=%1,"o oo"'[%1,'%1 s @%1@(Y,X)=$p(@%nALoooo,"<mx ")
 i 123'[%2 s:'%2 @%2@(Y,X)=$p(@%nALoooo,"<mx ") s:000 @%n@(%0)=$p(@%nALoooo,"<mx ")  ;; -oRC()
 i %q="---" n %nx,%n,%x,%mxI s %x=1,%mxI="" d  q ":%E:---"
 .f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  s %nx=$g(^(%x)) i $e(%nx,1,2)="?_" d  q:$p(%nx,";")["]"
 .. s %n=$e($p(%nx," "),3,99) s:%n["%mxIndex" %mxI=%nx q:"   %nn Y X %y %x o %nx %n * . $ "[(" "_%n_" ")
 .. s @%n=$g(^oYX(%USID,%mxSheet,Y,%n)) i $l(%mxI) x $p(%mxI,";;;",2,99) i %mxI[";-;" s $p(mxI,";-;")=""
 .. i $p(%nx,";")["]" x "n %1,%2,%3,%x,%y,%nx "_$p(%mxI,";-;",2) i %2>0 k:$l(%3) @%3
 .. i %x'<X s %YX(Y,%x)=".<mx ic3" k:$l(%3) @%3@(%n,%0)  ;; -oYX()
 i $l($g(gotoName)) s autoFill="",gotoYXyy=oRCyyyyy,%x=1 d
 . f  s %x=$o(^oRC(%USID,%mxForma,%Yrc,%x)) q:'%x  i $tr($p(^(%x)," "),"?_")=gotoName s gotoYXxx=-%x q
 i $p(%in,";")_gotoYXyy["]" s:$g(gotoYXxx)'<0 gotoYXyy=gotoYXyy+1,gotoYXxx=2 i $l(%3)!111,%q'="---" d:%0
 . n %n f %x=+X:-1:2 s o=$g(^oRC(%USID,%mxForma,%Yrc,%x)) i $e(o,1,2)="?_" d  i $p(o,";")["[" s:$g(gotoYXxx)'<0 gotoYXxx=%x q
 .. q:$p(o,";")[" -"  s %n=$e($p(o," "),3,99) q:"0oo..;?"[%n!%n   
 .. i %sheetNa'[%mxForma n %mxForma s %mxForma=$p(%sheetNa,"--")
 .. ;; i $d(%mxInput(%mxForma)) s %3=$name(@%3) s:%mxInput(%mxForma)=%n %mxInput(%mxForma)=%3 i %mxInput(%mxForma)'=%3 s %E=$g(%E)_"___  access denied "_%3 q
 .. i $l(%3) s:123'[%2 @%3@(%n,%0)=$p($g(@%n),"<mx ") s:%2>0 @%3@(%n)=$p($g(@%n),"<mx ")
 i gotoYXxx>-2,$p(%in,";")'["]",%q'="~"!(%Xcomm["~"),%q'="---" d:$g(^oRC(%USID,%mxForma,%Yrc,1))["_"
 . i gotoYXxx>-1 s %x=X f  s %x=$o(^(%x)) q:'%x  i $e(^(%x),1,2)="?_" s gotoYXxx=%x q
 . i gotoYXxx=-1 s %x=1 f  s %x=$o(^(%x)) q:'%x  s %=$p(^(%x),";") i $e(%,1,2)="?_",%[" [" s gotoYXxx=%x q
 s:gotoYXxx<0 gotoYXxx=-gotoYXxx s:gotoYXyy<0 gotoYXyy=-gotoYXyy 
 q:%nALoooo["o1o2o3" $g(%E)_":%E:"_@%nALoooo
 s %=$p(@%nALoooo,"<mx ")
 s:"o oo"'[%nALoooo (^oYX(%USID,%mxSheet,%nALoooo),^(%nALoooo,%nn),^oYX(%USID,%mxSheet,Y,X),^(%nALoooo),^oYX(%USID,%mxSheet,0,%nALoooo))=%
 s:"o oo"[%nALoooo ^oYX(%USID,%mxSheet,Y,X)=%
 ;; s oRC(Y,X)=%in,(oYX(Y,X),oYX(%nALoooo),oYX(%nALoooo,%nn))=% ;; -oRC()
 i $l($g(%E)) s %E=%E_" :%N="_%nALoooo
 q $$U^MXF($g(%E)_":%E:"_@%nALoooo)
oYX123(%q,%sheetNa,%Y,%X,%mxRange) 
 q:$g(%E)'="" 0 n %mxSheet,%mxForma s %mxSheet=%sheetNa,%mxForma=$p(%mxSheet,"--")  n %qMSM i %q["..",$e(%q,$l(%q)-1,99)=".." q ".."
 s %qMSM=$p(%q,"<mx ") i $zv["MS" s:$l(%qMSM)>511 %qMSM=$e(%qMSM,1,511)
 s ^oYX(%USID,%mxSheet,%Y,%X)=%qMSM,oYX(%Y,%X)=%q
 n %,%n,%1,%2,%3 s %=$g(mxConfig("M=EXCEL",%mxForma)),%1=$p(%," "),%2=$p(%," ",2),%3=$p(%," ",3) s:$l($g(%E)) (%,%1,%2,%3)="" s:"o."[%2 %2=-9
 i '%2,$e(%qMSM)'="?" s @%2@(%Y,%X)=%qMSM
 i $l(%1),"M"'=%1,"o"'=%1,'%1 s @%1@(%Y,%X)=%qMSM 
 q:'$l(%3) %1_" "_%2
 s %0=$$%0Yrc(%Y),%=$g(^oRC(%USID,%mxForma,%Yrc,%X))
 s:$p(%,";")["-" %3="" s %=$p(%," ")
 i $e(%)="?",$l(%3) s %n=$tr($p(%," "),"_?") i "@$.*0"'[$e(%n),'%n d
 .  q:" %q %n % %1 %2 o oo %Y %X %q "[(" "_%n_" ")
 .  i %3[%n,","_$tr($p(%3,"(",2,9),")",",")[(","_%n_",") s @%n=%q q
 .  ;;i $p(%sheetNa,"--")'=%mxForma n %mxForma s %mxForma=$p(%sheetNa,"--")
 .  i $d(%mxInput(%mxSheet)) d  i %mxInput(%mxSheet)'=%3 q
 ..  s %3=$name(@%3) s:%mxInput(%mxSheet)=%n %mxInput(%mxSheet)=%3 i %mxInput(%mxSheet)'=%3 s:%'["_" %mxInput(%mxSheet,%3,%n)=%q q
 .  n %1 s %1=999 f  s %1=$o(%mxInput(%mxSheet,%3,%1)) q:%1=""  s @%3@(%1)=%mxInput(%mxSheet,%3,%1) k %mxInput(%mxSheet,%3,%1)
 .  s:%["_" ^oYX(%USID,%mxSheet,%Y,%n)=%qMSM s:%'["_" ^oYX(%USID,%mxSheet,0,%n)=%qMSM
 .  i %'["_" q:%2>0  s %=$g(@%3@(%n)),^oldGlobs(%USID,%mxSheet,%n)=$zr_"="_%,@%3@(%n)=%qMSM q
 .  i %0 s:123'[%2 @%3@(%n,%0)=%qMSM s:%2>0 @%3@(%n)=%qMSM 
 q:$zv'["U) " "1="_%1_" 2="_%2_" 3="_%3_" (%0,%tabRow)="_%0_" mComm="_%_" $zr="_$zr
 q $$U^MXF("1="_%1_" 2="_%2_" 3="_%3_" (%0,%tabRow)="_%0_" mComm="_%_" $zr="_$zr)
oYX(%q,%sheetNa,%Y,%X,%mxRange) 
 ; select or change 
 s %mxSheet=%sheetNa i %q["..",$e(%q,$l(%q)-1,99)=".." q ".."
 i %Y>0,1_$$%YXo^MXTQM(%q,%sheetNa,%Y,%X) s oYXy=%Y,oYXx=%X,oYXy(%sheetNa)=%Y,oYXx(%sheetNa)=%X,oYXq=%q
 n %qMSM,%,%123,%1,%2,%3,%0,%n,%nn,%nFormul,%11
 s oSheetYX(-1)=$g(oSheetYX),oSheetYX=$p(%sheetNa,"--"),%qMSM=$p(%q,"<mx ") q:'%Y
 i %Y>0,%Y-$g(%YXy)!(%X-$g(%YXx)) d  s oYXy=%Y,oYXx=%X,oYXy(%sheetNa)=%Y,oYXx(%sheetNa)=%X,oYXq=%q
 . s:'$g(%YXy) %YXy=%Y s:'$g(%YXx) %YXx=%X
 . s %YXy(-2)=$g(%YXy(-1)),%YXy(-1)=$g(%YXy),%YXx(-1)=$g(%YXx),%YXx(-1)=$g(%YXx),%YXy=%Y,%YXx=%X,%YXq(-2)=$g(%YXq(-1)),%YXq(-1)=$g(%YXq),%YXq=%q
 . s oYXy(-2)=$g(oYXy(-1)),oYXy(-1)=$g(oYXy),oYXx(-1)=$g(oYXx),oYXq(-2)=$g(oYXq(-1)),oYXq(-1)=$g(oYXq)
 i $zv["MS" s:$l(%qMSM)>511 %qMSM=$e(%qMSM,1,511)
 s %123=$g(mxConfig("M=EXCEL",oSheetYX)),%1=$p(%123," ",1),%2=$p(%123," ",2),%3=$p(%123," ",3) s:$l($g(%E)) (%123,%1,%2,%3)="" s:"o."[%2 %2=-9
 i %Y>0 s (%tabRow,%0)=$$%0Yrc(%Y),%n=$g(^oRC(%USID,%mxForma,%Yrc,%X)) s:$e(%n)'="?"!("$. ?%1234567890^-=*@!+"[$e(%n,2)) %n="" s %nFormul=%n,%n=$tr($p(%n," "),"?_")
 i %Y<0 s ^oYX(%USID,%mxSheet,-%Y,%X)=%qMSM s:$l(%1)&("oM"'[%1)&'%1 @%1@(-%Y,%X)=%qMSM q "" 
 s ^oYX(%USID,%mxSheet,%Y,%X)=%qMSM i $l(%n),"o oo"'[%n s ^(%n)=%qMSM s:'%0 ^oYX(%USID,%mxSheet,0,%n)=%qMSM
 s %11=$o(^oYX(%USID,%mxSheet,%Y,%X,""),-1) s:'%11 ^($h*100000+$p($h,",",2))=%qMSM i %11>0,%q'=^(%11),"~ -- _ __"'[%q s ^($h*100000+$p($h,",",2))=%qMSM
 s:$e(%1)'="^" %1="" s:$l(%1) @%1@(oYXy,oYXx)=%qMSM
 i '%2,$e(%qMSM)'="?",$p(%nFormul,";")_" "'[" - " s @%2@(%Y,%X)=%qMSM
 s o="" f %nn="%YXy","%YXx","%YXq" s o=o_%nn_0_"="_$g(@%nn)_$c(4) f %=1,2 s o=o_%nn_%_"="_$g(@%nn@(-%))_$c(4)
 s %0=+%tabRow
 q:'$l(%n) o_$c(4)_" %mxFormula="_%nFormul   s:$p(%nFormul,";")_" "[" - " %3="" s %=$p(%nFormul," ")  q:'$l(%) o_$c(4)_" %mxFormula="_%nFormul  
 i $d(^oRC(%USID,%mxForma)) s o=o_" oRC0="_$p($e(%nFormul,1,25)," ")_$c(4) i $g(%YXy(-1)),$g(%YXx(-1)) d
 . n %0,% s %0=$$%0Yrc(%YXy(-1)),%=$p($g(^oRC(%USID,%mxForma,%Yrc,%YXx(-1)))," "),o=o_" oRC1="_$p($e(%,1,25)," ")
 i $l(%3) i "@$.*0"'[$e(%n),'%n d
 .  q:" %q %n % %1 %2 o oo %Y %X %q "[(" "_%n_" ")
 .  i %3[%n,","_$tr($p(%3,"(",2,9),")",",")[(","_%n_",") s @%n=%q q
 .  q:%0  q:%2>0  q:$p(%nFormul," ")["_"  q:$g(@%3@(%n))=%qMSM
 .  ;;i %sheetNa'[%mxForma n %mxForma s %mxForma=$p(%mxSheet,"--")
 .  i '$d(%mxInput(%mxSheet)) s %=$g(@%3@(%n)),^oldGlobs(%USID,%mxSheet,%n)=$zr_"="_%,@%3@(%n)=%qMSM q
 .  s %3=$name(@%3) s:%mxInput(%mxSheet)=%n %mxInput(%mxSheet)=%3 i %mxInput(%mxSheet)'=%3 s o=o_" input denied -->> "_$g(@%3@(%n))_" <<-- "_%q_$c(4),%mxInput(%mxSheet,%3,%n)=%q q
 .  i $d(%mxInput(%mxSheet,%3)) s %=99 f  s %=$o(%mxInput(%mxSheet,%3,%)) q:%=""  s @%3@(%)=%mxInput(%mxSheet,%3,%) k %mxInput(%mxSheet,%3,%)
 .  s %=$g(@%3@(%n)),^oldGlobs(%USID,%mxSheet,%n)=$zr_"="_%,@%3@(%n)=%qMSM
 q:'$d(%mxRange) o_$c(4)_" %mxFormula="_%nFormul 
 q:%mxRange=%q!'$l(%1_%2) o_$c(4)_" %mxFormula="_%nFormul 
 q:o[" %E={1085}{1077}{1090} {1088}{1072}{1079}{1088}{1077}{1096}{1077}{1085}{1080}{1103} {1085}{1072} {1074}{1074}{1086}{1076} / access denied "_$c(4) o_$c(4)_" %mxFormula="_%nFormul
 n %y0,%y,%x0,%x,%z s %y0=%mxRange,%x0=$p(%mxRange,"x",2),%z=1
 q:'%x0 o_$c(4)_" %mxFormula="_%nFormul  q:$p(%y0,"+",2)<1 o_$c(4)_" %mxFormula="_%nFormul  q:$p(%x0,"+",2)<1 o_$c(4)_" %mxFormula="_%nFormul
 f %y=+%y0:1:%y0+$p(%y0,"+",2)-1 f %x=+%x0:1:%x0+$p(%x0,"+",2)-1 s %z=%z+1 d
 . s:'%2 @%2@(+%y,+%x)=$p(%mxRange,$c(4),%z)
 q:$zv'["U) " o_$c(4)_" %mxFormula="_%nFormul q $$U^MXF(o_$c(4)_" %mxFormula="_%nFormul)
InseRows(%mxFormA,%1,%InsRows) 
 s %mxFormA=$g(%mxFormA,%mxForma),%1=$g(%1,%yChange),%InsRows=$g(%InsRows,1)
 n %,o,%zr q:$g(^oRC(%USID,%mxFormA,%yChange,1))'["_" 0
 f %=%1:-1:1 q:$g(^oRC(%USID,%mxFormA,%,1))'["_"
 s o="",%=1 f  s %=$o(^(%)) q:'%  s o=o_$g(^(%))
 q:o["%tabRow"!(o["""+""") 0
 f %=%xChange+1:1:99,0 i $g(^(%))["?_",$p(^(%),";")[" [" q
 q:'% 0 k ^oYX(%USID,%mxSheet,%yChange,%xChange)
 f %=%1:1 i '$$%0Yrc(%) s %=%-1 q
 f o=%:-1:%1+1 k ^oYX(%USID,%mxSheet,%) m ^oYX(%USID,%mxSheet,%)=^oYX(%USID,%mxSheet,%-1)
 k ^oYX(%USID,%mxSheet,%1)
 q $$U^MXF(o)
eqvTree2(z1,z2) 
 n %1,%2,%
 s %1=0 f  s %1=$o(@z1@(%1)) q:'%1  s %2=0 f  s %2=$o(@z1@(%1,%2)) q:'%2  s %=$p($g(^(%2)),"<mx ") i $p($p($g(@z2@(%1,%2)),"<mx "),"?")'=% s %2=-1_" "_%1_-%2_"  "_%_" ::: "_$g(@z2@(%1,%2)),%1=" "_%1 q
 q:%2<0 %2  q 0

QQ
QQ ; ;[ 20191122 21:43:31 ]
 ; MSM, CACHE, IRIS, GT.M, MiniM
 ; VMX  Copyright(c) SIA ENTERS  2005-2019
0 s %j=0,%B=$c(254) ;;  D E0^USb,^USDOS
1(%USID) ; start        MX_FORMA_xxx.XLSmb#sheets("1_")
 ;; x:$zv'["GT.M"&($zv'["MiniM") "B 1"
 K (%j,%USID,%unicode,%unicodx,%LANG,%mxWeb,ECB90) s (%,%USID)=$g(%USID,"xxx")
 k ^MsgVM(%),^MsgMV(%),^MsgMVM(%),^MsgVMV(%),^MVinfo(%),^rM(%),^mxM(%),^US($j),^oMX(%),^ooMX(%),^JOB(%)
 s ^JOB(%USID)=$j,^JOB(%USID,$j)=$h,%B=$c(254),%j=$g(%j)
 i $$NewDate^MXD()
start ;; q:$d(flgPlusM)
 s %1="Firma" d ^USX i $g(%XG(%1))'="",$$icFIRMA^fir()
 s %VaL=$s('$g(%gm):"EUR",%gm<201400:"LVL",1:$g(%VaL,"EUR")),xVAL=$s($l($g(xVAL))=3:xVAL,1:%VaL)
 s %B=$c(254),mxConfig="" k koko,%koko d %lat^fin i '$d(^mxConfig) q:'$d(^koko)!'$d(^konti)
 s (xC,xDOK,xf,xv,xCe,xCh,xT,xO,xmsm,xatb,xInv)=""
 s vbak=$g(^oVVVo(%USID)) i $g(%gm)'?6n,$$NewDate^MXD()
 i $l($g(%CvRee))>3 q:$g(mxConfig)[":CURRENCY="
 n oo,o,% s oo=":CURRENCY=LVL:",o="",d8KoFiDo=0
 i %gm>201400 s d8KoFiDo=20131231,oo=":CURRENCY=EUR:" i '$d(^VAL("Ls",20140101,"-")) s @$zr=%B_+$j(1/.702804,0,7)_%B_.702804
 f  s o=$o(^VAL(o)) q:'$l(o)  s:o?3A oo=oo_o_":"
 s $p(mxConfig,%B,15)=oo
 f o=1:1:9 s $p(mxConfig,%B,o)=$p($g(^mxConfig(1,"mxConfig",o,1)),%B,2)
 i mxConfig["NOz5" s flagNOz5=-1 k ^z5
 s $p(mxConfig,%B,10)=$g(^SetATG("mxConfig"))
 i $d(^SetATG("fir : firma")) s $p(mxConfig,%B,11)=":fir : firma:"
 ;; i $d(^SetATG("d8min")) s $p(mxConfig,%B,12)=":d8min="_+^("d8min")
 s %="",%CvRee="*" f  s %=$o(^konti(%)) q:%=""  d
 . s o=$p(^konti(%),%B,4) i $l(o)>2,$d(^VAL(o)),o'[%VaL s %CvRee=%CvRee_-%_o ;;,%CvRee(%)=o
 f %="VIDkods","kas1" i $d(^mxConfig(1,"firma",%,1)) s @%=$p(^(1),%B,2)
 s kokoKorr=$d(^kokoKorr)
 q
GetUser() ; http://www.georgejames.com/ws/HandT010.htm
 q ""
k q
C 
c ; clear all !!  for localhost only 
 k ^M,^US,^ParVM,^MsgVM,^MsgMV,^MsgMVM,^MsgVMV,^rm,^UTILITY
 k ^Err,^Er,^ERROR,^mvars,^mxM,^r,^rr,^rrr
 k ^menu,^ReSheet,^ReadSh
 i $zv'["Ca",$zv'["MiniM",$zv'["IRIS" d
 .s %g="^" f  s %g=$o(@%g) q:%g=""  s %g="^"_%g i %g["^o" k @%g
 i $zv["Ca"!($zv["IRIS") d
 .n gd x "d GetDir^%GD($zu(5),""gd"")"
 .s %g="" f  s %g=$o(gd(%g)) q:'$l(%g)  i %g["^o",%g'["^odd" k @%g
 .s %g="" f  s %g=$o(gd(%g)) q:'$l(%g)  i %g["^us" k @%g
 s zr="^AL" f  s zr=$q(@zr) q:zr=""  d
 .  k:$tr($qs(zr,1)," :`~!@#$%^&*()_+=,.:""/?,","************************")["*" @zr  k:$qs(zr,1) @zr
 .  k:".0-^"[$e($qs(zr,1)) @zr k:$$Uu^MXF("1.{1055}{1048}{1043}")[$e($qs(zr,2)_0) @zr k:$$Uu^MXF(".{1055}{1048}{1043}")[$e($qs(zr,3)_1) @zr
 .  k:$qs(zr,4)>80 @zr  k:$qs(zr,2)="T" @zr k:$qs(zr,2)="GL" @zr k:$qs(zr,2)="G" @zr
 .  k:$qs(zr,4)="%Gf" @zr  k:$qs(zr,2)="%FUN" @zr k:$qs(zr,2)="%Tf" @zr
 q
 q

US
US ;    ; [ 11/04/2006  5:40 PM ]  ;[ 20190328 10:20:30 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx  Copyright(c) SIA ENTERS  1997-2019
 g enter^USb
yx(y,x,c) 
 q ""
PN w $$n(@%1,%1) q
PN0 w $$n(%K,%N) q
n(%k,%N,%) 
 n %1 s %N=$tr($g(%N),"~")
 I %N="" s %N=$tr($p(%LI(%FILE),",",%G),"~")
 s (%k,@%N)=$g(%k,%K)
 s %1=$l($p(","_$tr(%LI(%FILE),"~")_",",","_%N_","),",")
 s (%G(%N),@%N)=%k,$p(%LIn,$c(5),%1)=%k
 q ""
RUN 
 s %NEW=1,%I="^"_%FILE,%ZR=1,%KEM=$L(%LII(%FILE),","),%SF=""
 f %=1:1:%KEM s %1=$p(%LII(%FILE),",") i $l(%1),$d(@%1) s %I=$name(@%I@(%1))
 i $$SaveMem^USX("t-"_%FILE)  ;; _$$CopySave^USX("t-"_%FILE)
 q
IR(%FILE) 
 n %,oo,%n s oo=""
 f %=1:1:$l(%LI(%FILE),",") s %n=$tr($p(%LI(%FILE),",",%),"~"),oo=oo_$e($g(@%n),1,1023)_$c(4)
 q oo
e(%Inew,%Iold) 
 s:$e(%Inew)'="^" %Inew="^"_%FILE_"("_%LII(%FILE)_")" 
 n %FILE s %Inew=$NAME(@%Inew),%FILE=$p($e(%Inew,2,999),"("),%SF=$g(%SF)
 q:$g(mxConfig)[("noChange:"_%FILE_":") ""
 s %Iold=$g(%Iold),%IRnew=$$IR(%FILE) s:%Iold["("""""!(%Iold[","""")") %Iold=""
 s:%Iold="" %Iold=%Inew i $e(%Iold)="~" s:$e(%Iold,2)="^" %Inew=$e(%Iold,2,999) s %Iold="DELETE"
 n %R,%1,%,%Rold,%N,o,%mxChange i '$d(%CON(%FILE)) s %1=%FILE d ^USX
 x %CON(%FILE) s %mxChange="" i $d(^mxConfig("A")),'$$tAccess("A",%FILE) s %E=" access denied " HALT  q %E
 i %Iold="DELETE" s %mxChange="-",%Iold=%Inew
 i %Iold["^",$d(@%Iold)#10 s %Iold=$NAME(@%Iold),%Rold=$$r5(%Iold) d  q:%mxChange<0 ""
 .  i $e(%mxChange)'="-",%Rold=%R,%Iold=%Inew s %mxChange=-1 q
 .  N %R,%I,@($tr(%LI(%FILE),"~")) s %I=%Iold,%R=%Rold x %XI(%FILE),%XG(%FILE)
 .  i 1_$$xglm(%I,-1) k @%Iold
 .  f %=1:1:$l(%LI(%FILE),",") s %n=$tr($p(%LI(%FILE),",",%),"~") d
 ..   i $p(%IRnew,$c(4),%)'=@%n s %mxChange=%mxChange_$c(10)_$c(13)_%n_"="_@%n_$c(10)_$c(13)
 q:$e(%mxChange)="-" %Inew_$c(4)_"-DELETED"
 i $$w5(%Inew,%R)_$$xglm(%Inew,1)
 q %Inew_$c(4)_%mxChange
vmALwr(%FILE,%Iold,%IRnew) 
 n %R,%1,%,%I,%Rold,%N,o i %FILE'=$g(%W) s %refreAL=1 d pAL^USb
 i mxConfig[("noChange:"_%FILE_":") q ""
 i mxConfig[("noChange2:"_%FILE_":"),%Iold["^" d  q:%Iold="" ""
 .  s o="^mM" f  s o=$q(@o) q:o=""  i o[(1_%Iold),$p(@o,%B)=%USID q
 .  s %Iold=""
 i '$d(%IRnew) s %IRnew=$$IR(%FILE)
 i %Iold["^" k %WW i $d(@%Iold)#10,%IRnew="" d  s %I="-"_%Iold g vmALwrE
 .  s %Iold=$NAME(@%Iold),%=$$xglm(%Iold,-1) k @%Iold
 i %IRnew="" s %I="?"_%Iold g vmALwrE
 f %=1:1:$l(%LI(%FILE),",") s %N=$tr($p(%LI(%FILE),",",%),"~"),(%G(%N),@%N)=$p(%IRnew,$c(4),%)
 s %I=$NAME(@("^"_%FILE_"("_%LII(%FILE)_")"))
 i %Iold'["^",$d(@%I)#10 s %Iold=%I ; exist old record with the same key
 i '$d(%CON(%FILE)) s %1=%FILE d ^USX
 x %CON(%FILE)
 i %Iold["^",$d(@%Iold)#10 s %=$NAME(@%Iold),%Rold=$$r5(%Iold) q:%R=%Rold&(%=%I) ""  d  k @%Iold
 .  N %R,%I s %I=%Iold,%R=%Rold
 .  n @($TR(%LI(%FILE),"~")) x %XI(%FILE),%XG(%FILE)
 .  i $$xglm(%I,-1)
 .  f %=1:1:$l(%LI(%FILE),",") d  ; only for indicate changed fields..
 ..   s %N=$tr($p(%LI(%FILE),",",%),"~")
 ..   s $p(%IRnew,$c(4),%)=$s($g(@%N)=$p(%IRnew,$c(4),%):"",1:$g(@%N)_$c(10)_"~~~~~~~~~~~~~"_$c(10)_$c(13)_$p(%IRnew,$c(4),%))
 i $$w5(%I,%R)_$$xglm(%I,1)
vmALwrE q %I_$c(4)_%Iold_$c(4)_%IRnew
vmALerr 
 x:$zv["MS" "w $zerr_%I_"" ""_%Iold_"" ""_%IRnew"
 q
ALv(%Sx7r) 
 s:'$g(%Sx7r) %Sx7r=1 s %LII=%LII(%FILE),%N=$tr(%N,"~") i %FILE'=$g(%W) s %refreAL=1 d pAL^USb
 I %Sx7r=1 k %mxINFO d  i %G>2,$d(^mxConfig("A")),'$$tAccess("A",%FILE) s %E=%N_": access denied "_$c(10)_$c(13)_%K_$c(10)_$c(13)_%E_$c(10)_$c(13)_"ERROR" q %E
 .s %LIn="",%KEI="",%KEM=$l(%LII(%FILE),",")
 .s %KEY=$l($p(","_%LII(%FILE)_",",","_%N_","),",")
 .i %G=1 s %maxList=1
 .i %K[$c(10)," Kase Banka oBanka pers pam "[(" "_%FILE_" ") s %K=$tr(%K,$c(10),"^") f  q:"^ "'[$e(%K)  s %K=$e(%K,2,9999) s:%K="" %K="-"
 .f  q:$c(10)_" "'[$e(%K)  s %K=$e(%K,2,9999) s:%K="" %K="-"
 k %ErrorM s $zt="ALvErr^US" s %E="" i %K[" " s %K=$p(%K_"     ","     ") s:'$l(%K) %K="-"
ALvNext s o=$g(%W(%N,%Sx7r)) s:o["$$pvn^fin" o="" s:$e(o)=";" o="" s %ALx=o
 i o["[""P""",$e(%N)="s" s o=$$trw^UST(o,"[""P""","[""p""")
 i $g(d)>20120700,o["""p"""!(o["""+""") n % d  s %ALx=o,o=""  
 . f %=118,121,122 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d,100)") 
 . f %=1.18,1.21,1.22 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d,100.01)") 
 . f %=.18,.21,.22 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d,.01)") 
 . f %=18,21,22 i o[% s o=$$trw^UST(o,%,"$$pvn^fin(d)") 
 i $g(d)>20110000,o[18,o'[22,o["""p"""!(o["""+"""),o'["$s(d" s o=$$trw^UST(o,18,22)
 i $g(d)>20110000,o[21,o'[22,o["""p"""!(o["""+"""),o'["$s(d" s o=$$trw^UST(o,21,22)
 i $g(d)>20090000,o[18,o'[21,o["""p"""!(o["""+"""),o'["$s(d" s o=$$trw^UST(o,18,21)
 i $zv["MiniM",o[" w "!(o[" w:")!($e(o)="w") s %E=o_" -- ""w"" not allowed in MiniM ! -- ",o=";" 
 s:$l(o) %ALx=o
 i " ; ?-"'[%ALx x %ALx
 i %K["  ",%K'["q",%K'["f",%K'["=" f  q:$l(%K)<2  q:%K'["  "  s %K=$$trw^UST(%K,"  "," ")
 i '$l(%E),%K?8n,%N="d"!(%N="d8"),mxConfig'[":%E.d8=NO:" s %E=$$d31^MXF(%K,8)
 i $l(%E),%E'[" ok!" s %E=%N_":"_$g(^AL(%FILE,"%W",%N,-1))_$c(10)_$c(13)_%K_$c(10)_$c(13)_%E_$c(10)_$c(13)_"ERROR" q %E
 i $l(%E),%E[" ok!" s %E=%N_$c(10,10)_%E q %E
 I $d(%W(%N,%Sx7r+1)) s %Sx7r=%Sx7r+1 g ALvNext
 s:$d(%mxINFO) %mxINFO=11
 i $$n(%K,%N)
 i " Kase oBanka pers pam "[(%FILE_" "),$l(%K,"^")>%maxList s %maxList=$l(%K,"^")
 k %ALx q %Sx7r
 q
ALvErr s %ErrorM="%ALx="_$g(%ALx)_"  "_$ze_" ;"_$c(0)
 q ""
WR q
F ; mx
 N %,%R,%1
 s %ZR=$NAME(@("^"_%FILE_"("_%LII(%FILE)_")"))
 S %R=$g(@%ZR),%NEW=%R="",%KEI=%ZR
 s:$l(%R)=500 %R=$$r5(%ZR) k %mxINFO(1,"'%NEW")
 I %NEW S %gminm=0,%gmaxm=9999 q
 x %XG(%FILE) s %mxINFO(1,"'%NEW")=%ZR ;; ,%="^mM("""")" 
 i $d(^mxConfig("A")),'$$tAccess("A",%FILE) s %E="F^US ::: access denied " s %R=0 x %XG(%FILE)
 q
xgl(%F,%ZR) 
 q:'$d(%ZR)!'%F "?"
 n %,%lg  x %ZRT(%F>0)
 i %AL("%F8")'["-m",$$%mM(%F>0,%ZR)
 i %F>0 x %xgl(0),%xgl(1) q ""
 n %R,%I s %I=%ZR,%R=$$r5(%ZR) n @($tr(%LI(%FILE),"~"))
 x %XI(%FILE),%XG(%FILE),$g(%xgl(%FILE,0)),$g(%xgl(%FILE,-1)) k @%ZR
xglE q ""
xglER x "s %E=$zerr " g xglE
xglm(%ZR,%F) 
 q:'$d(%ZR)!'%F "?"  s %E="" i %FILE'=$g(%W) s %refreAL=1 d pAL^USb
 i $g(mMdatums(%ZR)) s o=$g(mxConfig("mMdatums")) i o d  q:o
 . i ","_%LI(%FILE)'[",d,",","_%LI(%FILE)'[",d8," s o="" q
 . s:","_%LI(%FILE)[",d," %=d s:","_%LI(%FILE)[",d8," %=d8
 . i mMdatums(%ZR)>($h-o) s o="" q
 . s %E=mMdatums(%ZR),o=""
 k ^ooC(%ZR),odsFlag,opD s %isChang=1,^gramatos=0
 n %,%lg,%file,o s %file=$e($p(%ZR,"("),2,99)
 i '$d(%xglm(%file)) d %xgl^USX
 i $d(%ZRTm) x $g(%ZRTm(%file,%F>0))
 i $g(%AL("%F8"))'["-m",%file'["mxConfig",%file'["kNo",%file'["mMail",$$%mM(%F>0,%ZR)
 i %F>0,'$g(^otSelect(%USID,%file,0)) s %="^otSelect(%USID,%file,"_$p(%ZR,"(",2,9),@%@(%ZR)=1
 i %F>0 x $g(%xglm(%file,0)),$g(%xglm(%file,1)) q ""
 s %="" i $g(d),(","_%LI(%FILE)[",d,"),$d(^gramatos(d,%ZR)) s %=$zr
 i $g(d8),(","_%LI(%FILE)[",d8,"),$d(^gramatos(d8,%ZR)) s %=$zr
 i '$l(%),","_%LI(%FILE)[",d,"!(","_%LI(%FILE)[",d8,") f  s %=$o(^gramatos(%)) q:%=""  i $d(^gramatos(%,%ZR)) s %=$zr q
 i $l(%) k @%
 S %=$E(","_%LII(%FILE)_",",1,%),%KEY=$L(%,",")-2
 n %R,%I s %I=%ZR,%R=$$r5(%ZR) n @($tr(%LI(%file),"~"))
 x %XI(%file),%XG(%file)
 x $g(%xglm(%file,0))
 x $g(%xglm(%file,-1)) 
 k @%ZR
xglmE q ""
xglmER x "s %E=$zerr " 
 g xglE
pLI(%I) 
 n %R,oox,oor,%1,oon s %R=$g(@%I),%B=$c(254) q:%R="" ""
 i $e(%I,1,4)="^mM(" s %I=$p(%I,",",2,99),%I=$e(%I,3,$l(%I)-2)
 s %I=$$trw^UST(%I,"""""","""")
 s %1=$e($p(%I,"("),2,99) q:'$l(%1) ""
 x %XI(%1),%XG(%1) s oor="" i $d(^mxConfig("A")),'$$tAccess("A",%1) q ""
 f oox=1:1:$l(%LI(%1),",") s oon=$tr($p(%LI(%1),",",oox),"~"),oor=oor_%B_@oon
 q oor
%mM(%F,zr,r) 
 n o,%
 s zr=$NAME(@zr) k ^ooC(zr)
 i %F>0,$d(@zr)#10=0 q ""
 s %=$tr($h,",",".") s:$l(%)<11 $p(%,".",2)=$e(100000+$p(%,".",2),2,9)
 s o=1 f  q:'$d(^mM(%_o))  s o=o+1 q:o=9
 s:'$d(r) r=$g(@zr) s:$e(r)=%B r=%USID_r s ^mM(%_o,(%F>0)_zr)=r
 i $d(@zr)
 q ""
W S %WW(%N)=%K Q
tnq(format,text,h) 
 n t,tt,tt1,ttt,%1,%2,%3
 s t="",tt1=text,ttt="",h=$g(h,";"),text=$g(text)
 f %=1:1:$l(format,";") s tt=$p(format,";",%) d:tt'=""
 . s %1=$p(tt," "),%2=$p(tt," ",2,99),%3=$p($p(text,%1,2,99),h)
 . i %3="" s %3="?"
 . s tt1=$p($p(tt1,%1),h),ttt=ttt_"||"_%2_"|"_%1_"|"_%3 s:tt1="" tt1=" "
 q " | |"_tt1_ttt
%BELL q
%n1(%n) k %WW(%n) s:%NEW %WW(%n)=@%n\1+1 q ""
N1 K %WW(%N) S:%NEW %WW(%N)=%K\1+1 Q
%zb(h) q:%j ""
 q ""
w(y1,x1,y2,x2,w,s,c) 
 q ""
wT(a,y,x) q ""
r5(%zr) n %,%R s $p(%zr,"(")="^"_%FILE,%R=$g(@%zr) q:$l(%R)<500 %R
 f %=501:500 q:'$d(@%zr@(%))  q:$l(%R)#500  s %R=%R_^(%)
 q:1_$d(@%zr) %R
w5(%zr,%R) n %,r i $zv'["MS" s @%zr=%R q ""
 i '$d(@%zr),$l(%R)<500 s @%zr=%R q ""
 i $d(@%zr@(501))
 f %=501:500 s r=$e(%R,%,%+499) q:r=""&'$d(^(%))  k ^(%) s:r'="" ^(%)=r
 s @%zr=$e(%R,1,500)
 q ""
wkv(x) q:x'[$c(2) x  
 n xx s xx=$p(x,$c(2))
 f %=2:1:$l(x,$c(2))-1 s xx=xx_""""""_$p(x,$c(2),%)
 q xx
%T N %TIM,%TIM1,%NP
 N %M S %M=$P($H,",",2)\60
 N %I,%N S %TIM=%M\60_":"_(%M#60\10)_(%M#10)
 S %N=" AM" S:%M'<720 %M=%M-720,%N=" PM" S:%M<60 %M=%M+720
 S %I=%M\600 S:'%I %I=" " 
 S %TIM1=%I_(%M\60#10)_":"_(%M#60\10)_(%M#10)_%N
 I '$D(%NP) W:'%j %TIM1 K %TIM,%TIM1
 K %NP Q
%G(%N) ; mx
 q:"o"_%B[$g(%FILE,"o") 1  q:'$d(^AL(%FILE)) 1
 i '$d(%LII(%FILE)) n %1 s %1=%FILE d ^USX q:'$d(%LII(%FILE)) 1
 s %KEM=$l(%LII(%FILE),",")
 f %G=1:1:$l(%LI(%FILE),",") q:%N=$tr($p(%LI(%FILE),",",%G),"~")
 q %G
EnterAL(oo) 
 ; mx
 q:oo[";;" ""
 s o=$p(oo,";"),oo=$tr($p(oo,";",2,999),"=",",")
 s %FILE=$e($p(oo,"("),2,99),oo=$p(oo,"(",2,999)
 s:o="" o=%FILE s ^AL(%FILE,"NAME")=o
 s ^("%LII")=$p(oo,")"),^("%LG")="%SF"_$p(oo,")",2,999)
 s ^("%LI")=$tr(oo,")")
 f o=1:1:$l(oo,",") s n=$p(oo,",",o) i n[")" d  q
 . s ^AL(%FILE,"%W",$p(n,")"),1)=" d F "
 q ""
oAL() n %FILE,oo,o,%
 s %FILE=$p($g(oAL(0,1))," ",2) q:%FILE="" "ERROR - "_$g(oAL(0,1))
 s ^AL(%FILE,"NAME")=$p(oAL(0,1)," ",3,9)
 f g=1:1 s o=oAL(1,g) q:o=""  s:$d(oo) oo=oo_","_o,^AL(%FILE,"%LG")="%SF"_oo s:o[")" oo="" 
 s oo="" f g=1:1 s o=oAL(1,g) q:o=""  s oo=oo_o_"," i o[")" s ^AL(%FILE,"%LII")=$p(oo,")") q
 s oo="" f g=1:1 s o=oAL(1,g),oo=oo_$p(o,")")_"," i o="" s ^AL(%FILE,"%LI")=$p(oo,",,") q
 f g=1:1 s o=oAL(1,g) q:o=""  d 
 .f %=1:1:6 s ^AL(%FILE,"%W",$tr(o,")"),%)=oAL(%+4,g) k:@$zr="" @$zr
 .s ^AL(%FILE,"%W",$tr(o,")"),-1)=oAL(2,g) k:@$zr="" @$zr ; name
 .s ^AL(%FILE,"%W",$tr(o,")"),-2)=oAL(3,g) k:@$zr="" @$zr ; %SEL
 .s ^AL(%FILE,"%W",$tr(o,")"),0)=oAL(4,g)  k:@$zr="" @$zr ; before show 
 k oAL q $zr
tAccess(%0,%1) 
 s %1=$g(%1,%FILE) n %,%A,%zt s %zt=$zt,$zt="tAccessE^US"
 i %0="A" q:'$d(^mxConfig("A")) 1 d  s $zt=%zt q %A
 . i '$d(mxConfigA(%1)) s %="^mxConfig(""A"",%1)",mxConfigA(%1)=1 f  s %=$q(@%) q:%=""  q:$qs(%,1)'="A"  i $p($qs(%,2),"(")=%1 s mxConfigA(%1)=0 i $qs(%,3)=%USID s mxConfigA(%1,$qs(%,2)_%B_$qs(%,4))=$p(@%,%B,2)  
 . m %A=mxConfigA(%1) q:%A
 . s %=0 f  s %=$o(%A(%)) q:'$l(%)  s %A=1 d:%["("  i %A x "s %A="_%A(%) q:%A  ;; {1076}{1086}{1089}{1090}{1091}{1087} {1088}{1072}{1079}{1088}{1077}{1096}{1077}{1085} 
 .. n o,%i,%ii s %ii=$p($p(%,"(",2),")")
 .. f o=1:1:$l(%ii,",") s %i=$p(%LII(%1),",",o) q:'$l(%i)  i $g(@%i)'=$p(%ii,",",o) s %A=0 q  
tAccessE s $zt=%zt w ";",$c(0) q 0 ; not accessed
 q

USDOS
USDOS ; MX.Shell  ;[ 20191027 19:41:35 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 ; 
 ;(1,disk)        -D:           -q daudz.disku
 ;(2,file)     -ERASE (del)  -                    -5=no path
 ;(3,fold,fnew)-RENAME/(COPY?)  -
 ;(4)          -VER.of DOS   -
 ;(5,file,atr) -CHMOD        -32=arh,(16=dir,8=disk),4=sys,2=hid,1=read
 ;(6,dir)      -MKDIR        -
 ;(7,dir)      -RMDIR        -delete dir
 ;(8,dir)      -CD           -q                   -5=no path
 ;(9,disk)        -  ?space     -s/kl^freekl^b/s^kl
 ;(10,file,atr)-  ?atr       -q zos5              -5=no path
 ;(11,d)       -  ?dir       -q tek.dir(-d)
 ;(12,f?*,atr) -  ?file ,,63 -q file^S2=30b
 ;(13,q12)     -  ?nextfile  -q 12
 ;(14)         -  ?tek.disk  -
 ;             ------------------
 i '%j w #,$zv," ",?70 i $zv["MS" w $zu(0)
 s %USER=$g(%USER,"XXX") n %USPR s %USPR="USDOS"
 s %="\[3;47;20;78w\\open save rFnd Rcomp net mMailF9"
 d %M^USMENU q
zos(%1,%2) 
 n %,o
 i $zv["MS" x "s %=$zos(%1,%2)" q %
 q ""
open k ^US($j,"mMail.read") d %GR^USDOS q    ;\A:/B: glob.restory
rFnd d %RFound q                             ;\ROUTINES FOUND
Rcomp d RCMP^UShelp q                       ;\Glob & Rout Compare
zc(exe) 
 i $zv["MS" s exe=$$TERMINAL^%HOSTCMD(exe)
 i $zv["Ca" s exe=$zf(-1,exe)
 i $zv["IRIS" s exe=$zf(-1,exe)
 q exe
net ;\ Net-info
 k r s r(110)="NBTSTAT -r"
 s r(120)="NET CONFIG"
 s r(130)="NET DIAG"
 s r(140)="NET VIEW"
 s r(150)="NET PRINT"
 s r(160)="NET USE"
 s r(170)="NET VER"
 s r(180)="NETSTAT"
 s r(190)="ARP"
 s r(200)="FTP"
 s r(210)="PING"
 s r(220)="ROUTE"
 s r(230)="TELNET"
 s r(240)="TRACERT"
 ;
 s %=$$ws^USE("r",2,44) q:%zb=27
 s %=$$zc(@%wz),%=$$zc("PAUSE")
 q
mMail ;\ Write/Read
 q
mMailF9 ;\ Write/Read mMail show
 q
Shellbat(t) 
 n %,%file s %file="shell"_$j_".bat"
 d OpenUseW
 f %=1:1 q:$p(t,$c(13),%)=""  w $p(t,$c(13),%),!
 w "EXIT",!
 d Close
 s %=$$zc("start /min shell"_$j_".bat ") 
 h:'$d(%j)
 q %
save d USGS                       ;\MSM-globals,routines==>
%RFound q
jwr(%j,%NODE) 
 n %,%1,%Node,%2
 s %NODE=$g(%NODE),%Node="" x $e(%j,2,999)
 f  s %Node=$o(^mMail(%Node)) q:%Node=""  d:%Node=%NODE!(%NODE="")
 .s %dow=$p(^mMail(%Node),$c(254),2),gList=$p(^mMail(%Node),$c(254),3)
 .q:^(%Node)[";"
 .s %dor="" s:gList="-"!($e(gList)["(") %dor=%dow,%dow=""
 .s:$e(gList)["(" %dor=%dor_"/"_$p($p(gList,"(",2),")"),gList=$p(gList,"(")
 .f %="gList","%dow","%dor" s %(%)="" d  s @%=%(%)
 ..n %x f %x=1:1:9 s %1=$p(@%,"_",%x) i %1'="" d
 ... x:$e(%1)="(" "s %1="_%1 s %(%)=%(%)_%1
 .i gList[":\",$e(%dow,1,2)=$e(gList,1,2) x "s %=$zos(3,%dow,gList)" q
 .i gList["\"  d  h 1 q
 .. s %=gList,$p(%,"\",$l(%,"\"))="x.x"  q:$$zos(2,%)=-5
 ..s %=$$Shellbat("@echo off"_$c(13)_"copy "_%dow_" "_gList_" > nul") h 1
 .i %dow["\" s %=$$jwg(%j,%dow,gList,0,gList) q
 .i %dor["\" s %=$$jrg(%j,%dor) q
 h:%j  
 q ""
jw(%j,%Node,%dow,gList) 
 s %=$$jwg(%j,%dow,gList,0,gList)
 q ""
jwg(%j,%file,gList,%Piez,%MET) 
 s (%Piez,%MET)=$g(%Piez)_$g(%MET)
 s %file=$s(%Piez:+%Piez,1:%Piez["OS"),%RL=""
 d Close
 s %=%file,$p(%,"\",$l(%,"\"))="x.x" i $zv["MS" q:$$zos(2,%)=-5 ""
 s %file="C:\M\tmpjwg."_$j,%MET=%file_" "_$g(%MET) d %GSj
 f %1=1:1:3 s %=$$zos(2,%file) q:$$zos(10,%file)-32  h 5 ; del.@%file
 d Close
 i $zv["MS" x "s %=$zos(3,%file,%file)" i 1
 e  i $$Shellbat("@echo off"_$c(13)_"copy "_%file_" > nul")
 d Close
 h:%Piez["halt"&%j  
 q ""
jrg(%j,%file,%mode,%xmsm) 
 s %=%file,$p(%,"\",$l(%,"\"))="x.x"
 i $$zos(2,%)=-5 d:'%j  q ""
 . W !,"NOT found ",%file r rrrrrr
 s %mode=$g(%mode),%xmsm=$g(%xmsm)
 d %GR 
 d Close
 q ""
gr(%j,%USID,%file,%mode,%xmsm) 
 ; mx
 k ^ooMX(%USID,"gr") s ^ooMX(%USID,"gr")=%file_"-"_$h
 s %mode=$g(%mode),%xmsm=$g(%xmsm)
 d %GR
 s ^("gr")=$h_"-"_^ooMX(%USID,"gr")
 d Close
 q:%j  
 q $h
gs(%j,%USID,%file,max,%xmsm) 
 ; mx   ^mM(max)
 k ^ooMX(%USID,"gs") s ^ooMX(%USID,"gs")=%file_"-"_$h
 s:'$g(max) max=33 s zr="^mM(999999)",n=0,ot=0
 f  s zr=$q(@zr,-1) q:zr=""  s t=$qs(zr,1)\1 s:ot-t n=n+1 s ot=t q:n>max
 i zr="" s zr="^mM"
 d OpenUseW
 w $h,!,max
 i $zv'["U) " f n=0:1 s zr=$q(@zr) q:zr=""  w !,zr,!,@zr
 i $zv["U) " f n=0:1 s zr=$q(@zr) q:zr=""  w !,$$U^MXF(.zr),!,$$U^MXF(@zr)
 w !,"**",!,"**",!,!
 d Close
 s:'n n=-1
 s ^("gs")=n_"-"_$g(^ooMX(%USID,"gs"))
 q:%j  
 q n
gsj(%j,%USID,%file,%zr,%xmsm) 
 ; mx   ^glob
 s (%zr,zr)=$NAME(@%zr),%ql=$ql(zr)
 k ^ooMX(%USID,"gs") s ^ooMX(%USID,"gs")=%file_"-"_%zr_"-"_$h
 d OpenUseW
 f n=0:1 s zr=$q(@zr) q:zr=""  w @zr,! s ^ooMX(%USID,"gs",n)=@zr
 d Close s:'n n=-1
 s ^("gs")=n_"-"_$g(^ooMX(%USID,"gs"))
 q:%j  
 q n
saveGlob(%j,%USID,%file,zr,%xmsm) 
 ; mx  save one glob or node
 k ^ooMX(%USID,"saveGlob") s ^ooMX(%USID,"saveGlob")=%file_"-"_zr_"-"_$h_" ERROR "
 s:'%j zr=$NAME(@zr) s %xmsm=$g(%xmsm)
 s ^ooMX(%USID,"saveGlob")=%file_"-"_zr_"-"_$h
 d OpenUseW
 w $$pD^MXD($h,2)," ",zr," ",$zv,!,%USID
 s zr0=$e(zr,1,$l(zr)-1)
 i $zv'["U) " f n=0:1 s zr=$q(@zr) q:zr'[zr0  w !,zr,!,@zr s:$l(%xmsm) ^ooMX(%USID,"saveGlob",n)=@zr
 i $zv["U) " f n=0:1 s zr=$q(@zr) q:zr'[zr0  w !,$$U^MXF(zr),!,$$U^MXF(@zr) s:$l(%xmsm) ^ooMX(%USID,"saveGlob",n)=$$U^MXF(@zr)
 w !! d Close
 s ^("saveGlob")=n_"-"_$g(^ooMX(%USID,"saveGlob"))
 q:%j  
 q n
b25 q
USGS 
writeDOS 
 s n=0,%L=$g(%L),%MET=$g(%MET),%FN=$g(%FN)
 s %file=$e(%MET,1,3)["OS"!($p(%L,"=",3)["OS")
 n o x "s o=$s($zv[""MS"":$zu(0),1:$znspace)"
 s %USER=$g(%USER,o)
 s:%L["=" (%file,%FN)=$p($p(%L,"="),"?"),gList=$P(%L,"=",2),%RL=""
 g %GSRS
%GSj i '%j w $$w^USE("%GSj^USDOS",3,1) q:%zb=27
 ;  ------- Save Globals (mMail) ---------
 ;   M-globals/if_____?gList              
 ; to DOS-file________?%file               
 d %GS
 q
%GSRS i '%j w $$w^USE("%GSRS^USDOS",3,1) q:%zb=27
 ; M-Globals/if_____?gList                  i..,i      %zr  ;
 ; M-Routines/if ___?%RL
 ; to DOS-file________?%file                   A:xx.xxx  B:xx.xxx
 d %GS,%RS q:%j
 g %GSRS
saveUCI(routOnly,saveTo) 
 i '$d(saveTo) j saveUCIj(%USID) q
 j saveUCIj(%USID,routOnly,saveTo)
 q
saveUCIj(%USID,routOnly,%file) 
 s ^oTQMx(%USID,"saveUCI")=0
 n %j,gList,%RL,%,%L,o,%UCIsave,z,zz
 s %j=1,%L="",o="GTM" 
 x:$zv'["GT" "s (%UCIsave,o)=$s($zv[""MS"":$zu(0),1:$znspace)"
 i $g(%file)="" s %file="C:\M\save"_$p(o,",")
 s gList="* -ROUTINE -GB -rM* -rI* -rB* -rO* -mtemp* -CacheTem* -%* -M -rm* -UTILITY -mx* -US -mvars -o* -TK* -ZMS* -Msg* -Er* -menu* -JOB* -C -DC -NNd -vc* -mJournal -mM -iVAL -gramato* -fk0 -fd* -f -HroIndex -NNo -ceChange -bJournal -apm -aFirma -aDK"
 s %=$g(%qSelect)_$g(%qChange),%=%["isas"!(%["VISAS")!(%["VISI")!(%["isi")!(%["ALL")!(%["all")!(%["All")
 s:% gList="* -ROUTINE -rM* -rI* -rB* -rO* -mtemp* -CacheTem* -%* -M -rm* -UTILITY -mxM* -US* -mvars -o* -TK* -ZMS* -Msg* -Er* -menu* -JOB* -C -DC -mM -iVAL -gramato* -fk0 -fd* -f -HroIndex -NNo -apm -aFirma -aDK"
 k ^mmM i $zv["MS" k ^US,^M,^rm,^om,^oMX
 s z="^mM($h-400_.999999)" f  s z=$q(@z) q:'$l(z)  s zz="^mmM("_$p(z,"(",2,99),@zz=@z 
 s %RL=$g(routOnly) s:%RL="" %RL="* -%* -r -rr -rrr -TK* -oo* -Ens*"
 i $l($g(routOnly))<3 d %GS m ^oTQMx(%USID,"saveUCI","%gg")=%gg m ^oTQMx(%USID,"saveUCI","%gg")=%gm
 s ^oTQMx(%USID,"saveUCI")=$h_"  "_%file_" "_%RL_" save ^%RS started but NOT finished !! <mx fc7"
 d %RS
 s ^oTQMx(%USID,"saveUCI")=$h_"  "_%file
 q
%GS ;
 s %=$p(%file,":") s:%="" %="C"
 i '%j,$e(%file,2)=":",$$zos(9,%)<0 w $$^UShelp("%file","no $zos(9,"_%_")="_$$zos(9,%)) q
 q:'$l(gList)
 n %g,%g0,%g2,%x,%GL,n,%2,%r  k %gg
 s $zt="%GSlist2^USDOS"  ;;  if <DKSER> list global
%GSlist1 
 i $zv'["Ca",$zv'["IRIS" s %g="" f n=1:1 s %g=$o(^$GLOBAL(%g)) q:'$l(%g)  s %gg(%g)=n
 i $zv["Ca"!($zv["IRIS") d
 .n gd d GetDir^%GD("","gd")
 .s %g="" f n=1:1 s %g=$o(gd(%g)) q:'$l(%g)  i %g'["." s %gg("^"_%g)=n
 g %GSlISt
%GSlist2 
 s $zt="%GSlIStE^USDOS"  ;;  if <DKSER> list global
 i $zv'["Ca",$zv'["IRIS" s %g="" f n=1:1 s %g=$o(^$GLOBAL(%g),-1) q:'$l(%g)  s %gg(%g)=n
 i $zv["Ca"!($zv["IRIS") d
 .n gd d GetDir^%GD("","gd")
 .s %g="" f n=1:1 s %g=$o(gd(%g),-1) q:'$l(%g)  i %g'["." s %gg("^"_%g)=n
%GSlIStE I '%j zw %gg,n w $zt r %
%GSlISt s %GL=$p(gList,"/"),%di=1
 s $zt="ErGS^USDOS"  ;;  if <DKSER> 
revers s %="" f  s %=$o(%gg(%)) q:%=""  d
 .i "^UTILITY ^M ^R ^r ^rm ^US "[(%_" "),gList="*" q
 .i %["^o"!(%["^us"),gList="*" q
 .f %x=1:1:$l(%GL," ") s %g=$p(%GL," ",%x) i %g'="" d
 ..s:$e(%g)'["^" %g="^"_%g
 ..i %g["(",")."'[$e(%g,$l(%g)) s %g=%g_")"
 ..i %=$p(%g,"(") s %g(%g)=1 q
 ..i %g["*",%[$p(%g,"*") s %g(%)=1 s:gList["?" gList=gList_" "_%
 ..q:$e(%g,2)'["-"  s %g=$tr(%g,"-")
 ..i %=%g k %g(%) q
 ..i %g["*",%[$p(%g,"*") k %g(%)
 g ErGSend
ErGS 
 x:$zv["MS" "s %=$zerr" s $zt=""
 i '%j,%di>0 u $p zw %,%g  w !,"<DKSER> - M_database_invalid - file=",%g r % s %di=-1 g revers
 s $zt=""
ErGSend 
 q:gList_%RL["?"  n o
 x "s o=$s($zv[""MS"":$zu(0),1:$znspace)"
 s %CMT=%file_" "_$g(%MET)_" --- "_o_" --- "_gList_" --- "_$zv
 n %iff s %iff=$p(gList,"/",2,99) s:%iff="" %iff=1
 s %if="s %zr=$q(@%zr),%=%zr[%g0&(%g2'=%zr)-1 s:'% %="_%iff
 s %s=" w !,%zr,!,@%zr "  i $zv["U) " s %s=" w !,$$U^MXF(%zr),!,$$U^MXF(@%zr) "
 i %file s %s=" w !,$tr(@%zr,$c(254),"","") "
 i %file\1=2 s %s=" w @%zr,! "
 i '%file,%file'["." s %file=%file_".ggg"  ;; ,%s="s %r=@%zr s:%r[$c(10) %r=$tr(%r,$c(10),""^"") w !,%zr,!,%r"
 s %=%file,$p(%,"\",$l(%,"\"))="x.x"  i $zv["MS" q:$$zos(2,%)=-5
 w:'%j ! 
 d OpenUseW
 w $$pD^MXD($h)_" "_$h,!,%CMT  s ^ERR=%s
 s %2=$$Uu^MXF($c(10)_$c(10)_$g(%UCIsave)_$c(10)_"{1076}{1072}{1085}{1085}{1099}{1077} {1089}{1086}{1093}{1088}{1072}{1085}{1077}{1085}{1099} {1074} {1092}{1072}{1081}{1083} "_%file_$c(10)_"saved in "_%file)
 s %nn=0,%g="" f  s %g=$o(%g(%g)),%g0="^" q:%g=""  d  q:'$d(%g)  s ^oTQMx(%USID,"saveUCI","%gg",%g)=" -saved "_$h  s ^oTQMx(%USID,"saveUCI","lastGlobal")=%g s:%g["zzzzzzz" @$zr=%2
 .s %1=%g,%g2="" u:'%j $p
 .i %1["^mM(" s %1=$p(%1,")")_".."
 .i %1[".." s %g0=$p(%1,"..",2) s:%1["..." %g0=$p(%1,"...",2) d  i 1
 ..s %1=$p(%1,".."),%1=$p(%1_",,,",",,,"),%1=$p(%1_")))))",")))))")_")"
 ..i %1["^mM(" s %=+$p(%1,"(",2) i % d  s %1="^mM("_+%_")" q
 ... s:%<0 %=-% n n,x s n=%,%=$o(^mM(""),-1),%=""
 ... i n<999 f x=1:1:n s %=$o(^mM(%),-1)\1 q:'%
 ... i n>971111 s:-n[-9 n=19_n d  i % s %=$o(^mM(%\1+.9))\1 s:'% %=99999
 ....  f x=1:1:400 s %=$o(^mM(%),-1)\1 q:'%  q:$$%D^MXD(%)<n
 ..i %g0="" s %g0=$p(%1,"(") q
 ..f  q:$l(%1,",")'>$l(%g0,",")  s %g0=","_%g0
 ..f %=1:1 s %2=$p(%1,",",%) q:%2=""  s:$p(%g0,",",%)="" $p(%g0,",",%)=%2
 ..i 0_%1'[(0_$p(%g0,"(")_"(") s:%g0 %g0="("_%g0 s $p(%g0,"(")=$p(%1,"(")
 ..i %1'[%g0 s %g2=%g0 s:%g2_0'[")0" %g2=%g2_")" s %g2=$q(@%g2),%g0="^"
 ..s %=$p(%g,"..")_".."_$e(%g0,2,99) s:$e(%g2)="^" %=%_$q(@%g2,-1)
 .e  q:'$d(@%g)
 .i $d(@%1) s:%g'[".."&(%g0="^") %g0=$tr($NAME(@%1),",",")") d
 ..s %if="s %zr=$q(@%zr),%=$tr(%zr,"","","")"")[%g0&(%g2'=%zr)-1 s:'% %="_%iff
 .s %zr=$NAME(@%1),n=0 
 .u:$zv["MS" 51 u:$zv["Ca" %file u:$zv["IRIS" %file u:$zv["MiniM" "|FILE|"_%file
 .i $d(@%1)#10=1 s %zr=$q(@%zr,-1) s:%zr="" %zr=$p(%1,"(")
 .f  x %if q:%<0  i % x %s s %nn=%nn+1,n=n+1 i $zv["MS"&$zc d  q
 ..k %g s %g=%zr
 I $zv["MS",'%file u 51 W !,"**",!,"**",!,!
 I $zv["MiniM",'%file u "|FILE"_%file w !,"**",!,"**"
 I $zv["Ca"!($zv["IRIS"),'%file u %file w !,"**",!,"**"
 d Close
 q
%RS q:'$l(%RL)
 n %r,%x,%mxWeb s %mxWeb=1 s %RL=$p(%RL,"/")
 s %="" f  s %=$o(^$ROUTINE(%)) q:%=""  d:%'["."
 .n o s o=% n % s %=$p(o," ") q:o["LIC"
 .f %x=1:1:$l(%RL," ") s %r=$p(%RL," ",%x) d
 ..i %=%r s %r(%)=1 q
 ..i %r["*",1_%[(1_$p(%r,"*")) s %r(%)=1 s:%RL["?" %RL=%RL_" "_% q
 ..q:%r'["-"  s %r=$tr(%r,"-","")
 ..i %=%r k %r(%) q
 ..i %r["*",1_%[(1_$p(%r,"*")) k %r(%)
 q:%L_%RL["?"
 s %file=$p(%file,"."),%CMT=$g(%MET)_" "_$g(%USER)_" "_%RL
 s %=%file,$p(%,"\",$l(%,"\"))="x.x"  q:$$zos(2,%)=-5  
 w:'%j !
 d OpenUseW
 w $g(%USID)_"  ",!,%CMT n r 
 s %r="" f n=1:1 s %r=$o(%r(%r)) q:%r=""  d  q:$zc
 .k r x "zl @%r f %=0:1 s t=$t(+%) q:'$l(t)  s:t'["" ""&% t=t_"" ""  s r(%)=t"
 .f %=0:1 s t=$g(r(%)) q:'$l(t)  s t=$$U^MXF(t) s:%RL["-msm" t=$$Uu^MXF(t) w !,t
 .w ! q:'$zc  q:%j
 .s n=0
 w:'%j !!  
 d Close
 i '%j,n W ?45,!,"save-msm-ROUTINES =",n-1,"=>",%file,?45
 q
%GR s %j=$g(%j) i '%j w $$w^USE("%GR^USDOS",2,2) q:%zb=27
 ;                                               routines: ^^  ;
 ; DOS-msm-file   DOS-file___?%file         /-mGlob1-mGlob2- ..
 ;         jaun(j) contr(k) _?%mode
 ;            msm-commands___?%xmsm         %f  %r  %sel=1
pKC 
  w:'%j $$yx^US(7,0)
  n oo,o2,%r,%f,%sel,%n,%nnn,%er,%ss,%g,f,timeStmp,%mMindex,o,oDelay,%wMail
  s %oldf=0,%nnn=0,%er="",%f="",%ss=0
  s %2=$p(%file,"/",2,99),%file=$p($p(%file,"/")_"  ","  ") d
  .f %=1:1:99 s f=$p($tr(%2,"+-","  ")," ",%) i f'="" s f("^"_f)=%2'["-"
 d Close
  s %er=0,o=$h 
 d OpenUse
  s zc=$zc,za=$za,zb=$zb,oDelay=$p($h,",",2)-$p(o,",",2)
  i %er s ^ooMX(%USID,"gr")=$h_" ERROR: "_%file_"-not open .. Delay="_oDelay  c $s($zv["MS":51,1:%file) q
  ;
  s $zt="grErr^USDOS"
  i $zv["MS" f %n=0:1 u 51  q:$zc<0  r %r#512 q:$zc<0  d  i %er s ^ooMX(%USID,"gr",$h)="  ERROR : %n="_%n_"  %r="_%r_"  %f="_$g(%f) q
  .q:$l(%r)=512  i '%j u $p i %n<2 w !,%r q
  .i %n#2=0  d:$e(%r)'="^"    s %f=%r,%g=$p(%f,"(") q
  .. f  u 51  r %r#512 q:$zc<0  i $e(%r)="^",%r'["Ca",%r'[" " q
  .i $e(%f)'="^" s %er=1 q
  .i $e(%f,$l(%f))'=")" s %er=1 q
  .i $g(f(%g))=0 s %f="",%r="" q
  .s %mMindex=2_%f,timeStmp=+$h
  .i $e(%f,1,4)="^mM(" k % s %="%("_$p(%f,",",2,99) d  q:%f=""!%cancel
  ..  s %cancel=0  ;; s %cancel=1   --- for exit from ^wMail
  ..  s (timeStmp,oo)=+$p(%f,"(",2),o2=$p(oo,".",2)
  ..  s:$l(o2)<6 $p(oo,".",2)=$e(o2+1000000,2,9),timeStmp=oo
  ..  i %'["^" s ^ERROR(%n)=%_"  %f="_%f_" %r="_%r_" %g="_%g,%cancel=1 q
  ..  i %r="",%f'["0^" s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)="%r?",%cancel=1 q
  ..  s @%=0,%mMindex=$o(%("")),%f=$e(%mMindex,2,999),%g=$p(%f,"(")
  ..  i $g(f(%g))=0 s %f="" q
  ..  i $d(f)>2 s %2=$o(f(0)) i f(%2),'$d(f(%g)) s %f="" q
  ..  i '$d(%wMail) s %wMail=$l($t(^wMail))
  ..  i %wMail,1_$$w^wMail(%mMindex,%r) q:%cancel
  ..  
  .i %f_")))"'["))))" s %f="",%r="" q
  .s %g=$e($p(%f,"("),2,99),%sel=1
  .i $l(%xmsm),%xmsm["%sel"  x %xmsm q:'%sel
  .i $l(%xmsm),%xmsm'["%sel" s %sel=0 d  q:'%sel
  ..  f o=1:1:$l(%xmsm," ") i %g=$p(%xmsm," ",o) s %sel=1 q
  .i %j s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)=%r
  .i '%mMindex k @%f s %nnn=%nnn-1 q
  .i '%j w *13,%f
  .i $d(@%f)#10=1 w:'%j "..ir" q:%mode["j"!(@%f=%r&(%r'["=FE"))
  .i %r["=FE",%r'[$c(254) s %rr=%r,%r="" f %=1:1:$l(%rr) d  s %r=%r_%1
  .. s %1=$e(%rr,%) q:%1'="="
  .. n a,b s a=$e(%rr,%+1),b=$e(%rr,%+2) i a_b="FE" s %1=$c(254),%=%+2 q
  .. s a=$s(a="A":10,a="B":11,a="C":12,a="D":13,a="E":14,a="F":15,1:a)
  .. s b=$s(b="A":10,b="B":11,b="C":12,b="D":13,b="E":14,b="F":15,1:b)
  .. s %1=$c(a*16+b),%=%+2
  .q:%mode["k"  s @%f=%r,%nnn=%nnn+1  ;; k=kontrole
  i $zv["MS" c 51 q
  d ReadTXT(%file,"^oFileTXT($j)") k ^omxERROR(%USID)
  f %n=1:1 s %r=$g(^oFileTXT($j,%n)) q:'$l(%r)&'$o(^(%n))  d  i %er s ^ooMX(%USID,"gr",$h)="  ERROR : %n="_%n_"  %r="_%r_"  %f="_$g(%f) q
  .i %n#2 d:$e(%r)'="^"  s %f=%r,%g=$p(%f,"(") q
  .. n % f %=1:1:99 s %n=%n+1,%r=$g(^oFileTXT($j,%n)) q:$e(%r)="^"
  .i $e(%f)'="^" s %er=1 q
  .i $e(%f,$l(%f))'=")" s %er=1 q
  .i $g(f(%g))=0 s %f="",%r="" q
  .s %mMindex=2_%f,timeStmp=+$h
  .i $e(%f,1,4)="^mM(" k % s %="%("_$p(%f,",",2,99) d  q:%f=""!%cancel
  ..  s %cancel=0  ;; s %cancel=1   --- for exit from ^wMail
  ..  s (timeStmp,oo)=+$p(%f,"(",2),o2=$p(oo,".",2)
  ..  s:$l(o2)<6 $p(oo,".",2)=$e(o2+1000000,2,9),timeStmp=oo
  ..  i %'["^" s ^omxERROR(%USID,$j,%n)=%_"  %f="_%f_" %r="_%r_" %g="_%g,%cancel=1 q
  ..  i %r="",%f'["0^" s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)="%r??",%cancel=1 q
  ..  s @%=0,%mMindex=$o(%("")),%f=$e(%mMindex,2,999),%g=$p(%f,"(")
  ..  i $g(f(%g))=0 s %f="" q
  ..  i $d(f)>2 s %2=$o(f(0)) i f(%2),'$d(f(%g)) s %f="" q
  ..  i '$d(%wMail) s %wMail=$l($t(^wMail))
  ..  i %wMail,1_$$w^wMail(%mMindex,%r) q:%cancel
  ..  
  .i %f_")))"'["))))" s %f="",%r="" q
  .s %g=$e($p(%f,"("),2,99),%sel=1
  .i $l(%xmsm),%xmsm["%sel"  x %xmsm q:'%sel
  .i $l(%xmsm),%xmsm'["%sel" s %sel=0 d  q:'%sel
  ..  f o=1:1:$l(%xmsm," ") i %g=$p(%xmsm," ",o) s %sel=1 q
  .   ;
  .s ^ooMX(%USID,"gr",%g,timeStmp,%mMindex)=%r
  .i '%mMindex k @%f s %nnn=%nnn-1 q
  .i $d(@%f)#10=1 q:%mode["j"!(@%f=%r&(%r'["=FE"))
  .i %r["=FE",%r'[$c(254) s %rr=%r,%r="" f %=1:1:$l(%rr) d  s %r=%r_%1
  .. s %1=$e(%rr,%) q:%1'="="
  .. n a,b s a=$e(%rr,%+1),b=$e(%rr,%+2) i a_b="FE" s %1=$c(254),%=%+2 q
  .. s a=$s(a="A":10,a="B":11,a="C":12,a="D":13,a="E":14,a="F":15,1:a)
  .. s b=$s(b="A":10,b="B":11,b="C":12,b="D":13,b="E":14,b="F":15,1:b)
  .. s %1=$c(a*16+b),%=%+2
  .q:%mode["k"  s @%f=%r,%nnn=%nnn+1 ;; k=kontrole
  q
grErr s $zt=""
 n o i $zv["Ca"!($zv["IRIS") x "s o=$zeof" i o<0 c %file q
 s ^ooMX(%USID,"gr")=$g(oDelay)+1_"sec. "_%file_" ERROR: za="_za_" "_$g(^ooMX(%USID,"gr"))
 d Close
 s $zt=""
 q
erGR s $zt=""
 d Close
 i $e(%file)'="^" s %X=$e(%file)_":" w $$DiList^USDOS(3,4)
 g %GR^USDOS
DKSERsav 
 ; save of globals (gList) to  DOS-file (%file) if <DKSER>!!!only
 ;---------------variant 1.---------
 ;  d save^USDOS                         ;  start of the program
save1 s %file=0,%MET=1,%RL=""
save2 s %file="C:\mm.ggg"                 ;  DOS-file
save3 s gList="mM Banka"                 ;  glob.list
save4 d %GS^USDOS
 q
GSave(gList,%file) 
 s %file=0,%MET=1,%RL=""
 d %GS^USDOS
 q
readTXT(%USID,%file,h1,h2,max) 
 ; read %file into ^oreadTXT(%USID)
 n n,r,r1,%,o,zr k ^oreadTXT(%USID) s zr=$zr,h1=$g(h1),h2=$g(h2),max=$g(max),^oreadTXT(%USID)=%file
 s:$zv'["MiniM" $zt="errReadT^USDOS"
 if $zv["Ca"!($zv["IRIS") open %file:("RS"::$CHAR(13)_$CHAR(10)):2 u %file if 1
 else  d OpenUse
 s ^oreadTXT(%USID)=^oreadTXT(%USID)_"  "_$p
 i $zv["MS" f n=1:1 r r q:$zc<0  s ^oreadTXT(%USID,n)=$tr($s($l(r)<500:r,1:$e(r,1,510)),h1,h2) i max>0,n>max q
 i $zv'["MS" f n=1:1 d  q:$zeof!(r1<0)  i max>0,n>max q
 . s r1="",r=""
 . f %=0:1:31000 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10,o=13 s r=$e(r,1,$l(r)-2) q
 . s:% ^oreadTXT(%USID,n)=$s($l(h1):$tr(r,h1,h2),1:r)
 i $zv'["MS",$zv'["Ca",$zv'["IRIS" f n=1:1 d  q:$zc<0  s:% ^oreadTXT(%USID,n)=$tr(r,h1,h2) i max>0,n>max q
 . s r1="",r=""
 . i h2=-13 f %=0:1:31333 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10 s r=$e(r,1,$l(r)-1) q
 . i h2+13 f %=0:1:31333 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10,o=13 s r=$e(r,1,$l(r)-2) q
 s ^oreadTXT(%USID)=^oreadTXT(%USID)_"  "_n-1
 d Close
 q
ReadTXT(%file,zr,h1,h2,max) 
 ;mx  read fileTXT into @zr
 s ^oERROR("ReadTXT",0)=$h_" "_%file_" "_zr
 q:"^o ^|"'[$e(zr,1,2)
 s:$zv'["MiniM" $zt="errReadT^USDOS"
 n n,r,r1,%,o k @zr s h1=$g(h1),h2=$g(h2),max=$g(max),%=0
 d OpenUse
 s ^oERROR("ReadTXT",0)=^oERROR("ReadTXT",0)_"  "_$p
 i $zv["MiniM" f n=1:1 r r q:$zeof  s @zr@(n)=$e($s($l(h1):$tr(r,h1,h2),1:r),1,510) i max,n>max q
 i $zv["MS" f n=1:1 r r q:$zc<0  s @zr@(n)=$e($s($l(h1):$tr(r,h1,h2),1:r),1,510) i max,n>max q
 i $zv["Ca"!($zv["IRIS") f n=1:1 d  q:$zeof!(r1<0)!(%>31332)  i max>0,n>max q
 . s r1="",r=""
 . f %=0:1:30000 s o=r1 r *r1 q:$zeof  i r1>0 s r=r_$c(r1) i r1=10,o=13 s r=$e(r,1,$l(r)-2) q
 . s:% @zr@(n)=$s($l(h1):$tr(r,h1,h2),1:r)
 s ^oERROR("ReadTXT",8)=$h_" "_(n-1)
 s @zr=n-1
 d Close
 s ^oERROR("ReadTXT",9)=$h_" "_(n-1)
 q
errReadT s $zt=""
 s:% @zr@(n)=$e($s($l(h1):$tr(r,h1,h2),1:r),1,$zv'["MS"*31_510) 
 n o s $zt="errReadE^USDOS"
 i $zv["Ca"!($zv["IRIS") x "s o=$zeof" i o<0 s @zr=n-1 c %file q
 d Close
 s ^oERROR("ReadTXT",9)=$h_" "_(n-1)
 s ^oERROR("ReadTXT",8)=" ERROR: "_$ze
 s @zr=^(8)
 q
errReadE s $zt=""
 i $g(zr)["^" s @zr=$g(n)-1 
 d Close
 q
txt2glob(zr) 
 s:'$d(zr) zr="^oFileTXT"
 f %=3:2 q:'$d(@zr@(%))  s i=^(%),r=^(%+1) x:$e(i)'="^" "s o=% f %=o:1:o+9 i $e($g(^(%)))=""^"" s i=^(%),r=^(%+1) q" d:$e(i,$l(i))'=")"  i $e(i)="^",i_12[")12" s @i=r
 . s o=% f %=o+1:1:o+5 i $d(^(%+2)),$e(^(%))'="^" s i=i_" "_^(%),r=^(%+1) q:$e($g(^(%+2)))="^"  q:i_12[")12"
 q %
TXTtoXML(%USID,sss,zr) 
 ; read file.XML into glob: @zr
 s b=-1 n win1257,code1257 s win1257=0 k ^oXMLo(%USID),^oTEST m ^oXMLo(%USID)=^oXMLo1(%USID) m ^oTEST=^oXMLo1(%USID) k ^oXMLo1(%USID)
 s code1257=" 240.253 226.198 231.241 237.243 251.221 238.216 199.240 205.244 200.211 207.246 194.181"
 s h1=$g(h1),h2=$g(h2),max=$g(max),%=0,x=0,row=1,bit=0,wide=0,bb=0,rr=""
 k @zr,ERR s b0=0,r=0,i="",iii=0,rrr="",ttt="",e="",start=0,L=0,r0="0",r1="0",x="",t="",%r0=0
 f b=0:1 d  q:r<0
 . i $l(rr)<15 s %=$q(^oXMLo(%USID)) i $l(%),$qs(%,1)=%USID s rr=rr_@% k @%
 . s %r1=%r0,%=$e(rr),rr=$e(rr,2,99999) ;; r *% i $zv'["Ca",%<0 q
 .  ;; i %="{",rr>127,rr<257,$e(rr,4)="}" s %=$c(+rr),rr=$e(rr,5,99999)
 . i %="" s r=-1 q
 . s %r=%,%=$a(%)  q:"-10-13-9-8-"[(-%_"-")  s %r0=%
 . s:$d(@sss@(%)) %r=@sss@(%) 
 . i %r="{",rr>127,rr<256,$e(rr,4)="}",$e(rr,5)="{" s %2=$g(@sss@(+rr_+$e(rr,6,8+1))) s ERR($tr(+rr_+$e(rr,6,8+1),"{"))=%2_"   "_rr i $l(%2) s (%,%r0)=+rr_+$e(rr,6,8+1),rr=$e(rr,$l(%)=7+10,99999),%r=%2
 . i %r="{",rr>127,rr<256,$e(rr,4)="}",$e(rr,5)'="{" s %2=$g(@sss@(+rr)) i $l(%2) s (%,%r0)=+rr,rr=$e(rr,5,99999),%r=%2
 . i %r="{",rr>127,rr<256,$e(rr,4)="}" s %2=$g(@sss@(+rr)) i $l(%2) s (%,%r0)=+rr,rr=$e(rr,5,99999),%r=%2
 . d:win1257&(%>150)  s:%r="<" start=1 q:'start  s r1=r0,r0=r,r=%r i r'=" "!$l(rrr) s rrr=rrr_r
 .. s o=$f(code1257," "_%_".") s:o>1 %r=$c($e(code1257,o,o+3)) s:o<1 ttt=ttt_-%_"?"
 . i rrr["1257",(rrr["WINDOWS-1257")!(rrr["windows-1257") s win1257=b
 . i $l(i) s:r'=">" i=i_r i ">"=r s:i'["/" $p(iii,",",L)=$p(i," ") i i[" "&(i'["/") s @zr@(b,L,iii,0)=rrr s rrr="",t="",L=L-1,i="" q
 . i r0="<",r'="/" s i=r,L=L+1 q
 . i $l(e) s:r'=">" e=e_r i r=">" s e="",start=0,iii=$p(iii,",",1,L) s:iii="" iii=L q
 . i t["-1257",t["WINDOWS-"!(t["windows-") s win1257=b
 . i $l(t)>32000 s r0="/>",r="",t="--ERROR--"_t
 . i r0_r="/>" s e="",$p(iii,",",L)=i s:$l(t) @zr@(b,L,iii)=t s L=L-1,i="",rrr="",t="" q
 . i r0_r="</" s e="</" s:$l(t) @zr@(b,L,iii,e)=t s L=L-1,i="",rrr="",t="" q
 . s:r=">" i="",e="" i '$l(e),'$l(i),"<>"'[r,r'=" "!$l(t) s t=t_r ;; s:%>150 t=t_%
 s @zr=b
 ;; d Close
 ;; s ^oERROR(%USID,"ReadXML",9)=$h_" "_(b-1)
 q
korrTXT(zr) 
 q ""
glo2rout(zr) 
 n n,Rout,oo,t,nn s n=2,oo="",nn=0 k ^r m ^r=@zr k ERR
 f  q:'$d(@zr@(n+1))  d
 . s n=n+1,t=@zr@(n) q:"*************  ;; "[t
 . i t'[" ",'t s Rout=$p(t,"^") s:Rout["(" Rout=""
 . q:'$l(Rout)
 . i $zv'["MiniM" x "zr  f  s n=n+1,t=$g(@zr@(n)) s:$l(t)>255 ERR(Rout,n)=$l(t)_t s:$l(t)>250!(t["" ;"")!(t[""%mxWarn"")!($zv[""MS"") t=$$Uu^MXF(t) zs:'$l(t) @Rout q:'$l(t)  zi t s nn=nn+1"
 . i $zv["MiniM" n r x "f n=n+1:1 s t=$g(@zr@(n)) s:$l(t)>250!(t["" ;"")!(t[""%mxWarn"") t=$$Uu^MXF(t) q:'$l(t)  s nn=nn+1,r(nn)=t" i nn>1,$$SAVE^%R(Rout,$na(r)) d compile^%RCOMPIL(Rout)
 . s oo=oo_Rout_":"_nn_" ",Rout="",nn=0
 q oo
listOfZN(xxx) 
 n oo,o,n,ns,%,%B s n="",oo="",%B=$c(254)
 i $zv["MiniM" s o=$v("db",15) f %=1:1:$l(o,"*") s ns=$p(o,"*",%) i ns'["%" s oo=oo_%B_ns,n=n+1
 x:$zv["Ca"!($zv["IRIS") "f %=1:1:$zu(90,0) s ns=$zu(90,2,0,%)  i ns'[""%"" s:%B_oo_%B'[(%B_ns_%B) oo=oo_%B_ns,n=n+1"
 ; ^%GD 
 q n_oo
ReadByte(%file) 
 n %,zr s:$zv["MiniM" %file=$tr(%file,"/","\") s zr="^oBytes(%USID)" k @zr,^mxMonito(%USID,"ReadBytJ")
 i $zv["Ca"!($zv["IRIS") x "s o=$zu(140,1,%file),zu=$s(o=-2:""file not found"",o=-3:""path not found"",o=-5:""access denied"",o=-12:""invalid access"",1:o)" i o'=zu q 0
 j ReadBytJ(%USID,%file) f %=0:1:99 q:$g(^mxMonito(%USID,"ReadBytJ"))  h .1 h:%>97 1
 ;; s ^mxMonito($$pD^MXD($h,2),3_%USID,"ReadBytJ")=%file_-%
 q $g(@zr,-%-1)
ReadBytJ(%USID,%file,zr) 
 s $zt="ReadBytE^USDOS"  s:'$d(zr) zr="^oBytes(%USID)"  ; read bytes
 d OpenUse s ^mxMonito($$pD^MXD($h,2),1_%USID,"ReadBytJ")=%file_" "_$t
 k @zr s ooo="",b=0
 f %=1:2 s b=b+1 r *r q:r<0  q:$zeof  s $e(ooo,%,%+1)=$e("0123456789ABCDEF",r\16+1)_$e("0123456789ABCDEF",r#16+1) s:%>30000 @zr@(b)=ooo,ooo="",%=-1
ReadBytE s:b>15000 @zr@(b)=ooo s @zr=$s(b>15000:-b,1:ooo)
 s ^mxMonito(%USID,"ReadBytJ")=b
 d Close
 q
ReadBMP(%file,zr,filtr) 
 ; mx  read file.BMP into @zr
 s:'$d(zr) zr="^oBMP" s ^oERROR("ReadBMP",0)=$h_" "_%file_" "_zr
 q:$e(zr,1,2)'="^o"  k @zr k b s b=-1
 s $zt="errReadB^USDOS"
 n b,n,r,r1,%,x,row,r0 k r s h1=$g(h1),h2=$g(h2),max=$g(max),%=0,x=0,row=1,bit=0,wide=0,bb=0
 d OpenUse
 s b0=0,r0=-1 f b=0:1 d  q:$zeof!(r<0)  ;; i max>0,b>max q
 . i b=33 s h=b(23)*256+b(22),b0=b(11)*256+b(10),bit=b(28),wide=256*b(19)+b(18),b4=4-($s(bit=24:3,1:1)*wide#4)#4
 . r *r q:$zeof  q:r<0  i bit=24,b0 r *r2  r *r3 s r=(r+r2+r3)\3_":"_r_":"_r2_":"_r3 
 . s:b<33 b(b)=r i b0,b'<b0 s x=x+1 s:x>(wide+b4) x=1,row=row+1,r0=-1 s:$d(filtr) r=r<filtr s:r'=r0 @zr@(-row,x)=r,r0=r,bb=bb+1
 s @zr=b
 d Close
 s ^oERROR("ReadBMP",9)=$h_" "_(b-1)
 q
errReadB s $zt="",b=+$g(b)
 i $g(zr)["^" s @zr=b-1 
 d Close
 q 
ReadXML(%USID,%file,zr,filtr) 
 ; read file.XML into glob: @zr
 s ^oERROR(%USID,"ReadXML",0)=$h_" "_%file_" "_zr
 k @zr s b=-1 n win1257,code1257 s win1257=0
 s code1257=" 240.253 226.198 231.241 237.243 251.221 238.216 199.240 205.244 200.211 207.246 194.181"
 s $zt="errReadX^USDOS"
 s h1=$g(h1),h2=$g(h2),max=$g(max),%=0,x=0,row=1,bit=0,wide=0,bb=0
 d OpenUse
 s b0=0,r=0,i="",iii=0,rrr="",ttt="",e="",start=0,L=0,r0="0",r1="0",x="",t="",%r0=0 ;;k ^xml
 f b=0:1 d  q:r<0
 . s %r1=%r0 r *% i $zv'["Ca",$zv'["IRIS",%<0 q
 . i $zv["Ca"!($zv["IRIS"),%<0!$zeof s r=-1 q
 . q:"-10-13-9-8-"[(-%_"-")  s %r0=% i %r1_%="196187" s t=$e(t,1,$l(t)-1)_"{315}" q
 . ;; i %r1_%="199205" s t=$e(t,1,$l(t)-1)_"{..199.205..}" q
 . s %r=$c(%) d:win1257&(%>150)  s:%r="<" start=1 q:'start  s r1=r0,r0=r,r=%r i r'=" "!$l(rrr) s rrr=rrr_r
 .. s o=$f(code1257," "_%_".") s:o>1 %r=$c($e(code1257,o,o+3)) s:o<1 ttt=ttt_-%_"?"
 . i rrr["1257",(rrr["WINDOWS-1257")!(rrr["windows-1257") s win1257=b
 . i $l(i) s:r'=">" i=i_r i ">"=r s:i'["/" $p(iii,",",L)=$p(i," ") i i[" "&(i'["/") s @zr@(b,L,iii,0)=rrr s rrr="",t="",L=L-1,i="" q
 . i r0="<",r'="/" s i=r,L=L+1 q
 . i $l(e) s:r'=">" e=e_r i r=">" s e="",start=0,iii=$p(iii,",",1,L) s:iii="" iii=L q
 . i t["-1257",t["WINDOWS-"!(t["windows-") s win1257=b
 . i $l(t)>32000 s r0="/>",r="",t="--ERROR--"_t
 . i r0_r="/>" s e="",$p(iii,",",L)=i s:$l(t) @zr@(b,L,iii)=t s L=L-1,i="",rrr="",t="" q
 . i r0_r="</" s e="</" s:$l(t) @zr@(b,L,iii,e)=t s L=L-1,i="",rrr="",t="" q
 . s:r=">" i="",e="" i '$l(e),'$l(i),"<>"'[r,r'=" "!$l(t) s t=t_r ;; s:%>150 t=t_%
 s @zr=b
 d Close
 s ^oERROR(%USID,"ReadXML",9)=$h_" "_(b-1)
 q
errReadX s $zt="",b=+$g(b)
 i $g(zr)["^" s @zr=b-1
 d Close
 q 
wrByte(%file,%glob,%len) 
 d OpenUseW
 s z=%glob f n=1:1 s z=$q(@z) q:'$l(z)  s rr=@z d
 . i %glob["^oFileExp(" w rr w:%len ! k @z q 
 . f %=0:2:$l(rr)-2 s FF=$e(rr,%+1,%+2) w $c($zh(FF))
 d Close
 q
WriteDBF(%file,formaDBF,tableDBF,tableDB2,nnnnnDBF,startTab) 
 s ooztoooo=$zt,$zt="WriteDB2^USDOS"
 i $e(tableDBF)="^" s o="",%=tableDBF,tableDBF="" f  s o=$o(@%@(o)) q:'$l(o)  s tableDBF=tableDBF_^(o)  
 i $e(tableDB2)="^" s o="",%=tableDB2,tableDB2="" f  s o=$o(@%@(o)) q:'$l(o)  s tableDB2=tableDB2_^(o)  
 d Close
WriteDB2 n rrrrrDBF,b s $zt="errReadD^USDOS",rrrrrDBF="",b=0,r=""
 i $zv["MS" open 51:(formaDBF:"R"):1 use 51
 i $zv["MiniM" open "|FILE|"_formaDBF:("rte") use "|FILE|"_formaDBF
 i $zv["Ca" open formaDBF:("R"::):1 use formaDBF
 i $zv["IRIS" open formaDBF:("R"::):1 use formaDBF
 i $zv'["MS" f b=0:1:999999 s r0=r,r="" r *r q:$zeof  q:r<0  s:b<9999 rrrrrDBF=rrrrrDBF_$c(r)
 i $zv["MS" f b=0:1:999999 s r0=r,r="" r *r q:$zc<0  s:b<9999 rrrrrDBF=rrrrrDBF_$c(r)
WriteDB x "n %FILE s %file=formaDBF h 1 d Close"
 s ^oERROR("ReadDBF",9)=$h_" "_(b-1),$zt=ooztoooo
 d OpenUseW
 s $e(rrrrrDBF,5)=$c(nnnnnDBF#256)
 w $e(rrrrrDBF,1,$s($g(startTab):startTab,1:225)),tableDBF,tableDB2,$c(r)
 d Close
 q
errReadD s $zt=$g(ooztooo) g WriteDB+1
 q
Close close $s($zv["MS":51,$zv["MiniM":"|FILE|"_%file,1:%file)
 q
OpenUse i $zv["MS" o 51:(%file:"R"):0 u 51
 i $zv["GT" o %file:"RS":1 u %file
 i $zv["Ca" o %file:("RS"::$CHAR(13)_$CHAR(10)):2 u %file
 i $zv["IRIS" o %file:("RS"::$CHAR(13)_$CHAR(10)):2 u %file
 i $zv["MiniM" open "|FILE|"_%file:("rte") u "|FILE|"_%file
 q
OpenUseW i $zv["MS" o 51:(%file:"NW"):1 use 51 q
 i $zv["Ca" o %file:("NWS"::):1 use %file q
 i $zv["IRIS" o %file:("NWS"::):1 use %file q
 d OpenUse
 q

USE
USE ; MX select [ 01/10/2006  10:31 PM ]  ;[ 20160329 20:48:04 ]
 ; NiniM, MSM, CACHE, GT.M
 ; vmx Copyright(c) SIA ENTERS  2005-2016
yx(y,x,c) 
 q ""
R 
K 
e0 
E0 
 Q
%zb(h) 
 q ""
%zbr(r,h,y,x) 
 q:%j ""
 q r
ws(%zR,%yY,%xX,%4,%5) 
 k %v n %LineS  s %USPR=$g(%USPR,%USID)
 n %,%y0,%z0,%zRw,%y,%yM,%x,%xM,%w,%co,%0,%rest,%Scr,%z s %Scr="ws"
 s %co(1)=120,%co(3)=202,%co(0)=""
 x "s %zRw=$zr,%yY=$g(%yY,1),%xX=$g(%xX,1),%rest=1,%zb=0,%0=2"
 s %xM=$p(%xX_-79,"-",2),%yM=$p(%yY_-24,"-",2),%yY=+%yY,%xX=+%xX
 s:%yY<0 %yY=0 s:%xX<0 %xX=0 s:%yM>24 %yM=24 s:%xM>79 %xM=79
 n %zbR s %zbR=""
 d:'%j e0 x $g(%5)
 s:$g(%4)="" %4=206 s:+%4?3n %4="s %=$$yx("_%4_")" x %4
 i %zR?1.8e1"^".e,%zR'["(" n t d  s %zR="%w"
 .f %y=1:1 x "s t=$t("_$p(%zR,"^")_"+"_%y_"^"_$p(%zR,"^",2)_")" s t=$p(t,";",2) q:t=""  d
 ..s %=$p(t," ") s:%'="" %w(%y,%)=$p(t," ",2,999) q
 s %z=$g(^US("$$ws^USE",%USPR,%zR),$q(@%zR)) q:%z="" ""
 s:'$d(@%z) %z=$q(@%zR)
 s %=%zR,%y=%yY
 f %LineS=0:1 s %=$q(@%) q:%=""  s:%y<%yM %y=%y+1 d
 .  s %LineS(%LineS+1,1)=%,%LineS(%LineS+1,2)=@%
 s %yM=%y-1
 d e0
 k wsKey,wsLine,%vb
 ;  mxm -----------------------
 i %j d  q ""
 .s wsLine=+$g(^US(%USID,"ws^USE",%zR))
 .k %v,%ws,%wz,%zb s wsKey=$tr(wsKey,"RP-K","rp-k")
 .i '$g(wsLine) s %zb=27 q
 .s (%wz,%ws("$zr"))=%LineS(+wsLine,1),%zb=13
 .s (%ws(1),%ws)=$$%ws1(%wz)
 .s %v(%ws)=$s(wsKey["p":1,1:1,1:1,1:1,wsKey["r":"re",1:0)
 .i $zv'["Ca",$o(@%zRw)'="" i $o(@%zRw,-1)
 g %rest
%ws1(%wz) 
 q ""
l(%d,%col) 
 q ""
wl(%col) 
 q ""
pg(z,%d) 
 q ""
w1j(%USID,%n) 
 q
wj(%USID,%mEt) 
 q
w(%mEt,y0,x0,%20x,%rest) 
 q ""
%rest 
 q ""
%n(%q,%N) 
 q ""
wyx 
 q
n(%1,%2) 
 n %,%n,%3 f %=1:1:%ff i f(%)=%1 s %3=%f,%f=% d wyx s %f=%3 q
 q:$d(%2) %2  q $g(@%1)
%k(%QW,%k) 
 q ""
k 
 q
var(%QW,V) 
 Q ""
se(%zr,%x,gs,gk,y0,x0,%r,%8,gSEL,%10) 
 ; 2-%x      what found...
 ; 3-gs      g2_g3_(ind1)_g7_(ind3)      (x "s %g="_gs)  
 ; 4-gk
 ; 8-%8      s %SEL(-1)=%8  titul
 ; 9-gSEL    s %SEL(%k)=%g
 ; 10-%10     x %10          start
 n %1,%2,%k,%g,f,f0,%n,%file,%if,%LATV,%latv,%B
 k %SEL
 S %LATV="JQWERTYUIOPASDFGHKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{316}{311}{291}{326}{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}"
 s %LATV=$$Uu^MXF(%LATV_" /.;!#*:""""")
 s %latv=$$Uu^MXF("jqwertyuiopasdfghklzxcvbnmeuia{353}gkl{382}{269}neuialkgn{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}")
 s %B=$c(254),%8=$g(%8) s:%8="" %8="s %SEL(-1)="" ""_%x "
 x $g(%10)
 i $l(%8)>1,%8'["%SEL(" s %8="s %SEL(-1)="_%8
 s (%9,gSEL)=$g(gSEL) s:gSEL="" gSEL="s %SEL(%k)=%g"
 s y0=$g(y0,5),x0=$g(x0,40),%file=$e($p(%zr,"("),2,99)
 i '$d(%XI(%file)),$$x^USX(%file)
 i '$d(@%zr) s %SEL(0)=$NAME(@%zr)_" -nav ..."
 s %zr=$NAME(@%zr),f0=$e(%zr,1,$l(%zr)-1),%r=$g(%r,$c(254)),%if="["
 s:%x[%r %if=$p(%x,%r,2,99),%x=$p(%x,%r)
 i %if="~" s %if="$p(%zr,"")"",2,99)_"".""_$tr(%g,%LATV,%latv)[%x" d
 . s %x=$tr(%x,".~"_%LATV,".~"_%latv) q:%x'["~"
 . s %1=$p(%if,"["),%if=%1_"["""_$p(%x,"~")_""""
 . f %=1:1:$l(%x,"~") s %if=%if_"&("_%1_"["""_$p(%x,"~",%)_""")"
 s:$l(%if)<2 %if="%g"_$e(%if_"[")_"%x"
 s %gs="s %g=" f %=1:1:$l(gs,"_") s %n=$p(gs,"_",%) d
 .i $e(%n)'="(" s %gs=%gs_$$%XG(%file,%n,"@%zr")_"_%B_" q
 .s %n=$p($e(%n,2,99)_")))",")))"),%gs=%gs_$$%XI(%file,%n,"%zr")_"_%B_"
 s %11="__",gs=$p(%gs_%11,%11)
 i $e(%9)="("!%9 s gSEL="s %SEL(%k)=" f %=1:1:$l(%9,"_") d
 .s %n=$p(%9,"_",%)
 .i $e(%n)'="(" s gSEL=gSEL_$$%XG(%file,%n,"@%zr")_"_%B_" q
 .s %n=$p($e(%n,2,99)_")))",")))")
 .s gSEL=gSEL_$$%XI(%file,%n,"%zr")_"_%B_"
 s gSEL=$p(gSEL_%11,%11)
 s:gk'["=" gk="s %k="_$$%XI(%file,gk,"%zr")
 s %n=0 f %count=0:1:999999 s (%zr,f)=$q(@%zr) q:%zr'[f0!($s<1000)  x gs d
 .i @%if x gk s:%k=%g %g="~" i $l(%k),'$d(%SEL(%k)) x gSEL s %n=%n+1
 i %8'=0 s %1=$g(%SEL(-1)) k %SEL(-1) x %8 i $d(%SEL(-1)),%1'="" d
 .s %2=%SEL(-1),%SEL(-1)=%1,%1=$o(%SEL(""))-.1,%SEL(%1)=%2
 k %SEL(-1) q $d(%SEL)
%XG(%f,%n,%r) 
 n % i '$d(%XG(%f)) n %1 s %1=%f d ^USX
 q:%n="" "@%zr"
 i %n q "$p("_%r_",%B,"_+%n_")"
 s %=$p($tr(%XG(%f)," ",","),","_%n_"=$",2) s:%n %=$p(%XG(%f),"=$",%n)
 q "$p("_%r_","_$p(%,",",2)_","_+$p(%,",",3)_")"
%XI(%f,%n,%i) 
 n % s %=+$p($p($g(%XI(%f)),","_%n_"=$",2),",",4) s:%n %=%n
 q "$tr($p($p("_%i_",""("",2,9),"","","_%_"),"""""")"","""")"
%SEL(%zr,%K,%x) 
 ; %x="x %XG(%file) if ...  s o=...   s %SEL(o)=..." ; %R %I %k i1 i2 
 n %1,%2,%k,%0,%file,%I,%R,%B,i1,i2,i3,i4,i5,o,%count
 s %file=$e($p(%zr,"("),2,99) i $$x^USX(%file)
 S %1="JQWERTYUIOPASDFGHKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{316}{311}{291}{326}{1049}{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1066}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}"
 s %1=$$Uu^MXF(%1_" /.;!#*:"""""),%B=$c(254)
 s %2=$$Uu^MXF("jqwertyuiopasdfghklzxcvbnmeuia{353}gkl{382}{269}neuialkgn{1081}{1094}{1091}{1082}{1077}{1085}{1075}{1096}{1097}{1079}{1093}{1098}{1092}{1099}{1074}{1072}{1087}{1088}{1086}{1083}{1076}{1078}{1101}{1103}{1095}{1089}{1084}{1080}{1090}{1100}{1073}{1102}")
 s %k=$tr(%K,%1,%2)
 s %I=$NAME(@%zr),%0=$e(%I,1,$l(%I)-1)
 f %count=0:1 s %I=$q(@%I) q:%I'[%0!($s<3000)  s %R=@%I d  x %x
 . f o=1:1:$ql(%I) x "s i"_o_"=$qs(%I,o)"
 . i $l(%R)=500,$d(@%I@(501)) s %R=%R_$g(^(501)) s %I=$NAME(^(501))
 q %count
wT(a,y,x,l) 
 q ""
clzr(%zr,i) 
 s %=%zr s:$e(%)="^" %=$p(%,"(",2,999),%=$e(%,1,$l(%)-1)
 s %=$p(%,",",i) i $e(%)="""" s %=$e(%,2,$l(%)-1)
 q %

USF
USF ;  [ 04/05/2005  9:16 PM ]  ;[ 20170118 15:33:18 ]
 ; MSM, CACHE, GT.M,  MiniM
 ; MX Copyright(c) SIA ENTERS  2005-2016
yx(y,x,c) 
 q:%j ""
 q:$d(c) $$yx^US(y,x,c) q:$d(x) $$yx^US(y,x) q $$yx^US(y)
qs(%i,%KEY,%N,%d) 
 n %,%I,%n s %I=$qs(%i,0),%N=$tr($g(%N),"~"),%d=$g(%d)
 x:$zv'["GT.M" "f %=1:1:%KEY s %I=$d(@%I@($s(%=%KEY&$l(%N):%N,1:$qs(%i,%)))),%I=$zr"
 q:$d(@%I)#2 %I
 s:%d>0 %=$q(@%I) s:%d<0 %=$$zo500("%I@("""")",-1)
                  s:%d<0 %=$$zo500("%I@("""")",-1)
 i %'[%Zon q %I
 i %'=%I,%'="" s %I=%
 q %I
Zo(%i,%d) 
 n %,%1 s %d=$g(%d,1) s:'%d %d=1
 i %Zon="" i '$d(@("^"_%FILE)) q "^"_%FILE
 s:%i>%KEM!(%i=0) %i=%KEM
 i %i s:%I'["(" %I="^"_%FILE s %i=$p(%I,"(")_"("_$p(%LII,",",1,%i)_")"
 i %i'["("""")" s %i=$NAME(@%i)
 i %i'["(" s %i=%i_"("""")"
 s %=%i f  s %=$q(@%,%d) q:%=""  q:$l(%,",")=%KEM   ;;q:$ql(%)=%KEM
 q:%'[%Zon %I q %
r5(%zr) 
 n %,%R s $p(%zr,"(")="^"_%FILE,%R=$g(@%zr) q:$l(%R)<500 %R
 f %=501:500 q:'$d(@%zr@(%))  q:$l(%R)#500  s %R=%R_^(%)
 q:$d(@%zr)+1 %R
w5(%zr,%R) 
 n %,r i '$d(@%zr),$l(%R)<500 s @%zr=%R q ""
 i $d(@%zr@(501))
 f %=501:500 s r=$e(%R,%,%+499) q:r=""&'$d(^(%))  k ^(%) s:r'="" ^(%)=r
 s @%zr=$e(%R,1,500)
nE q ""
mxFsel(%i0,%N,%K,%SELflag) 
 n %sym,%XG,%nK,%KmxFsel,%,%1,%2,%3,%seZona,o,oo,xoo,%FILE
 k ^ose(%USID),^o60 s %N=$tr(%N,"~")
 s:'$d(%LAT) %LAT=$$Uu^MXF("QWERTYUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326} .:`""")
 s:'$d(%lat) %lat="qwertyuiopasdfghjklzxcvbnmeuiasgklzcneuiasgklzcn"
 s %sym="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM%1234567890"
 s %1=%LAT,%2=%lat n %LAT,%lat s %LAT=%1,%lat=%2
 i $e(%K)="=" q:%K="="  s %K="("_%N_"="""_$p(%K,"=",2,9)_""").."
 i $e(%K,$l(%K))="=" s %K="("_%N_"="""_$p(%K,"=")_""").."
 i %K_"$1$a$s"[("....$1$a$s") q ""
 i %K_"$1$a$s"[("...$1$a$s") s o=%K n %K s %K=$p(o_"$1$a$s","...$1$a$s") q:o="" o  d
 . s o=$tr(%K,%LAT,%lat) s:o="" o=%K,%LAT=0,%lat=0 s %K="($tr(%I_%B_@%I,%LAT,%lat)["""_o_""").."
 s %FILE=$e($p(%i0,"("),2,99) s %KmxFsel=%K
 i $e(%i0)'="^" s (%1,%FILE)=$p(%i0,"(") d ^USX d:"PPR PAV"[%1
 . s o=%FILE_"sp" 
 . i '$d(^AL(%FILE,"%W",%N)),$d(^AL(o,"%W",%N)) s (%1,%FILE)=o d ^USX
 s %="^"_%FILE
 s:$d(%SeZona(%FILE))#2 %=%SeZona(%FILE)
 i %["^" s %seZona=$e($NAME(@%),1,$l($NAME(@%))-1)
 s %=$e(11_%K,$l(11_%K)-1,9999)
 i "::;;"[% d  q:$d(%SEL) ""  s %KmxFsel="1%N.."_%K s:%K="" %K="1%N" s %K=%K_".."
 .s %K=$p($p(%K,"::"),";;") k %SEL i $g(%SELflag),%K="" q  ;;;s:%K=$g(@%N) %K="" 
 .s %=$g(^AL(%FILE,"%W",%N,-2)) q:%=""  x %  q:$g(%SELflag)
 .s o="" f  s o=$o(%SEL(o)) q:o=""  w $$U^MXF(o),$c(9),$$U^MXF(%SEL(o)),$c(4)
 ; F12
 ; 
 k %1
 i $e($p(%K,";"))="[" s $p(%K,"[")="..;$p(%I,""("",2,99)_%R"
 s %nK=" "_%N_" "_$tr(%K,%sym_%K,%sym_"                                                       ")_" "
 s %XG="" f %=1:1:$l(%LG(%FILE),",") s %n=$tr($p(%LG(%FILE),",",%),"~") d
  . s:%nK[(" "_%n_" ") %XG=%XG_" s "_%n_"=$p(%R,%B,"_%_") "
 s:%K["^"!(%LI(%FILE)["~") %XG=%XG(%FILE)
 s:%XG'="" %XG="s %R=@%I s:$l(%R)=500 %R=$$r5(%I) "_%XG
 n %R,%NG,%GM,%nn,%nnn,%I,%I0,%KEM,%NSum,%n2
 n %,%1,%2,%3,%x,%x2,%xx,%xx2,%x1,%xecute,%g,%i
 ;; s %g=0 f %=1:1:$l(%LG(%FILE),",")  i $p(%LG(%FILE),",",%)=%N s %g=% q   ;; i $tr($p(%LG(%FILE),",",%),"~")=%N  s %g=% q
 s %i=0 f %=1:1:$l(%LII(%FILE),",") i $p(%LII(%FILE),",",%)=%N s %i=% q  ;; i $tr($p(%LII(%FILE),",",%),"~")=%N s %i=% q
 s %nn="%nn",%nnn="%nnn",%Nsum="%Nsum"
 s %x1=0,(%xx,%xx2)="",%NSum=0,%GM=$l(%LI(%FILE),","),^US(%USID,"%K")=%K
 f %=1:1:9 s (%x,%x2)=$p(%K,"..",%) d:%x'=""  I %x'="" s %xx=%xx_"("_%x_")&",%xx2=%xx2_"("_%x2_")&"
 .q:%x="1%N"  ;; sorted by %N
 .I %x="-%1" s %x="",%x1=-1 q
 .I %x="?AL" s %x="",%xecute="",(%i,%g)=0 d  q
 .. F %1=1:1:6 s %2=$g(%W(%N,%1)) I %2["%E" s %xecute(%1)=%2
 .I $e(%x,1,2)="//" s %3=$p(%x,"//",3),%2=$p(%x,"//",2),%xecute=%2,(%i,%g)=0 I %3'="" s %xecute=%3 x %2 s %x="" q
 .I $e(%x)="(",$e(%x,$l(%x))=")" s (%i,%g)=0 q
 .I $e(%x)="." s (%x,%x2)="-13509.18_"_%N_"[(-13509.18_"""_$e(%x,2,99)_""")" q
 .I "="[$e(%x) s %x=%N_"="""_$e(%x,2,99)_"""",%x2="%n2[(""^"_$e(%x2,2,99)_"^"")" q
 .s %1=$tr(%x,%LAT,%lat) s:%1="" %1=%x,%LAT=0,%lat=0 s (%x,%x2)="$tr("_%N_",%LAT,%lat)["""_%1_""""
 s %xx=$p(%xx_"&&&&&","&&&&&"),%xx2=$p(%xx2_"&&&&&","&&&&&")
 I %xx="",'$d(%xecute),'$d(%q),$l(%K) q -1
 k ^US(%USID,"mxFsel-1",%FILE) s %x=0
 I %x1=-1 k ^oM3(%USID) m ^oM3(%USID)=^US(%USID,"mxFse",%FILE)
 I %x1=-1 m ^US(%USID,"mxFse-1",%FILE)=^oM3(%USID) k ^oM3(%USID)
 s ^US(%USID,"mxASK",%FILE,%K)=%xx
 f %=1:1:%GM s %NG(%)=$tr($p(%LI(%FILE),",",%),"~") n @(%NG(%))
r2Fsel k ^US(%USID,"mxFsel",%FILE),^US(%USID,"mxFse",%FILE)
 s %I="^"_%FILE_"("""")",%nnn=0,%I0="^",%KEM=$l(%LII(%FILE),",")
 s %KEM=$l(%LII(%FILE),",")
 I $e(%i0)="^" s %=$d(@%i0) i %,%#2=0 s %I=$NAME(@%i0),%I0=$e(%I,1,$l(%I)-1)
 i %KmxFsel'="1%N.." f %nn=0:1 s %I=$q(@%I)  q:%I'[%I0  d:$ql(%I)=%KEM
 .i $d(%seZona) q:%I'[%seZona
 .I %x1=-1 q:'$d(^US(%USID,"mxFse-1",%FILE,%I))
 .x %XG,%XI(%FILE) i $d(^mxConfig("A")),'$$tAccess^US("A",%FILE) q  
 .;; i $d(%XG0(%FILE)) n %K s %XG0=0 f  s %XG0=$o(%XG0(%FILE,%XG0)) q:'%XG0  x %XG0(%FILE,%XG0) i $d(%K) s @($tr($p(%LI(%FILE),",",%XG0),"~"))=%K k %K
 .s %2=@%N
 .I $e(%KmxFsel)="=" s:%2["." %2=$p(%2_".............",".............")
 .s:%2="" %2="-"
 .i %xx'="" s @%N=%2 x "s %="_%xx i '% q:%2'["^"  s %n2="^"_%2_"^" x "s %="_%xx2 q:'%
 .s %NSum=%NSum+%2,@%N=%2
 .I $d(%xecute) x %xecute q:%K'["?AL"  n %xAL,%E,%K  d  q:%E=""
 .. s %E="",%xAL="",%K=@%N
 .. f  s %xAL=$o(%xecute(%xAL)) q:%xAL=""  x %xecute(%xAL) q:%E'=""
 .s %1=%I,%2=@%N q:%2=""  i "D8 d8 "[$p(%LII(%FILE),","),%KmxFsel'["1%N" s %2=0
 .s:$l(%2)>60 %2=$e(%2,1,60)_"__",^o60(%2)=$e(@%N,1,500)
 .I $d(^US(%USID,"mxFsel",%FILE,%2,1))!1 x " s ^("_%LII(%FILE)_")=%1"
 .s %nnn=%nnn+1,^US(%USID,"mxFse",%FILE,%I)=1
 ;
 i %KmxFsel="1%N.." s mxTEST("1%N..")=%i0
 i %KmxFsel="1%N..",%i=2,%i0["^",$qs(%i0,1)?6n s %I=%i0,%I0=$e(%I,1,$l(%I)-1)
 i %KmxFsel="1%N.." f %nn=0:1 s %I=$q(@%I)  q:%I'[%I0  d:$ql(%I)=%KEM
 .i $d(%seZona) q:%I'[%seZona  i $d(^mxConfig("A")),'$$tAccess^US("A",%FILE) q 
 .s:%i @%N=$qs(%I,+%i) x:%XG'="" %XG
 .f %3=1:1:$l(@%N,"^") s %2=$p(@%N,"^",%3) s:$l(%2)>60 %2=$e(%2,1,60)_"__",^o60(%2)=$e(@%N,1,500) d:$l(%2)
 ..s ^US(%USID,"mxFsel",%FILE,%2,%nn_"."_%3_1)=%I
 m ^ose(%USID)=^US(%USID,"mxFsel",%FILE)
 i '$d(^ose(%USID)),%seZona["(" s %seZona="" g r2Fsel
ose 
 q:'$d(^ose(%USID)) "" k ^oseooooo(%USID,-1) i $g(%SELflag) m %SEL=^ose(%USID) q ""
 n o,oo2,o2,oo,op,oMaxRetu,% s o=$NAME(^ose(%USID)),oo=0,oMaxRetu=16000 s:$zv["MiniM" oMaxRetu=7000
 f xoo=0:1 s o=$q(@o),o2="" d  q:o=""  q:$qs(o,1)'=%USID
 . i o'="",$qs(o,1)=%USID s o2=$qs(o,2)
 . i xoo,o2'=oo2 s %=oo2_$c(9)_$s(oo>1:oo,1:@op),^oseooooo(%USID,-1,xoo)=%,oo2=o2,oo=0
 . s oo=oo+1,op=o s:'$d(oo2) oo2=o2
 q:$g(%SELflag)="0" ""
 s o="" f  s o=$o(^oseooooo(%USID,-1,o),-1) q:'o  s oMaxRetu=oMaxRetu-$l(^(o))-2 q:oMaxRetu<0
 f  s o=$o(^oseooooo(%USID,-1,o)) q:'o  w $$U^MXF(^(o)),$c(4)  
 q ""
oseGet(node) 
 n o,oo,ll i '$d(node) g oseGetAl
 i '$d(^ose(%USID,node)) s o=$o(^ose(%USID,node)) q:o'[node $NAME(^ose(%USID,node))  s node=o
 s o=$NAME(^(node)),ll=0
 f  s o=$q(@o) q:o=""  q:ll>15000  q:$qs(o,2)'=node  q:$qs(o,1)'=%USID  d
 . s oo=$$zoIR^USX(@o,0),ll=ll+$l(oo)+2 i ll<15000 w $$U^MXF(oo),$c(4) k @o
 q $c(4)
oseGetAl ; get all
 q:'$d(^ose(%USID)) $NAME(^ose(%USID))  
 n o,oo,ll s o=$NAME(^ose(%USID)),ll=0
 f  s o=$q(@o) q:o=""  q:ll>15000  q:$qs(o,1)'=%USID  d
 . s oo=$$zoIR^USX(@o,0),ll=ll+$l(oo)+2 i ll<15000 w $$U^MXF(oo),$c(4) k @o
 q $c(4)
F6f 
RET 
FouStart 
vF ; mv
FOUND 
vFnext ; mv
FoundF12 
 q
%XG(%f,%n,%r) q:'$d(%XG(%f)) %n
 n % s %=$p(%XG(%f),","_%n_"=$",2) s:%n %=$p(%XG(%f),"=$",%n)
 q "$p("_%r_","_$p(%,",",2)_","_+$p(%,",",3)_")"
%XI(%f,%n,%i) q:'$d(%XI(%f)) %n
 n % s %=+$p($p(%XI(%f),","_%n_"=$",2),",",4) s:%n %=%n
 q "$tr($p($p("""_%i_""",""("",2,9),"","","_%_"),"""""")"","""")"
key 
 s %KEM=$l(%LII,","),%KEY=$l($p(","_%LII_",",","_%N_","),",")
 S:%KEY>%KEM %KEY=0 s:%KEY %NEW=%KEY
 q
zo500(%i,%d) 
 i %d'<0 s %=$q(@%i) s:%'[%Zon %=%i q %
 s %=%i
 i $zv'["GT" f  s %=$q(@%,%d) q:%=""  q:$ql(%)=%KEM
 i $zv["GT" f  s %=$q(@%,%d) q:%=""  q:$l(%,",")=%KEM
 i %'[%Zon s %=%i
 q %
 q

USMENU
USMENU ; US*  [ 01/10/2006  10:43 PM ]  ;[ 20070324 17:08:44 ]
 ; M3-LITE, MSM-4.4x, CACHE-3x..5x, GT.M-5x
 ; Soft-in-cell  MX Copyright(c) SIA ENTERS  1997-2007
yx(y,x,c) 
 q:%j ""
 q:$d(c) $$yx^US(y,x,c) q:$d(x) $$yx^US(y,x) q $$yx^US(y)
m1xx(%) d %M q ""
%M1xx(%USID) 
 s %=$$RestMem^USX(%USID,"menu"),%=%menu
 ; JV
%M ; MENU - select 1 (with passw.), %=parametr !
 s $p(%,"\",5)=%USPR,%menu=%
%M2 
 I '%j,$zv["MSM" x "u $p:(:::::1)"
 k YY,x1,x2,y1,y2,S,%ZN,%ZN0
 I $zv["MSM" d
 .n a1,a2,a3,a4 s a1="Esc",a2="F2",a4="F9",a5="F10",a3="F5"
 .w:'%j $$w^USE("                               return?.a1 mMail?.a3 FILE?.a4 exit?.a5",24,1)
 F %=1:1:9 X "k %"_%_"  S %"_%_"=$P(%menu,""\"","_%_")"
 f YY=3:1 q:YY+$l(%menu," ")>(23-YY)
 S %ZN=$tr(%5,"^") S:%ZN="" %ZN=%USPR,$p(%menu,"\",5)=%ZN
 s %3=107
 s y1=$p(%2,"[",2),x1=$p(%2,";",2),y1=YY+1*'y1+y1
 f  s y2=y1+$l(%4," ")+2 q:y2<24  s y1=y1-1
 S x2=+$p(%2,";",4) s:'x2 x2=x1+30 s %=x2-x1+1 s:x2>79 x2=79,x1=x2-%
 w:'%j $$w^US(y1,x1,y2,x2,"b")
 i $zv'["GT.M" x "w:'%j $$yx(y1,x1+3),%1,""--"",$zu($zv[""Ca""*5),""--"",%ZN"
 F YY=1:1 S %0=$P(%4," ",YY) Q:%0=""  D
 .S %9=$T(@%0^@%ZN) S:$L(%9,"\")>4!(%9'[";\") %9=""
 .S:%9'="" $P(%4," ",YY)=%0_"^"_%ZN S:%9="" %9=$T(@%0)
 .I %9="" S %9="^"_$G(^AL(%0,"NAME")),YY(YY,3)="__^"_%0_"___"
 .E  S %9=$P(%9,"\",2,3),YY(YY,3)=%0
 .S YY(YY)=YY+y1,YY(YY,1)=%0,YY(YY,2)=$E(%9,1,x2-x1-7)
 .i %j,YY(YY,2)["izeja" s YY(YY,2)="(HIDE)"
 .s YY(YY,"c")=%3 s %=$$%lw(YY,x1,x2,107) Q
 S YY("max")=YY,%0=$g(^US(%USID,"%MENU",%menu,0),1)
 i '$d(^menu(%USPR)) s oo=$p(%menu,"\",4) f o=1:1:$l(oo," ") d
 .  s ^menu(%USPR,o)=%B_$p(oo," ",o)_%B_$p(%menu,"\")
 f YY=1:1:99,1 q:$g(YY(YY,1))=%0
 s %menuY0=YY
 i '%j d %L F  D  Q:13.27[%zb  d %L
 .s R=$$%zbr^USE("") S %3=$E(%zb,5,6)  
 .I +%zb=133 s R="s o=$$KALK^USF(40)",%zb=13 q
 .i %zb="0134" c 1 o 1 u 1 d ^%RE     q
 .i %zb=277984 d mMailF9^USDOS  s %zb=0 q
 .i %zb=277988 s R="d ^USDOS",%zb=13  q
 .i %zb=277989 d EXIT^USMENU          q
 .I "-127-8-279168"[-%zb              q
 .I %zb=13 s:R="" R=YY                q
 .I -%zb[-27,%3=65!(%3=66)  d         q
 ..w $$%lw(YY,x1,x2,107)
 ..S YY=YY-(%3=65)+(%3=66) S:YY=YY("max") YY=YY("max")-1 s:'YY YY=1
 .q  
 ;  mv
 ;;;;;;;;;zw %j r rrrrrr
w7xx i +%j=7 d  q
 .;;w "<html><title>menu</title>",!
 .;;w "<body>",!
 .k %XD82 i $$d8^MXD
 .w "<h5 align=""center"" >",$g(%XD82),"</h5>",!
 .;;w "<h5 align=""right"" >",$zu(0)," ",$zv,"</h5>",!
 .;;w "<h2 align=""center"" >",$$o^MX(%FIRMA),"</h2>",!
 .;;w "<h2 align=""center"" >",$$d8t^MXD($g(%XD82)),"</h2>",!
 .w "<table border=""1"" width=""90%"" align=""center"" >",!
 .w "<colgroup><col align=""right""><col span=""4"" align=""center"">"
 .w "</colgroup>",!
 .;;m ^mxv("YY")=YY
 .f o=1:1:99 q:'$d(YY(o))  d
 .. w "<pre><tr bgcolor=""khaki"" >"
 .. w "<td>",$$o^MX(YY(o,1)),"</td>"
 .. w "<td>",$$o^MX(YY(o,2)),"</td>"
 .. ;;w "<td>",$$o^MX(YY(o,3)),"</td>"
 .. w "</tr></pre>",!
 .w "</table>",!
 .;;w "</body></html>"
 q:%zb=27
 q:"."[R
SaveAndH 
 i R_"^^"["^^^",%j d  g %Mret
 .i $$%MSAVE(YY)
 .s ^JOB(%USID,"STOP")=1 f  h 1  q:'$d(^JOB(%USID,"STOP"))
 .h:'$d(^JOB(%USID))
 ;  mv
 I R Q:'$d(YY(R))  S YY=+R,R=$P(%4," ",+R)
 i R'[" " s:$e(R)["^" R=$e(R,2,99)
 I R[" ",%j  s o=$$%MSAVE(YY) x R             g %Mret
 I R[" " s o=$$%MSAVE(YY) x R                 g %Mret
 i R'["(",R'["," x "s %=$t("_R_")" i %'="" d  g %Mret
 . s o=$$%MSAVE(YY) d @R s %zb=0
 s o=$$%MSAVE(YY) i $d(^AL(R)),'R s o=$$Enter^USb(R)  halt:%j   g %Mret
 s o=$$ALR^USX(R) g %Mret
 q
RestMenu(%J,%menu) 
 s %=$$RestMem^USX(%J,%menu)
 q %menu
%Mret 
 S %MENU=+$O(^US(%USID,"%MENU",999),-1) q:%MENU<1
 s %menu=$g(^US(%USID,"%MENU",%MENU))
 k ^US(%USID,"%MENU",%MENU)
 g %M2
%MSAVE(y) 
 s %MENU=$o(^US(%USID,"%MENU",9999),-1)+1
 s:R'["EXIT" ^US(%USID,"%MENU",%MENU)=%menu,^(%menu,0)=YY(y,1)
 s ^(YY(YY,1))=$g(^US(%USID,"%MENU",%menu,1,YY(YY,1)))+1
 s %Scr=%MENU
 q ""
EXITxx d 00  ;\izeja
 i '%j k ^JOB(%USID) h
 h
00 
 q
%lw(y,x1,x2,c1,c2) 
 Q:'$D(YY(y)) ""   q:'$d(YY) ""
 n %,%3 s %=$g(^US(%USID,"MENU",%menu,1,YY(y,1))),%3=YY(y,"c")
 i '$d(c2) s c2=$s(%>30:247,%>11:207,1:%3)
 i c2<0 s (c1,c2)=3-$e(%3)_(7-$e(%3,2))_(7-$e(%3,3)) d
 .i c2=270 s c2=202 i YY(y,3)'["_^" s c2=242
 W:'%j $$yx(YY(y),x1+1,c1),YY(y,1),$e("_______",1,6-$l(YY(y,1)))
 w:'%j $$yx(c2)," ",YY(y,2),?x2 Q ""
%L q:'$d(YY)  q:'$d(YY(YY))
 n %,%1,x s %1=YY(YY,3),%=%1
 i %1["^" f x=1:1:9,"-" s %=$q(@($tr(%1,"_","")_"("""")"),-1)_x q:%["^"
 w:'%j $$%lw(YY,x1,x2,-1,-1) 
 w:'%j $$yx(YY("max")+y1,4+x1,%3),%,"  ",$e("               ",1,x2-x1-$l(%))
 Q

USOPEN
USOPEN ; ;[ 20160310 22:27:24 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  1997-2016
 ; 
C q
UserDate(%1) 
 q $$NewDate^MXD
NewDate(%1) 
 q:'$d(%1) $$NewDate^MXD()  q $$NewDate^MXD(%1)
icDate(p1,p2) 
 q $$icDate^MXD(p1,p2)
d8(p1,p2) q ""
d9(d,mm) q $g(%DatUMs)
d8plus(d8,p) 
 q $$d8plus^MXD(d8,p)
mnew(m,p) 
 n %
 i p>0 f %=1:1:p s m=m+1 s:m#100=13 m=m+88
 i p<0 f %=1:1:-p s m=m-1 s:m#100=0 m=m-88
 q m
dd(x) n %
 i '$d(x)!$g(x) s %=$$d8(0) q ""
 s %=$$d8 q ""
%XD6 
D s %=$$d8(0) q
d8t(d8,mm) 
 q:'$d(mm) $$d8t^MXD(d8)  q $$d8t^MXD(d8,mm)
ZD q
pD(%H,t) 
 ; CONVERTS %H,$H ==> ggggmmdd hh:mm:ss
 q $$pD^MXD(%H,$g(t))
WeekDay(d8) 
 q $$WeekDay^MXD(d8)
time(h,r) ; Time
 n %1,%2
 s:'$d(h) h=$p($h,",",2) s %1=h\3600,%2=h#3600\60
 i '$d(r) q %1_":"_$e(%2+100,2,3)
 q %1_r_$e(%2+100,2,3)
CleAL 
 q
 ;;;;;;;;;;M-academija;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
x1 s d="06/13/00" w $tr("Dd.Mm.20Yy.g.","Mm/Dd/Yy",d)  ;;; 13.16.2000.g.
 q
x2 s x=12345,$e(x)=""  w x                             ;;; 2345
 q
x3 s x="",$e(x,3)=""   w 1,x,$l(x)                     ;;; 1  2
 q
x4 s x=12345,$e(x,9)=""  w x,$l(x)                     ;;; 12345   8
 q
korobov ; ;[ 11/24/00  12:49 PM ]
 s home=$io
 open 4 s ^OK=0
 u 4 write !,"ATDN3480229;"+$c(13)
 f  read r q:r["OK"  h 1
 u home write "Connected! :",r s ^OK=1
 u 4 w "ATH"+$c(13)
 u home w !,"Disconnected"
 close 4
 q

USPRINT
USPRINT ; US* ; [ 08/01/2005  5:48 PM ]  ;[ 20140228 13:44:16 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX cellSoft Copyright(c) SIA ENTERS  2005-2014
%RUN 
 d R^USOPEN q:%zb=27 
 s %=$$%MMUSER^USX("^M")
 n %W s %W=$c(255) s %VaL=$s(%gm>201400:"EUR",1:"LVL")
 i '$l($g(flgPlusM)) s %="" f  s %=$o(^M(%V,%)) q:%=""  k:$p(%,":",2)=%USID ^M(%V,%) k ^rm(%USID,%V,%)
 i $l($g(flgPlusM)) q:$d(flgPlusM(%V,+%ggmm))  s flgPlusM(%V,+%ggmm)=2 n %ggmm s %ggmm=flgPlusM_":"_%USID_":*" 
 F %FileNum=1:1:33 S o=$p(%V(%V,6)," ",%FileNum) d:o'=""
 . s:o o=$p(o,+o,2,99) s %V(%V,6,$p(o,"^"))=1
 . d %FILE(o)
 d %PRINT
 q
%FILE(o) 
 n %R,%Rout,%FILE k %koko,koko,%SEL ;;s mxCHECK($h_o)=1
 s %FILE=$p(o,"^"),%Rout=$p(o,"^",2) s $p(%R,%B_0,99)=""
 s %=$$%xig^USX(%FILE) X %XG(%FILE)  s %VaL=$s(%gm>201400:"EUR",1:"LVL")
 i $e($g(xmsm),1,6)="%FILE=",xmsm'[%FILE,%FILE'="ciko" q
 i $t(@%FILE^@%Rout)'="" s oo="" d @%FILE^@%Rout q
 s o="StatusBar=1 label "_%FILE_" in rout "_%Rout_" not exist ! "_%V
 s oERROR(o)=%V,mxERROR=o
 q
%PRINT 
 k %koko,koko i $$%PrNode(%V,"^M")
 q
%PrNode(%PrNode) 
 k %d8start,ooLabels
 s:$e(%PrNode)'="^" %PrNode="^"_%PrNode
 d %Ru k ^rM($j,%V) i $l($g(flgPlusM)) s flgPlusM=""
 q ""
%Ru 
%RuRest 
 n %MiT,%Mi,%LGmax,%,%NNN,%NNE,%IT,%V4,%V4L,%V4M,%3,%i
 n %W,%M,%OLD,%Rold,%Mold,%R,%E,%NEW,%NiT,%PrFile,%zr
 s %W=$c(255),%PrFile=$p($g(%PrNode),"(")
 i %PrNode'["(" s %PrNode=%PrNode_"(%V,%ggmm)"
 i %PrNode["%V" s %PrNode=$p(%PrNode,"(")_"(%V,%ggmm"_$p(%PrNode,"%V,%ggmm",2,9) i %PrNode_"0"'[")0" s %PrNode=%PrNode_")"
 i $d(@%PrNode)!1 s %PrNode=$NAME(@%PrNode)
 k %Li
 S (%NNN,%IT)=0
 S %V4=%B_%V(%V,4.1) s:%V(%V,4.2)'="" %V4=%V4_%B_%V(%V,4.2)
 s (%V4L,%V4ML)=$L(%V4,%B),%V4M=%V(%V,4.3)
 s %3=%V(%V,3.1)
 f %=1:1:$l(%3,%B) s %i=$p(%3,%B,%) d
 .s %Mi(%)=%i,%Mi=%,%Mi(0,%)=%PrFile_"("_$tr($p(%3,%B,1,%),%B,",")_")"
 .s %Mi("%E",%)=%Mi(0,%)
 .i $qs(%PrNode,%)'="" n @%i s @%i=$qs(%PrNode,%)  
 .s (%Mi(0,-%),%Mi(1,-%),%Mi(-%))=$s($p(%PrNode,",",%)'="":@%i,1:"")
 .s %OLD(%Mi(%))="",%NEW=""
 s %Mi("%R")="",%Mi("%M")="",%Li=1 d %LiDn
 i %Li<%Mi k %Li q   ;;; dati nav atrasti ..........
 s %Li=%Mi i $o(@(%Mi(0,%Li)))
 f  s %R="" d  q:$g(%Li)<2!'$d(%V)  i %Li<%Mi,%Mi(-%Li)'="" d %LiDn q:%Li<2
 .i %Mi(-%Li)'="" s %R=$g(^(%Mi(-%Li))),%Mi(0,%Li)=$NAME(^(%Mi(-%Li)))
 .i %Mi(-%Li)="" s %Li=%Li-1
 .x:$zv["GT" "s %zr=$r" x:$zv'["GT" "s %zr=$zr"
 .i %Li=%Mi,%PrNode'[$e(%zr,1,$l(%PrNode)-1) s %Mi(-%)="",%Li=0 q
 .i %Li=%Mi,%V(%V,3.5)'="",%R'="" s %i=$o(^(%Mi(-%Li),"")) d  ;;3.5
 ..f  q:%i=""  s %MiT(%Li,%i)=^(%i),%i=$o(^(%i))              ;;3.5
 .i %R="" s %R=$g(%MiT(%Li)),%MiT(%Li)=""
 .i %R'="" d %R q:'$d(%V)  f %=1:1:%Mi s %OLD(%Mi(%))=%Mi(-%)
 .q:$g(%Li)<2  i $o(@%Mi(0,%Li))
 .s %Mi(-%Li)=$o(^(%Mi(-%Li))) s:%Li>2 @(%Mi(%Li))=%Mi(-%Li)
 q
%LiDn 
 n % i $d(@(%Mi(0,%Li)))
 F %=%Li+1:1:%Mi d  i %Mi(-%)="" s %=%-1 q
 .s %Mi(-%)=$o(^(%Mi(-%+1),"")) s @(%Mi(%))=%Mi(-%)
 .i %Mi(1,-%)'="" s (@(%Mi(%)),%Mi(-%))=%Mi(1,-%)
 .q:%Mi(-%)=""
 .s:1+$d(^(%Mi(-%))) %Mi(0,%)=$NAME(^(%Mi(-%)))
 s %Li=%
 q
%R 
 q:%Li<2  n %,%1,%2
 s %M=%Mi(0,%Li)
 s:%Li<%Mi %M=%M_%W
 s %Rold=%Mi("%R"),%Mi("%R")=%R,%Mold=%Mi("%M"),%Mi("%M")=%M
 S %IT=0,%OLD=%NEW,%NEW="",%E=%Mi(%Li)
 s:'$d(%LGmax(%E)) %LGmax(%E)=$l(@%E)+1
 s:$l(@%E)>%LGmax(%E) %LGmax(%E)=%LGmax(%E)+1
 i %V(%V)["?",%Li+1=%Mi,%Mi(%Mi)="%I" s %M=$p(%M,%W)
 i %V(%V,3.5)'="" x "s %=$$rv"_$p(%XV(%V),"$$wv",2)  ;;;;;(3.5)
 f %=3:1:%Mi s @%Mi(%)=$s(%Mi(-%)="":"*",1:%Mi(-%))
 s %1=$p(%V(%V,5),"-")
 f %=1:1:%Mi s %NEW=%NEW_" "_%Mi(%)_"="_%Mi(-%) q:%Mi(%)=%1
 i %V(%V,3.5)'="" s %v=%V(%V,3.5) n %r,%n
 F %=2:1:%V4L s %1=$p(%V4,%B,%) i '%1 s @%1=$P(%R,%B,%) d
 .s:'$d(%LGmax(%1)) %LGmax(%1)=$l(@%1)+1
 .s:$l(@%1)>%LGmax(%1) %LGmax(%1)=%LGmax(%1)+1
 I %V4M'="" S %1="" F %=%V4L+1:1 X "S %1=$O("_%V4M_"(%1))"  Q:%1=""  d
 . X "S "_%V4M_"(%1)=$P(%R,%B,%),%V4ML=%"
 S %2=$g(%MiT(%Li-1))    ;; $$%RsuM
 F %=2:1:$l(%V(%V,4.1),%B)+1,%V4L+1:1:%V4ML d
 . S $P(%2,%B,%)=$P(%2,%B,%)+$P(%R,%B,%)
 i $d(%V(%V,"4.p")) F %=2:1:$l(%V(%V,4.1),%B)+1,%V4L+1:1:%V4ML d
 .s %p=$p(%V(%V,"4.p"),%B,%-1) q:'%p
 .s %1=$P(%R,%B,%),%1=%1-$j(%1,0,%p),$p(%2,%B,%)=$p(%2,%B,%)-%1
 s %MiT(%Li-1)=%2
 i $d(%V(%V,"4.rm")),%V(%V,5)_"-"'[("-"_%E_"-") d
 . s %=$$rm^USX(%Mi("%E",%Li),%V(%V,"4.rm"))
 q:%V(%V,5)_"-"[("-"_%E_"-")
 S %NNE=" " i %M'[%W s %NNN=%NNN+1,%NNE=%NNN
 q:'$d(%Li)
 s %NiT=%E_"."_@%E
 d @(%V_"L^"_%Rout)
 q
%RsuM(%p) 
 q:%M[%W ""
 s %p=$g(%p)
 n %2,%sign S %2=$g(%MiT(%Li-1)) s %sign=$s(%p<0:-1,1:1)
 F %=2:1:$l(%V(%V,4.1),%B)+1,%V4L+1:1:%V4ML d
 .i %p s $P(%2,%B,%)=$P(%2,%B,%)+($P(%Mi("%R"),%B,%)*%sign) q
 .n %n
 .s %n=$p(%V(%V,4.1),%B,%-1),%n=$p(%Mi("%R"),%B,%)-@%n q:'%n
 .s $p(%2,%B,%)=$p(%2,%B,%)-$p(%Mi("%R"),%B,%)+%n
 s %MiT(%Li-1)=%2 k:%M'[%B @%M
 i %p,$d(%V(%V,"4.rm")),%M'[%W!(%p<-1) s %=$$wm^USX(%p)
 q ""
l(%lN,%i) 
 q:$d(%i) $$l^UST(%lN,%i) q:$d(%lN) $$l^UST(%lN) q $$l^UST

UST
UST ;  ; [ 03/28/2005  1:10 AM ]  ;[ 20191011 20:24:39 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2016
 q
NTL ;  summa vardiem (LATVIA) ; kos
 N %,%0,N,NNN,T,TT,B,o   ; %1-ieeja    %2-izeja
 S %2="",B=" " S:%1<0 %1=-%1,%2="m{299}nus "
 s %0=$E($j(%1,0,2)\1+1000000000000,2,99)
 S:'%0 %2="nulle "
 F N=1:3:10 S NNN=$E(%0,N,N+2) I NNN D
 .S T=$$Uu^MXF("viens divi tr{299}s {269}etri pieci se{353}i septi{326}i asto{326}i devi{326}i desmit")
 .S %=NNN\100 S:%>1 %2=%2_$P(T,B,%)_" simti "
 .            S:%=1 %2=%2_$p(T,B,%)_" simts "
 .S TT=$$Uu^MXF("vien div tr{299}s {269}etr piec se{353} septi{326} asto{326} devi{326}"),%=NNN#100
 .I %>19 S %2=%2_$P(TT,B,%\10)_"desmit "_$P(T,B,%#10)_B
 .E  I %>10 S %2=%2_$P(TT,B,%-10)_"padsmit "
 .E  S %2=%2_$P(T,B,%)_B
 .S T=$$Uu^MXF("miljard s i miljon s i t{363}ksto tis {353}i")
 .s %2=%2_$P(T,B,N)_$P(T,B,NNN#10'=1+N+1)_B
 s o=$$Uu^MXF("ertuiopasdfghjklzxcvbnm{275}{363}{299}{257}{353}{291}{311}{316}{382}{269}{326}")
 S $E(%2)=$TR($E(%2),o,$$Uu^MXF("ERTUIOPASDFGHJKLZXCVBNM{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}"))
 q
LS q
nt(N,w,val,p) ;; $132.25 would translate into: "One hundred thirty-two and 25/100-------dollars."  http://www.ehow.com/how_6495403_correct-spell-out-dollar-amounts.html#ixzz1pqytQoxq
 n t,tx,%2,% s w=$g(w),p=$g(p,2)_" "_w,tx="" s:'w w=60_" "_w
 i w["EN" n %1 s %1=N d NTU x "f %=1:1 q:$e(%2)'="" ""  s %2=$e(%2,2,999)" q $e(%2)_$tr($e(%2,2,999),$g(%LAT),$g(%lat))_$s($p(N,".",2):" and "_+$p($j(N,0,2),".",2)_"/100",1:"")_" --- dollars."
 s N=$j(N,0,$s(p:p,1:2)),%=+$p(N,"."),%=$e(%,$l(%)),%=$s(1[%:"s",1:"i") i $d(val) k:val["Lat" val
 s:$g(%gm)<201400 val=$g(val,"Lat"_%_";sant.") s:$g(%gm)>201400 val=$g(val,"EUR;cent")
 s %1=+$p(N,"."),N=$p(N,".",2) s:val="" N=$s('N:"",1:"."_N)
 d
 .i p["RU"!(p["r")!(val[$$Uu^MXF("{1091}{1073}"))!(val[$$Uu^MXF("{1059}{1041}")) d NTR q
 .i p["US"!(p["u")!(N["USD")!(N["$") d NTU q
 .d NTL
 s %=$s(val[";":";",val[" ":" ",1:".")
 i val["cent",N'="" s %2=%2_" "_$p(val,%)_" "_$s(p["US":"and ",1:"")_N_" "_$s(val["EUR":"euro",1:"")_"cent"_$s(N#10=1!(p["US"):"s",1:"i")
 i val'["cent"!(N="") s %2=%2_" "_$p(val,%) s:N'="" %2=%2_" "_N_" "_$p(val,%,2)
 f  q:$e(%2)'=" "  s %2=$e(%2,2,999)
 i p["US" s $p(%2,$p(val,%))=$e(%2)_$tr($e($p(%2,$p(val,%)),2,999),$g(%LAT),$g(%lat))
 q $$trw^UST(%2,"  "," ")
ntRU(s,v) ; {1095}{1080}{1089}{1083}{1086} {1090}{1077}{1082}{1089}{1090}{1086}{1084} RU,  {1074}{1090}{1086}{1088}{1086}{1081} {1087}{1072}{1088}{1072}{1084}{1077}{1090}{1088}: "{1074}{1072}{1083}{1102}{1090}{1072}:{1084}{1077}{1083}{1086}{1095}{1100}"  ({1085}{1072}{1087}{1088}{1080}{1084}{1077}{1088}: "{1076}{1086}{1083}{1083}.{1057}{1064}{1040}:{1094}{1077}{1085}{1090}")
 n R,i,A,S,t,n19
 s n19="{1086}{1076}{1080}{1085} {1076}{1074}{1072} {1090}{1088}{1080} {1095}{1077}{1090}{1099}{1088}{1077} {1087}{1103}{1090}{1100} {1096}{1077}{1089}{1090}{1100} {1089}{1077}{1084}{1100} {1074}{1086}{1089}{1077}{1084}{1100} {1076}{1077}{1074}{1103}{1090}{1100} {1076}{1077}{1089}{1103}{1090}{1100} {1086}{1076}{1080}{1085}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1076}{1074}{1077}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1090}{1088}{1080}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1095}{1077}{1090}{1099}{1088}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1087}{1103}{1090}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1096}{1077}{1089}{1090}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1089}{1077}{1084}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1074}{1086}{1089}{1077}{1084}{1085}{1072}{1076}{1094}{1072}{1090}{1100} {1076}{1077}{1074}{1103}{1090}{1085}{1072}{1076}{1094}{1072}{1090}{1100}"
 s t="",S="" s:s<0 t="{1084}{1080}{1085}{1091}{1089} ",s=-s s R=s\1 s:'R t=t_"{1085}{1091}{1083}{1100} "
 s t=$$Uu^MXF(t)
 i R f i=1:3:$l(R) s A=$e(R,$l(R)-1-i,$l(R)-i+1) d:A  s S=$$Uu^MXF(S)
 .s:i>4 S="{1084}{1080}{1083}{1083}{1080}"_$s(i=7:"{1086}{1085}",1:"{1072}{1088}{1076}")_$s(A#100\10-1&(A#10>1)&(A#10<5):"{1072}",A#10=1&(A#100\10-1):"",1:"{1086}{1074}")_" "_S
 .i i=4 s S="{1090}{1099}{1089}{1103}{1095}"_$s(A#100\10=1!(A#10>4)!(A#10=0):"",A#100\10-1&(A#10>1)&(A#10<5):"{1080}",1:"{1072}")_" "_S
 .i A#100\20=0!(A#10),A#100 s S=$p($s(A#100=1!(A#100=2):"{1086}{1076}{1085}{1072} {1076}{1074}{1077}",1:n19)," ",A#100>9&(A#100<20)*10+(A#10))_" "_S
 .s:A#100\20 S=$p("{1076}{1074}{1072}{1076}{1094}{1072}{1090}{1100} {1090}{1088}{1080}{1076}{1094}{1072}{1090}{1100} {1089}{1086}{1088}{1086}{1082} {1087}{1103}{1090}{1100}{1076}{1077}{1089}{1103}{1090} {1096}{1077}{1089}{1090}{1100}{1076}{1077}{1089}{1103}{1090} {1089}{1077}{1084}{1100}{1076}{1077}{1089}{1103}{1090} {1074}{1086}{1089}{1077}{1084}{1100}{1076}{1077}{1089}{1103}{1090} {1076}{1077}{1074}{1103}{1085}{1086}{1089}{1090}{1086}"," ",A#100\10-1)_" "_S
 .s:A\100 S=$p("{1089}{1090}{1086} {1076}{1074}{1077}{1089}{1090}{1080} {1090}{1088}{1080}{1089}{1090}{1072} {1095}{1077}{1090}{1099}{1088}{1077}{1089}{1090}{1072} {1087}{1103}{1090}{1100}{1089}{1086}{1090} {1096}{1077}{1089}{1090}{1100}{1089}{1086}{1090} {1089}{1077}{1084}{1100}{1089}{1086}{1090} {1074}{1086}{1089}{1077}{1084}{1100}{1089}{1086}{1090} {1076}{1077}{1074}{1103}{1090}{1100}{1089}{1086}{1090}"," ",A\100)_" "_S
 s t=t_S s:$l($g(v)) t=t_" "_$p(v,":")_" "_$p($j(s,0,2),".",2)_" "_$p(v,":",2)
 s $e(t)=$tr($e(t),$$Uu^MXF("{1096}{1074}{1087}{1086}{1076}{1095}{1089}{1084}{1090}{1085}{1084}"),$$Uu^MXF("{1064}{1042}{1055}{1054}{1044}{1063}{1057}{1052}{1058}{1053}{1052}"))
 q t
NTR ; ZPPROPIS ;{1057}{1059}{1052}{1052}{1040} {1055}{1056}{1054}{1055}{1048}{1057}{1068}{1070}  ;$DER$;   19890828  RUSSIA
 N RUB,KOP,I,A,MINUS,S,o
 S S=$j(%1,0,2)
 S MINUS=$$Uu^MXF($S(S<0:"{1052}{1048}{1053}{1059}{1057} ",1:"")),S=$J($S(S<0:-S,1:S),0,2)
 s KOP=S#1*100,RUB=S\1,S=$S(RUB:"",1:$$Uu^MXF("{1053}{1059}{1051}{1068}  "))
 I RUB F I=1:3:$L(RUB) S A=$E(RUB,$L(RUB)-1-I,$L(RUB)-I+1) I A D
 .I I>4 S S="{1052}{1048}{1051}{1051}{1048}"_$S(I=7:"{1054}{1053}",1:"{1040}{1056}{1044}")_$S(A#100\10'=1&(A#10>1)&(A#10<5):"{1040}",A#10=1&(A#100\10'=1):"",1:"{1054}{1042}")_" "_S
 .I I=4 S S="{1058}{1067}{1057}{1071}{1063}"_$S(A#100\10=1!(A#10>4)!(A#10=0):"",A#100\10'=1&(A#10>1)&(A#10<5):"{1048}",1:"{1040}")_" "_S
 .I A#100\20=0!(A#10),A#100 S S=$P($T(@$S(I'=4:1,A#100=1!(A#100=2):1000,1:1))," ",A#100>9&(A#100<20)*10+(A#10)+1)_" "_S
 .I A#100\20 S S=$P($T(10)," ",A#100\10)_" "_S
 .I A\100 S S=$P($T(100)," ",A\100+1)_" "_S
 s (%1,%2,S)="  "_MINUS_$tr($$Uu^MXF(S),";")
 Q
1 ;{1054}{1044}{1048}{1053} {1044}{1042}{1040} {1058}{1056}{1048} {1063}{1045}{1058}{1067}{1056}{1045} {1055}{1071}{1058}{1068} {1064}{1045}{1057}{1058}{1068} {1057}{1045}{1052}{1068} {1042}{1054}{1057}{1045}{1052}{1068} {1044}{1045}{1042}{1071}{1058}{1068} {1044}{1045}{1057}{1071}{1058}{1068} {1054}{1044}{1048}{1053}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1044}{1042}{1045}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1058}{1056}{1048}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1063}{1045}{1058}{1067}{1056}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1055}{1071}{1058}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1064}{1045}{1057}{1058}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1057}{1045}{1052}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1042}{1054}{1057}{1045}{1052}{1053}{1040}{1044}{1062}{1040}{1058}{1068} {1044}{1045}{1042}{1071}{1058}{1053}{1040}{1044}{1062}{1040}{1058}{1068}
10 ;{1044}{1042}{1040}{1044}{1062}{1040}{1058}{1068} {1058}{1056}{1048}{1044}{1062}{1040}{1058}{1068} {1057}{1054}{1056}{1054}{1050} {1055}{1071}{1058}{1068}{1044}{1045}{1057}{1071}{1058} {1064}{1045}{1057}{1058}{1068}{1044}{1045}{1057}{1071}{1058} {1057}{1045}{1052}{1068}{1044}{1045}{1057}{1071}{1058} {1042}{1054}{1057}{1045}{1052}{1068}{1044}{1045}{1057}{1071}{1058} {1044}{1045}{1042}{1071}{1053}{1054}{1057}{1058}{1054}
100 ;{1057}{1058}{1054} {1044}{1042}{1045}{1057}{1058}{1048} {1058}{1056}{1048}{1057}{1058}{1040} {1063}{1045}{1058}{1067}{1056}{1045}{1057}{1058}{1040} {1055}{1071}{1058}{1068}{1057}{1054}{1058} {1064}{1045}{1057}{1058}{1068}{1057}{1054}{1058} {1057}{1045}{1052}{1068}{1057}{1054}{1058} {1042}{1054}{1057}{1045}{1052}{1068}{1057}{1054}{1058} {1044}{1045}{1042}{1071}{1058}{1068}{1057}{1054}{1058}
1000 ;{1054}{1044}{1053}{1040} {1044}{1042}{1045}
NTU ;numeric by text USA,UK  ; T.JANKOVA  19990604 
 N RUB,KOP,I,A,MINUS,S
 S S=%1 S:'$g(S) S=0 s:S[.99 S=$j(S,0,2)
 S MINUS=$S(S<0:"MINUS ",1:""),S=$J($S(S<0:-S,1:S),0,2),KOP=S#1*100,RUB=S\1,S=$S(RUB:"",1:"NULL  ")
 I RUB F I=1:3:$L(RUB) S A=$E(RUB,$L(RUB)-1-I,$L(RUB)-I+1) I A D
 .I I>4 S S=$S(I=7:"MILLION",1:"BILLION")_$S(A#100\10'=1&(A#10>1)&(A#10<5):"",A#10=1&(A#100\10'=1):"",1:" ")_" "_S
 .I I=4 S S="THOUSAND"_$S(A#100\10=1!(A#10=0):"S",A#100\10'=1&(A#10>1):"",1:"")_" "_S
 .I A#100\20=0!(A#10),A#100 S S=$P($T(@$S(I'=4:"u1",A#100=1!(A#100=2):"u1000",1:"u1"))," ",A#100>9&(A#100<20)*10+(A#10)+1)_" "_S
 .I A#100\20 S S=$P($T(u10)," ",A#100\10)_" "_S
 .I A\100 S S=$P($T(u100)," ",A\100+1)_" HUNDRED"_$s(A\100>1:"",1:" ")_" "_S 
 s S=$tr($$Uu^MXF(S),";","")
 S S="  "_MINUS_S
 S %2=S
 Q
u1 ;ONE TWO THREE FOUR FIVE SIX SEVEN EIGHT NINE TEN ELEVEN TWELVE THIRTEEN FOURTEEN FIFTEEN SIXTEEN SEVENTEEN EIGHTEEN NINETEEN
u10 ;TWENTY THIRTY FORTY FIFTY SIXTY SEVENTY EIGHTY NINETY
u100 ;ONE TWO THREE FOUR FIVE SIX SEVEN EIGHT NINE
u1000 ;ONE TWO THREE FOUR FIVE SIX SEVEN EIGHT NINE TEN ELEVEN TWELVE THIRTEEN FOURTEEN FIFTEEN SIXTEEN SEVENTEEN EIGHTEEN NINETEEN
 q
l(%lN,%i,%x) 
 n %,%VFx4 k lUST
 q:'$d(%lN) ""
 n %b,%n,%p,%K,%w
 s $p(%b," ",$l(%lN)+1)=""
 s %lN=$tr(%lN,"^=-"_$c(176)_$c(177)_$c(178)_$c(179)_$c(202)_$c(203)_$c(205)_$c(206)_$c(207)_$c(209)_$c(199)_$c(186)_$c(197)_$c(196)_$c(195)_$c(194)_$c(193)_$c(192)_$c(190)_$c(187)_$c(182)_$c(218)_"|;#\][}{#&*!`:",%b)
 f %=1:1:$l(%lN) s:$e(%lN,%)'=" " %n=$p($p($e(%lN,%,%+99)," "),"^"),%w(%)=%n,%=%+$l(%n)-1
 s %="" f  s %=$o(%w(%)) q:%=""  d
 .s %n=$p($p($p(%w(%),"_"),"~")_"..","..")
 .s:$e(%n)?1n %n=$p(%n,+%n,2,99) s:%n="" %n="%K",%K=""
 .s:$d(@%n)#10=0 @%n=%n s %K=@%n
 .s %p=$l($p(%w(%),".",2))+(%w(%)["."*.0001)+(%w(%)["_"*.0001)
 .i '%K,%p," "'[%K s %K="- "
 .i %w(%)["~",%K\1=%K s %p=.0001
 .i %K,%p s %K=$j(%K,0,%p\1)
 .s:'$d(lUST) lUST(1)=%n s lUST(%n)=%K
 q ""
zos(%1,%2) 
 n % x "s %=$zos(%1,%2)" q %
jxml(%FILE) 
 k ^US(%USID,"xml^UST")  j xml(%USID,%FILE) f %=1:1:9 h 1 q:$d(^US(%USID,"xml^UST"))
 q:%>8 -9 q %FILE
xml(%USID,%FILE) 
 q
uni(s) 
 i %rus'[s q s
 n uni,%,%uni,%rusUNI   ;; a=&#1094;  a=garumz
 i '$d(%uni) d  f %=1:1:$l(%rus) s %uni($e(%rus,%))=$p(%rusUNI,";",%)
 . s %rusUNI="34;58;38;60;62;1105;1081;1094;1091;1082;1077;1085;1075;1096;1097;1079;1093;1098;1092;1099;1074;1072;1087;1088;1086;1083;1076;1078;1101;1103;1095;1089;1084;1080;1090;1100;1073;1102;"
 . s %rusUNI=%rusUNI_"1105;1081;1094;1091;1082;1077;1085;1075;1096;1097;1079;1093;1098;1092;1099;1074;1072;1087;1088;1086;1083;1076;1078;1101;1103;1095;1089;1084;1080;1090;1100;1073;1102"
 q $g(%uni(s),s)
p(t,h,n) 
 n o,oo i n>0 q $p(t,h,n)
 i 'n d  q oo
 . s oo=-1 f o=1:1:$l(t,h) i n=$p(t,h,o) s oo=o q
 f o=1:1:$l(t,h) s oo(o)=$p(t,h,o)
 q $g(oo(n+o+1))
trw(t,w1,w2,n) 
 i $zv["Ca"!($zv["IRIS"),'$d(n) q $replace(t,w1,$g(w2))
 n t2,%,nn s t2="",w2=$g(w2),nn=$l(t,w1) q:w1=""!(t'[w1) t
 i w2=" ",w1="  ",t'[$c(3) d  q $tr(t,$c(3))
 . f %=1:1:$l(t) i $e(t,%)=" "," "[$e(t,%+1) s $e(t,%)=$c(3)
 . f  q:$e(t)'=" "  s t=$e(t,2,999)
 f %=1:1:nn s %(%)=$p(t,w1,%)
 f %=1:1:nn s t2=t2_%(%)_$s(%<nn:w2,1:"") q:%=+$g(n)
 q:'$d(n) t2  i n'["L",n'["R" q t2
 q:t[$c(3) t  s w1=$e(w1)
 i n["L" f %=1:1:$l(t)-1 q:$e(t,%)'=w1  s $e(t,%)=$c(3)
 i n["R" f %=$l(t):-1:2 q:$e(t,%)'=w1  s $e(t,%)=$c(3)
 q $tr(t,$c(3)) 
 q

USX
USX ; MX-SERVER [ 01/10/2006  10:11 PM ]  ;[ 20191107 20:16:20 ]
 ; MSM, CACHE, GT.M, MiniM
 ; MX  Copyright(c) SIA ENTERS  2005-2019
 ; 
 N II,GG,%IG,%2,L,%FILE,%B,%,o,%n,%x s %=""
 S %FILE=$P(%1," "),%USPR=$G(%USPR,"%USPR"),%B=$c(254) q:"o"_%B[%FILE
 i '$l($g(%USID))!'$l(%FILE) s %mxWarng("^USX")="'$l($g(%USID)!'$l(%FILE)"_$g(%USID)_$g(%FILE) q
 i -$g(xC)[-56,$d(^mxConfig("A",%FILE)),'$d(^(%FILE,%USID)) s xC=-xC_"- access denyed",%mxWarng(xC)="^USX" q
 S II=$g(^AL(%FILE,"%LII")),GG=$g(^("%LG"))
 i $l(II)<1!($l(GG)<3) s:$d(@("^"_%FILE)) mxWarng(%FILE)=II_GG_$g(%V)_%B_$g(%I) q
 f %="II","GG" s @%=$p(@%_"    ","    ")
 S %2="s "_$p(GG,",",2)_"=$p(%R,"""_%B_""",2)"
 i (GG["~") s %2="s %B=$c(254)"
 s %x=1 F %=2:1:$L(GG,",") d
 . i GG["~" s %n=$p($p(GG,",",%),$c(13)) d  q
 . . ;;;q:%n["~~"
 . . i $e(%n)'="~" s %x=%x+1,%2=%2_","_%n_"=$p(%R,%B,"_%x_")" q
 . . s %n=$tr(%n,"~"),%2=%2_","_%n_"=$p($p(%R,%B_"""_%n_"="",2),%B)"
 . S:%>2 %2=%2_","_$P(GG,",",%)_"=$P(%R,"""_%B_""","_%_")"
 S %XG(%FILE)=%2
 s %2="n %,%q s %=$p(%I,""("",2,9),%=$p(%_0,"")0"")"
 F %=1:1:$l(II,",") S %2=%2_" s "_$p(II,",",%)_"=$p(%,"","","_%_")" d
 .s %2=%2_" s:$e("_$p(II,",",%)_")="""""""" "_$p(II,",",%)_"=$e("_$p(II,",",%)_",2,$l("_$p(II,",",%)_")-1)"
 s %2="s " d
 .f %=1:1 s %n=$p(II,",",%) q:%n=""  s %2=%2_%n_"=$qs(%I,"_%_"),"
 .s %2=$p(%2_",",",,")
 n %x1
 S %XI(%FILE)=%2,%x=$l(GG,",")+9,%x1=1  k %CON
 i GG'["~" S %CON(%FILE)="n %,%N,%B S %R=%SF,%B=$c(254) F %=2:1:"_$L(GG,",")_" S %N=$P("""_GG_""","","",%),%R=%R_%B_@%N "
 i GG["~" S %CON(%FILE)="n %,%N,%B S %R=%SF,%B=$c(254)" F %=2:1:$L(GG,",") s %n=$p(GG,",",%) d
 . ;;;q:%n["~~"
 . s:%n'["~" %x1=%x1+1,o="(%OLD("""_%n_"""),$p(%R,%B,"_%x1_"))="_%n
 . s:%n["~" o="$p(%R,%B,"_%x_")="""_$tr(%n,"~")_"=""_"_$tr(%n,"~"),%x=%x+1
 . s %CON(%FILE)=%CON(%FILE)_","_o
 S %LG(%FILE)=GG,%LII(%FILE)=II,%LI(%FILE)=$p($g(^AL(%FILE,"%LI"))," ")
 q
%XG(%1) 
 s %1=$p(%1,"(") s:$e(%1)="^" %1=$e(%1,2,22) q:'$l(%1) 0
 i $d(^AL(%1)) d ^USX q %1
 q 0
x(%1) d X q ""
xe(%USID,%xecute) 
 s %xUSX=%xecute s $zt="Erx^USX"
 n % x %xecute
 q
get(%1,%2) 
 n %n,%
 f %=1:1:$l(%1," ") s %n=$p(%1," ",%) i %n'="",'%n s @%n=$g(@%n,$g(%2))
 q ""
wm(%rm,%nn) 
 n %,%1,%r,%n,%x,%im,%j,%jq,%lrm,%rmx
 s %j=+%rm,%jq=0 i %rm s %rm=%V(%V,3),%nn=%V(%V,"4.rm")
 f %1=$l(%rm,$c(254)):-1:1 d
 .i %j<-1,%1>($l(%rm,$c(254))+1-%j) q
 .f %x=1:1:$l(%nn,$c(254)) s %n=$p(%nn,$c(254),%x) d:%V(%V,5)_"-"'[("-"_%n_"-")
 ..s %="" f  s %=$o(@%n@(%)) q:%=""  s %jq=@%n@(%)   d:%jq
 ...i %j s:%j>0 %jq=%jq-$j(%jq,0,%j) s:%j<0 %jq="-"_%jq q:'%jq
 ...s $p(%rm(%1,$c(255)_%),$c(254),%x)=%jq
 ...q:%V(%V)'["-"
 ...s $p(%rm(%1,$c(255)_%),$c(254),%x)="-"_%jq
 .s %im=$p(%rm,$c(254),1,%1) x "i $o(^rm(%USID,"_$tr(%im,$c(254),",")_",0))"
 .s %="" f  s %=$o(%rm(%1,%)) q:%=""  d 
 .. s %r=$g(^(%)),%lrm=$l(%rm(%1,%),$c(254))
 .. i %rm(%1,%)'["++",%r'["++" d  q
 ... f %x=1:1:%lrm s $p(%r,$c(254),%x)=$p(%r,$c(254),%x)+$p(%rm(%1,%),$c(254),%x)
 ... s ^(%)=%r
 .. n v,s
 .. f %x=1:1:%lrm s %rmx=$p(%rm(%1,%),$c(254),%x),s=$p(%r,$c(254),%x),$p(%r,$c(254),%x)=$$sv^fin("s++%rmx")
 .. s ^(%)=%r
 q ""
nE(%E) n % f %=1:1:99,0 q:$p(%V(%V,3.1),%B,%)=%E
 q %
rm(%e,%nn) 
 n %x,%n,% k %LineVAL
 i %e'[")" d  i '% s mxERROR=%e_" %e  $$rm^USX(%e,%nn) ?? " q ""
 .s %=$$nE(%e) q:'%
 .s %e=$p(%V(%V,3.1),%B,1,%),%e="^rm(%USID,"_$tr(%e,%B,",")_")"
 s $p(%e,",")="^rm(%USID,%V" 
 s:'$d(%nn) %nn=$g(%V(%V,"4.rm")) q:%nn="" ""
 f %x=1:1:$l(%nn,%B) s %n=$p(%nn,%B,%x),%=$g(@%n) k @%n s @%n=%
 i '$d(%V(%V,"rm")) s %=$c(255) d
 .i $o(^rm(%USID,%V,%ggmm,%))'="" f  s %=$o(^(%)) q:%=""  s %V(%V,"rm",%)=^(%)
 .i '$d(%V(%V,"rm"))   f  s %=$o(^rm(%USID,%V,%)) q:%=""  s %V(%V,"rm",%)=^(%)
 .k ^rm(%USID,$j,%V) m ^rm(%USID,$j,%V)=%V(%V,"rm") k %V(%V,"rm") s %V(%V,"rm")=1
 s %="" i $e(%e,$l(%e))'=")" s %e=$e(%e,1,$l(%e)-1)
 f  s %=$o(^rm(%USID,$j,%V,%)) q:%=""  d:$g(%V(%V,4))["*"!($d(@%e@(%))#10)
 .s %rm=$g(@%e@(%)),%1=$e(%,2,99)
 .f %x=1:1:$l(%nn,%B) d
 .. s %n=$p(%nn,%B,%x),@%n@(%1)=$p(%rm,%B,%x)
 .. q:@%n@(%1)'["++"  n v,%
 .. f %=2:1:$l(@%n@(%1),"++") s v=$e($p(@%n@(%1),"++",%),1,3) d:v'=""
 ...  s %LineVAL(v)=$g(%LineVAL(v),%B)_%n_%B
 q ""
wv(%m,%g) 
 n %l,%i,% s %l=$l(%g,$c(254)),%i=$p($p(%m,"(",2),")")
 s @%i="" f  s @%i=$o(@%m) q:@%i=""  s %r=$g(^(@%i)) d  s ^(@%i)=%r
 .f %=1:1:%l s %n=$p(%g,$c(254),%) i %n'="" s:$g(@%n) $p(%r,$c(254),%)=@%n+$p(%r,$c(254),%)
 q ""
rv(%m,%g) 
 n %l,%i,%r,%rr s %l=$l(%g,%B),%i=$p($p(%m,"(",2),")")
 f %=1:1:%l s %n=$p(%g,%B,%) k:%n'="" @$p(%n,"(")
 s @%i="" f  s @%i=$o(%MiT(%Li,@%i)) q:@%i=""  d
 .s %r=%MiT(%Li,@%i),%rr=$g(%MiT(%Li-1,@%i)) k %MiT(%Li,@%i)
 .f %=1:1:%l s %n=$p(%g,%B,%) d:%n'=""
 ..x "s "_%n_"=$p(%r,%B,%)"
 ..s $p(%rr,%B,%)=$p(%rr,%B,%)+$p(%r,%B,%)
 .s %MiT(%Li-1,@%i)=%rr
 q ""
%xgl 
 s (%xgl(0),%xgl(1),%xgl(-1))=";"  q:'$d(^AL(%FILE,"Gf"))
 F %=-1,0,1 S %xgl(%)=$G(^AL(%FILE,"Gf",$P("OFF PRE ON"," ",2+%)))
 k %xglm  m %xglm(%FILE)=%xgl
 Q
X 
 N A S A=%1 D USX 
 q
%xig(%1) 
 s (%XG(%1),%XI(%1))="" d:$d(^AL(%1)) X
 q ""
%MMUSER(%PrFile,%Vch) 
 n %v,%1,%2,%,%n,L,oo,o
 S L=$T(@%V^@%USPR) Q:L="" ""
 n Vq s Vq=""
 F %L=2:1:15 S %1=$P(L,"\",%L) D  S %v(%L)=%1
 .s %=$p($g(%Vch),"\",%L) s:$l(%) %1=%
 .s %1=$p(%1_"     ","     ") s:%1="-" %1=""
 .i $e(%1)="@" d
 ..  s %=$p($e(%1,2,99)," ") s:%="" %=%V
 ..  s %2=$p($t(@%+(%=%V)^@%USPR),"\",%L)
 ..  s:%2="" %2=$g(@%) s %1=$p(%2_" "_$p(%1," ",2,99)_"   ","   ")
 .i %L<8 s Vq=Vq_" ;"_%L_" ?%v("_%L_") "
 s:%v(3)'[%B %v(3)=$tr(%v(3),",",%B)
 i %v(4)["@" s $p(%v(4),"@",2)=@$p(%v(4),"@",2),%v(4)=$tr(%v(4),"@")
 s %v(4)=$tr(%v(4)," ",%B),%=$p(%v(4),"=",2) 
 f o=1:1:$l(%,%B) s oo=$p(%,%B,o) s:%B_%v(3)_%B[(%B_oo_%B) $p(%,%B,o)=1
 f o=1:1:$l(%,%B) s oo=$p(%,%B,o) s:%B_$p(%v(4),"=")_%B[(%B_oo_%B) $p(%,%B,o)=1
 s:%[(%B_1) %=$$trw^UST(%,%B_1),$p(%v(4),"=",2)=%
 S:%B_%B_%v(3)'[(%B_%B_"%V"_%B) %v(3)="%V"_%B_"%ggmm"_%B_%v(3)
 S:$E(%v(5))="-" %v(5)=$P(%v(3),%B,2)_%v(5)
 S:%B_%v(3)_%B'[(%B_$P(%v(5),"-")_%B) %v(5)=$P(%v(3),%B,2)
 f %=1:1:$l(%v(3),%B) s %n=$p(%v(3),%B,%) i $e(%n)["-" d
 . s %v(5)=%v(5)_%n,$p(%v(3),%B,%)=$e(%n,2,99)
 S %v(6)=" "_$tr(%v(6),","," ")_" "
 i mxConfig[":^z5:",%v(6)["ciko",%v(6)'["z5" s %v(6)=%v(6)_"z5 "
 i %v(7)[" " x %v(7)
 s %v(4)=$g(%v(14))_%v(4) k %v(14)
 i $$%XV(%PrFile)
 merge %V(%V)=%v
 q ""
%XV(%PrFile) 
 N H,%,%2,%3,%4,%4M,%E,x,%22,o 
 s %PrFile="^"_$tr(%PrFile,"^","")
 f %="%v(3)","%v(4)" s:@%'[%B @%=$tr(@%,",",%B)
 s %v(3.5)=$p(%v(3),"*",2),%v(3.1)=$p(%v(3),"*")
 i %v(3.5)["(" f %=1:1:$l(%v(4),%B) d
 .s x=$p(%v(4),%B,%)
 .q:$tr(x,"()",",,")'[$tr(","_$p(%v(3.5),"(",2),"()",",,")
 .s $p(%v(4.5),%B,%)=x s $p(%v(4),%B,%)=1 q
 s %v(4.3)="",%=%v(4)
 i %v(4)'["*)",%v(4)'["(*" s %v(4.3)=$p(%v(4),"*",2),%=$p(%v(4),"*")
 s %v(4.2)=$p(%,"=",2),%v(4.1)=$p(%,"=")
 f %=1:1:$l(%v(4.1),%B) s x=$p(%v(4.1),%B,%) d:",*)"[$e($p(x,"(",2)_0)
 .s x=$p(x,"("),$p(%v(4.1),%B,%)=2
 .s %v("4.rm")=$g(%v("4.rm"))_$s($d(%v("4.rm")):%B,1:"")_x
 S %3=%v(3.1),%4=%v(4.1),%4M=%v(4.3)
 s %2="" f %=1:1:$l(%4,%B) s %n=$p(%4,%B,%) d:%n!%2!(%n["_")
 .q:%n=+%n
 .i %n["_" s %n=$l($p(%n,".",2))_$p($p(%n,"."),"_")
 .s:%n %2=+%n,%n=$p(%n,+%n,2,99),$p(%4,%B,%)=%n
 .s $p(%v("4.p"),%B,%)=%2
 s %v(4.1)=%4 s:$l(%v(4.2)) %4=%4_%B_%v(4.2)
 s %v(.34)=%3_%B_%4
 s %4=$L(%v(4.1),%B)+1_%B_%4,H=""""_%B_""""
 s %2="n %zr S %zr=$NAME("_%PrFile_"("_$tr(%3,%B,",")_")),%R=$g(@%zr) i $e(%zr,1,$l(%zr)-1)[$e($g(%V(%V,""xMrm"")),1,$l($g(%V(%V,""xMrm"")))-1) s ^("
 s:'$d(%V(%V,"xMrm")) %2="S ooozr=$NAME("_%PrFile_"("_$tr(%3,%B,",")_")),%R=$g(@ooozr),^("
 s %E=$p(%3,%B,$L(%3,%B))
 s %2=%2_%E_")=" F %=2:1:%4 d
 .s %1="_" s:%=2 %1="" i $p(%4,%B,%) s %2=%2_%1_H
 .e  s %2=%2_%1_H_"_($p(%R,"_H_","_%_")+"_$P(%4,%B,%)_")"
 f %=%4+1:1:$L(%4,%B) s %2=%2_"_"_H_"_"_$P(%4,%B,%)
 i %4M'="" s %2=%2_"_"_%B_"_$P(%R,%B,"_($L(%4,%B)+1)_",99) N I,% S I="""" F %="_($L(%4,%B)+1)_":1 S I=$O("_%4M_"(I)) Q:I=""""  S:"_%4M_"(I) $P(^("_%E_"),%B,%)=$P(%R,%B,%)+"_%4M_"(I)"
 i %v(3.5)'="" s %2=%2_" i $d(^("_%E_",1))+1,1!$$wv^USX("""_%v(3.5)_""","""_%v(4.5)_""")"
 i $g(%v("4.rm"))'="" s %2=%2_" i 1!$$wm^USX("""_%v(3.1)_""","""_%v("4.rm")_""") "
 s %XV(%V)=%2
 q ""
wParVM(%USID,%n,%q) 
 q ""
VarsMe1(%zr) 
 n %1,%2,%3,% s %="%",%3="",%1=251 i $d(@%zr@(1))
 f  s %=$o(@%) q:%=""  i %'="%",%'?1"%"1n,$d(@%)#2,$l(@%)<999 d
 .s %3=%3_$c(4)_%_"="_@% q:$zv["M3"  q:$l(%3)>15000
 .i $l(%3)>250 f  d  q:$l(%3)<250
 .. s ^(%1)=$e(%3,1,250),%3=$e(%3,251,9999),%1=%1+250
 s ^(%1)=%3_$c(4)
 q $d(@%zr)
SaveMem(%1,%2,LiOfMvar) 
 s:'$d(%2) %2=$g(%1),%1=%USID
 n % s:0[$g(%2) %2=0 s:0[$g(%1) %1=%USID i %2'<0,$d(%mxWeb) q %2
 k ^oAllVars(%1,%2) s ^(%2,"$j")=$j
 i $l($g(LiOfMvar)) d  q $g(%11)
 . i LiOfMvar="%FILE" s %=$tr(%LI(%FILE),",~"," ") q:'$l(%)  s LiOfMvar=%_" %xgl() %xglm() %G() %W() %FILE %gFILE %GM %I %LG %K %KEM %N %B %SF %NEW %LIv" 
 . s ^oAllVars(%1,%2,-1)=LiOfMvar
 . f %11=1:1:$l(LiOfMvar," ") s %=$p(LiOfMvar," ",%11) i $l(%) x:%["()" "s %=$p(%,""()"") m:$d(@%) ^oAllVars(%1,%2,%)=@% i $d(^oAllVars(%1,%2,%))" s:$d(@%)#2 ^(%)=@%
 i $d(%mxWarng) k ^o($j,"%mxWarng") s %=$s($zv["GT":"$R",1:"$zr") x "m @"_%_"=%mxWarng s @"_%_"=$g(%mxForma)_"" ""_$$pD^MXD($h,2) k %mxWarng"
 s %="%" g:$zv'["MS" SaveMem3 
 f  s %=$o(@%) q:%=""  i $e(%)'="$"," %0 %1 %2 %USID o oo ooo "'[(" "_%_" ") d:$d(@%)>1  i $d(@%)#2 s ^(%)=$e(@%,1,500)  i $l(@%)>500 f %22=501:500:$l(@%) s ^(%,%22)=$e(@%,%22,%22+499) i $d(^oAllVars(%1,%2,%))
 . n %11 s %11=%_"("""")"
 . f  s %11=$q(@%11) q:%11=""  i $d(@%11)#2 s ^(%11)=$e(@%11,1,500) d
 .. i $l(@%11)>500,'$d(^(%11,1)) d  i $d(^oAllVars(%1,%2,%))
 ... f %22=501:500:$l(@%11) s ^(%22)=$e(@%11,%22,%22+499)
 q ""
SaveMem3 
 s ^oAllVars(%1,%2,1)=$h,%="%" ;; s:$zv["M3" %="%1J"
 f  s %=$o(@%) q:%=""  i $e(%)'="$",$e(%,1,2)'?1"%"1n," %USID o oo ooo %msm8uni cMSM2Uni "'[(" "_%_" ") s:$d(@%)#2 ^(%)=@% i $d(@%)>1 m ^oAllVars(%1,%2,%)=@% i $d(^oAllVars(%1,%2,%)) 
 q ""
CopySave(%) 
 n %1
 k ^oAllVars(%USID,%),^oM3(%USID)
 m ^oM3(%USID)=^oAllVars(%USID,0) m ^oAllVars(%USID,%)=^oM3(%USID)
 k ^oM3(%USID)
 s %=0,%1="" f  s %=$o(^oAllVars(%USID,%)) q:%=""  s %1=%1_%_$c(4)
 q %1
RestMeKi(%USID,%xxx0,%noKILL) 
 q:'$d(^oAllVars(%USID,%xxx0)) ""
 i $$RestMem(%USID,%xxx0,$g(%noKILL))
 k ^oAllVars(%USID,%xxx0)
 q 1
RestAdd(%1,%2) 
 i $d(^oAllVars(%1,%2,1))
 n % s %=999 f  s %=$o(^(%)) q:'$l(%)  i $e(%)'="$",'$d(@%) m @%=^oAllVars(%1,%2,%)
 q 1
RestMem(%1,%2,%) 
 s:'$d(%2) %2=$g(%1),%1=%USID
 i %2<0,$d(%mxWeb),$j=$g(^oAllVars(%1,%2,"$j")),$g(%session)=$g(^("%session")) q $j
 s:0[$g(%1) %1=%USID s:0[$g(%2) %2=0 ;; i %2'<0,$d(%mxWeb) q %2
 h:'$d(^oAllVars(%1,%2,"$j")) 1   q:'$d(^oAllVars(%1,%2,"$j")) -1  
 i '$d(%mxWeb),^("$j")-$j q -1
 i $l($g(^oAllVars(%1,%2,-1))) n %11,LiOfMvar s LiOfMvar=^(-1) d  g RestMemE
 . f %11=1:1:$l(LiOfMvar," ") s %=$p(LiOfMvar," ",%11) i $l(%),%'="%" s %=$p(%,"("),@%=$g(^(%)) i $d(^(%))>1 k @% m @%=^oAllVars(%1,%2,%) i $d(^oAllVars(%1,%2,%))
 i $zv'["MS" s %=999 f  s %=$o(^(%)) q:%=""  d:$e(%)'="$"
 .q:" oo o ERR mxMsgBox mxERROR %USID %RestMem % %1 %2 "[(" "_%_" ")
 .i $e(%)="%",'$d(%mxWeb),$d(@%) q:"%LANG %YX %omPrint %mxSheet %mxForma %XD81 %XD82 %gm %DatUMs %DATUMS %MENESI %GADS %DAYS %YEAR %XD81m %XD82m "[(%_" ")
 .i $d(^(%))=1 s @%=^(%) q
 .k @% m @%=^oAllVars(%1,%2,%)
 i $zv["MS" s %=999 f  s %=$o(^(%)) q:%=""  d:$e(%)'="$"
 .q:" oo o ERR mxMsgBox mxERROR %USID %RestMem % %1 %2 "[(" "_%_" ")
 .i $e(%)="%",$d(@%) q:"%LANG %YX %omPrint %mxSheet %mxForma %XD81 %XD82 %gm %DatUMs %DATUMS %MENESI %GADS %DAYS %YEAR %XD81m %XD82m "[(%_" ")
 .k @% i $d(^(%))#2 s @%=^(%) d:$l(@%)=500
 ..n %22
 ..f %22=501:500 q:'$d(^oAllVars(%1,%2,%,%22))  s @%=@%_^(%22)
 ..i $d(^oAllVars(%1,%2,%))
RestMemE s %=999 f  s %=$o(%RestMem(%)) q:%=""  s @%=%RestMem(%) k %RestMem(%)
 q ""
v(%Vch,oov,oov2) 
 n oovL,v 
 s oovL=$tr($p(%Vch,"\",3,4),"\,=","   ")_" %I "
 s oovL=$$trw^UST(oovL,"(*)")
 i $g(oov)?8n d  s oov="s:d8<"_oov_" flagSTOP=1 "_$g(oov2)
 . n x,o k %d8start
 . f x=1:1:99 s o=$p($p(%Vch,"\",6)," ",x) s:$l(o) %d8start(o)=oov
 q $$%v($p(%Vch,"\"),%Vch,,,$g(oov))_$$%vL($p(%Vch,"\"),,,,oovL)    
 ;
%v(%V,%Rout,xMcode,%PrFile,oov) 
 n %Vch s %Vch=$g(%Rout) i $l(%Vch,"\")<4 s %Vch=""
 i %V["^" s %Rout=$p(%V,"^",2),%V=$p(%V,"^")
 s %PrFile=$g(%PrFile,"^M")
 n o,oo,%FILE,%W,%uspr s %uspr=%USPR
 n %USPR k %rVstop(%V),%koko
 s %USPR=%Rout,%V(%V)="1F",%W=$c(255)
 i $t(@%V^@%USPR)=""  d  q mxERROR
 . s mxERROR="line "_%V_"^"_%USPR_" not exist.."
 i $$%MMUSER(%PrFile,%Vch)
 k ^oMX(%USID,"%V",%V) m ^oMX(%USID,"%V",%V)=%V 
 k vbak 
 s xVw="d "_%V_"^"_%Rout
 i $zv["Ca" do DISABLE^%NOJRN ;;i $SortBegin(^M(%V,%ggmm))
 k @%PrFile@(%V,%ggmm),^rm(%USID,%V,%ggmm),^oMX(%USID,"v",%V)
 i '$l($g(flgPlusM)) s %="" f  s %=$o(^M(%V,%)) q:%=""  k:$p(%,":",2)=%USID ^(%) k ^rm(%USID,%V)
 i $l($g(flgPlusM)) q:$d(flgPlusM(%V,+%ggmm)) 0 s flgPlusM(%V,+%ggmm)=1 n %ggmm s %ggmm=flgPlusM_":"_%USID_":*"  
 F %FileNum=1:1:33 S o=$p(%V(%V,6)," ",%FileNum) d:o'=""
 .s:o o=$p(o,+o,2,99) d %FILE^USPRINT(o_"^"_%Rout)
 i $zv["Ca" do ENABLE^%NOJRN  ;;i $SortEnd(^M(%V,%ggmm))
 q $d(@%PrFile@(%V))
%vL(%V,%PrNode,xMcodeL,%PRRvL,oovL) 
 n %E,%NNN,d8,sd,sk,%vL s %NNN=0
 i $l($g(flgPlusM)),$d(flgPlusM(%V,%ggmm))!111 n %ggmm s %ggmm=flgPlusM_":"_%USID_":*"
 i $d(%PrNode),%PrNode_%V'["^" s %V=%V_"^"_%PrNode k %PrNode
 i %V["^" s %Rout=$p(%V,"^",2)
 s %V=$p($p(%V,"^")_"LLLLLLLL","LLLLLLLL")
 m %V=^oMX(%USID,"%V",%V)
 s %vL=%V_"L",%PrNode=$g(%PrNode,"^M(%V)")
 q:'$d(@%PrNode) $NAME(@%PrNode)
 i $t(@%vL^@%Rout)="" q "line "_%vL_"^"_%Rout_" not found.."
 n %Li,%Mi,%M,%MiT
 i $zv["Ca" do DISABLE^%NOJRN
 i $$%PrNode^USPRINT(%PrNode)
 i $zv["Ca" do ENABLE^%NOJRN
 q 1_%USPR_"."_%V_%PrNode
qerr s $zt="" h 1 q "ERROR:ta^USX("_%j_","_p1_") "_$h_-$j_" zc="_zc
wDOS(%dos,text) 
 ; o 51:(%dos:"W"):0
 ; u 51 w:$d(text) text w:'$d(text) !,$h,!,%USPR,!
 q ""  ; c 51 q ""
MsgVM1 ;;;;(%ListVM) ;;  FromM.VM1 ==> to  M  !!!!
 f %=2:2:$l(%ListVM,$c(4)) d
 . s %1=$p(%ListVM,$c(4),%),%2=$p(%ListVM,$c(4),%+1)
 . i %2="",%1[" " x %1 q
 . x "s "_%1_"="""_%2_""""
 q
MsgMVj(%VarList) 
 q $$MsgVMV("  ",%VarList)
MsgVM ; MVM ;;;(%ListVM)  ;;  job 
 k ^MsgVM(%USID),^(%USID,1)
 n %MsgVMxx  ;;; h 3  
 f %=2:2:$l(%ListVM,$c(4)) d
 . s %1=$p(%ListVM,$c(4),%),%2=$p(%ListVM,$c(4),%+1)
 . i %1="%MVMkey" s %MVMkey=%USID       ;;;%2
 . s %MsgVMxx(%1)=%2,^(%1)=%2
 s ^MsgVM(%USID)=1
 q
MsgVMV(%,%VarList) 
 k %MsgMV s %MsgMV=%_$c(4),%VarList=$g(%VarList)
 i $g(%ErrorM)'="" s %VarList=%VarList_" %ErrorM"
 n %1,%2,%3,% s %2=""
 s %MsgMV=%MsgMV_$g(%VarList)_$c(4)_"$j="_$j_$c(4)
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d:$e(%)="@"
 . s %2=%2_" "_$e(%,2,99)_" "_$tr($g(@($e(%,2,99))),","_$c(4),"  ")
 s %VarList=%VarList_%2_" %VarList "
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d
 .q:"@"[$e(%_"@")
 .i $d(@%)#2 s %MsgMV(%1)=$c(4)_%_"="_$e(@%,1,15000) d:$l(@%)>15000 
 ..f %2=15001:15000:$l(@%) s %MsgMV(%1*100000_"."_%2)=$e(@%,%2,%2+14999)
 .q:$d(@%)<2
 . s %3=%_"("""")" f %4=1:1 s %3=$q(@%3) q:%3=""  i $d(@%3)#2 d
 .. s %MsgMV(%1*100000+%4)=$c(4)_%3_"="_$e(@%3,1,15000)
 .. i $l(@%3)>15000 f %2=15001:15000:$l(@%3) s %MsgMV(%1*100000+%4_"."_%2)=$e(@%3,%2,%2+14999)
 s %1=0,%2="%MsgMV"
 f  s %2=$q(@%2) q:%2=""  s %1=%1+$l(@%2) q:%1>15000  s %MsgMV=%MsgMV_$c(4)_@%2 k @%2
 q:$zv'["U) " %MsgMV  q $$U^MXF(%MsgMV)
GetList(%,%VarList) 
 k %MsgMV s %MsgMV=%_$c(4),%VarList=$g(%VarList)
 i $g(%ErrorM)'="" s %VarList=%VarList_" %ErrorM"
 n %1,%2,%3,% s %2=""
 s %MsgMV=%MsgMV_$g(%VarList)_$c(4)_"$j="_$j_$c(4)
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d:$e(%)="@"
 . s %2=%2_" "_$e(%,2,99)_" "_$tr($g(@($e(%,2,99))),","_$c(4),"  ")
 s %VarList=%VarList_%2_" %VarList "
 f %1=1:1:$l(%VarList," ") s %=$p(%VarList," ",%1) s:%["~" %=$tr(%,"~") d
 .q:"@"[$e(%_"@")
 .i $d(@%)#2 s %MsgMV(%1)=$c(4)_%_"="_$e(@%,1,8000) d
 ..i $l(@%)>8000 f %2=8001:8000:$l(@%) d
 ... s %MsgMV(%1*100000_"."_%2)=$e(@%,%2,%2+7999)
 .q:$d(@%)<2
 . s %3=%_"("""")" f %4=1:1 s %3=$q(@%3) q:%3=""  i $d(@%3)#2 d
 .. s %MsgMV(%1*100000+%4)=$c(4)_%3_"="_$e(@%3,1,8000)
 ..i $l(@%3)>8000 f %2=8001:8000:$l(@%3) d
 ... s %MsgMV(%1*100000+%4_"."_%2)=$e(@%3,%2,%2+7999)
 s %1=$l(%MsgMV),%2="%MsgMV" f  s %2=$q(@%2) q:%2=""  s %1=%1+$l(@%2) d
 . i %1<8000 s %MsgMV=%MsgMV_$c(4)_@%2 k @%2
 q %MsgMV
latv1(%) 
 s %="e{275}{274}u{363}{362}i{299}{298}a{257}{256}s{353}{352}g{291}{290}k{311}{310}l{316}{315}z{382}{381}c{269}{268}n{326}{325}..{1081}{1049}{1094}{1062}{1091}{1059}{1082}{1050}{1077}{1045}{1085}{1053}{1075}{1043}{1096}{1064}{1097}{1065}{1079}{1047}{1093}{1061}{1098}{1066}{1092}{1060}{1099}{1067}{1074}{1042}{1072}"
 s %=%_"{1040}{1087}{1055}{1088}{1056}{1086}{1054}{1083}{1051}{1076}{1044}{1078}{1046}{1101}{1069}{1103}{1071}{1095}{1063}{1089}{1057}{1084}{1052}{1080}{1048}{1090}{1058}{1100}{1068}{1073}{1041}{1102}{1070}"
 n o s o="..|."
 s %=%_$c(254)_o_$c(179)_"."_$c(186)_"."_$c(182)_"."_$c(197)_"."_$c(199)_"."_$c(180)_"."_$c(195)_"."_$c(196)_"."_$c(205)_"."_$c(213)_"."_$c(209)_"."_$c(187)_"."_$c(218)
 q $$Uu^MXF(%_"."_$c(193)_"."_$c(194)_"."_$c(192)_"."_$c(212)_"."_$c(190)_"."_$c(202)_"."_$c(201)_"."_$c(200)_"."_$c(203)_"."_$c(206)_"."_$c(207)_"."_$c(178)_"."_$c(176)_"."_$c(177)_"."_$c(178)_".")  
%ALstart(%FILE) 
 q 1
ALwrite(%List) 
 n %h s %h=$c(4),%B=$c(254),%Lg="",%Lii="",%FILE=""
 f %=1:4:999 s %1=$p(%List,%h,%,%+3) q:$p(%1,%h,4)=""  d
 . s %K=$p(%1,%h),%n=$p(%1,%h,2),%g=$p(%1,%h,3),%FILE=$p(%1,%h,4)
 . i %g<0,%K="" s %=9999 q
 . i %g<0 s:+%K'=%K %K=""""_%K_"""" s $p(%Lii,",",-%g)=%K
 . i %g>0 s $p(%Lg,%B,%g+1)=%K
 i %<999,%FILE'="" s @("^"_%FILE_"("_%Lii_")")=%Lg,(%Lg,%Lii)=""
 q
readI(%i,%xColumn) 
 x "s $zt=""Err^USX"""
 I %i'["^"!(%i'["(") q "-^-(-?-)-"
 I $d(@%i)#2=0 q "00"
 s %R=$g(@%i),%I=$NAME(@%i) d:$l(%R)=500  n %1 s %1=$e($p(%i,"("),2,99)
 .n % f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 x %XG(%1),%XI(%1) i $d(^mxConfig("A")),'$$tAccess^US("A",%1) s %R="" x %XG(%1) q 0
 q 1
zo(%i,%di,%MV) 
 i %i["("""""""")" s ^ERROR(%i)="zo^USX" q ""
 n %,%I,%R,%IR,%n,%1 s %R=""
 s %1=$e($p(%i,"("),2,99)
 i $g(%LII(%1))=""!($g(%LI(%1))="") d
 .  n %i,%di,%MV d ^USX s %LI(%1)=$g(^AL(%1,"%LI"))
 i '%di s %R=$g(@%i),%I=$NAME(@%i) d:$l(%R)=500  i 1
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 e  s %I=$$zo500(%i,%di) i $l(%I),%I'["("""")" s %R=$g(@%I) d:$l(%R)=500
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 x %XG(%1),%XI(%1) s %IR=%I
 i $d(^mxConfig("A")),'$$tAccess^US("A"),%i'["("""")" s %I=%i,%R=$g(@%i) x %XG(%1),%XI(%1) q $$MsgVMV("$$zo^USX",%MV)
 f %=1:1 s %n=$p(%LI(%1),",",%) q:'$l(%n)  d:%n["~"  s %IR=%IR_$c(9)_@%n
 . i %n'["~~" s %n=$tr(%n,"~") q
 . s %n=$tr(%n,"~") s:'$d(%XG0(%1,%)) %XG0(%1,%)=$p($g(^AL(%1,"%W",%n,0)),";",2,99)
 . s o=%XG0(%1,%) n %K,%1,% x o s:$d(%K) @%n=%K
 i %R="" s %IR=""
 q $$MsgVMV("$$zo^USX",%MV)
 ; ; q $$GetList("$$zo^USX",%MV)
mxGetBlo(h4,h5,BloSize) 
  ; ; %zr  %zr0 
 q:%zr'[%zr0 ""  n blok,%r,%,o500 s blok=""
 s h4=$g(h4,$c(4)),h5=$g(h5,$c(5)),BloSize=$g(BloSize,10000)
 f  s %zr=$q(@%zr) q:%zr'[%zr0  d  s %zr=o500  q:$l(blok)>BloSize
 .s %r=@%zr,o500=%zr
 .i $l(%r)=500 f %=501:500 q:$g(@%zr@(%))=""  s %r=%r_@%zr@(%),o500=$NAME(@%zr@(%))
 .i h4<0 s blok=blok_%r_h5 q
 .s blok=blok_%zr_h4_$tr(%r,%B,h4)_h5
 q blok
zoIRg(%i,%di) ; 20060214
 n %,%IR,o,%Zon,%oP1,%oll s o=%i,%oP1="",%oll=0 k ooozoIRg
 i $d(@%i)#2 x:$zv'["GT" "s o=$q(@o,-1)" i o="" s o=$$zoIR(%i,0)_$c(4),ooozoIRg(0)=o w o q 0
 s %=$p($g(%i)_"))))","))))"),%Zon=$p(%_"""""""","""""""")
 q:o="" $c(4)
 f %=0:1 s %IR=$$zoIR(o,%di),%1=$p(%IR,$c(9)) q:o=%1  q:%1'[%Zon  d
 . s %oll=%oll+$l(%IR)+1 i %oll>15000 s ooozoIRg(%)=%oP1,%oP1="",%oll=$l(%IR)+1
 . s o=%1,%oP1=%oP1_%IR_$c(4)
 s:$l(%oP1) ooozoIRg(%)=%oP1
 q %
zoIRn(%i,%di,%3) 
 s %="",ooo="" i $$zoIRo(%i,%di,99999)
 f  s %=$o(^o(%USID,%),-1) q:'%  s ooo=^(%)_$c(4)_ooo q:$l(ooo)>25000
 q ooo
zoIRo(%i,%di,%3) 
 n %,%IR,o,%Zon s o=%i,%3=$g(%3,99999) q:o="" 0  k ^o(%USID)
 i $d(@%i)#2 x:$zv'["GT" "s o=$q(@o,-1)" i o="" s ^o(%USID,1)=$$zoIR(%i,0) q 1
 s %=$p($g(%i)_"))))","))))"),%Zon=$p(%_"""""""","""""""")
 f %=1:1:%3 s %IR=$$zoIR(o,%di),%1=$p(%IR,$c(9)) q:o=%1  q:%1'[%Zon  d
 . s o=%1,^o(%USID,%)=%IR 
 q %-1
zoIR(%i,%di,%Zon) 
 n %,%I,%R,%IR,%n,%1,o
 s %1=$e($p(%i,"("),2,99)
 i $g(%LII(%1))=""!($g(%LI(%1))="") d
 .  n %i,%di,%MV d ^USX s %LI(%1)=$g(^AL(%1,"%LI"))
 i '%di s %I=$NAME(@%i),%R=$g(@%I) d:$l(%R)=500  i 1
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 e  s %I=$$zo500(%i,%di) s:%I="" %I=%i s %R=$g(@%I) d:$l(%R)=500
 . f %=501:500 q:$g(@%I@(%))=""  s %R=%R_^(%)
 x %XG(%1),%XI(%1) s %IR=%I
 i $d(^mxConfig("A")),'$$tAccess^US("A",%1) q %IR
 f %=1:1 s %n=$p(%LI(%1),",",%) q:'$l(%n)  d:%n["~"    s %IR=%IR_$c(9)_$s($l(@%n)<1023:@%n,1:$l(@%n)_">1023")
 . i %n'["~~" s %n=$tr(%n,"~") q
 . s %n=$tr(%n,"~") s:'$d(%XG0(%1,%)) %XG0(%1,%)=$p($g(^AL(%1,"%W",%n,0)),";",2,99)
 . s o=%XG0(%1,%) n %K,%1,% x o s:$d(%K) @%n=%K
 q %IR
zo500(i0,di) 
 n i,%KeM s i=i0 i i0'[%FILE n %FILE s %FILE=$e($p(i0,"("),2,99)
 s %KeM=$g(%KEM(%FILE)) s:'%KeM (%KeM,%KEM(%FILE))=$l(%LII(%FILE),",")
 i 'di q:$ql(i)=%KeM i0
 i di'<0 f  s i=$q(@i) q:'$l(i)  q:$ql(i)=%KeM
 i di<0 f  s i=$q(@i,-1) q:'$l(i)  q:$ql(i)=%KeM
 q:'$l(i) i0  q:$o(mxConfig("^"))'["^" i 
 n % s %=$o(mxConfig($p(i0,"("))) q:'$l(%) i0  q:i'[% i0
 q i
vFoundI(%i,f) 
 n %FILE,%,zr  s f=$g(f)
 s %FILE=$e($p(%i,"("),2,99)
 I f=0 k ^rMX(%USID,"vFoundI",%FILE) q 0
 s %="^rMX(%USID,""vFoundI"",%FILE,"_$p(%i,"(",2,99) I f>0 s @%=f q f
 s %=$d(@%),zr=$NAME(@%)
 I %<1 s %=$q(@zr) I %["vFoundI" s %="^"_%FILE_"("_$p(%,",",4,99)
 q %
CheckSyn(%RN,text) 
 ; Syntaxis checking
 q:$zv["GT" "ok"    ;;;;;;; GT.M - no checking... ;;;;
 q:$zv["MiniM" "MiniM"    ;;;;;;; MiniM - no checking... ;;;;
 n LN,OFS,%,LBL,K,LINE,zt,error s text=$g(text)
 x "s zt=$zt,$zt=""erChSy"""
 i %RN[" ",text="" s text=" "_%RN
 i text[$c(4) s text=WMcode(text)
 i text'="" s %RN="r" x "zr  zi text zs r zl r zs r::1" S LN=$ZA,OFS=$ZB
 i text=""  x " zl @%RN ZS @%RN::1" S LN=$ZA,OFS=$ZB
 I LN=0,OFS=0 Q "ok!"
 S LBL="",K=0
 F %=1:1:LN S LINE=$T(+%^@%RN) Q:LINE=""  d
 . S K=K+1 I $P(LINE," ")'="" S K=0,LBL=$P(LINE," ")
 s LINE=text S:'$l(text) LINE=$T(+LN^@%RN)
 x:$zv'["MiniM" "s $zt=zt" s error="?"
 i $l(LINE,"(")-$l(LINE,")") s error=")("
 i $l(LINE,"""")#2=0 s error=""""""
 q +LN_":"_LBL_"+"_K_"c"_OFS_"@"_error_"@"_LINE
erChSy x "s %=%USID_"".CheckSyntax^USX: name of routine is unvalid !! ""_$ze"
 s $zt=zt q %_";"_$c(0)
MWcode(%1) 
 n %,%2,%3,s
 s %=$c(179)_$c(186)_$c(182)_$c(197)_$c(199)_$c(180)_$c(195)_$c(196)_$c(205)_$c(213)_$c(209)_$c(187)_$c(218)_$c(193)_$c(194)_$c(192)_$c(212)_$c(190)_$c(202)_$c(201)_$c(200)_$c(203)_$c(206)_$c(207)_$c(178)_$c(176)_$c(177)_$c(178)
 q:$tr(%1,%_%1,%)="" %1
 s %2="" f %3=1:1:$l(%1) s s=$e(%1,%3) d:%[s  s %2=%2_s
 . s s=$c(4)_$e(1000+$a(s),2,9)
 q %2
WMcode(%2) 
 i %2'[$c(4) q %2
 s %1=$p(%2,$c(4))
 f %=2:1:$l(%2,$c(4)) s s=$p(%2,$c(4),%),%1=%1_$c($e(s,1,3))_$e(s,4,999)
 q %1
uci q
ic(%USID,%) 
 n %1
 i $g(%)'="",$$RestMem^USX(%USID,%)
 i $$icDate^MXD(%XD81,%XD82)
 q 1
xEmpty() 
 q ""
fo(fo) 
 n %,%1,%2
 s %=$$trw^UST(fo,"s~","$$s^USX("""),%=$$trw^UST(%,"v~","$$v^USX(""") q:%=fo fo
 f %=2:1:$l(fo,"~") s %1=$p(fo,"~",%) d
 . f %2=2:1:99 q:",_*\/ #+-)?!"[$e(%1_" ",%2)
 . S $p(fo,"~",%)=$e(%1,1,%2-1)_""")"_$e(%1,%2,999)
 s %=$$trw^UST(fo,"s~","$$s^USX("""),%=$$trw^UST(%,"v~","$$v^USX(""")
 q %
xForma(%I,%xForma) 
 n %FILE,% s %xForma=+$g(%xForma)
 s %FILE=$e($p(%I,"("),2,99) q:%FILE="" "?? %I non correct"
 i '%xForma q "?? "_%xForma
 k ^xForma s %j=+%j_" xForma "
 i $d(^AL(%FILE,"%xForma",%xForma)) x ^(%xForma) s %j=+%j q %xForma
 f %=9:-1:2 i $d(^(%)) x ^(%) q
 s %j=+%j n %1 i '$g(%xForma) q %xForma
 s %=%FILE_"^AL" x "s %1=$t("_%_")" i $l(%1) d @% q %FILE
 q "?? "
 q

USb
USb ; ;[ 20190219 13:36:55 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 k koko,%NG,%xgl,%NEW,%US,%AL
 i $$icFIRMA^fir
 s %FILE=$tr(%FILE," ","") i $l(%FILE),$d(^mxConfig("A",%FILE)),'$d(^(%FILE,%USID)) q
pAL n o,%,%n,%1,%zt,u s %="",o=""
 f  s %=$o(^AL(%FILE,%)) q:%=""  s %(%)=$g(^(%)) d
 . f  s o=$o(^AL(%FILE,%,o)) q:o=""  d
 ..  i $e(o,1,2)="t_" d  q
 ...    i %'=%USID s o(o)=^(o) ;; k:$h-%(%)>222 ^AL(%FILE,%) q
 ...    else  s %AL(o)=^(o)  ;; s:%(%)-$h ^AL(%FILE,%)=$h,%(%)=$h ;; m %AL(%)=^AL(%FILE,%)
 ..  m %AL(%)=^AL(%FILE,%)
 ;
 k %AL("blank"),%AL(1),^AL(%FILE,"t_FontName"),^("CAP"),^("%FOK")
 k %W s %n=99,%W=%FILE f  s %n=$o(%AL("%W",%n)) q:%n=""  s %2=1 d
 . f %=-2,-1,1:1:9 i $p($g(%AL("%W",%n,%)),";")'="" d
 .. i %>0 s %W(%n,%2)=%AL("%W",%n,%),%2=%2+1 q
 .. s (o,%W(%n,%))=%AL("%W",%n,%) i o[18,$e(%n)="s" d  s %W(%n,%)=o
 k %AL("%W"),o("t_FontName"),o("t_Number")  m o=%AL m %AL=o k ^oAL m ^oAL=%AL
 ;  s o="" f  s o=$o(o(o)) q:o=""  i '$d(%AL(%USID,o)) s %AL(%USID,o)=o(o)
 S %1=%FILE D ^USX,%xgl^USX
 q:'$d(%CON(%FILE))  ;; -------------------
 s %gFILE="^"_%FILE,%SF=""
 S %LI(%FILE)=$G(^AL(%FILE,"%LI")),%LII(%FILE)=$g(^AL(%FILE,"%LII"))
 s %KEM=$L(%LII(%FILE),","),%LG="%SF"
 F %=1:1 S %N=$P(%LI(%FILE),",",%) Q:%N=""  S:","_%LII(%FILE)_","'[(","_%N_",") %LG=%LG_","_%N
 S %GM=%-1,%LG(%FILE)=%LG,o=0
 ;; f  s o=$o(o(o)) q:'$l(o)  s:$l(o(o),":")>%GM (o(o),^AL(%FILE,o),%AL(%USID,o))=$p(o(o),":",1,%GM) s:'$d(%AL(%USID,o)) %AL(%USID,o)=o(o)
 f %G=1:1:%GM s %N=$p(%LI(%FILE),",",%G) s:%N["~" %N=$tr(%N,"~") d
 .s %NG(%G)=%N,@%N=$g(@%N,"-"),%G(%N)=@%N,%W(%N)=$g(%W(%N,0)),%W(%N,-1)=$g(%W(%N,-1))
 S (%E,%K,%R)="",%B=$c(254),%G=1,%FIN=0
 i $g(%refreAL) k %refreAL q
CapEr s %zt=$zt,$zt="Err^USb" x $G(^AL(%FILE,"START")) s $zt=%zt
 i $g(^AL(%FILE,"START"))[" show last ",'$d(^otSelect(%USID,%FILE)),$o(%tSelect("^"_%FILE_"("))'[("^"_%FILE_"(") d
 . n o,%I,%1 s %1=0,%="^mM("""")" f o=1:1:9999 s %=$q(@%,-1) q:'$l(%)  i $qs(%,2)[("1^"_%FILE_"(") s %I=$e($qs(%,2),2,999) i $d(@%I) s ^otSelect(%USID,%FILE,%I)=1,%1=%1+1 i o>100 q:%1>2
 k ^mxAL(%USID,%FILE)
 k ^AL(%FILE,"ColumnWidth"),^("blank"),^("Fx"),^("prKadr") i "PPR PAV"[%FILE k ^("Tf")
 g RUN^US
e0 
E0 
%USID i '$d(%USID) s %USID="GTM" i $zv'["MiniM" x:$zv'["GT.M" "s %USID=$zu($s($zv[""Ca"":5,1:0))"
 x:$zv["MiniM"&'$d(%USID) "s %USID=$znspace" s ^JOB(%USID)=$h
 q
Enter(%,%Ymn,%Ymx,%Xmn,%Xmx,%ww,%Zona) 
 s:%["^" %=$e($p(%,"("),2,99) s %FILE=%
 d USb
 q ""
Err s %mxWarng(0)=$g(^AL(%FILE,"START"))_" --- ERROR IN START-COMMAND --- "_$zr q

UShelp
UShelp  ;[ 20191012 17:58:34 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS 2005-2018
 q ""
Rcomp(f,Rout,UCI2) ; f=0/1 (short/full form)
 ; routines compare between UCI's
 k oRcomp n %UCI x:$zv["MiniM"!($zv["Ca")!($zv["IRIS") "s %UCI=$znspace"  x:'$d(%UCI) "s %UCI=$zu(0)"
 n o,%,x,z,zz,t,m,n,e,xzr s e="" s:'$d(UCI2) UCI2=%UCI
 i " "[$g(Rout) q " Rout=?? "
 i $zv["Ca"!($zv["MiniM")!($zv["IRIS") q:'$d(^$ROUTINE(Rout)) Rout_" - not exist in "_%UCI
 i $zv["Ca"!($zv["MiniM")!($zv["IRIS") x "zn UCI2 s %=$d(^$ROUTINE(Rout)) zn %UCI" q:'% Rout_" - not exist in "_UCI2
 i $zv["MS" d
 . x "S %UI=$S(UCI2?3U:$ZU(UCI2),1:$ZU($P(UCI2,"",""),$P(UCI2,"","",2)))"
 . x "S %UI=32*$P(%UI,"","",2)+%UI,%HI=$V(2,$J,2)"       ; %HI=0  %UI=1
 k ^r s zz=1
 s ^r(1)=" ;"_Rout_"_1_"_UCI2
 s ^r(0)=" ;"_Rout_"_0_"_%UCI
 s %="V 2:$J:%UI:2  zr  zl:$d(^ (Rout)) @Rout  V 2:$J:%HI:2"
 ;
 i $zv["Ca"!($zv["MiniM")!($zv["IRIS") d
 . zn UCI2 n r f %=1:1 Q:'$l($t(+%^@Rout))  S r(%)=$t(+%^@Rout)
 . zn %UCI m ^r(1)=r s m(1)=+$o(^r(1,9999),-1)
 i $zv["MS" x "x %  f %=1:1 q:'$l($T(+%))  s ^r(1,%)=$t(+%),m(1)=%"
 f %=1:1 q:'$l($t(+%^@Rout))  S ^r(0,%)=$t(+%^@Rout),m(0)=%
 i '$d(^r(1,1)) q " ..not exist in "_UCI2
 s o="" i $g(m(0))-$g(m(1)) s o=$g(m(0))_":"_$g(m(1))
 i o="" f n=2:1:m(1) i $$Uu^MXF(^r(0,n))'=$$Uu^MXF(^r(1,n)) s o=n_".."_$e(^r(0,n),1,12) q
 ;
 q:o=""!'f o
 ;
 f x=0,1 s me=-1,nn=0 f n=1:1:m(x) d
 .s t=$p(^r(x,n)," ") i t'="" s me=$p(t,"("),nn=0,t(me,x)="   ----- "_n
 .s nn=nn+1,(t(me,x,nn),t)=^r(x,n)
 .f %=-7:1:7 i t=$g(t(me,'x,nn+%)) k t(me,x,nn),t(me,'x,nn+%) q
 .q:'$d(t(me,x,nn))!'$d(t(me,'x,nn))  
 .s t2=t(me,'x,nn) s t(me,x,nn)=t,t(me,'x,nn)=t2
 s me="" f  s me=$o(t(me)) q:me=""  d  k:$d(t(me,0))+$d(t(me,1))<5 t(me)
 .f x=0,1 s n=0 f  s n=$o(t(me,x,n)) q:'n  k:"     "[t(me,x,n) t(me,x,n)
 k ^r m oRcomp=t 
 q ""

USm
USm ;US.m -setup^AL [ 03/28/2005  1:06 AM ]  ;[ 20070204 19:51:29 ]
 ; M3-LITE, MSM-4.4x, CACHE-3x..5x, GT.M-5x
 ; Soft-in-cell  MX Copyright(c) SIA ENTERS  1997-2007
 ; 
 q
SelALGlo(%all) 
 n %,%1,%s k %SEL s %=""
 s %s="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM%1234567890"
 f  s %=$o(^AL(%)) q:%=""  i $tr(%,%s_%,%s)=%,'%,$e(%)'=0 i $d(^AL(%,"NAME")) s %1="^"_% d
 . i '$g(%all),$d(@%1) k @%1@("-") s:$d(@%1) %SEL(%)=^AL(%,"NAME") q
 . q:'$g(%all)  i '$d(@%1) s %SEL($c(254)_%)=^AL(%,"NAME")
 q $d(%SEL)

ZFIO
ZFIO ; ATG.Alga/pers. ; [ 02/23/2006  5:15 PM ]  ;[ 20190118 18:52:33 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX inCellSoft  Copyright(c) SIA ENTERS  2005-2019
 ; 
 N %R,%,d,%n,%1,%2,n,nn,nnn,f,max,o,DCH0
 k CF,DCH,du,dp,diPak,kPak,Amats,SN,zF,kFIO,paseDati
 i '$d(%XG("pers")) s %1="pers" d ^USX
 S %R=$G(^pers(+$g(T))) s:'$l(%R) %R=$g(^persArhi(+$g(T))) s:$l(%R)=500 %R=%R_$g(^(+T,501))_$g(^(1001)) s:%R[$c(10) %R=$tr(%R,$c(10),"^")
 s zF=0 X %XG("pers")
 s:DCH["k" DCH=$$trw^UST(DCH,"k","200"),$p(%R,%B,8)=DCH s DCH0=DCH
 ; flagDCH !! (not flagCDR):
 i $g(flagDCH),$l(DCH,-%gm)>2 f o=1:1 d  q:%2'[-%gm  s DCH=%1_%gm_%2
 .  s %1=$p(DCH,-%gm),%2=$p(DCH,-%gm,2,99)
 f o=2:1 s %n=$tr($p(%LI("pers"),",",o),"~") q:'$l(%n)  d
 . i @%n[" " s @%n=$p(@%n_"          ","          ") s:'$l(@%n) @%n=0
 . f  q:@%n_"!!!"'["^!!!"  s @%n=$e(@%n,1,$l(@%n)-1)
 s atbrkods=$p(SN,"^",$l(DCH,"^")),%2=0 
 f n=1:1:$l(DCH,"^") s %1=%2,(%,%2)=$p(DCH,"^",n) d   
 .i $zr'["Arh" s:$tr(%1,"-")>$tr(%2,"-") %mxWarng(+T)=%1_"--"_%2_" -- uz "_$zr_" datums ievad{299}ts nepareizi (nevis hronolo{291}iski) ! "_DCH 
 .s:-%[-9 %=19_%  s:%[-9 %=-19_-%  s d(+%)=+%
 .s %=+$p(%_" "_$p(kPak,"^",n),"-",2) i %>19600000 s d(%+.2)=-% q
 .s %=+$p($p(kPak,"^",n),"-",3)       i %>19600000 s d(%+.2)=-% q
 s %=1,(dp,du,DFIO)=0,dpu=DCH
 ;  i $g(flagpers) k pers1 m pers1=d 
 f  s %=$o(d(%)) q:%=""  d:%gm_33>%
 .i d(%)>19600000 s DCH(%)=d(%)
 .i d(%)>19600000 s dp(%)=% s:dp["-"!'dp dp=%,DFIO=%
 .i d(%)<-19600000 s (du,du(%\1))=%\1,dp=dp_"-"
 s:du<dp du=0 i du,-du'[-%gm s DFIO=0
 f o=2:1 s %n=$tr($p(%LI("pers"),",",o),"~") q:'$l(%n)  i %n'="DCH" d:@%n["^"!(%n="SN")
 .s n=$g(@%n) k @%n s:$e(n)="^" n="-"_n s %1="?",nn="nn?"
 .f %=1:1:$l(DCH,"^") d
 ..s:$p(n,"^",%)="" $p(n,"^",%)=%1
 ..s nnn=$g(@%n),@%n=$p(n,"^",%) s:@%n'="" %1=@%n
 ..s @%n=$tr(@%n,";",":"),d=+$p(DCH,"^",%) i %n="SN",SN,d>0,SN<9 s SN=$p(SN,+SN,2,9) s:SN="" SN="-"
 ..i d<0 s d=-d i %n="SN",SN s:SN<0 SN=$tr(SN,"-") i %>1 s SN=+SN_$s(nn>1:$p(nn,+nn,2,9),1:" "_nn)
 ..  s:-d[-9 d=19_d q:d<19600000
 ..i d>(%gm_33) s:nnn'="" @%n=nnn q
 ..i %>1 s:@%n="" @%n=nn
 ..x "s "_%n_"(d)=@%n" s nn=@%n
 S TARF="",ADRF=ADR
 s SN=$tr(SN,"|") s:+SN=1 SN=$e(SN,2,99) s:SN="" SN="-"
 i SN["i"!(SN["r") s %=0  d  s:% ^persO(T,%gm*100,"SNxxxPAK")=%,^persO(T,$e(DCH,1,6)*100,"SNxxxPAK")=%
 . s:SN["i2"!(SN["i3")!(SN["iii") %="090" i SN["r" s %=$s(SN["rv":"091",1:"092")
 s %=Fi_" ",sex=$s(%[" v ":"v",%[" s ":"s",%["s ":"v",1:"s")
 S FIO=Fi,Fi=$p(Fi," ",1,2) s:$e(Fi)=" " Fi=$e(FIO,2,99) i $e(Fi,2,99)'[" " s Fi=$tr(Fi," ")_" "_$tr(FIO," ") s:$l(Fi)<3 Fi=$tr(FIO," ")_+T_" "_+T_$tr(FIO," ")
 s %=19_$e(KODS,5,6)_$e(KODS,3,4)_$e(KODS,1,2),ageGG=%XD82-%\10000,dzimDat=%
 k mAlga,mKoef m mAlga=diPak,mKoef=kPak
 s %=$o(DCH(""),-1) S:% DCH=DCH(%) s DCH=+DCH
 i mxConfig[":LM:" s UB=+$p(CF,".",2),CF=CF\1 i 'DFIO,T,$d(^AM(T,%gm)) d
 . s o=$g(^(%gm,242)) k:o<.001 ^(242) s:$d(^AM(T,%gm)) DFIO=%gm_33
 s (VEF,Cf,VED)=CF,KAF=Amats,Agrupa=Amats
 i Amats,Amats<99 s (VED,VEF)=+Amats,Amats=$p(Amats,+Amats,2,9)
 i Amats>99 s:Amats?4n&'zF zF=+Amats,Amats=$p(Amats,+Amats,2) s Agrupa=$p(Amats,+Amats)_+Amats,Amats=$p(Amats,+Amats,2,9)
 s:Fi["VAKANCE"!($l(Fi)<3) DFIO=0 s:Amats="" Amats=0
 i $l($g(paseDati))<3 s paseDati=IZD
 k nereKODS s %=$p(ADR,",") i $l(%)=2,$d(^kNo("VK",%)) s nereKODS=%_$p(KODS,",",2),KODS=$p(KODS,",")
 s kFIO=0 i $g(persAizs)<0 s KODS="xxxxxx-xxxxx",(paseDati,Amats,Fi,ADR)="Person{257}ldatu Aizsadz{299}ba"
 i -du'[-%gm,-dp'[-%gm s kFIO(%gm)=1,kFIO=1 q
 ;
 s %1=$o(dp(%gm*100),-1),%2=$o(du(%gm*100),-1),f=%2<%1
 s:'%2 f=1 s:'%1 f=0
 s max=28+$e(3_($e(%gm,1,4)#4=0)_3232332323,$e(%gm,5,6))
 f %=%gm*100+1:1:%gm*100+max d
 . i $d(du(%)) s f=0,kFIO=kFIO+1 q
 . i $d(dp(%)) s f=1,kFIO=kFIO+1 q
 . s kFIO=kFIO+f
 s kFIO=kFIO/max s:kFIO>1!'kFIO kFIO=1
 s:SN["n" kFIO=1 s kFIO(%gm)=kFIO
 q
T(T,%gm) 
 s %gm=$e(%gm,1,6) d ZFIO
 q Fi_" "_KODS_" "_Amats
m(%gm) 
 s %gm=$e(%gm,1,6) d ZFIO 
 q ""
pers 
 q
IZD(iz0,iz,iz8) 
 n %,%1,%2,%3
 s iz=$e(100000000+iz,2,9),iz0=$e(100000000+iz0,2,9)
 s %3=$e(iz0,7,8)-$e(iz,7,8)
 s %2=$e(iz0,5,6)-$e(iz,5,6)
 s %1=$e(iz0,1,4)-$e(iz,1,4)
 s %3=$e(iz8,7,8)-%3,%2=$e(iz8,5,6)-%2,%1=$e(iz8,1,4)-%1
 i %1<0 s %1=%1+30,%2=%2-1
 i %2<0 s %2=%2+12,%1=%1-1
 s %=%1*100+%2*100+%3
 q %
period(T,d1,%3) 
 n o,oo,ooo,ffff,m,periods,o1,o2,d1o,%R 
 i $g(d1)<1 s d1o=$g(d1),d1=%gm\100_"0101"
 s %R=$g(^pers(+T)) s:%R="" %R=$g(^persArhi(+T)) s:$l(%R)=500 %R=%R_$g(^(+T,501))_$g(^(1001)) s:%R[$c(10) %R=$tr(%R,$c(10),"^")
 s oo=$p(%R,%B,8),oo=$tr(oo,"^","|"),oo=$$trw^UST(oo,"-","|-")
 s oo=-2_"|"_$$trw^UST(oo,"||","|"),ooo=""
 s ffff=0 f o=1:1:199 s o1=$p(oo,"|",o),o2=$p(oo,"|",o-1) d:o1
 .i o1<0,-o1<d1 s ooo="" q
 .i o1>(d1-1),o2<-1,o1<(%XD82+.1) s ooo=ooo_$e(o1,7,8)_"."_$e(o1,5,6),ffff=1
 .i o1<0,-o1<(%XD82+1),-o1>(d1-1) s ooo=ooo_"-"_$e(o1,8,9)_"."_$e(o1,6,7)_" ",ffff=-1
 s o="01.01"
 s:ooo<0 ooo=o_ooo s ooo=$p(ooo_"   ","   ")
 i ffff>0!$g(%3) s ooo=ooo_"-"_($e(3_($e(%gm,1,4)#4=0)_3232332323,%gm#100)+28)_"."_$e(%gm,5,6)
 i $g(d1o)<0,'$g(%3) f o=$l(ooo," ")-1:-1:1 i $e($p(ooo," ",o),10,11)<$e($p(ooo," ",o+1),4,5) s ooo=$p(ooo," ",o+1,999) q
 q ooo_"."_$e(%gm,1,4)_".g."
pers1(T) q 0
 ;
pers0(T) q 0
Fi(gm) n %R,Fi s:'$d(gm) gm=%gm
 S %R=$G(^pers(+$g(T))) s:%R="" %R=$g(^persArhi(+T)) s:$l(%R)=500 %R=%R_$g(^(+T,501))_$g(^(1001)) s:%R[$c(10) %R=$tr(%R,$c(10),"^")
 q:'$l(%R) +$g(T)_"-nav-sarakstaa -"_$g(T)
 s Fi=$p(%R,%B,2) q:Fi'["^" Fi  n DCH,n,% s DCH=$p(%R,%B,8),%R=Fi
 f n=1:1:$l(DCH,"^") s %=$p(DCH,"^",n) i %>0 q:$e(%,1,6)>gm  s:$l($p(%R,"^",n))>2 Fi=$p(%R,"^",n)
 q Fi

ZSTU
mx ; d TCPSTART^APIMGR  ;[ 20160203 14:57:53 ]
tcp j tcp^MX1  j web^MX1

ZT
ZT ; ATG.alga (galv.moduls)  [ 09/20/2005  5:10 PM ]  ;[ 20191118 14:35:34 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 ; 
 k bS,As s %gm12=%gm d ZTA i $$NewDate^MXD
 i $$ZWAM("^AM")
 q
ZTA 
 n TTT s TTT=+T k ^oT(T,%gm) i %gm-%gm(0),$$NewDate^MXD(%gm)
 n %FILE,%I,%I2,o,O,%R,Oava,OalgBan
 K SU,SUsoc,SUnor,MI,RM,AM,S,uzd,As,NM,a,bSoc,%MINM,%algNod,N,%soc,persO
 i $$m^ZFIO(%gm)
 q:'DFIO
 S (QL,HF,ZA,KA,DF,C,REM,PLUS,MINUS,BSalim,BSsoda,BSoc,bSoc,dBezSocS)=""
 S:'VEF VEF=CF
 s (M,gm)=%gm
algBan s o=Or,OalgBan=0,Oava=Oavans
 f  s o=$o(^algBan(o)) q:'o  i $d(^(o,T)) s SU(o,%gm)="-*" d
 . s %=$p(^(T),%B,6),%2=$p(%,"-",2) s:%2<%gm&%2 %=999999 i %>200000,$e(%,1,6)>%gm k SU(o) q
 . s %=$p(^(T),%B,5),%2=$p(%,"-",2) s:%2<%gm&%2 %=999999 i %>200000,$e(%,1,6)>%gm k SU(o) q
 . s:+o?3n OalgBan=+o,Oava=o-1 s:Oava=900!'$d(^O(Oava)) Oava=Oavans
avans ;  avanss uz banku
 i '$d(xAVANS) d:$d(^AVANS(%gm,T))
 . s VED=$p(^(T),%B,3) s:'VED VED=-%gm
 . s (s,SU(Oava,VED))=$p(^(T),%B,2)
 . i s["%" s (s,SU(Oava,VED))=$j(s*$g(^AM(T,%gm))/100,0,0)
 . i s["o=" k SU(Oava,VED) s SU($p(s,"o=",2),VED)=s
 ;
 i '$d(xAVANS) s o=%gm*100 f  s o=$o(^AVANS(o)) q:-o'[-%gm  i $d(^(o,T)) d
 . s VED=$p(^(T),%B,3),bk=$p(^(T),%B,4) s:'VED VED=-%gm_VED
 . s s=$p(^(T),%B,2) i s["%" s s=$p(s,"%",2)
 . s:bk'["k" SU(Oava,o)=s s:bk["k" SU(Oavans,o)=s
 i $d(xAVANS) x xAVANS,$g(xAVANS2)
AM S %1=$tr($g(^AM(T,%gm(-1))),%B,","),%2=$P(%1,",",2)
 s %=%1-%2,%2=$P(%2,"+",2) i %gm=201401 s %=%/.702804,%2=%2/.702804
600 ; cents   
 ;; i Osant>99,%2 s SU(Osant,1)=+%2 
 I %<0,$g(Oparads) S SU(Oparads,1)=-%    ;;  parads
Trun 
 s %I="",TTT=T
 f  s %I=$o(^ZT(%gm,+T,%I)) Q:%I=""  s %R=$g(@%I) d
 .q:%R=""  s %=T n T s T=%
 .s %FILE=$e($p(%I,"("),2,22),(HF,ZA,DF)=0,KA=KAF
 .s (M,gm)=%gm,L=%I
 .i '$d(%XG(%FILE)) s %1=%FILE D X^USX
 .x %XG(%FILE),%XI(%FILE) q:TTT-T   s obj=0 s:%R["ob=" obj=$p($p($p(%R,"ob=",2)," "),%B) d @%FILE
algaZT s %FILE=0,obj=0
 f  s %FILE=$o(^kNo("alga_ZT",%FILE)) q:'$l(%FILE)  s %1=%FILE d ^USX x ^kNo("alga_ZT",%FILE)
LIC i '$d(%XG("LIC")) s %1="LIC" d ^USX
 s PA=0,ON=1 f  s ON=$o(^LIC(%gm,T,ON)) q:ON=""  s %R=^(ON),%I=$zr d
 .x %XG("LIC") S O=ON\1,L=$zr,gm=$p($g(^O(O)),%B,4),gm=+$g(%gm(+gm)),RM(O,L)=$g(PA) s:'gm gm=%gm
 .d OL  s (HF,ZA,DF)=0
zu s O=1 f  s O=$o(^ZU(T,O)) q:O=""  s %=^(O),SU(O\1,$zr)="^"
kasR s d=%gm*100
 f  s d=$o(^kas(d)) q:-d'[-%gm  f %=0:.1:.9 i $d(^kas(d,T+%)) d
 .s %R=^(T+%),%1="kas" d ^USX x %XG("kas")
 .s (L,%I)=$name(^kas(d,T+%)),O=$g(Okase,884),S=s,REM="kase",RM(O,L)="kase"
 .s:dok["PAR" O=905,REM=dok,RM(O,L)=dok s:dok["NORD" O=909,REM=dok,RM(O,L)=dok
 .s M=%gm,(DF,HF,ZA)=0 n % d OL
 s (HF,ZA,DF)=0,Or=$g(Or) s:Or<499 Or=799.5
bezAlg i $o(SU(Or),-1)<99,DFIO s SU(200,0)=.0000001
PLUS S (O,L)=""
 f  s O=$o(SUnor(O)) q:O=""  f  s L=$o(SUnor(O,L)) q:L=""  d
 . s gm=0,S=$g(SUnor(O,L)),HF=+$p(S,"h",2),DF=+$p(S,"DF",2) d:S OL
 f  s O=$o(SU("-%",O)) q:O=""  f  s L=$o(SU(O,L)) q:L=""  d
 .s SU(O,"-%"_L)=$j(SU(O,L)*SU("-%",O),0,2)
 F  s O=$o(SU(O)) q:O>Or!'O  F  S L=$o(SU(O,L)) Q:L=""  d
 .S S=SU(O,L),s=+$j(S,0,2) I 'S K SU(O,L) Q
 .s:S=+S (S,SU(O,L))=s
 .S %M=$g(%M(O)),M=+$P(S,"m",2) S:M<200000 M=%gm d:%M="" %M
1 .S I=$E(%M_0) S:I S(M,I)=$G(S(M,I))+s i s,'$g(S(M,I)) s S(M,I)=.00000001
prof .S:$E(%M,Mprof) S(%gm,Oprof)=$G(S(%gm,Oprof))+s ; PROFS
alim .I $D(SU(Oalim)),$E(%M,Malim) S BSalim=BSalim+s
soda .I $D(SU(Osoda)),$E(%M,Msoda) S BSsoda=BSsoda+s
 .S SU(O)=$G(SU(O))+s,PLUS=PLUS+s
 D ZN
MINUS S L="",O=Or k:$l($g(%ieOrder))<9 %ieOrder n %zzOrder
 F %zzOrder=2:1 s:$g(SU(O)) MINUS=MINUS-SU(O),SU(O)=$j(SU(O),0,2),MINUS=MINUS+SU(O) s O=$s($d(%ieOrder):$p(%ieOrder,":",%zzOrder),1:$o(SU(O))) Q:'O  s L="" F  S L=$o(SU(O,L)) Q:L=""  d
 .i O=$g(OalgBan) d  q:'$d(SU(O,L))  
 ..  s o="" f  s o=$o(SU(O,o)) q:o=""  i o'=%gm k SU(O,%gm)  ;; manual bank
 .S S=$g(SU(O,L)),s=$j(S,0,2),su(O,L)=S_-s  i S="" k SU(O,L) q
 .I $E(S)="^"!(S["%") S:'L %R=@L S MI(O,L)=MINUS,%I=L d
 ..  s SU(O,L,"%I")=%I,A=$E($P(L,"("),2,9) 
 ..  s SU=$$ZU(%I)
 ..  S (s,S)=SU s:O'[Osoc s=$j(S,0,2)
 .i S="-*" s (S,s)=PLUS-MINUS  i s<0 s (S,s)=0
 .i 'S,S'["S",'$p(S,"c",2),O>Or k SU(O,L) Q
 .s MINUS=MINUS+$s(O-Osoc:S,1:s),SU(O\1)=$g(SU(O\1))+$s(O-Osoc:S,1:s),SU(O\1,L)=S
 .i O[Osoc,L'["^" s m=+$p(L_"m"_%gm,"m",2),SU(O\1,m)=$g(SU(O\1,m))+S k SU(O\1,L)
 ;
900 i Osant>99 S S=PLUS-MINUS S:S>0 S=S#1,SU(900,1)=S,MINUS=MINUS+S S:S<0 S=0
 q
P1 S CFAKT=$P(O,%B,2),O=O\1 G OL
Z71 g OL
nor 
norAste q
norKTU q
TAB 
 n ooo,OOO,DFF,HFF,SSS
 s OOO=O,DFF=DF,HFF=HF,SSS=S n O,DF,HF,S i 'SSS s SSS=.00000001
 f ooo=1:1:$l(OOO,"^") d
 .s O=$p(OOO,"^",ooo),DF=$p(DFF,"^",ooo),HF=$p(HFF,"^",ooo),KA=0 s:REM?1n KA=REM
 .s S=$p(SSS,"^",ooo) S:$P(DF,":",2) DG=$P(DF,":",2) S:$P(HF,":",2) HG=$P(HF,":",2)
 .s gm=0,%=+$p(O,"-",2),O=O\1 s:$d(%gm(-%)) gm=%gm(-%)
 .s o=$p($g(^O(O)),%B,4) i o,$d(%gm(+o)) s gm=%gm(+o)
 .d OL s KA=""
 q
Tabl 
tab 
dtab q
slim s RM(O,L)=periods d OL s SU(O,L)=SU(O,L)_"p"_periods
kas q
%M s:'$d(^O(O)) ^(O)=%B_"????????????"_%B_"????"_%B_"????"_%B_"????" S (%M,%M(O))=$P($G(^O(O)),%B,3,9)
 Q
ZN 
 s O=0,L="",h=$c(254) k S,N,am,nbsvM
 s S(%gm,1)=0
 f  s O=$o(SU(O)) q:O>Or!'O  f  s L=$o(SU(O,L)) q:L=""  d
 .s S=SU(O,L),%M=$g(%M(O)),m=+$p(S,"m",2) s:m<200000 m=%gm
 .i O>700 s OO=$p($g(^O(O)),%B,2) i OO["%" s %=$tr(OO,1234567890_OO,1234567890) i %,%>10,%<70 s S=S-(S*%/100)
 .s S(m,Osoc)=$g(S(m,Osoc))+($e(%M,Msoc)*S) s %=$e(%M) i % S S(m,%)=$g(S(m,%))+S
 .;; i SN["p",$e(%M,Mprof) s S(%gm,Oprof)=$g(S(%gm,Oprof))+S
 k nod,baz,bac,soc,am
nodAM F X=1:1:11 s mm=%gm(-X) q:-mm'[-$e(%gm,1,4)&(mm#100<12)  d:$d(^AM(T,mm,On))
 .S (am(mm),AM)=$tr(^(On),"URMBCIN'","urmbcin"_%B)
 .F x=1:1 S s=$P(AM,%B,x),m=+$P(s,"m",2) s:m<200000 m=mm Q:s=""  d
 ..i %gm>201400,mm<201400 s s=s/.702804_"_"_s
 ..s:s["s" nod(m)=s+$g(nod(m))
socAM F X=1:1:11 s mm=%gm(-X) q:-mm'[-$e(%gm,1,4)&(mm#100<12)  d:$d(^AM(T,mm,Osoc))
 .s AM=$tr(^(Osoc),"URMBCIN'","urmbcin"_%B)
 .f x=1:1 s s=$P(AM,%B,x),m=+$P(s,"m",2) s:m<200000 m=mm Q:s=""  d
 ..i %gm>201400,mm<201400 s s=s/.702804_"_"_s
 ..s soc(m)=s+$g(soc(m))
bazAM F X=1:1:11 s mm=%gm(-X) q:-mm'[-$e(%gm,1,4)&(mm#100<12)  s o="" f  s o=$o(^AM(T,mm,o)) q:o>Or!'o  d
 .i '$d(%M(o)) s %M(o)=$p($g(^O(o)),%B,3) i ^AM(T,mm,o)
 .q:'$e(%M(o))
 .s (AM,am(mm,o))=^(o),AM=$tr(AM,"URMBCIN'","urmbcin"_%B)
 .F x=1:1:$l(AM,%B) S s=$P(AM,%B,x),m=+$P(s,"m",2) s:m<200000 m=mm d
 ..i %gm>201400,mm<201400 s s=s/.702804_"_"_s
 ..s baz(m)=$g(baz(m))+s  s:$e(%M(o),3) bac(m)=$g(bac(m))+s
 f %=0:-1:-3 s S(%gm(%),1)=$g(S(%gm(%),1))
nodok k a,BS s L="" f  s L=$o(SUsoc(L)) q:L=""  d
 .  s m=+$p(L,"m",2),%=1 s:m<200000 m=%gm i %gm>201400,m<201400 s %=.702804
 .  s N(m,On,"c")=$g(N(m,On,"c"))+(SUsoc(L)/%)
 S M=%gm-100,o=+$p(mxConfig,":d8min=",2) s:o>M M=$e(o,1,6)  i -M'[-$e(%gm,1,4),M#100<12 s M=M\100_12
 k socS   ;; 20161026
 F  S M=$o(S(M)) Q:'M  D M
 i $$m^ZFIO(%gm)
 q
M i '$d(%MINM(M)),$$%MINM(M)
 i $$m^ZFIO(M)
 s BS=S(M,1)+$g(baz(M)),S=0 D:BS!S(M,1)!(M=%gm)            ;; 20161005
 .;; i M>201700 d socS            ;; 20161026
 .i '$g(S(M,1)),M-%gm,%gm<201500 q   ;; ,'$d(^AK(T,M)) q
 .s BS(M,1)=BS d N1  S N(M,1)=$j(S,0,2)-$g(nod(M))
 s S=$g(N(M,1))
 f O=Osoc,On I $G(N(M,O)) S SU(O,M)=$j(N(M,O),0,2) s:M-%gm SU(O,M)=SU(O,M)_"m"_M
 s (s(1),s(2))=0 f %=1,2 s:$g(S(M,%)) s(%)=$g(S(M,%))
 s SU(On,M)=$j(S,0,2)_"s"_s(1)_"s"_s(2)_"m"_M_"u"_S
 i 'SU(On,M),M=%gm s SU(On,M)=.000001_" "_SU(On,M)
 i '$g(N(M,On,"b")),SN["b",M=%gm s N(M,On,"b")=.000001
 f %="b","c","n","i","r" i $g(N(M,On,%)) S SU(On,M)=SU(On,M)_%_+N(M,On,%)_"___"
 q
Nsoc q
b n o s bn="n",bi="--",bb="--",br="--",bs="s",SNxxxPAK=0 k ^persO(T,M*100,"SNxxxPAK")
 s SNi=0 i M>201100 s SNi=$o(SN(M*100+1)) s:-SNi'[-M SNi=0
 i SN["v" s o=+$o(SN(M*100+1.1-1.1),-1),o=$g(SN(o)) d
 . i o="" n % s %=$o(SN(M*100)) i -%[-M,SN(%)'["v" q
 . i o["v"!'$l(o) s bs="v" s:M<201900 bn="--" q
 . s SN=o
 i SN["s" d
 .  s o=$o(SN(M*100),-1) f  s o=$o(SN(o)) q:'o  q:SN(o)'["s"  i o>(M_33) s o=-10 q  
 .  i o<0 s bn="--"  ;; 20190215
 i SN["i" s bi="i",SNxxxPAK="090" i M<201900 s:'SNi bn="--"   ; 20190517 - inga  i M<201900
 i SN["r" s br="r",bn="--",o=+$p(SN,"r",2) i o>89,o<999 s SNxxxPAK=$e(1000+o,2,4)
 i SN["rv" s br="rv",bn="--",o=+$p(SN,"rv",2) i o>89,o<999 s SNxxxPAK=$e(1000+o,2,4)
 i SN["r",SN'["v",M>200900 s br="r",bn="n"
 i SN["z" s bs="z",bb="b"  i M<201900 s bn="--"
 i SN["k" i M<201900 s bn="k"
 i SN["d" s bs="d"  i M<201900 s bn="--"
 i $l($g(KODS))=12 s o=19_$e(KODS,5,6)_$e(KODS,3,4) i M-o\100<15,$$d31^MXD(o_$e(KODS,1,2),8)'["E" s bs="--"
 i SNxxxPAK s ^persO(T,M*100,"SNxxxPAK")=SNxxxPAK
 q
nod 
N1 d b n o,s,L,I,%1,%2 i M<201403!'$d(%algNod(M))!(M>201800),$$%MINM(M)
 i '$d(%soc(M))!(M>201800) s %soc(M)=$$m(M,bs),%SOC(M)=$$m(M,$tr(bs,"zvds","ZVDS"))
 ;; i M>2017009999,M=%gm d socS   
 s i=$p(SN,"i",2) s:'i i=$l(SN,"i")-1
 s N(M,On,"i")=$$m(M,bi,i+1) s:SN["s" N(M,On,"i")=0
 s b=$$m(M,"b"),N(M,On,"b")=$L(SN,"b")-1*b
 s N(M,On,"r")=$$m(M,br)
 s N(M,On,"n")=$$m(M,bn) 
 s N(M,On,"c")=$g(N(M,On,"c"))+($g(bac(M))*%soc(M))
 i SN["n" s o=+$p(SN,"n",2),N(M,On,"n")=o f %="i","r" i $g(N(M,On,%)) k s s N(M,On,%)=o,N(M,On,"n")=0 m s=SN n SN m SN=s s SN=$tr(s,"n"," ") q
 i M<%gm,$d(^AM(T,M,On)) s am=^(On) d
 .f L=1:1:9 s %=$p(am,%B,L) q:'$l(%)  d:+$p(%,"m",2)=M
 .. i M<201500 f o="n","b","i","c" s N(M,On,o)=0
 .. i %["n" s o=+$p(%,"n",2) s:o N(M,On,"n")=o
 .. i %["b" s o=+$p(%,"b",2) s:M<201500&o N(M,On,"b")=o i M>201500,o,b,o#b s N(M,On,"b")=o
 .. i %["i" s o=+$p(%,"i",2),i=$g(N(M,On,"i")) i M>201500,o,i,o<i,o>.01 s N(M,On,"i")=o 
 s L="",max=28+$e(3_'(M\100#4)_3232332323,M#100) 
 ; slim lapa B :
 s no=0,lidz=99,k=0,o=+$p(SN,"no",2) i o?8n,-o[-M,$p(SN,"n",2) s no=o#100 
 s o=$o(SU(Os1-.1)) i o,o'>Os2 s o=o-.1,k=max d
 .f  s o=$o(SU(o)) q:o>Os2!'o  f  s L=$o(SU(o,L)) q:L=""  d
 .. s m=+$p(^O(o),%B,4),s=SU(o,L)  q:M-$g(%gm(m))&m  q:M-%gm&'m  
 .. s %=$p(s,"d",2) s:%<.1 %=$j($p(s,"h",2)/8,0,0)
 .. s:+$p(s_"m"_M,"m",2)=M k=k-%+.000001_"  o="_o
 .. i 'no s no=+$p(s_"no1","no",2),lidz=no+%-1 s:lidz<no lidz=no s:no no=no_"B"
 i k,'no,k-max s k=k\1,no=1 i -dp[-M s no=dp,lidz=no-1+k
 ; SN["b":  SN["s":  slimB:
 k nbs n iii,ii,bb,b,nn,v,i,ss,SNi,strada s (bb,nn,v,i,ii,iii,SNi)=0,ss=max,nea=$g(N(M,On,"n"))*(M>201900)
 i M>201100 s SNi=$o(SN(M*100+1)) s:-SNi'[-M SNi=0   ;; s:SNi#100=1 SNi=0  20170522-ANN
 i M<%gm&SNi!(M=%gm)!no s %=0 d:no!SNi  i '% i -$o(SN(M_33),-1)[-M&(-$o(SN(M_33),-1)'[-(M_"01"))!(-$o(SN(M_"01"))[-M) d  ;;  20170522-ANN
 .  i M<%gm s o=$o(^AM(T,M,Os1)) i o,o<Os2 q   ;; 20160511  Tatjana-zveri
 .  s %=1,o0=+$o(SN(M*100+1.1),-1),b=$l($g(SN(o0)),"b")-1,v=$g(SN(o0))["v",i=$g(SN(o0))["i"
 .  s s=$g(SN(o0))["s",strada=1,o=$o(dp(M_"00"),-1) s:'o strada=0 
 .  i o,$o(du(M_"00"),-1)'<o s strada=0
 .  n oi f o=M_"01":1:M_max d
 .  . s nbs(o)="     "
 .  . s:$d(dp(o)) strada=1,strada(o)=1
 .  . i -du[-M,du<o s strada=0,strada(o)=0 q
 .  . q:'strada  s nbs(o)="......."
 .  . i $d(SN(o)),o-du s b=$l(SN(o),"b")-1,s=$s(SN(o)["s":1,1:0) s:-dp'[-M!111 i=$s(SN(o)["i":1,1:0) i SN(o)_$g(SN(o0))["v" s v=1 i SN'["n" s bn="--"
 .  . i no,o#100'<no,o#100'>lidz,no["B"!'i q
 .  . i 's s:b bb=bb+b,$e(nbs(o),2)=b s:bn["n"&'v!(SN["n") $e(nbs(o),1)="n",nn=nn+1  
 .  . s:s $e(nbs(o),3)="s" s:v $e(nbs(o),4)="v" s:i $e(nbs(o),5)="i",ii=ii+1 i i,$e(nbs(o),1)="n",M<201900 s $e(nbs(o),1)=".",nn=nn-1 
 .  . s:du=o!$d(du(o)) strada=0,strada(o)=0
 .  . s oi=$o(SN(o+.1),-1) i oi s oi=SN(oi) i oi["i" s oi=$s($p(oi,"i",2):$p(oi,"i",2),1:$l(oi,"i")-1),iii=$$m(M,"i",oi+1)+iii,$p(nbs(o),"    :i ",2)=+$$m(M,"i",oi+1)
 .  i M>201900,$l(nea)>7,SN["s" s nn=max
 .  s N(M,On,"b")=bb*$$m(M,"b")/max i N(M,On,"b"),N(M,On,"b")'["." s N(M,On,"b")=N(M,On,"b")_.0000001
 .  i iii s N(M,On,"i")=iii/max_.0000001,ii=0
 .  i ii,ii<max s i=$p(SN,"i",2) s:'i i=$l(SN,"i")-1 i i s N(M,On,"i")=ii*$$m(M,"i",i+1,SN)/max_.0000001
 .  i M=%gm,nn f o="r","n" s N(M,On,o)=+$j(nn*N(M,On,o)/max,0,5) s:N(M,On,o)'["." N(M,On,o)=N(M,On,o)_.0000031 
 i $d(nbs) m nbsvM(M)=nbs
 i M>%gm,$d(^mxConfig(1,"alga","atvNod",1)) f o="i","r","n","b" s N(M,On,o)=0
 s a="" f o="i","r","n","b","c" i $d(N(M,On,o)) s:o'="c"&(M>%gm) N(M,On,o)="~~"_N(M,On,o) s a=a+$j(N(M,On,o),0,2)
 s a(M)=a,BS(M)=BS,S=$j(BS-a*$j(%algNod(M)/100,0,2),0,2) s:S<0 S=0
 ;;  2018
 n %,%1,%2,%3,s1,s2,%23 s s1=+$j(BS,0,2),s2=0,%1=+$j(%algNod(M)/100,0,2),%2=".2 (20%)",%3=1667,%23=".23 (23%)"
 k ^persO(T,M,"N") i (BS*BS)<.00001,M=%gm f o="i","r","n","b","c" k N(M,On,o)
 n N1,N2,n1,n2,c,n11,n22,ks,dme s ks=0,dme=0 
 i $d(nbsvM(M)) f %=M_"01":1:M_33 q:'$d(nbsvM(M,%))  s o=nbsvM(M,%),dme=dme+1 s:o["s" ks=ks+1 i o'["s",o["v"!(o["n")!(o["b")!(o["i") s ks("n")=o
 i ks s:ks=dme ks=0 s ks=ks/dme
 i M>201800,(BS*BS)>.00001 s (n2,n22,N2)=0 s:s1>%3&((SN'["s")!ks) s2=s1-%3,s1=%3 d
 . s c=-$j(s1+s2*%soc(M)*%2,0,12)_"<mx @"_%soc(M)_" * "_(s1+s2)_" * "_%2
 . i SN["s",'ks!(ks&'$d(ks("n"))) s N1=$j(s1*%23,0,12),n11=N1
 . else  s (N1,n11)=s1*$s(%1[23:%1,ks:%2,1:%2) f o="i","r","n","b" s %=$g(N(M,On,o)),n11=n11-$j(%*%2,0,12),N(M,"nod",o)=-$j(%*%2,0,12)_"<mx @"_%2_" no "_%_" "_o
 . i s2 s N2=$j(s2*%23,0,12)
 . s S=n11+N2+c
 . f o="N1","N2","n11","n22","s1","s2","SN","%2","%1","%23","S","c","ks","dme" s N(M,"nod",o)=@o
 . s:S<0 S=0 s S=$j(S,0,2) m ^persO(T,M,"N")=N(M)
 q
socS ;   soc2  no 2017.g.  ;; 20161205
Nprof q
m(M,s,n,sn) 
 s:'$d(sn) sn=$g(SN)
 s:s'[" " s=" "_s
 q +$p($$%soc(M,sn),s,$g(n,2))
%soc(M,sn) i '$d(%MINM(M)),$$%MINM(M)
 n %,t,b,ig,i,n2,%2  s t=%MINM(M),%2=+M_33  ;;  2018
 f  s %2=$o(^persO(T,%2),-1) q:%2<20180000  i $d(^(%2,"aNodNeap")) s n2=@$zr s:n2["23%" %algNod(M)=23,n2=$$trw^UST(n2,"23%"," %") i $e(n2)?1n!n2 s t=" n"_+n2_" "_+%2_"n .t="_t d:-%2[-M   q  
 .  q:%2#100=1  n %1,k1,k2,n,n1 s %1=$o(^persO(T,%2),-1) q:'%1
 .  q:'$d(^(%1,"aNodNeap"))  s n1=@$zr,max=28+$e(3_'(M\100#4)_3232332323,M#100) 
 .  s k1=%2-1#100/max,k2=1-k1 i k1<1,k2<1 s n=n1*k1+(n2*k2) s:n'["." n=n_".000000001" s t="  n"_n_" "_t
 s %="" s:'$d(sn) sn=$g(SN) s i=$l(sn,"i")-1,ig=$p(sn,"i",2) i i s:ig i=ig d
 . n p1,p2
 . s p1=$p($p(t,"i",i+1),"%",2),p2=$p($p(t,"i",i+1),"%",3)
 . i i=3,'p1 s p1=+$p(t,"s",2),p2=+$p(t,"S",2)
 . s t=" s"_p1_" S"_p2_" "_t
 f b=" s"," S"," v"," V"," z"," Z"," d"," D" s %=%_" "_b_($p(t,b,2)/100)
 f b=" m"," n"," b"," p"," r"," rr"," rv"," d" s %=%_" "_b_+$p(t,b,2)   ;; /k702804)
 q %_" i"_$p(t,"i",2,4)
%MINM(M) n %m,o,m,%,b s %m=M
 i M>201400,%gm<201400,$d(^ZMIN(201401))
 s m=+$o(^ZMIN(%m+1),-1),%=0,(o,%MINM(M))=" "_$p(^(m),%B,2)
 s minAlga=+$p(^(m),"a",2) s:minAlga<99 minAlga=$s(M>201700:380,1:370)  ;; 20161026
 i m<200000 s %mxWarng(M)=" ^ZMIN -- datums maz{257}k nek{257} 2000 gads T="_$g(T) q
 s:^(m)["nod=" %=+$p(^(m),"nod=",2) s:^(m)["IIN" %=+$p(^(m),"IIN",2)
 s:'% %=$s(%m>201300:24,%m>201100:25,%m>201000:26,%m>200900:23,1:25) s %algNod(M)=%
 i SN["23%" s %algNod(M)=23  ;; 2018
 q %
Empty q
ZU(%I) i '$d(%MINM(%gm)),$$%MINM(%gm)
 n kDAY,max,o,dd1,dd2,%1,LimitS,PAY,OST,POST,ZU s o=O\1,ZU="?" n O
 S (REM,Z,ZA,DD,CN,ADR,SU1,LimitS,PAY,OST,POST,kDAY)="",DOLG=0
 s sSoc=0,%="" f  s %=$o(SU(Osoc,%)) q:%=""  s sSoc=sSoc+SU(Osoc,%)
 s sNod=0,%="" f  s %=$o(SU(On,%))   q:%=""  s sNod=sNod+SU(On,%)
 S %1=$e($p(%I,"("),2,99) i '$D(%XG(%1)) d ^USX
 s KAM=Fi,konts="?"    X %XI(%1),%XG(%1) i '$d(^O(o\1)) s %mxWarng("uz ^ZU nepareiz kods : "_o)=T_%B_Fi q
 S DD=$tr(DD,":/","--"),O=o,dd1=+DD,dd2=+$p(DD,"-",2),max=28+$e(3_'(%gm\100#4)_3232332323,%gm#100)
 s:'dd2 dd2=dd1 s dd1=$e(dd1_"01",1,8),dd2=$e(dd2_max,1,8)
 i -dd1[-%gm f %=dd1#100:1:max s kDAY=kDAY+1
 i -dd2[-%gm f %=1:1:dd2#100   s kDAY=kDAY+1
 s kDAY=kDAY/max s:kDAY>1!'kDAY kDAY=1 s:%XD81>dd2!(%XD82<dd1) S=0 s ZU=S
 S %M=$G(%M(o)) S:%M="" (%M,%M(o))=$P(^O(o),%B,3,4)
 I S["%" D
 .S RM(o,L)=S,Z=PLUS,SU(o,L,"%")=S,SU(o,L,"ADR")=ADR s:o=Oalim Z=BSalim-sSoc-sNod
 .;;I o=Osoda S Z=BSalim-sSoc-sNod   ;;Z=BSsoda
 .S:+S=100 Z=PLUS-$G(MI(o,L)) S ZU=Z*S/100*kDAY,SU(o,L,"S")=ZU S:ZU<0 ZU=0
 I S["%",Oalim[o!1111 S ALGA=Z-$G(SU(o)) S:'SU1 SU1=ZU
 i o=Osoda,S["100%" s ZU=PLUS-MINUS-sSoc
 i S["*" s (LimitS,ss)=$p(S,"*",2,9),S=$tr(S,"*","<"),%=%gm f  s %=%-1 s:%#100=0 %=%-88 q:'$d(^AM(T,%,o\1))&(%<$e(DD,1,6))  s ss=ss-@$zr-$p(@$zr,%B,2)-$p(@$zr,%B,3),S=+S_"<"_ss
 I S["<",$P(S,"<",2)<ZU S ZU=$P(S,"<",2) s:LimitS RM(o,L)=$G(RM(o,L))_" LimitS="_LimitS
 I S[">",$P(S,">",2)>ZU S ZU=$P(S,">",2)
 S ZU=+$j(ZU,0,2)
 I Oalim=o,S'["%" d
 .S Z=$g(BSalim)-sNod i Z-$G(SU(o))<S S ZU=Z-$G(SU(o)) S:ZU<1 ZU=0
 .S:ZU+1<SU1 DOLG=+$j(SU1-ZU,0,2)
 S:S["%" ZU=ZU_" "_S S:Z ZU=ZU_" *"_+Z  ;; _" BSalim="_BSalim_" sSoc="_sSoc_" sNod="_sNod
 i S_%B_%B[("."_%B_%B) s ZU=S
 i konts s uzd(o,L,"s")=ZU,uzd(o,L,"k")=konts
 q:'$g(DOLG) ZU
 S ZU=ZU_" ("_-DOLG_")",RM(o,L)=$G(RM(o,L))_"(-"_DOLG_")"
 q ZU
atv(di,dm,O,%jj,gm,diKalend) 
 n atvFlag s atvFlag=1 g atvRsli
sli(di,dm,O,%jj,gm) 
 n atvFlag s atvFlag=0
atvRsli n iii s iii=0 k sa
 n di0,diF,diR,O s %jj=$g(%jj),di0=di k LMs3alga
 n am,L,m,mm,ss,sss,s1,x1,x2,o,mAM,so,dso,m0,sAt1,km,hd,hdp,Maska,k
 i di<0 s di=-di_$s(di0["s":" s",1:"")
 s hd="d",hdp="dienas" i di["s" s hd="h",hdp="stundas"
 s (ss,s1,dd,o,dso)=0,Maska=$g(Mslim,6) s:atvFlag Maska=$g(Matv,7)
 i mxConfig[":LM",atvFlag s Maska=6,Matv=6
 k km s km=0,mAM=%gm-.1,m0=%gm(-7),f=1
 f xd=1:1:12 q:xd=7&ss  s mAM=$g(%gm(-xd+dm)) i f,mAM s O=0 f  s O=$o(^AM(T,mAM,O)) q:O>Or!'O  d  i -du[-mAM s f=0
 .s:'$d(Matv(O)) Matv(O)=$e($p($g(^O(O)),%B,3),Maska)
 .q:'Matv(O)  i Matv(O)=3 d  q
 .. s am=^AM(T,mAM,O)
 .. i $d(^(O))>1 s o="",am="" f  s o=$o(^AM(T,mAM,O,o)) q:o=""  s am=am_%B_^(o)
 .. s am=$tr(am,"'HDM",%B_"hdm")
 .. f L=1:1:$l(am,%B) s LMs3alga=$p(am,%B,L)+$g(LMs3alga)
 .s am=^AM(T,mAM,O)
 .i $d(^(O))>1 s o="",am="" f  s o=$o(^AM(T,mAM,O,o)) q:o=""  s am=am_%B_^(o)
 .s am=$tr(am,"'HDM",%B_"hdm")
 .f L=1:1:$l(am,%B) s s=$p(am,%B,L) s:%gm>201400&(mAM<201400) s=s/.702804_"_"_s d:$l(s)
 ..s mm=+$p(s,"m",2) s:mm<200000 mm=mAM i xd<7 q:mm>%gm(-1+dm)  q:mm<%gm(-6+dm)
 ..s so=+s,ss=ss+s,diF=$p(s,hd,2)
 ..i diF,Matv(O)=1 d
 .. . i '$d(diKalend) s dd=dd+diF,dso=+diF q
 .. . s diR=$p($g(^ds(mAM)),%B,2) q:'diR
 .. . s max=28+$e(3_'(mAM\100#4)_3232332323,mAM#100)
 .. . s o=diF/max*diR
 .. . s dd=dd+$j(o,0,0),dso=+$j(o,0,3)_"k"_+diF
 ..i +%jj=1 s iii=iii+1 d  s sa(O,mm)=s,sa(O)=$g(sa(O))+s,dso=""
 .. . i 1_$d(^oMX(%USID,1,iii,0)) f o="mm","O","so","dso","ss" s ^(o)=@o
 ..s:'$d(km(mm)) km(mm)=s,km=km+1
 s (s1,sAt1,sAtv,sss)=0,k=.8 s:atvFlag k=1
 s:$g(^atabKorr(%gm,T)) dd=^(T)
 s:dd (s1,sAt1)=ss/dd,(sAtv,sss)=s1*di*k-('atvFlag*.05*s1*$p(di,"-",2))
 i dd,di0<0 s (s1,sAt1)=ss/dd,(sAtv,sss)=s1*di i di0["s",di0'["ss",di<5 s (sAtv,sss)=sss*8_"s"
 s %K=+sss,OA=O,gm=$g(gm,%gm)
 i gm=%gm s sAtv0a=sAtv,sAtv1a=""
 i gm=%gm(1) s sAtv1a=sAtv
 i %jj s ssAtv=$g(ssAtv)+sAtv,ddAtv=$g(ddAtv)+di
 i km s kmAtv=km i kmAtv-6,%jj s kmAtv=kmAtv_" <mx ic8 "
 q %K
As(M) k As q:M>201800  ;  07082013  ; 20180213 
 s gm0=%gm\100*100 i M#100=0 q 0
 k:$d(^AM(T,%gm)) ^oAs(T) k:$g(^oAs(T))<%gm ^(T) i $g(^oAs(T,M)) m As=^oAs(T) q As(M)
 n o,gm,m,am,s f gm=%gm\100*100+1:1:%gm-1 d
 .s o=0 f  s o=$o(^AM(T,gm,o)) q:o>Or!'o  s am=$tr(^(o),"M'","m"_%B) d
 .. f %=1:1:$l(am,%B) s s=$p(am,%B,%),m=+$p(s,"m",2) d:-M[-$e(m,1,4)
 ...  i $g(%M(o))'[%B s %M(o)=$p($g(^O(o)),%B,3,4)
 ...  s:$e(%M(o),Msoc)=1 As(gm)=$g(As(gm))+s
 f o=1:1:12 s m=$e(%gm,1,4)*100+o,As(m)=$g(As(m-1))+$g(As(m))
 k ^oAs(T) m ^oAs(T)=As s ^oAs(T)=%gm
 q $g(As(M))
OL 
 n no,x,bSocMax0,o,f,%  k As
 i ZA<0 s ^AMOi(T,%gm,"ZA",%I)=ZA,^AMOi(T,%gm,"S",%I)=S
 s T=+T,x=" ",no=0 i 'S,'DF q
 s o=+$p(S,":",2) i o,diPak_":"[(":"_o_":") q:$g(algaFOND)-o&$g(algaFOND)  s SU(O,L,"FOND")=o
 s DF(0)=$p($g(SU(O,L)),"d",2),HF(0)=$p($g(SU(O,L)),"h",2)
 i DF s S=S_"d"_(DF+DF(0)),no=+$p(DF," ",2)
 S:HF[":"!HF S=S_"h"_(HF+HF(0))_"h" S:ZA\1?4n S=S_"z"_ZA i ZA<0,-ZA\1?4n s S=S_"z"_ZA  
 I C,C-Cf S S=S_"C"_+C
 S M=%gm,%M=$g(%M(O)) D:%M="" %M s o=+$p(%M,%B,2) s:$d(%gm(o))&o M=%gm(o)
 s:gm M=gm S:M-%gm x=x_"m"_M_"o"_O
 n gm,m i O<Or s o=$g(^O(O)) i S*S<.001 s:$p(o,%B,3,4)["-S" dBezSocS=dBezSocS+DF
 i 'ZA,O<Or s o=+$p(o,%B,5) s:'o o=+zF i o\1?4n n ZA s ZA=o 
 i ZA\1?4n s konts=71_-ZA,ob=0,SU(O,L,"z")=+ZA
 e  s ob=+ZA,konts="71-5610"
 s:ob S=S_"ob"_ob_"ob" s:konts S=S_"#"_konts i no,no<32 s S=S_"no"_no
 i $l($g(obj))>1 s S=S_" ob="_obj_" "
 s SU(O,L,"%I")=%I s:KA SU(O,L,"KA")=KA
 i $d(SU(O,L)) s SU(O,L)=$g(SU(O,L))+S_"d"_(DF+DF(0))_"h"_(HF+HF(0))_x_" "_S
 else  s SU(O,L)=S_x
 q:'$e(%M(O),Msoc)  q:O>Or  d b
 s %soc(M)=$$m(M,bs),%SOC(M)=$$m(M,$tr(bs,"zvds","ZVDS"))
 i $g(SN)["%" s %soc(M)=+$p(SN,"%",2),%SOC(M)=+$p(SN,"%",3)
 i $g(SN)["s0" s %soc(M)=0,%SOC(M)=0
 s:%soc(M)>1 %soc(M)=%soc(M)/100 s:%SOC(M)>1 %SOC(M)=%SOC(M)/100
 i '$g(bSocMax(M)) s bSocMax(M)=99999999 f o=M:-1:M-11 s %=+$p($g(^ZMIN(o)),"socMax=",2) i %>9999 s bSocMax(M)=% q
 s:'$d(%gm12) %gm12=%gm ;; i '$d(As),$$As(%gm-1)
 i %gm=%gm12 s bS(M,Osoc)=$g(bS(M,Osoc))+S
 s o=bSocMax(M)-$g(As(M-1))-$g(bS(M,Osoc))-$g(bS(M-1,Osoc))-$g(bS(M-2,Osoc))-$g(bS(M-3,Osoc))
 s bSoc="bSoc=0 " i o<0,$g(bS(M,Osoc))+o>0 s bSoc=bS(M,Osoc)+o
 i o'<0 s:o>S bSoc=S s:o'>S bSoc=o
 s bSoc(M)=bSoc_" S="_S_" <> "_(-$g(As(M-1))-$g(bS(M-999,Osoc))-$g(bS(M-1,Osoc))-$g(bS(M-2,Osoc))-$g(bS(M-3,Osoc)))
 s %1=$p($g(^O(O)),%B,5) i ZA>0 s:ZA\1?4n %1=ZA s:%1\1'?4n %1=7210 s %2=%1+100 
 s:$d(^kNo("algaSocKonts",%1)) %2=$p(^(%1),%B,2),$p(x,":[",2)=%2
 s a=$p($g(SUsoc(x)),"a",2)
 s SUsoc(x)=bSoc*%soc(M)+$g(SUsoc(x))_x_"/"_(bSoc*%SOC(M)+$p($g(SUsoc(x)),"/",2))
 s SUsoc(x)=SUsoc(x)_"a"_(S+a)_"%"_%SOC(M)_"%"_%soc(M),SU(Osoc,x)=+SUsoc(x)_"m"_M_" "_x
 q:%1*%2<1000000  s o1=$p($g(^O(Osoc)),%B,5),o2=$p($g(^O(Osoc+1000)),%B,5) q:o1*o2<1000000
 i $g(flgFondi) s %=$p(%1,".",2) s:$l(%)-2 %=$p(%2,".",2) s:$l(%)=2 ($p(%1,".",2),$p(%2,".",2))=%
 s SUsoc(x)=SUsoc(x)_" 1["_%1_" 2["_%2
 q
Tf(gm) 
 n %1,%XG,%XI,%I,%R,%ZR,oxx,of0,of s gm=+gm q:gm'?6n -6
 f %1="TAB","Tabl","nor","norAste","Z71","P1" d
 .s of="^"_%1_"("_gm_")" q:'$d(@of)
 .;; i mxConfig'[":LM:","Z71 P1"[%1 q
 .d ^USX S oxx=$g(^AL(%1,"Tf")) s:$l(oxx)<7 oxx=$g(^("Gf","ON")) q:oxx=""
 .S %I=$NAME(@of),of0=$e(%I,1,$l(%I)-1)
 .s o=$g(%LI(%1)) q:'$l(o)  s o=$tr(o,"~") n @o
 .f  s (%I,%ZR)=$q(@%I) q:%I'[of0  s %R=@%I X %XG(%1),%XI(%1),oxx
 q ""
AMM k As,bS
 s %gm12=%gm n %gm,%XD81,%XD82 k ^AMM(T) k oN,oS
 f %gm=$e(%gm12,1,4)_"01":1:%gm12 d
 . i $$NewDate^MXD(%gm)
 . s %XD81=%gm_"01",%XD82=%gm_(28+$e(3_($e(%gm,1,4)#4=0)_3232332323,$e(%gm,5,6)))
 . d ^ZFIO q:'DFIO  d ZTA i $$ZWAM("^AMM") 
 . m oN(%gm)=N m oS(%gm)=SU
 i $$NewDate^MXD(%gm12)
 q
ZWAM(A) n o i $g(algaTEST) q "algaTEST"
 S T=+T,h=$c(254)
 i $g(^algArh(%gm))["sl" s A="^AK"
 K ^AK(T,%gm) K @A@(T,%gm) q:$D(SU)<2 0
 ;; i Osant>99 s sant=$g(SU(Osant,1)) k SU(Osant,1)
 S (O,L)="",^(%gm)=PLUS_","_MINUS_"+"_S
 I $D(^(%gm,0))
 F  s O=$o(SU(O)) q:O>Or!'O  F N=0:1 S L=$O(SU(O,L)) Q:L=""  D
 .s S=SU(O,L) i S>0,S#.01 s S=$j(S,0,2)_"_"_S
 .i $g(SU(O,L,"z")),'$p(S,"z") s S=S_"z"_SU(O,L,"z")
 .i $g(SU(O,L,"KA")) s S=S_"k"_SU(O,L,"KA")
 .s:'N ^(O)=S S:N ^(O)=^(O)_$c(254)_S
 ;; i Osant>99 s SU(600,1)=sant
 i mxConfig[":LM:" s:'$g(SU(242)) ^(242)=.000001 
 S O=Or
 F  S O=$o(SU(O)) Q:'O  F  S L=$o(SU(O,L)) Q:L=""  s s=$g(SU(O,L)) d:s
 .i s-$j(s,0,2) s:s*s>.000001 s=+$j(s,0,2)_"_"_s
 .i O=Oavans,L>0 s s=s_"v"_L_"v"
 .i O=Osoc,L?6n,L-%gm s s=s_"m"_L
 .i $g(SU(O,L,"z")) s s=s_"z"_SU(O,L,"z")
 .i $g(SU(O,L,"FOND")) s s=s_" f="_SU(O,L,"FOND")_" "
 .S:L["^ZU" s=s_L S ^(O)=$s($d(^(O)):^(O)_$c(254)_s,1:s)
 g:'$d(SUsoc) ZWAMe
 s L="",r=$p($g(@A@(T,%gm,Osoc)),"''")_"''"
 f  s L=$o(SUsoc(L)) q:L=""  s (o,s)=SUsoc(L) d
 .s %SOC=+$p(s,"%",2),Sa=+$p(s,"a",2),ss=+$p(s,"/",2,9),s=$p(s,"/")
 .s SUsoc(L)="s"_s_"/"_ss_"a"_Sa_"%"_%SOC,r=r_SUsoc(L) i %gm>200700 s:o[" 1[" r=r_" 1["_$p(o," 1[",2)
 s:r["s" ^(Osoc)=r
ZWAMe ;; i $g(socS(%gm,"DD")) m ^("socS")=socS(%gm)  ;; 20161026
 q:A="^AM" 1   s %1="ok"
 s o=99 f  s o=$o(^AM(T,%gm,o)) q:o=""  i o s %=^(o)  s:%-$g(^AK(T,%gm,o)) ^(o,0)=%,%1=-o
 k:'%1 ^AK(T,%gm)
 q 2_%1
 q

alg
alg ; ;  [ 03/25/2006  5:05 PM ]  ;[ 20190206 20:20:41 ]
 ; MSM, CACHE, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 ; 
parm0 f %1="O","pers" d ^USX
 k ^ZCT d ZCT
 i $$Tf^ZT(%gm)
parm1 
algStart d %lat^MXF
 s Oparads=900,Osant=0
 s (hAM,h,%B("AM"))=$c(254),Oavban=903,Oalban=904
 S (Onod,On)=881,Or=799.5,Osoc=899,Oprof=890,Odividen=0
 s Os1=500,Os2=509,Ocomp=-1,Oalim=885,Okase=884,Osoda=886,Oavans=880
 s Malim=4,Msoda=5,Mnod=1,Msoc=3,Mprof=2,Matv=7,Mslim=6
 s Oatv="241 242 243",Osli="510 511 512",Osve=214
 i $g(%FIRMA)["UPTK" s Oatv="174 175 176",Osli="130 131 132"
 s t="Osant hAM On Or Osoc Oprof Os1 Os2 Okase Osoda Oavans Oatv Osli Osve Malim Msoda Mnod Msoc Matv Mslim"
 f %=1:1:$l(t," ") s %1=$p(t," ",%) i $d(^kNo("alga",%1)) s @%1=$p(^(%1),$c(254),2)
 s Onod=On 
 q
ZCT N T S T=1  q:$g(^ZCT)=%gm  k ^ZCT
 F  S T=$O(^pers(T)) Q:'T  d ^ZFIO S ^ZCT(Cf,+T)=1
 S ^ZCT=%gm
 q

algLap
algLap ; .alga/lapas druka  [ 05/17/2006  3:52 PM ]  ;[ 20170118 10:22:45 ]
 ; MSM, CACHE, GT.M, MiniM
 ; MX Copyright(c) SIA ENTERS  2005-2017
 ; 
algLapD ; alga.lapas druka
 K SS,SSS S (CCC,T,cehs)="" s:oxT xT=oxT
 f  S T=$O(^pers(T)) q:T=""  d:T
 .s TTT=T,%=cehs n cehs s cehs=% s %=T n T s T=%
 .i xT,T<xT!(T>$p(xT_-xT,"-",2)) q
 .d ^ZFIO q:'DFIO
 .i $l(xmsm) x "s %="_xmsm q:'% 
 .i xCh,CF-xCh q
 .s cehs=CF d LIST
 q
AM(xT,xCh) 
 I $g(^algArh(%gm))["s" q "^algArh "_%gm_" slegts"
AM2(xT,xCh) 
 s @$zr=%B_"atver."
 K SS,SSS S (CCC,T)="" s xT=$g(xT),xCh=$g(xCh)
 n %FILE,%I,%ZR,%R
 d parm0^alg I $$Tf^ZT(%gm)
 s T="",cehs="" k algArh m algArh=^algArh k ^algArh(%gm)
 f  S T=$O(^pers(T)) q:T=""  d:T
 .s TTT=T,%=cehs n cehs s cehs=% s %=T n T s T=%
 .i xT,T<xT!(T>$p(xT_-xT,"-",2)) q
 .d ^ZFIO i xCh,CF-xCh q
 .s cehs=CF d ^ZT
 m ^algArh=algArh
 q ""
BT 
 q
LIST k a
 I $g(^algArh(%gm))["sl",$g(SUfromAM)!1111 k SU d SUfromAM i 1111
 else  D ^ZT I 'DFIO k:$g(^algArh(%gm))'["sl" ^AM(T,%gm) g qEr
 I $D(SU)<2 g qEr
 S (%W,W)=":",T=+T,(KOP,O,L,%,U)="" s:'du du=""
 s MnthYear=%MONTH_"."_%YEAR
 n %V s %V="Lap1" s:'du du=""
 f o="CF","Fi","SN","TARF","PLUS","MINUS" s ^om(%USID,"algLapDruka",T,1,1,o)=$g(@o)
 S (O,OO,L,i)="" k slim k ^oMX(%USID,"ALG_LAP") 
PLUS 
 s O=99 F  S O=$O(SU(O)) Q:O>Or!'O  F  S L=$O(SU(O,L)) Q:L=""  d
 .d OL s OO=$p($g(^O(O)),%B,2)
 .s (df,hf,me)="" s:DF df=+DF s:HF hf=+HF
 .i 'df,'hf,S*S<.00001,O-157,O-Onod q
 .s:%gm-M me=$p(%MONTHS," ",M#100)
 .s RM=$g(RM(O,L)),LL="" s:L["^" LL=$tr(L,"^","")_RM
 .s LL="" i 'hf s hf=$g(RM(O,L))
 .s i=i+1,%I=$g(SU(O,L,"%I"))
 .f o="OO","O","S","df","hf","me","LL","PLUS","%I" d
 ..  s ^oMX(%USID,"ALG_LAP",1,i,o)=$g(@o)
 ..  s ^om(%USID,"algLapDruka",T,2,i,o)=$g(@o)
MINUS 
 S O=Or K RM(Onod)
 F  S O=$O(SU(O)) Q:'O  F  S L=$O(SU(O,L)) Q:L=""  i SU(O,L) D OL d
 .s OO=$p($g(^O(O)),%B,2)
 .s me="" s:%gm-M me=$p(%MONTHS," ",M#100)
 .s RM=$g(RM(O,L)),LL=RM s:L["^" SU(O,L,"%I")=L
 .n OO2,O2,S2,me2,LL2 s OO2=OO,O2=O,S2=S,me2=me,LL2=LL
 .s i=i+1,%I=$g(SU(O,L,"%I"))
 .f o="OO","O","S","me","LL","L","MINUS","%I" d
 ..  s ^oMX(%USID,"ALG_LAP",2,i,o)=$g(@o)
 ..  s ^om(%USID,"algLapDruka",T,3,i,o)=$g(@o)
 s mi=MINUS,SV=$j(PLUS-MINUS,0,2)
SS 
SUsoc d SUfromAM
 s n="",(soc,Soc,SOC,ss)=0
 f  s n=$o(SUsoc(n)) q:n=""  d
 . s SOC=SOC+$p(SUsoc(n),"/",2)
 . i mxConfig[":LM:"!$g(flagLM) s Soc=Soc+SUsoc(n),soc=SOC-Soc q
 . s soc=soc+SUsoc(n),Soc=SOC-soc
 s (socnodd,Soc)=$j(Soc,0,2),(soc,ssdb)=$j(soc,0,2)
 ;;,vst=$$sli^ZT("-1ss",Osve,Osve)
 s (LMs3alga,st)="",kst=1 
 i $g(flagLM) s Matv=6,Mslim=6,st="ss",kst=8
 n %V s %V="atv",Oatv=241,vst=$$atv^ZT(1_st,+1,Oatv,1,%gm(1))
 f o="socnodd","Soc","soc","ss","ssdb","du","vst","LMs3alga" s ^om(%USID,"algLapDruka",T,9,1,o)=$g(@o)
qEr Q
SUfromAM ;;q:'$g(SUfromAM)
 n o,oo,O,L,s,m,am k SU,SUsoc
 s sant=0,PLUS=$G(^AM(T,%gm)),O=1,SUsoc=$g(^(%gm,Osoc))
 s:$l(SUsoc)=500 SUsoc=SUsoc_$g(^(Osoc,501))
 s MINUS=+$p(PLUS,",",2)
 f L=2:1 s s=$p(SUsoc,"s",L) q:s=""  d
 . s s=$tr(s,"M","m"),m=+$p(s_"m"_%gm,"m",2),SUsoc(m_"."_L)=s
 s o=1
 f  s o=$o(^AM(T,%gm,o)) q:'o  s am=^(o) d
 .i $d(^(o))>1 s am="",%="" f  s %=$o(^AM(T,%gm,o,%)) q:%=""  s am=am_^(%)_%B
 .s am=$tr(am,"KMDH'","kmdh"_%B) 
 .f L=1:1:$l(am,%B) s s=$p(am,%B,L),m=+$p(s_"m"_%gm,"m",2),SU(o,L)=s,SU(o)=$g(SU(o))+s
 i $g(Osant) s o=$g(^AM(T,%gm(-1))),o=+$p(o,"+",2),SU(Osant,1)=o
 q
T1 
T1j 
M q
OL 
 I '$D(%TO(O)) S %TO(O)=$E($P($G(^O(O)),%B,2),1,30)
 s S=SU(O,L),s=$tr(S,"HDM","hdm")
 S DF=+$P(s,"d",2),HF=$P(s,"h",2),SSS(O)=$G(SSS(O))+S
 S M=+$P(s_"m"_%gm,"m",2)
 Q

algPaz
algPaz ; ATG.alga.  [ 05/31/2005  7:34 PM ]  ;[ 20180131 00:07:40 ]
 ; MiniM, MSM, CACHE, GT.M
 ; vmx Copyright(c) SIA ENTERS  2005-2018
pazPr ; 
 d T
 s (VID,izsn)="Kurzemes re{291}ion{257}l{257}s iest{257}des Liep{257}jas noda{316}a "  ;;
 s o=$o(^mxConfig("alga","VID",%XD82+.1),-1) s:o (VID,izsn)=$p(^(o),%B,2)
 s periods=$$period^ZFIO(T)
 q
T ; 
 n %,o,k,d0,d00,m,M,MM,gm,AM,am,S k oSTORNO
 s xT=$g(xT),T=+T
 i '$d(Or) s Osant=-9999,(Onod,On)=881,Or=799.5,Osoc=899,Oprof=890,Msoc=3,Mprof=2,Os1=500,Os2=509
 ;
 S GADS=%gm\100_".g.",(d00,d0)=%gm\100*100+1,%B=$c(254)
 s d0=d00-90  ; -2.men.
 i dp<%XD81,dp>($e(%gm,1,4)_"0000") s (d00,d0)=$e(%gm,1,4)_$e($$period^ZFIO(T,-1),4,5)
 K SS,SSdd,kFIOm,s
 D AM s MM=d0-.1
 F  s MM=$o(AMT(MM)) q:MM>%gm(1)!'MM  S AM=$G(AMT(MM,On)) s:AM["ob" AM=$$trw^UST(AM,"ob"," ") F L=1:1:$l(AM,%B) d
 .s gm=MM i xT'["*" i dp+.1>%XD81,gm_33<dp q
 .S S=$p(AM,%B,L)
 .i S="" q:L>1  q:$o(SS(MM,1))<1
 .S m=+$p(S_"m"_MM,"m",2) i m<d00,mxConfig[":LM:",MM'>%gm s m=MM
 .i MM>%gm,m'>%gm n MM s (gm,MM)=%gm  ;; 20151027 LCT
 .i m>%gm,MM'>%gm s m=%gm ;; +  20160110 for LCT (at home)
 .q:m>%gm  
 .s %=$$m^ZFIO(MM) q:'DFIO  s kFIOm(MM)=kFIO
 .S SS(m,"s")=$g(SS(m,"s"))+S,SS(m,On)=SS(m,"s")
 .S SSdd(m,"s")=$g(SSdd(m,"s"))+$p(S,"d",2),SS(m,On)=SS(m,"s")
 .q:L>1&(m=MM)  i L=1 n M s M=$e(m,1,6) d b^ZT
 .i L=1,mxConfig[":LM:",MM<%gm,-du'[-MM,-dp'[-MM,'$d(SS(MM,106))!(SN["v") s o=$$m^ZT(MM,bn,2),SS(MM,"n")=o_":LM:"
 .f l=1:1:$l(AM,%B) s S=$p(AM,%B,l),m=+$p(S_"m"_MM,"m",2) d
 ..  s o=+$p(S,"n",2) s:SNgm["d" o="SN="_SNgm i o,$g(SS(m,"n"))'[":LM:" s:'$g(SS(m,"n")) SS(m,"n")=o s:SS(m,"n")>o SS(m,"n")=o ;; 20090602 cdr
 ..  f %="b","i","r" s o=+$p(S,%,2) i o,m'<MM,'$g(SS(m,o))  s SS(m,%)=o
 .q:L>1  i -du[-MM!(mxConfig'[":LM:") q
 .s o=SS(MM,"bFIO")-$g(SS(MM,"b")) 
 .i MM+1<%gm,o*o'<%1,o*o'[".",mxConfig'[":LM:" s SS(MM,"b")=SS(MM,"bFIO")
 .i MM+1<%gm,mxConfig[":LM:" s SS(MM,"b")=+SS(MM,"bFIO")_"bFIO"
 s MM=%gm+.1
 f  s MM=$o(AMT(MM),-1) q:MM<d0!'MM  d  
 .s gm=MM i xT'["*" i dp+.1>%XD81,gm_33<dp q
 .s k=$g(kFIOm(MM))
 .s max=$e(MM,1,4)#4=0&(+$e(MM,5,6)=2)+28+$e(303232332323,MM#100)
 .s o=Os1-.01
 .i k s %=$o(SSdd(MM,o)) i %,%<Os2 s k=k*max d
 ..f  s o=$o(SSdd(MM,o)) q:o>Os2!'o  s k=k-$g(SSdd(MM,o))
 ..s k=k/max s:k<0 k=0 s:k>1 k=1
 .s:'k k=1
 s MM=%gm(1)+.1 
 F  s MM=$o(AMT(MM),-1) q:MM<d0!'MM  S (am(MM,Osoc),AM)=$g(AMT(MM,Osoc)) F L=1:1:$l(AM,%B) d
 .s gm=MM i xT'["*" i dp+.1>%XD81,gm_33<dp q
 .s am(MM,Osoc)=AM,S=$p(AM,%B,L)
 .Q:S=""
 .;; S m=+$p(S_"m"_MM,"m",2) q:m>%gm  i m<d00,mxConfig[":LM:"!(mxConfig[":HOK"&(S>0)) s m=MM 
 .S m=+$p(S_"m"_MM,"m",2) i m<d00,mxConfig[":LM:"!(mxConfig[":HOK"&(S>0)),MM'>%gm s m=MM
 .i MM>%gm,m'>%gm n MM s (gm,MM)=%gm  ;; +  20160110 for LCT (at home)
 .i m>%gm,MM'>%gm s m=%gm ;; +  20160110 for LCT (at home)
 .q:m>%gm
 .S SS(m,"c")=$G(SS(m,"c"))+S,SS(m,Osoc)=SS(m,"c")
 ;
 i $$m^ZFIO(%gm)
 k s
 F m=d00:1:%gm i m#100<13,m#100 D
 .s gm=m i xT'["*" i dp+.1>%XD81,gm_33<dp q   ;;20040208
 .S s(1,m)=$g(s(1,m))+$G(SS(m,"v"))
 .s s(2,m)=$g(s(2,m))+$G(SS(m,"e"))
 .S s(3,m)=$g(s(3,m))+$G(SS(m,"c"))
 .s s(4,m)=0
 .s s(5,m)=$g(s(5,m))+$g(SS(m,"n"))
 .s s(6,m)=$g(s(6,m))+$G(SS(m,"b"))
 .S s(7,m)=$g(s(7,m))+$G(SS(m,"i"))
 .s s(8,m)=$g(s(8,m))+$g(SS(m,"r"))
 .s s(0,m)=$g(s(0,m))+$g(SS(m,"s"))
 F m=d00:1:%gm i m#100<13,m#100 D 
 .s gm=m i xT'["*" i dp+.1>%XD81,gm_33<dp q   ;;20040208
 .s %=s(3,m)+s(5,m)+s(6,m)+s(2,m)+s(7,m) d:%>s(1,m)
 ..s %=%-s(1,m)
 ..i %>0 s s(5,m)=s(5,m)-%,%=0 i s(5,m)<0 s %=-s(5,m),s(5,m)=0
 ..i %>0 s s(7,m)=s(7,m)-%,%=0 i s(7,m)<0 s %=-s(7,m),s(7,m)=0
 ..i %>0 s s(6,m)=s(6,m)-%,%=0 i s(6,m)<0 s %=-s(6,m),s(6,m)=0
 ..;;i %>0 s s(7,m)=s(7,m)-%,%=0 i s(7,m)<0 s %=-s(7,m),s(7,m)=0  ; 20070731
 ..s SS(m,"e")=s(2,m),SS(m,"n")=s(5,m),SS(m,"b")=s(6,m),SS(m,"i")=s(7,m)
 .s s(9,m)=s(1,m)-s(2,m)-s(3,m)-s(4,m)-s(5,m)-s(6,m)-$s(s(8,m)>s(7,m):s(8,m),1:s(7,m)),SS(m,-9)=$j(s(9,m),0,2)
 .q
 k s
 F m=d00:1:%gm i m#100<13,m#100 D
 .s gm=m i xT'["*" i dp+.1>%XD81,gm_33<dp q   ;;20040208
 .S s(1)=$g(s(1))+$G(SS(m,"v"))
 .s s(2)=$g(s(2))+$G(SS(m,"e"))
 .S s(3)=$g(s(3))+$G(SS(m,"c"))
 .s s(4)=0
 .s s(5)=$g(s(5))+$g(SS(m,"n"))
 .s s(6)=$g(s(6))+$G(SS(m,"b"))
 .S s(7)=$g(s(7))+$G(SS(m,"i"))
 .s s(8)=$g(s(8))+$g(SS(m,"r"))
 .s s(9)=$g(s(9))+$g(SS(m,-444))  ; pens ugd 444
 .s s(0)=$g(s(0))+$g(SS(m,"s"))
 .s s(11)=$g(s(11))+$g(SS(m,-9))
 s %=0
 s s01=$j(s(1),%,2),s02=$j(s(2),%,2),s03=$j(s(5),%,2),s04=$j(s(6),%,2)
 s s05=$j(s(7),%,2),s06=$j(s(8),%,2),s07=$j(0,%,2),s08=$j(s(3),%,2)
 s s09=$j(s(9),%,2),s10=$j(s(4),%,2),s11=$j(s(11),%,2),s12=$j(s(0),%,2)
 s s13=s12,SUM=s13
 q
AM ; 
 s o=$$m^ZFIO(%gm),SNgm=SN,MM=d0-.1 n AK d AMT^zz
 F  s MM=$o(AMT(MM)) q:MM>%gm(1)!'MM  d:$d(AMT(MM))#2
 .i xT'["*" i dp+.1>%XD81,MM_33<dp q
 .s O=99,SS=0
 .f  S O=$o(AMT(MM,O)) Q:'O  S AM=$tr(AMT(MM,O),"'MHD",%B_"mhd"),AMT(MM,O)=AM F L=1:1:$l(AM,%B) d
 ..s S=$p(AM,%B,L) q:S=""  q:O=Osant  q:O=$g(Odividen)
 ..s:$g(%M(O))'[(%B_%B) %M(O)=$p($g(^O(O)),%B,3,9)_%B_%B
 ..s m=+$p(S_"m"_MM,"m",2) i m<d00,mxConfig[":LM:",MM'>%gm s m=MM
 ..i MM>%gm,m'>%gm n MM s (gm,MM)=%gm  ;; +  20160110 for LCT (at home)
 ..i m>%gm,MM'>%gm s m=%gm ;; +  20160110 for LCT (at home)
 ..q:m>%gm  
 ..s SS(m,O)=$g(SS(m,O))+S
 ..s SSdd(m,O)=$g(SSdd(m,O))+$p(S,"d",2) I '$p(S,"d",2) s SSdd(m,O)=$g(SSdd(m,O))+($p(S,"h",2)/8)
 ..s SS(m,"z")=$G(SS(m,"z"))+(O<Or*2-1*S)
 ..q:O>Or  S SS=SS+S
 ..s SS(m,"v")=$g(SS(m,"v"))+S
 ..s SS(m,"e")=$g(SS(m,"e"))+('$e(%M(O))*S)
 ..s o=7
 ..i $e(%M(O),o)=1 s SS(m,"d")=$g(SS(m,"d"))+$p(S,"d",2),SS(m,"h")=$g(SS(m,"h"))+$p(S,"h",2)
 q
 q

bil
bil ; ATG.bilance un PVN [ 04/26/2006  7:00 PM ]  ;[ 20190519 17:36:21 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 q
q() i xf'="",$tr(firma,%LAT,%lat)'[xf q 1
 i 'xDOK,xDOK'="",DOKf'=xDOK q 1
 i xDOK,DOKf-xDOK q 1
 q 0
%vv g @%V
%I0 d %I0^fin q
Kase d %I0,%I0^kas,KaseV^kas q
atg 
pps d %I0,ppsV^tirgus q
pamk d %I0,%I0^pam,pamkV^pam q
FRq 
PAV 
PPR d %I0,%I0^tirgus,PPRV^tirgus q
Saiz7 
Saiz d %I0,%I0^kas,SaizV^kas q
vbak d %I0,vbakV^fin q
ciko d %I0,cikoV^fin q
alg d %I0,algV^zvn  q
ppq6 
ppq 
ppf d %I0,%I0^fin,ppfV^fin q
z5 
 Q:"LVL Ls EUR"'[xVAL  s koko1="z5"  i "EUR"'[xVAL,%gm>201400 q
 s %FILE="z5" d %I0,%I0^fin n T,%I,%I2,DOKf,DOK,firma,fir,kurs,d8,d s T=0
 s (d8,z5C)="",(piez,DOK)="z5",%1=99999999,%I="",%2=0,ob=0,NN=0 k obj
 f  s %I=$o(%tSelect(%I)) q:%I=""  s d=$qs(%I,1) i d?8n s:d<%1 %1=d s:d>%2 %2=d
 n d8maxVoo s d8maxVoo=%XD82 i %1<99999999 s d8=%1-.1,d8maxVoo=%2
 f  s d8=$o(^z5(d8)) q:d8>d8maxVoo!'d8  f  s %I=$o(^z5(d8,%I)) q:%I=""  i '$d(%tSelect)!$d(%tSelect(%I)) f  s z5C=$o(^z5(d8,%I,z5C)) q:z5C=""  d
 .  s r=^(z5C),%I2=%I q:$e(%I)'="^"  i '$d(@%I) k ^z5(d8,%I,z5C) q
 .  s s1z5=$p(r,%B,2),s2z5=$p(r,%B,3),kurs=$$vk^fin(s1z5_" "_s2z5,d8)
 .  s fir=$p(r,%B,4),firma=$p(r,%B,5),(DOK,DOKf)=$p(r,%B,6)
 .  s S=s1z5-s2z5,DK=$p(r,%B,7) i S<0 s S=-S,DK=$p(DK,"-",2)_"-"_$p(DK,"-")
 .  s %1=$p($e(%I,2,99),"("),%R=$g(@%I) q:%R=""  d
 . .   n DOK,DOKf,firma,fir d:'$d(%XG(%1)) ^USX  x %XG(%1)
 .  x xVw i $g(gramatos)>0 s %=$g(^gramatos(d8,%I)) d
 ..    i '$l(%) s ^(%I)=%B_DK_%B_S q
 ..    d kokoSave^fin 
 q
Banka d %I0
BankaV 
 s (OfirO,OfirmaO,DOKfin)="",d8KoFiDo=$g(d8KoFiDo,0) i d8KoFiDo'["-" s d8KoFiDo=0 s:%gm>201400 d8KoFiDo=20131231 
 s %RunQuit=0,oGlob=0,xLev="",ofir="",da=0,%XI=%XI(%FILE),%XG=%XG(%FILE)
 n K,T,fir,firma,DOKf,oI
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I["^Banka(",$d(@%I) s oI=%I d BankaS s (OfirO,OfirmaO)=""
 s oI="^Banka" s:$g(d8KoFiDo) oI=oI_"(d8KoFiDo+.1)" s:$g(xd8start)?8n %I=oI_"("_xd8start_")"
BankaS d:$d(%tSelect)  i '$d(%tSelect) F  S oI=$q(@oI) Q:'$l(oI)  d  Q:'$d(oI)
 .s (%I,%I2)="^"_$e(oI,2,99)
 .X %XI s d8=d,xLev="" s:-d[-9 (d,d8)=19_+d s:$g(flagd8mM) (d,d8)=$$d8mM^fin(.d8,.%I) i d8\1>%XD82,'$d(%tSelect) k:'$g(flagd8mM) oI q
 .S DOKfin="",%R=$tr(@oI,$c(10),"^") x %XG s:'K K=9999 i xT,firma-xT q
 .q:-K[-261  i 'sD,'sK k @%I q           ;;;;;;; uz ^Kase !!!!!
 .s fir=firma,fir2="" s:OfirO=fir firma=OfirmaO
 .i $e(fir),fir[":",-xC[-26,$d(^pers(+fir))!$d(^persArhi(+fir)),$l($p(fir,":",2)) s fir=$p(fir,":",2,9),OfirO=""
 .s:OfirO'=fir!(fir>99) T=0,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma
 .i '$p(sD,"^",2),'$p(sK,"^",2) d Banka1 q
 .n oRo,oo,o1 s oRo=%R,o1=$l(sD,"^"),xLevMax=$l(sK,"^")
 .s:xLevMax<o1 xLevMax=o1
 .f xLev=1:1:xLevMax s %R="" d
 .. F oo=2:1:$L(%LG(%FILE),",") s %n=$p(%LG(%FILE),",",oo),%=$tr(%n,"~"),o1=$p(@%,"^",xLev) d
 ...  s:o1="" o1=$g(oRo(%n,xLev-1)) s oRo(%,xLev)=o1
 .. s %n="" f  s %n=$o(oRo(%n)) q:%n=""  n @%n s @%n=oRo(%n,xLev)
 .. d Banka1
 q:$d(%tSelect)  k xLev
 q
Banka1 
 s:DOK[" " DOK=$tr(DOK," ") s:DOK="-" DOK=-n s DOKf=DOK,Piez=piez,%=1
 g:" . 0 - -- "'[DOKfin DOKfin g:mxConfig[":DOKf=DOK:" DOKfin
 i piez["," s piez=$$trw^UST(piez,", ",","),%=$l($tr(piez,"1234567890"_piez,"1234567890"))/$l(piez)
 i DOK["mu" s %1=$p(DOK,"mu"),%2=$p(DOK,"mu",2) i $l(%1),$l(%2) s DOKf=%1,DOK=%2,%=0
 i piez[$$Uu^MXF("{275}{311}") f o="Nr. ","Nr.","r{275}{311}.","R{275}{311}.","r{275}{311}ins. ","R{275}{311}ins. ","r{275}{311}ins.","R{275}{311}ins." i piez[$$Uu^MXF(o) d  q
 . s %1=$p($p(piez,o,2)," ") s:%1="" %=$p($p(piez,o,2)," ",2)
 . i $l(%1),$l($tr(%1,1234567890_%1,1234567890))>3 s DOKf=%1,%=0
 i %,piez["p" d
 .i $e(piez)="p" s o=$p($p(piez,"p",2)," ") s:$e(o)="p" o=$e(o,2,999) i $l($tr(o,1234567890_o,1234567890))>3!o!($g(xLevMax)>1)!(%FIRMA["NIKSI") s DOKf=$tr(o," ") q
 .i $p(piez,"p",2) s DOKf=$p($p(piez,"p",2)," ") q
 .s o=$p($p(piez,"p",$l(piez,"p"))," ") s:o DOKf=o
DOKfin i " . 0 - -- "'[DOKfin s DOKf=$tr(DOKfin," ")
 i DOKf["d",+$p(DOKf,"d",2)?8n s DOKf=$p(DOKf,"d")
 i "fk fdk"[%V,"5252 2222"[($e(K,1,2)_$e(xC,1,2)),$e(piez)="p" s DOKf=$e(piez,2,99)  ; UPTK 2019
  ;; i -K[-52 s ^k52(DOK)=%I,^k52d(DOKf,d8_%I)=sD-sK_" "_sD_" "_sK
 s AvNor=$p($p(piez,"#",2)," ") i 'AvNor,$e(DOKfin)="#" s AvNor=$e(DOKfin,2,99)
 i bak=K,sK s %=$$vk^fin(sK,-d8) i %,%-1 s %=$p(%,+%,2),bak=bak_"."_%
 s atb=0 i T s atb=T
 i T,-K[-238,'AvNor,$g(xatb) d
 . s o=$o(^oToAvNor(%USID,T,d8-.1)) i $e(o,1,6)=$e(d8,1,6) s AvNor=^(o) q:xatb=T
 . s o=$o(^oToAvNor(%USID,T,d8+.1),-1) i $e(o,1,6)=$e(d8,1,6) s AvNor=^(o) q:xatb=T
 . s AvNor=-T
 q:$$q
 i $d(sD) s ss=sD+sK_" "_sD_" "_sK   i $$koko^fin(ss)
 q
oCFDval 
 q  
GaG ;\GALVENA GRAMATA\C,DK,mm\sd0,sk0,sd,sk\\@kn\k ^opaDokum(%USID)
 s mm=d8\100 s:d8<%XD81 mm=0 
 i C_DK["*" s C=$tr(C,"*"),DK=$tr(DK,"*") d
 . s %mxWarng(%I2)="{1087}{1086}{1078}{1072}{1083}{1091}{1081}{1089}{1090}{1072} {1080}{1089}{1087}{1088}{1072}{1074}{1090}{1077} {1082}{1086}{1085}{1090}* - {1079}{1074}{1077}{1079}{1076}{1086}{1095}{1082}{1072} {1085}{1077}{1076}{1086}{1087}{1091}{1089}{1090}{1080}{1084}{1072} "
 i $g(paDokume),mm s mm=mm_-d8_%I2,^opaDokum(%USID,$p(DK,"-"),mm,DK)=S,^opaDokum(%USID,$p(DK,"-",2),mm,DK)=S
gg s o="-2680-8150-8170-8250-8270-8050-8190-" s:%V["G" o=o_"2380-" 
 f %=1,2 i o[$e($p(DK,"-",%),1,4) s $p(DK,"-",%)=$e($p(DK,"-",%),1,4)
 g dk^fin
GraD ;\GALVENA GRAMATA (DOKUM)\C,DK,mm\sd0,sk0,sd,sk\\@kn
 s mm=d8_firma_%B_DOK_%B_DOKf s:d8<%XD81 mm=0
 g gg
GGD ;\GALVENA GRAMATA (dienas)\C,mm,DK\sd0,sk0,sd,sk\\@kn
 s mm=d8 s:d8<%XD81 mm=0
 g gg
GG ;\GALVENA GRAMATA\C4,kv,m\sd(*),sk(*),sd0(*),sk0(*)\C4-%ggmm\@kn\s sd00=0,sk00=0,iii=0 k f s:'xC xC=2310 k ^oMX(%USID)
 s %=%XD82\10000_"0101" i %<%XD81 n %XD81 s %XD81=%
 n m s m=d8\100 S:d8<%XD81 m=0,kv=0 s:m kv=m#100+2\3
 f %=1,2 s %1=$p(DK,"-",%) i $l($p(%1,".",2))>2 s %1=$p(%1,"."),$p(DK,"-",%)=%1
 s ooxC=xC i -xC[-8 n xC s xC=""
 d dkk^fin
 i '$d(f),S,DK-ooxC=0!($p(DK,"-",2)-ooxC=0) s f=1 d
 .  n S s S=.0000001 f m=%gm\100*100+1:1:%gm s kv=m#100+2\3 d dkk^fin
 q:xC  s o=""
 f  s o=$o(^M(%V,%ggmm,o)) q:'o  i o-ooxC k ^(o),^rm(%V,%ggmm,o)
 q
GGL s C=C4 i %E="kv",'kv q
 s %l="sd sk "
 k msd d
 . n sd,sk,sd0,sk0 s %=$$rm^USX("C4")
 . s %="" f  s %=$o(sd(%)) q:%=""  d  i 'sd(%),'sk(%) k sd(%),sk(%)
 ..   s sd00=sd00+$g(sd0(%)),sk00=sk00+$g(sk0(%))
 . m msd=sd
 s (k,sd,sk,s)="",g=10 f  s k=$o(msd(k)) q:k=""  d
 . f %="sd","sk","sd0","sk0" s @%@(k)=$g(@%@(k))
 . s kk=$p(k,":",2)
 . i msd(k) s g=g+1 x "s r"_g_"=kk"
 . s:sd(k)*sd(k)<.00003 sd(k)=0 s sd=sd+sd(k),sk=sk+sk(k)
 . i msd(k) s %l=%l_" s"_g x "s s"_g_"=sd(k)"
 i '$d(f(%V,C)),C d
 . s sd000=sd00-sk00,sk000=0 s:sd000<0 sk000=-sd000,sd000=0
 . s s4=sd000-sk000,t=$$konti^fin(C),f(%V,C)=1
 q:m=0
 i %E="m" s s4=s4+sd-sk,sd4=s4,sk4=0.0001 s:sd4<0 sk4=-sd4,sd4=0.0001
 s mm=m,gg=GADS
 s kv="    "_$s(kv=1:"  -I-",kv=2:" -II-",kv=3:"-III-",1:"-IV-")
 s rr=$s(%E="kv":"kv",%E="C4":"gg",1:"mm"),ii=@%E
 i $$l("rr ii "_%l_" sd4 sk4 ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
GGDT ;\GALVENA GRAMATA (DT)\-C4,m\sd(),sk(),sd0,sk0\-%ggmm\@kn\s iii=0 k ^oMX(%USID)
 n m,%XD81 s %XD81=$e(%gm,1,4)_"0101",m=0
 s:d8'<%XD81 m=$e(d8,1,6)
 f %=1,2 s %1=$p(DK,"-",%) i $l($p(%1,".",2))>2 s %1=$p(%1,"."),$p(DK,"-",%)=%1
 i 'm g dkk^fin
 d dkk^fin n S s m=0,S=999999 g dkk^fin
 q
GGDTL f o="sd","sk","sd0","sk0" m ^oMX(%USID,%V,C4,m,o)=@o
 q
knf ;\Konta zurnals pa firmam\C,-FK,KOR,firma\sd,sk,sd0,sk0,sdg,skg=%FILE\-%ggmm\@kn\@kn
kn ;\Konta zurnals\C,-FK,KOR\sd,sk,sd0,sk0,sdg,skg=firma,%FILE\-%ggmm\ppq6 Saiz Saiz7 Banka Kase ppq ppf ciko pps atg FRq PPR PAV alg pamk vbak z5\s iii=0 k ^oMX(%USID),s00,s0
 s (sdg,skg)=0 g gg
knfL 
knL i %E="C" s s0(C)=sd0-sk0 q
 i 'sd,'sk,'sdg,'skg q
 n %FILE i $$l("KOR sd sk sdg skg firma %FILE %E ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
knn ;\Konta zurnali\-C4,C,-FK,KOR\sd0,sk0,sd,sk,sdg,skg=firma\-%ggmm\@kn\s iii=0,oC=0 k ^oMX(%USID)
 n FK s FK=-DK[-C,(sdg,skg)=0 g gg
knnL 
 i (sd-sk)*(sd-sk)<.0000003 q:KOR  i (sd0-sk0)*(sd0-sk0)<.0000003 q:KOR  q:oC-C
 i $$l("%E C KOR sd0 sk0 sd sk sdg skg firma")
 s iii=iii+1,oC=C m ^oMX(%USID,%V,iii)=lUST
 q 
bank ;\bank\-d88,-DOKf,%I\sd0(),sk0(),sd(),sk()=firma,piez,kurs,d8,DOK,C\-%ggmm\Banka Kase Saiz ciko vbak\s iii=0 k ^oMX(%USID)
 i d8'<%XD81 s d88=d8 g dk^fin
 n DOKf,%I s (d88,DOKf,%I)=11111111 g dk^fin
 q
bankL s:'d8 d8=d88 
 f n="sd0","sk0","sd","sk" s k=1,@n=0 f  s k=$o(@n@(k)) q:k=""  d:-k[-xC
 . s sdk=@n@(k) x "s "_n_"=$$sv^fin("""_n_"++sdk"")" 
 i $$l("d8 DOK DOKf %I sd0 sk0 sd sk firma piez kurs C")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
kap ;koGra;\Konta gramata\d88,DOK\sd0(),sk0(),sd(),sk()=firma,piez,%FILE,d8,DK,II\-%ggmm\@kn\s k1=0,iii=0 k s0d8,s0d8v,kagC,dDOK,%Vfla(%V),^oMX(%USID),sd0,sk0,sd,sk
 s II=%I2 i %I2["Kasp" s %=piez n piez s piez=$p(%,":.")
  i %I2["ppq6" s %=piez n piez s piez=NN
 i d8<%XD81 n DOK s (d88,DOK)=11111111 g dk^fin
 s %=DOK n DOK s DOK=d8_":"_%_$s(%'[DOKf:" "_DOKf,1:"")_"piez="_$e(piez,1,20)_":!:"_+$g(T)_$e(firma,1,9)_DOKf
 i -xC[-261 s DOK=d8_":"_% s:%=+% DOK=d8_":"_$j(%,''sD+7,0)
 i -xC[-561 s:T DOK=DOK_-T
 i xC[9999,$p(xC,".",2)?2n f %=1,2 s o=$p(DK,"-",%) i $p(o,".",2)=$p(xC,".",2) s $p(DK,"-",%)=xC
 s d88=%XD82 d dk^fin g dkk^fin
 q
kapL s d88ooooo=d88,DOKooooo=DOK,DOK=$p(DOK,":!:")
 i d88=11111111 s (k,sd0o,sk0o)="" f  s k=$o(sd0(k)) q:'$l(k)  d
 .q:-k'[-xC  i k'=xC,xC'["..",xC'["*" q
 .i k'=xC,xC["..",%B_k'[(%B_$p(xC,"..")) q
 .i k'=xC,xC["*",%B_k'[(%B_$p(xC,"*")) q
 .s sd0o=$$sv^fin("sd0o++sd0(k)"),sk0o=$$sv^fin("sk0o++sk0(k)")
 q:d88=11111111
 n o
 s oDOK=DOK s:II'="" II="<mx @"_II 
 i %E="d88" s firma=""
 i DOK[":",DOK s oDOK=DOK,d=+DOK,dDOK=$$dat(+DOK),DOK=$p(DOK,":",2) d
 . s %=0 s:xC %=$p($g(^konti(xC)),%B,4)
 . i $l(%)>2,%'["LVL",%'["Ls",d<20140000 s dDOK=dDOK_" kurs="_$$vk^fin(%,$s(d#100<33:d,1:-d))
 . i '$d(dDOK(dDOK)) s dDOK(dDOK)=1,o=$$l("dDOK d8 II"),iii=iii+1 m ^oMX(%USID,%V,15,iii)=lUST
 s h=" ",(s1d,spk,k,sd,sk,sd0,sk0,osd,osk)=0 k spk s spk=""
 s k="" f  s k=$o(sd(k)) q:k=""  d:k'[":"
 .i $$kxC(k,xC) s osk=$$sv^fin("osk++sk(k)"),osd=$$sv^fin("osd++sd(k)")
 s:osd*osd<.00003 osd=0 s:osk*osk<.00003 osk=0
 k kk 
 i osd s k="" f  s k=$o(sd(k)) q:k=""  s kk=$p(k,":",2) d:kk
 . i '$$kxC($p(k,":"),xC),'$$kxC(kk,xC),-kk'[-5721,-kk'[-8 q
 . i -kk[-5721 s kk=kk_" "
 . i sd(k)["+"!sd(k),$$kxC($p(k,":"),xC) s kk(kk)=$$sv^fin("kk(kk)++sd(k)"),sd=$$sv^fin("sd++sd(k)")
 i osd s k="" f  s k=$o(kk(k)) q:k=""  d
 .s p=""
 .s DOK=$p(oDOK,"piez="),o=$p(DOK,":",2,9) s:o'="" DOK=o
 .s:$l(piez)>2 firma=firma_" ^"_piez s:II'="" DOK=DOK_II
 .i $l(firma)<60 s firma=$tr(firma,"^",":")
 .i k,firma="" s firma=$$konti^fin(k)
 .s sv=$p(kk(k),"++",2,9),o=$e(sv_1,1,3)
 .i %E="DOK" s ^(o)=$g(^oMX(%USID,%V,5,1,o))+kk(k)
 .s DOK2=DOK,firma2=firma,k2=k,kk2=kk(k),p2=p,sv2=sv
 .s DOK4=DOK,firma4=firma,k4=k,kk4=kk(k),p4=p,sv4=sv
 .i %E="DOK",$$l^UST(" DOK2 firma2 k2 kk2 p2 sv2 d88ooooo DOKooooo II")
 .i %E'="DOK",$$l^UST("DOK4 firma4 k4 kk4 p4 sv4 d88ooooo DOKooooo II")
 .s iii=iii+1 m ^oMX(%USID,%V,15,iii)=lUST
 .s firma="",piez=""
 k kk 
 i osk s k="" f  s k=$o(sk(k)) q:k=""  s kk=$p(k,":",2) d:kk
 . i '$$kxC($p(k,":"),xC),'$$kxC(kk,xC),-kk'[-5721,-kk'[-8 q
 . i -kk[-5721 s kk=kk_" "
 . i sk(k)["+"!sk(k),$$kxC($p(k,":"),xC) s kk(kk)=$$sv^fin("kk(kk)++sk(k)"),sk=$$sv^fin("sk++sk(k)")
 i osk s k="" f  s k=$o(kk(k)) q:k=""  s p="" d
 .s p="",DOK=$p(oDOK,"piez="),o=$p(DOK,":",2,9) s:o'="" DOK=o
 .s:$l(piez)>2 firma=firma_" ^"_piez s:II'="" DOK=DOK_II
 .s:$l(firma)<60 firma=$tr(firma,"^",":") i k,firma="" s firma=$$konti^fin(k)
 .s sv=$p(kk(k),"++",2,9),o=$e(sv_1,1,3) 
 .i %E="DOK" s ^(o)=$g(^oMX(%USID,%V,5,2,o))+kk(k)
 .s DOK3=DOK,firma3=firma,k3=k,p3=p,kk3=kk(k),sv3=sv,kk=kk(k)
 .s DOK5=DOK,firma5=firma,k5=k,p5=p,kk5=kk(k),sv5=sv
 .i %E="DOK",$$l^UST("  DOK3 firma3  k3  p3  kk3 sv3  d88ooooo DOKooooo II")
 .i %E'="DOK",$$l^UST(" DOK5 firma5  k5  p5  kk5 sv5  d88ooooo DOKooooo II")
 .s iii=iii+1 m ^oMX(%USID,%V,15,iii)=lUST
 .s firma="",piez=""
 q:%E'="d88" 
 s s4=sd-sk+$g(s0d8(0))
 i $$sv^fin("sd++-sk++s0d8v","s4v")
 i $$sv^fin("sd++sk","v")
 i $$sv^fin("sd++0","sdvv")
 i $$sv^fin("sk++0","skvv")
 s vv="" k Ls m Ls=^oMX(%USID,%V,5) f  s vv=$o(v(vv)) q:vv=""  d
 . s sdvv=$g(sdvv(vv)),skvv=$g(skvv(vv))
 . s Ls1=$g(Ls(1,vv)),Ls2=$g(Ls(2,vv))
 . k p f o=1,2 s v="" f  s v=$o(Ls(o,v)) q:v=""  s p(o)=$g(p(o))+Ls(o,v)
 . s p1=0,p2=0 s:$g(p(1)) p1=Ls1/p(1)*100 s:$g(p(2)) p2=Ls2/p(2)*100
 . s %=$$l("p1 Ls1 p2 Ls2 sdvv skvv vv"),iii=iii+1 m ^oMX(%USID,%V,18,iii)=lUST
 q
kxC(%1,%2) 
 q $$kxC^kas(%1,%2)
tSelect ;\^gramatos\-DOKf,-ooFILE,-d8,-ooI2,-C,-DK,xLev\sd0,sk0,sd,sk=firma,kurs,ko1,Sp,Sb\\@kn\n d8 k ^oMX(%USID,%V) s iii=0,limC="4*",oxCxo=0,vbakStop=1
 s:'$d(%tSelect) %tSelect=0 s ooFILE=%FILE,ooI2=%I2
 s:$g(xLev)="" xLev=0 s ko1=$tr(koko1,%B,"|")
 g ap
tSelectL i $$l("kurs ooFILE d8 ooI2 C DK sd0 sk0 sd sk firma DOKf ko1 Sp Sb")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
ap ;\Apgrozijuma parskats \%C4,C\sd0,sk0,sd,sk=text,text1,fir\\@kn\k ^ito,^oxxTestC,^oapItogo(%USID) k ito s limC="4*" i $g(xC)_$g(xmsm)_$g(xf)_$g(xDOK)_$g(xT)_$g(xINV)_$g(oxCxo)="" s oxCxo=1
 s text="",text1="",DK=$tr(DK," "),mm6=$e(d8,1,6),firm=C
 i xmsm["DOK" s text=%I2 g dk^fin
 i %gm>201900,d8<20170000,-xC[-22 n DOKf s DOKf=-xC,d8=$e(d8,1,4)_1231
 i xC!(xmsm["INV") d  g dk^fin
 . s text=d8_" "_firma_"::"_DOKf_"::<mx @"_%I2,text1=""
 . i xf="" s text=firma s:fir text=fir_" "_firma s:xC[".." text=+xC s:xmsm["INV" text=%I2,text1=""
 . i T,xC,xT["*"!(xmsm["[""alg""") s text=T_":"_$$Fi^ZFIO
 . i T,-xC[-561!(-xC[-238),$d(^pers(T))!$d(^persArhi(T)) s text=T_":"_$$Fi^ZFIO
 . i -xC[-21,-xC'[-219,$l(NN)>1,xmsm["NN" s text=NN_"::"_d8_"::"_DOKf_"::"_%I2
 . s limC=99,%C4=text,firm=text i '$l(%C4) s %C4=xC i '$l(%C4) s %C4=DK i '$l(%C4) s %C4=0
 s %="-2680-8150-8170-8250-8270-8050"
 i $$dkx^fin(S,DK,"s %C4=$e(C,1,4) i $l(C)>4,'xC s:"""_%_"""[$e(C,1,4) C=C\1")
 q
apL 
 s:sd0'<sk0 sd0=sd0-sk0,sk0=0 s:sk0'<sd0 sk0=sk0-sd0,sd0=0
 s s1=sd0+sd,s2=sk0+sk S:s1'<s2 s1=s1-s2,s2=0 s:s2'<s1 s2=s2-s1,s1=0
 f %="sd0","sk0","sd","sk","s1","s2" d
 .i %M[%W s @%=ito(%E,%) k ito(%E,%) q
 .f e="%C4","C","%ggmm" s ito(e,%)=$g(ito(e,%))+@%
 i 'sd0,'sk0,'sd,'sk q
 i %E="%C4" s C=%C4 I limC["*" s C=C_"*"
 i xC,%M[%W d
 . s:sd0>sk0 sd0=sd0-sk0,sk0=0 s:sk0>sd0 sk0=sk0-sd0,sd0=0
 . s:s1>s2 s1=s1-s2,s2=0 s:s2>s1 s2=s2-s1,s1=0
 s:%E="C" ^ito(C)=s1-s2,^ito(23,C)=sd-sk,^ito(C,"t")=text1_text
 s:%E="C" ^oapItogo(%USID,C)=s1-s2,^oapItogo(%USID,23,C)=sd-sk,^oapItogo(%USID,C,"t")=text1_text
 q
AT ;\apgroz-alga\T\sd0,sk0,sd,sk=%I2\\Banka Kase Saiz ciko alg
 q:'T  i $l(xT) s o=T n T s T=o_":"_%I2
 g dk^fin 
ATm ;\apgroz-alga-menesi\T,m,%I2\sd0,sk0,sd,sk\\Banka Kase Saiz ciko alg
 q:'T  i $l(xT) s o=T n T s T=o_":"_%I2
 n m s m=d8\100 S:d8<(%gm\100*10000) m=111111
 d dk^fin k sd0,sk0,sd,sk
 q
BT ;\alga\DK,T\sd0,sk0,sd,sk\\Banka Kase Saiz ciko alg
 q:'T
 g dk^fin
ap12o ;\Apgrozijuma parskats par menesiem\mm,C\sd0,sk0,sd,sk\\@kn\k ^oap12o(%USID)
 s mm=$e(d8,1,6) s:d8<%XD81 mm=1
 g ap
ap12oL s:C ^oap12o(%USID,+mm,C)=sd0-sk0+sd-sk
 q
ap12 ;\Apgrozijuma parskats par menesiem\%C4,C,mm\sd0,sk0,sd,sk=text\\@kn\k ito,^oap12(%USID) s limC=22
 s mm=$e(d8,1,6) s:d8<(%gm\100_"0101") mm=1
 g ap
ap12L s ^("D")=sd+sd0+$g(^oap12(%USID,C,+mm,"D")),^("K")=sk+sk0+$g(^("K"))
 s:mm?6n ^("D")=$g(^oap12(%USID,C,999999,"D"))+sd,^("K")=sk+$g(^("K"))
 i 'C s ^oap12(%USID)=%gm
 q
ito(fo) i '$d(fo) s fo=$p($g(^g1($e(%gm,1,4),+nnn)),%B,5)
 n ss,%k,f,k,k2,z,s s ss=0 i fo<0 s fo=0_fo
 f %k=1:1:$l(fo,"+") s k=$p($p(fo,"+",%k),"-") i k s o=1 d
 .f  s o=$o(ito(o)) q:'$l(o)  i o,o'["*" d:k[".."  i -o[-k&(k=+k)!(o=k),fo'[("("_o_")"),o s ss=ss+ito(o),s(o)=$g(s(o))+ito(o)
 .. i o,-o'[-k,o>k,o'>$p(k,"..",2),fo'[("("_o_")") s ss=ss+ito(o),s(o)=$g(s(o))+ito(o)
 f %k=2:1:$l(fo,"-") s k=$p($p(fo,"-",%k),"+") i k s o=1 d
 .f  s o=$o(ito(o)) q:'$l(o)  i o'["*",-o[-k,o s ss=ss-ito(o),s(o)=$g(s(o))-ito(o)
 k SSSS s s="",o="",SSSS(0)=fo f  s o=$o(s(o)) q:o=""  i s(o) s SSSS(o)=s(o),s=s+s(o) i $d(itoCheck) s itoCheck(o)=s 
 q ss
dat(d8) q $e(d8,1,4)_".g. "_$p(%MONTHS," ",$e(d8,5,6))_". "_$e(d8,7,8)_"."
PVNd ;\PVN.Deklaracija \r\sd(),sk()\\Banka Kase ppq ppf ppq6 pps FRq PPR PAV atg Saiz Saiz7 ciko\k DKdPVN,formPVNd 
 Q:d8<%XD81  s r=1 i xC'="" n xC s xC=""
 i %FILE="ciko",piez["**apSl" q
 i "Vv"[$e(firma),$tr($tr(firma,%LAT,%lat)," ")["valstskase" q
 i K["/5721.2" s o=DK n DK s:o[-5210 $p(o,"-",2)=9999 s:-o[-5210 $p(o,"-")=9999 s DK=o
 i DK["572"!(-DK[-8) s DKdPVN(DK)=$g(DKdPVN(DK))+S
 i $$dkx^fin(S,DK)
PVNdL q
GB ;\B I L A N C E \r,C\sd,sk,sd0,sk0=firma\-%ggmm\@kn\k ito
 s r=1 g dk^fin
GBL s ito(C)=+$g(ito(C))+sd-sk+sd0-sk0
 q
l(%lN,%i,%x) q $$l^UST(%lN)
isGramat(%I) 
 s z="^koko" f  s z=$q(@z) q:z=""  i " "_$p(@z,%B,6)_" "[(" "_$e($p(%I,"("),2,9)_" ") s z=1 q
 q z
gz(d8,%I,xC,z) 
 q -1
pvn(gm,%) s:$e(+gm,1,6)<200000!($e(+gm,1,6)>209900) %mxWarng("PVN")=gm_" -- {1087}{1088}{1086}{1074}{1077}{1088}{1100}{1090}{1077} {1076}{1072}{1090}{1091} PVN -- "_$g(%I)_$g(zi)
 n p s gm=$e(+gm,1,6),p=$s(gm>201206:21,gm>201100:22,gm>200900:18,1:21)
 i gm>201300 n P s P=$o(^mxNorma("PVN","PVN",gm_33),-1) i P>20130000 s P=$g(^(P,"norValue")) s:P<15!(P>30) %mxWarng("PVN")=$zr_"  "_P_" %   -- PVN -- ?? -- mxNorma  -- ",P=0  s:P p=P
 s:$g(%)[100 p=p+100 s:$g(%)[.01 p=p/100
 q p
d8mM(d8,%I) 
 q:$zv'["Ca" d8  x "s %=$d(^||d8mM)" q:'% d8  n z,%2 s z="^mM"
 x "f  s z=$q(@z) q:'$l(z)  s %2=$qs(z,2) i %2 s ^||d8mM($e(%2,2,99))=$$pD^MXD($qs(z,1))"
 x "s %=$d(^||d8mM(%I))"
 q:% @$zr   x "s ^||d8mM(0,%I)=d8" q d8 
s(nform)   ; form=";;+k6110..6119;;+k5210..5219;;-d5210..5219;;:261:262:238"
 n k,k2,o,os,x,s,dia,ia,%,formtt,form,%1,%2,z,DK,if,L,ss m ss=sd,ss=sk
 i nform d
 . i $d(formPVNd(%gm,nform)) s form=formPVNd(%gm,nform) q
 . i $d(^mxNorma("formPVNd",nform)) s o=$o(^(nform,d8+.1),-1) i o s form=^(o,"norma"),if=$g(^("piez")) i 'if,$l(if),'@(if) s if=if_$zr_" form="_form,form="-if"
 . q:$d(form)
 . i $d(^kNo("PVNd2018")) s (form,formPVNd(%gm,nform))=$p($g(^kNo("PVNd2018",nform)),%B,2) q:%gm>201800
 . s (form,formPVNd(%gm,nform))=$p($g(^kNo("PVNd11",nform)),%B,2) 
 q:$l($g(form))<5 "_"_nform_" form="_$g(form)_" if="_$g(if)
 s s=0,form="+"_form,formtt=$$trw^UST(form,"+",";;+")
 s formtt=$$trw^UST(formtt,"-",";;-")_";;"
 s k2=$p(form,":",2,99) i k2 s k2=$p(k2_"::","::")
 s k=0 f  s k=$o(ss(k)) q:k=""  d
 . s o=$p(k,":",2) ;; i k2,o f x=1:1:$l(k2,":") i -o[-$p(k2,":",x) s o=0 q
 . s os=s,%1=$g(sd(k)),%2=$g(sk(k))
 . i %1 s:formtt[("+d"_+k_";;") s=s+%1 s:formtt[("-d"_+k_";;") s=s-%1
 . i formtt[("+k"_+k_";;") s s=s+%2 i form["-(k8)" s %=1 f  s %=$o(DKdPVN(%)) q:'%  i -%[-8,%[-k s s=s-DKdPVN(%)
 . i %2,formtt[("-k"_+k_";;") s s=s-%2
 . ;; s:s %mxWarng(nform_-k)=%1_%B_%2_%B_s_%B_form
 . q:os-s  q:form'[".."
 . f z="+","-" f %=2:1:$l(form,z) s dia=$p($p($p(form,z,%),"+"),"-") d
 .. s if=$p(dia,":",2) i if q:-o'[-if 
 .. s x=+$p(dia,"/",2) s:'x x=1 s x=1/x i dia["*",x=1 s x=+$p(dia,"*",2) s:'x x=1
 .. s ia=$e(dia,2,99)_".."_$e(dia,2,99)
 .. i %1,$e(dia)="d",z="+",k'<ia,k'>$p(ia,"..",2) s s=%1*x+s q
 .. i %1,$e(dia)="d",z="-",k'<ia,k'>$p(ia,"..",2) s s=-%1*x+s q
 .. i %2,$e(dia)="k",z="+",k'<ia,k'>$p(ia,"..",2) s s=%2*x+s q
 .. i %2,$e(dia)="k",z="-",k'<ia,k'>$p(ia,"..",2) s s=-%2*x+s q
 q s
orC ;\pirmas datums \firma\d8\\ppq ppf ppq6 ciko pps atg Saiz Saiz7 PPR PAV FRq Banka Kase z5 vbak\s:'xC xC=2310 k ^orC(%USID)
 i $g(flagDOKf) s o=$tr(DOKf,"1234567890/.-+"_DOKf,"1234567890/.-+") i $l(o)>2,$l($tr(DOKf," "))-$l(o)=3 n DOKf s DOKf=o
 i DOKf["//" s o=$p(DOKf,"//") i $l(o) n DOKf s DOKf=o
 I $l(xf_xDOK),$$q q
 i $l(xmsm) x "s %="_xmsm q:'%
 ;; s ^fd(fir,DOKf,d8_%I)=1,xC1=$p(xC,"+")
 s ^fd1(firma,DOKf,d8_%I)=1,^fd1(firma,"=*=",d8)=1
 n o s o=xC[".."!(xC["*"),oDOK=DOKf,xC1=$p(xC,"+")
 f x=1,2 s C=$p(DK,"-",x) I C-xC1=0!(-C[-xC1&o) d  i $g(%flagVom) s:$l($g(formulaL))<9 formulaL="i $$m^MXF()" x formulaL
 .s v=1 i kurs,kurs-1 s %=S,v=$p(kurs,+kurs,2) n S s S=%
 .s:x=2 S=-S
 .i d8'<%XD81 s ^orC(%USID,xC1,firma)=999999999,^(firma,DOKf)=999999999 q
 .i kurs,kurs-1 s S=S*kurs
 .s %=$g(^orC(%USID,xC1,firma))+S s ^(firma)=%
 .s %=$g(^(firma,DOKf))+S s ^(DOKf)=%
 .i $g(oxVisi),d8'<%XD81 s ^(DOKf)=99999999 q
 .i %*%<.00000001 k ^(DOKf) i $d(^orC(%USID,xC1,firma))<2 k ^(firma)
 q
gramat s %FILE="gramat" d %I0 
 n s,S,kurs,sD,sK,fir,firma,DOK,DOKf,DOKfin,T,%I,%I2,Piez,piez,K,KOR,atb,bak,%R,o,dok,d8,NN,xForm,DKS,DKSnn,DKSn2,gramat,sZak,zDok
 s d8=%XD81-.1,d8=20090000,dok="",NN=0,dad=0 q:$d(%tSelect)  q:$g(%V)="an1"
 s s=0,T=0,rn="",ob=0,kurs=1,piez="" k obj
 f gramat=0:1 s d8=$o(^gramat(d8)) q:d8>%XD82!'d8  s dok="" f  s dok=$o(^gramat(d8,dok)) q:'$l(dok)  d
 .s (DKS,DKSnn,DKSn2)=0,d=d8,(DOK,DOKf,DOKfin)=$tr(dok," "),(sZak,kNN,AvNor,T,atb)=0,kurs=1,val=xVAL
 .s (zDok,fir,piez)="",%=$$getObj^MXTQM($name(^gramat(d8,dok))) q:'$l(zDok)  q:'$d(@zDok)  d  
 .. s d8o=d8,firo=fir n fir,d8 i 1_$$getObj^MXTQM(zDok)  q:$g(d8)-d8o
 .q:'DKS&'DKSnn  s (%I,%I2)=zDok,firma=$$firma^fir(fir)  i fir="" s %mxWarng(zDok)=" {1085}{1077} {1091}{1082}{1072}{1079}{1072}{1085}{1072} {1092}{1080}{1088}{1084}{1072} " q
 .s:'$l(piez) piez=$e($p(zDok,"("),2,99)_"<mx <$$B 9] 9 o xForma="_xForm  s Piez=piez
 .s:DOKf="" (DOK,DOKf,DOKfin)=0  i $g(flagDOKf) s o=$tr(DOKf,"1234567890/.-+"_DOKf,"1234567890/.-+") i $l(o)>2,345[($l($tr(DOKf," "))-$l(o)) s (DOK,DOKf,DOKfin)=o
 .i $l(val)=3,val'=xVAL s kurs=$$vk^fin(1_" "_val,d8)
 .f dks=DKS,DKSnn,DKSn2 f %DKS=1:1:$l(dks,%B) s S=$p(dks,%B,%DKS) i S,$d(@zDok@(%DKS)) s DK=$p(S,":"),NN=$p(S,":",3),(sD,S,ss,Sb,Sbv)=+$j($p(S,":",2),0,2),sK=0,(Sp,Spv)=0 i DK[+xC!'xC d
 .. s bak=$p(DK,"-"),K=$p(DK,"-",2) x xVw
 q
 q

dok
dok ;ATG - kases ord DRUKA  [ 07/18/2005  5:55 PM ]  ;[ 20180530 21:28:01 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX Copyright(c) SIA ENTERS  2005-2017
 ; 
kasOr n Or
 s Or=$s(sD:"ieOr",1:"izOr")
 i Or="ieOr"!(Or="izOr") d @Or
 q
xForma() 
 S xForma=$s(sD:"ieOr",1:"izOr")
 d @xForma
 q xForma
ieOr 
 s d8=d,%B=$c(254),kor=K,s=sD+sK,ieOr=$s(DOK:DOK,1:d8_-n)
 s Datums=$$d8t^MXD(d8)
 i $$icFIRMA^fir(1)
 s %=n n n s n=%,T=0
 s kurs=$$vk^fin(sD_" "_sK,d),merv=$p(kurs,+kurs,2),pie=piez
 i sD["/" s kurs=$$vk^fin($p(sD,"/",1),d8),merv=$p(kurs,+kurs,2)
 n %V s (xForma,%V)=$s(+kurs=1:"ieOr",1:"ieOrv")
 s fir=firma n firma s firma=$$firma^fir(fir) i fir,$d(^pers(fir))!$d(^persArhi(fir)) n Fi s T=fir d ^ZFIO
 s FiReg=firma_"^"_reNr s:T FiReg=Fi_"^"_KODS
 s DOK0=DOK,summa=0,pie="",checks="",sekc="",o=$$Uu^MXF("{269}")
 i piez[o s pie=o_"eki:"_$p(piez,o,2,99),%=piez n piez s piez=$p(%,o)
 s pie=$$trw^UST(pie,"eks","")
 d
 .n K,sD,sK,firma,fir,piez,%R,DOK,maks,DOKfin  k ss,Sb,Sp,iKase s pppp="",n=$s("- 0 "[DOK0:n-.00001,1:"")
 .f  s n=$o(^Kase(d,bak,n)) q:n=""  s %R=^(n) x %XG("Kase") i sD,DOK=DOK0 d  i "- 0 "[DOK0,"- 0 "[DOK q
 .. s %=$p(sD,"p",2),Sb(K)=$g(Sb(K))+sD-%,Sp(K)=$g(Sp(K))+%
 .. s iKase($zr)=piez
 .. s ss(K)=$g(ss(K))+sD,p=$p(sD_" "_sK,"p",2)
 .. s:p ss("PVN")=$g(ss("PVN"))+p,ss(K)=ss(K)-p
 .. i sD["/" s ss(K)=$p(sD,"/",1)
 .. s o=$$Uu^MXF("{269}"),checks=checks_$p(piez,o,2)_" "
 .. s sekc=sekc_$p($p(piez,"s.",2),o)_","
 .. s pppp=pppp_piez_$c(10)
 .s pppp=$p(pppp_$c(10),$c(10)_$c(10))
 k s,kor s k="",sss=0,kor=""
 f %=1:1 s k=$o(ss(k)) q:k=""  s $p(s,"^",%)=$j(ss(k),0,2),$p(kor,"^",%)=k,sss=sss+ss(k),%K=s,summa=sss
 i kurs-1,kurs s summa=summa_" "_merv_"^"_$j(kurs*summa,0,2)_" "_%VaL
 s kurs=+kurs
 s st=$$nt^UST(summa,"",$s(merv'[%VaL:merv,1:%VaL_".cent"))
 i ieOr["=" s %=ieOr n ieOr s ieOr=$p(%,"=",2)
 s OrNum=ieOr
 s ieOr=ieOr_"<mx @"_$g(%I)_"@"
 q
izOr 
 s d8=d,%B=$c(254),kor=K,s=sK+sD,Datums=d8,izOr=$s(DOK:DOK,1:d8_-n)
 s %=n n n s n=%,T=0
 i $$icFIRMA^fir(1)
 s kurs=$$vk^fin($p(sD,"/")_" "_$p(sK,"/"),d),merv=$p(kurs,+kurs,2)
 ;;i sD_sK["/" s kurs=$$vk^fin($p(sD_sK,"/",2),d8),merv=$p(kurs,+kurs,2)
 n %V s %V=$s(+kurs=1:"izOr",1:"izOrv"),xForma=%V
 s izOr=DOK,KODS=""  s Datums=$$d8t^MXD(d8)
 s fir=firma n firma s firma=$$firma^fir(fir) i fir,$d(^pers(fir))!$d(^persArhi(fir)) n Fi s T=fir d ^ZFIO
 s FiReg=firma_"^"_reNr s:T FiReg=Fi_"^"_KODS
 s DOK0=DOK,summa=0
 d
 .n K,sD,sK,firma,fir,piez,%R,DOK,maks,DOKfin k ss s n=$s("- 0 "[DOK0:n-.00001,1:"")
 .f  s n=$o(^Kase(d,bak,n)) q:n=""  s %R=^(n) x %XG("Kase") i sK,DOK=DOK0 d   i "- 0 "[DOK0,"- 0 "[DOK q
 .. s %=sK_" "_sD_" "_sK
 .. s ss(K)=$g(ss(K))+%,p=$p(sD_" "_sK,"p",2)
 .. i -K'[-5 s:p ss("PVN")=$g(ss("PVN"))+p,ss(K)=ss(K)-p
 s %=K k s,kor s k="",sss=0,s=0,kor=%
 s konv=1
 f %=1:1 s k=$o(ss(k)) q:k=""  s ss(k)=ss(k)*konv,$p(s,"^",%)=$j(ss(k),0,2),$p(kor,"^",%)=k,sss=sss+ss(k),summa=sss
 s st=$$nt^UST(summa,"",$s(merv'[%VaL:merv,1:%VaL_".cent"))
 i kurs-1,kurs s summa=summa_" "_merv_"^"_$j(kurs*summa,0,2)_" "_%VaL
 s kurs=+kurs,OrNum=izOr
 s izOr=izOr_"<mx @"_$g(%I)_"@"
 q

fin
fin ; ATG [ 12/05/2006  6:25 PM ]  ;[ 20191121 01:02:54 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX Copyright(c) SIA ENTERS  2005-2019
 q
kokoSave i S<.01,S*S<.0000000001 q
 i $d(%tSelect),d8<d8arhiv q
 s:'$l(%I2) %I2="^oVVVo"  i %I2["^oVVVo" s o=%I2 n %I2 s %kokoNum=%kokoNum+1,%I2=o_(1000000+%kokoNum) s:$l(%I2)>55 %I2="^oVVVo"_(1000000+%kokoNum)
 s:"-231-232-233-234-531-532-533-534-"[$e(DK,1,3)!("-231-232-233-234-531-532-533-534-"[$e($p(DK,"-",2),1,3)) ^apm(firma,d8_%I2)=DK 
 n %10 s:$g(AvNor) %10="|AvNor="_AvNor_"|" s:T %10=$g(%10)_"|T="_+$s($g(Tatb):Tatb,1:T)_"|" 
 i '$d(^gramatos(d8,%I2)) s ^gramatos(d8,%I2)=%B_DK_%B_+S_%B_$s(+kurs=1:1,1:kurs)_%B_firma_%B_DOKf_%B_+Sb_%B_+Sp_%B_+ss_%B_$g(%10) q
 n % s %=$g(^(%I2)) i $l(%)=500,$zv["MS" s %=%_$g(^gramatoz($zr,501))
 s %=%B_$p(%,%B,2)_"^"_DK_%B_$p(%,%B,3)_"^"_+S_%B_$p(%,%B,4)_"^"_$s(+kurs=1:1,1:kurs)_%B_firma_%B_$p(%,%B,6)_"^"_DOKf_%B_%B_%B_%B_$p(%,%B,10)_$g(%10)
 i $zv["MS",$l(%)>500 s ^gramatos(d8,%I2)=$e(%,1,500),^gramatoz($zr,501)=$e(%,501,1009) q
 s ^gramatos(d8,%I2)=%
 q
xVw(%1mVarLi) 
 n %,%2
 f %=1:1:$l(%1mVarLi," ") s %2=$p(%1mVarLi," ",%) d
 .i %2'="",$d(@%2)#10 s %1mVarLi(%2)=@%2
 x xVw
 f %=1:1:$l(%1mVarLi," ") s %2=$p(%1mVarLi," ",%) d
 .i %2'="",$d(%1mVarLi(%2)),%1mVarLi(%2)'=@%2 s @%2=%1mVarLi(%2)
 q ""
dkk s %=DK n DK i %[":" s %=$tr(%,":",".")
 s DK=$p(%,"-")_":"_$p(%,"-",2)_"-"_$p(%,"-",2)_":"_$p(%,"-")
dk N sd,sk
 s DK=$tr(DK," ^,"),FK="+dt",sd=S,sk=0
 s C=$p(DK,"-"),KOR=$P(DK_"-0","-",2)
 d:C w
 S FK="-kr",sk=S,sd=0,C=$P(DK,"-",2),KOR=$p(DK,"-") s:'KOR KOR=0
 g:C w
 q
dkx(S,DK,%X) 
 N sd,sk
 s DK=$tr(DK," ^,"),sd=S,sk=0,C=$p(DK,"-")
 i C x $g(%X) d w
 s sk=S,sd=0,C=$p(DK,"-",2)
 i C x $g(%X) d w
 q ""
q() i $l(xf),$tr(firma,%LAT,%lat)'[xf q 1
 q 0
w i %FILE["ciko" q:%V'["fk"&(piez["*korr.sant.fk*")  q:%VaL'[xVAL&(piez["korr.sant")  i piez["**apSlegt" q:-%XD81'[-$e(%gm,1,4)
 i C["*" s C=$tr(C,"*") s:$l(C)<4 C=$e(C_"0000",1,4) q:'C  
 s %wIndex=$g(%wIndex)+1,C4=C\1 i $l(C4)>6,d8>20140000 s %mxWarng(%I2,C4)=C_" konts vair{257}k nek{257} 6 cipuras "
 i C[":",$g(%lenKont)[":" s C=$p(C,":") s:$g(KOR)[":" KOR=$p(KOR,":") i $g(DK)[":" x "n %,%1 f %=1:1:9 s %1=$p(DK,"":"",%) q:'$l(%1)  s:+%1<1111 $p(DK,":",%)="""" " i DK["::" s DK=$$trw^UST(DK,"::",":")
 i mxConfig[":d8min=" s o=+$p(mxConfig,":d8min=",2) i d8<o q:%I2'["^ciko"  q:d8<(o-1)
 i $g(d8KoFiDo)'<d8,%I'["^KoFiDo(" q   ;;  Ls-EUR  2014.g.
 i xmsm'="" x "s %="_xmsm q:'%
 i C["999",-C["-999",-xC'[-9999 q
 I $l(xDOK_xf),$$q q
 I d8>%XD82,d8\1>%XD82 q
 i $g(oVVVo)-%XD82 s oVVVo=%XD82 i '$l(xC_xmsm_xf_xDOK_$g(xINV)_$g(xT)_$g(xNol)),'$d(%tSelect) d
 .q:%VaL'[xVAL  i $g(oxCxo) k ^oVVVo(%USID) s oDOoVVVo=1,^oVVVo(%USID)=%XD82
 .q:'$g(apSlegt)  n zr s zr="^ciko" k ^oVVVo(%USID) s oDOoVVVo=1,^oVVVo(%USID)=%XD82
 .f  s zr=$q(@zr) q:zr=""  i @zr["**apSleg",$qs(zr,1)>%XD81 k @zr
 i %XD81>20140000,d8<20140000,%I'["^KoFiDo(" q  ;; Ls-EUR
 s:'kurs kurs=1_%VaL i $l(C)<4 s %mxWarng(%I2)=C_" -- konts maz{257}k nek{257} 4 cip. -- !! "
 i $g(oDOoVVVo),kurs-1,kurs-.702804,%FILE'["z5" d
 .s va=$p(kurs,+kurs,2) q:$g(%CvRee)'[(-C_va)!($l(va)-3)  q:%VaL[va
 .s o=firma_-C_%I2_$g(xLev)_+sd_+sk q:o=$g(oooovbak)  s oooovbak=o
 .s %=%I2 i -C[-26 n firma,DOKf s (firma,DOKf)=$e(C,1,4)_":val.starp.",%=""
 .s o=$g(^oVVVo(%USID,va,+C,firma,DOKf,d8_%))
 .s o=(o+sd-sk)_%B_($p(o,%B,2)+(sd-sk*kurs))_%B_%XD82_%B_kurs
 .s:o!$p(o,%B,2) ^(d8_%)=o  k:'o ^(d8_%)  ;; s:o*o<1 ^(d8_%)="_"_+o_%B_"_"_+$p(o,%B,2)_%B_%XD82_%B_kurs
 i xC["+" x "f %=1:1:$l(xC,""+""),0 q:-C[-$p(xC,""+"",%)" q:'%  n xC s xC=""
 i xC s C4=$p(C,":") q:C4'=xC&(xC=+xC)  i xC'=+xC q:%B_C'[(%B_$p($p(xC,"*"),".."))
 i xC,xC'=C,xC'["*",xC'["..","_"_C'[("_"_xC) q
 s (sd0,sk0,sdv,skv,sdg,skg)=0 s:$e(d8,1,4)=$e(%XD82,1,4) sdg=sd,skg=sk
 i kurs-1 s:sd sdv=sd,sd=sd*kurs,sdg=sdg*kurs s:sk skv=sk,sk=sk*kurs,skg=skg*kurs 
 i "vbak z5 ciko alga algV pamk PPRsp PAVsp"'[%FILE,$l($p(sd,".",2))>2!($l($p(sk,".",2))>2),'$d(flagNOz5),-C[-572!(-C[-238)!(-C[-6)!(-C[-23)!("PPR Saiz"[$e(%I,2,4)&(d8>20170000)),%VaL[xVAL d
 .  s (%,z5)="" q:C\1'?4n  i d8<20170000 q:C[5721.3   i -C[-238 q:+kurs=1  
 .  i sd*sd>.01 s %=sd-$j(sd,0,2) q:'%  s $p(z5,%B,2)=%,sd=+$j(sd,0,2)
 .  i sk*sk>.01 s %=sk-$j(sk,0,2) q:'%  s $p(z5,%B,3)=%,sk=+$j(sk,0,2)
 .  q:'$l(z5)  q:%[".0000"  q:DK-$p(DK,"-",2)=0  q:'$g(oxCxo)  
 .  s %=8299_-9999_$s(d8<20190000:"",1:"."_$e(DK,1,2)_$e($p(DK,"-",2),1,2)),$p(z5,%B,4)=fir_%B_firma_%B_DOKf_%B_%_%B_C_%B_DK
 .  s ^z5(d8,%I2,DK)=z5
 s:d8<%XD81 sd0=sd,sk0=sk,(sd,sk)=0
 i xC["*" s:-C[-$p(xC,"*",2)&'xC C=$e($p(xC,"*",2)_"0000",1,4) i xC s o=C n C s C=$p(xC,"*") s:$l(C)<4 C=$e(C_"0000",1,4) i o[":",$p(o,":",2)>1111 s C=C_":"_$p(o,":",2)
 f %="sd0","sk0","sd","sk" i @% s @%=+@% d  s @%@(C)=@% q
 .i %VaL'[xVAL s @%=@%/$$vk^fin(xVAL,d8)_"++"_%VaL_+@% q
 .q:"vbak z5"[%FILE  i +kurs=1 s:@%*@%>.1&($g(%CvRee)[-C) @%=+@%_"++"_%VaL_+@% q
 .s @%=+@%_"++"_$e($p(kurs,+kurs,2)_" ",1,3)_$s(%["d":sdv,1:skv)
 i $g(%flagVom) s:$l($g(formulaL))<9 formulaL="i $$m^MXF()" x formulaL i %flagVom>10,%flagVom<99 k @$s(sd0:"sd0",sk0:"sk0",sd:"sd",1:"sk")@(C) q
 X %XV(%V) k @$s(sd0:"sd0",sk0:"sk0",sd:"sd",1:"sk")@(C)
 q
%vv g @%V
kokoTQM(ss,%ZR) 
 q $$koko1(ss,%ZR)
koko1(ss,zr,%getFile) 
 k %DK1,%DK2 n o,xVw,%I,%I2
 s ss=$g(ss),zr=$g(zr) s:+$g(kurs)=1!'$g(kurs) kurs=1_%VaL s:zr'["^" zr=$g(%ZR) q:zr'["^" ""
 n %ZR s (%I,%I2,%ZR)=zr
 s xVw=" n v,o,b s b="" : "",v="""",o=$p($g(%DK1(DK)),b,2) s:kurs-1 v=""v""_$p(kurs,+kurs,2)_+kurs  s %DK1(DK)=DK_b_(S*kurs+o)_v,%DK2(DK_%B_$s($g(xLev):+xLev,1:1)_%B_%nk)=(S*kurs)_v"
 s:$g(sD) sK=$g(sK) s:$g(sK) sD=$g(sD)
 i ss="",$d(sD),$d(sK) s ss=sD+sK_" "_sD_" "_sK
 ;;q:(ss*ss)<.000000003 -1  
 i '$l($g(%getFile)),$$koko^fin(ss)
 m %mxINFO(1)=%DK1
 s o="" f  s o=$o(%DK1(o)) q:o=""  s %DK1sum(o)=$g(%DK1sum(o))+$p(%DK1(o)," : ",2)
 q ""
koko(ss) 
 s:$l($g(xVAL))<3 (xVAL,%VaL)=$s(%gm>201400:"EUR",1:"LVL") n IDK i +$g(d8)'?8n q 0 
 n o,%nk,DK,S,Sp,Sb,koDtXXXX,koKrXXXX,koSummaX,koPrefXX,%1,%2,%3,%k,%,koFile,d8o,%revDK
 i '$d(%XG("koko")) s %1="koko" d ^USX
 s koFile=$e($p($s(%I2["^":%I2,1:%I),"("),2,99)
 q:'$l(koFile) -1  q:$d(%koko(koFile))=-1 ""
 i '$d(%koko(koFile)) s o="^koko" f  s o=$q(@o) q:'$l(o)  d
 . m:" "_$p(@o,%B,6)_" "[(" "_koFile_" ") %koko(koFile)=^koko($qs(o,1))
 i '$d(%koko(koFile)) s %koko(koFile)=-1 q ""
 i $g(d)-$g(d8),$g(d)?8n,koFile["sp("!(","_$g(%LI(koFile))[",d,") s d8=d
 s (Kurs,kurs)=1_%VaL,o=$tr(ss,"~k=p-+.0123456789 /?:%")
 i $l(o) d
 .i $p(ss,"/")["EUR",'$p(ss,"EUR",2),ss'[")",ss'["=" s (Kurs,kurs)=$s(%gm<201400:".702804EUR",1:"1EUR") q
 .i $l(o)>2!'$d(%ValRee) s (Kurs,kurs)=$$vk(ss,d8) q
 .f %="u","e","r" i o[%,%ValRee[(%_"=") s (Kurs,kurs)=$$vk(ss,d8) q
 i xVw'["%DK1",$g(gramatos) s %kokoNum=0,o=xVw n xVw s xVw="d kokoSave^fin "_o
 s Sp=+$p(ss,"p",2)_" "_ss,Sb=ss-Sp_" "_ss s:$p(ss,"+",2) Sp=+$p(ss,"+",2)_" "_ss,Sb=+ss_" "_ss
 i $g(mxTestDB),Sb,Sp,Sp/Sb>.4 s %mxWarng(%I2)="PVN vair{257}k nek{257} 40% ::: "_ss
 i Sp,d8>20180000,$g(K)["/57",K[" R",$g(%LG(koFile))[",K," s %revDK=+$p(K,"/",2)_-$p(K,"/",2)
 s %nk="" f  s %nk=$o(%koko(koFile,%nk)) q:%nk=""  d
 . s koko1="("_koFile_","_%nk_")"_%koko(koFile,%nk)
 . s %2=$p(koko1,%B,2),%3=$p(koko1,%B,3) i $d(%revDK) k:$p(koko1,%B,5)[" R"!(%2_%3["$p(K,""/"",2)") %revDK
 . x "s koPrefXX="_$p(koko1,%B,5) q:'koPrefXX  x "s koSummaX="_$p(koko1,%B,4) q:'koSummaX
 . x "s koDtXXXX="_$p(%2," ")_",koKtXXXX="_$p(%3," ")
 . s DK=koDtXXXX_"-"_koKtXXXX,S=koSummaX_" "_ss s:'$d(IDK) IDK=DK 
 . i $g(mxTestDB),koDtXXXX<1000!(koKtXXXX<1000) s %mxWarng(%FILE)=koko1_"  :: ^koko :: <<"_DK_">> ::  gramatojuma k{316}uda vai ^koko nepareizi !! "_%I2  
 . i $p(ss,"/",2)>0,ss>0,"^Kase ^Banka ^Saiz"[$e(%I2,1,5),$l(%I2)>4 n oookonvS d  i oookonvS s ss=0 q
 .. s kKonv=+$p($p(koko1,%B,6),"kKonv=",2),oookonvS=$$konvS(ss,bak,K,kKonv) q:'oookonvS
 .. q:+$p(ss,"k=",2)'?8n&(d8<20140000)  n S,kurs s S=$p(ss,"/",2),kurs=$$vk(S,d8)
 .. i -koKtXXXX[-26 s %=$p($p(" "_$p(koko1,%B,6)," k=",2)," ") x:$l(%) " s %="_% i %,$$kura(S_" k="_+$p(ss,"k=",2),%,0,S)
 . i ss["k=",+$p(ss,"k=",2)?8n!(d8>20140000) x xVw s %=$p($p(" "_$p(koko1,%B,6)," k=",2)," ") d:%'=""  q
 ..  x " s %="_% i %,$$kura(S_" "_ss,%,+sD,+sK)
 . i $d(^kokoKorr(d8)) s %=$name(@$$trw^UST(%I2,"sp(","("),1) i $d(^kokoKorr(d8,%,DK)) s o=$g(^(DK)) i o,$p($h,",",2)-$p(o,",",2)>1!($p($h,",",2)<$p(o,",",2)) s S=S+o,$p(^(DK),",",2)=$p($h,",",2)
 . x xVw
 . i %nk[".",koPrefXX,$l($p(%nk,".",2))=3 s %nk=%nk\1+.9999  ;; exit loop, if %nk like x.001 x.002 .. ;;
 i $d(%revDK) s DK=%revDK,S=Sp x xVw
 q 1
kura(ss,K,sD,sK) 
    ; k=20221231     ( kursStarpiba )
 n DK,S,k0,k,kurf,%,K0,%8,minusK,minusS,o,dkurf
 s K0=K,minusK=0,minusS=1 s:K<0 K=-K,minusK=1 s:ss<0 minusS=-1
 ;;  i %FIRMA["Hokeja ",d8<20140000 s o=$p($g(^konti(+K)),%B,4) i $l(o)=3,"LVL"'=o q 0
 n k8150,k8250
 s k8150=8151,k8250=8251,k0=kurs
 s (dkurf,kurf)=+$p(ss,"k=",2)_$p(k0,+k0,2)
 i +dkurf?8n,%gm>201400,dkurf<20140000,d8>20150000 s %mxWarng(%I2)=ss_" - kurss par EURO vai LVL ?? - " q 0
 s kurf=+dkurf  s:+dkurf?8n kurf=$$vk^fin(ss,+dkurf)
 q:'kurf!'K ""  s k=k0-kurf
 i sD s DK=K_"-"_k8150 s:k<0 DK=k8250_"-"_K  ; i sD
 i sK s DK=k8250_"-"_K s:k<0 DK=K_"-"_k8150  ; i sK
 i -K[-238,%FILE["Saiz" d
 .i sD s DK=K_"-"_k8150 s:k>0 DK=k8250_"-"_K
 .i sK s DK=k8250_"-"_K s:k>0 DK=K_"-"_k8150
 i minusK d
 .i sK s DK=K_"-"_k8150 s:k>0 DK=k8250_"-"_K  ; i sD
 .i sD s DK=k8250_"-"_K s:k>0 DK=K_"-"_k8150  ; i sK
 s S=k*ss s:k<0 S=-S s S=S*minusS
 i $l(firma) f o="firma","DOKf","sD","sK","ss","DK","S","k0","kurf","d","dkurf" d
 . s ^ooMX(%USID,"kura",firma,%I,o)=$g(@o)
 n kurs s kurs=1_$p(k0,+k0,2)
 x:S xVw
 q S
konvS(S,bak,K,kKonv,dKonv) 
 q:(d8>%XD82) 0  ;  q:-bak[-2690!(-K[-2690) 0  ;   S1/S2val  S1val/S2
 s:'$g(dKonv) dKonv=d s:-d[-9 dKonv=19_dKonv
 i '$d(k8170) f %=8170,8270 s @("k"_%)=$g(^SetATG("konti",%),%) d
 . i $g(^(8070))'="",$g(^(8070))'[";;" s k8070=8070
 i $g(k8070) s (k8170,k8270)=k8070
 s %="SetATG(""konti"",""kKonv"")" s:'$d(@%) @%=$g(@("^"_%))
 s:@% kKonv=@% s:'$g(kKonv) kKonv=2680
 n kurs1,kurs2,S1,S2,kurs,k1,k2,%1,%2
 i sD,-bak[-26,d8>20100000 d:d8>20110000  s S=$p(S,"/",2)_"/"_$p(S,"/"),%=K,K=bak,bak=% n sK s sK=sD n sD s sD=0
 . s kurs1=$$vk($p(S,"/"),dKonv),%1=$p(kurs1,+kurs1,2),kurs2=$$vk($p($p(S,"/",2),"k="),$s(sK'["k=":dKonv,1:$p(sK,"k=",2))),%2=$p(kurs2,+kurs2,2)
 . i kurs1,kurs1-1,%VaL'[%1 s:$g(^konti(bak))'[%1 %mxWarng(%I)=S_" -- val{363}ta neatbilst konta "_bak_" val{363}tai "_$g(^konti(bak)) i kurs2,kurs2-1,%VaL'[%2 s $p(S,"/",2)=$p(S,"/",2)*kurs2
 s (%1,S1)=$p(S,"/"),(%2,S2)=$p(S,"/",2)
 s (kurs(%1),kurs1)=$$vk(%1_"/",dKonv),(kurs(%2),kurs2)=$$vk(%2_"/",dKonv)
 q:S1*S2=0 0
 q:kurs1=kurs2 0
 n S,KR,DT,sKR,sDT,DK
 s:sD DT=bak,sDT=%1,KR=K,sKR=%2
 s:sK DT=K,sDT=%2,KR=bak,sKR=%1
 s %1=DT,%2=KR s:-%1'[-26 %1=%2 s:-%2'[-26 %2=%1
 s S=sKR,DK=kKonv_"."_%1_"-"_KR,kurs=kurs(S) s:+kurs=1&(+kurs1=.702804)&(d8>20100000) S=+sDT_" EUR",kurs=kurs1 s %=$$xVw("d8 DT KR sDK sKR")
 s S=sDT,DK=DT_"-"_kKonv_"."_%2,kurs=kurs(S),%=$$xVw("d8 DT KR sDK sKR")
 s S=(sKR*kurs(sKR))-(sDT*kurs(sDT))
 i mxConfig'[":(Ls LVL)[xVAL:",%VaL'[xVAL s S=0
 q:S*S<.000000003 1
 i S>0 s DK=k8270_"."_%1_"-"_kKonv_"."_%1
 e  s S=-S,DK=kKonv_"."_%2_"-"_k8170_"."_%2
 s kurs=1_%VaL x xVw
 q 1
vk(Sv,d,b) 
 s %VaL=$s($g(%gm)>201400:"EUR",1:"LVL")
 i $g(%gm)>201400,d[20131231!(-d>20131230&(-d<20140102)) s d=20140102 q:Sv["USD" .515/.702804_"USD"  q:Sv["CHF" ".815305547CHF"  q:Sv["SEK" ".1111262884SEK"  q:Sv["CAD" ".6872471CAD"
 q:'$l($tr(Sv,"0123456789.-+p% ")) 1_%VaL   i d<0 q:-d'?8n "1:???:-d="_d_";"_Sv  s:-d>20140000 d=-d 
 i d>20140101 s d=$s(d#100>1:d-1,1:$$d8plus^MXD(d,-1)) i d>20150000 s:d[1230 d=d+1
 i d<20140102,d>0,$g(%gm)>201400 s d=20140102 ;; ECB-EURO 
 i d<0,d[".",$p(d,".",2),$p(d,".",3),-d<33 s d="-"_$$dmg^MXD($e(d,2,14)) 
 i d>0,d[".",$p(d,".",2),$p(d,".",3),d<33 s d=$$dmg^MXD(d) 
 s d=$e(+d,1,9) i d'<0 q:d'?8n "1:???:d="_d_";"_Sv
 ;s:$g(b)="" b="-" 
 s b="-" n k,v,%,o
 s:$l($g(xVAL))-3 xVAL=%VaL
 i '$d(%ValRee) s (%ValRee,%)="" d
 . s o=$p($g(^mxConfig(1,"fin","%ValRee",1)),%B,2)
 . s:$l(o) %ValRee=o_" "
 . f  s %=$o(^VAL(%)) q:%=""  i $l(%)=3,$tr(%,"QWERTYUIOPASDFGHJKLZXCVBNM")="",%'=%VaL s %ValRee=%ValRee_%_" "
 q:'$l(%ValRee) 1_%VaL
 i 'Sv,Sv["u",$tr(Sv,123456789,999999999)'[9 s Sv=$tr(Sv,"u")
 i Sv["u" s Sv=Sv_" USD",%=$p(Sv,"u",2) i %,%<1 s Sv=Sv_+%
 s v=$s(Sv["EUR":"EUR",Sv["USD":"USD",1:"") i v="",d>20140000,Sv["LVL"!(Sv["Ls") q "1.4228718LVL"
 i '$l(v) f %=1:1 s v=$p(%ValRee," ",%) q:v=""  q:Sv[v  i $l(v)>3,Sv[$p(v,"=") d  s v=$p(v,"=",2) q
 .i Sv[($p(v,"=")_"=") s Sv=$$trw^UST(Sv,$p(v,"=")_"=",$p(v,"=",2)_"=")
 q:%VaL[v 1_%VaL
 s k=+$p(Sv,v,2) i d<20131231&(Sv*Sv<1)!(Sv[(v_"+"))!(Sv[(v_"-"))!(Sv[(k_"/"))!(Sv[("++"_v))!(k<0) s k=0
 i k?8n,k>19900000,k<20990000 s:%gm<201400 d=+k,k=0 s:k>20140000 d=$$d8plus^MXD(k,-1),k=0 i k,%gm>201400,d<20140000 s %mxWarng($zr)=k_%B_Sv_%B_d_" ---  val{363}tas kurss LVL ??  --- "_$g(%I2),k=0,d=20140101  
 i k s %=+$o(^VAL(v,$s(d>0:d,1:-d)+1),-1) s:'% %=+$o(^(0)) s %=$p($g(^(%,"-")),$c(254),2) i %*2>k,%/2<k q k_v
 i k s:d>20140000 %mxWarng($zr)=k_%B_Sv_%B_d_" --- nere{257}ls val{363}tas kurss --- "_$g(%I2) q k_v
 i Sv[(v_")"),$p(Sv,"(",2),Sv s %=$$vk($p(Sv,"(",2),d) q:%-1 $p(Sv,"(",2)*%/Sv_%VaL  q 1_%VaL
 i Sv[(v_"=") d  i Sv s k=$p(Sv,v_"=",2)/Sv q:k>0 $j(k,0,11)_1_v
 . f %=1:1:9 q:$p(Sv," ")[(v_"=")  s Sv=$p(Sv," ",2,9)
 i v="EUR" q:d>20140000!(d<-20140000) "1EUR"  i d>0 s d=-d 
 i d<0 s %=-d,d=+$o(^VAL(v,-d+1),-1) s:'d d=+$o(^VAL(v,-d8+1),-1) i $e(%,1,4)-$e(d,1,4) s %mxWarng("kurs:"_v)="exchange not present in ^VAL("_%
 s k=+$p($g(^VAL(v,d,b)),$c(254),2) q:k>0 k_v
 i d>$$pD^MXD($h) s %=d,d=+$o(^VAL(v,$g(%XD82)+1),-1),d=d8,%mxWarng(%I)=%_" datums vairaak nekaa "_$$pD^MXD($h)_"  datums bus "_d8
 s k=+$p($g(^VAL(v,d,b)),$c(254),2) q:k>0 k_v
 i d>20140000,Sv["LVL"!(Sv["Ls") q +$j(1/.702804,0,4)_"Ls"
 s o="v="_v_" d="_d_" Sv="_Sv_"::: define currency exchange rates! "
 s %=d,d=+$o(^VAL(v,d),-1),k=+$p($g(^(d,b)),$c(254),2) d:$e(%,1,4)-$e(d,1,4)  q:k>0 k_v
 . q:v="LTL"!(%<20160000)  ;; s %mxWarng("kurs:"_v)=$g(%I)_$g(%I2)_k_" -- for more than one year rate is not recorded in the table ^VAL("_%_"   "_Sv
 q "1:???:"_v_":::"_Sv
%I0 f %1="pers" d ^USX  s %VaL=$s(%gm>201400:"EUR",1:"LVL") s:$l($g(xVAL))<3 xVAL=%VaL 
 s kurs=1_%VaL,d=1,nn="" i $g(vbakStop)="" s vbakStop=0 s:'$d(^VAL) vbakStop=1
 S (T,INV,C,DI,piez,parko,Srea,bak,K,sD,sK,s)=0
 s (sVAL,VAL)=0
 s (firma,DOK,DOKf,n,sd,sk,sd0,sk0,fir2,ob,NN,da,DK)=0 k obj
 d %lat k %I S %I="^"_%FILE
%lat g %lat^MXF
Kase d %I0,%I0^kas,KaseV^kas q
Banka d %I0,BankaV^bil        q
pamk d %I0,%I0^pam,pamkV^pam q
atg 
pps d %I0,ppsV^tirgus q
Saiz7 
Saiz d %I0,%I0^kas,SaizV^kas q
z5 d z5^bil q
vbak d %I0
vbakV k oDOoVVVo
 i mxConfig'[":(Ls LVL)[xVAL:",%VaL'[xVAL q
 n %,S,SS,s,d,d8,v,%kn,bak,K,k,sVAL,kurs,n,%XD81p,zr,zr0
 s kn="",n=0,(sD,sK,T,INV,Sb,Sp,ss,ob,K)=0,zr0=-1,%gm01=%gm\100_"01" k obj
 k ^ossVAL(%USID),^ooodsAll(%USID) n d26,%XD31
 ;;  k ^oDOKclos(%USID)  ;;  m ^oDOKclos(%USID)=^ooods(%USID)
 s DOKf=0,kurs=1_%VaL,zr="^oVVVo(%USID)",%XD81p=$$d8plus^MXD(%XD81,-1),%=$e(%XD81,1,4)_"01"
 f %1=%gm01:1:%gm f %=%1_$$d31^MXD(%1),$$d8plus^MXD(%gm01_"01",-1),%XD82,%XD81p s %XD31(%)=31,d26(%)=%
 f  s zr0=zr,zr=$q(@zr) q:zr=""  q:$qs(zr,1)'=%USID  d
 .s (d8,d8zr)=+$qs(zr,6),(bak,%kn)=+$qs(zr,3),(%I,%I2)=$e($qs(zr,6),9,99)
 .q:d8>%XD82
 .i xC,-xC'[-8,-%kn'[-xC q
 .s (fir,firma)=$qs(zr,4),v=$qs(zr,2),(DOK,DOKf)=$qs(zr,5)
 .s SS=@zr,K=9999,sVAL=+SS,S=+$p(SS,%B,2),k="."_+$tr(%kn,".","")
 .s d8close=$p(SS,%B,3) 
 .i -%kn[-26 n firma,DOKf s (firma,DOKf)="kurs.starp."_%kn,d8close=%XD82,od=%XD82
 .i -%kn'[-26 s ^("sVAL")=$g(^ooodsAll(%USID,+%kn,firma,DOKf,d8,"sVAL"))+sVAL
 .i -%kn[-26 s d26=d8 f  s d26=$o(d26(d26)) q:'d26  d
 ..  s ^ooodsAll(%USID,+%kn,firma,DOKf,d26,"%I")="^oVVVo"
 ..  s ^("k")=k,^("v")=v,^("sVAL")=$g(^("sVAL"))+sVAL,^("S")=$g(^("S"))+S
 .i -%kn'[-26 s od=0 d   ;; s o=$g(^ooods(%USID,firma,DOKf,+%kn)),od=+$p(o,"d",2) d
 .. k %XD,kokoSave s:v="EUR" %XD(20060101)=1
 .. f %=d8,od,%XD81p,%XD82 i %'<d8,%'>d8close,%'>%XD82 s %XD(%)=1 
 .. f %=$e(d8,1,4)_1231:10000:$e(d8close,1,4)_1231,d8close i %'<d8,%'>d8close,%'>%XD82 s %XD(%)=1231
 .. s %=1 f  s %=$o(%XD31(%)) q:'%  i '$d(%XD(%)),%'<d8,%'>d8close,%'>%XD82 s %XD(%)=31
 .. n d8 s d8=1 f  s (d,d8)=$o(%XD(d8)) q:'d8  s k=$$vk(v,-d8) d
 ...  s ^ooodsAll(%USID,+%kn,firma,DOKf,d8,"%I")="^oVVVo" 
 ...  s ^("k")=k,^("v")=v 
 ;
 s (firma,DOKf,%kn)=""
 f  s (bak,%kn)=$o(^ooodsAll(%USID,%kn)) q:'$l(%kn)  f  s firma=$o(^ooodsAll(%USID,%kn,firma)) q:'$l(firma)  f  s (DOK,DOKf)=$o(^ooodsAll(%USID,%kn,firma,DOKf)) q:'$l(DOKf)  d
 .n d8 s d8=0,k0=0,sVAL=0,SS=0 f  s (d8,d)=$o(^ooodsAll(%USID,%kn,firma,DOKf,d8)) q:'d8  d
 ..  s DK=%kn_-8150,(%I,%I2)=$g(^(d8,"%I")),k=$g(^("k")),v=$g(^("v"))
 ..  i -%kn'[-26 s %=k-k0,S=$s(k0:sVAL*%,1:0),k0=k,sVAL=$g(^("sVAL"))+sVAL,^("S")=S,^("sVAL")=sVAL
 ..  i -%kn[-26 s (S,s1)=^("S"),sVAL=^("sVAL"),k=$$vk(v,d8),s=$j(sVAL*k-S,0,2),S=s-SS,SS=s,DOK=$j(1/k,0,5)_"<mx @ kurs.starp.no.g.sakuma="_s_"   valutas.atlikums="_sVAL_" atlikums="_+s1
 ..  ;; i -%kn[-26,d8>20170000,S*S<.1 s ^("S")="_"_S,^("sVAL")="_"_sVAL q
 ..  q:'S  ;;  s:-%kn'[-26 ^(+%kn)=$g(^oDOKclos(%USID,firma,DOKf,+%kn))+S
 ..  i d8>20180000,S<0,mxConfig'[":8150:" s S=-S,DK=8250_"-"_%kn
 ..  i $$xVw("v k k0 kurs S d d8 sVAL firma DOKf DOK %kn")
 ..  i $g(gramatos)>0 s:'$l(%I2) (%I,%I2)="^oVVVo" d kokoSave
 q:'$g(oxCxo)  q:$$d8plus^MXD(%XD82,1)#100=1  q:$d(%tSelect)  q:$g(^oVVVo(%USID))-%XD82 
 k ^oVVVgm(%USID,%gm) m ^oVVVgm(%USID,%gm)=^oVVVo(%USID)
 q
ciko d %I0
cikoV 
 s s=0,d8KoFiDo=$g(d8KoFiDo,0) i d8KoFiDo'["-" s d8KoFiDo=0 s:%gm>201400 d8KoFiDo=20131231 
 f %1="Firma","ciko" d ^USX
 n K,fir,firma,T
 I $d(%tSelect) s %I="" d  g cikoE
 .f  s (%I2,%I)=$o(%tSelect(%I)) q:%I=""  i %I["^ciko(",$d(@%I) d cikoS
 s %I="^ciko" s:$g(d8KoFiDo) %I=%I_"(d8KoFiDo+.1)" s:$g(xd8start)?8n %I="^"_%FILE_"("_xd8start_")"
cikoS d:$d(%tSelect)  i '$d(%tSelect) f  s (%I2,%I)=$q(@%I) q:%I=""  d  q:'$d(%I)
 .x %XI(%FILE) s d8=d i $g(flagd8mM) s (d,d8)=$$d8mM^fin(.d8,.%I) 
 .s %R=@%I x %XG(%FILE) i d8>%XD82,'$d(%tSelect) k:'$g(flagd8mM) %I q
 .s da=0 i %R["a=" s da=$p($p($p(%R,"a=",2)," "),%B) ;; i -bak[-52 s ^k52(DOK)=%I
 .i $g(xT),xT-firma q
 .s:DOK[" " DOK=$tr(DOK," ") s (DOKf,DOKfin)=DOK,Piez=piez,fir=firma,(sZak,kNN,AvNor)=0
 .s T=0,atb=0,firma=$$firma^fir(fir)
 .q:$$q  i xVAL["EUR",%I["san",-%gm[-2013,(sD+sK)*(sD+sK)<.001,%R["kor" q
 .s KOR=K,C=bak,ss=sD+sK_" "_sD_" "_sK,ob=0 s:piez["ob=" ob=$p($p(piez,"ob=",2)," ")
 .i T,-bak[-238 s AvNor=$p(piez_"#"_-T,"#",2),atb=T i $e(d8,1,4)<($e(%gm,1,4)-1),AvNor s AvNor=$e(d8,1,4)
 .i $$koko(ss)
 d gramat,KoFiDo
cikoE n %FILE s %FILE=""
 f  s %FILE=$o(^mxConfig(1,"runFile",%FILE)) q:%FILE=""  d
 . s oRunFile=$p($g(^(%FILE,1)),%B,2),%3=$p($g(^(1)),%B,3) s:" -- "[%3 %3=1 i @%3 x oRunFile
 q
gramat d gramat^bil
 q
KoFiDo s %FILE="KoFiDo" d %I0 i $g(d8KoFiDo)["-",'d8KoFiDo q
 n s,S,kurs,sd,sk,sd0,sk0,sD,sK,fir,firma,DOK,DOKf,DOKfin,T,%I,%I2,Piez,piez,K,KOR,atb,bak,%R,o
KoFiDoV s d8KoFiDo=+$o(^KoFiDo(%XD81-.1),-1)*(%gm>201400) q:d8KoFiDo'<%XD82!'d8KoFiDo  q:$d(%tSelect)  q:$g(%V)="an1"  q:%gm<201400
 s s=0,T=0,rn="",ob=0,%I="^KoFiDo(d8KoFiDo)" k obj  f %1="Firma","KoFiDo" d ^USX
 f nnnKoFiDo=0:1 s (%I2,%I)=$q(@%I) q:%I=""  q:$qs(%I,1)-d8KoFiDo  d
 .x %XI(%FILE) s d=d8,(bak,%C4,C)=konts,(DOK,DOKf,DOKfin)=$tr(dokf," ") i xC,-C'[-xC q
 .i $g(flagDOKf) s o=$tr(DOKf,"1234567890/.-+"_DOKf,"1234567890/.-+") i $l(o)>2,345[($l($tr(DOKf," "))-$l(o)) s (DOK,DOKf,DOKfin)=o
 .s %R=@%I x %XG(%FILE)  s:DOKf="" (DOK,DOKf,DOKfin)=0
 .s Piez=piez,(sZak,kNN,AvNor,T,atb)=0,firma=$$firma^fir(fir)
 .s (K,KOR)=9999,(S,ss,Sb,Sbv)=sD+sK_" "_sD_" "_sK,(Sp,Spv)=0  i -C[-572 s (Sp,Spv)=S,(Sb,Sbv)=0
 .s kurs=$$vk^fin(sD_" "_sK,20131231),dd=+piez,dad=$p(piez,"dad=",2)+$p(piez,"da=",2),d8i=0 s:'dad dad=$$d8plus^MXD(d8,7) s da=dad s:dd?8n d8i=dd
 .s:DOK["T:" T=$p(DOK,"T:",2) i T s atb=T i $g(xT),xT-T q
 .s (sdv,sd)=sD,(skv,sk)=sK,rn=""  q:$$q  i %gm>201400,$d(^dad($e(C,1,2),firma,DOKf,"rn")) s rn=@$zr 
 .;; i xC[-22,%gm>201900 s DOKf=-2013
 .i sD s DK=C_-9999 x xVw q
 .i sK s DK=9999_"-"_C,%=K,(K,KOR)=C,C=% x xVw q
 q
alg d %I0,algV^zvn q
FRq 
PAV 
PPR  d %I0,%I0^tirgus,PPRV^tirgus q
ppq6 
ppq 
ppf  d %I0,%I0^fin
ppqV 
ppq6V 
ppfV k q,DOKfin,dOk,dof s (T,c,NN,q,piez,parko)=0,d8KoFiDo=$g(d8KoFiDo,0) i d8KoFiDo'["-" s d8KoFiDo=0 s:%gm>201400 d8KoFiDo=20131231 
 i %FILE="ppq6" k ^rrr("Srea")
 f %1="Firma" d ^USX
 n oda,oNN,OfirO,OfirmaO,K,fir,firma,T
 s (oNN,OfirO,OfirmaO,sKb)="",%XI=%XI(%FILE),%XG=%XG(%FILE)
 I $d(%tSelect) s %I="" d  q
 .f  s (%I2,%I)=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) d ppfS s (oNN,OfirO,OfirmaO)=""
 s %I="^"_%FILE s:$g(d8KoFiDo) %I=%I_"(d8KoFiDo+.1)" s:$g(xd8start)?8n %I="^"_%FILE_"("_xd8start_")"
ppfS d:$d(%tSelect)  i '$d(%tSelect) F  S (%I2,%I)=$q(@%I) Q:%I=""  k DOKfin d  q:'$d(%I)
 .X %XI s d8=d s:$g(flagd8mM) (d,d8)=$$d8mM^fin(.d8,.%I) i d8>%XD82,'$d(%tSelect) k:'$g(flagd8mM) %I q
 .s (nos,da,m,NN,Srea,ob,nol)=0 k obj,dof,DOKfin s %R=@%I X %XG i DOK[" " s DOK=$tr(DOK," ") s:'$l(DOK) DOK=0
 .i %R["ob=" s (obj,ob)=$p($p($p(%R,"ob=",2),%B)," ")
 .i nol[".",ob=0 s ob=$p(nol,".",2)
 .s:oNN'=NN nos=$$nos^tirgus(NN,%gm),oNN=NN i $d(obj) s ob=obj k obj
 .s DOKf=DOK,Piez=piez,fir=firma,fir2="" i $d(DOKfin)#2,$l(DOKfin)>1 s DOKf=DOKfin
 .s:OfirO=fir firma=OfirmaO s DOKfin=DOKf
 .s:OfirO'=fir!(fir>99) T=0,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma
 .q:$$q  i $g(dOk)'=DOKf,$d(dOk) s dOk("%I2")=%I2 m:d8>%XD81 ^fdOk(firma,DOKf)=dOk k dOk 
 .s dOk("sK")=$g(dOk("sK"))+sK s:$p(sK,"-",2)&(sK>0) dOk("atla")=$p(sK,"-",2)
 .i sD_sK["a" f o="sD","sK" i @o["a" s da=$tr($p(@o,"a",2),"=") q
 .i 'da,%R["a=" s da=$p($p(@%I,"a=",2),%B) d:da\1?4n&(da[".")  s da=+da
 .. s o=$p(da,".",3),di=$p(da,".",2) s:'di di=1
 .. s:'o o=$s(o["jan":1,o["feb":2,o["mar":3,o["apr":4,o["ma":5,o["nij":6,o["lij":7,o["sep":9,o["aug":8,o["okt":10,o["nov":11,o["dec":12,1:$e(d8,5,6))
 .. s da=da\1*10000+(o*100)+di
 .i da,$e(da,1,4)?4n,$e(da,5)'?1n s da=$e(d8,1,4)_$e(da,1,4)
 .i 'da,$d(^oooda(firma,DOKf)) s da=+^(DOKf)
 .s:'da da=7 i da?8n,piez["a=" s piez=$p(piez,"a=")
 .i da<999 s da=$$d8plus^MXD(d8,da)
 .s ^oooda(firma,DOKf)=da,dOk("da")=da
 .i sD_sK["r" f %="sD","sK" i $e(@%)="r" d  q
 .. s Srea=$p(@%,"r",2),@%="",s=sD+sK
 .. i Srea["%" s Srea=sD+sK+$p(sD_" "_sK,"+",2)*Srea/100
 .. f %="Srea","s" s ^(%)=$g(^rrr("Srea",%XD82,%))+@%
 .s ss=sD+sK_" "_sD_" "_sK
 .i $$koko(ss)
 .i $d(dof),$l(dof)>2 s DOKfin=$p(dof," "),%=$p(dof," ",2) s:$l(%) fir=%,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma i $l(DOKfin)>1,1_$$koko(ss) k dof
 q
kn ;;\\\\\ppq ppf ppq6 ciko pps atg Saiz Saiz7 alg pamk PPR PAV FRq Banka Kase z5 vbak
knf ;;\\\\\ppq ppf ppq6 ciko pps atg Saiz Saiz7 PPR PAV FRq Banka Kase z5 vbak
dat(d8) q $e(d8,1,4)_".g. "_$p(%MONTHS," ",$e(d8,5,6))_". "_$e(d8,7,8)_"."
fk ;\pa firmam-datiem-dokum.\firma,-d1,DOKf,-d8,-DK,%FILE\sd(),sk(),sd0(),sk0()=%I,%I2,fir,xForm\\@knf\k ss,ofir,sss,^oMX(%USID) s i=0,iii=0,ofir=-1 ;; s %=$$%v^USX("orC","bil")
 i d8<%XD81 q:d8<$p(mxConfig,":d8min=",2)&(%FILE'["ciko")  i DOKf["maks.kart" n d8,d s (d,d8)=%XD81-1  
 s Ck=xC,xC1=$p(xC,"+"),xForm=$g(xForm)
 i $g(flagDOKf) s o=$tr(DOKf,"1234567890/.-+"_DOKf,"1234567890/.-+") i $l(o)>2,$l($tr(DOKf," "))-$l(o)=3,o'["//" n DOKf s DOKf=o i $e(o,$l(o))="-" s DOKf=$e(o,1,$l(o)-1)
 I $l(xf_xDOK),$$q q
 i $e(DOKf,1,2)="//" s DOKf=0_DOKf
 ;; I d8<%XD81 s %=$g(^orC(%USID,xC1,firma,$p(DOKf,"//"))) i %*%<.00003 q:xf=""  q:DOKf'=$g(DOKf2)
 ;; s %=$g(^orC(%USID,xC1,firma))
 ;; I %*%<.003 s d2=$o(^fd1(firma,"=*=",99999999),-1) q:d2<(%XD81-100)&'$l(xf)
 i DOKf["//",-xC1'[-521 s o=DOKf n DOKf s DOKf=$p(o,"//"),DK=DK_":AV:"_$p(o,"//",2)
 i DOKf["//",-xC1[-521 s o=DOKf n DOKf s DOKf=$p(o,"//",2),DK=DK_":AV:"_$p(o,"//")
 s (o,d1)=1  i %gm>201900,d8<20170000,-xC[-22 n DOKf,%FILE s DOKf=-xC,d8=$e(d8,1,4)_1231,DK=xC,%FILE=0
 ;; i $d(^fkA(xC1,firma,DOKf)) s o=^(DOKf) i o'>%XD82 q 
 ;; i -xC1'[-521 f  s o=$o(^fd1(firma,DOKf,o)) q:'o  i o["^" s:+o'?8n!($e(o,9)'="^") %mxWarng(%I2)=o_"  --  {1076}{1072}{1090}{1072} {1085}{1077} 8 {1094}{1080}{1092}{1088} :ggggmmdd: "  i +o?8n,$e(o,9)="^",$d(@($e(o,9,99))) s d1=+o q   ;;;;;;;CDR AV:
 g dk
fkL s s=$g(^om(%USID,1,firma,%B,"s")) i $l(s),s*s<.001 s %1=$g(^("sd")),%2=$g(^("sk")) i %1*%1<.001,%2*%2<.001 q
 i $l(s) s s=$g(^om(%USID,1,firma,DOKf,"s")) i $l(s),s*s<.001 s %1=$g(^("sd")),%2=$g(^("sk")) i %1*%1<.001,%2*%2<.001 q
 s E=%E 
 s sd=0,sk=0,sd0=0,sk0=0,o=xC[".."!(xC["*")
 s k="" f  s k=$o(sd(k)) q:k=""  d:k-xC=0!(-k[-xC&o)!$$xCplus(xC,k)
 .s sd=$$sv("sd++sd(k)"),sd0=$$sv("sd0++sd0(k)")
 .s sk=$$sv("sk++sk(k)"),sk0=$$sv("sk0++sk0(k)")
 i 'sk,'sd,'sk0,'sd0 q
 s s=sk0 s:sk0'<sd0 s=sd0 s sd0=$$sv("sd0++-s"),sk0=$$sv("sk0++-s")
 i %E["%g" f %="sd0","sk0","sd4","sk4" s @%=ss(%)
 d:%E="firma"
 . s sd4=sd0-sk0+sd-sk,sk4=0 s:sd4<0 sk4=-sd4,sd4=0
 . f %="sd0","sk0","sd4","sk4" s ss(%)=$g(ss(%))+@%
 . ;; s o=$g(^ooodS(%USID,$p(xC,"+"),firma))
 . ;; i (sd4-sk4)*(sd4-sk4)<.00003,o*o<.1 k ^(firma)
 s s="" i %E="DOKf" s s=sd0-sk0+sd-sk ;; d
 . ;; s o=$g(^ooodS(%USID,$p(xC,"+"),firma,DOKf)) i s*s<.00003,o*o<.1 k ^(DOKf)
 s:d8 ofir=fir s tip=1 s:%E="firma" DOKf=ofir
 i $$l("DOKf d8 DK sd0 sk0 sd sk s firma fir tip %I2 E %E xForm")
 i %E'["firma" s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 f %="sd","sk","sd0","sk0" s @%=$$sv(%_"++0",%),sss=$$sv("sss++"_%,"sss")
 ;
 d:%E="firma"!(%E["%g")
 .s sf=$$sv("sd4++-sk4") s:sf*sf<.0000003 sf=0
 .s sd0f=sd0,sk0f=sk0,sdf=sd,skf=sk
 .s %=$g(^fk0(+$p(xC,"+"),firma,%gm(-1)))
 .i xf_xDOK="",%XD82#100>27 s ^fk0(+$p(xC,"+"),firma,%gm)=+sf
 .s tip=3 i $$l("firma fir sd0f sk0f sdf skf sf tip %I2 E %E")
 .s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 .k ofir
 k sd,sk,sd0,sk0,%FILE
 q
fks ;\apmaksa pa firmam\firma,-d1,DOKf\sd(),sk(),sd0(),sk0()=%I,%I2,fir,da,oda,rn\\@knf\k ss,ofir,^oMX(%USID),^ooM(%USID),sd0,sk0,sd,sk,fksAll
 i fir,fir?1n q
 i $g(flagDOKf) s o=$tr(DOKf,"1234567890/.-+"_DOKf,"1234567890/.-+") i $l(o)>2,345[($l($tr(DOKf," "))-$l(o)) n DOKf s DOKf=o
 I $l(xf_xDOK),$$q q
 s Ck=xC,rn=$g(rn),da=$g(da) s:%I2["KoFiDo" da=dad,d1=dd  s:'da da=$p(sD,"a",2) s:'da da=$p(sK,"a",2) 
 i da,$e(da,1,4)?4n,$e(da,5)'?1n s da=$e(d8,1,4)_$e(da,1,4)
 i 'da,$g(@%I)["a=" s da=$p($p(@%I,"a=",2),%B) d:da\1?4n&(da[".")  s da=+da
 . s o=$p(da,".",3),di=$p(da,".",2) s:'di di=1
 . s:'o o=$s(o["jan":1,o["feb":2,o["mar":3,o["apr":4,o["ma":5,o["nij":6,o["lij":7,o["sep":9,o["aug":8,o["okt":10,o["nov":11,o["dec":12,1:$e(d8,5,6))
 . s da=da\1*10000+(o*100)+di
 i %I2'["Banka" i 'da,$d(^oooda(firma,DOKf)) s da=+^(DOKf)
 i %I2'["Banka" s:'da da=7 i da<999 s da=$$d8plus^MXD(d8,da)
 s oda=0  i da s:da<d8 da=da+10000 s oda=$g(^oooda(firma,DOKf))_" da="_da
 s:firma="" firma=0 ;; i "-"_DK[-6 s ^ooM(%USID,firma,DOKf)=DK
   s ^ooM(%USID,firma,DOKf,"da")=da_"  "_%I2
 s (o,d1)=1 
 ;; f  s o=$o(^fd1(firma,DOKf,o)) q:'o  i o["^",$d(@($e(o,9,99))) s:+o?8n d1=+o q
 s:da ^ooM(%USID,firma,DOKf,"%I2",%I2)=da  s:%I2["KoFiDo" d1=dd,da=dad s:d1'?8n d1=d8
 g dk
fksL q
fdda ;\Salidzin. akts\firma,DOKf,d8\sd0(),sk0(),sd(),sk()=fir,reNr,piez,%I\firma\@knf\s:'xC xC=2310 k ss,d0,^oMX(%USID),sd,sk,sd0,sk0 s iii=0
 i fir,fir?1n q
 s Ck=xC
 i $g(flagDOKf) s o=$tr(DOKf,"1234567890/.-+"_DOKf,"1234567890/.-+") i $l(o)>2,$l($tr(DOKf," "))-$l(o)=3 n DOKf s DOKf=o
 I $l(xf_xDOK),$$q q
 i '$g(oxVisi) s %=$g(^orC(%USID,xC,firma,DOKf)) q:%*%<.00003
 s %=$g(^orC(%USID,xC,firma))
 I '$g(oxVisi),%*%<.00003 s d2=$o(^fd1(firma,"=*=",99999999),-1) q:d2<(%XD81-100)
 g dk
fddaL 
 q:%E["%g"  i %I["^" s II=%I
 s:fir'="" fir1=fir
 s sd=0,sk=0,sd0=0,sk0=0,sd4=0,sk4=0
 s k="" f  s k=$o(sd(k)) q:k=""  d
 .q:-k'[-xC  i k-xC,xC'["*",xC'[".." q
 .s sd=$$sv("sd++sd(k)",2),sd0=$$sv("sd0++sd0(k)",2)
 .s sk=$$sv("sk++sk(k)",2),sk0=$$sv("sk0++sk0(k)",2)
 s s1=$$sv("sd++sd0"),s2=$$sv("sk++sk0") 
 ;
 i '$g(oxVisi),(s1-s2)*(s1-s2)<.00003 k:%E'="d8" d0 q:%E'="firma"
 ;
 i %E="firma" d
 . s sd4=$$sv("sd++-sk++sd0++-sk0","vv"),sk4=0
 . s:sd4<0 sk4=$$sv("0++-sd4","vv"),sd4=0
 i %E="d8" d  q
 . s d0(d8)=$g(d0(d8))_$s(sd+sd0:"d",1:"")_$s(sk+sk0:"k",1:""),II=%I
 i %E="DOKf" d  k d0
 .s d1="" f  s d1=$o(d0(d1)) q:'d1  i d0(d1)["d" q
 .s d2=999999999,h=" " f  s d2=$o(d0(d2),-1) q:'d2  i d0(d2)["k" q
 .f o="s1","s2" d:@o
 ..  i @o'["++" s @o=$j(@o,0,2) q
 ..  s @o=$$trw^UST(@o,"++","^"),$p(@o,"^")=+$j($p(@o,"^"),0,2)
 .i $$l(" s1   s2   DOKf     d1      d2    fir1 II ")
 .s iii=iii+1 m ^oMX(%USID,%V,firma,iii)=lUST
 s d1="",d2=""
 i %E="firma" s v=9,s1v=sd4,s2v=sk4 d
 .i $$l(" sd4.__ sk4.__ v") i (sd4-sk4)*(sd4-sk4)<1,xf="" k ^oMX(%USID,%V,firma) q
 .s iii=iii+1 m ^oMX(%USID,%V,firma,iii)=lUST s o=$$sv^fin("s1v++-s2v",2) q:o*o<.1
 .s %=$e($p(o,"++",2),4,99) q:'%  s %=o/%-$$vk^fin(o,%XD82) q:%*%>.02
 .f xx=2:1 s v=$o(vv(v)) q:v=""  d
 .. s sd4=$e($p(s1v,"++",xx),4,44)_" "_$e($p(s1v,"++",xx),1,3)
 .. s sk4=$e($p(s2v,"++",xx),4,44)_" "_$e($p(s2v,"++",xx),1,3)
 .. i 1_$$l("sd4 sk4 v") s iii=iii+1 m ^oMX(%USID,%V,firma,iii)=lUST
 k sd,sk,sd0,sk0
 q
konti(C) 
 n %,%B,CC s %B=$c(254),CC=C i -C[-9999,$d(^kNo("fondi",+$p(C,".",2))) q $p(@$zr,%B,3)
 i C[":",+C=9,$p(C,":",3)>1111 n C s C=$p(CC,":",3),CC="Bank:"_$p(CC,":",2)
 s C=$p($p(C_"      ","      "),":") s:C="" C=" " q:C="*" C s %="^konti"
 s %=$p($g(@%@(C)),%B,2) s:%="" %=$p($g(^(+C)),%B,2)
 i %="",C["*"!(C[".."),C n o s o=+C f  s o=$o(^konti(o)) q:o=""  i -o[-C s %=%_o_": "_$p(^(o),%B,2)_%B
 i %="" s %=$tr(C,123456780.9_C,123456780.9) s:%'="" C=%,%=""
 i %="" s %=$p($g(^(C)),%B,2) i %="",C'["*" s %=$p($g(^(C\1)),%B,2)
 i %="" s %=" ("_$s(C=23:"debitori",C=53:"kreditori",1:C)_")"
 s:C["pvn"!(C["PVN") %=%_" PVN"  s:CC'=C %=%_" "_CC
 q $e($tr(%,"^"," "),1,500)
atl q
sv1(%sss,%d) 
 s %d=$g(%d,d)
 n %sign,%11,%n,%nx,%ssss,%v,%,%sssv,kurs s %ssss="",%sssv=""
 f %11=1:1:$l(%sss,"++") s %n=$p(%sss,"++",%11) d
 . s %sign=1 s:$e(%n)="-" %sign=-1,%n=$e(%n,2,99)
 . i $e(%n)'?1n,'%n,'$d(@%n) q
 . x "s %="_%n q:'%
 . s kurs=$$vk(%,%d),%v=$p(kurs,+kurs,2) s:%v'="" %v(%v)=%
 . s %ssss=%ssss+(%*kurs*%sign)
 . s %sssv=%sssv+(%sign*%)_%v
 s %v="" f %=0:1 s %v=$o(%v(%v)) q:%v=""
 i %<2&% s %=%sssv
 e  s %=%ssss
 q %
sv(%sss,%2) 
 n %sign,%11,%n,%nx,%ssY,%v,%sssv,kurs,o,%ozx,%zr s %ssY="",%zr=$zr
 i %sss'["++",%sss["+"!(%sss["-") s kurs="" d  q %ssY_" "_$p(kurs,+kurs,2)
 .i "+-"'[$e(%sss) s %sss="+"_%sss
 .f %11=1:1:$l(%sss,"+") s %n=$p($p(%sss,"+",%11),"-") i $l(%n) s %ssY=%ssY+@%n s:+kurs=1!'kurs kurs=$$vk(@%n,-$$d8^MXF)
 .f %11=1:1:$l(%sss,"-") s %n=$p($p(%sss,"-",%11),"+") i $l(%n) s %ssY=%ssY-@%n s:+kurs=1!'kurs kurs=$$vk(@%n,-$$d8^MXF)
 f %11=1:1:$l(%sss,"++") s %n=$p(%sss,"++",%11) d
 . s %sign=1 s:$e(%n)="-" %sign=-1,%n=$e(%n,2,99)
 . i $e(%n)'?1n,'%n,'$d(@%n) q
 . x " s %ozx="_%n q:'%ozx
 . s %ssY=%ssY+(%sign*%ozx)
 . f %nx=2:1:$l(%ozx,"++") s %v=$e($p(%ozx,"++",%nx),1,3) s:$l(%v) %ssY(%v)=$g(%ssY(%v))+($p(%ozx,"++"_%v,2)*%sign)
 s %v="",o=9 s:$g(%2) o=%2
 f  s %v=$o(%ssY(%v)) q:%v=""  s:%ssY(%v) %ssY=%ssY_"++"_%v_+$j(%ssY(%v),0,o)
 i $g(%2) q %ssY
 i $g(%2)'="" k @%2 m @%2=%ssY s @%2@(1)=+%ssY
 q:$d(@%zr) %ssY  q %ssY
svp(%sss,o,%3) 
 n %11,%n,%nx,%ssY,%v,%s,%ozx s %ssY="",o=$g(o,9)
 i $g(%3)'="" d  q $p(%ssY_%3_%3,%3_%3)
 . f %11=1:1:$l(%sss,"++") s %ozx=$p(%VaL_"*"_%sss,"++",%11) d
 .. s %v=$e(%ozx,1,3),%s=$e(%ozx,4,99)
 .. s:%11=1!%s %ssY=%ssY_%v_+$j(%s,0,o)_%3
 f %11=1:1:$l(%sss,"++") s %ozx=$p(%VaL_"*"_%sss,"++",%11) d
 . s %v=$e(%ozx,1,3),%s=$e(%ozx,4,99)
 . s:%11=1!%s %ssY=%ssY_%v_+$j(%s,0,o)_" "
 q $e(%ssY,4,999)
s(form)   ; form=";;+k6110..6119;;+k5210..5219;;-d5210..5219;;:261:262:238"
 q $$s^bil(form)
l(%lN) q $$l^UST(%lN)
xCplus(xC,k) q:xC'["+" 0
 n % f %=1:1:$l(xC,"+"),0 q:-k[-$p(xC,"+",%)
 q %
pvn(gm,%) q $$pvn^bil(gm,$g(%))
d8mM(d8,%I) q:$zv'["Ca" d8  q $$d8mM^bil(d8,%I)
 q

fir
fir(f,%fir) ; ; [ 02/15/2006  5:18 PM ]  ;[ 20191207 21:14:26 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 n o,fir s o="",fir=f f  s o=$o(^Org(o)) q:o=""  i $g(^(o,"firma"))=f s fir=o q
 i o="" f  s o=$o(^Firma(o)) q:o=""  i $p(^(o),%B,2)=f s fir=o q
 i '$d(%fir),$$firma(fir)
 q fir
apmaksa(d8start,d8finish) 
 q apmaksaeeeeeeeeeeeee
oQuery(xC,xf,xDOK) 
 ;; i oQueryeeeeeeeeeeeee
 n nnn,%se,%10,%1,h,%I,%I2,firma,d8,%DK,zr,r,%S,kurs,o,DOKf,xT k ^oQuery(%USID)
 s zr="^gramatos",xf=$g(xf),xT=0,nnn=0,h="^" s:'$g(xC) xC=$g(oxxC)
 i '$g(^gramatos) q "!-gramatos=0"
 i xf,$d(^pers(xf)) s xT=xf
 f  s zr=$q(@zr) q:'$l(zr)    s r=@zr s:$l(r)=500 r=r_$g(^gramatoz(zr,501)) s d8=$qs(zr,1),%DK=$p(r,%B,2) q:d8>%XD82  d:%DK[+xC 
 .s (%I,%I2)=$qs(zr,2),%S=$p(r,%B,3),%kurs=$p(r,%B,4),%10=$p(r,%B,10)
 .s firma=$p(r,%B,5),DOKf=$p(r,%B,6)
 .i xT,%10'[("|T="_xT_"|") q
 .i 'xf,$l(xf),$tr(firma,%LAT,%lat)'[xf q
 .i 1_$d(^oQuery(%USID,d8_%I2,1)) 
 .f o=1:1:$l(%DK,h) s DK=$p(%DK,h,o) i DK[+xC d
 .. s %="",S=$p(%S,h,o),kurs=$p(%kurs,h,o) s:kurs-1&kurs S=S*kurs  ;_"++"_$p(kurs,+kurs,2)_+S
 .. i $p(DK,"-")=xC s %=$s(d8<%XD81:"sd0",1:"sd"),^(%)=$g(^(%))+S
 .. i $p(DK,"-",2)=xC s %=$s(d8<%XD81:"sk0",1:"sk"),^(%)=$g(^(%))+S
 .. i $l(%) s nnn=nnn+1 s:xT ^("T")=+$p(%10,"|T=",2) s ^("firma")=firma,^("%10")=%10 s ^("og")=zr_r
 q nnn_" xC="_xC_" xf="_xf_" xT="_xT 
BOSS i eeeeeeeeeeeeeeee
 q
ssum(%I,atla) 
 d ssum^tirgus(%I,atla)
 q
firma(fir,%find) 
 s (ema,eMail,tel)=""  ;; s (tel,fax,men,gra,pas,dir,ema,eMail)=""
 n %,o,f s reNr=$g(reNr,0),adr=$g(adr,0),%find=$g(%find),T=+$g(T) i '$l($g(fir)) s KODS=$g(KODS,0),fir=1
 i %find=-1 s %="" x "f  s %=$o(^Org(%)) q:'$l(%)  q:$g(^(%,""firma""))=fir" q %
 i %find=2,$d(^Org(fir)) s %find=0
 i %find>0 k %SEL d  q fir 
 . s %E=fir,o="",f=$tr($p(fir_"..",".."),oLat1_";. ",oLat2) q:'$l(f) 
 . f  s o=$o(^Org(o)) q:'$l(o)  i $tr(o_%B_$g(^(o,"firma")),oLat1,oLat2)[f s %SEL(o)=$g(@$zr),%E=$s(%find["%SEL":"%SEL"_$p(%find,"%SEL",2,9),1:"%SEL"),%=$g(^("VK")) s:'$l(%) %=$e($g(^("reNr")),1,2) i $l(%) d  s %SEL(o,1)="c:\mx\flag\"_%_".gif"
 .. s:%["IN" %="RU" q:$tr(%,"QWERTYUIOPASDFGHJKLZXCVBNM")=""  s %=$s(%["{1059}{1053}":"BY",$g(^(o,"firma"))["OOO":"RU",1:%)
 .. s:$tr(%,"{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}")="" %="RU"
 ;; i $d(xFirF),fir'=1,fir'="%FIRMA" s firf=fir x xFirF i firma'="" s reNr=VATnoINN q firma
 n %1,firma,%R,FIRMA s firma=$g(^Org(fir,"firma")) n:fir<100 T i fir>99,'$d(^pers(+fir)) n T
 f %1="Firma","pers" d:'$d(%XG(%1)) ^USX
 i '$l($g(%XG("Firma"))) s %XG("Firma")=""
 s T=+fir,firA=fir,Fi=0,KODS=0,banka="bank",pase=$g(pase,"pase") i T<0 s T=-T,fir=$e(fir,2,99)
 i '$l(firma) s %R=$g(^Firma(fir)) n pvn s pvn=0 x %XG("Firma") s:$g(FIRMA)'="" firma=FIRMA s:$l(pvn)-1>$l(reNr) reNr=pvn
 ;; i %flagOrg s firma=^Org(fir,"firma")
 s bank="" s:$e(firma)=" " firma=$e(firma,2,99)  s:'$l(firma) firma=fir  s:banka["s:" banka=$tr(banka,":","=")
 s banKonts=$p($p(banka,"konts=",2)," ") s:$l($g(^("bankon1")))>3 banKonts=^("bankon1")
 s banKods=$p($p(banka,"kods=",2)," ") s:$l($g(^("bankod1")))>3 banKods=^("bankod1")
 s banka=$p($p(banka,"konts="),"kods=") i $l($g(^("banka1")))>3 s banka=^("banka1"),bank=banka_"  "_banKods_$c(10)_banKonts
 s kFir=2310 s:$g(reDt) kFir=reDt s:$l($g(reAd))<5&$g(reAd) kFir=reAd
 ;; d
 s %=$g(^("adr")) s:$l(%)>3 adr=% 
 s %=$g(^("faks1")) s:$l(%)>5 fax=% 
 s %=$g(^("eMail1")) s:$l(%)>5 ema=%,eMail=% i ema="" s %=$g(^("eMail")) s:$l(%)>5 eMail=%,ema=%
 s %=$g(^("reNr")) s:$l(%)>5 reNr=% ;;  s:$l(VAT)>5 reNr=VAT
 s OrgVAT="",VAT="" i $l($g(^("VAT")))>5 s (VAT,OrgVAT)=^("VAT") 
 i fir=1 f o="tel","gra","kas","dir" d   s %BANK=bank,%FIRMA=firma,%ADR=adr,(%reNr,%RENR,%REGN)=reNr s:$l(VAT)>5 %REGN=VAT
 . s @(o_1)=$g(^mxConfig(1,"firma",o_1,1))
 . i @(o_1)="" s @(o_1)=$p($p($p($g(^Firma(1)),o_"=",2)," "),%B)
 ;;
 s:reNr[$$Uu^MXF("{1048}") reNr="RU"_reNr
 s OrgVK="zz",%=$e(reNr,1,2) s:$l(VAT)>5 %=$e(VAT,1,2) s:%["IN" %="RU" d  s:$l(%)&'% OrgVK=%
 . q:$tr(%,"QWERTYUIOPASDFGHJKLZXCVBNM")=""  s %=$s(%["{1059}{1053}":"BY",firma["OOO":"RU",adr["Polija":"PL",1:%)
 . s:$tr(%,"{1062}{1059}{1050}{1045}{1053}{1043}{1064}{1065}{1047}{1061}{1060}{1067}{1042}{1040}{1055}{1056}{1054}{1051}{1044}{1046}{1069}{1071}{1063}{1057}{1052}{1048}{1058}{1068}{1041}{1070}")="" %="RU"
 s dap="" i 'reNr s o="QWERTYUIOPASDFGHJKLZXCVBNM" i o'[$e(reNr_1)!(o'[$e(reNr_11,2)) s reNr="xx"_reNr
 i T s %R=$g(^pers(T))_$g(^persArhi(T)) i T=+fir,%R="" s T=0
 i T,%R'="" d ^ZFIO s (firma,o)=Fi s:$l(reNr)<5 reNr=%REGN
 ;; i T,%R'="",$g(mxTestDB),$l(firma) s o=$s($d(^Firma(T)):$zr,$d(^Org(T)):$zr,1:1) s:'o %mxWarng(T)=firma_%B_o_"="_$g(FIRMA)
 q firma
q() q:xf_xDOK="" 0
 i xf'="" i $tr(firma,%LAT,%lat)'[xf q 1
 i 'xDOK,xDOK'="",DOKf'=xDOK q 1
 i xDOK,DOKf'=xDOK q 1
 q 0
FDK(xmsm) i FDKeeeeeeeeeee
 q
FDKkoko i FDKeeeeeeeeeee
 q
FDKdok(fir,dok,xC,d1,d2,%i,oRound) 
 i FDKdokeeeeeeeeeeeee
 q
DC(xmsm) q fff
icFIRMA(%) q $$firma(1)
ofd() i ofdeeeeeeeeeeeeeeeeeee
 q fff
wofd() s DOKo=DOKf,o=$tr(DOKf,"1234567890./-"_DOKf,"1234567890./-")
 i $l(o)>5 s DOKo=o
 i $l(fir),$l(DOKo) s ^ofd(%USID,fir,DOKo,d8_%I)="" i DOKf'=DOKo s ^(0)=DOKf
 q 1
DOKfir(DOKf,mxINFO) 
 q ""  ;  i '$d(^ofd(%USID)) i $$ofd()
 n fir,ff s (ff,fir)="" 
 f  s fir=$o(^ofd(%USID,fir)) q:'$l(fir)  d:$d(^ofd(%USID,fir,DOKf))
 . i fir,$d(^pers(fir)) q
 . s ff=ff_fir_%B s:$g(mxINFO) %mxINFO(1,55)=fir_%B_DOKf_%B_$g(^(DOKf,0))_$c(10)
 q $e(ff,1,$l(ff)-1)
 q

gra
gra ; ;[ 11/04/2006  4:59 PM ]
 q
icFIRMA(%) q:$d(%) $$icFIRMA^fir(%)  q $$icFIRMA^fir()
start g start^QQ

kas
kas ;ATG.-kase, avans.norek [ 05/28/2005  11:48 PM ]  ;[ 20190118 18:58:05 ]
 ; MSM, CACHE, GT.M, MiniM
 ; VMX  Copyright(c) SIA ENTERS  2005-2019
 q
q() i xf'="" i $tr(firma,%LAT,%lat)'[xf q 1
 q:xDOK="" 0 i 'xDOK,DOKf'=xDOK q 1
 i DOKf-xDOK q 1
 q 0
dk g dk^fin
dkk g dkk^fin
parm g parm^fin
alg d %I0,%I0^fin,algV^zvn   q
vbak d %I0,%I0^fin,vbakV^fin  q
Banka d %I0,BankaV^bil         q
ciko d %I0,%I0^fin,cikoV^fin  q
FRq 
PAV 
PPR d %I0,%I0^fin,PPRV^tirgus q
pps d %I0,%I0^fin,ppsV^tirgus q
ppq6 
ppq 
ppf d %I0,%I0^fin,ppfV^fin   q
z5 d z5^bil                 q
Kase d %I0,%I0^fin
KaseV n %iKasp,fi2,T,AvNor,piez,firma,fir
 f %1="Kasp","Firma" d ^USX s (OfirO,OfirmaO,DOKfin)="",d8KoFiDo=$g(d8KoFiDo,0) i d8KoFiDo'["-" s d8KoFiDo=0 s:%gm>201400 d8KoFiDo=20131231 
 I $d(%tSelect) s %I="" d  q
 .f  s (%I2,%I)=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) d KaseS s (OfirO,OfirmaO)=""
 s %I="^"_%FILE,da=0  s:$g(d8KoFiDo) %I=%I_"(d8KoFiDo+.1)"  s:$g(xd8start)?8n %I="^"_%FILE_"("_xd8start_")"
 i $g(%d8start(%FILE))>$g(d8KoFiDo) s %I="^"_%FILE_"("_%d8start(%FILE)_")" k %d8start(%FILE) 
KaseS d:$d(%tSelect)  i '$d(%tSelect) f  s (%I2,%I)=$q(@%I) q:%I=""  d  q:'$d(%I)
 .x %XI(%FILE) s d8=d s:$e(d)="9" (d8,d)=$e(19_+d,1,8) s:$g(flagd8mM) (d8,d)=$$d8mM^fin(.d8,.%I) i d8>%XD82,'$d(%tSelect) k:'$g(flagd8mM) %I q
 .i d8'?8n s %mxWarng(%I)=" {1085}{1077}{1087}{1086}{1085}{1103}{1090}{1085}{1086} {1082}{1072}{1082}{1072}{1103} {1076}{1072}{1090}{1072} ?? d="_d8 q
 .S %R=@%I X %XG(%FILE) s:DOK="" DOK=0  i firma="" s %mxWarng(%I)=" {1085}{1077}{1087}{1086}{1085}{1103}{1090}{1085}{1086} {1082}{1072}{1082}{1072}{1103} {1092}{1080}{1088}{1084}{1072} ?? " q
 .s dtNr=$p(%R,%B,8),ktNr=$p(%R,%B,9) i dtNr!ktNr n DOK s DOK=$s(dtNr&ktNr&sD:dtNr_"/"_ktNr,dtNr&ktNr&sK:ktNr_"/"_dtNr,dtNr:dtNr,1:ktNr)
 .i $d(%Filtr(%FILE)) s %f=0 x %Filtr(%FILE) q:'%f
 .s:'K K=9999 i DOK[" " s DOK=$tr(DOK," ") s:'$l(DOK) DOK=0 
 .;; i -K[-52 s ^k52(DOK)=%I
 .s DOKf=DOK,Piez=piez,AvNor=$p($p(piez,"#",2)," "),fir=firma
 .s:OfirO=fir firma=OfirmaO i AvNor?4n,AvNor+1=$e(d8,1,4) s AvNor=AvNor+1
 .s:OfirO'=fir!(fir>99) T=0,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma
 .i $g(xT),T-xT q
 .s atb=0 i T s atb=T
 .i T,'AvNor,-K[-238 d
 .. s o=$o(^oToAvNor(%USID,T,d8-.1)) i $e(o,1,6)=$e(d8,1,6) s AvNor=^(o) q
 .. ;; s o=$o(^oToAvNor(%USID,T,d8)) i ($e(o,1,6)-1)=$e(d8,1,6) s AvNor=^(o) q
 .. s o=$o(^oToAvNor(%USID,T,d8+.1),-1) i $e(o,1,6)=$e(d8,1,6) s AvNor=^(o) q
 .. s:'AvNor AvNor=-T
 .i AvNor,d8<%oldDate s AvNor=$e(d8,1,4)
 .i $g(xatb),xatb-atb s:AvNor=$g(xAvNor)&(piez["#")&T&atb %mxWarng(%I2)=AvNor_" -- r{275}{311}ina numurs kas attiec{299}b{257} uz citu personu !! "_T_%B_$$Fi^ZFIO(T) q
 .i $l($p(" "_piez," p",2)) s o=$p($p(" "_piez," p",2)," ") s:o DOKf=o i 'o,$e(piez)="p" d 
 .. i $l($tr($e(piez,2,9),"1234567890"_piez,"1234567890"))>4 s DOKf=o
 .s:$p(piez,"-")?6n DOKf=$p(piez,"-")
 .i " . 0 - -- "'[DOKfin s DOKf=DOKfin
 .I xDOK_xf'="" q:$$q
 .s ss=sD+sK_" "_sD_" "_sK
 .i %FILE'["Kas"!('$g(flagBT)&(-xC'[-56)) q:1_$$koko^fin(ss)
 .s %iKasp="^Kasp("_$p(%I,"(",2,9) i '$d(@%iKasp) q:1_$$koko^fin(ss) 
 .s nn="" f  s nn=$o(@%iKasp@(nn)) q:nn=""  d
 ..s %R=^(nn),%I2=%iKasp x %XG("Kasp") s DOKf=nn,piez=Piez_"."_p,T=0 s:fir2 fir=fir2
 ..I fir2,$d(^pers(fir2))!$d(^persArhi(fir2)) s T=fir2
 ..s %=+$p(%R,"d=",2) i %?8n n d s d=%
 ..i $$koko^fin(s)
 q:$d(%tSelect)  k %Filtr(%FILE)
 Q
KasOrNum(%i) 
 i '%i,%i["^",%i[")" s %i=$name(@%i)
 n s,d,bak,n,num,dok,%I i '%i,%i["^",%i[")",'$d(@%i) q %XD82
 f %1="Kase","Firma" d:'$g(%XI(%1)) ^USX
 n @($tr(%LG("Kase"),"~")) s dok=""
 i '%i s %R=@%i,%I=%i x %XG("Kase"),%XI("Kase") s s="sD" s:sK s="sK" s b=bak
 i %i s b=%i,DOK=-1,%I="^Kase($e(%XD82,1,4)*10000)",s="sD",d=%XD82
 s %I="^Kase(d\10000*10000)",num=1
 F  S %I=$q(@%I) Q:%I=""  q:%I=%i  S %R=@%I X %XI("Kase"),%XG("Kase") d
 .q:bak-b  q:'@s  q:DOK=dok  s num=num+1,dok=DOK
 q num
Saiz7 
Saiz d %I0
Saiz7V 
SaizV n T,Tatb,Tfir,NN,atb,AvNor,a,nos,fir,firma,DOK,err,q,s,c,kNN,piez,d,d8,ob,m,nol 
 s d8KoFiDo=$g(d8KoFiDo,0) i d8KoFiDo'["-" s d8KoFiDo=0 s:%gm>201400 d8KoFiDo=20131231 
 s sD=" ",(Sreab,Sreap,nol,da)=0,(OfirO,OfirmaO,NN)="",xNN=$g(xNN),xNol=$g(xNol)
 d %I0 f %1="Saisp","Firma" d ^USX
 I $d(%tSelect) s %I="" d  q
 .f  s (%I2,%I)=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) d SaizS s (OfirO,OfirmaO)=""
 s %I="^"_%FILE s:$g(d8KoFiDo) %I=%I_"(d8KoFiDo+.1)" s:$g(xd8start)?8n %I="^"_%FILE_"("_xd8start_")"
 i $g(%d8start(%FILE))>$g(d8KoFiDo) s %I="^"_%FILE_"("_%d8start(%FILE)_")" k %d8start(%FILE) 
SaizS d:$d(%tSelect)  i '$d(%tSelect) f  s (%I2,%I)=$q(@%I) q:%I=""  d  q:'$d(%I)
 .S %R=@%I,q=0
 .I $d(%Filtr(%FILE)) s %f=0 x %Filtr(%FILE) q:'%f
 .s DOKfin=0,err="" X %XI(%FILE),%XG(%FILE) s:DOKf[" " DOKf=$tr(DOKf," ") s:$l(DOKfin)>1 DOKf=DOKfin
 .s ob=$p(nol,".",2) s:%R["ob=" ob=$p($p($p(%R,"ob=",2),%B)," ") i q,c,+$j(q*c,0,2)'=(sD+sK) s err="q*cena="_(q*c)_" ,  bet summa="_(sD+sK)_"  "_%I
 .i $l(NN) s nos=$$nos^tirgus(NN),nol=nol\1 s:'nol nol=1 s:-kNN[-7&(nol<9) nol=kNN i $g(xNol),xNol-nol q
 .i $l(NN),$l(xNN),NN'=xNN q:xNN'[":"  q:NN'[xNN
 .s d8=d,s=sK q:+d'?8n  s:$g(flagd8mM) (d8,d)=$$d8mM^fin(.d8,.%I) i d8>%XD82,'$d(%tSelect) k:'$g(flagd8mM) %I q
 .s (nos,m)=0 i $l(NN) s nos=$$nos^tirgus(NN,%XD82) ;; q:$e(d8,1,6)<mnosMNd
 .i xC,$g(gramatos)<0 s %=$g(^gramatos(d8,%I)) i $l(%) q:$p(%,%B,2)'[+xC
 .s a=atb,Piez=piez,fir=firma,konts=K,AvNor=DOK,KODS=0 s:'K K=9999
 .s:OfirO=fir firma=OfirmaO s (Tatb,Tfir)=0 i fir,$d(^pers(fir))!$d(^persArhi(fir)) s Tfir=+fir
 .s:OfirO'=fir!(fir>99) T=0,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma
 .q:$$q
 .s atb=a s:a<0 a=-a
 .i a,$d(^pers(a))!$d(^persArhi(a)) s (T,atb,Tatb)=a i AvNor s ^oToAvNor(%USID,T,d8)=AvNor s:d8<%oldDate AvNor=$e(d8,1,4)_-T_-K
 .s:-xC'[-238&Tfir T=Tfir i $g(xatb),xatb-atb q
 .I sK["--",sK s k1=$$vk^fin($p(sK,"--"),d8),k2=$$vk^fin($p(sK,"--",2),d8) i k1,k2,k2*k1-1 d
 ..i sK'["p" s piez=piez_" ("_$p(sK,"--")_")",sK=$j(sK*k1/k2,0,2)_" "_$p(k2,+k2,2) q
 ..s sK=$j(sK*k1/k2,0,2)_"p"_$j($p(sK,"p",2)*k1/k2,0,2)_" "_$p(k2,+k2,2)
 .I %I'["Saiz7" s ss=sD+sK_" "_sD_" "_sK,k2=0
 .e  s ss=sD+sK_" "_sD_" "_sK_" "_c,k2=0
 .i $d(%V(%V,"w1")) q:$l(NN)<2  s o=$$koko^tirgus(ss) q
 .i $$koko^fin(ss)
 k %Filtr(%FILE)
 Q
%I0 
 f %1="pers" d ^USX
 S (C,DOK,DI,piez)=0,%B=$c(254),atb=$g(%FILE,0)
 s (sd,sk,sd0,sk0,sd0v,sk0v,skv,sdv,firma)=0
 s AvNor=0,fir2="",firma2="",%I="^"_%FILE
 q
%vv g @%V
xAvNor 
xAtbNor q
an1 ;\avNor\-atb,AvNor,-d8,dn\sd0(),sk0(),sd(),sk()=firma,piez,kurs,%I,%I2,DOKf\-%ggmm\Saiz Saiz7 alg Banka Kase ciko\@\
 ;\\\\\\s (iii,k1)=0 k avT,d8aMax,s0d8,kagC,a,ss0,ss4,AvNor0,^SaizI(%USID),^oasd,^oask,^oMX(%USID)
 q:d8'?8n  q:'xAvNor  q:'atb  q:$l(AvNor)<2  n vbakStop s vbakStop=1
 s atbKODS=KODS,dn=DOK_"."_n s:d8>20180000&'$d(avT(AvNor,atb))!$g(%test) avT(AvNor,atb)=%I ;;  i -$g(bak)[-238 s:$g(k238)'[bak k238=$g(k238)_%B_bak
 i AvNor=xAvNor d  i piez["#" s o=piez n piez s piez=$p(o,"#"_AvNor)
 .i xatb-atb s %mxWarng(%I2)=AvNor_" -- avansa r{275}{311}ina numurs kas attiec{299}b{257} uz citu personu !! "_atb_%B_$p($g(^pers(atb)),%B,2)
 i AvNor'=xAvNor q:atb-xatb  i $d(HideRees) s:d8<d8Saiz ^o(%USID,"ss0",%I2)=d8 q
 i d8<%XD81,AvNor=xAvNor,$d(HideRees) n %XD81 s %XD81=d8
 g dkk^fin
 q
an1L q:xAvNor'=AvNor
 i %E="dn" m ^oasd(d8,dn)=sd,^oask(d8,dn)=sk d  q
 .  s a(d8,dn)=firma_" : "_piez_" : "_DOKf_"<mx @"_%I
 .  s:firma=%FIRMA a(d8,dn)=piez_" : "_DOKf_"<mx @"_%I
 .  s ^SaizI(%USID,%I)=1
 q:%E'="AvNor"  q:'$d(^oasd)&'$d(^oask)
 s ss0=0,s2=0,s3=0,sd=0,sk=0,PVN=5721,PVN=":"_PVN
 s k="" f  s k=$o(sd(k)) q:k=""  i -k[-xC d
 .  s ss0=$$sv^fin("ss0++sd0(k)++-sk0(k)",2)
 .  s sd=$$sv^fin("sd++sd(k)"),sk=$$sv^fin("sk++sk(k)")
 s ss2=sd,ss3=sk,ss4=ss0+ss2-ss3,ss4v=$$sv^fin("ss2++-ss3","ss4v")
 s AvNo=AvNor
 s %XD81an=+$g(^dAvNor(xatb,xAvNor),%XD81)
 s %XD82an=+$p($g(^dAvNor(xatb,xAvNor),-%XD82),"-",2)
 s (k,d8,dn)=""
 f  s d8=$o(^oasd(d8)) q:'d8  f  s dn=$o(^oasd(d8,dn)) q:dn=""  d
 .f  s k=$o(^oasd(d8,dn,k)) q:k=""  d:-k[-xC
 ..s kk=$p(k,":",2),fp=$g(a(d8,dn)),s=^oasd(d8,dn,k),%I2=$p(fp,"<mx @",2) q:fp=""
 ..s svp=$$svp^fin(s),svp=$p(svp," ",2,9)
 ..q:'s
 ..q:xxatb>1  s:'svp svp=$p(fp," : ",3),fp=$p(fp," : ",1,2)
 ..i $$l("d8 dn fp kk s.__ svp kurs %I2 DOKf")
 ..s iii=iii+1,z=1 m ^oMX(%USID,"AvNor",z,iii)=lUST
 s (k,d8,dn)="" k pvn s nDOK=0
 f  s d8=$o(^oask(d8)) q:'d8  f  s dn=$o(^oask(d8,dn)) q:dn=""  d
 .f  s k=$o(^oask(d8,dn,k)) q:k=""  d:-k[-xC
 ..i k[PVN!(k[":xx239") s pvn(d8,dn)=^oask(d8,dn,k)_"  "_k q
 s (k,d8,dn)=""
 f  s d8=$o(^oask(d8)) q:'d8  f  s dn=$o(^oask(d8,dn)) q:dn=""  d
 .f  s k=$o(^oask(d8,dn,k)) q:k=""  d:-k[-xC
 ..i k[PVN!(k[":xx239") q
 ..s kk=$p(k,":",2),fp=$g(a(d8,dn)),s=^oask(d8,dn,k),svp=$$svp^fin(s) q:'s  q:fp=""
 ..s %I2=$p(fp,"<mx @",2)
 ..i k["PVN" s fp=" "
 ..q:xxatb>1  s d2=d8,dn2=dn,kk2=kk,svp2=$p(svp," ",2,9),fp2=fp,s2=s
 ..s pvn=$g(pvn(d8,dn)),sum=s2+pvn,nDOK=nDOK+1 k pvn(d8,dn)
 ..s:'svp2 svp2=$p(fp," : ",3),fp2=$p(fp2," : ",1,2)
 ..i fp2["--" s k1=$$vk^fin($p(fp2,"--"),+d8) i k1,k1-1 s v1=$p(k1,+k1,2),sv1(v1)=$g(sv1(v1))+111
 ..i $$l("d2 dn2 fp2 kk2 s2.__ svp2 pvn sum kurs %I2 DOKf")
 ..s iii=iii+1,z=2 m ^oMX(%USID,"AvNor",z,iii)=lUST
 s d8=0,dn=""
 f  s d8=$o(pvn(d8)) q:'d8  f  s dn=$o(pvn(d8,dn)) q:dn=""  d
 .s d2=d8,dn2=dn,kk2="",fp2=pvn(d8,dn),s2=0,svp2="",sum=+fp2,pvn=+fp2
 .s fp2=$g(a(d8,dn),fp2)
 .i $$l("d2 dn2 fp2 kk2 s2.__ svp2 pvn sum kurs %I2 DOKf")
 .s iii=iii+1,z=2 m ^oMX(%USID,"AvNor",z,iii)=lUST
 s (ssd,ssk)=0
 s (k)="" f  s k=$o(sd(k)) q:k=""  d:-k[-xC
 .s kkd=$p(k,":",2),sd=sd(k),td=$$konti^fin(+kkd)
 .s svpd=$p($$svp^fin(sd)," ",2,99) q:'sd
 .i $$l(" td   kkd   sd.__ svpd  DOKf")
 .s iii=iii+1,z=3 m ^oMX(%USID,"AvNor",z,iii)=lUST
 .s ssd=$$sv^fin("ssd++sd",2)
 s (k)="" f  s k=$o(sk(k)) q:k=""  d:-k[-xC
 .s kkk=$p(k,":",2),sk=sk(k),tk=$$konti^fin(+kkk)
 .s svpk=$p($$svp^fin(sk)," ",2,99) q:'sk
 .i $$l(" tk kkk sk.__ svpk kurs %I2 DOKf")
 .s iii=iii+1,z=4 m ^oMX(%USID,"AvNor",z,iii)=lUST
 .s ssk=$$sv^fin("ssk++sk",2)
 k a,ss m ss=ssd,ss=ssk,ss=s0 s ss(1)="Ls " s:%gm>201400 ss(1)="euro "
 s (t,tv)="*"
 i $$l("t ssd.__ ssk.__")
 s v=1 f  s v=$o(ss(v)) q:v=""  d
 . s ssdv=$g(ssd(v)),sskv=$g(ssk(v)),tv="t.sk."_v
 .i $$l("tv ssdv.__ sskv.__")
 s v=0 f vv=0:1 s v=$o(ss4v(v)) q:v=""
 s v=0 f  s v=$o(ss4v(v)) q:v=""  d
 . i v=1
 . s ss0v=$g(ss0(v)),ss4v=ss4v(v),sdv=ss2,skv=ss3 I v-1 s sdv=+$p(ss2,v,2),skv=+$p(ss3,v,2)
 . s kv=$$vk^fin(v,-%XD82an),sv=+ss4v i kv,kv-1 s sv=ss4v*kv
 . s kv=$s(kv-1:v_" "_+kv,1:xVAL_"*")
 . S v(v)=v i v=1 n v s sv=+ss4v,v="Ls*" s:%gm>201400 v="euro "
 . i '$d(ValKase) s %="" f  s %=$o(^konti(%)) q:%=""  s %1=$p(^(%),%B,4) I " -- "'[%1,-%[-261 s ValKase(%1)=%
 . S fo="" I vv<3,ss4v<0 S fo=v_" "_ss4v_"<mx @; s v=$p(o,"" ""),ss4v=$p(o,"" "",2),^Kase(%XD82an,$g(ValKase(v),2610),v)=%B_v_%B_aTb_%B_""~""_%B_-ss4v_v_%B_xC_%B_""~#""_xAvNor" S fo=fo_"  s oo=""<mx @""_$zr"
 . I vv>2 s fo=v_" "_ss4v_" <mx @; s %=$$SaizI^kas("""_v_""") "
 . i $$l("fo v kv s0v.__ sdv.__ skv.__ ss4v.__ sv.__ kurs %I2  DOKf")
 . s iii=iii+1,z=5 m ^oMX(%USID,"AvNor",z,iii)=lUST
 s v1=1 f  s v1=$o(sv1(v1)) q:v1=""  d
 . i $$l("v1 sv1(v1)")
 . s iii=iii+1,z=6 m ^oMX(%USID,"AvNor",z,iii)=lUST
 q
SaizI(v) n %R,%I,s,k,d8,III s %I="",III=""
 f  s %I=$o(^SaizI(%USID,%I)) q:%I=""  I %I["^Saiz(" d
 .s %R=@%I,s=$p(%R,%B,7),d8=$qs(%I,1) q:s[("--"_v)
 .s k=$$vk^fin(s,d8) q:k[v
 .s:s $p(s,"--",2)=v,$p(%R,%B,7)=s,@%I=%R,III=III_%I
 q III
k(k0,ns) n k,ss,%
 s k="" f  s k=$o(sd(k)) q:k=""  i -k[-k0 s ss(ns)=$g(ss(ns))+@(ns)@(k)
 q $g(ss(ns))
kagC q
kxC(k,xC) i k,k=$p(xC," ") q 1
 i xC[".."!(xC["*"),xC,-k[-xC q 1
 q 0
atl g atl^fin
oov ;\\\\\\s iii=0 k ^oMX(%USID,"oov") k sd,sk,sd0,sk0
 i $l($g(oov)) s flagSTOP=0 x oov q:flagSTOP
 g dk^fin
oovL q:'$l($g(oovL))  i 1_$$l^UST(oovL_" %E %M ")
 s iii=iii+1 m ^oMX(%USID,"oov",iii)=lUST
 f o="sd0","sk0","sd","sk" i $d(@o)>2 m ^oMX(%USID,"oov",iii,o)=@o k @o 
 k %d8start
 q
l(%lN) q $$l^UST(%lN)

pam
ATGpam ; ATG.pamatlidz. ; [ 02/16/2007  5:29 PM ]  ;[ 20191010 21:51:26 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2019
 q
w i xmsm'="" x "s %="_xmsm q:'%
 i Ch="" s %mxWarng(INV)="pam.w :: ERROR :: Inv.Nr="_INV_" cehs=???  vai nepareizi datumi "_%I q
 x %XV(%V) i $g(%flagVom) s:$l($g(formulaL))<9 formulaL="i $$m^MXF()" x formulaL
 q
%I0 S %I="^"_%FILE,(firma,fir,DOK,DOKf)=0,%I2=""
start q
pm(INV,%gm,i) 
 k ^pm,^opm(%USID)
 n xmsm,XN,xVe,XN
 s (XN,XN(INV))=INV,xVe="",xmsm=1 k:$d(i) @i
 n d,ZA,piez,Ch,S0,ASTART,NoAm,KoAm,D1,SOST,NAME,Ve
 d INV($g(flagBEZp))
 i $d(i) q:$d(@i) @i q:'$d(@i) "..?"
 s m=0 f  s m=$o(sN(m)) q:m=""  d
 .s %=+$p(sN(m),"s",2),r=%B_%_%B
 .s r=r_+sN(m)_%B_$j(%-sN(m),0,2)_%B_+$j($p(sN(m),"a",2),0,4)_%B
 .s r=r_$g(r("NoAm",m))
 .s ^pm(m)=r_%B_$g(r("piez",m))
 .s ^opm(%USID,m)=r_%B_$g(r("piez",m))
 q "" 
pmk 
 n INV,DOKf,firma,m,nf
 s (DOKf,firma,m)=0,nf=""
 f  s nf=$o(^pmk(nf)) q:nf=""  f  s m=$o(^pmk(nf,m)) q:m=""  s %I=$NAME(^(m)),INV=nf d @%V
 q
%vv g @%V
pamk d %I0^fin,%I0^pam,pamkV^pam q
pamkV  ; i %FIRMA["LAG{362}MA" s mxConfig=":pam:e:"_mxConfig i $g(^mxConfig(1,"mxConfig",1,1))'["pam:e" s ^(1)=%B_":pam:e"
 s %1="pam" d ^USX i $$icFIRMA^fir
 s o=xVw n xVw s xVw=o_"  d DKsave",flMazCen=$g(flMazCen)
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) s INV=$qs(%I,1) d pamS
pamS d:$d(%tSelect)  i '$d(%tSelect) s INV="" f  s INV=$o(^pam(INV)) q:INV=""  d
 .s %R=$tr(^pam(INV),$c(10),"^"),(%I,%I2)=$NAME(^(INV)) x %XG("pam"),%XI("pam")
 .i $g(flMazCen) q:Ve["mc"&(flMazCen-1)  q:Ve'["mc"&(flMazCen-2)
 .s %=$$pm^pam(INV,%gm),%kokoNum=0
 .Q:'$o(sN(%gm+1),-1)
 .s fir="%FIRMA",firma=%FIRMA
 .n m,m1 s m=0,m1=0 f  s m=$o(sN(m)) q:'m  q:m\1>%gm  d  s m1=m q:'s0
 ..s (d,d8)=$e(m,1,6)_"01" s:m?8n (d,d8)=m   i %gm>201400,m_11<$g(d8KoFiDo) n xVw s xVw=""
 ..s s1=$g(sN(m1)),s=sN(m),s0=$p(sN(m),"s",2),(DOKf,DOK)=m_" Inv.Nr:"_+$e(INV+100000,2,9)
 ..s s0p=$p($g(sN(m1)),"s",2),sOSTp=s0p-s1
 ..n KoAm,ZA,S0 f o="KoAm","ZA","S0" s %=$o(pam(o,m+.00001),-1),@o=pam(o,%)
 ..i $d(dkINV(m)) s DK="" f  s DK=$o(dkINV(m,DK)) q:DK=""  s S=dkINV(m,DK) x xVw  ;; 20070910
 ..s (am,S)=$p(sN(m),"a",2)
 ..s DK=7420_-1290 i '$p(KoAm,"-",2) s:KoAm\1?4n!(KoAm\1?6n) $p(DK,"-",2)=$p($p(KoAm,"-")," ")
 ..i KoAm[-7 s DK=$p($p(KoAm,"-",2)," ")_"-"_$p($p(KoAm,"-")," ")
 ..i S,KoAm'[",",DK\1?4n!(DK\1?6n),$p(DK,"-",2)\1?4n!($p(DK,"-",2)\1?6n) x xVw  ;  amortiz
 ..i S,KoAm["," n pp,SS,p,ss,x,DK2 s pp=0,SS=S,ss=0,DK2=$p(DK,"-",2) n S f x=1:1:$l(KoAm,",") s DK=$p(KoAm,",",x) d:DK
 ...  s p=$p(DK,":",2),DK=$p(DK,":") s:$p(DK,"-",2) DK2=$p(DK,"-",2) s $p(DK,"-",2)=DK2
 ...  q:DK\1'?4n&(DK\1'?6n)  q:$p(DK,"-",2)\1'?4n&($p(DK,"-",2)\1'?6n)
 ...  s S=$j(SS*p/100,0,2),pp=pp+p,ss=ss+S x:S xVw q:$p(KoAm,",",x+1)
 ...  s S=$j(SS-ss,0,2) x:S xVw 
 ..i ZA\1'?4n,ZA\1'?6n n ZA s ZA=1230
 ..;; s:sN(m)["dzes" s0=0
 ..;; i 's0,m>200411,$g(mxConfig)["pam:BLG" s o=m+1 s:o#100=13 o=o+88 s (d,d8)=o_16 q:d>%XD82
 ..i 's0,sOSTp-am'>0,KoAm\1?4n!(KoAm\1?6n) s S=s0p,DK=$p($p(KoAm,"-")," ")_"-"_$p($p(ZA,"-")," ") x xVw d:'S
 ... i m=$e(D1,1,6) s S=S0 x xVw
 ..   ;  norakst, kad nav atl.vert
 ..i 's0,sOSTp-am>0 s S=sOSTp-am,DK="8291-"_$p($p(ZA,"-")," ") d   x xVw
 ...  i $p(S0,"D",2)\1?4n!($p(S0,"D",2)\1?6n) s $p(DK,"-")=$p($p($p(S0,"D",2),"-")," ")
 ...  i $p(S0,"K",2)\1?4n!($p(S0,"K",2)\1?6n) s $p(DK,"-",2)=$p($p($p(S0,"K",2),"-")," ")
 ..   ;  norakst, atlik v{275}rt
 ..i 's0,sOSTp-am>0,KoAm\1?4n!(KoAm\1?6n) s S=s1+am,DK=$p($p(KoAm,"-")," ")_"-"_$p($p(ZA,"-")," ") x xVw
 ..   ;  noraks, uzkr nolietojums
 ..s S=s0-s0p
 k r,S0,SIZN,nf,NOF,s0,sN,am,DKm,dkINV
 q
DKsave q:$g(gramatos)'>0  q:S*S<.000001  n % 
 i $d(%tSelect),d8<%XD81 q
 i '$d(^gramatos(d8,%I)) s ^(%I)=%B_DK_%B_S q
 s %=^(%I),^(%I)=%B_$p(%,%B,2)_"^"_DK_%B_$p(%,%B,3)_"^"_S
 q
pam d %I0^pam
pamV n r,s0,s00,sN,pam n @($tr(%LI("pam"),"~")) 
 D %I0 S INV="",N=1,XN=$g(XN),%I="^pam"
 F  S INV=$o(^pam(INV)) Q:INV=""  d
 .d INV($g(flagBEZp)) q:'$D(sN)
 .i $g(flMazCen) q:Ve["mc"&(flMazCen-1)  q:Ve'["mc"&(flMazCen-2)
 .i xCh'=""," "_xCh_" "'[(" "_Ch_" ") q
 .i xVe'=""," "_xVe_" "'[(" "_Ve_" ") q
 .i $g(xAtb)'="",ATB'=xAtb q
 .x xVw
 k r,S0,SIZN,nf,NOF,s0,sN,am,DKm,dkINV
 Q
INV(flagBEZp) 
 q:'$g(INV)  n muv,%RR,m,m1,rr,ff,newAmLs,amKoefS2,atlmNoAm,gm0,aam,k7,o,AST,kEUR
 k r,S0,SIZN,nf,NOF,s0,sN,am,DKm,dkINV,S0minus,s22,pam
 s (%RR,am,m,m1,amP,amg,D3,AM,kp,dp,pS,SOST,SIZN,N1,S0minus)=0 s:'$d(ff) ff=^AL("pam","%LG")
 s muv=" ",%R=$tr(^pam(INV),$c(10),"^"),%I=$zr
 x %XG("pam") s:'S0 $p(S0,"^")=.000001 s:$g(flagBEZp)>111111 $p(d,"^")=$e(flagBEZp,1,6) k flagBEZp
 i d>%gm s S0=0 q
 s s00=S0 k pam i %gm>201400,$e(d,1,6)<201400 s ASTART=ASTART/.702804_"_"_ASTART
 f xm=1:1 s m=$p(d,"^",xm) q:'m  d
 .i m<0 s m=-m i $p(S0,"^",xm) s $p(S0,"^",xm)=0_" "_$p(S0,"^",xm)
 .s gm=$e(m,1,6),kEUR=1 q:gm>%gm  i gm<201400&(%gm>201400) s kEUR=.702804 d
 ..  s o=$p(S0,"^",xm) s:$p(o,"-",2) $p(o,"-",2)=$p(o,"-",2)/.702804_"_"_$p(o,"-",2,99)
 ..  s:o $p(S0,"^",xm)=o/.702804_"_"_o,s00=S0
 ..  q
 .i $e(m1,1,6)=gm f x=2:1 s n=$p(ff,",",x) q:n=""  i "piez S0"[n s %=$p(@n,"^",xm) i r(n,gm)'=% s $p(@n,"^",xm)=r(n,gm)_":|:"_%
 .i '$d(gm0) s D1m=gm,sN=+ASTART,rD=gm,gm0=gm
 .f x=2:1 s n=$p(ff,",",x) q:n=""  d
 .. s (r,r(n,gm),pam(n,gm))=$p(@n,"^",xm)
 .. i n="S0" s:$p(r,"~",2)&'r (r,r(n,gm))=$p(r(n,gm0),"~")_"  ~"_($p(r,"~",2)/kEUR) s:r<.01&(r>0) (r,r(n,gm))=.0001_" "_r i $g(flagBEZp),r["p" s (r,r(n,gm),pam(n,gm))=""
 .. s:gm=gm0 r(n,0)=r
 .. i n="ASTART","+-"[$e(r_1) s (r,r(n,gm))=+r(n,gm0)_" +"_+r_" "_r
 .. i n="NAME","+,"[$e(r_1) s (r,r(n,gm))=r(n,gm0)_r
 .. i n="piez",$l(r)<2 s r(n,gm)=" ",r="*"
 .. i $tr(r,"- ./,:;")="" d
 ...  s r(n,gm)=$g(r(n,gm0)) k:xm>1 pam(n,gm) i n="S0" s r(n,gm)=$tr(r(n,gm),"~p","  ")
 ...  s:n="ASTART" r(n,gm)=+r(n,gm)
 .s:$e(m,1,6)<$e($p(d,"^",xm+1),1,6) gm0=$e(m,1,6) s m1=m
 f x=2:1 s n=$p(ff,",",x) q:n=""  s @n=$g(r(n,0))
 i 'd s %ACT=0 q
 k s22i s m0=0,m1=0,s22i=0,S0i=S0,amortmen=0,AST=0 s:D1m>201000 AST=ASTART
 i AST,NoAm,NoAm'["Ls",NoAm'["EUR" s amortmen=AST/(NoAm*S0/1200)\1-1_"AST" s:amortmen<0 amortmen=0
 f m=D1m:1:%gm s:m#100=13 m=m+88 d  q:'m  q:$e(D3,1,6)=m  s m0=m,am1111=am s:m<201100 am1111=0
 .s m1=+$o(r("d",m),-1) i m>%gm s m=0 q
 .s (pS0,flagam,plusSOST,s22a)=0,amortmen=amortmen+1,kEURO=1 s:m<201400&(%gm>201400) kEUR=.702804
 .i $d(r("d",m)) d  Q:'m
 .. f x=2:1 s n=$p(ff,",",x) q:n=""  s @n=$g(r(n,m))
 .. s n=r("NoAm",m) s:n["Ls"!(n["EUR") am(m)=n/kEUR s:n="0" ($p(NoAm,"/"),am(m))="0.000001"
 .. i n s:n["g" ($p(r("NoAm",m),"/"),$p(NoAm,"/"))=$j(100/n,0,4) s:n["m" ($p(r("NoAm",m),"/"),$p(NoAm,"/"))=$j(100/n*12,0,4)
 .. s n=r("KoAm",m) i n_11["e11",mxConfig["pam:e" s (Koam,r("KoAm",m))=r("KoAm",m)_"/"
 .. s s22a=$p($g(r("S0",m)),"~",2)/kEUR i s22a,'r("S0",m) s (S0,r("S0",m))=$p(r("S0",m1),"~")_" .~"_s22a
 .. i S0["dz"!'S0 s D3=m,(r("S0",m),S0,S0i)=r("S0",m1) q
 .. i S0["-" i mxConfig["S0minus",$p(mxConfig,"S0minus=",2)>m s S0minus=+$p(S0,"-",2)
 .. s S0i=S0 i s22a s plusSOST=$j(s22a/S0*(sN(m0)+$$am(m,sN,S0)),0,2) s am(m)=$$am(m,sN,S0)  ;; ~ 
 .. i s22a s s22i=s22i+plusSOST,S0i=S0+s22i,s22i(m,"-")=s22a-plusSOST,s22i(m,"+")=s22a
 .. s ss=S0i-$j(r("S0",m1),0,2) i ss*ss>.01,S0'["~" d  s r("S0",m)=S0i-plusSOST_$s(m<200800:"",1:" . . "_r("S0",m))
 ...  i S0["p" s pS0=S0i-r("S0",m1)-$p(piez,"+",2)
 .. s am=$$am(m,sN,S0i,$s(m>200600:ss,1:0)),flagam=1 i plusSOST*plusSOST>.01 s am(m+1)=am,am=am(m) s:m#100=12 am(m+89)=am(m+1)
 .. i S0_" "["p0 " k am s (newAmLs,sN,sNp,SIZN)=0,SOST=S0 n:000 s22 s am=$$am(m,0,S0)  ;; parvert-0
 .. i ss>.01,m>201010,ss'>S0i s %=$p($g(sN(m0)),":a",2) s:'% %=$p($g(sN(m0)),"a",2) i %>0 s am=+%_":a"_+am  ;; 201101 balozi
 .i 'flagam,KoAm_NoAm["e/"!$d(am(m))!(mxConfig["pam:e"&(KoAm_NoAm["e"))!(m>200500) s am=$$am(m,sN,S0i)
 .i $d(aam(m)) s am=aam(m)
 .i plusSOST*plusSOST>.01 s %7=7420,k7=0,S0i=S0i-plusSOST s:KoAm[7421 %7=7421 d
 .. i $d(^mxNorma("AmAizIzm",%7)) s o=$o(^(%7,m_99),-1) i o,$g(^(o,"norValue")) s k7=@$zr
 .. s dkINV(m,$s($p(KoAm,"-")\1?4n:$p(KoAm,"-"),1:1290)_"-"_+ZA)=+plusSOST
 .. s dkINV(m,$p(%_"D"_$s(k7:k7,1:7550),"D",2)_"-"_+ZA)=s22a-plusSOST
 .i m=D1m n am s am=0
 .s:S0["~" S0i=S0,am=$s(am1111:am1111,1:am) s sN=sN+am-plusSOST i sN-.01>(S0i-S0minus),(S0i-S0minus)>-1,m-D1m s am=$$am(m,sN-am,S0i),sN=S0i-S0minus  ;; err -S0minus
 .i -m[-$e(%gm,1,4) s amg=amg+am
 .s sN(m)=+$j(sN,0,kEUR<1_2)_" s"_+$j(S0i,0,S0i<.001*9+(kEUR<1_2))_" a"_am s:s22a sN(m)=sN(m)_"~++"_s22a
 .s:plusSOST sN(m)=sN(m)_" --"_(s22a-plusSOST)
 .s s0=+$p(sN(m),"s",2) i s0>.01,m0 s %=$p($g(sN(m0)),"s",2)-s0 s:%>.01 $p(sN(m)," --",3)=% s:%<-1 $p(sN(m)," ++",3)=-% 
 .i pS0*pS0>.01 s sN(m)=sN(m)_" p"_pS0
 .i D3\1=m s sN(m)=sN(m)_" dzests ",amP=am,muv=" dzests "
 .i $g(atlmNoAm) s atlmNoAm=atlmNoAm-1
 .i AST,$g(atlmNoAm) s o=S0-sN-S0minus,%m=m+1 i o*o>.01 s:%m#100=13 %m=%m+88 s aam(%m)=o/atlmNoAm s:aam(%m)>o aam(%m)=o ;; Inga 20100725
 .s ^Opam(INV,m,"S0minus")=S0minus f o="atlmNoAm","newAmLs","atlmen","s22a","S0" s ^(o)=$g(@o)
 s am=+$p($g(sN(%gm)),"a",2),AM=$j(am,0,2),amg=+$j(amg,0,2),SIZN=$j($g(sN(%gm)),0,2)
 i S0i>-1 s:SIZN<.02 SIZN=0
 s S0p=S0i,SIZNp=SIZN s:muv["dzes" S0p=r("S0",m1)
 s %=$o(sN(%gm+1),-1) i % s SIZNp=$j($g(sN(%)),0,2)
 s:muv["dzes" S0i="0 "_S0i,SIZN=0 s SOST=S0i-SIZN,SOSTp=S0p-SIZNp
 i $g(sN(%gm))["dzes",'S0i,'SIZN s sN(%gm)="0sS"_+$p(sN(%gm),"s",2)_"a"_$p(sN(%gm),"a",2,99)
 i '$d(sN(%gm)) s %=$o(sN(%gm),-1) i % s sN(%)="0sS"_+$p(sN(%),"s",2)_"a"_$p(sN(%),"a",2,99)
 i S0i>-1 s:SOST<0 SOST=0 s:SOSTp<0 SOSTp=0
 i SOSTp s %=$o(sN(%gm),-1) i %,$g(sN(%))["dzes" s $p(sN(%)," --",2)=SOSTp
 s (N1,nos1)=$p(NAME,"\"),(N2,nos2)=$p(NAME,"\",2),N3=$p(NAME,"\",3)
 S CCh=Ch k ff i '$d(sN(%gm)) s (S0,S0i,SIZN,SOST,AM,am)=0
 q
am(m,sNp,S0,s22) 
 i m<201200,%FIRMA["COMPAQPEAT" q $$am^pam2008(m,$g(sNp),$g(S0),$g(s22))      ;; 20130419
 n S,%,o,am0,m0,flagExpo,flagParv s flagExpo=0,flagParv=0
 i $g(r("S0",m))["p" s flagParv=m
 i KoAm_NoAm["e",mxConfig["pam:e"!(KoAm_NoAm["e/") s flagExpo=1
 s %=+$p($g(r("S0",m)),"-",2) s:%-S0minus&% S0minus(m)=%,S0minus=%
 s S=S0-S0minus-$g(SIZN(0)),m0=+$o(r("NoAm",m),-1) k ^Opam(INV,m) s:NoAm["EUR" NoAm=NoAm_" Ls"
 s o=NoAm*S/1200 i o,NoAm'["Ls" s:'$d(atlmNoAm) atlmNoAm=S+1-AST/o\1+(m>200800) i m0,r("NoAm",m0)-NoAm s atlmNoAm=S+1-AST/o\1-amortmen+1+(m>200800)  
 i %,S0,S>sNp,S0>S,$o(S0minus(1))>$e(D1,1,6) s amKoefS2=(S0-S0minus-sNp/(S0-sNp))*(S0/S) s:m<200800 amKoefS2=S/S0
 i flagExpo,NoAm n mm,k s mm=100/NoAm*12,k=S/(1+mm*mm/2) d  q am
 . n o,n,m1 s o="" f n=0:1 s o=$o(sN(o)) q:'o  q:o=m  i o>m s n=n-1 q
 . s am=0,m1=$o(sN(m),-1) i n s am=mm-n+1*k s:am<0 am=0 f o="mm","am","k" s ^Opam(INV,m,o)=@o
 . i m1,$g(sN(m1))+am>S s am=S-$g(sN(m1)) s:am<0 am=0
 ;i KoAm_NoAm["e/" s %=m-1 s:%#100=0 %=%-88 n S s S=$p($g(sN(%)),"s",2)-$g(sN(%)),eS(m)=S
 n a s a=NoAm*(S-$g(s22))/1200 s:NoAm["Ls" a=NoAm/kEUR s:$p(NoAm,"a",2) am=$p(NoAm,"a",2)*NoAm/1200
 s:$g(newAmLs) a=+newAmLs_"-newAmLs  "
 i a,m0,$g(s22),'$p(NoAm,"a",2) s atlmen=S0-s22-sNp/a i atlmen>.9 s newAmLs=S0-sNp/atlmen_" S0="_S0_" sNp="_sNp_" a="_+a_" atlmen="_atlmen s:newAmLs<1 newAmLs=0
 s (am,am0)=NoAm*S/1200 i '$d(limNewAm) s limNewAm=+$p(mxConfig,":limNewAm=",2) s:'limNewAm limNewAm=1 
 i m<200800 i $g(newAmLs) s am=newAmLs s:$g(amKoefS2) am=am*amKoefS2 
 i m>200800,am s:$g(newAmLs) am=newAmLs s:$g(amKoefS2) am=am*amKoefS2 
 i m>200800,m0,r("NoAm",m0)-NoAm!(r("S0",m0)-S0),$g(atlmNoAm) s o=S-sNp/atlmNoAm s:o>limNewAm (newAmLs,am)=o_"a"
 i m>200800,m0,S0minus,$g(atlmNoAm),$o(S0minus(1))>$e(D1,1,6) s o=S-sNp/atlmNoAm s:o>limNewAm (am,newAmLs)=o_"a"
 i flagExpo s:NoAm'["Ls" am=NoAm*S*4/1200 s:am<(.001*$p($g(sN(%)),"s",2)) am=S q am
 ;i KoAm["e/" s %=S0-$g(sN(%))-am i %<(.1*S0)&(%<50) s am=%+am s:am<0 am=0
 s:NoAm["Ls" am=NoAm/kEUR s:$p(NoAm,"a",2) am=$p(NoAm,"a",2)/kEUR*NoAm/1200
 s:m>200500 am=$j(am,0,2)
 s %=am+sNp-S i %>0,'flagExpo s am=am-%
 i m>200600,%<0,%>-1 s am=am-%
 s:am<0 am=0 s atlmen=$j($g(atlmen),0,1),newAmLs=$j($g(newAmLs),0,2) s:newAmLs<.01 newAmLs=0
 s ^Opam(INV,m,"am")=am f o="amortmen","m","flagParv" s ^(o)=$g(@o)
 f o="atlmNoAm","newAmLs","atlmen","s22","am0","amKoefS2","S0minus","S0","sNp","S" s ^(o)=$g(@o)
 q am
%nff(m) q $$%nf(m)
%nf(m) n n,%,k,k0 s %=+$o(r("NoAm",m+1),-1),n=$g(r("NoAm",%)),n=+$p(n,"/",2),%=0
 q:m<199512!'n "0-00%"
 s k0=$s('n:"0-00%",n<6:"1-5%",n<15:"2-10%",n<25:"4-20%",n<40:"3-35%",1:9_-n_"%")
 s k=$e(%XD82,5,6)/12 s:$e(%XD81,1,6)=%gm k=1
 s %=$o(^mxConfig(1,"firma","ggggMMdd",19000000)) i %?8n d  i $e(%,1,4)=$e(m,1,4) s k=13-($e(%,1,6)#100)/12
 . i m_33<% s %mxWarng(INV)=m_" -- datums maz{257}k nek{257} Uz{326}{275}muma darb{299}bas s{257}kuma datums !! "_$g(N1)
 q:k'<.99 k0
 q $p(k0,"-")_"-"_+$j($p(k0,"-",2)*k,0,4)_"%"
A1 ;\Pamatlidz saraksts\Ch,Ve,INV\S0,SOST,SIZN,AM,amg=Y0,ZA,KoAm,ATB,NoAm,D1,nff,N1,%I\\pam\ s iii=0 k ^oMX(%USID,%V)
 s nff=$$%nf(%gm) i D3,$e(D3,1,6)<$e(%XD81,1,6) q
 g w
A1L s nos=N1
 i $$l("Ch INV Ve Y0 D1 NoAm KoAm S0.__ SIZN.__ SOST.__ AM.__ amg.__ ATB nff nos piez %I")
 s:Ch="*" Ch=%B_" *** "
 s iii=iii+1 m ^oMX(%USID,%V,Ch,iii)=lUST
 q 
FinGr ;\PL noliet.finansu gramatv.\Ve,INV\S0,SOST,SIZN,AM,amg=ATB,Y0,ZA,KoAm,NoAm,D1,N1\cnn-r\pam\s iii=0 k ^oMX(%USID,%V)
 s cnn=Ch,r=0  s:-D3[-%gm S0=0 i D3,$e(D3,1,4)<$e(%gm,1,4) q
 i '$d(sN(%gm)) q:$o(sN(%gm),-1)<%gm0
 g w
FinGrL 
 s nos=N1,o=$e(D1,1,6) n D1 s D1=$e(o,1,4)_"."_$e(o,5,6)
 i $$l("INV  D1  nos   S0.__  NoAm   AM.__ amg.__ SIZN.__ SOST.__ Ve ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
am12 ;\amortizacija par 12 m{275}n.\Ve,INV\SIZNg,S01,SIZN1,SOST1,S012,SIZN12,SOST12,a(*)=N1,D1,NoAm,KoAm,Ch\\pam\s iii=0 k ^oMX(%USID,%V)
 k a s gm1=%gm\100*100+1,gm2=gm1+11
 q:'$o(sN(gm1-.1))  q:$o(sN(gm2+.1),-1)<gm1
 s SIZNg=0,s=$g(sN(gm1-89)),S01=+$p(s,"s",2),SIZN1=+s,SOST1=S01-SIZN1
 s s=$g(sN(gm2)),S012=+$p(s,"s",2),SIZN12=+s,SOST12=S012-SIZN12
 f m=gm1:1:gm2 s a(m#100)=$p($g(sN(m)),"a",2),SIZNg=SIZNg+a(m#100)
 g w
am12L s N1=$tr(N1,"*","x")
 f m=gm1:1:gm2 s:m#100=13 m=m+88
 s li="SIZNg S01 SIZN1 SOST1 S012 SIZN12 SOST12 N1 INV NoAm D1 Ve Ch "
 f n=1:1:12 s a(n)=$g(a(n)),li=li_"a("_n_") "
 i $$l(li)
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 Q
si ;\sanemsana - izsniegsana inv. par periodam\m,INV\s2,s22,s3,sp,sAtlp,sNolp,s22a=Ch,nf,Nm,Pi,D1,piez\\pam\s iii=0 k ^oMX(%USID)
 s nf=$$%nf(%gm) i $g(xnf),xnf-nf q 
 k Nm s Nm=""
 ;i piez["Mazv.in" n INV,Pi,cn s Pi="",cn="",INV=888888,Nm(1)=" Mazv.inv"
 f m=%gm:-1:%XD81\100 s m0=m-1 s:m0#100=0 m0=m0-88 d
 .s (s2,s22,s3,sp)=0,Nm=$g(r("NAME",m),Nm) s:$l(Nm)<3 Nm=NAME
 .i $d(Nm(1)) s Nm=Nm(1)
 .s Pi=$g(Piez(m)),sNolp=0,sAtlp=0,s22a=$p($g(sN(m)),"~",2)
 .i '$d(sN(m0)),$d(sN(m)) s s2=$p(sN(m),"s",2)
 .i 's2,$d(sN(m)),$g(r("piez",m))'["LIKV" s s22=$p(sN(m),"s",2)-$p($g(sN(m0)),"s",2)
 .i $g(sN(m))["dz" s s3=$p(sN(m),"s",2)+$p(sN(m),"S",2)
 .i si["p",$g(r("piez",m))["IEK.P" s sp=$p($g(sN(m)),"s",2) d w q
 .q:$g(r("piez",m))["IEK.P"
 .i si["s",s2!(s22>0)!s22a d w q
 .i si["i",s3 s sNolp=sN(m0)+$p($g(sN(m)),"a",2),sAtlp=s3-sNolp d w
 q
siL 
 s s=s2+s22,mu=$g(^omu(%USID,INV)) s:'$l(mu) mu=piez
 i sp!s2!s22!s3!s22a=0 s o=$$%RsuM^USPRINT(-1) q
 i INV s INV=INV_"<mx @"_$NAME(^pam(INV))
 i $l(mu)>1000 s mu=$e(mu,$l(mu)-1000,99999)
 i $$l("si m INV Nm sp s2.__ sNolp sAtlp s22.__ s3 s22a Ch mu Pi nf piez")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q 
pmkfing ;\pmk formesana - Inga\nf\s1\\pam\k ^pmk,^pmkInv
 q:NoAm'["/"  i $g(oxxINV) q:INV-oxxINV
 i $g(flagPL11) i NoAm["auto"!(NoAm["iek") q
 s %=$o(sN(%gm+.1),-1) i %>(%gm\100*100) f m=%+1:1:%gm s sN(m)=SIZNp_"s"_S0p
 s m="",m1=0,s1=0 n n2n i Ve["i",%gm>200600 q
 f  s m=$o(sN(m)) q:m=""  d
 . s nf=$$%nf(m),n1=$$%nf(m1),nff=$$%nff(m),n2n=$p(NoAm,"/",2) 
 . ;;i n2n["n",n2n s nf="9-"_(n2n*2)_"%.n"
 . s s=$p(sN(m),"s",2),a=$p(sN(m),"a",2),sn=+sN(m)
 .i n2n["n",m=%gm!(m#100=12)!m,$e(D1,1,4)-$e(%gm,1,4)!1 d  q
 ..  s nemat(INV)=s_"n"_((n2n/12)+$p($g(nemat(INV)),"n",2))_"n"_n2n q
 . s (s2,s31,s32,s3,s22)=0 i s>s1,s1 s s22=s-s1
 . i s>s1,'s1 s s2=s-s1
 . i 's s s=S0p,sn=SIZNp,s31=S0p,s32=SIZNp,s3=SOSTp
 . i 'nf s $p(nf,"-",3)=INV
 . s %R=$g(^pmk(nf,m)) f %=1:1:9 x "s g"_%_"=$p(%R,%B,%)"
 . s ^pmk(nf,m)=%B_(s+g2)_%B_(sn+g3)_%B_(s-sn+g4)_%B_(a+g5)_%B_(s2+g6)_%B_(s31+g7)_%B_(s32+g8)_%B_(s22+g9)_%B_%B_%B_%B_%B_%B_nff
 . s %R=$g(^pmkInv(nf,INV,m)) f %=1:1:9 x "s g"_%_"=$p(%R,%B,%)"
 . s ^pmkInv(nf,INV,m)=%B_(s+g2)_%B_(sn+g3)_%B_(s-sn+g4)_%B_(a+g5)_%B_(s2+g6)_%B_(s31+g7)_%B_(s32+g8)_%B_(s22+g9)_%B_%B_%B_%B_%B_%B_nff
 . s m1=m,s1=s
 q
 ; Inga {
p3 ;\PL noliet.kopsavilkums nod.\-nf,m\ss2,ss31,ss32,ss0,ss22,AV,sAtl,sNod,sIzn,sUzk\\pmk\s iii=0 k ^oMX(%USID,%V)
 q:m#100-12
 s ss2=0,ss31=0,ss32=0,ss22=0,ss0=$p($g(^pmk(nf,m)),%B,2)
 s AV=$p($g(^pmk(nf,m-100)),%B,11)
 i $d(^mxConfig(1,"pam",+nf,$e(m,1,4))) s AV=$p(^($e(m,1,4)),%B,2)
 f mm=1:1:12 d
 . s %R=$g(^pmk(nf,m\100*100+mm)) f %=1:1:20 x "s g"_%_"=$p(%R,%B,%)"
 . s nff=g15,ss2=ss2+g6,ss31=ss31+g7,ss32=ss32+g8,ss22=ss22+g9
 s sNod=(AV+ss2+ss22-(ss31-ss32))*$p(nff,"-",2)*2/100,sAtl=AV+ss2+ss22-(ss31-ss32)-sNod
 s:sNod<0 sNod=0,sAtl=0
 s $p(^pmk(nf,m),%B,11)=sAtl
 s sIzn=AV+ss2+ss22-(ss31-ss32),$p(^(m),%B,10)=sIzn,sUzk=ss0-sAtl
 i 'nf,$g(kopa00) s o=nf n nf s nf=$p(o,"-",1,2)
 g w
p3L 
 i $e(m,1,4)-$e(%gm,1,4),m s o=$$%RsuM^USPRINT(-1) q
 s ss2=ss2+ss22
 i $$l("nf m ss2 ss22 ss31 ss32 sIzn sNod sUzk sAtl ss0")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 k sN,r
 q
p2 ;\PL nodokli gramatv.\-nf,-INV,m\s\\pmkInv\s iii=0 k ^oMX(%USID)
 q:nf-$g(xnf)  q:'$g(xnf)   i xInv,INV-xInv q
 i xSar'="",'$d(^v(xSar,INV)) q
 s f=0,s=0
 f m=$e(%gm,1,4)_12:-100:$e(%XD81,1,4)_12 i $d(^pmkInv(nf,INV,m)) s f=1 d w
 i f s m=0 d w
 q
p2L s %=$$l("nf INV m "),iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
mA ;\men.amort.CDR\Gko\AM,S0,SOST,SIZN\\pam\s iii=0 k ^oMX(%USID,%V)
 i D3,D3<$e(%XD81,1,6) q
 i mxConfig[":CDR:" d G g w
 s Gko=ZA s:KoAm>999 Gko=KoAm g w
 q
mAL s t=$$konti^fin(Gko)
 i $$l("Gko t S0.__ SIZN.__ SOST.__ AM.__")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 Q
G s G=+$e(112233333333333,Ve\1),G=1 i $p(ZA,"k",2) s G=+$p(ZA,"k",2)
 s Gko=G*10+1200
 i ZA\1?4n!(ZA\1?6n) s Gko=+ZA
 q 
Is2 ;\Inventariz. saraksts\Ve,INV\Q,S0,SIZN,SOST=NAME,Y0,D1,ATB,Ch\R\pam\s iii=0 k ^oMX(%USID,%V)
 q:S0<1  s Q=1 s:-D3[-%gm S0=0 i D3,$e(D3,1,4)<$e(%gm,1,4) q
 g w
Is2L i $$l("%E %NNE INV NAME Y0 D1 Q  S0.__ SIZN.__ SOST.__ Ve Ch ATB")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
l(%lN) q:$d(%lN) $$l^UST(%lN) q $$l^UST

pam2008
ATGpam ; ATG.pamatlidz. ; [ 02/16/2007  5:29 PM ]  ;[ 20090326 12:09:21 ]
 ; M3-LITE, MSM, CACHE, GT.M, MiniM
 ; MX Copyright(c) SIA ENTERS  2005-2009
 q
w i xmsm'="" x "s %="_xmsm q:'%
 i Ch="" s mxMsgBox="pam :: ERROR :: INV="_INV_" cehs=???  vai nepareizi datumi "_%I q
 x %XV(%V)
 q
%I0 
 S %I="^"_%FILE,(firma,fir,DOK,DOKf)=0,%I2=""
 f %1="pa" d ^USX
start q
pm(INV,%gm,i) 
 k ^pm,^opm(%USID)
 n xmsm,XN,xVe,XN
 s (XN,XN(INV))=INV,xVe="",xmsm=1,%1="pa" d ^USX k:$d(i) @i
 n d,ZA,piez,Ch,S0,ASTART,NoAm,KoAm,D1,SOST,NAME,Ve
 d INV($g(flagBEZp))
 i $d(i) q:$d(@i) @i q:'$d(@i) "..?"
 s m=0 f  s m=$o(sN(m)) q:m=""  d
 .s %=+$p(sN(m),"s",2),r=%B_%_%B
 .s r=r_+sN(m)_%B_$j(%-sN(m),0,2)_%B_+$j($p(sN(m),"a",2),0,4)_%B
 .s r=r_$g(r("NoAm",m))
 .s ^pm(m)=r_%B_$g(r("piez",m))
 .s ^opm(%USID,m)=r_%B_$g(r("piez",m))
 q "" 
pmk 
 n INV,DOKf,firma,m,nf
 s (DOKf,firma,m)=0,nf=""
 f  s nf=$o(^pmk(nf)) q:nf=""  f  s m=$o(^pmk(nf,m)) q:m=""  s %I=$NAME(^(m)),INV=nf d @%V
 q
%vv g @%V
pamk d %I0^fin,%I0^pam,pamkV^pam q
pamkV i %FIRMA["LAG{362}MA" s mxConfig=":pam:e:"_mxConfig i $g(^mxConfig(1,"mxConfig",1,1))'["pam:e" s ^(1)=%B_":pam:e"
 s %1="pam" d ^USX i $$icFIRMA^fir
 s o=xVw n xVw s xVw=o_"  d DKsave"
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) s INV=$qs(%I,1) d pamS
pamS d:$d(%tSelect)  i '$d(%tSelect) s INV="" f  s INV=$o(^pam(INV)) q:INV=""  d
 .s %R=^pam(INV),(%I,%I2)=$NAME(^(INV)) x %XG("pam"),%XI("pam")
 .s %=$$pm^pam(INV,%gm),%kokoNum=0
 .Q:'$o(sN(%gm+1),-1)
 .s fir="%FIRMA",firma=%FIRMA,(DOKf,DOK)="Inv."_$e(INV+100000,2,9)
 .n m,m1 s m=0,m1=0 f  s m=$o(sN(m)) q:'m  q:m\1>%gm  d  s m1=m q:'s0
 ..s (d,d8)=$e(m,1,6)_"01" s:m?8n (d,d8)=m
 ..s s1=$g(sN(m1)),s=sN(m),s0=$p(sN(m),"s",2)
 ..s s0p=$p($g(sN(m1)),"s",2),sOSTp=s0p-s1
 ..n KoAm,ZA,S0 f o="KoAm","ZA","S0" s %=$o(pam(o,m+.00001),-1),@o=pam(o,%)
 ..i $d(dkINV(m)) s DK="" f  s DK=$o(dkINV(m,DK)) q:DK=""  s S=dkINV(m,DK) x xVw  ;; 20070910
 ..s (am,S)=$p(s,"a",2)
 ..s DK="7420-1290" i '$p(KoAm,"-",2) s:KoAm\1?4n!(KoAm\1?6n) $p(DK,"-",2)=$p($p(KoAm,"-")," ")
 ..i KoAm[-7 s DK=$p($p(KoAm,"-",2)," ")_"-"_$p($p(KoAm,"-")," ")
 ..i S,KoAm'[",",DK\1?4n!(DK\1?6n),$p(DK,"-",2)\1?4n!($p(DK,"-",2)\1?6n) x xVw  ;  amortiz
 ..i S,KoAm["," n pp,SS,p,ss,x,DK2 s pp=0,SS=S,ss=0,DK2=$p(DK,"-",2) n S f x=1:1:$l(KoAm,",") s DK=$p(KoAm,",",x) d:DK
 ...  s p=$p(DK,":",2),DK=$p(DK,":") s:$p(DK,"-",2) DK2=$p(DK,"-",2) s $p(DK,"-",2)=DK2
 ...  q:DK\1'?4n&(DK\1'?6n)  q:$p(DK,"-",2)\1'?4n&($p(DK,"-",2)\1'?6n)
 ...  s S=$j(SS*p/100,0,2),pp=pp+p,ss=ss+S x:S xVw q:$p(KoAm,",",x+1)
 ...  s S=$j(SS-ss,0,2) x:S xVw 
 ..i ZA\1'?4n,ZA\1'?6n n ZA s ZA=1230
 ..;; s:sN(m)["dzes" s0=0
 ..i 's0,m>200411,$g(mxConfig)["pam:BLG" s o=m+1 s:o#100=13 o=o+88 s (d,d8)=o_16 q:d>%XD82
 ..i 's0,sOSTp-am'>0,KoAm\1?4n!(KoAm\1?6n) s S=s0p,DK=$p($p(KoAm,"-")," ")_"-"_$p($p(ZA,"-")," ") x xVw d:'S
 ... i m=D1 s S=S0 x xVw
 ..   ;  norakst, kad nav atl.vert
 ..i 's0,sOSTp-am>0 s S=sOSTp-am,DK="8291-"_$p($p(ZA,"-")," ") d   x xVw
 ...  i $p(S0,"D",2)\1?4n!($p(S0,"D",2)\1?6n) s $p(DK,"-")=$p($p($p(S0,"D",2),"-")," ")
 ...  i $p(S0,"K",2)\1?4n!($p(S0,"K",2)\1?6n) s $p(DK,"-",2)=$p($p($p(S0,"K",2),"-")," ")
 ..   ;  norakst, atlik v{275}rt
 ..i 's0,sOSTp-am>0,KoAm\1?4n!(KoAm\1?6n) s S=s1+am,DK=$p($p(KoAm,"-")," ")_"-"_$p($p(ZA,"-")," ") x xVw
 ..   ;  noraks, uzkr nolietojums
 ..s S=s0-s0p
 k r,S0,SIZN,nf,NOF,s0,sN,am,DKm,dkINV
 q
DKsave q:$g(gramatos)'>0  q:S*S<.000001  n % 
 i $d(%tSelect),d8<%XD81 q
 i '$d(^gramatos(d8,%I)) s ^(%I)=%B_DK_%B_S q
 s %=^(%I),^(%I)=%B_$p(%,%B,2)_"^"_DK_%B_$p(%,%B,3)_"^"_S
 q
pam d %I0^pam
pamV n r,s0,s00,sN,pam n @($tr(%LI("pam"),"~")) 
 D %I0 S INV="",N=1,XN=$g(XN),%I="^pam"
 F  S INV=$o(^pam(INV)) Q:INV=""  d
 .d INV($g(flagBEZp)) q:'$D(sN)
 .i xCh'=""," "_xCh_" "'[(" "_Ch_" ") q
 .i xVe'=""," "_xVe_" "'[(" "_Ve_" ") q
 .x xVw
 k r,S0,SIZN,nf,NOF,s0,sN,am,DKm,dkINV
 Q
INV(flagBEZp) 
 n muv,%RR,m,m1,rr,ff,newAmLs,amKoefS2,atlmNoAm
 k r,S0,SIZN,nf,NOF,s0,sN,am,DKm,dkINV,S0minus,s22,pam
 s (%RR,am,m,m1,gm0,amP,amg,D3,AM,kp,dp,pS,SOST,SIZN,N1)=0 s:'$d(ff) ff=^AL("pam","%LG")
 s muv=" ",%R=^pam(INV),%I=$zr
 x %XG("pam") s:'S0 $p(S0,"^")=.000001
 i d>%gm s S0=0 q
 s s00=S0 k pam
 f xm=1:1 s m=$p(d,"^",xm) q:'m  d
 .i m<0 s m=-m i $p(S0,"^",xm) s $p(S0,"^",xm)=0_" "_$p(S0,"^",xm)
 .s gm=m\1 q:gm>%gm
 .i 'gm0 s D1m=m,sN=+ASTART,rD=m,gm0=m
 .f x=2:1 s n=$p(ff,",",x) q:n=""  d
 .. s (r,r(n,gm),pam(n,gm))=$p(@n,"^",xm)
 .. i n="S0" s:$p(r,"~",2)&'r r=r(n,m1)_"~"_$p(r,"~",2) s:r<.1&(r>0) (r,r(n,gm))=.0001_" "_r i $g(flagBEZp),r["p" s (r,r(n,gm),pam(n,gm))=""
 .. s:m=gm0 r(n,0)=r
 .. i n="ASTART","+-"[$e(r_1) s (r,r(n,gm))=+r(n,m1)_" +"_+r_" "_r
 .. i n="NAME","+,"[$e(r_1) s (r,r(n,gm))=r(n,m1)_r
 .. i n="piez",$l(r)<2 s r(n,gm)=" ",r="*"
 .. i $tr(r,"- ./,:;","")="" d
 ...  s r(n,gm)=$g(r(n,m1)) k:xm>1 pam(n,gm) i n="S0" s r(n,gm)=$tr(r(n,gm),"~p","  ")
 ...  s:n="ASTART" r(n,gm)=+r(n,gm)
 .s m1=m
 f x=2:1 s n=$p(ff,",",x) q:n=""  s @n=$g(r(n,0))
 i 'd s %ACT=0 q
 k s22i s m0=0,m1=0,s22i=0,S0i=S0,amortmen=0
 f m=D1m:1:%gm s:m#100=13 m=m+88 d  q:'m  q:D3=m  s m0=m
 .s m1=+$o(r("d",m),-1) i m>%gm s m=0 q
 .s (pS0,flagam,plusSOST,s22a)=0,amortmen=amortmen+1
 .i $d(r("d",m)) d  Q:'m
 .. f x=2:1 s n=$p(ff,",",x) q:n=""  s @n=$g(r(n,m))
 .. s n=r("NoAm",m) s:n["Ls" am(m)=n i n s:n["g" (r("NoAm",m),NoAm)=100/n s:n["m" (r("NoAm",m),NoAm)=100/n*12
 .. s n=r("KoAm",m) i n_11["e11",mxConfig["pam:e" s (Koam,r("KoAm",m))=r("KoAm",m)_"/"
 .. s (%,s22a)=$p($g(r("S0",m)),"~",2) i %,'r("S0",m) s (S0,r("S0",m))=r("S0",m1)_"~"_%
 .. i S0["dz"!'S0 s D3=m,(r("S0",m),S0,S0i)=r("S0",m1) q
 .. s S0i=S0 i % s plusSOST=$j(%/S0*(sN(m0)+$$am(m,sN,S0)),0,2)  s am(m)=$$am(m,sN,S0) ;;;;;;;;;;;; ~ ~ 
 .. i % s s22i=s22i+plusSOST,S0i=S0+s22i,s22i(m,"-")=%-plusSOST,s22i(m,"+")=%
 .. s ss=S0i-$j(r("S0",m1),0,2) i ss d  s r("S0",m)=S0i-plusSOST_$s(m<200800:"",1:" "_r("S0",m))
 ...   ;;s ss=$s(ss>0:"+",1:"-")_$j(ss,0,2)
 ...   i S0["p" s pS0=S0i-r("S0",m1)-$p(piez,"+",2)
 .. s am=$$am(m,sN,S0i,$s(m>200600:ss,1:0)),flagam=1 i plusSOST s am(m+1)=am,am=am(m) i m#100=12 s am(m+89)=am(m+1)
 .. i S0_" "["p0 " k am s (newAmLs,sN,sNp,SIZN)=0,SOST=S0 n s22 s am=$$am(m,0,S0)  ;; parvert-0
 .i 'flagam,KoAm_NoAm["e/"!$d(am(m))!(mxConfig["pam:e"&(KoAm_NoAm["e"))!(m>200500) s am=$$am(m,sN,S0i)
 .i m=D1m n am s am=0
 .i plusSOST s dkINV(m,+KoAm_"-"_+ZA)=plusSOST,S0i=S0i-plusSOST   ;;s am=am-plusSOST
 .i plusSOST s dkINV(m,$p(%_"D7550","D",2)_"-"_+ZA)=%-plusSOST
 .s sN=sN+am-plusSOST i sN>S0i,S0i>-1 s am=$$am(m,sN-am,S0i),sN=S0i
 .i -m[-$e(%gm,1,4) s amg=amg+am
 .s sN(m)=+$j(sN,0,2)_" s"_+$j(S0i,0,S0i<.001*9+2)_" a"_+am s:s22a sN(m)=sN(m)_"~++"_s22a
 .i plusSOST s sN(m)=sN(m)_"--"_(%-plusSOST)
 .i pS0 s sN(m)=sN(m)_"p"_pS0
 .i D3\1=m s sN(m)=sN(m)_" dzests ",amP=am,muv=" dzests "
 .i $g(atlmNoAm) s atlmNoAm=atlmNoAm-1
 s am=+$p($g(sN(%gm)),"a",2),AM=$j(am,0,2),amg=+$j(amg,0,2),SIZN=$j($g(sN(%gm)),0,2)
 i S0i>-1 s:SIZN<.02 SIZN=0
 s S0p=S0i,SIZNp=SIZN s:muv["dzes" S0p=r("S0",m1)
 s %=$o(sN(%gm+1),-1) i % s SIZNp=$j($g(sN(%)),0,2)
 s:muv["dzes" S0i="0 "_S0i,SIZN=0 s SOST=S0i-SIZN,SOSTp=S0p-SIZNp
 i $g(sN(%gm))["dzes",'S0i,'SIZN s sN(%gm)="0sS"_+$p(sN(%gm),"s",2)_"a"_$p(sN(%gm),"a",2,99)
 i '$d(sN(%gm)) s %=$o(sN(%gm),-1) i % s sN(%)="0sS"_+$p(sN(%),"s",2)_"a"_$p(sN(%),"a",2,99)
 i S0i>-1 s:SOST<0 SOST=0 s:SOSTp<0 SOSTp=0
 s (N1,nos1)=$p(NAME,"\"),(N2,nos2)=$p(NAME,"\",2),N3=$p(NAME,"\",3)
 S CCh=Ch k ff i '$d(sN(%gm)) s (S0,S0i,SIZN,SOST,AM,am)=0
 q
am(m,sNp,S0,s22) 
 n S,%,o,am0,m0,flagExpo,flagParv s flagExpo=0,flagParv=0
 i $g(r("S0",m))["p" s flagParv=m m ERR=r
 i KoAm_NoAm["e",mxConfig["pam:e"!(KoAm_NoAm["e/") s flagExpo=1
 s %=+$p($g(r("S0",m)),"-",2),S0minus=$g(S0minus) s:%-S0minus&% S0minus(m)=%,S0minus=%
 s S=S0-S0minus-$g(SIZN(0)),m0=$o(r("NoAm",m),-1) k ^Opam(INV,m)
 s o=NoAm*S/1200 i o s:'$d(atlmNoAm) atlmNoAm=S+1/o\1+(m>200800) i m0,r("NoAm",m0)-NoAm s atlmNoAm=S+1/o\1-amortmen+1+(m>200800)  
 i %,S0,S>sNp,S0>S,$o(S0minus(1))>D1 s amKoefS2=(S0-S0minus-sNp/(S0-sNp))*(S0/S) s:m<200800 amKoefS2=S/S0
 i flagExpo,NoAm n mm,k s mm=100/NoAm*12,k=S/(1+mm*mm/2) d  q am
 . n o,n,m1 s o="" f n=0:1 s o=$o(sN(o)) q:'o  q:o=m  i o>m s n=n-1 q
 . s am=0,m1=$o(sN(m),-1) i n s am=mm-n+1*k s:am<0 am=0 f o="mm","am","k" s ^Opam(INV,m,o)=@o
 . i m1,$g(sN(m1))+am>S s am=S-$g(sN(m1)) s:am<0 am=0
 ;i KoAm_NoAm["e/" s %=m-1 s:%#100=0 %=%-88 n S s S=$p($g(sN(%)),"s",2)-$g(sN(%)),eS(m)=S
 n a s a=NoAm*(S-$g(s22))/1200 s:NoAm["Ls" a=NoAm s:$p(NoAm,"a",2) am=$p(NoAm,"a",2)*NoAm/1200
 s:$g(newAmLs) a=+newAmLs_"-newAmLs  "
 i a,$g(s22),'$p(NoAm,"a",2) s atlmen=S0-$g(s22)-sNp/a i atlmen>.9 s newAmLs=S0-sNp/atlmen_" S0="_S0_" sNp="_sNp_" a="_+a_" atlmen="_atlmen s:newAmLs<1 newAmLs=0
 s (am,am0)=NoAm*S/1200 
 i m<200800 i $g(newAmLs) s am=newAmLs s:$g(amKoefS2) am=am*amKoefS2 
 i m>200800 s:$g(newAmLs) am=newAmLs s:$g(amKoefS2) am=am*amKoefS2 
 i m>200800,m0,r("NoAm",m0)-NoAm!(r("S0",m0)-S0),$g(atlmNoAm) s o=S-sNp/atlmNoAm s:o>1 (newAmLs,am)=o
 i m>200800,S0minus,$g(atlmNoAm),$o(S0minus(1))>D1 s o=S-sNp/atlmNoAm s:o>1 (am,newAmLs)=o
 i flagExpo s am=NoAm*S*4/1200 s:am<(.001*$p($g(sN(%)),"s",2)) am=S q am
 ;i KoAm["e/" s %=S0-$g(sN(%))-am i %<(.1*S0)&(%<50) s am=%+am s:am<0 am=0
 s:NoAm["Ls" am=NoAm s:$p(NoAm,"a",2) am=$p(NoAm,"a",2)*NoAm/1200
 i mxConfig[":CDR:" s:m>200600 am=$j(am,0,2)
 else  d
 .i m>200700 s am=$j(am,0,2)
 .i m>200600,mxConfig'[":FALCK:" s am=$j(am,0,2)
 .i m>200500,mxConfig'[":ETA:",mxConfig'[":FALCK:" s am=$j(am,0,2)
 s %=am+sNp-S i %>0,'flagExpo s am=am-%
 i mxConfig'["CDR"!(m>200600),%<0,%>-1 s am=am-%
 s:am<0 am=0 s atlmNoAm=$j($g(atlmNoAm),0,1),atlmen=$j($g(atlmen),0,1),newAmLs=$j($g(newAmLs),0,2) s:newAmLs<1 newAmLs=0
 s ^Opam(INV,m,"am")=am f o="amortmen","m","flagParv" s ^(o)=$g(@o)
 f o="atlmNoAm","newAmLs","atlmen","s22","am0","amKoefS2","S0minus","S0","sNp","S" s ^(o)=$g(@o)
 q am
%nf(m) 
 n n,%,k,k0 s %=$o(r("NoAm",m+1),-1),n=r("NoAm",%),n=$p(n,"/",2),%=0
 q:m<199512!'$l(n) 0  s n=+n
 s k0=$s(n=5:"1-5%",n=35:"3-35%",n=10:"2-10%",n=20:"4-20%",'n:"0-00%",1:"9-"_+n_"%")
 s k=$e(%XD82,5,6)/12 s:$e(%XD81,1,6)=%gm k=1
 q:k'<.99 k0  q $p(k0,"-")_"-"_+$j($p(k0,"-",2)*k,0,4)_"%"
 q
%nff(m) 
 n n,%,k,k0 s %=$o(r("NoAm",m+1),-1),n=r("NoAm",%),n=$p(n,"/",2),%=0
 q:m<199512!'$l(n) 0  s n=+n
 s k0=$s(n=5:"1-5%",n=35:"3-35%",n=10:"2-10%",n=20:"4-20%",'n:"0-00%",1:"9-"_+n_"%")
 s k=$e(%XD82,5,6)/12 s:$e(%XD81,1,6)=%gm k=1
 s %=$g(^SetATG("pam","ggggmm")) i $e(%,1,4)=$e(m,1,4) s k=13-($e(%,1,6)#100)/12
 s %=$o(^mxConfig(1,"firma","ggggMMdd",19000000)) i %?8n,$e(%,1,4)=$e(m,1,4) s k=13-($e(%,1,6)#100)/12
 q:k'<.99 k0  q $p(k0,"-")_"-"_+$j($p(k0,"-",2)*k,0,4)_"%"
 q
A1 ;\Pamatlidz saraksts\Ch,Ve,INV\S0,SOST,SIZN,AM,amg=Y0,ZA,KoAm,ATB,NoAm,D1,nff,N1,%I\\pam\ s iii=0 k ^oMX(%USID,%V)
 s nff=$$%nf(%gm) i D3,D3'>$e(%XD81,1,6) q
 g w
A1L 
 s nos=N1
 i $$l("Ch INV Ve Y0 D1 NoAm KoAm S0.__ SIZN.__ SOST.__ AM.__ amg.__ ATB nff nos piez %I")
 s:Ch="*" Ch=%B_" *** "
 s iii=iii+1 m ^oMX(%USID,%V,Ch,iii)=lUST
 q 
FinGr ;\PL noliet.finansu gramatv.\Ve,INV\S0,SOST,SIZN,AM,amg=ATB,Y0,ZA,KoAm,NoAm,D1,N1\cnn-r\pam\s iii=0 k ^oMX(%USID,%V)
 s cnn=Ch,r=0  s:-D3[-%gm S0=0 i D3,$e(D3,1,4)<$e(%gm,1,4) q
 i '$d(sN(%gm)) q:$o(sN(%gm),-1)<%gm0
 g w
FinGrL 
 s nos=N1,o=D1 n D1 s D1=$e(o,1,4)_"."_$e(o,5,6)
 i $$l("INV  D1  nos   S0.__  NoAm   AM.__ amg.__ SIZN.__ SOST.__ Ve ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
am12 ;\amortizacija par 12 m{275}n.\Ve,INV\SIZNg,S01,SIZN1,SOST1,S012,SIZN12,SOST12,a(*)=N1,D1,NoAm,KoAm,Ch\\pam\s iii=0 k ^oMX(%USID,%V)
 k a s gm1=%gm\100*100+1,gm2=gm1+11
 q:'$o(sN(gm1-.1))  q:$o(sN(gm2+.1),-1)<gm1
 s SIZNg=0,s=$g(sN(gm1-89)),S01=+$p(s,"s",2),SIZN1=+s,SOST1=S01-SIZN1
 s s=$g(sN(gm2)),S012=+$p(s,"s",2),SIZN12=+s,SOST12=S012-SIZN12
 f m=gm1:1:gm2 s a(m#100)=$p($g(sN(m)),"a",2),SIZNg=SIZNg+a(m#100)
 g w
am12L 
 s N1=$tr(N1,"*","x")
 f m=gm1:1:gm2 s:m#100=13 m=m+88
 s li="SIZNg S01 SIZN1 SOST1 S012 SIZN12 SOST12 N1 INV NoAm D1 Ve Ch "
 f n=1:1:12 s a(n)=$g(a(n)),li=li_"a("_n_") "
 i $$l(li)
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 Q
si ;\sanemsana - izsniegsana inv. par periodam\m,INV\s2,s22,s3,sp,sAtlp,sNolp,s22a=Ch,nf,Nm,Pi,D1,piez\\pam\s iii=0 k ^oMX(%USID)
 s nf=$$%nf(%gm) i $g(xnf),xnf-nf q 
 k Nm s Nm=""
 ;i piez["Mazv.in" n INV,Pi,cn s Pi="",cn="",INV=888888,Nm(1)=" Mazv.inv"
 f m=%gm:-1:%XD81\100 s m0=m-1 s:m0#100=0 m0=m0-88 d
 .s (s2,s22,s3,sp)=0,Nm=$g(r("NAME",m),Nm) s:$l(Nm)<3 Nm=NAME
 .i $d(Nm(1)) s Nm=Nm(1)
 .s Pi=$g(Piez(m)),sNolp=0,sAtlp=0,s22a=$p($g(sN(m)),"~",2)
 .i '$d(sN(m0)),$d(sN(m)) s s2=$p(sN(m),"s",2)
 .i 's2,$d(sN(m)),$g(r("piez",m))'["LIKV" s s22=$p(sN(m),"s",2)-$p($g(sN(m0)),"s",2)
 .i $g(sN(m))["dz" s s3=$p(sN(m),"s",2)+$p(sN(m),"S",2)
 .i si["p",$g(r("piez",m))["IEK.P" s sp=$p($g(sN(m)),"s",2) d w q
 .q:$g(r("piez",m))["IEK.P"
 .i si["s",s2!(s22>0)!s22a d w q
 .i si["i",s3 s sNolp=sN(m0)+$p($g(sN(m)),"a",2),sAtlp=s3-sNolp d w
 q
siL 
 s s=s2+s22,mu=$g(^omu(%USID,INV)) s:'$l(mu) mu=piez
 i sp!s2!s22!s3!s22a=0 s o=$$%RsuM^USPRINT(-1) q
 i INV s INV=INV_"<mx @"_$NAME(^pam(INV))
 i $l(mu)>1000 s mu=$e(mu,$l(mu)-1000,99999)
 i $$l("si m INV Nm sp s2.__ sNolp sAtlp s22.__ s3 s22a Ch mu Pi nf piez")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q 
pmkfing ;\pmk formesana - Inga\nf\s1\\pam\k ^pmk,^pmkInv
 q:NoAm'["/"  i $g(oxxINV) q:INV-oxxINV
 i $g(flagPL11) i NoAm["auto"!(NoAm["iek") q
 s %=$o(sN(%gm+.1),-1) i %>(%gm\100*100) f m=%+1:1:%gm s sN(m)=SIZNp_"s"_S0p
 s m="",m1=0,s1=0 n n2n i Ve["i",%gm>200600 q
 f  s m=$o(sN(m)) q:m=""  d
 . s nf=$$%nf(m),n1=$$%nf(m1),nff=$$%nff(m),n2n=$p(NoAm,"/",2) 
 . ;;i n2n["n",n2n s nf="9-"_(n2n*2)_"%.n"
 . s s=$p(sN(m),"s",2),a=$p(sN(m),"a",2),sn=+sN(m)
 .i n2n["n",m=%gm!(m#100=12)!m,$e(D1,1,4)-$e(%gm,1,4)!1 d  q
 ..  s nemat(INV)=s_"n"_((n2n/12)+$p($g(nemat(INV)),"n",2))_"n"_n2n q
 . s (s2,s31,s32,s3,s22)=0 i s>s1,s1 s s22=s-s1
 . i s>s1,'s1 s s2=s-s1
 . i 's s s=S0p,sn=SIZNp,s31=S0p,s32=SIZNp,s3=SOSTp
 . i 'nf s $p(nf,"-",3)=INV ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 . s %R=$g(^pmk(nf,m)) f %=1:1:9 x "s g"_%_"=$p(%R,%B,%)"
 . s ^pmk(nf,m)=%B_(s+g2)_%B_(sn+g3)_%B_(s-sn+g4)_%B_(a+g5)_%B_(s2+g6)_%B_(s31+g7)_%B_(s32+g8)_%B_(s22+g9)_%B_%B_%B_%B_%B_%B_nff
 . s %R=$g(^pmkInv(nf,INV,m)) f %=1:1:9 x "s g"_%_"=$p(%R,%B,%)"
 . s ^pmkInv(nf,INV,m)=%B_(s+g2)_%B_(sn+g3)_%B_(s-sn+g4)_%B_(a+g5)_%B_(s2+g6)_%B_(s31+g7)_%B_(s32+g8)_%B_(s22+g9)_%B_%B_%B_%B_%B_%B_nff
 . s m1=m,s1=s
 q
 ; Inga {
p3 ;\PL noliet.kopsavilkums nod.\-nf,m\ss2,ss31,ss32,ss0,ss22,AV,sAtl,sNod,sIzn,sUzk\\pmk\s iii=0 k ^oMX(%USID,%V)
 q:m#100-12
 s ss2=0,ss31=0,ss32=0,ss22=0,ss0=$p($g(^pmk(nf,m)),%B,2)
 s AV=$p($g(^pmk(nf,m-100)),%B,11)
 ;;
 i %FIRMA["Falck",-m[-2004,+nf=3 s AV=370
 i %FIRMA["Falck",-m[-2004,+nf=4 s AV=4231
 ;
 i $d(^mxConfig(1,"pam",+nf,$e(m,1,4))) s AV=$p(^($e(m,1,4)),%B,2)
 f mm=1:1:12 d
 . s %R=$g(^pmk(nf,m\100*100+mm)) f %=1:1:20 x "s g"_%_"=$p(%R,%B,%)"
 . s nff=g15,ss2=ss2+g6,ss31=ss31+g7,ss32=ss32+g8,ss22=ss22+g9
 s sNod=(AV+ss2+ss22-(ss31-ss32))*$p(nff,"-",2)*2/100,sAtl=AV+ss2+ss22-(ss31-ss32)-sNod
 s:sNod<0 sNod=0,sAtl=0
 s $p(^pmk(nf,m),%B,11)=sAtl
 s sIzn=AV+ss2+ss22-(ss31-ss32),$p(^(m),%B,10)=sIzn,sUzk=ss0-sAtl
 i 'nf,$g(kopa00) s o=nf n nf s nf=$p(o,"-",1,2)
 g w
p3L 
 i $e(m,1,4)-$e(%gm,1,4),m s o=$$%RsuM^USPRINT(-1) q
 s ss2=ss2+ss22
 i $$l("nf m ss2 ss22 ss31 ss32 sIzn sNod sUzk sAtl ss0")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 k sN,r
 q
p2 ;\PL nodokli gramatv.\-nf,-INV,m\s\\pmkInv\s iii=0 k ^oMX(%USID)
 q:nf-$g(xnf)  q:'$g(xnf)   i xInv,INV-xInv q
 i xSar'="",'$d(^v(xSar,INV)) q
 s f=0,s=0
 f m=$e(%gm,1,4)_12:-100:$e(%XD81,1,4)_12 i $d(^pmkInv(nf,INV,m)) s f=1 d w
 i f s m=0 d w
 q
p2L 
 s %=$$l("nf INV m "),iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
Vg ;\Gada vid atl.vertiba\rr,GV,c\ss4,s2,s(-88),s(3),s(6),s(9),s(12)\-%ggmm\pam\s xfin=1,iii=0 k ^oMX(%USID)
 S GV=0  ;;+$E(113323330003,Ve\1)
 s s2=0,(s(-88),s(3),s(6),s(9),s(12))=0
 f m=%gm0-88,%gm0+3,%gm0+6,%gm0+9,%gm0+12 i $d(sN(m)),sN(m)'["dz{275}s" d
 .k rr s rr(1)=1 s s(m-%gm0)=$p(sN(m),"s",2)-sN(m) s:m=200212 s(m-%gm0)=S0-sN(m) ;;;;;; p200212
 .s c=$g(Cm(m),Ch),rr='c+1 n Ch s Ch=c
 .i $d(^v("H",INV))!$d(^("c="_Ch)) s rr(2)=2
 .s s=s(m-%gm0) s:m#100=12 s=s/2
 .Q:s<0
 .s ss4=s/4,s2=0 d Vg12w s s(m-%gm0)=0
 .i m=(%gm0+12),SOST s s2=SOST,ss4=0 d Vg12w
 q
Vg12w s rr=0 f  s rr=$o(rr(rr)) q:rr=""  d w  q:%V[1
 q
VgL 
 s s(-88)=s(-88)/2,s(12)=s(12)/2,%1="",sv=0
 f %=-88,3,6,9,12 s %1=%1_" s("_%_").__",sv=sv+s(%)
 s %1=%1_" sv.__ " s:%V["Vg1" %1=%1_" INV "
 i $$l("  r   GV   c  ss4.__ s2.__ "_%1)
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST 
 q
Vg1 ;\Gada vid atl.vertiba (dekl.)\INV\s(-88),ss4,s2=NAME\\pam\s xfin=1,iii=0 k ^oMX(%USID)
 g Vg
Vg1L 
 s NAME=$p(NAME,"\"),s2=s(-88)
 i 's2,'ss4 q
 s s88=$g(s(-88)) i $$l("%NNE INV   NAME s2.__ ss4.__ s88.__ ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q 
mA ;\men.amort.CDR\Gko\AM,S0,SOST,SIZN\\pam\s iii=0 k ^oMX(%USID,%V)
 i D3,D3'>$e(%XD81,1,6) q
 i mxConfig[":CDR:" d G g w
 s Gko=ZA s:KoAm>999 Gko=KoAm g w
 q  ;;s:-D3[-%gm S0=0 i D3,$e(D3,1,4)<$e(%gm,1,4) q
mAL 
 s t=$$konti^fin(Gko)
 i $$l("Gko  t   S0.__ SIZN.__ SOST.__ AM.__")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 Q
G s G=+$e(112233333333333,Ve\1),G=1 i $p(ZA,"k",2) s G=+$p(ZA,"k",2)
 s Gko=G*10+1200
 i ZA\1?4n!(ZA\1?6n) s Gko=+ZA
 q 
Is2 ;\Inventariz. saraksts\Ve,INV\Q,S0,SIZN,SOST=NAME,Y0,D1,ATB,Ch\R\pam\s iii=0 k ^oMX(%USID,%V)
 q:S0<1  s Q=1 s:-D3[-%gm S0=0 i D3,$e(D3,1,4)<$e(%gm,1,4) q
 g w
Is2L 
 i $$l("%E %NNE INV NAME Y0 D1 Q  S0.__ SIZN.__ SOST.__ Ve Ch ATB")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
l(%lN) q:$d(%lN) $$l^UST(%lN) q $$l^UST

tirgus
tirgus ; ATG.materiali [ 09/20/2006  2:33 PM ]  ;[ 20191205 18:12:28 ]
 ; MSM, CACHE, GT.M, MINIM
 ; vmx Copyright(c) SIA.ENTERS  2005-2019
 q
w1 i $g(mxConfig)[":d8min=" q:d8<$p(mxConfig,":d8min=",2)
 i $g(mnosMNd),$e(d8,1,6)<$e(mnosMNd,1,6) q   ;;; VEN UPTK
 i $l($g(xmsm)) x "s %="_xmsm q:'%
 i $g(%flagVom) x $g(formulaL) i %flagVom>10,%flagVom<99 q
 X %XV(%V)
 q
NP(nos) n NN q:nos="" "?"
 s NN=$p($g(^NP(nos)),%B,2) s:NN="" NN="?"
 q NN
PN(NN,gm) q $$nos(NN,$g(gm))
PNos(NN,gm) q $$nos(NN,$g(gm))
MNos(NN,gm) q $$nos(NN,$g(gm))
nos(NN,gm) 
 n o,%,rr s (PN7,kNN)=9999,mnosMNd=0
 i $l(NN)>55!'$l(NN) s (gr,cena,strcode,m,mv)="?" q "?"
 I $d(^MNd(NN)) q $$MNd(NN,$g(gm))
 s cena=+$p(NN,":",2),rr=$g(^PN(NN)) i rr="",$d(^MNd) q $$MNd(NN,$g(gm))
 i rr="",cena s %=$o(^PN($p(NN,":")_":")) s:$p(%,":")=$p(NN,":") rr=^(%),$p(rr,%B,6)=cena,^(NN)=rr
 i rr="",cena s rr=$g(^PN($p(NN,":"))) i $l(rr) s $p(rr,%B,6)=cena,^(NN)=rr
 s m=$p(rr,%B,2) s:m["gab" m="gb" s m=$p(m_"..","..") s:m="" m=1
 s gr=+$p(rr,%B,4),(kNN,PN7)=gr,mv=m s:'kNN kNN=0
 s strcode=$p(rr,%B,5) s:'cena cena=$p(rr,%B,6)
 q:rr'="" $tr($p(rr,%B,3),"*","x")
 s cena=-1 d:$d(%ALx) %SEL^MXF($name(^PN(NN)),NN)
 q NN
MNd(NN,gm) 
 s (m,cena,PN7,kNN,mnosMNd)="?" i $l(NN)>55!'$l(NN) s (gr,strcode,m,mv)="?"  q "?"
 n mm,nos,rr,% s:$g(gm)<200000 gm=%gm s mnosMNd=0,gm=$e(+gm,1,6)
 s mm=$o(^MNd(NN,gm+.1),-1) s:'mm mm=$o(^(gm_33),-1) s:'mm mm=$o(^(""),-1) s rr=$g(^(+mm))
 i $o(^(mm),-1) s nos=$p(rr,%B,4),mnosMNd=mm,%=mm d
 .  f  s %=$o(^(%),-1) q:'%  q:nos'=$p(^(%),%B,4)  s mnosMNd=%
 i $l(rr,%B)>6 n %R,%1 s %R=rr,%1="MNd" d:'$d(%XG(%1)) ^USX x %XG("MNd")
 s cena=$p(rr,%B,2),PN7=$p(rr,%B,5),crBEZpvn=$p(rr,%B,7) s:'$d(nos) nos=$p(rr,%B,4)
 s strcode="" i $p(PN7," ",2) s strcode=$p(PN7," ",2),PN7=$p(PN7," ")
 i $p(rr,%B,6) s strcode=$p(rr,%B,6)
 s m=$p(rr,%B,3) k mv  i %gm>201400,gm<201400 s cena=cena/.702804,crBEZpvn=crBEZpvn/.702804
 i m["=" f %=2:1:9 s mv=$p(m,"=",%) s:mv mv=$p(mv,+mv,2) i $l(mv) s mv(mv)=+$p(m,"=",%) s:'mv(mv) mv(mv)=1
 s (m,mv)=$p(m,"="),kNN=PN7 s:$p(NN,":",2) cena=+$p(NN,":",2)
 s:m["gab" m="gb" s (m,mv)=$p(m_"..","..") s:m="" (m,mv)=1
 q:$l(nos) nos s cena=-1 d:$d(%ALx) %SEL^MXF($name(^MNd(NN,gm)),NN)
 q NN
q() q:xf_xDOK="" 0
 i xf'="" i $tr(firma,%LAT,%lat)'[xf q 1
 i 'xDOK,xDOK'="",DOKf'=xDOK q 1
 i xDOK,DOKf'=xDOK q 1
 q 0
%I0 s (s,sp)=0 q
koko(s,DK) 
 i $d(%V(%V,"w1")) d @%V q 1
 i $g(DK) n %koko s %koko(%FILE,1)=%B_$p(DK,"-")_%B_$p(DK,"-",2)_%B_s_%B_1_%B_%FILE
 q $$koko^fin(s)
%vv g @%V
Saiz7 d %I0,%I0^fin,Saiz7V^kas q
ppq 
ppq6 
pps d %I0,%I0^fin,ppsV^tirgus q
atg d %I0,%I0^fin,atgV^tirgus q
FRq 
PPR d %I0,%I0^fin,PPRV^tirgus q
PAV d %I0,%I0^fin,PAVV^tirgus q
atgV 
ppsV n Piez,piez,p,da,T
 s sVe="",(fa,da,did,dk,nn,cFIFO,sFIFO,ob,T,INV,K)=0,parko=" ",xNN=$g(xNN),d8KoFiDo=$g(d8KoFiDo,0) i d8KoFiDo'["-" s d8KoFiDo=0 s:%gm>201400 d8KoFiDo=20131231 
 f %1="Firma","pps","atg",%FILE d ^USX k obj
 s NN=0,%I2="",bak=2310,%I="^"_%FILE,kurssumm=1
 s OfirO="",OfirmaO=""
 d %I0 f %1="Saisp","Firma" d ^USX
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"(") d ppsS s (OfirO,OfirmaO)="" q:'$d(%I)
 s %I="^"_%FILE s:$g(d8KoFiDo) %I=%I_"(d8KoFiDo+.1)" s:$g(xd8start)?8n %I="^"_%FILE_"("_xd8start_")"
 i $g(%d8start(%FILE))>$g(d8KoFiDo) s %I="^"_%FILE_"("_%d8start(%FILE)_")" k %d8start(%FILE) 
ppsS d:$d(%tSelect)  i '$d(%tSelect) f  s (%I2,%I)=$q(@%I) q:%I=""  d  q:'$d(%I)
 .s ob="",%R=@%I,K=0 i %R["ob=" s ob=$p($p($p(%R,"ob=",2),%B)," "),%R=$$trw^UST(%R,"ob="_ob)
 .k p,ccR,dad,did s piez=" ",da=0 X %XI(%FILE),%XG(%FILE) q:d#100=33  s:'$d(ccR) ccR=c i d>%XD82 k %I q 
 .i xNN'="",NN'=xNN q:xNN'[":"
 .i %FILE="ppq" s nol=+$p(piez,"n",2),NN=+piez q:$l(NN)<2  ;; only for non-accountable
 . i mxConfig[":UPTK:",%FILE="ppq6",nol=4,$l(NN)<2 s NN=11111111
 .i %FILE="ppq6" s o=$p(nol,".",2),nol=nol\1 q:$l(NN)<2  s:o&'$l(ob) ob=o  ;; only for non-accountable
 .q:NN=""  ;; only for non-accountable
 .s d8=d,nn=n,m=0,DOK=$tr(DOK," ") s:$d(p) piez=p,K=p 
 .s nos=$$nos(NN,%XD82) s:'kNN kNN=2130  i q*s>0,s/q-c s c=s/q_" "_c
 .s vc=c,cZak=c,DOKf=DOK,(Piez,p)=piez ;; i %R["ob=" s ob=$p($p($p(%R,"ob=",2),%B)," ")
 .i %FILE="pps" s nol=+$p(atb,"n=",2)\1 s:'nol nol=+atb\1 s:-kNN[-7&(nol<9) nol=kNN  
 .s:'nol nol=1 s ceh=nol,ceh1=ceh,ceh2=0
 .i $g(xNol),nol-xNol q
 .s:%R["a=" da=+$p(%R,"a=",2) s:da'?8n da=0 i $l($g(did)) s:did["a=" did=+$p(did,"a=",2) s:$g(did)?8n&'$g(da) da=did  
 .i OfirO'=fir!(fir>99) s T=0,firma=$$firma^fir(fir),OfirO=fir
 .s kurs=$$vk^fin(c_" "_s,d8) s:'kurs kurs=1 s cLs=c*kurs s:kurs-1 s=s_" "_kurs
 .i ceh=1 s ^cR(NN,0)=c*kurs_" "_c,^("DOK")=DOKf
 .f %=1:1:5 s cR(%)=$p(ccR,"/",%),sR(%)=kurs*cR(%) d
 ..  x " s cR"_%_"=cR(%),sR"_%_"=sR(%)"
 ..  i ceh=1 s:cR(%) ^(%)=cR(%)_" "_d8_"<mx@"_%I
 .q:$$q
 .s:'s s=.00000001
 .s ss=s,qq=q,cR=0,s2=q*c*kurs,q2=q,(q0,q3,s0,s3)=0
 .s %=$p(ss,"-",2) s:'%&fa %=fa s:% %=100-%/100 ;; %=bezAtlaide
 .i s["+",s'[" +",$e(s)'="+" s s=$$trw^UST(s,"+"," +")
 .i d8<%XD81 s q0=q2,s0=s2,(q2,s2)=0
 .s sD=0,sK=s,Sp=$p(s,"p",2)+$p(s," +",2),Sb=s-Sp s:s[" +" Sb=+s
 .s %=$$koko(s)
 q
Saiz7V q
PPRV 
PAVV n ssSumma,K,T,Ch k %koko n PPR,PAV s (PPR,PAV)=0,Ch="PAV"
 k %I f %1="Firma","PAVsp","PPRsp","pps","FRqsp" d ^USX
 s %I="",NN="",%I2="",bak=2310,K=5310,xNN=$g(xNN),ob=0,(OfirO,OfirmaO,DOK)="" k obj
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) s DOK=$qs(%I,1) d PPRS s (OfirO,OfirmaO)=""
PPRS d:$d(%tSelect)  i '$d(%tSelect) s DOK="" f  s DOK=$o(@("^"_%FILE)@(DOK)) q:DOK=""  d  q:$g(%koko(%FILE))=-1
 . S %R=^(DOK),(%I2,%I)=$NAME(^(DOK)),DOKf=DOK,(sAtla,sVe,DOKfin)=0
 . i $p(%R,%B,2)<20140000,%gm>201400 q
 . i $g(xd8start)?8n,$p(%R,%B,2)<xd8start q
 . s ob="" i %R["ob=" s ob=$p($p($p(%R,"ob=",2),%B)," "),%R=$$trw^UST(%R,"ob="_ob)
 . i DOK[" ",mxConfig[":noBlank:" s DOKf=$tr(DOK," ") s:'$l(DOKf) DOKf=0
 . i $p(DOK,".",2),%I["^PAV(" s o=$p(DOK,".") i $l(o),$d(^PAV(o)) s DOKf=o
 . i DOKf[.2,DOKf_%B[(.2_%B) s o=$p(DOKf,".2") i $l(o),$d(^(o)) s DOKf=o
 . i %I["^PAV" s PAV=DOK
 . i %I["^PPR" s PPR=DOK i $g(^PPRx3(PPR,"noActive")) q 
 .s (Piez,Pi,piez)="" X %XG(%FILE) s d8=d,gm=$e(d8,1,6) q:d8>%XD82
 .s (Piez,piez)=$s($l(Piez):Piez,$l(Pi):Pi,1:piez),fir=san,ssSumma=ss_" "_summa,ossSum18=summa,DOKfi=DOKfin,DOKfin=0
 .s %atla=$p(sVe,"%a=",2) i '%atla,%FILE="PAV" s %atla=$p(sVe,"-",2)
 .i sVe["pvn="!%atla,%FILE["P" d ssum(%I,%atla) s ss=ss-sAtla
 .s (ceh,ceh1,nol,nol0)=+pie,ceh2=0 s:'nol nol=1 i san,san<2222 s ceh2=+san
 .s cch=+ceh1_"-"_+ceh2 i %FILE["PPR",$g(^PPRx3(PPR,"sAtla")) s ss=ss-@$zr
 .s kPVN=1,rrt="realizacija",sZak=0,kNN=0,fir=san
 .s:OfirO=fir firma=OfirmaO s:OfirO'=fir!(fir>99) T=0,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma
 .q:$$q  i $g(xNol),nol-xNol q
 .s kurs=$$vk^fin(ssSumma,d8) s:'kurs kurs=1 s kurssumm=kurs s:+sP[".0000" sP=0
 .s dk=1,ss=ss_" +"_sP_" "_kurs,(sD,sK,cFIFO,sFIFO)=0 i %R["ob=" s ob=$p($p($p(%R,"ob=",2),%B)," ")
 .i $l(%V),$d(%V(%V,"w0")) d @%V q
 .i '$g(xNol) s %=$$koko(ss) i %FILE="PPR" s o=$o(^PPRx3(DOK,"DK:")) d:o["DK:"
 .. s S=^(o),o=$p(o,":",2) i o,S,$$koko(S,o)
 .s dk=0,%iPP="^"_%FILE_"sp(DOK)",nnPP=""
 .i '$d(kokoFile) s kokoFile=" ",o="^koko" f  s o=$q(@o) q:o=""  d
 ..  s:kokoFile'[(" "_$p(@o,%B,6)_" ") kokoFile=kokoFile_$p(@o,%B,6)_" "
 .i kokoFile[(%FILE_"sp") s dk=1
 .n kurs,dof f  s nnPP=$o(@%iPP@(nnPP)) q:nnPP=""  d
 ..s %R=^(nnPP),%I2=$NAME(^(nnPP)) i xNN'="",%R'[xNN q
 ..x %XG(%FILE_"sp") s NN=k i k="" s %mxWarng(%I2)=" materiala kods - -  ?? "_%R q
 ..i $l(xNN)>1,NN'=xNN q:xNN'[":"
 .. i %R["ob=" n ob s ob=$p($p($p(%R,"ob=",2)," "),%B)
 ..s nos=$$nos(NN,%XD82) i -kNN[-7,'nol0 n nol s nol=kNN
 ..s cena0=c,nn=nnPP,kurs=kurssumm i $g(mxTestDB) s o=q*c-s i o*o>.001 s %mxWarng(d8,%I2)="q="_q_"  c="_c_"  s=?? "_s_"    bet pareiz.summa=q*c="_(q*c)_"    k{316}uda="_(s-(q*c))
 ..s vc=+$p(c,"z",2) i 'vc,c["z" s vc=+c
 ..s:'vc vc=+$$vcdCena(nol,NN,d8) s vcLs=vc,Ch=0 i +sert?4n,sert'[".",$l($p(sert,+sert,2)) s Ch=$p(sert,+sert,2)
 ..s cZak=+vc s:'c c=cZak s svc=q*vc,sZakLs=q*cZak s:'kurs kurs=1
 ..s (s3,sZak)=q*cZak/kurs_" "_kurs,q3=q
 ..s (q0,q2,s0,s2)=0 i d8<%XD81 s q0=-q3,s0=-s3,(q3,s3)=0
 ..s ss=s_" "_kurs_" "_c,dk=0,sD=ss,sK=0,loo=1,ossSum18=ossSum18-s-$j(s*$s(d8>20120700:.21,d8>20110000:.22,d8<20090000:.18,1:.21),0,2)
 ..s %=$$koko(ss) i $d(dof),$l(dof)>2 s DOKfin=$p(dof," "),%=$p(dof," ",2) s:$l(%) fir=%,firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma i $l(DOKfin)>1,1_$$koko(ss) k dof
 .i ossSum18,(ossSum18*ossSum18)<.0004,mxConfig[":ossSum18:" s %=$$koko(ossSum18_"o")
 .k ossSum18
 .q:'DOKfi  s DOKfin=DOKfi,%I2=%I,DOKf1=DOKf n DOKf
 .f DOKfi=1:1 s o=$p(DOKfin,",",DOKfi) q:o=""  s DOKf=DOKf1_"//"_$p(o,":"),(nos,s)=$p($$trw^UST(o,"5%"," 5%"),":",2),%=$$koko(s)  
 q
saFi ;\sanem pa firmam\firma,-d8,DOKf\Sp,Sb,s,sB,sP,s2,q2,s2R=kurs\\pps Saiz7 atg\@p1sR
 q:d8<%XD81  s c2R=$g(^cR(NN,2)),s2R=q2*c2R  n s2 s s2=q*c
 i xDOK'="" s o=DOKf n DOKf s DOKf=o_"."_(100+n)
 s sP=$p(s,"+",2)+$p(s,"p",2),sB=s-sP
 i kurs,kurs-1 f o="Sp","Sb","s","sB","sP","s2","s2R" s @o=@o*kurs
 g w1
saFiL i $$l("d8 DOKf  firma s2 s2R s sB sP  Sp Sb kurs ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
pard1 ;\Pardo{353}ana pa datiem PPR\-d8,DOKf\ss,sP=firma,kurs\\PPR PAV\k qq,ss s %V(%V,"w0")=1,iii=0 k ^oMX(%USID)
 q:d<%XD81
 i xNol,pie-xNol q
 i kurs,kurs-1 s ss=ss*kurs,sP=sP*kurs
 g w1
pard1L s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 s ssP=ss+sP
 i d,$$l("d firma DOKf ss.__ sP.__ ssP.__ kurs w1")
 i d s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
parf ;\pard. pa firmam Ls\firma,-d8,DOKf\ss,sP=kurs,I2\\PPR\k qq,ss s %V(%V,"w0")=1,iii=0 k ^oMX(%USID)
 q:d<%XD81  s I2=%I2
 i xNol,nol-xNol q
 i kurs,kurs-1 s ss=ss*kurs,sP=sP*kurs
 g w1
parfL s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)  s ssP=ss+sP
 i %E="firma" s d=firma
 i $$l("d DOKf ss.__ sP.__ ssP.__ kurs  I2 ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
parfq ;\Pardosana pa dokumentiem (daudz.)\-d8,-firma,DOKf,nn\q,s3=c,NN,nos,%I2,kurs\\PPR PAV\\k qq,ss s %V(%V,"w1")=1,iii=0 k ^oMX(%USID)
 i xNol,xNol-nol q
 q:d<%XD81  q:dk  q:%I2'["sp("  n s3 s s3=q*c*kurs
 g w1
parfqL s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="DOKf" s nos="*"
 i $$l("d  firma  DOKf  nos q c.___ s3.__ %I2   kurs")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
parmaF ;\Pardosana pa firmam (daudz.)\firma,-d8,-DOKf,nn\q,s3=m,NN,nos,c,%I2\\PPR PAV\k qq,ss s %V(%V,"w1")=1,iii=0 k ^oMX(%USID)
 g parma
parmaFL g parmaL
parma ;\Pardosana pa datiem-firmam (daudz.)\-d8,firma,-DOKf,nn\q,s3=m,NN,nos,c,%I2,kurs\\PPR PAV\k qq,ss s %V(%V,"w1")=1,iii=0 k ^oMX(%USID)
 q:d<%XD81  q:dk  q:%I2'["sp("  q:$e(k)="-"  n s3 s s3=q*c*kurs
 g w1
parmaL s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="DOKf" s nos="*"
 i $$l("d firma DOKf nos  q  c.___ s3.__ %I2  kurs ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
invs ;\Inventarizacijas saraksts\NN\q0,q2,q3,q4,s4=cZak,nos,m,kurs\\pps atg PAV PPR Saiz7\k qq,ss s %V(%V,"w1")=1,iii=0 k ^oMX(%USID)
 s q4=q0+q2-q3,s4=cZak*q4*kurs
 q:dk
 g w1
invsL s q4=q0+q2-q3,cR=$g(^cR(NN,2)),cRn=2_" "_cR
 i 'cR f cRn=5:-1:0 i $d(^(cRn)) s cR=^(cRn),cRn=cRn_" "_cR q
 s s4R=$j(q4*cR,0,2)
 i %E="NN"  f %="%ggmm" s ss(%)=$g(ss(%))+s4R
 e  s s4R=$g(ss(%E)) k ss(%E)
 i 'q4,'s4R q
 i %E="NN" s:s4R<0 s4R=s4R_"<mx ic7" s:cRn<2 cRn=cRn_"<mx ic6"
 s s4=s4R,cZak=cR
 i %E="NN",'q4,'q2,'q3,1_$$%RsuM^USPRINT(-1) q
 s:%M[%W q4=0
 i $$l("NN  nos  m  cZak    q4      s4   cRn kurs")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q 
cc(NN,d0,qq) 
 q $$NNcFIFO(1,NN,d0,qq)
ssum(%I,atla,k118,%pvn) 
 s (ss,qq,sP)=0,summa=%I_"?nav",okurs="" s:$g(d)'?8n d=$g(d8)
 n %FILE,sp,oo,%pvn,o,s,q,k,s0pvn,S0pvn  s (s0pvn,S0pvn)=0
 s %FILE=$e($p(%I,"("),2,99)_"sp",k118=$g(k118,1)
 i '$d(%pvn) s %pvn=$s(d>20120700:.21,d>20110000:.22,d<20090000:.18,1:.21) i $g(sVe)["pvn=" s %pvn=$p(sVe_$g(sP),"pvn=",2)/100
 i '$d(%LI(%FILE)) s %1=%FILE d ^USX
 s o="^"_%FILE_"("_$p(%I,"(",2,9)
 q:'$d(@o)
 s %I=$NAME(@o) n @($tr(%LI(%FILE),"~"))
 s n="",ss=0 f  s n=$o(@%I@(n)) q:n=""  d
 .s %R=^(n) x %XG(%FILE)
 .i $l(c)-$l(+c)>2 s okurs=okurs_c_" "
 .s:'s s=$p(s,"r",2) s:'s s=$p(c,"r",2)*q  s qq=qq+q
 .i 's q:mxConfig'[":sp=0:vc:"&(mxConfig'[":UPTK:")  
 .i 's s o="" f  s o=$o(^NNd(o)) q:o=""  s s=$$vcdCena(o,k,d)*q q:s
 .s ss=ss+s,sp=s*%pvn s:s_" "[" 0% " s0pvn=s0pvn+sp,S0pvn=S0pvn+s
 s sP=$j(ss*%pvn-s0pvn,0,2),sAtla=0
 i $g(atla) d  s sP=$j(ss-sAtla*%pvn,0,2)
 . s sAtla=atla s:sVe_atla'["EUR" sAtla=$j(ss*atla/100,0,2) s:sAtla>ss sAtla=0
 s summa=ss+sP-sAtla s:s0pvn sP=sP_" S.pvn.0%="_S0pvn_" pvn.0%="_s0pvn
 q
ssum2(%I,atla,k118,%pvn) 
 s (ss,qq,sP)=0,summa=%I_"?nav" s:$g(d)'?8n d=$g(d8)
 n %FILE,sp,%pvn,s,q,k 
 s %FILE=$e($p(%I,"("),2,99)_"sp",k118=$g(k118,1)
 i '$d(%pvn) s %pvn=$s(d>20120700:.21,d>20110000:.22,d<20090000:.18,1:.21) s:$g(sVe)["pvn=" %pvn=$p(sVe,"pvn=",2)/100
 i '$d(%LI(%FILE)) s %1=%FILE d ^USX
 s o="^"_%FILE_"("_$p(%I,"(",2,9)
 q:'$d(@o)
 s %I=$NAME(@o) n @($tr(%LI(%FILE),"~"))
 s n="",ss=0 f  s n=$o(@%I@(n)) q:n=""  d
 .s %R=^(n) x %XG(%FILE) s:'s s=$p(s,"r",2) s:'s s=$p(c,"r",2)*q s c=c/(1+%pvn) s qq=qq+q
 .i 's q:mxConfig'[":sp=0:vc:"&(mxConfig'[":UPTK:")
 .i 's s o="" f  s o=$o(^NNd(o)) q:o=""  s s=$$vcdCena(o,k,d)*q q:s
 .s s=s/k118,ss=ss+s,sp=s*%pvn
 s ss=$j(ss,0,2),sP=$j(ss*%pvn,0,2),sAtla=0
 i $g(atla) d  s sP=$j(ss-sAtla*%pvn,0,2)
 . s sAtla=atla s:sVe_atla'["EUR" sAtla=$j(ss*atla/100,0,2) s:sAtla*2>ss sAtla=0
 s summa=ss+sP-sAtla
 q
PPRa q
PAVcena(NN,nc) 
 ;      cena no ^pps
 n di,o,n s:'$g(nc) nc=1
 s n="" f  s n=$o(^NNd(n)) q:n=""  i $d(^NNd(n,NN)) s di=%XD82+1_"^" d
 .f  s di=$o(^NNd(n,NN,di),-1) q:di=""  i di["^pps(" s o(di)=^(di)
 s di=$o(o(""),-1) q:'di 0
 s o=$p(o(di),%B)
 q $p(o,"/",nc)
F12(ce,%k,d,p) 
 n Q,o,dd
 s o=%K s:o_"$"["*$" o=$tr(%K,"*")
 i $tr($g(^PN(%k)),%LAT,%lat)[o s %SEL(%k)=%g_%B_%B_%
 else  d
 . s:'$g(d) d=99990000 s dd=$o(^MNd(%k,d),-1) q:'dd
 . i $tr($g(^MNd(%k,dd)),%LAT,%lat)[o s %SEL(%k)=%g_%B_%B_%
 q:'$d(%SEL(%k)) ""  q:%K'=o ""
 s o=$g(p) s:o="" o=$g(pie) s:o="" o=1 s Q=$$NNq(o,%k,d)
 i Q'>0 k %SEL(%k) q ""
 s $p(%SEL(%k),%B,2)="  nol="_o_" atlikums="_Q_"  "
 q ""
NNqRest(d6min) 
 i $$icFIRMA^fir
 s d6min=0
 k ^ovcdCena,^ovcdNNdi,^vc3,^ovcz,^oNNdklk,^vcdklk,^vcklk,^klkvar,^oLsEURmk
 k ^NN,^NNd,^NNob,^NNklk,^vcd,^vcz,^vcz2,^vce,^vci,^ovcd(%USID)
 n onnn,%FILE,%I,%R,o,zi,nol,nol0,d,d8,san,san0,%R,q2,q3,k,NN,kurs,okurs,flagZ,NNcena
 s onnn=0,%B=$c(254),flagZ=mxConfig[":z:"
 i %gm>201400 m ^NNd=^NNd2013 d
 .  s zi="^NNd" f  s zi=$q(@zi) q:'$l(zi)  s o=+@zi i o,zi'["EUR" s $p(@zi,%B)=o/.702804_"_"_o
 f %FILE="Saiz7","pps","atg","PPRsp","PAVsp","ppq","ppq6" i $d(^AL(%FILE)) k %R d
 . s %1=%FILE d ^USX s %I="^"_%FILE ;; i mxConfig[":^mk:",%FILE'="mk",mxConfig'[":+^mk:" q
 . i %FILE="atg",$d(^invFakt) q  ;;  20170110 big-7
 . ;; i %FILE="mk",mxConfig'[":^mk:",mxConfig'[":+^mk:" q
 . i %FILE'["sp",%gm>201400,%FILE'["mk" s %I=%I_"(20140000)" 
 . q:'$l($q(@%I))
 . i '$d(%XI(%FILE)) s %mxWarng(%FILE)=" -- {1086}{1073}{1085}{1086}{1074}{1080}{1090}{1077} AL -- " q
 . f  s %I=$q(@%I) q:%I=""  s %R=@%I d
 ..  s (d8,d,c,q2,q3,ob,q,nol0,san0)=0,(NN,k,sert,okurs,lidz)="",kurs=1 k obj
 ..  x %XI(%FILE),%XG(%FILE) s san=0,d8=d s:q q2=q
 ..  i %FILE["sp" s d8=$p($g(@$p(%I,"sp(")@($qs(%I,1))),%B,2) i d8<20140000,%gm>201400 s %=$qs(%I,1) s:%'=+% %=""""_%_"""" s %I=$p(%I,"(")_"("_%_",%B)" q
 ..  q:d8<20140000&(%gm>201400)  q:d8>20140000&(%gm<201400)
 ..  I %FILE["PAVsp" s NN=k,q2=0,q3=q s:flagZ c=c_"z" d  q:'$l(%R)
 ...    i s*q>0,s/q-c s c=s/q_" "_c
 ...    i c["z",'$p(c,"z",2) s $p(c,"z",2)=+c
 ...    i $d(%R(PAV)) s %R=%R(PAV),ob=$g(%R(PAV,"ob"))
 ...    else  k %R s %R=$g(^PAV(PAV)),%R(PAV)=%R
 ...    i %R="" k @%I q
 ...    s d8=$p(%R,%B,2),(nol,nol0)=$p(%R,%B,3),(san,san0)=$p(%R,%B,4),sVe=$p(%R,%B,5) s:'nol nol=$s(nol="G":11,nol="F":12,nol="K":13,1:1) s:'san san=$s(san="G":11,san="F":12,san="K":13,1:7777)
 ...    s:san san=san\1 s:nol nol=nol\1
 ...    s ob=sert s:ob["ob=" ob=$p($p(ob,"ob=",2),%B)
 ...    i %R["ob=" s ob=$p($p($p(%R,"ob=",2)," "),%B)
 ...    s:"0 - "'[ob %R(PAV,"ob")=ob
 ...    i mxConfig[":^klk:",$d(^klk(NN)) s o=$$NNklk(nol,san),d8=.1
 ..  I %FILE["PPRsp"  s NN=k,q2=0,q3=q s:flagZ c=c_"z" d  q:'$l(%R)
 ...    i s*q>0,s/q-c s c=s/q_" "_c
 ...    i c["z",'$p(c,"z",2) s $p(c,"z",2)=+c
 ...    i $d(%R(PPR)) s %R=%R(PPR)
 ...    else  k %R s %R=$g(^PPR(PPR)),%R(PPR)=%R
 ...    i %R="" k @%I q
 ...    s d8=$p(%R,%B,2),(nol,nol0)=$p(%R,%B,3),(san,san0)=$p(%R,%B,4) s:'nol nol=$s(nol="G":11,nol="F":12,nol="K":13,1:nol) s:'san san=$s(san="G":11,san="F":12,san="K":13,1:san)
 ...    s:'nol nol=$s(mxConfig[":nol^PPR=":+$p(mxConfig,":nol^PPR=",2),1:1)
 ...    s:mxConfig[":nol=1:" nol=1 s:san san=san\1 s:nol nol=nol\1
 ...    i %R["ob=" s ob=$p($p($p(%R,"ob=",2)," "),%B)
 ..  i %FILE="ppq"   s q2=0,q3=q,(nol,nol0)=+$p(piez,"n",2),NN=+piez
 ..  s:'d8 d8=d  q:d8'?8n  q:$e(NN)="-"  q:"0 -"[NN  i $g(^PN(NN))[9999,$p(^(NN),%B,4)=9999 q
 ..  s onnn=onnn+1
 ..  i %FILE="atg" s nol=p,nol0=0,atb="gra1",ob=0,q2=q,q3=0 s:q<0 q3=-q,q2=0
 ..  i %FILE="pps" s nol=1,nol0=0 s:'atb atb=$s(atb="G":11,atb="F":12,atb="K":13,1:atb) s:atb (nol,nol0)=+atb\1,ob=$p(atb,".",2) s:%R["ob=" ob=$p($p($p(%R,"ob=",2)," "),%B) d  s:ccR $p(ccR,"/")=c,c=ccR
 ...  s:c ^cR(NN,5)=c_" "_d8 i q*s>0,s/q-c s c=s/q_" "_c
 ...  i $l($tr(c_s,"QWERTYUIOPASDFGHJKLZXCVBNM"))>2 s o=$$vk^fin(c_" "_s,-d8) i o,o-1 s c=c*o,kurs=o,okurs=" kurs="_o
 ...  ;; i "0 - ."'[ob n m s ^PAV(d8_":"_DOK_"."_n_"-pps")=%B_d8_%B_nol_%B_ob_%B_q,%=$qs($zr,1) k ^PAVsp(%) s ^PAVsp(%,1)=%B_NN_%B_$$nos^tirgus(NN)_%B_q_%B_$g(m)_%B_c_%B_(c*q)_%B_"ob="_ob
 ..  i %FILE="ppq6"  s obo=$p(nol,".",2),(nol0,nol)=nol\1 s:$l(obo) ob=obo
 ..  i %FILE="Saiz7" s ob="" d
 ...  i $l($tr(c_sK,"QWERTYUIOPASDFGHJKLZXCVBNM"))>2 s o=$$vk^fin(c_" "_sK,-d8) i o,o-1 s c=c*o,kurs=o,okurs=" kurs="_o
 ...  s obo=$p(nol,".",2),(nol0,nol)=nol\1 s:$l(obo) ob=obo s:q c=sK-$p(sK,"p",2)/q*kurs s:%R["ob=" ob=$p($p($p(%R,"ob=",2)," "),%B) 
 ...  ;; i "0 - ."'[ob n m s ^PAV(d8_":"_DOK_"."_n_"-Saiz7")=%B_d8_%B_nol_%B_ob_%B_q,%=$qs($zr,1) k ^PAVsp(%) s ^PAVsp(%,1)=%B_NN_%B_$$nos^tirgus(NN)_%B_q_%B_$g(m)_%B_c_%B_(c*q)_%B_"ob="_ob
 ..  i %R["ob=" s ob=$p($p($p(%R,"ob=",2)," "),%B) q:ob=-1
 ..   i mxConfig[":UPTK:" d  q:NN'?8n
 ...     i %FILE="ppq6",nol=4,$l(NN)<2 s NN=11111111
 .. q:$l(NN)<2  i san=7777!'nol0,%FIRMA'["AISBERGS" s nos=$$nos^tirgus(NN,d8) s:-kNN[-7&'nol0 nol=kNN  s:'nol nol=7777.7
 .. i san=7777,kNN>3333 s san=kNN
 .. s:" 0 -- ? . "'[ob ^NNob(ob,d8_%I)=q_" n="_nol_$s(san:"->"_san,1:"")
 .. i c["z" s z=$p(c,"z",2) s:'z z=+c*kurs i z>0 s ^vcz(NN,d8)=z
 .. i c'["z","^ppq6(^pps(^Saiz(^Saiz7(^mk("[("^"_%FILE_"(") s ^vcz2(NN,d8)=+c_%FILE i 'c,%FILE="pps",s,q s c=+$j(s/q,0,6)*kurs_"s/q",^vcz2(NN,d8)=+c_%FILE
 .. i lidz,$p(lidz,".",2) s:'$p(lidz,".",3) $p(lidz,".",3)=$e(d8,1,4) s:$p(lidz,".",3)<100 $p(lidz,".",3)=$e(d8,1,2)_$p(lidz,".",3) s lidz=$$gmd^MXD(lidz,8)
 .. s:lidz'?8n lidz="" s:lidz lidz=" l="_lidz i $l(mxConfig)>14,mxConfig[":mat-vc-ggggmm:" s o=d8 n d8 s d8=$e(o,1,6)_"00"
 .. i san s ^NNd(san,NN,d8_%I)=c_%B_q3_%B_q2_okurs_lidz
 .. i nol s ^NNd(nol,NN,d8_%I)=c_%B_q2_%B_q3_okurs_lidz
 s n="" f  s n=$o(^invFakt(n)) q:'$l(n)  s d=1 f  s d=$o(^invFakt(n,d)) q:'d  s NN="" f  s NN=$o(^invFakt(n,d,NN)) q:'$l(NN)  s zr=$zr,q=$g(^(NN,"q")),s=$g(^("s")),cena=$p($g(^PN(NN)),%B,6) s:cena s=q*cena s ss=0 i $l(q),q'="-" s ^NNd(n,NN,d_zr)="inv"_s_%B_"inv"_q k:q="-" @zr 
 i $$vcs(d6min*100) 
 q onnn
vcs(d8min) ;  create ^vcd ^vcm
 n n,NN,gm,d8,di,o
 s:'$d(^vcd) d8min=0 k:'d8min ^vcd,^vci,^vce,^vcm
 s:d8min<11111111 d8min=11111111
 s n=.1,NN="" f  s n=$o(^NNd(n)) q:n=""  d
 .f  s NN=$o(^NNd(n,NN)) q:NN=""  s o=$g(^NNblockM(NN)) d
 .. s di=1 f  s di=$o(^NNd(n,NN,di)) q:'di  s m=$e(di,1,6),c=^(di),q2=$p(c,%B,2),q3=$p(c,%B,3) d
 .. .  i o,o<%gm,o<201900 k ^NNd(n,NN) q
 .. .  i c["inv" s c=+$tr(c,"inv"),q2=$tr(q2,"inv") s:q2 c=c/q2
 .. .  s ^(1)=$g(^vcm(n,NN,m,1))+(c*q2),^(2)=$g(^(2))+q2,^(3)=$g(^(3))+q3
 s n=.1,NN="" f  s n=$o(^vcm(n)) q:n=""  f  s NN=$o(^vcm(n,NN)) q:NN=""  d
 . s m=1,s0=0,q0=0,vcm=0  
 . f  s m=$o(^vcm(n,NN,m)) q:'m  s s2=^(m,1),q2=^(2),q3=^(3),(^(0),vcm)=$s(q0+q2>0:s0+s2/(q0+q2),1:vcm),(^(4),q0)=q0+q2-q3,(^(5),s0)=s0+s2-(vcm*q3)
 ;
 s n=.1,NN="" f  s n=$o(^NNd(n)) q:n=""  d
 .f  s NN=$o(^NNd(n,NN)) q:NN=""  d:'$d(^klk(NN))
 .. s d8=+d8min f  s d8=$o(^vcd(n,NN,d8)) q:'d8  k ^(d8)
 .. s di=+d8min_"^",d8=+$o(^NNd(n,NN,di)) q:'d8
 .. f  s di=$o(^NNd(n,NN,di)) d:di-d8  q:'di
 ...  s o=$o(^vcd(n,NN,d8),-1),o=$g(^(+o)),o=$$vcd(n,NN,d8,o),^vcd(n,NN,d8)=o,d8=+di
 q:'$d(^klk) ""  q:mxConfig'[":^klk" ""
 ;
 s n=.1,NN="" f  s n=$o(^NNd(n)) q:n>999999!'n  d
 .f  s NN=$o(^NNd(n,NN)) q:NN=""  d:$d(^klk(NN))
 .. s d8=+d8min f  s d8=$o(^vcd(n,NN,d8)) q:'d8  k ^(d8)
 .. s di=+d8min_"^",d8=+$o(^NNd(n,NN,di)) q:'d8
 .. f  s di=$o(^NNd(n,NN,di)) d:di-d8  q:'di
 ...  s o=$o(^vcd(n,NN,d8),-1),o=$g(^(+o)),^vcd(n,NN,d8)=$$vcd(n,NN,d8,o),d8=+di
 q ""
vcq(no,NN,d8,oV) 
 q 0
vcd(no,NN,d8,oV) 
 n di,%I,%r,o,q2,q3,Q2,Q3,S2,S22,Q22,S2v,S3,s2,c,z,Q,S
 s (Q0,Q)=+$p(oV,"Q=",2),(S0,S)=+$p(oV,"S=",2),q2=0
 i +d8'?8n s d8=$e(+d8_11111111,1,8)
 s di=+d8_"^",(z,Q2,Q3,S2,S3,S22,Q22,S2v)=0 k ^vci(no,NN,d8)
 f  s di=$o(^NNd(no,NN,di)) q:di-d8  d
 . s %I=$e(di,9,99) i '$d(@%I) k ^NNd(no,NN,di) q
 . i $e(%I,2)="P",$e(%I,4)=")" s o=$e(%I,1,4),%=$qs(%I,1),%I=$name(@o@(%)) q:'$d(@%I)  ;=zr
 . s %r=^NNd(no,NN,di),q2=$p(%r,%B,2),q3=$p(%r,%B,3)
 . i 'q2,'q3,q2["inv" q  ;;  s q2=$tr(q2,"inv"),s=+$tr(%r,"inv") i s,q2 s (Q0,Q,S0,S,s2,Q2,Q3,S2,S3,S22,Q22,S2v,c)=0,%r=(s/q2)_"z"_(s/q2)_%B_q2
 . s ^vci(no,NN,d8,%I)="",z=0
 . i $p(%r,%B)["z" s z=-.000000001,o=$p($p(%r,%B),"z",2) s:o>0 z=o
 . s Q2=Q2+(q2'["tr"*q2),Q3=Q3+q3,s2=0
 . i q2 d  i s2 s S22=S22+s2,Q22=Q22+(q2'["tr"*q2)
 .. i "^ppq6^pps^Saiz^Saiz7^mk^invzzzFakt^"[($p(%I,"(")_"^")!(q2=q3)!z s s2=q2*%r,^ovcdNNdi(NN,di)=%r q
 .. i %r["var=" n var,qs,c s var=+$p(%r,"var=",2),qs=+$p(%r,"qs=",2) s:'qs qs=(q2'["tr"*q2)+q3 s s2=$$sklkd(no,NN,qs,d8,var)
 ;
 s Q=Q+Q22,S=S+S22,c=0  i Q>0,S>0,Q22'<0,S22'<0 s c=S/Q
 i Q2>0,'Q22,'Q0,'S0 s o=$o(^ovcdNNdi(NN,d8_%B),-1) s:o c=+^(o)
 s:z c=z_" z  "_c i 'z d:'c
 .i Q22>0,S22>0 s c=S22/Q22 q
 .s o=$o(^vcz(NN,d8+.1),-1) i o,o>(d8-10000) s c=^(o)_"z"_-o q:c
 .s o=$o(^vcz(NN,d8)) i o,o<(d8+33) s c=^(o)_"z+"_o,^ovcz(NN,d8)=c q:c
 .s c=+oV_"vc" s:z c=z_"z" q:c
 .s o=$o(^vcz2(NN,d8+.1),-1) i o,o>(d8-10000) s c=^(o)_"z"_-o q:c
 .s o=$o(^vcz2(NN,d8)) i o,o<(d8+33) s c=^(o)_"z+"_o,^ovcz(NN,d8)=c q:c
 .s o=$o(^ovcdNNdi(NN,d8_%B),-1) i o s c=+^(o) q
 .i no<999 n mm f mm=100:100:300,10000:10000:90000 d  q:c>0
 .. n nn s nn=0
 .. f  s nn=$o(^NNd(nn)) q:nn=""  i $d(^(nn,NN)),1_$g(^(NN,1)) s di="" d  q:c>0
 .. . f  s di=$o(^(di),-1) q:di=""  i di>(d8-mm),di'>d8,+di?8n s c=+^(di)_"n="_nn_di q:c>0
 ;
 i Q2-Q22 s S2v=Q2-Q22*c_"vc",S=S+S2v
 s S2=S22+S2v,Q=Q-Q3-Q22+Q2,S3=Q3*c,S=S-S3 
 s:q2'["tr"&'Q S=0 i Q>0,S<0 s S=Q*c
 q c_%B_"Q="_+Q_%B_"S="_+S_%B_"Q2="_+Q2_%B_"S2="_+S2_%B_"Q3="_+Q3_%B_"S3="_+S3_%B_"Q0="_Q0_%B_"S0="_S0_%B_"Q22="_Q22_%B_"S22="_S22
 ;
sklkd(nol,NN,q,d8,var) 
 n n,%R,qk,zr,ss,k,o,r,vc,onol,ingr
 s ss=0,n="" s:'$g(var) var=+$p(q,"/",3)
 q:'$d(^klk(NN,+var)) "not^klk"
 f  s n=$o(^klk(NN,var,n)) q:n=""  s %R=^(n),ingr=$p(%R,%B,2) d
 . s k=$p(%R,%B,5) s:'k k=+$p(mxConfig,"klk=",2) s:'k k=1
 . s norma1=$p(%R,%B,3)/k,norma2=$p(%R,%B,4)/k,qk=norma1*q q:'qk
 . f onol=nol\1:-1:1 s o=$o(^vcd(onol,ingr,d8+.1),-1),vc=$g(^(+o)) q:vc
 . s s=vc*qk,ss=ss+s
 i q,ss s ^vcdklk(0,NN,d8,var)=ss/q_" "_q
 q ss
 ;
vcdCena(n,NN,d8) 
 n c,c1,d,zr,o,cUPT,d0,vc,S,Q,q2 s (zr,c,c1,d)=" ? " s:'d8 d8=%XD82
 s cUPT="" i d8>20140000,%FIRMA["UPTK" s o=$o(^MNd(NN,20140000)) i o s cUPT=$p(^(o),%B,2)_"_"
 i %gm>(%FIRMA["Balo"+2019_"00") q:$d(^ovcd(%USID,n,NN,d8)) ^(d8)  s (Q,S,vc)=0 d  s %=$o(^vcd(n,NN,d8+.1),-1),(%,^ovcd(%USID,n,NN,d8))=vc_" "_$g(^vcd(n,NN,+%))_" d0="_d0 q %
 .f o=0:1:5 s d0=$o(^NNd(n,NN,d8-10000_%B),-1),d0=d0\10000-o_"0000^" d  q:vc  
 .. s d=d0 f  s d=$o(^(d)) q:d>d8!'d  s c=^(d),q2=$p(c,%B,2) i q2>0,c>0,c'["tr" s Q=q2+Q,S=q2*c+S,vc=S/Q
 i 'n s o="" f  s o=$o(^vcd(o)) q:'o  i $d(^(o,NN)) s n=o
 i n s o=$o(^vcd(n,NN,d8+.1),-1) i o?8n,o>19900000 s d=o,c1=cUPT_$g(^(d)),zr=$name(^(d)) q:c1>0 c1_" d="_d
 n Q2,S2,nn,mm,di s nn=0,c=" ?? "
 i c1'>0,$o(^vcd(n,NN,0))>d8 q 0
 i c1'>0 q c1  ;;  s ^ovcdCena(n,NN,d8)=c1 q c1
 ;
 f mm=100:100:$e(d8,5,6)*100,10000:10000:90000 d  q:c>0 
 . s nn=0,c=" ?? "
 . f  s nn=$o(^vcd(nn)) q:nn=""  i $d(^(nn,NN)) s o=$o(^(d8+.1),-1) i o>(d8-mm),o?8n s d=o,c=+^(d) q:c>0
 i c>0 s:zr["^"&n $p(@zr," ")=+c1 q +c_" "_c1_" 2d="_d_" no="_nn
 f mm=10000:10000:90000 d  q:c>0 
 . s nn=0,c=" ??? "
 . f  s nn=$o(^NNd(nn)) q:nn=""  i $d(^(nn,NN)),1_$g(^(NN,1)) s di="" d  q:c>0
 ..  f  s di=$o(^(di),-1) q:di=""  i di>(d8-mm),di'>d8,+di?8n s d=di,c=+^(di) q:c>0
 i c>0 s:zr["^"&n $p(@zr," ")=+c
 ;;  i c'>0 s ^ovcdCena(n,NN,d8+.2)=c 
 q +c_" "_c1_" 3d="_d_" ??? no="_nn       
 ;
Q(no,NN,d0,xmsm,zero) 
 k r,q023 q:NN=""!(no="") "???"
 s:'$g(d0) d0=%XD81_-%XD82 s:d0?6n d0=d0_"01-"_d0_33
 n c2,%,%2,%3,di,Q,%I,%I2,ccR,Qminus,d2,Q2,Q3,Q0,Q2vc,S2vc,Q0vc,S0vc,z0,z2,c,s2,ss2
 n gm,Q,o,Q2v,d06,d26,var,s,q0,q2,q3,q4,S0,S2,S3,Q0L,Q02,S02,Q03,qq0,qq2,qq3,qq4
 s Q=0,di="",ccR=0,Qminus="",(qq0,qq2,qq3,ss2)=0
 s (Q02,S02,Q03,Q2,S2,Q2v,Q3,Q0,S2vc,Q2vc,S0vc,Q0vc,z0,z2,q0,q2,q3,S0,S3,Q0L)=0
 s d2=+$p(d0,"-",2),d0=+d0 s:'d2 d2=d0
 i '$g(zero) s %=0 f  s %=$o(^invFakt(no,%)) q:%>d0!'%  i %?8n,$d(^(%,NN)),$g(^invFakt(no,%,NN,"q"))'<0 s (Q,Q0,qq0)=$g(^invFakt(no,%,NN,"q")),Q0L=$g(^("qL")),di=%_"^"
 s c2=0,d06=$e(d0-100,1,6),d26=$e(d2,1,6) s:d06#100=0 d06=d06-88
 f  s di=$o(^NNd(no,NN,di)) q:di>d2!'di  d
 . q:di["^atg(" 
 . s %r=^(di),q2=$p(%r,%B,2),q3=$p(%r,%B,3),Q=Q+q2-q3,q0=0,c=+%r s:q2 c2=c
 . s (%I,%I2)=$e(di,9,99) q:$e(%I)'="^"   Q:'$d(@%I)  
 . i 'q2,'q3,q2["inv" s (q2,qq4)=$tr(q2,"inv"),s=+$tr(%r,"inv") i s,q2 s %r=s/q2_%B_q2,c=+%r,(Q02,S02,Q03,Q2,S2,Q2v,Q3,Q0,S2vc,Q2vc,S0vc,Q0vc,z0,z2,q0,q2,q3,S0,S3,Q0L)=0 i c2 d
 .. s %r=+%r_" z"_c2_%B_q2,c=+c2 i di>20190500 s %=$g(^invFakt(no,+di,NN,"s")) i %,%-c2 s ^("c2")=c2
 . i $e(%I,2)="P" s o=$e(%I,1,4),%=$qs(%I,1) Q:'$d(@o@(%))  s %I=$NAME(@o@(%))
 . i $g(zero)="0",'Q,di'<d0 s (S2vc,Q2vc)=0   ;;;;;;;;;; zero 20041115
 . i $g(xmsm)'="" x "s %9="_xmsm q:'%9
 . s gm=$e(di,1,6),var=+$p(%r,"var=",2)
 . s:q2["tr" q2="transp"  s s2=q2*c
 . s:di<d0 Q0=Q,Q02=Q02+q2,Q03=Q03+q3,S02=s2+S02,qq0=qq0+q2-q3 s:di'<d0 Q2=Q2+q2,Q3=Q3+q3,qq2=qq2+q2,ss2=ss2+s2,qq3=qq3+q3 s:$d(qq4) qq4=qq4+q2-q3
 . s:%r["/" ccR=$p(%r,%B)
 . i %r["z",%r'["(""z" s z2=+$p(%r,"z",2)_"z" s:di<d0 z0=z2
 . s o=$p(%I,"(")_"("
 . i "^ppq6(^pps(^Saiz(^Saiz7("[o,%r d  i z2,z2'["z" s z2=0,z0=0
 ..         s S2vc=s2+S2vc,Q2vc=Q2vc+q2
 ..   s:di<d0 S0vc=s2+S0vc,Q0vc=Q0vc+q2
 . i 'S2vc,c,z2'["z" s z2=c s:di<d0 z0=z2
 . i var s s=0,s2=0 d  s:q0 S0=S0+s i di'<d0 s:q2 S2=S2+s s:q3 S3=S3+s
 .. i q3,no>3.9 s s=q3*$$vcdCena(no,NN,+di) q
 .. s s=$$sklk(no,NN,qs,gm,var) s $p(^NNd(no,NN,di),%B,7)=s
 . i di'<d0,q2 s:'s2 Q2v=Q2v+q2 s:'var S2=s2+S2 
 s:Q2vc S2vc=+$j(S2vc/Q2vc,0,8) i 'S2vc,z2 s S2vc=z2
 s:Q0vc S0vc=+$j(S0vc/Q0vc,0,8) i 'S0vc,z0 s S0vc=z0
 s vc0=S0vc,vc2=S2vc
 i '$p(ccR,"/",2) s $p(ccR,"/",2)=+$g(^cR(NN,5))
 ;; i $d(qq4) s %4=qq0+qq2-qq3 ;; s:%4>qq4 qq3=qq3+(%4-qq4)
 s q023(0)=qq0,q023(2)=qq2_$s(ss2:"<mx s"_+$j(ss2,0,2),1:""),q023(3)=qq3,q023(4)=$g(qq4)
 f o="Q0","Q","Q2","Q2v","S0","S2","S3","Q3","vc0","vc2","d0","no","ccR" s r(o)=$g(@o)
 q +Q0_" Q="_Q_" Q0L="_+Q0L_" Q2="_Q2_"v"_Q2v_" S2="_S2_" Q3="_Q3_" vc0="_vc0_" vc2="_vc2_" d="_d0_" no="_no_" ccR="_+ccR_" Q02="_Q02_"  S02="_S02_"  Q03="_Q03_"  z2="_z2_"  Q2vc="_Q2vc
 q
NNklk(pie,san) 
 n q2,k,var s q2=$p(q_"/"_q,"/",2),var=+$p(q,"/",3) s:'var var=1
 n n,%R,qk,zr s n=""
 s:san<9 ^NNd(+san,NN,d8_%I)=c_%B_q_" var="_var_" qs="_q2
 i pie>3 s ^NNd(+pie,NN,d8_%I)=%B_%B_q q ""
 ;
 f  s n=$o(^klk(NN,var,n)) q:n=""  s %R=^(n),zr=$NAME(^(n)),ingr=$p(%R,%B,2) d
 . s k=$p(%R,%B,5) s:'k k=+$p(mxConfig,"klk=",2) s:'k k=1
 . s norma1=$p(%R,%B,3)/k,norma2=$p(%R,%B,4)/k
 . s qk=norma1*q2 q:'qk
 . s ^NNd(+pie,ingr,d8_%I)=%B_%B_qk_" var="_var_" qs="_qk_" pie="_pie_" san="_san_" NN="_NN
 q ""
vcklk(nol,NN,d,var) 
 n gm,vc,o q:'$d(^klk(NN)) "no^klk("_NN_")"
 s gm=$e(d,1,6),o=$p($g(var),"/",3),q="1/1/" s:o q=var,var=o s:'q q=1_q
 i '$g(var) s o=+$o(^klkvar(NN,gm+.1),-1) i o s var=^(o)
 i '$g(var) s var=+$o(^vcklk(nol,NN,gm,0)) s:'var var=1
 s vc=$g(^vcklk(nol,NN,gm,var)),$p(q,"/",3)=var
 s:'vc o=$$sklk(nol,NN,q,d,var),o=$g(^vcklk(nol,NN,gm,var))
 s:'vc o=$o(^vcklk(0,NN,gm+.1),-1),vc=$g(^(+o,var))
 q vc_"k"
sklk(nol,NN,q,d,var) 
 n q22,n,%R,qk,zr,ss,k,o,r,gm,vc,onol,ingr s gm=$e(d,1,6),d=$e(d*100,1,8)
 s ss=0,n="" s:'$g(var) var=+$p(q,"/",3) q:'$d(^klk(NN)) "not^klk"
 i var s:'$d(^klk(NN,var)) var=0 s:var ^klkvar(NN,$e(d,1,6))=var
 i 'var s o=+$o(^klkvar(NN,$e(d_33,1,6)+.1),-1) i o s var=^(o)
 s:'var var=+$o(^klk(NN,0))
 f  s n=$o(^klk(NN,var,n)) q:n=""  s %R=^(n),ingr=$p(%R,%B,2) d
 . s k=$p(%R,%B,5) s:'k k=+$p(mxConfig,"klk=",2) s:'k k=1
 . s norma1=$p(%R,%B,3)/k,norma2=$p(%R,%B,4)/k,qk=norma1*q q:'qk
 . s vc=$$vcdCena(nol\1,ingr,d)
 . f onol=4,3,2 q:vc  d
 .. n n,NN,nol,s,ss,q,o,qk s vc=$$vcdCena(onol,ingr,d)
 . i 'vc,$d(^vc3(ingr,3,$e(d,1,6))) s vc=^($e(d,1,6))
 . s s=vc*qk,ss=ss+s,^oNNdklk(no,NN,di,ingr)=s_" var="_var
 i q,nol<9 s ^vcklk(0,NN,gm,var)=ss/q,^vcklk(nol\1,NN,gm,var)=ss/q_" "_q
 q ss
NNq(no,NN,d0,%Ibez,qq) 
 q $$Q(no,NN,d0)
NNcFIFO(nol,NN,di0,q0) 
 q 0
l(%lN) q $$l^UST(%lN)
LIFOs3(no,NN,d2,d1) 
 n di,S,c2,q2,q3,i s di=1,S=0   ;     mxConfig=":^mk:+^mk:" 
 f  s di=$o(^NNd(no,NN,di)) q:di>d2!'di  s q2=$p(^(di),%B,2) i q2 s c2(di)=+^(di),q2(di)=q2,S=q2*c2(di)+S
 q:'d1 S  s di=d2_%B,S=0
 f  s di=$o(^NNd(no,NN,di),-1) q:di<d1  s q3=$p(^(di),%B,3) d
 . i di["^mk(" n %I s %I=$e(di,9,99) i %I[",0,0)" s S=$p(@%I,%B,6)+S,q3=q3-$p(@%I,%B,5) q
 . q:'q3  s i=+di_%B f  s i=$o(q2(i),-1) q:'i  q:'q3  s q2=q2(i) d
 .. i q2'>q3 s q3=q3-q2,S=c2(i)*q2(i)+S k q2(i),c2(i) q
 .. s q2=q2-q3,S=c2(i)*q3+S,q3=0 q
 q S
FIFOq3(no,NN,d3,d2,q3) 
 q:'q3 " -"   ; d3..Q3     d2..Q2
 n %d,di,c2,q2,S,Q,Q2,Q3 s (S,Q,Q2,q2,Q3,c2)=%B s:$g(q3)'>0 q3=1_%B
 s di=0,%d=0 f  s di=$o(^NNd(no,NN,di)) q:di>d3!'di  s Q3=$p(^(di),%B,3)+Q3,Q2=$p(^(di),%B,2)+Q2 i Q3=Q2,di<d3 s (Q3,Q2)=0,%d=di
 s di=%d,Q2=0
 f  s di=$o(^NNd(no,NN,di)) q:di>d2!'di  s q2=$p(^(di),%B,2) i q2 s Q2=q2+Q2 i Q2'<Q3 s Q=Q2-Q3,c2=+^(di),S=Q*c2 q
 i Q>q3 q q3*c2_" Q>q3 Q="_Q_"  q3="_q3
 f  s di=$o(^NNd(no,NN,di)) q:di>d2!'di  s q2=$p(^(di),%B,2) i q2 s c2=+^(di),Q=Q+q2,S=q2*c2+S i Q'<q3 s S=S-(Q-q3*c2) q
 i q3>Q s %=q3-Q*c2+S_" q3-Q="_(q3-Q) s:% S=% i 'S,q3=(1_%B) s S=+c2_" (last.cena.q2)"
 q S
 q

tirgusSV
tirgusSV ; ATG.materiali [ 09/20/2006  2:33 PM ]  ;[ 20140405 19:26:51 ]
 ; M3-LITE, MSM, CACHE, GT.M, MINIM
 ; Soft-in-cell  MX.ATG  Copyright(c) SIA ENTERS  2005-2011
 q
w1 
 i $g(mxConfig)[":d8min=" q:d8<$p(mxConfig,":d8min=",2)
 ;; i $g(mnosMNd),$e(d8,1,6)<$e(mnosMNd,1,6) q   ;;; VEN UPTK
 i $l($g(xmsm)) x "s %="_xmsm q:'%
 X %XV(%V)
 q
NP(nos) 
 n NN q:nos="" "?"
 s NN=$p($g(^NP(nos)),%B,2) s:NN="" NN="?"
 q NN
PN(NN,gm) 
 q $$nos(NN,$g(gm))
PNos(NN,gm) 
 q $$nos(NN,$g(gm))
MNos(NN,gm) 
 q $$nos(NN,$g(gm))
nos(NN,gm) 
 n o,%,rr s (PN7,kNN)=9999,mnosMNd=0
 q:NN="" "?"
 I $d(^MNd(NN)) q $$MNd(NN,$g(gm))
 s cena=+$p(NN,":",2),rr=$g(^PN(NN))
 i rr="",cena s %=$o(^PN($p(NN,":")_":")) d
 .  s:$p(%,":")=$p(NN,":") rr=^(%),$p(rr,%B,6)=$p(NN,":",2),^(NN)=rr
 s m=$p(rr,%B,2) s:m["gab" m="gb" s m=$p(m_"..","..") s:m="" m=1
 s gr=+$p(rr,%B,4),(kNN,PN7)=gr,mv=m
 s strcode=$p(rr,%B,5) s:'cena cena=$p(rr,%B,6)
 q:rr'="" $tr($p(rr,%B,3),"*","x")
 s cena=-1
 q NN
MNd(NN,gm) 
 s (m,cena,PN7,kNN,mnosMNd)="?" q:'$l(NN) "?"
 n mm,nos,rr,% s:$g(gm)<200000 gm=%gm s mnosMNd=0,gm=$e(+gm,1,6)
 s mm=$o(^MNd(NN,gm+.1),-1) s:'mm mm=$o(^(gm_33),-1) s:'mm mm=$o(^(""),-1) q:'mm NN  s rr=^(mm)
 i $o(^(mm),-1) s nos=$p(rr,%B,4),mnosMNd=mm,%=mm d
 .  f  s %=$o(^(%),-1) q:'%  q:nos'=$p(^(%),%B,4)  s mnosMNd=%
 i $l(rr,%B)>6 n %R,%1 s %R=rr,%1="MNd" d:'$d(%XG(%1)) ^USX x %XG("MNd")
 s cena=$p(rr,%B,2),PN7=$p(rr,%B,5),crBEZpvn=$p(rr,%B,7) s:'$d(nos) nos=$p(rr,%B,4)
 s strcode="" i $p(PN7," ",2) s strcode=$p(PN7," ",2),PN7=$p(PN7," ")
 i $p(rr,%B,6) s strcode=$p(rr,%B,6)
 s m=$p(rr,%B,3) k mv 
 i m["=" f %=2:1:9 s mv=$p(m,"=",%) s:mv mv=$p(mv,+mv,2) i $l(mv) s mv(mv)=+$p(m,"=",%) s:'mv(mv) mv(mv)=1
 s (m,mv)=$p(m,"="),kNN=PN7 s:$p(NN,":",2) cena=+$p(NN,":",2)
 s:m["gab" m="gb" s (m,mv)=$p(m_"..","..") s:m="" (m,mv)=1
 q:$l(nos) nos s cena=-1
 q NN
q() 
 q:xf_xDOK="" 0
 i xf'="" i $tr(firma,%LAT,%lat)'[xf q 1
 i 'xDOK,xDOK'="",DOKf'=xDOK q 1
 i xDOK,DOKf'=xDOK q 1
 q 0
%I0 s (s,sp)=0 q
koko(s,DK) 
 i $d(%V(%V,"w1")) d @%V q 1
 ;;i kurssumm-1,kurssumm s s=s/kurssumm_" "_s,sZak=sZak/kurssumm
 i $g(DK) n %koko s %koko(%FILE,1)=%B_$p(DK,"-")_%B_$p(DK,"-",2)_%B_s_%B_1_%B_%FILE
 q $$koko^fin(s)
%vv g @%V
Saiz7 q   ;; d %I0,%I0^fin,Saiz7V^kas q
ppq 
ppq6 
pps d %I0,%I0^fin,ppsV^tirgusSV q
atg d %I0,%I0^fin,atgV^tirgusSV q
FRq 
PPR d %I0,%I0^fin,PPRV^tirgusSV q
PAV d %I0,%I0^fin,PAVV^tirgusSV q
atgV 
ppsV 
 s sVe="",(fa,dk,nn,cFIFO,sFIFO,ob,T,INV)=0,parko=" ",xNN=$g(xNN)
 f %1="Firma","pps","atg",%FILE d ^USX
 s NN=0,%I2="",bak=2310,K=5310,%I="^"_%FILE,kurssumm=1
 s OfirO="",OfirmaO=""
 d %I0 f %1="Saisp","Firma" d ^USX
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"(") d ppsS s (OfirO,OfirmaO)=""
 s %I="^"_%FILE
 i $g(%d8start(%FILE)) s %I="^"_%FILE_"("_%d8start(%FILE)_")" k %d8start(%FILE) 
ppsS d:$d(%tSelect)  i '$d(%tSelect) f  s (%I2,%I)=$q(@%I) q:%I=""  d  q:'$d(%I)
 .s %R=@%I i xNN'="",%R'[xNN q
 .k p,ccR X %XI(%FILE),%XG(%FILE) s:'$d(ccR) ccR=c i d>%XD82 k %I q 
 .i xNN'="",NN'=xNN q:xNN'[":"
 .i %FILE="ppq" s nol=+$p(piez,"n",2),NN=+piez q:$l(NN)<2  ;;; only for non-accountable
 . i mxConfig[":UPTK:",%FILE="ppq6",nol=4,$l(NN)<2 s NN=11111111
 .i %FILE="ppq6" s ob=$p(nol,".",2),nol=nol\1 q:$l(NN)<2   ;;; only for non-accountable
 .q:NN="" ;;; only for non-accountable
 .s d8=d,nn=n,m=0,DOK=$tr(DOK," ") s:$d(p) piez=p 
 .s nos=$$nos(NN,%XD82) s:'kNN kNN=2130 q:$e(d8,1,6)<mnosMNd
 .s vc=c,cZak=c,DOKf=DOK,(Piez,p)=piez ;;konts=2130
 .i %FILE="pps" s nol=+$p(atb,"n=",2)\1 s:'nol nol=+atb\1
 .s:'nol nol=1 s ceh=nol,ceh1=ceh,ceh2=0
 .i $g(xNol),nol-xNol q
 .i OfirO'=fir s firma=$$firma^fir(fir),OfirO=fir
 .s kurs=$$vk^fin(c_" "_s,d8) s:'kurs kurs=1 s cLs=c*kurs s:kurs-1 s=s_" "_kurs
 .i ceh=1 s ^cR(NN,0)=c*kurs_" "_c,^("DOK")=DOKf
 .f %=1:1:5 s cR(%)=$p(ccR,"/",%),sR(%)=kurs*cR(%) d
 ..  x " s cR"_%_"=cR(%),sR"_%_"=sR(%)"
 ..  i ceh=1 s:cR(%) ^(%)=cR(%)_" "_d8_"<mx@"_%I
 .q:$$q
 .s:'s s=.00000001
 .s ss=s,qq=q,cR=0,s2=q*c*kurs,q2=q,(q0,q3,s0,s3)=0
 .s %=$p(ss,"-",2) s:'%&fa %=fa s:% %=100-%/100 ;; %=bezAtlaide
 .i s["+",s'[" +",$e(s)'="+" s s=$$trw^UST(s,"+"," +")
 .i d8<%XD81 s q0=q2,s0=s2,(q2,s2)=0
 .s sD=0,sK=s,Sp=$p(s,"p",2)+$p(s," +",2),Sb=s-Sp s:s[" +" Sb=+s
 .s %=$$koko(s)
 q
Saiz7V q
PPRV 
PAVV 
 n ssSumma k %koko n PPR,PAV s (PPR,PAV)=0
 k %I f %1="Firma","PAVsp","PPRsp","pps","FRqsp" d ^USX
 s %I="",NN="",%I2="",bak=2310,K=5310,xNN=$g(xNN),ob=0,(OfirO,OfirmaO)=""
 I $d(%tSelect) s %I="" d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^"_%FILE_"("),$d(@%I) s DOKf=$qs(%I,1) d PPRS s (OfirO,OfirmaO)=""
PPRS d:$d(%tSelect)  i '$d(%tSelect) s DOKf="" f  s DOKf=$o(@("^"_%FILE)@(DOKf)) q:DOKf=""  d  q:$g(%koko(%FILE))=-1
 .S %R=^(DOKf),(%I2,%I)=$NAME(^(DOKf)),DOK=DOKf,(sAtla,sVe,DOKfin)=0
 . i DOK[" ",mxConfig[":noBlank:" n DOKf s DOKf=$tr(DOK," ")
 . i %I["^PAV" s PAV=DOKf
 . i %I["^PPR" s PPR=DOKf i $g(^PPRx3(PPR,"noActive")) q 
 .X %XG(%FILE) s d8=d,gm=$e(d8,1,6) i d8>%XD82,'$d(%tSelect) q
 .s piez=Piez,fir=san,ssSumma=ss_" "_summa,ossSum18=summa,DOKfi=DOKfin,DOKfin=0
 .s %atla=$p(sVe,"%a=",2) i '%atla,%FILE="PAV" s %atla=$p(sVe,"-",2)
 .i sVe["pvn="!%atla,%FILE["P" d ssum^tirgus(%I,%atla) s ss=ss-sAtla
 .s (ceh,ceh1,nol)=+pie,ceh2=0 s:'nol nol=1 i san,san<2222 s ceh2=+san
 .s cch=+ceh1_"-"_+ceh2
 .s kPVN=1,rrt="realizacija",sZak=0,kNN=0,fir=san
 .s:OfirO=fir firma=OfirmaO s:OfirO'=fir firma=$$firma^fir(fir),OfirO=fir,OfirmaO=firma
 .q:$$q  i $g(xNol),nol-xNol q
 .s kurs=$$vk^fin(ssSumma,d8) s:'kurs kurs=1 s kurssumm=kurs s:+sP[".0000" sP=0
 .s dk=1,ss=ss_" +"_sP_" "_kurs,(sD,sK,cFIFO,sFIFO)=0
 .i $l(%V),$d(%V(%V,"w0")) d @%V q
 .i '$g(xNol) s %=$$koko(ss) i %FILE="PPR" s o=$o(^PPRx3(DOK,"DK:")) d:o["DK:"
 .. s S=^(o),o=$p(o,":",2) i o,S,$$koko(S,o)
 .s dk=0,%iPP="^"_%FILE_"sp(DOK)",nnPP=""
 .i '$d(kokoFile) s kokoFile=" ",o="^koko" f  s o=$q(@o) q:o=""  d
 ..  s:kokoFile'[(" "_$p(@o,%B,6)_" ") kokoFile=kokoFile_$p(@o,%B,6)_" "
 .i kokoFile[(%FILE_"sp") s dk=1  ;; falck ;; blg ;;
 .n kurs f  s nnPP=$o(@%iPP@(nnPP)) q:nnPP=""  d
 ..s %R=^(nnPP),%I2=$NAME(^(nnPP)) i xNN'="",%R'[xNN q
 ..x %XG(%FILE_"sp") s NN=k
 ..i $l(xNN)>1,NN'=xNN q:xNN'[":"
 ..s nos=$$nos(NN,%XD82) ;;;q:$e(d8,1,6)<mnosMNd
 ..s cena0=c,nn=nnPP,kurs=kurssumm
 ..s vc=+$p(c,"z",2) s:$p(NN,":",2) vc=$p(NN,":",2) i 'vc,c["z" s vc=+c
 ..i vc,$l(vc)-$l(+vc)>2 s %=$$vk^fin(vc,d8) s:'% %=1 i %-1,vc s vc=vc*%,kurs=%,c=vc_" "_kurs
 ..s:'vc vc=+$$vcdCena^tirgus(nol,NN,d8) s vcLs=vc
 ..s cZak=+vc s:'c c=cZak s svc=q*vc s:'kurs kurs=1 s sZakLs=q*cZak
 ..s (s3,sZak)=q*cZak/kurs_" "_kurs,q3=q
 ..s (q0,q2,s0,s2)=0 i d8<%XD81 s q0=-q3,s0=-s3,(q3,s3)=0
 ..s ss=s_" "_kurs_" "_c,dk=0,sD=ss,sK=0,loo=1,ossSum18=ossSum18-s-$j(s*$s(d8>20110000:.22,d8<20090000:.18,1:.21),0,2)
 ..s %=$$koko(ss)
 .i ossSum18,(ossSum18*ossSum18)<.0004,mxConfig[":ossSum18:" s %=$$koko(ossSum18_"o")
 .k ossSum18
 .q:'DOKfi  s DOKfin=DOKfi,%I2=%I,DOKf1=DOKf n DOKf
 .f DOKfi=1:1 s o=$p(DOKfin,",",DOKfi) q:o=""  s DOKf=DOKf1_"//"_$p(o,":"),(nos,s)=$p($$trw^UST(o,"5%"," 5%"),":",2),%=$$koko(s)  
 q
p1sR ;\ Precu sanemsana pa datiem\d8,firma,-DOKf,n\q2,Sb,Sp=nos,m,c,NN,%I,kurs\\pps Saiz7 atg\k qq,ss s %V(%V,"w1")=1,iii=0 k ^oMX(%USID)
 q:d8<%XD81
 i 'c n c s c=$p(ccR,"/",2)
 s Sb=c*q2,Sp=0 s:'q2 Sb=s 
 i kurs,kurs-1 f o="Sp","Sb" s @o=@o*kurs
 g w1
p1sRL 
 s d=""  s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="n" s firma=nos_"<mx@"_%I,qq(m)=$g(qq(m))+q2,ss(m)=$g(ss(m))+Sb
 I %E="n" f o="DOKf","firma" s @o=$tr(@o,"*","x")
 I %E="d8" s firma=d8
 i $$l("d   DOKf  NN  firma   m  c.___~ q2.__~ Sb.__ Sp kurs")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 i %E["%g" s q2="",m="" f o=1:1 s m=$o(qq(m)) q:m=""  d
 . s q2=qq(m),Sb=ss(m),Sp="",firma="t.sk.  "_m
 . i $$l("d   DOKf NN  firma  m  c.___~ q2.__~ Sb.__ Sp kurs")
 . s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
saFm ;\ Precu sanemsana pa firmam-materialam\firma,atb,-d8,DOKf,n\q2,Sb,Sp=nos,m,c,NN,%I,kurs\\pps Saiz7 atg\@p1sR
 q:d8<%XD81
  i kurs,kurs-1 f o="Sp","Sb" s @o=@o*kurs
 g w1
saFmL 
 s d=""  s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="n" s firma=nos_"<mx@"_%I,qq(m)=$g(qq(m))+q2,ss(m)=$g(ss(m))+Sb
 i %E="atb" s firma=atb
 i $$l("d  DOKf   firma  m  c.___~ q2.__~ Sb.__ Sp kurs")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 i %E["%g" s q2="",m="" f o=1:1 s m=$o(qq(m)) q:m=""  d
 . s q2=qq(m),Sb=ss(m),Sp="",firma="t.sk.  "_m
 . i $$l("d  DOKf   firma  m c.___~ q2.__~ Sb.__ Sp kurs")
 .s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
saFi ;\sanem pa firmam\firma,-d8,DOKf\Sp,Sb,s,sB,sP,s2,q2,s2R=kurs\\pps Saiz7 atg\@p1sR
 q:d8<%XD81  s c2R=$g(^cR(NN,2)),s2R=q2*c2R  n s2 s s2=q*c
 i xDOK'="" s o=DOKf n DOKf s DOKf=o_"."_(100+n)
 s sP=$p(s,"+",2)+$p(s,"p",2),sB=s-sP
 i kurs,kurs-1 f o="Sp","Sb","s","sB","sP","s2","s2R" s @o=@o*kurs
 g w1
saFiL 
 i $$l("d8 DOKf  firma s2 s2R s sB sP  Sp Sb kurs ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
p1s ;\ Pre{269}u sa{326}em{353}ana pa datiem\-d8,firma,-DOKf,n\q2,Sb,Sp=nos,m,c,NN,%I,kurs\\pps Saiz7 atg ppq ppq6\@p1sR
 q:d8<%XD81  q:$l(NN)<2
 i xNol,nol-xNol q
 s nPREV=n,nosPREV=nos,cPREV=c,mPREV=m
 i kurs,kurs-1 f o="Sp","Sb" s @o=@o*kurs
 g w1
p1sL 
 s d=""  s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="n" s firma=nos_"<mx@"_%I,qq(m)=$g(qq(m))+q2,ss(m)=$g(ss(m))+Sb
 I %E="n" f o="DOKf","firma" s @o=$tr(@o,"*","x")
 I %E="d8" s firma=d8
 i $$l("d DOKf firma m c.___~ q2.__~ Sb.__ Sp kurs %oM")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 i %E["%g" s q2="",m="" f o=1:1 s m=$o(qq(m)) q:m=""  d
 . s q2=qq(m),Sb=ss(m),Sp="",firma="t.sk.  "_m
 . i $$l("d DOKf firma m c.___~ q2.__~ Sb.__ Sp")
 . s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
p1f ;\ Pre{269}u sa{326}em{353}ana pa firmam\firma,-d8,-DOKf,n\q2,Sb,Sp=nos,m,c,NN,%I\\pps Saiz7 atg ppq ppq6\@p1sR
 q:d8<%XD81  q:$l(NN)<2
 i xNol,nol-xNol q
 s nPREV=n,nosPREV=nos,cPREV=c,mPREV=m
 i kurs,kurs-1 f o="Sp","Sb" s @o=@o*kurs
 g w1
p1fL g p1sL
pard1 ;\Pardo{353}ana pa datiem PPR\-d8,DOKf\ss,sP=firma,kurs\\PPR PAV\k qq,ss s %V(%V,"w0")=1,iii=0 k ^oMX(%USID)
 q:d<%XD81  ;;i %I2["sp",$o(@%I2,-1)'="" q
 i xNol,pie-xNol q
 i kurs,kurs-1 s ss=ss*kurs,sP=sP*kurs
 g w1
pard1L s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 s ssP=ss+sP
 i d,$$l("d firma DOKf ss.__ sP.__ ssP.__ kurs w1")
 i d s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
parf ;\pard. pa firmam Ls\firma,-d8,DOKf\ss,sP=kurs\\PAV PPR\k qq,ss s %V(%V,"w0")=1,iii=0 k ^oMX(%USID)
 q:d<%XD81  ;;i %I2["sp",$o(@%I2,-1)'="" q
 i xNol,nol-xNol q
 i kurs,kurs-1 s ss=ss*kurs,sP=sP*kurs
 g w1
parfL 
 s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)  s ssP=ss+sP
 i %E="firma" s d=firma
 i $$l("d DOKf ss.__ sP.__ ssP.__ kurs ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
parfq ;\Pardosana pa dokumentiem (daudz.)\-d8,-firma,DOKf,nn\q,s3=c,NN,nos,%I2,kurs\\PPR PAV\@p1sR
 i xNol,xNol-nol q
 q:d<%XD81  q:dk  q:%I2'["sp("  n s3 s s3=q*c*kurs
 g w1
parfqL 
 s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="DOKf" s nos="*"
 i $$l("d  firma  DOKf  nos q c.___ s3.__ %I2  kurs")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
paratb ;\Pardosana pa mat.atb.pers.\matb,NN,-DOKf,nn\q,s3=c,%I2,kurs,d8\\PPR ppq\@p1sR
 q:d<%XD81  q:dk  q:%I2'["sp("&(%FILE["PPR")  q:'NN
 s matb=nol
 n s3 s s3=q*c*kurs
 g w1
paratbL 
 i $$l("matb NN firma  DOKf nn q c s3.__ %I2  kurs")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q 
parmaF ;\Pardosana pa firmam (daudz.)\firma,-d8,-DOKf,nn\q,s3=m,NN,nos,c,%I2\\PPR PAV\@p1sR
 g parma
parmaFL 
 g parmaL
parma ;\Pardosana pa datiem-firmam (daudz.)\-d8,firma,-DOKf,nn\q,s3=m,NN,nos,c,%I2\\PPR PAV\@p1sR
 q:d<%XD81  q:dk  q:%I2'["sp("  n s3 s s3=q*c*kurs
 g w1
parmaL 
 s d="" s:d8 d=$e(d8,5,6)_"."_$e(d8,7,8)
 i %E="DOKf" s nos="*"
 i $$l("d firma DOKf nos  q  c.___ s3.__ %I2 kurs ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
invs ;\Inventarizacijas saraksts\NN\q0,q2,q3,q4,s4=cZak,nos,m,kurs\\pps atg PAV PPR Saiz7\@p1sR
 s q4=q0+q2-q3,s4=cZak*q4*kurs
 q:dk
 g w1
invsL 
 s q4=q0+q2-q3,cR=$g(^cR(NN,2)),cRn=2_" "_cR
 i 'cR f cRn=5:-1:0 i $d(^(cRn)) s cR=^(cRn),cRn=cRn_" "_cR q
 s s4R=$j(q4*cR,0,2)
 i %E="NN"  f %="%ggmm" s ss(%)=$g(ss(%))+s4R
 e  s s4R=$g(ss(%E)) k ss(%E)
 i 'q4,'s4R q
 i %E="NN" s:s4R<0 s4R=s4R_"<mx ic7" s:cRn<2 cRn=cRn_"<mx ic6"
 s s4=s4R,cZak=cR
 i %E="NN",'q4,'q2,'q3,1_$$%RsuM^USPRINT(-1) q
 s:%M[%W q4=0
 i $$l("NN  nos  m  cZak    q4      s4   cRn  kurs ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q 
cc(NN,d0,qq) 
 q $$NNcFIFO(1,NN,d0,qq)
PPRsert(Pkods,nc) 
 q "$$PPRsert() not exists"
PPRa 
PPRaa s %I="^PPR"  f %1="PPR" d ^USX
ppfaa s %I="^ppf"  f %1="ppf" d ^USX
ppqaa s %I="^ppq"  f %1="ppq" d ^USX
PPRaM 
 q
PAVnew(%F,Nr) 
 q "$$PAVnew^tirgus() not exists"
PAVcena(NN,nc) 
 ;      cena no ^pps
 n di,o,n s:'$g(nc) nc=1
 s n="" f  s n=$o(^NNd(n)) q:n=""  i $d(^NNd(n,NN)) s di=%XD82+1_"^" d
 .f  s di=$o(^NNd(n,NN,di),-1) q:di=""  i di["^pps(" s o(di)=^(di)
 s di=$o(o(""),-1) q:'di 0
 s o=$p(o(di),%B)
 q $p(o,"/",nc)
F12(ce,%k,d,p) 
 n Q,o,dd
 s o=%K s:o_"$"["*$" o=$tr(%K,"*")
 i $tr($g(^PN(%k)),%LAT,%lat)[o s %SEL(%k)=%g_%B_%B_%
 else  d
 . s:'$g(d) d=99990000 s dd=$o(^MNd(%k,d),-1) q:'dd
 . i $tr($g(^MNd(%k,dd)),%LAT,%lat)[o s %SEL(%k)=%g_%B_%B_%
 q:'$d(%SEL(%k)) ""  q:%K'=o ""
 s o=$g(p) s:o="" o=$g(pie) s:o="" o=1 s Q=$$NNq(o,%k,d)
 i Q'>0 k %SEL(%k) q ""
 s $p(%SEL(%k),%B,2)="  nol="_o_" atlikums="_Q_"  "
 q ""
PNrest 
 s NN="" f  s NN=$o(^MNd(NN)) q:NN=""  s nos=$$nos(NN,99999999) d
 . s ^PN(NN)=%B_m_%B_nos
 q
NNqRest(d6min) 
Q(no,NN,d0,xmsm,zero) 
NNq(no,NN,d0,%Ibez,qq) 
 q $$Q(no,NN,d0)
NNcFIFO(nol,NN,di0,q0) 
 q 0
l(%lN) q $$l^UST(%lN)

zvn
zvn ; ATG.alga/izzinas [ 02/23/2006  6:18 PM ]  ;[ 20190827 21:55:17 ]
 ; MSM, CACHE, GT.M, MiniM
 ; Copyright(c) SIA ENTERS  2005-2018
 q
w n o s o=+$p(mxConfig,":d8min=",2) i o,gm_11<o q
 i $l(xmsm)>1 x "s %="_xmsm q:'%
 x %XV(%V) i $g(%flagVom) s:'$l($g(formulaL)) formulaL="i $$m^MXF()" x formulaL
 q
%vv g @%V
pers g pers^zz
AM20 g AM20^zz
algNod ;\Darba alga nodokli\CF,T\s,su(*)=Fi\\pers\s cap=0 i $$Tf^ZT(%gm)
 g algNod^zz
ie ;\Izzina par ietur.\oiet,T\s=Fi\-%ggmm\AM20\s iii=0 k ^oMX(%USID)
 g ie^zz
ieL g ieL^zz
algV ; no ^AM
 q:$g(xf)_$g(xDOK)'=""  q:$g(xmsm)["%I"  d parm0^alg 
algVseT 
 n mo,flag2009,DOK,DOKf,firma,fir,o,%
 s o=1,flgFondi="" f  s o=$o(^O(o)) q:'o   s %=$p(^O(o),%B,5) i -%[-7,$l($p(%,".",2))=2 s:flgFondi'[$p(%,".",2) flgFondi=flgFondi_$p(%,".",2)_" "
 k soc,SOC,Soc s r=0,kurs=1
 i '$g(konSocDD),$p($g(^O(1000+Osoc)),%B,5) s konSocDD=$p($g(^O(1000+Osoc)),%B,5)
 s k72=7220,k73=7310
 f %="konSocDD:5725.2","kontPlus:5610","kont72:"_k72,"kont73:"_k73 d
 . s %1=$p(%,":")
 . i $d(^kNo("algaSocKonts",%1)) s @%1=$p(^(%1),%B,2) q
 . i '$d(@%1) s @%1=$g(@("^SetATG(""alga"","""_%1_""")"),$p(%,":",2))
 s ceh="",gm2=%XD82\100,xVAL=$s($l(xVAL)=3:xVAL,1:"EUR"),xT=$g(xT)
 s gm1=201401 i %gm<201400 s gm1=199801 n xVAL s xVAL="LVL"
 s piez="alga",(fir,firma)="alga" n T
 I $d(%tSelect) s %I="",gm1=gm2 d  q
 .f  s %I=$o(%tSelect(%I)) q:%I=""  i %I[("^pers"),$d(@%I) n xT s (T,xT)=$qs(%I,1) d algS
algS 
 d:$d(%tSelect)  i '$d(%tSelect) s T=0 f  s %1=$o(^pers(T)),%2=$o(^persArhi(T)) s T=$s('%2:%1,%2<%1:%2,1:%1) q:T=""  d:T
 .n %I  s (DOK,DOKf)=T i xT," "_xT_" "'[(" "_+T_" ") q
 .f gm=gm1:1:gm2 s:gm#100=13 gm=gm+88 q:gm>gm2  k am,SU,su d:$d(^AM(T,gm))
 ..s flag2009=0 s:gm>200900 flag2009=1 s:gm>201400 xVAL=$s($l(xVAL)=3:xVAL,1:"EUR")
 ..s %=$$m^ZFIO(gm)   q:'DFIO  q:SN["s0"  s (fir,firma)=Fi
 ..s (d,d8)=$e(gm,1,4)#4=0&(+$e(gm,5,6)=2)+(gm*100)+$e(303232332323,$e(gm,5,6))+28 i $g(flagd8mM) s (d,d8)=$$d8plus^MXD(d8,10)
 ..s sant=0,PLUS=$g(^AM(T,gm)),(%I,%I2)=T_" "_gm_" "_Fi,O=1
 ..s MINUS=$p(PLUS,",",2)  q:d8>%XD82
 ..s SUsoc=$g(^(gm,Osoc)) s:$l(SUsoc)=500 SUsoc=SUsoc_$g(^(Osoc,501))
 ..k soc,Soc,SOC f L=2:1 s s=$p(SUsoc,"s",L) q:s=""  d
 ... s s=$tr(s,"MDH","mdh"),m=+$p(s_"m"_gm,"m",2)
 ... s mo=m_$p(s,"1[",2)_" "_$p(s,"2[",2),Soc(mo)=$g(Soc(mo))+$p(s,"/",2)-s_"  "_s
 ... s am(1000+Osoc,gm,m)=$g(am(1000+Osoc,gm,m))+$p(s,"/",2)-s_" "_s
 ... s am(1000+Osoc,gm,m,L-1)=$g(am(1000+Osoc,gm,m,L-1))+$j($p(s,"/",2)-s,0,12)_" "_s
 ... s am(Osoc,gm,m,L-1)=$g(am(Osoc,gm,m,L-1))+s_" "_s,soc(mo)=$g(soc(mo))+s_" "_s
 ..i flag2009 k am m SOC=soc,SOC=Soc s m=1 d 
 ...  f  s m=$o(SOC(m)) q:'m  s:$g(soc(m)) am(Osoc,gm,m,1)=$j(soc(m),0,2)_" "_soc(m) s:$g(Soc(m)) am(Osoc+1000,gm,m,1)=$j(Soc(m),0,2)_" "_Soc(m)
 ..m am=^AM(T,gm)
 ..s o=1 f  s o=$o(am(o)) q:o>999!'o  s am(o)=$tr(am(o),"MDH'","mdh"_%B) f L=1:1:$l(am(o),%B) d
 ... s s=$p(am(o),%B,L),SU(o)=$g(SU(o))+s,su(o)=$g(su(o))+s
 ... s s=$tr(s,"MDH","mdh"),m=+$p(s_"m"_gm,"m",2)
 ... s am(o,gm,m)=$g(am(o,gm,m))+s i o-Osoc s am(o,gm,m,L)=s
 ..d algDK
 ..i $g(^AM(T,gm,"socS")) s DK=$g(^("socS","DK")),O=1898,S=+$j($g(^("DD"))+$g(^("DN")),0,2) i DK,S d 
 .. . s (DOK,DOKf)="socS",piez="socS."_Fi,sSoc=0 x xVw  ;; 20161026
 q
algDK n flgFondi s flgFondi=0
 n L,OO,f,ff,aDK,oDK s (L,O,m)=0,aDK=T_gm,o1=$p($g(^O(Osoc)),%B,5),o2=$p($g(^O(Osoc+1000)),%B,5)
 f  s O=$o(am(O)) q:'O  s OO=$g(^O(O)),m="" f  s m=$o(am(O,gm,m)) q:'m  s L="" f  s L=$o(am(O,gm,m,L)) Q:'$l(L)  d
 .  q:O=Oavans&(%gm<201400)  s piez=$p(OO,%B,2)
 .  s s=am(O,gm,m,L),S=+s,(DOK,DOKf,df,sf)=0,ob=0 s:s[" ob=" ob=$p($p(s," ob=",2)," "),oDK=ob 
 .  i O#1000=Osoc n DOK,DOKf,firma s (DOK,DOKf)="d/d.Soc",firma="alga.soc.nod." s:gm=%gm (DOK,DOKf)="d/d.Soc "_T_" "_Fi,firma=T_" "_Fi d  i DK>999,$p(DK,"-",2)>999 s aDK(m_%B_DK_%B_O_" ob="_ob)=$g(aDK(m_%B_DK_%B_O_" ob="_ob))+s_-O q
 ..   i O>999 s DK=$p($p($p(s," 2[",2),"]")," ") s:'$p(DK,"-",2) $p(DK,"-",2)=o2 d  q
 .. .   s f=0 i $g(flgFondi) s f=+$p($p(m,"2[",2),".",2) s:$l(f)-2 f=0
 .. .   i f s:+DK'["." $p(DK,"-")=+DK_"."_f s:$p(DK,"-",2)'["." DK=DK_"."_f  
 ..   s DK=$p($p($p(s," 1[",2),"]")," ") s:'$p(DK,"-",2) $p(DK,"-",2)=o1
 ..   s $p(DK,"-")=5610,f=0 i $g(flgFondi) s f=+$p($p(m,"2[",2),".",2) s:$l(f)-2 f=0
 ..   i f s $p(DK,"-")=5610_"."_f s:$p(DK,"-",2)'["." DK=DK_"."_f  
 .   i O=(1000+Osoc) d  q
 ..   s kk=kont73+((CF["adm")!(zF[7220)),f=0 i $g(flgFondi) s f=+$p($p(m,"2[",2),".",2) s:$l(f)-2 f=0
 ..   s DK=kk_"-"_konSocDD,(DOK,DOKf)="d/d.Soc" 
 ..   i f s:+DK'["." $p(DK,"-")=+DK_"."_f s:$p(DK,"-",2)'["." DK=DK_"."_f  
 ..   i DK>999,$p(DK,"-",2)>999 d aDK
 .  q:O#1000=Osoc  s %=+$p(OO,%B,5) q:%=-1  q:%[9999  i O=900 q:OO["parads"
 .  s kT=+$p(s,"z",2) i kT<0,-kT\1?4n s DK=5610_kT d aDK q
 .  i O<Or s k=0,%=+$p(OO,%B,5) d  q
 ..  i %,$l(%)>3 s k=%
 ..  i kT,$l(kT)>3 s k=kT
 ..  s:'k k=$s(CF["adm":10+kont72,1:kont72)
 ..  ;; i SN["s0",O=Onod s k=5724.9   ;;;  SPO 
 ..  s df=$p(s,"d",2),hf=$p(s,"h",2),DK=k_-kontPlus,f=$p(k,".",2) i flgFondi,f?2n s DK=DK_"."_f,ff(f)=$g(ff(f))+S
 ..  i O>700 s dk=$p($g(^(O)),%B,5) i dk>1111 s:'$p(dk,"-",2) dk=dk_-5610
 ..  i DK>999,$p(DK,"-",2)>999 d aDK
 .  s k=% i 'k q:O>Or  s k=kT q:k<1111 
 .  s DK=kontPlus_"-"_k
 .  i k'["," q:DK<999!($p(DK,"-",2)<999)  d:'$d(ff) aDK d:$d(ff)  q
 ..  n s,SS s f=0,s=S,SS=S,ff=0 f  s f=$o(ff(f)) q:'f  s ff=ff+ff(f)
 ..  f  s f=$o(ff(f)) q:'f  s DK=kontPlus_"."_f_"-"_k_"."_f,S=$s($o(ff(f)):$j(ff(f)/ff*s,0,2),1:SS),aDK(m_%B_DK_%B_O_-f)=S_-O_-f,SS=SS-S
 .  n SS,kk,pp,p,x,k1 s SS=S,kk=k,pp=0,ss=0,k1=kontPlus n S f x=1:1:$l(kk,",") s k=$p(kk,",",x) d:k\1?4n 
 ..  s p=$p(k,":",2),pp=pp+p,S=$j(SS*p/100,0,12),ss=ss+S 
 ..  s DK=k1_"-"_$p(k,":") s:$p(k,"-",2) DK=$p(k,":"),k1=$p(k,"-") 
 ..  i S,DK>999,$p(DK,"-",2)>999 d aDK
 .  s S=$j(SS-ss,0,12) i S,DK>999,$p(DK,"-",2)>999 d aDK
 .  ;;s S=$j(SS-ss,0,12) i S x xVw s aDK(DK)=$g(aDK(DK))+S_-O
 .  i pp>100 s p=pp-100,S=-$j(SS*p/100,0,12) d aDK
 .  i pp<100 s p=100-pp,S=$j(SS*p/100,0,12) d aDK
DKsave n %DK,%S,sSoc,SocDK,mDK s mDK=0,sSoc=0,aDK="" i gm=%gm k ^aDK(T,gm) m ^aDK(T,gm)=aDK
 f  s mDK=$o(aDK(mDK)) q:'$l(mDK)  s S=aDK(mDK) s:S[-(1000+Osoc) sSoc=sSoc+S,SocDK=$p(mDK,%B,2) s %=$p(mDK,%B,2) i -%=-$p(%,"-",2) k aDK(mDK) 
 s sSoc=$j(sSoc,0,2)
 f  s mDK=$o(aDK(mDK)) q:'$l(mDK)  s ob=$p(mDK,"ob=",2),S=+$j(aDK(mDK),0,2),DK=$p(mDK,%B,2),O=+$p(mDK,%B,3),%DK=$s('$d(%DK):DK,1:%DK_"^"_DK),%S=$s('$d(%S):S,1:%S_"^"_S) s:xC (DOK,DOKf)=T_":"_$p(aDK(mDK),"-",2),piez=Fi s:" 0."[ob ob=$g(oDK) x xVw i O=(1000+Osoc) s sSoc=sSoc-S
 i sSoc s S=sSoc,DK=SocDK,%DK=%DK_"^"_DK,%S=%S_"^"_S s:xC (DOK,DOKf)=T_":soc",piez=Fi x xVw
 i $g(gramatos)>0,'$g(flagd8mM) s:$d(%S) ^gramatos(d8,$name(^pers(T)))=%B_%DK_%B_%S
 q
aDK s aDK(m_%B_DK_%B_O_" ob="_ob)=$g(aDK(m_%B_DK_%B_O_" ob="_ob))+S_-O q
iso ;\*Izmaksas saraksts\CF,T\SV,DOLG,PLUS,MINUS,sS(*),soc,Soc,SOC,IZMA=Fi,SN\\AM20\s iii=0 k ^oMX(%USID)
 g iso^zz
isoL g isoL^zz
asa ;\Algas sadale\R\sS(*)\-%ggmm\AM20\s iii=0 k ^oMX(%USID)
 g asa^zz
asaL g asaL^zz
diffe190(T,gm) 
 q ""
 q

zz
zz ; ATG.alga-sadale [ 02/17/2006  6:35 PM ]  ;[ 20181220 19:37:15 ]
 ; MSM, CACHE, GT.M, MiniM
 ; vmx Copyright(c) SIA ENTERS  2005-2018
 q
w i $l(xmsm)>1 x "s %="_xmsm q:'%
 i $g(oxT),T-oxT q
 i $g(gm),gm<200600,mxConfig[":d8min=",$p(mxConfig,":d8min=",2)<(gm_11) q
 X %XV(%V) i $g(%flagVom) s:'$l($g(formulaL)) formulaL="i $$m^MXF()" x formulaL
 q
a(o,gm) n ss,am,L,s,m,% s (hh,dd,ss)=0,gm=$g(gm,%gm)
 s am=$g(^AM(T,gm,o))
 i $d(^(o))>1 s %="",am="" f  s %=$o(^AM(T,gm,o,%)) q:%=""  s am=am_^(%)_%B
 s am=$tr(am,"'HDMK",%B_"hdmk")
 f L=1:1:$l(am,%B) d
 .s s=$p(am,%B,L),m=+$p(s_"m"_gm,"m",2) i %gm>201400,gm<201400 s s=s/.702804
 .s ss=ss+s,hh=$p(s,"h",2)+hh,ss(m)=$g(ss(m))+s
 s m=0 f  s m=$o(ss(m)) q:'m  s ss=ss_" "_m_"="_ss(m)
 q ss
pers s T="" k ^persA(%USID) m ^persA(%USID)=^pers m ^persA(%USID)=^persArhi
 f  s T=$o(^persA(%USID,T)) q:T=""  d:T  i T'=+T s %mxWarng(+T)=T_$zr
 . i xT," "_xT_" "'[(" "_+T_" ") q
 . d ^ZFIO q:'DFIO  i %V'["algNod" q:SN["s0"
 . i " - "'[xCh," "_xCh_" "'[(" "_CF_" ") q
 . d @%V
 q
p12 s gm1=%XD81\100,gm2=%XD82\100,T="" k ^persA(%USID) m ^persA(%USID)=^pers m ^persA(%USID)=^persArhi
 f  s T=$o(^persA(%USID,T)) q:T=""  i xT=T!'xT d
 .s o=$e(%XD81,1,6)-100 q:'$o(^AM(T,o))
 .s %I=T,%I2=T 
 . i 1_$$m^ZFIO(%gm)," - "'[xCh," "_xCh_" "'[(" "_CF_" ") q
 . q:SN["s0"  d AMT
 .f gm=gm1:1:gm2 s:gm#100=13 gm=gm+88 d
 ..  s o=$g(AMT(gm,Osoc)) s:$l(o)=500 o=o_$g(AMT(gm,Osoc,500)) s SUsoc=o
 ..  ;; s o=$g(AMT(gm,Onod)) s:$l(o)=500 o=o_$g(AMT(gm,Onod,500)) s SUnod=o
 ..  s socS=0  ;; +$j($g(^AM(T,gm,"socS","DD"))+$g(^("DN")),0,2)
 ..  q:dp>%XD82!'dp  d @%V
 q
AM20 
 n o,oo,M,%,gm,SU,su,Osoc1,L,nestrada s Osoc1=1000+Osoc,o=+$p($g(^ds(%gm+1)),%B,4)
 s:o=1 nestrada($$d31^MXD(%gm)+1)=o s oo=$p($g(^ds(%gm)),%B,4) f %=1:1:9 s o=$p(oo,",",%) s:o nestrada(+o)=o 
 ;
 d %I0^fin f %1="ZU","pers" D ^USX
 s ceh="",T="",gm1=%XD81\100,gm2=%XD82\100,xVAL="Ls"
 s xT=$g(xT) i %V["St" s gm1=gm1-1 s:gm1#100=0 gm1=gm1-88 s gm1=gm1-1 s:gm1#100=0 gm1=gm1-88
 s T="" k ^persA(%USID) m ^persA(%USID)=^pers m ^persA(%USID)=^persArhi
 f  s T=$o(^persA(%USID,T)) q:T=""  d
 .i xT," "_xT_" "'[(" "_+T_" ") q
 .f gm=gm1:1:gm2 s:gm#100=13 gm=gm+88 k am,SU,su,St,Dn d:$d(^AM(T,gm))
 ..s %=gm n gm s gm=%
 ..s %=$$m^ZFIO(gm) q:SN["s0"
 ..q:SN["s0"&(%V'="iso")  i du,du<%XD81 q
 ..i xCh," "_xCh_" "'[(" "_CF_" ") q
 ..d AMT s M=gm,sant=0,PLUS=$g(AMT(gm)),MINUS=$p(PLUS,",",2),(%I,%I2)=$NAME(^AM(T,gm))
 ..s SUsoc=$g(AMT(gm,Osoc)),socS=+$j($g(^AM(T,gm,"socS","DD"))+$g(^("DN")),0,2)
 ..f L=2:1 s s=$p(SUsoc,"s",L) q:s=""  d
 ...  s s=$tr(s,"M","m"),m=+$p(s_"m"_gm,"m",2),oo=1000+Osoc,%2=$j($p(s,"/",2)-s,0,12)
 ...  i m-gm,mxConfig'[":LM:" s oo=oo_"."_$e(gm,4,6)_$e(m,4,6)_1
 ...  s su(oo)=$g(su(oo))+%2 
 ..s o=1,ss=0
 ..f  s o=$o(AMT(gm,o)) q:'o  d
 ...  s am(o)=AMT(gm,o) 
 ...  s am(o)=$tr(am(o),"MDH'","mdh"_%B) 
 ...  f L=1:1:$l(am(o),%B) d
 ....  i xO," "_xO_" "'[(" "_o_" ") q
 ....  s s=$p(am(o),%B,L),m=+$p(s_"m"_gm,"m",2),SU(o)=$g(SU(o))+s,oo=o s:s["no" s=$$trw^UST(s,"no"," ")
 ....  I m-gm,mxConfig'[":LM:" s oo=o_"."_$e(gm,4,6)_$e(m,4,6)_1
 ....  s o2=+$p(s,"o",2) I mxConfig'[":LM:",o2,o2-o s oo=o_"."_o2_1
 ....  s st=$p(s,"h",2),dn=$p(s,"d",2) i dn,'st s st=dn*8/1000000
 ....  s ss=1,su(oo)=$g(su(oo))+s
 ....  i m'>%gm,m'<$e(%XD81,1,6) s:st!dn St(oo)=$g(St(oo))+st,Dn(oo)=$g(Dn(oo))+dn  ;; 20090608 LM
 ..i Osant>99 s su(Osant)=+$p($g(AMT(%gm(-1))),"+",2)
 ..s:'ss ss=$g(AMT(gm)) d:ss @%V
 q
algNod ;\Darba alga nodokli\CF,T\s,su(*)=Fi\\pers\s cap=0 n xT,xCh i $$Tf^ZT(%gm)
 n o,L,am,o2,s,m,su s s=0,o=T n T s T=+o
 x "n CF,xCh,su d ^ZT" d AMT k df
 s o=1 f  s o=$o(AMT(%gm,o)) q:'o  d
 .  s am=AMT(%gm,o)
 .  s am=$tr(am,"KMDH'","kmdh"_%B)
 .  f L=1:1:$l(am,%B) d
 ..  s s=$p(am,%B,L),m=+$p(s_"m"_%gm,"m",2) s:s["no" s=$$trw^UST(s,"no"," ")
 ..  i 's,o-200 s s=.00000001_" "_s
 ..  s su(o)=$g(su(o))+s,o2=+$p(s,"o",2),df(o)=$g(df(o))+$p(s,"d",2)
 ..  I o2,o2-o,o2?3n,o2>99 s o2=o_"."_+$p(s,"o",2)_1,su(o2)=$g(su(o2))+s,df(o2)=$g(df(o2))+$p(s,"d",2)
 g w
soc3 ;\ZINOJUMS par soc. iemaks.\Sar,T\Sa(),SOC(),ien1,riskN,risk=%SOC,KODS,Fi,datu,SN,I\Sar\p12\s AllFIO=1 k Tsoc s %XD81=%gm_"01",iii=0 k ^oMX(%USID)
 q:gm-%gm!(SN["s0")  i '$d(^AM(T,%gm)),'$d(^(%gm(-1))) q
 i SN'["v" s a=$e(KODS,1,6),a=19_$e(a,5,6)_$e(a,3,4)_$e(a,1,2) i a>19300000,%XD82-a>640000,%XD82-a<670000 s %mxWarng(T)=SN_" -- pensionars ? -- "_KODS_" "_Fi
 n ooSa,ooSOC,oosoc,ooSoc s ien1=0,%SOC=0
 d AMT s:'%SOC %SOC=$$m^ZT(%gm," S") s SUsoc3=$tr(SUsoc,"M","m")
 f m=%gm,%gm(-1) s %SOC=+$p($g(AMT(m,Osoc)),"%",2) q:%SOC  q:m#100=1
 ;; s SUsoc3=0
 f m=%gm,%gm(-1),%gm(-2) s o=$g(AMT(m,Onod)) d
 . ;; f %=1:1:$l(o,%B) s s=$p(o,%B,%) s:+$p(s,"m",2)=%gm SUsoc3=SUsoc3+$p(s,"s",2) 
 . i m=%gm f %=1:1:$l(o,%B) s s=$p(o,%B,%) i s<0 s:+$p(s,"m",2)=%gm(-1) ien1=ien1+s 
 . i m<%gm f %=1:1:$l(o,%B) s s=$p(o,%B,%) s:+$p(s,"m",2)=%gm(-1)&(s>0!111) ien1=ien1+s i +$p(s,"m",2)=%gm(-2),m=%gm(-1) s ien1=ien1+s
 s:ien1<0 ien1=0
 i SN["u"!(SN["U") s ien1="uzn"
 f m=%gm(-1),%gm(-2) s o=$g(AMT(m,Osoc)) d
 . f %=2:1:$l(o,"s") s s=$p(o,"s",%) s:+$p(s,"m",2)=%gm SUsoc3=SUsoc3_"s"_s
 ;
 f %=2:1:$l(SUsoc3,"s") s s=$p(SUsoc3,"s",%),m=+$p(s_"m"_%gm,"m",2) d:m
 .k Sa,SOC s:m<%gm m=-1 q:m>%gm  ;; s:m<%gm m=%gm  ;; 20150901 Inga s:m<%gm m=%gm
 .s SOC=+$p(s,"/",2),Sa(m)=+$p(s,"a",2),soc=+s,Soc=SOC-soc
 .s SOC(m)=soc+Soc i 'Sa(m) q:'SOC(m)
 .s ooSa(m)=$g(ooSa(m))+Sa(m)
 .s oosoc(m)=$g(oosoc(m))+soc,ooSoc(m)=$g(ooSoc(m))+Soc
esoc3 
 s Sar=%SOC,I=1,socS=0  ;; =+$j($g(^AM(T,%gm,"socS","DD"))+$g(^("DN")),0,2)
 i du,du<%XD81 s I="I",Sar=4 i du<(%gm(-1)*100),'ien1 q
 k Sa,SOC m Sa=ooSa s m=-99999999
 f  s m=$o(oosoc(m)) q:'m  s SOC(m)=$j(oosoc(m),0,2)+$j(ooSoc(m),0,2)
 i '$d(risk(%gm)) s o=$o(^ZMIN(%gm+.1),-1),risk=$p($g(^(+o)),"riska=",2) s:'risk risk=$p($g(^(+o)),%B,5) s:'risk risk=$s(%gm<200600:0,$g(^(+o))["riska=":0,o<201400:.25,1:.36) s risk(%gm)=risk
 s risk=$g(risk(%gm)) i %gm>200600,%gm<201400,risk>.25 s risk=.25 
 s:SN["A"!(SN["C")!(SN["D")!(SN["I") risk=0 s:du<%XD81&du risk=0 s riskN=''risk
 i 'ien1,'$d(SOC),'$d(Sa),du,du<%XD81 q
 g w
soc3L 
 s Sa=$g(Sa(%gm)),SOC=$g(SOC(%gm)),Sa1=$g(Sa(-1)),SOC1=$g(SOC(-1)),socS=0
 s:'T Fi="*" 
 i $$l("%NNE KODS Fi Sa.__ SOC.__ Sa1.__ SOC1.__ ien1.__ riskN risk datu T I %SOC SN socS ")
 s iii=iii+1 m:T ^oMX(%USID,%V,Sar,iii)=lUST
 q
SON ;\Soc nodok atskait\Sar,-gcc,gc,CFAK\ooSa,oosoc,ooSoc,N,riskN,risk=T,I,cehs\\p12\s AllFIO=1,iii=0 k ^oMX(%USID)
 q:SN["s0"  q:gm-%gm
 n ooSa,ooSOC,oosoc,ooSoc,Sa,m,o,L,%SOC,SUsoc3,Sa,SOC
 f o=0:-1:-2 s %SOC=+$p($g(AMT(%gm(o),Osoc)),"%",2) q:%SOC
 s:'%SOC %SOC=$$m^ZT(%gm," S") s ^soc(%gm,T)=%SOC
 s SUsoc=$tr(SUsoc,"M","m")
 f L=2:1:$l(SUsoc,"s") s s=$p(SUsoc,"s",L),m=+$p(s_"m"_%gm,"m",2) d
 .k Sa,SOC
 .s m=%gm
 .s SOC=+$p(s,"/",2),soc=+s,Soc=SOC-soc
 .i mxConfig[":LM:" s Soc=+s,soc=SOC-Soc
 .s SOC(m)=soc+Soc
 .s ooSa(m)=$g(ooSa(m))+$p(s,"a",2)
 .s oosoc(m)=$g(oosoc(m))+soc,ooSoc(m)=$g(ooSoc(m))+Soc 
 s Sar=%SOC,I=1
 i '$g(risk(%gm)) s o=$o(^ZMIN(%gm+.1),-1),o=+$p($g(^(+o)),"riska=",2) s:'o o=$p($g(@$zr),%B,5) s:'o o=.36 s risk(%gm)=o
 s risk=$g(risk(%gm))
 i du,du<%XD81 s risk=0
 s riskN=''risk,N=0
 s gc=$s(CF<0:4,CF<20:1,CF<31!(CF=45):3,1:2),gcc=gc>3
 k m m m=ooSoc m m=oosoc m m=ooSa s m="" 
 i '$d(m(%gm)) q:'$d(^AM(T,%gm))  s m(%gm)=0
 i xCh,$g(oxT)=".." s (gc,gcc)=T
 f  s m=$o(m(m)) q:m=""  d
 . f o="oosoc","ooSoc","ooSa" s @o=$g(@o@(m))
 . i 'oosoc,'ooSoc,'ooSa,'DFIO q
 . i '$p(SUsoc,"R",2) d  q
 . .  s (cehs,CFAK)=CF,ooSoc=$j(ooSoc,0,2),oosoc=$j(oosoc,0,2),N=1
 . .  i xCh,xCh-CF q  
 . .  d w s N=0,risk=0,riskN=0
 . f xR=2:1:$l(SUsoc,"s") s s=$p(SUsoc,"s",xR) d
 . . s R=+$p(s_"R"_CF,"R",2),cehs=CF,CFAK=CF  
 . . i R s:R<10 R=0_R s:CF-R (CFAK,cehs)=CF_"."_R 
 . . i R,xCh="" s (CFAK,cehs)=+R,gc=$s(R<0:4,R<20:1,R<31!(R=45):3,1:2),gcc=gc>3
 . . i xCh,xCh-(CFAK\1) q
 . . s oosoc=+s,ooSa=+$p(s,"a",2),ooSOC=$p(s,"/",2),ooSoc=ooSOC-oosoc
 . . ;; i mxConfig[":LM:" s ooSoc=+s,oosoc=ooSOC-ooSoc
 . . s ooSoc=$j(ooSoc,0,2),oosoc=$j(oosoc,0,2)
 . . d w s N=0,risk=0,riskN=0
 q
SONL i %E="gc",gc=4 q
 i $$l("Sar gcc gc cehs CFAK ooSa.__ oosoc.__ ooSoc.__ N T riskN risk ")
 s iii=iii+1 m ^oMX(%USID,%V,Sar,iii)=lUST
 q 
isoSt ;\stundas sadale\-CF,T\DN,sS(*),St(*),Dn(*)=Fi,SN\-%ggmm\AM20\s iii=0 k ^oMX(%USID) k ^oStundas(%USID,%gm)
 ;;  i -%XD81[-%gm q:gm-%gm
 k sS s o=1,DN=0
 f  s o=$o(St(o)) q:'o  s %=$p($g(^O(o\1)),%B,3) s:$e(%,7)-1&(%'["s") St(o)=0,Dn(o)=0 s DN=DN+$g(Dn(o)),$p(St(o),"d",2)=$g(Dn(o))
 i 'DFIO,'$d(^AM(T,%gm)),'$d(sS) q
 g w
isoStL 
 s li="%NNE T Fi SN " n oo
 s o=1,oo=10 f  s o=$o(sS(o)) q:'o  d
 .  s oo=oo+1,li=li_" s"_oo_" d"_oo_" h"_oo x "s s"_oo_"=sS(o),d"_oo_"=$g(Dn(o)),h"_oo_"=$g(St(o))"
 .  s o2=o s:$p(o,".",2) o2=$e(o,1,$l(o)-1),o2=$tr(o2,".",$c(10))
 .  x "s c"_oo_"=o2 " i T,$g(St(o)) s ^(o)=$g(^oStundas(%USID,%gm,T,o))+St(o)_"d"_($p($g(^(o)),"d",2)+$g(Dn(o)))
 i 1_$$l(li) s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
iso ;\Izm. saraksts\CF,T\SV,DOLG,PLUS,MINUS,sS(*),soc,Soc,SOC,IZMA,socS=Fi,SN\\AM20\s iii=0 k ^oMX(%USID)
 i -%XD81[-%gm q:gm-%gm
 s Soc=0,SOC=0,soc=0,Nod=0 k sS s o=1
 f  s o=$o(su(o)) q:o=""  s (sS(o),su(o))=$j(su(o),0,2) s:o\1=Onod Nod=Nod+su(o) i o>Or,o\1[Osoc d
 . s:o<999 soc=soc+su(o) i o>999 s Soc=Soc+su(o) i '$o(su(o)),$o(su(o),-1)<999 s sS(o)=$j(Soc,0,2)
 s soc=$j(soc,0,2),Soc=$j(Soc,0,2),SOC=Soc+soc
 i 'DFIO,'$d(^AM(T,%gm)),'$d(sS) q
 s neap=0,apli=PLUS-soc,atvi=$g(N(Onod,M,"b"))
 s iena=$g(SU(On)) s iena=Nod
 S SV=PLUS-MINUS,DOLG=0 S:SV<0 DOLG=-SV,SV=0
 s (SV,IZMA)=SV
 I xT!(%XD81'[%gm&xCh) s o=T n T s T=gm_-o
 g w
isoL i T,$d(^pers(T)) s T=T_"<mx @"_$NAME(^pers(T))
 i %E="CF" s T=CF_" *"
 s sant=0,santNew=0 s:'DOLG DOLG=SN 
 s li="%NNE T Fi sant PLUS MINUS IZMA DOLG santNew soc Soc SOC SN socS "
 n oo s o=1,oo=10 f  s o=$o(sS(o)) q:o=""  d
 .  s oo=oo+1,li=li_" s"_oo x "s s"_oo_"=sS(o)"
 .  s o2=o s:$p(o,".",2) o2=$e(o,1,$l(o)-1),o2=$tr(o2,".",$c(10))
 .  x "s c"_oo_"=o2"
 i 1_$$l(li) s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
sok ;\Soc.kart.\-FiT,-T,m\Sa,SOC,soc,Soc,socS=%SOC,%soc,%Soc\-%ggmm\p12\k ^oMX(%USID) s iii=0
 q:SN["s0"  I $g(oxT) s xT="",%2=+$p(oxT,"-",2) q:T-oxT&'%2  I %2 q:T>%2!(T<oxT)
 s FiT=$tr($p(Fi," ",2),$$Uu^MXF("{274}{362}{298}{256}{352}{290}{310}{315}{381}{268}{325}"),"EUIASGKLZCN"),N=1
 f L=2:1:$l(SUsoc,"s") s s=$tr($p(SUsoc,"s",L),"M","m"),m=+$p(s_"m"_gm,"m",2) d
 .k Sa,SOC,soc,Soc
 .s SOC=+$p(s,"/",2),%SOC=+$p(s,"%",2)
 .s (Sa,Sa(m))=+$p(s,"a",2),soc=+s,Soc=SOC-soc
 .s soc(m)=soc,%soc=0 s:SOC %soc=+$j(%SOC/SOC*soc,0,4)
 .i $p(s,"%",3) s %soc=+$p(s,"%",3)
 .i +$j(%soc,0,2)=.09 s %soc=.09
 .s %Soc=%SOC-%soc,so=+%soc_-%SOC
 .i m d w
 q
sokL s %SOC=100*%SOC_"%",%soc=100*%soc_"%",%Soc=100*%Soc_"%"
 i 'm s (%SOC,%Soc,%soc)=""
 i m,m<(%gm\100*100)!(m>%gm) q
 i Sa<.01,SOC<.01,soc<.01 s (%SOC,%Soc,%soc,Sa,SOC,soc)=""
 i $$l("m Sa.__ %SOC SOC.__  %Soc  Soc.__ %soc soc.__ socS")
 s iii=iii+1 m ^oMX(%USID,%V,T,iii)=lUST
 q
st1 ;\Zinas par darba nemejem\-T,p\s=Fi,KODS,dd\-%ggmm\pers\s nn=0,iii=0 k ^oMX(%USID)
 s s=0,TT=T  q:SN["s0"
 i du'<%XD81,du'>%XD82 s p=21,dd=du s:SN p=+SN s p=p_" " d w
 i dp'<%XD81,dp'>%XD82 s p=11,dd=dp s:SN["v" p=13 s:SN["g" p=12 d w q
 s dd=$o(SN(%gm*100))
 i dd,dd'<%XD81,dd'>%XD82,SN(dd)["v" s %=$o(SN(%gm*100),-1) d:%
 .i SN(%)'["v" s p=33 s:$e(du,1,6)-%gm&(SN>9) p=+SN d w
 q
st1L s nnn="" i %OLD("T")-T,T s nn=nn+1,nnn=$j(nn,2,0)_"."
 s zkn=$p($g(^kNo("zk",p)),%B,2)
 i $$l("nnn T KODS Fi dd p zkn")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
ie ;\Izzina par ietur.\oiet,T\s=Fi\-%ggmm\AM20\s iii=0 k ^oMX(%USID)
 i 'xO n xO s xO="881 885 886 888 891 892 893 896 899"
 f xxo=1:1:$l(xO," ") s oiet=$p(xO," ",xxo) d:oiet
 .f ooo=1:1:$l($g(am(oiet)),%B) s s=$p($g(am(oiet)),%B,ooo) d:s w
 q
ieL i $$l(" oiet T Fi s.__ ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
asa ;\Algas sadale\R\sS(*),SOC,soc,Soc,socS\-%ggmm\AM20\s iii=0 k ^oMX(%USID)
 s R=1,m=%gm i -%XD81[-%gm!(%V="asd") q:gm-%gm
 s (Soc,soc,o,Nod)=0 k sS
 f  s o=$o(su(o)) q:o=""  s sS(o)=su(o) s:o\1=Onod Nod=Nod+su(o) i o>Or,o\1[Osoc d
 . s:o>999 Soc=Soc+su(o) s:o<999 soc=soc+su(o)
 s soc=$j(soc,0,2),Soc=$j(Soc,0,2),SOC=Soc+soc,socS=$j($g(^AM(T,%gm,"socS","DD"))+$g(^("DN")),0,2)
 ; 
 i MINUS>PLUS s sS(1800)=PLUS-MINUS
 s n1=(Soc+soc)*(Soc+soc)>.0001,n2=Nod*Nod>.0001 d:$d(sS) w i %V="asd" x $g(formulaL)
 q
asaL n o s o="" f  s o=$o(sS(o)) q:o=""  d
 .s (ss1,ss2)=sS(o) s:o<Or ss2="" s:o>Or ss1=""
 .s nO="" i o s nO=$p($g(^O(+$p(o,"."))),%B,2)
 .s O=o i $$l(" O nO m ss1 ss2 SOC soc Soc socS")
 .s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
asd ;\sadale par DVK\DVk\n1,n2,SOC,soc,Soc,Nod,socS=T,Fi,SUsoc\\AM20\k ^oMX(%USID)
 s DVk=+DVK,s1=0 g asa
asdL q
a166p2 ;\DARBA DEVEJA PAZINOJUMS (Saraksts)\T\s01,s02,s03,s04,s05,s06,s07,s08,s09,s10,s11,s12,s13=Fi,KODS,DVK,T,periods,gram,ADR\\p12\s iii=0,nT=0 k ^oMX(%USID),^IeIeN
 q:SN["s0"  q:gm-%gm  i du,du<(%gm\100*10000) q
 i xCh'="" q:CF'=xCh    
 q:'$o(^AM(T,%gm+.1),-1)  q:'$o(^AM(T,%gm-200))  q:$o(^AM(T,%gm-200))>%gm
 d pazPr^algPaz
 g w
a166p2L s s0=s10,s5=s05,s6=s06,s7=s07,p=periods f %=1:1:9 s p1=$p(p," ",%) q:$p(p," ",%+1)=""
 i T s veids="d/a",KODS=$e(KODS,1,6)_"-"_$e(KODS,7,99) d
 . s:p["01.01-31.12" periods="   "_$e(%XD82,1,4)_".g."  s p=""
 i $$l("Fi KODS DVK p p1 periods s01.__ s02.__ s03.__ s04.__ s5.__ s6.__ s7.__ s08.__ s09.__ s0.__ s11.__ s12.__ s13.__ T")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST q:'T  s nT=nT+1
 q
uzb ;\Maks.uzd uz banku\FiT\s,s2=Fi,KODS,CARD,T,kam\\p12\s iii=0,ss=0 k ^oMX(%USID)
 s s=$g(AMT(%gm,+xO))
 s CARD=$p($g(^algBan(+xO,+T)),%B,$s(mxConfig[":LM:":2,1:4)),kam=$p($g(^algBan(+xO,+T)),%B,2)
 s:$l(kam)>9 CARD=kam
 i xO["alga" q:CARD=""  s s=$g(AMT(%gm)),s=s-$p(s,",",2)
 i $g(oxFiltr)?8n s s=$p($g(^kas(oxFiltr,+T)),%B,2),o=$p($g(^algBan(+xO,+T)),%B,5) i o?8n,o>oxFiltr q
 i 's,$g(d8uzBank)?8n s s=$g(^persO(T,%gm,"uzBank",+xO,d8uzBank,"S"))
 q:'s  
 s o2=$p($p($g(^O(+xO)),%B,5),".",2),s2=0 i o2 s s2=$g(^AM(+T,%gm,o2))
 i $l(CARD)<3 s o="" d
 .  f  s o=$o(^ZU(+T,o),-1) q:o=""  i -o[-xO s CARD=$p(^(o),%B,5) q
 i $l(CARD)<3 s o="" d
 .  f  s o=$o(^algBan(o)) q:o=""  i $d(^(o,+T)) s CARD=$p(^(+T),%B,$s(mxConfig[":LM:":2,1:4)) q 
 s %2=$p(Fi," ",2),FiT=$tr($e(%2),oLat1,oLat2)_%2_-T
 g w
uzbL i $$l("%NNE Fi KODS s.__ CARD s2.__ T kam ")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
uzbRESU ;\Maks.uzd uz banku RESUME\FiT,nCARD\s=Fi,CARD,T\\p12\s iii=0 k ^oMX(%USID)
 f nCARD=0:.1:.9 i $d(^persO(T,%gm,"uzBank",xO+nCARD,d8uzBank,"S")) d
 . s s=$g(^persO(T,%gm,"uzBank",xO+nCARD,d8uzBank,"S")) q:'s
 . s CARD=$p($g(^algBan(xO+nCARD,+T)),%B,$s(mxConfig[":LM:":2,1:4)),kam=$p($g(^algBan(xO+nCARD,+T)),%B,2)
 . i $l(kam)>5,$l($tr(kam,1234567890_kam,1234567890))<9 n Fi s Fi=kam
 . i CARD="" s o="" f  s o=$o(^ZU(+T,o),-1) q:o=""  i -o[-xO s CARD=$p(^(o),%B,5) q
 . s FiT=$tr($e(Fi),oLat1,oLat2)_$e(Fi)_$tr(Fi,oLat1,oLat2)_-T
 . d w
 q
uzbRESUL i $$l("%NNE Fi KODS s.__ CARD T nCARD")
 s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
banDi ;\Disk a:uz banku\T\s,s2=Fi,KODS,CARD\\p12\k ^oMX(%USID) s iii=0,ss=0
 g uzb
banDiL q:'T  s aFile="a:"_+xO_".txt"
 s o="                             ",ss=ss+s
 s o=$e(%NNN+1_o,1,11)_$e(Fi_o,1,25)_$e(KODS_o,1,14)_$e(CARD_o,1,26)
 s aFileRec=o_$j(s,9,2)_"     "_%gm_"  0     "_T
 i T,1_$$l(" %NNN aFileRec T Fi KODS CARD s ") s iii=iii+1 m ^oMX(%USID,%V,iii)=lUST
 q
l(%lN) q $$l^UST(%lN)
AMT k AMT n m i %gm>201500 s m=201400 x "f  s m=$o(^AM(T,m)) q:'m  m AMT(m)=^AM(T,m)" q
 m AMT=^AM(+T) q:%gm<201400  n AM,o,L,m,s,S,b s m=1 
 f  s m=$o(AMT(m)) q:'m  q:m>201400  s AMT(m)=AMT(m)/.702804_"+ ,"_($p(AMT(m),",",2)/.702804) d
 . s o=99 f  s o=$o(AMT(m,o)) q:'o  s AM=AMT(m,o) x:$l(AM)>499 "s AM=AM_$g(AMT(m,o,501)) k AMT(m,o,501)" f L=1:1:$l(AM,%B) s S=$p(AM,%B,L),S=S/.702804_"_"_S d:o>Or  s $p(AM,%B,L)=S,AMT(m,o)=AM
 .. f b="s","n","/","b","r","c","z","u","a" i S[b f %=2:1:$l(S,b) s s=$p(S,b,%) s:s $p(S,b,%)=s/.702804_"_"_s 
 q
 q

zzz
test ; test
